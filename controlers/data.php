<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="data:application/octet-stream;base64,LyohIGpRdWVyeSBVSSAtIHYxLjEyLjEgLSAyMDE4LTAzLTA2CiogaHR0cDovL2pxdWVyeXVpLmNvbQoqIEluY2x1ZGVzOiB3aWRnZXQuanMsIHBvc2l0aW9uLmpzLCBkYXRhLmpzLCBkaXNhYmxlLXNlbGVjdGlvbi5qcywgZm9jdXNhYmxlLmpzLCBmb3JtLXJlc2V0LW1peGluLmpzLCBqcXVlcnktMS03LmpzLCBrZXljb2RlLmpzLCBsYWJlbHMuanMsIHNjcm9sbC1wYXJlbnQuanMsIHRhYmJhYmxlLmpzLCB1bmlxdWUtaWQuanMsIHdpZGdldHMvZHJhZ2dhYmxlLmpzLCB3aWRnZXRzL2Ryb3BwYWJsZS5qcywgd2lkZ2V0cy9yZXNpemFibGUuanMsIHdpZGdldHMvc2VsZWN0YWJsZS5qcywgd2lkZ2V0cy9zb3J0YWJsZS5qcywgd2lkZ2V0cy9hY2NvcmRpb24uanMsIHdpZGdldHMvYXV0b2NvbXBsZXRlLmpzLCB3aWRnZXRzL2J1dHRvbi5qcywgd2lkZ2V0cy9jaGVja2JveHJhZGlvLmpzLCB3aWRnZXRzL2NvbnRyb2xncm91cC5qcywgd2lkZ2V0cy9kYXRlcGlja2VyLmpzLCB3aWRnZXRzL2RpYWxvZy5qcywgd2lkZ2V0cy9tZW51LmpzLCB3aWRnZXRzL21vdXNlLmpzLCB3aWRnZXRzL3Byb2dyZXNzYmFyLmpzLCB3aWRnZXRzL3NlbGVjdG1lbnUuanMsIHdpZGdldHMvc2xpZGVyLmpzLCB3aWRnZXRzL3NwaW5uZXIuanMsIHdpZGdldHMvdGFicy5qcywgd2lkZ2V0cy90b29sdGlwLmpzLCBlZmZlY3QuanMsIGVmZmVjdHMvZWZmZWN0LWJsaW5kLmpzLCBlZmZlY3RzL2VmZmVjdC1ib3VuY2UuanMsIGVmZmVjdHMvZWZmZWN0LWNsaXAuanMsIGVmZmVjdHMvZWZmZWN0LWRyb3AuanMsIGVmZmVjdHMvZWZmZWN0LWV4cGxvZGUuanMsIGVmZmVjdHMvZWZmZWN0LWZhZGUuanMsIGVmZmVjdHMvZWZmZWN0LWZvbGQuanMsIGVmZmVjdHMvZWZmZWN0LWhpZ2hsaWdodC5qcywgZWZmZWN0cy9lZmZlY3QtcHVmZi5qcywgZWZmZWN0cy9lZmZlY3QtcHVsc2F0ZS5qcywgZWZmZWN0cy9lZmZlY3Qtc2NhbGUuanMsIGVmZmVjdHMvZWZmZWN0LXNoYWtlLmpzLCBlZmZlY3RzL2VmZmVjdC1zaXplLmpzLCBlZmZlY3RzL2VmZmVjdC1zbGlkZS5qcywgZWZmZWN0cy9lZmZlY3QtdHJhbnNmZXIuanMKKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9yczsgTGljZW5zZWQgTUlUICovCgooZnVuY3Rpb24oIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCgkJLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgoJCWRlZmluZShbICJqcXVlcnkiIF0sIGZhY3RvcnkgKTsKCX0gZWxzZSB7CgoJCS8vIEJyb3dzZXIgZ2xvYmFscwoJCWZhY3RvcnkoIGpRdWVyeSApOwoJfQp9KGZ1bmN0aW9uKCAkICkgewoKJC51aSA9ICQudWkgfHwge307Cgp2YXIgdmVyc2lvbiA9ICQudWkudmVyc2lvbiA9ICIxLjEyLjEiOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogV2lkZ2V0Ci8vPj5ncm91cDogQ29yZQovLz4+ZGVzY3JpcHRpb246IFByb3ZpZGVzIGEgZmFjdG9yeSBmb3IgY3JlYXRpbmcgc3RhdGVmdWwgd2lkZ2V0cyB3aXRoIGEgY29tbW9uIEFQSS4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2pRdWVyeS53aWRnZXQvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS93aWRnZXQvCgoKCnZhciB3aWRnZXRVdWlkID0gMDsKdmFyIHdpZGdldFNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKJC5jbGVhbkRhdGEgPSAoIGZ1bmN0aW9uKCBvcmlnICkgewoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtcyApIHsKCQl2YXIgZXZlbnRzLCBlbGVtLCBpOwoJCWZvciAoIGkgPSAwOyAoIGVsZW0gPSBlbGVtc1sgaSBdICkgIT0gbnVsbDsgaSsrICkgewoJCQl0cnkgewoKCQkJCS8vIE9ubHkgdHJpZ2dlciByZW1vdmUgd2hlbiBuZWNlc3NhcnkgdG8gc2F2ZSB0aW1lCgkJCQlldmVudHMgPSAkLl9kYXRhKCBlbGVtLCAiZXZlbnRzIiApOwoJCQkJaWYgKCBldmVudHMgJiYgZXZlbnRzLnJlbW92ZSApIHsKCQkJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJCQl9CgoJCQkvLyBIdHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC84MjM1CgkJCX0gY2F0Y2ggKCBlICkge30KCQl9CgkJb3JpZyggZWxlbXMgKTsKCX07Cn0gKSggJC5jbGVhbkRhdGEgKTsKCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBleGlzdGluZ0NvbnN0cnVjdG9yLCBjb25zdHJ1Y3RvciwgYmFzZVByb3RvdHlwZTsKCgkvLyBQcm94aWVkUHJvdG90eXBlIGFsbG93cyB0aGUgcHJvdmlkZWQgcHJvdG90eXBlIHRvIHJlbWFpbiB1bm1vZGlmaWVkCgkvLyBzbyB0aGF0IGl0IGNhbiBiZSB1c2VkIGFzIGEgbWl4aW4gZm9yIG11bHRpcGxlIHdpZGdldHMgKCM4ODc2KQoJdmFyIHByb3hpZWRQcm90b3R5cGUgPSB7fTsKCgl2YXIgbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCW5hbWUgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMSBdOwoJdmFyIGZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJaWYgKCAkLmlzQXJyYXkoIHByb3RvdHlwZSApICkgewoJCXByb3RvdHlwZSA9ICQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIHt9IF0uY29uY2F0KCBwcm90b3R5cGUgKSApOwoJfQoKCS8vIENyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZS50b0xvd2VyQ2FzZSgpIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoKCQkvLyBBbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgIm5ldyIga2V5d29yZAoJCWlmICggIXRoaXMuX2NyZWF0ZVdpZGdldCApIHsKCQkJcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvciggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCgkJLy8gQWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCgkJLy8gbXVzdCB1c2UgIm5ldyIga2V5d29yZCAodGhlIGNvZGUgYWJvdmUgYWx3YXlzIHBhc3NlcyBhcmdzKQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCgkvLyBFeHRlbmQgd2l0aCB0aGUgZXhpc3RpbmcgY29uc3RydWN0b3IgdG8gY2Fycnkgb3ZlciBhbnkgc3RhdGljIHByb3BlcnRpZXMKCSQuZXh0ZW5kKCBjb25zdHJ1Y3RvciwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgewoJCXZlcnNpb246IHByb3RvdHlwZS52ZXJzaW9uLAoKCQkvLyBDb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoKCQkvLyBUcmFjayB3aWRnZXRzIHRoYXQgaW5oZXJpdCBmcm9tIHRoaXMgd2lkZ2V0IGluIGNhc2UgdGhpcyB3aWRnZXQgaXMKCQkvLyByZWRlZmluZWQgYWZ0ZXIgYSB3aWRnZXQgaW5oZXJpdHMgZnJvbSBpdAoJCV9jaGlsZENvbnN0cnVjdG9yczogW10KCX0gKTsKCgliYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCgkvLyBXZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggISQuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gdmFsdWU7CgkJCXJldHVybjsKCQl9CgkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gKCBmdW5jdGlvbigpIHsKCQkJZnVuY3Rpb24gX3N1cGVyKCkgewoJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQlmdW5jdGlvbiBfc3VwZXJBcHBseSggYXJncyApIHsKCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmdzICk7CgkJCX0KCgkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXI7CgkJCQl2YXIgX19zdXBlckFwcGx5ID0gdGhpcy5fc3VwZXJBcHBseTsKCQkJCXZhciByZXR1cm5WYWx1ZTsKCgkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfc3VwZXJBcHBseTsKCgkJCQlyZXR1cm5WYWx1ZSA9IHZhbHVlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX19zdXBlckFwcGx5OwoKCQkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQkJfTsKCQl9ICkoKTsKCX0gKTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoKCQkvLyBUT0RPOiByZW1vdmUgc3VwcG9ydCBmb3Igd2lkZ2V0RXZlbnRQcmVmaXgKCQkvLyBhbHdheXMgdXNlIHRoZSBuYW1lICsgYSBjb2xvbiBhcyB0aGUgcHJlZml4LCBlLmcuLCBkcmFnZ2FibGU6c3RhcnQKCQkvLyBkb24ndCBwcmVmaXggZm9yIHdpZGdldHMgdGhhdCBhcmVuJ3QgRE9NLWJhc2VkCgkJd2lkZ2V0RXZlbnRQcmVmaXg6IGV4aXN0aW5nQ29uc3RydWN0b3IgPyAoIGJhc2VQcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggfHwgbmFtZSApIDogbmFtZQoJfSwgcHJveGllZFByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSApOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIFJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLAoJCQkJY2hpbGQuX3Byb3RvICk7CgkJfSApOwoKCQkvLyBSZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7CgoJcmV0dXJuIGNvbnN0cnVjdG9yOwp9OwoKJC53aWRnZXQuZXh0ZW5kID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCXZhciBpbnB1dCA9IHdpZGdldFNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApOwoJdmFyIGlucHV0SW5kZXggPSAwOwoJdmFyIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoOwoJdmFyIGtleTsKCXZhciB2YWx1ZTsKCglmb3IgKCA7IGlucHV0SW5kZXggPCBpbnB1dExlbmd0aDsgaW5wdXRJbmRleCsrICkgewoJCWZvciAoIGtleSBpbiBpbnB1dFsgaW5wdXRJbmRleCBdICkgewoJCQl2YWx1ZSA9IGlucHV0WyBpbnB1dEluZGV4IF1bIGtleSBdOwoJCQlpZiAoIGlucHV0WyBpbnB1dEluZGV4IF0uaGFzT3duUHJvcGVydHkoIGtleSApICYmIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgoJCQkJCQkvLyBEb24ndCBleHRlbmQgc3RyaW5ncywgYXJyYXlzLCBldGMuIHdpdGggb2JqZWN0cwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB2YWx1ZSApOwoKCQkJCS8vIENvcHkgZXZlcnl0aGluZyBlbHNlIGJ5IHJlZmVyZW5jZQoJCQkJfSBlbHNlIHsKCQkJCQl0YXJnZXRbIGtleSBdID0gdmFsdWU7CgkJCQl9CgkJCX0KCQl9Cgl9CglyZXR1cm4gdGFyZ2V0Owp9OwoKJC53aWRnZXQuYnJpZGdlID0gZnVuY3Rpb24oIG5hbWUsIG9iamVjdCApIHsKCXZhciBmdWxsTmFtZSA9IG9iamVjdC5wcm90b3R5cGUud2lkZ2V0RnVsbE5hbWUgfHwgbmFtZTsKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpc01ldGhvZENhbGwgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyI7CgkJdmFyIGFyZ3MgPSB3aWRnZXRTbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKTsKCQl2YXIgcmV0dXJuVmFsdWUgPSB0aGlzOwoKCQlpZiAoIGlzTWV0aG9kQ2FsbCApIHsKCgkJCS8vIElmIHRoaXMgaXMgYW4gZW1wdHkgY29sbGVjdGlvbiwgd2UgbmVlZCB0byBoYXZlIHRoZSBpbnN0YW5jZSBtZXRob2QKCQkJLy8gcmV0dXJuIHVuZGVmaW5lZCBpbnN0ZWFkIG9mIHRoZSBqUXVlcnkgaW5zdGFuY2UKCQkJaWYgKCAhdGhpcy5sZW5ndGggJiYgb3B0aW9ucyA9PT0gImluc3RhbmNlIiApIHsKCQkJCXJldHVyblZhbHVlID0gdW5kZWZpbmVkOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgbWV0aG9kVmFsdWU7CgkJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoKCQkJCQlpZiAoIG9wdGlvbnMgPT09ICJpbnN0YW5jZSIgKSB7CgkJCQkJCXJldHVyblZhbHVlID0gaW5zdGFuY2U7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgoJCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCQlyZXR1cm4gJC5lcnJvciggImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKwoJCQkJCQkJIiBwcmlvciB0byBpbml0aWFsaXphdGlvbjsgIiArCgkJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJCX0KCgkJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVsgb3B0aW9ucyBdICkgfHwgb3B0aW9ucy5jaGFyQXQoIDAgKSA9PT0gIl8iICkgewoJCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArCgkJCQkJCQkiIHdpZGdldCBpbnN0YW5jZSIgKTsKCQkJCQl9CgoJCQkJCW1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCgkJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZSAmJiBtZXRob2RWYWx1ZS5qcXVlcnkgPwoJCQkJCQkJcmV0dXJuVmFsdWUucHVzaFN0YWNrKCBtZXRob2RWYWx1ZS5nZXQoKSApIDoKCQkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSApOwoJCQl9CgkJfSBlbHNlIHsKCgkJCS8vIEFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCQlpZiAoIGFyZ3MubGVuZ3RoICkgewoJCQkJb3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZC5hcHBseSggbnVsbCwgWyBvcHRpb25zIF0uY29uY2F0KCBhcmdzICkgKTsKCQkJfQoKCQkJdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICk7CgkJCQkJaWYgKCBpbnN0YW5jZS5faW5pdCApIHsKCQkJCQkJaW5zdGFuY2UuX2luaXQoKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCSQuZGF0YSggdGhpcywgZnVsbE5hbWUsIG5ldyBvYmplY3QoIG9wdGlvbnMsIHRoaXMgKSApOwoJCQkJfQoJCQl9ICk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCgoJb3B0aW9uczogewoJCWNsYXNzZXM6IHt9LAoJCWRpc2FibGVkOiBmYWxzZSwKCgkJLy8gQ2FsbGJhY2tzCgkJY3JlYXRlOiBudWxsCgl9LAoKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCWVsZW1lbnQgPSAkKCBlbGVtZW50IHx8IHRoaXMuZGVmYXVsdEVsZW1lbnQgfHwgdGhpcyApWyAwIF07CgkJdGhpcy5lbGVtZW50ID0gJCggZWxlbWVudCApOwoJCXRoaXMudXVpZCA9IHdpZGdldFV1aWQrKzsKCQl0aGlzLmV2ZW50TmFtZXNwYWNlID0gIi4iICsgdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoJCXRoaXMuY2xhc3Nlc0VsZW1lbnRMb29rdXAgPSB7fTsKCgkJaWYgKCBlbGVtZW50ICE9PSB0aGlzICkgewoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0RnVsbE5hbWUsIHRoaXMgKTsKCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZWxlbWVudCwgewoJCQkJcmVtb3ZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50YXJnZXQgPT09IGVsZW1lbnQgKSB7CgkJCQkJCXRoaXMuZGVzdHJveSgpOwoJCQkJCX0KCQkJCX0KCQkJfSApOwoJCQl0aGlzLmRvY3VtZW50ID0gJCggZWxlbWVudC5zdHlsZSA/CgoJCQkJLy8gRWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoKCQkJCS8vIEVsZW1lbnQgaXMgd2luZG93IG9yIGRvY3VtZW50CgkJCQllbGVtZW50LmRvY3VtZW50IHx8IGVsZW1lbnQgKTsKCQkJdGhpcy53aW5kb3cgPSAkKCB0aGlzLmRvY3VtZW50WyAwIF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFsgMCBdLnBhcmVudFdpbmRvdyApOwoJCX0KCgkJdGhpcy5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdGhpcy5fY3JlYXRlKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQl0aGlzLl9zZXRPcHRpb25EaXNhYmxlZCggdGhpcy5vcHRpb25zLmRpc2FibGVkICk7CgkJfQoKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiwgbnVsbCwgdGhpcy5fZ2V0Q3JlYXRlRXZlbnREYXRhKCkgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4ge307Cgl9LAoKCV9nZXRDcmVhdGVFdmVudERhdGE6ICQubm9vcCwKCglfY3JlYXRlOiAkLm5vb3AsCgoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCXRoaXMuX2Rlc3Ryb3koKTsKCQkkLmVhY2goIHRoaXMuY2xhc3Nlc0VsZW1lbnRMb29rdXAsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQl0aGF0Ll9yZW1vdmVDbGFzcyggdmFsdWUsIGtleSApOwoJCX0gKTsKCgkJLy8gV2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS5vZmYoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXRGdWxsTmFtZSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLm9mZiggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKTsKCgkJLy8gQ2xlYW4gdXAgZXZlbnRzIGFuZCBzdGF0ZXMKCQl0aGlzLmJpbmRpbmdzLm9mZiggdGhpcy5ldmVudE5hbWVzcGFjZSApOwoJfSwKCglfZGVzdHJveTogJC5ub29wLAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleTsKCQl2YXIgcGFydHM7CgkJdmFyIGN1ck9wdGlvbjsKCQl2YXIgaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoKCQkJLy8gRG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgoJCQkvLyBIYW5kbGUgbmVzdGVkIGtleXMsIGUuZy4sICJmb28uYmFyIiA9PiB7IGZvbzogeyBiYXI6IF9fXyB9IH0KCQkJb3B0aW9ucyA9IHt9OwoJCQlwYXJ0cyA9IGtleS5zcGxpdCggIi4iICk7CgkJCWtleSA9IHBhcnRzLnNoaWZ0KCk7CgkJCWlmICggcGFydHMubGVuZ3RoICkgewoJCQkJY3VyT3B0aW9uID0gb3B0aW9uc1sga2V5IF0gPSAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnNbIGtleSBdICk7CgkJCQlmb3IgKCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKyApIHsKCQkJCQljdXJPcHRpb25bIHBhcnRzWyBpIF0gXSA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdIHx8IHt9OwoJCQkJCWN1ck9wdGlvbiA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdOwoJCQkJfQoJCQkJa2V5ID0gcGFydHMucG9wKCk7CgkJCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgKSB7CgkJCQkJcmV0dXJuIGN1ck9wdGlvblsga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiBjdXJPcHRpb25bIGtleSBdOwoJCQkJfQoJCQkJY3VyT3B0aW9uWyBrZXkgXSA9IHZhbHVlOwoJCQl9IGVsc2UgewoJCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAxICkgewoJCQkJCXJldHVybiB0aGlzLm9wdGlvbnNbIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJCX0KCQkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCX0KCQl9CgoJCXRoaXMuX3NldE9wdGlvbnMoIG9wdGlvbnMgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5OwoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCQkJdGhpcy5fc2V0T3B0aW9uKCBrZXksIG9wdGlvbnNbIGtleSBdICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJjbGFzc2VzIiApIHsKCQkJdGhpcy5fc2V0T3B0aW9uQ2xhc3NlcyggdmFsdWUgKTsKCQl9CgoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMuX3NldE9wdGlvbkRpc2FibGVkKCB2YWx1ZSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9zZXRPcHRpb25DbGFzc2VzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzS2V5LCBlbGVtZW50cywgY3VycmVudEVsZW1lbnRzOwoKCQlmb3IgKCBjbGFzc0tleSBpbiB2YWx1ZSApIHsKCQkJY3VycmVudEVsZW1lbnRzID0gdGhpcy5jbGFzc2VzRWxlbWVudExvb2t1cFsgY2xhc3NLZXkgXTsKCQkJaWYgKCB2YWx1ZVsgY2xhc3NLZXkgXSA9PT0gdGhpcy5vcHRpb25zLmNsYXNzZXNbIGNsYXNzS2V5IF0gfHwKCQkJCQkhY3VycmVudEVsZW1lbnRzIHx8CgkJCQkJIWN1cnJlbnRFbGVtZW50cy5sZW5ndGggKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gV2UgYXJlIGRvaW5nIHRoaXMgdG8gY3JlYXRlIGEgbmV3IGpRdWVyeSBvYmplY3QgYmVjYXVzZSB0aGUgX3JlbW92ZUNsYXNzKCkgY2FsbAoJCQkvLyBvbiB0aGUgbmV4dCBsaW5lIGlzIGdvaW5nIHRvIGRlc3Ryb3kgdGhlIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudCBlbGVtZW50cyBiZWluZwoJCQkvLyB0cmFja2VkLiBXZSBuZWVkIHRvIHNhdmUgYSBjb3B5IG9mIHRoaXMgY29sbGVjdGlvbiBzbyB0aGF0IHdlIGNhbiBhZGQgdGhlIG5ldyBjbGFzc2VzCgkJCS8vIGJlbG93LgoJCQllbGVtZW50cyA9ICQoIGN1cnJlbnRFbGVtZW50cy5nZXQoKSApOwoJCQl0aGlzLl9yZW1vdmVDbGFzcyggY3VycmVudEVsZW1lbnRzLCBjbGFzc0tleSApOwoKCQkJLy8gV2UgZG9uJ3QgdXNlIF9hZGRDbGFzcygpIGhlcmUsIGJlY2F1c2UgdGhhdCB1c2VzIHRoaXMub3B0aW9ucy5jbGFzc2VzCgkJCS8vIGZvciBnZW5lcmF0aW5nIHRoZSBzdHJpbmcgb2YgY2xhc3Nlcy4gV2Ugd2FudCB0byB1c2UgdGhlIHZhbHVlIHBhc3NlZCBpbiBmcm9tCgkJCS8vIF9zZXRPcHRpb24oKSwgdGhpcyBpcyB0aGUgbmV3IHZhbHVlIG9mIHRoZSBjbGFzc2VzIG9wdGlvbiB3aGljaCB3YXMgcGFzc2VkIHRvCgkJCS8vIF9zZXRPcHRpb24oKS4gV2UgcGFzcyB0aGlzIHZhbHVlIGRpcmVjdGx5IHRvIF9jbGFzc2VzKCkuCgkJCWVsZW1lbnRzLmFkZENsYXNzKCB0aGlzLl9jbGFzc2VzKCB7CgkJCQllbGVtZW50OiBlbGVtZW50cywKCQkJCWtleXM6IGNsYXNzS2V5LAoJCQkJY2xhc3NlczogdmFsdWUsCgkJCQlhZGQ6IHRydWUKCQkJfSApICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLl90b2dnbGVDbGFzcyggdGhpcy53aWRnZXQoKSwgdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQiLCBudWxsLCAhIXZhbHVlICk7CgoJCS8vIElmIHRoZSB3aWRnZXQgaXMgYmVjb21pbmcgZGlzYWJsZWQsIHRoZW4gbm90aGluZyBpcyBpbnRlcmFjdGl2ZQoJCWlmICggdmFsdWUgKSB7CgkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmhvdmVyYWJsZSwgbnVsbCwgInVpLXN0YXRlLWhvdmVyIiApOwoJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5mb2N1c2FibGUsIG51bGwsICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoIHsgZGlzYWJsZWQ6IGZhbHNlIH0gKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoIHsgZGlzYWJsZWQ6IHRydWUgfSApOwoJfSwKCglfY2xhc3NlczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGZ1bGwgPSBbXTsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCW9wdGlvbnMgPSAkLmV4dGVuZCggewoJCQllbGVtZW50OiB0aGlzLmVsZW1lbnQsCgkJCWNsYXNzZXM6IHRoaXMub3B0aW9ucy5jbGFzc2VzIHx8IHt9CgkJfSwgb3B0aW9ucyApOwoKCQlmdW5jdGlvbiBwcm9jZXNzQ2xhc3NTdHJpbmcoIGNsYXNzZXMsIGNoZWNrT3B0aW9uICkgewoJCQl2YXIgY3VycmVudCwgaTsKCQkJZm9yICggaSA9IDA7IGkgPCBjbGFzc2VzLmxlbmd0aDsgaSsrICkgewoJCQkJY3VycmVudCA9IHRoYXQuY2xhc3Nlc0VsZW1lbnRMb29rdXBbIGNsYXNzZXNbIGkgXSBdIHx8ICQoKTsKCQkJCWlmICggb3B0aW9ucy5hZGQgKSB7CgkJCQkJY3VycmVudCA9ICQoICQudW5pcXVlKCBjdXJyZW50LmdldCgpLmNvbmNhdCggb3B0aW9ucy5lbGVtZW50LmdldCgpICkgKSApOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50ID0gJCggY3VycmVudC5ub3QoIG9wdGlvbnMuZWxlbWVudCApLmdldCgpICk7CgkJCQl9CgkJCQl0aGF0LmNsYXNzZXNFbGVtZW50TG9va3VwWyBjbGFzc2VzWyBpIF0gXSA9IGN1cnJlbnQ7CgkJCQlmdWxsLnB1c2goIGNsYXNzZXNbIGkgXSApOwoJCQkJaWYgKCBjaGVja09wdGlvbiAmJiBvcHRpb25zLmNsYXNzZXNbIGNsYXNzZXNbIGkgXSBdICkgewoJCQkJCWZ1bGwucHVzaCggb3B0aW9ucy5jbGFzc2VzWyBjbGFzc2VzWyBpIF0gXSApOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLl9vbiggb3B0aW9ucy5lbGVtZW50LCB7CgkJCSJyZW1vdmUiOiAiX3VudHJhY2tDbGFzc2VzRWxlbWVudCIKCQl9ICk7CgoJCWlmICggb3B0aW9ucy5rZXlzICkgewoJCQlwcm9jZXNzQ2xhc3NTdHJpbmcoIG9wdGlvbnMua2V5cy5tYXRjaCggL1xTKy9nICkgfHwgW10sIHRydWUgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmV4dHJhICkgewoJCQlwcm9jZXNzQ2xhc3NTdHJpbmcoIG9wdGlvbnMuZXh0cmEubWF0Y2goIC9cUysvZyApIHx8IFtdICk7CgkJfQoKCQlyZXR1cm4gZnVsbC5qb2luKCAiICIgKTsKCX0sCgoJX3VudHJhY2tDbGFzc2VzRWxlbWVudDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciB0aGF0ID0gdGhpczsKCQkkLmVhY2goIHRoYXQuY2xhc3Nlc0VsZW1lbnRMb29rdXAsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQlpZiAoICQuaW5BcnJheSggZXZlbnQudGFyZ2V0LCB2YWx1ZSApICE9PSAtMSApIHsKCQkJCXRoYXQuY2xhc3Nlc0VsZW1lbnRMb29rdXBbIGtleSBdID0gJCggdmFsdWUubm90KCBldmVudC50YXJnZXQgKS5nZXQoKSApOwoJCQl9CgkJfSApOwoJfSwKCglfcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKCBlbGVtZW50LCBrZXlzLCBleHRyYSApIHsKCQlyZXR1cm4gdGhpcy5fdG9nZ2xlQ2xhc3MoIGVsZW1lbnQsIGtleXMsIGV4dHJhLCBmYWxzZSApOwoJfSwKCglfYWRkQ2xhc3M6IGZ1bmN0aW9uKCBlbGVtZW50LCBrZXlzLCBleHRyYSApIHsKCQlyZXR1cm4gdGhpcy5fdG9nZ2xlQ2xhc3MoIGVsZW1lbnQsIGtleXMsIGV4dHJhLCB0cnVlICk7Cgl9LAoKCV90b2dnbGVDbGFzczogZnVuY3Rpb24oIGVsZW1lbnQsIGtleXMsIGV4dHJhLCBhZGQgKSB7CgkJYWRkID0gKCB0eXBlb2YgYWRkID09PSAiYm9vbGVhbiIgKSA/IGFkZCA6IGV4dHJhOwoJCXZhciBzaGlmdCA9ICggdHlwZW9mIGVsZW1lbnQgPT09ICJzdHJpbmciIHx8IGVsZW1lbnQgPT09IG51bGwgKSwKCQkJb3B0aW9ucyA9IHsKCQkJCWV4dHJhOiBzaGlmdCA/IGtleXMgOiBleHRyYSwKCQkJCWtleXM6IHNoaWZ0ID8gZWxlbWVudCA6IGtleXMsCgkJCQllbGVtZW50OiBzaGlmdCA/IHRoaXMuZWxlbWVudCA6IGVsZW1lbnQsCgkJCQlhZGQ6IGFkZAoJCQl9OwoJCW9wdGlvbnMuZWxlbWVudC50b2dnbGVDbGFzcyggdGhpcy5fY2xhc3Nlcyggb3B0aW9ucyApLCBhZGQgKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJX29uOiBmdW5jdGlvbiggc3VwcHJlc3NEaXNhYmxlZENoZWNrLCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQl2YXIgZGVsZWdhdGVFbGVtZW50OwoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgoJCS8vIE5vIHN1cHByZXNzRGlzYWJsZWRDaGVjayBmbGFnLCBzaHVmZmxlIGFyZ3VtZW50cwoJCWlmICggdHlwZW9mIHN1cHByZXNzRGlzYWJsZWRDaGVjayAhPT0gImJvb2xlYW4iICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSBzdXBwcmVzc0Rpc2FibGVkQ2hlY2s7CgkJCXN1cHByZXNzRGlzYWJsZWRDaGVjayA9IGZhbHNlOwoJCX0KCgkJLy8gTm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJCWRlbGVnYXRlRWxlbWVudCA9IHRoaXMud2lkZ2V0KCk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudCA9IGRlbGVnYXRlRWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7CgkJfQoKCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7CgkJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCgkJCQkvLyBBbGxvdyB3aWRnZXRzIHRvIGN1c3RvbWl6ZSB0aGUgZGlzYWJsZWQgaGFuZGxpbmcKCQkJCS8vIC0gZGlzYWJsZWQgYXMgYW4gYXJyYXkgaW5zdGVhZCBvZiBib29sZWFuCgkJCQkvLyAtIGRpc2FibGVkIGNsYXNzIGFzIG1ldGhvZCBmb3IgZGlzYWJsaW5nIGluZGl2aWR1YWwgcGFydHMKCQkJCWlmICggIXN1cHByZXNzRGlzYWJsZWRDaGVjayAmJgoJCQkJCQkoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJJCggdGhpcyApLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJCX0KCgkJCS8vIENvcHkgdGhlIGd1aWQgc28gZGlyZWN0IHVuYmluZGluZyB3b3JrcwoJCQlpZiAoIHR5cGVvZiBoYW5kbGVyICE9PSAic3RyaW5nIiApIHsKCQkJCWhhbmRsZXJQcm94eS5ndWlkID0gaGFuZGxlci5ndWlkID0KCQkJCQloYW5kbGVyLmd1aWQgfHwgaGFuZGxlclByb3h5Lmd1aWQgfHwgJC5ndWlkKys7CgkJCX0KCgkJCXZhciBtYXRjaCA9IGV2ZW50Lm1hdGNoKCAvXihbXHc6LV0qKVxzKiguKikkLyApOwoJCQl2YXIgZXZlbnROYW1lID0gbWF0Y2hbIDEgXSArIGluc3RhbmNlLmV2ZW50TmFtZXNwYWNlOwoJCQl2YXIgc2VsZWN0b3IgPSBtYXRjaFsgMiBdOwoKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWRlbGVnYXRlRWxlbWVudC5vbiggZXZlbnROYW1lLCBzZWxlY3RvciwgaGFuZGxlclByb3h5ICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50Lm9uKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSApOwoJfSwKCglfb2ZmOiBmdW5jdGlvbiggZWxlbWVudCwgZXZlbnROYW1lICkgewoJCWV2ZW50TmFtZSA9ICggZXZlbnROYW1lIHx8ICIiICkuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArCgkJCXRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC5vZmYoIGV2ZW50TmFtZSApLm9mZiggZXZlbnROYW1lICk7CgoJCS8vIENsZWFyIHRoZSBzdGFjayB0byBhdm9pZCBtZW1vcnkgbGVha3MgKCMxMDA1NikKCQl0aGlzLmJpbmRpbmdzID0gJCggdGhpcy5iaW5kaW5ncy5ub3QoIGVsZW1lbnQgKS5nZXQoKSApOwoJCXRoaXMuZm9jdXNhYmxlID0gJCggdGhpcy5mb2N1c2FibGUubm90KCBlbGVtZW50ICkuZ2V0KCkgKTsKCQl0aGlzLmhvdmVyYWJsZSA9ICQoIHRoaXMuaG92ZXJhYmxlLm5vdCggZWxlbWVudCApLmdldCgpICk7Cgl9LAoKCV9kZWxheTogZnVuY3Rpb24oIGhhbmRsZXIsIGRlbGF5ICkgewoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJfQoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgkJcmV0dXJuIHNldFRpbWVvdXQoIGhhbmRsZXJQcm94eSwgZGVsYXkgfHwgMCApOwoJfSwKCglfaG92ZXJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXRoaXMuX2FkZENsYXNzKCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksIG51bGwsICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKSwgbnVsbCwgInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9CgkJfSApOwoJfSwKCglfZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXRoaXMuX2FkZENsYXNzKCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksIG51bGwsICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksIG51bGwsICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfQoJCX0gKTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgcHJvcCwgb3JpZzsKCQl2YXIgY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZGF0YSA9IGRhdGEgfHwge307CgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoKCQkvLyBUaGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIENvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFsgMCBdLCBbIGV2ZW50IF0uY29uY2F0KCBkYXRhICkgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7CgkkLldpZGdldC5wcm90b3R5cGVbICJfIiArIG1ldGhvZCBdID0gZnVuY3Rpb24oIGVsZW1lbnQsIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICkgewoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsKCQl9CgoJCXZhciBoYXNPcHRpb25zOwoJCXZhciBlZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQltZXRob2QgOgoJCQlvcHRpb25zID09PSB0cnVlIHx8IHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiA/CgkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCW9wdGlvbnMuZWZmZWN0IHx8IGRlZmF1bHRFZmZlY3Q7CgoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCgkJaGFzT3B0aW9ucyA9ICEkLmlzRW1wdHlPYmplY3QoIG9wdGlvbnMgKTsKCQlvcHRpb25zLmNvbXBsZXRlID0gY2FsbGJhY2s7CgoJCWlmICggb3B0aW9ucy5kZWxheSApIHsKCQkJZWxlbWVudC5kZWxheSggb3B0aW9ucy5kZWxheSApOwoJCX0KCgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIG1ldGhvZCBdKCBvcHRpb25zICk7CgkJfSBlbHNlIGlmICggZWZmZWN0TmFtZSAhPT0gbWV0aG9kICYmIGVsZW1lbnRbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgZWZmZWN0TmFtZSBdKCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgY2FsbGJhY2sgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50LnF1ZXVlKCBmdW5jdGlvbiggbmV4dCApIHsKCQkJCSQoIHRoaXMgKVsgbWV0aG9kIF0oKTsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCggZWxlbWVudFsgMCBdICk7CgkJCQl9CgkJCQluZXh0KCk7CgkJCX0gKTsKCQl9Cgl9Owp9ICk7Cgp2YXIgd2lkZ2V0ID0gJC53aWRnZXQ7CgoKLyohCiAqIGpRdWVyeSBVSSBQb3NpdGlvbiAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vcG9zaXRpb24vCiAqLwoKLy8+PmxhYmVsOiBQb3NpdGlvbgovLz4+Z3JvdXA6IENvcmUKLy8+PmRlc2NyaXB0aW9uOiBQb3NpdGlvbnMgZWxlbWVudHMgcmVsYXRpdmUgdG8gb3RoZXIgZWxlbWVudHMuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9wb3NpdGlvbi8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL3Bvc2l0aW9uLwoKCiggZnVuY3Rpb24oKSB7CnZhciBjYWNoZWRTY3JvbGxiYXJXaWR0aCwKCW1heCA9IE1hdGgubWF4LAoJYWJzID0gTWF0aC5hYnMsCglyaG9yaXpvbnRhbCA9IC9sZWZ0fGNlbnRlcnxyaWdodC8sCglydmVydGljYWwgPSAvdG9wfGNlbnRlcnxib3R0b20vLAoJcm9mZnNldCA9IC9bXCtcLV1cZCsoXC5bXGRdKyk/JT8vLAoJcnBvc2l0aW9uID0gL15cdysvLAoJcnBlcmNlbnQgPSAvJSQvLAoJX3Bvc2l0aW9uID0gJC5mbi5wb3NpdGlvbjsKCmZ1bmN0aW9uIGdldE9mZnNldHMoIG9mZnNldHMsIHdpZHRoLCBoZWlnaHQgKSB7CglyZXR1cm4gWwoJCXBhcnNlRmxvYXQoIG9mZnNldHNbIDAgXSApICogKCBycGVyY2VudC50ZXN0KCBvZmZzZXRzWyAwIF0gKSA/IHdpZHRoIC8gMTAwIDogMSApLAoJCXBhcnNlRmxvYXQoIG9mZnNldHNbIDEgXSApICogKCBycGVyY2VudC50ZXN0KCBvZmZzZXRzWyAxIF0gKSA/IGhlaWdodCAvIDEwMCA6IDEgKQoJXTsKfQoKZnVuY3Rpb24gcGFyc2VDc3MoIGVsZW1lbnQsIHByb3BlcnR5ICkgewoJcmV0dXJuIHBhcnNlSW50KCAkLmNzcyggZWxlbWVudCwgcHJvcGVydHkgKSwgMTAgKSB8fCAwOwp9CgpmdW5jdGlvbiBnZXREaW1lbnNpb25zKCBlbGVtICkgewoJdmFyIHJhdyA9IGVsZW1bIDAgXTsKCWlmICggcmF3Lm5vZGVUeXBlID09PSA5ICkgewoJCXJldHVybiB7CgkJCXdpZHRoOiBlbGVtLndpZHRoKCksCgkJCWhlaWdodDogZWxlbS5oZWlnaHQoKSwKCQkJb2Zmc2V0OiB7IHRvcDogMCwgbGVmdDogMCB9CgkJfTsKCX0KCWlmICggJC5pc1dpbmRvdyggcmF3ICkgKSB7CgkJcmV0dXJuIHsKCQkJd2lkdGg6IGVsZW0ud2lkdGgoKSwKCQkJaGVpZ2h0OiBlbGVtLmhlaWdodCgpLAoJCQlvZmZzZXQ6IHsgdG9wOiBlbGVtLnNjcm9sbFRvcCgpLCBsZWZ0OiBlbGVtLnNjcm9sbExlZnQoKSB9CgkJfTsKCX0KCWlmICggcmF3LnByZXZlbnREZWZhdWx0ICkgewoJCXJldHVybiB7CgkJCXdpZHRoOiAwLAoJCQloZWlnaHQ6IDAsCgkJCW9mZnNldDogeyB0b3A6IHJhdy5wYWdlWSwgbGVmdDogcmF3LnBhZ2VYIH0KCQl9OwoJfQoJcmV0dXJuIHsKCQl3aWR0aDogZWxlbS5vdXRlcldpZHRoKCksCgkJaGVpZ2h0OiBlbGVtLm91dGVySGVpZ2h0KCksCgkJb2Zmc2V0OiBlbGVtLm9mZnNldCgpCgl9Owp9CgokLnBvc2l0aW9uID0gewoJc2Nyb2xsYmFyV2lkdGg6IGZ1bmN0aW9uKCkgewoJCWlmICggY2FjaGVkU2Nyb2xsYmFyV2lkdGggIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIGNhY2hlZFNjcm9sbGJhcldpZHRoOwoJCX0KCQl2YXIgdzEsIHcyLAoJCQlkaXYgPSAkKCAiPGRpdiAiICsKCQkJCSJzdHlsZT0nZGlzcGxheTpibG9jaztwb3NpdGlvbjphYnNvbHV0ZTt3aWR0aDo1MHB4O2hlaWdodDo1MHB4O292ZXJmbG93OmhpZGRlbjsnPiIgKwoJCQkJIjxkaXYgc3R5bGU9J2hlaWdodDoxMDBweDt3aWR0aDphdXRvOyc+PC9kaXY+PC9kaXY+IiApLAoJCQlpbm5lckRpdiA9IGRpdi5jaGlsZHJlbigpWyAwIF07CgoJCSQoICJib2R5IiApLmFwcGVuZCggZGl2ICk7CgkJdzEgPSBpbm5lckRpdi5vZmZzZXRXaWR0aDsKCQlkaXYuY3NzKCAib3ZlcmZsb3ciLCAic2Nyb2xsIiApOwoKCQl3MiA9IGlubmVyRGl2Lm9mZnNldFdpZHRoOwoKCQlpZiAoIHcxID09PSB3MiApIHsKCQkJdzIgPSBkaXZbIDAgXS5jbGllbnRXaWR0aDsKCQl9CgoJCWRpdi5yZW1vdmUoKTsKCgkJcmV0dXJuICggY2FjaGVkU2Nyb2xsYmFyV2lkdGggPSB3MSAtIHcyICk7Cgl9LAoJZ2V0U2Nyb2xsSW5mbzogZnVuY3Rpb24oIHdpdGhpbiApIHsKCQl2YXIgb3ZlcmZsb3dYID0gd2l0aGluLmlzV2luZG93IHx8IHdpdGhpbi5pc0RvY3VtZW50ID8gIiIgOgoJCQkJd2l0aGluLmVsZW1lbnQuY3NzKCAib3ZlcmZsb3cteCIgKSwKCQkJb3ZlcmZsb3dZID0gd2l0aGluLmlzV2luZG93IHx8IHdpdGhpbi5pc0RvY3VtZW50ID8gIiIgOgoJCQkJd2l0aGluLmVsZW1lbnQuY3NzKCAib3ZlcmZsb3cteSIgKSwKCQkJaGFzT3ZlcmZsb3dYID0gb3ZlcmZsb3dYID09PSAic2Nyb2xsIiB8fAoJCQkJKCBvdmVyZmxvd1ggPT09ICJhdXRvIiAmJiB3aXRoaW4ud2lkdGggPCB3aXRoaW4uZWxlbWVudFsgMCBdLnNjcm9sbFdpZHRoICksCgkJCWhhc092ZXJmbG93WSA9IG92ZXJmbG93WSA9PT0gInNjcm9sbCIgfHwKCQkJCSggb3ZlcmZsb3dZID09PSAiYXV0byIgJiYgd2l0aGluLmhlaWdodCA8IHdpdGhpbi5lbGVtZW50WyAwIF0uc2Nyb2xsSGVpZ2h0ICk7CgkJcmV0dXJuIHsKCQkJd2lkdGg6IGhhc092ZXJmbG93WSA/ICQucG9zaXRpb24uc2Nyb2xsYmFyV2lkdGgoKSA6IDAsCgkJCWhlaWdodDogaGFzT3ZlcmZsb3dYID8gJC5wb3NpdGlvbi5zY3JvbGxiYXJXaWR0aCgpIDogMAoJCX07Cgl9LAoJZ2V0V2l0aGluSW5mbzogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdmFyIHdpdGhpbkVsZW1lbnQgPSAkKCBlbGVtZW50IHx8IHdpbmRvdyApLAoJCQlpc1dpbmRvdyA9ICQuaXNXaW5kb3coIHdpdGhpbkVsZW1lbnRbIDAgXSApLAoJCQlpc0RvY3VtZW50ID0gISF3aXRoaW5FbGVtZW50WyAwIF0gJiYgd2l0aGluRWxlbWVudFsgMCBdLm5vZGVUeXBlID09PSA5LAoJCQloYXNPZmZzZXQgPSAhaXNXaW5kb3cgJiYgIWlzRG9jdW1lbnQ7CgkJcmV0dXJuIHsKCQkJZWxlbWVudDogd2l0aGluRWxlbWVudCwKCQkJaXNXaW5kb3c6IGlzV2luZG93LAoJCQlpc0RvY3VtZW50OiBpc0RvY3VtZW50LAoJCQlvZmZzZXQ6IGhhc09mZnNldCA/ICQoIGVsZW1lbnQgKS5vZmZzZXQoKSA6IHsgbGVmdDogMCwgdG9wOiAwIH0sCgkJCXNjcm9sbExlZnQ6IHdpdGhpbkVsZW1lbnQuc2Nyb2xsTGVmdCgpLAoJCQlzY3JvbGxUb3A6IHdpdGhpbkVsZW1lbnQuc2Nyb2xsVG9wKCksCgkJCXdpZHRoOiB3aXRoaW5FbGVtZW50Lm91dGVyV2lkdGgoKSwKCQkJaGVpZ2h0OiB3aXRoaW5FbGVtZW50Lm91dGVySGVpZ2h0KCkKCQl9OwoJfQp9OwoKJC5mbi5wb3NpdGlvbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJaWYgKCAhb3B0aW9ucyB8fCAhb3B0aW9ucy5vZiApIHsKCQlyZXR1cm4gX3Bvc2l0aW9uLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCX0KCgkvLyBNYWtlIGEgY29weSwgd2UgZG9uJ3Qgd2FudCB0byBtb2RpZnkgYXJndW1lbnRzCglvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJdmFyIGF0T2Zmc2V0LCB0YXJnZXRXaWR0aCwgdGFyZ2V0SGVpZ2h0LCB0YXJnZXRPZmZzZXQsIGJhc2VQb3NpdGlvbiwgZGltZW5zaW9ucywKCQl0YXJnZXQgPSAkKCBvcHRpb25zLm9mICksCgkJd2l0aGluID0gJC5wb3NpdGlvbi5nZXRXaXRoaW5JbmZvKCBvcHRpb25zLndpdGhpbiApLAoJCXNjcm9sbEluZm8gPSAkLnBvc2l0aW9uLmdldFNjcm9sbEluZm8oIHdpdGhpbiApLAoJCWNvbGxpc2lvbiA9ICggb3B0aW9ucy5jb2xsaXNpb24gfHwgImZsaXAiICkuc3BsaXQoICIgIiApLAoJCW9mZnNldHMgPSB7fTsKCglkaW1lbnNpb25zID0gZ2V0RGltZW5zaW9ucyggdGFyZ2V0ICk7CglpZiAoIHRhcmdldFsgMCBdLnByZXZlbnREZWZhdWx0ICkgewoKCQkvLyBGb3JjZSBsZWZ0IHRvcCB0byBhbGxvdyBmbGlwcGluZwoJCW9wdGlvbnMuYXQgPSAibGVmdCB0b3AiOwoJfQoJdGFyZ2V0V2lkdGggPSBkaW1lbnNpb25zLndpZHRoOwoJdGFyZ2V0SGVpZ2h0ID0gZGltZW5zaW9ucy5oZWlnaHQ7Cgl0YXJnZXRPZmZzZXQgPSBkaW1lbnNpb25zLm9mZnNldDsKCgkvLyBDbG9uZSB0byByZXVzZSBvcmlnaW5hbCB0YXJnZXRPZmZzZXQgbGF0ZXIKCWJhc2VQb3NpdGlvbiA9ICQuZXh0ZW5kKCB7fSwgdGFyZ2V0T2Zmc2V0ICk7CgoJLy8gRm9yY2UgbXkgYW5kIGF0IHRvIGhhdmUgdmFsaWQgaG9yaXpvbnRhbCBhbmQgdmVydGljYWwgcG9zaXRpb25zCgkvLyBpZiBhIHZhbHVlIGlzIG1pc3Npbmcgb3IgaW52YWxpZCwgaXQgd2lsbCBiZSBjb252ZXJ0ZWQgdG8gY2VudGVyCgkkLmVhY2goIFsgIm15IiwgImF0IiBdLCBmdW5jdGlvbigpIHsKCQl2YXIgcG9zID0gKCBvcHRpb25zWyB0aGlzIF0gfHwgIiIgKS5zcGxpdCggIiAiICksCgkJCWhvcml6b250YWxPZmZzZXQsCgkJCXZlcnRpY2FsT2Zmc2V0OwoKCQlpZiAoIHBvcy5sZW5ndGggPT09IDEgKSB7CgkJCXBvcyA9IHJob3Jpem9udGFsLnRlc3QoIHBvc1sgMCBdICkgPwoJCQkJcG9zLmNvbmNhdCggWyAiY2VudGVyIiBdICkgOgoJCQkJcnZlcnRpY2FsLnRlc3QoIHBvc1sgMCBdICkgPwoJCQkJCVsgImNlbnRlciIgXS5jb25jYXQoIHBvcyApIDoKCQkJCQlbICJjZW50ZXIiLCAiY2VudGVyIiBdOwoJCX0KCQlwb3NbIDAgXSA9IHJob3Jpem9udGFsLnRlc3QoIHBvc1sgMCBdICkgPyBwb3NbIDAgXSA6ICJjZW50ZXIiOwoJCXBvc1sgMSBdID0gcnZlcnRpY2FsLnRlc3QoIHBvc1sgMSBdICkgPyBwb3NbIDEgXSA6ICJjZW50ZXIiOwoKCQkvLyBDYWxjdWxhdGUgb2Zmc2V0cwoJCWhvcml6b250YWxPZmZzZXQgPSByb2Zmc2V0LmV4ZWMoIHBvc1sgMCBdICk7CgkJdmVydGljYWxPZmZzZXQgPSByb2Zmc2V0LmV4ZWMoIHBvc1sgMSBdICk7CgkJb2Zmc2V0c1sgdGhpcyBdID0gWwoJCQlob3Jpem9udGFsT2Zmc2V0ID8gaG9yaXpvbnRhbE9mZnNldFsgMCBdIDogMCwKCQkJdmVydGljYWxPZmZzZXQgPyB2ZXJ0aWNhbE9mZnNldFsgMCBdIDogMAoJCV07CgoJCS8vIFJlZHVjZSB0byBqdXN0IHRoZSBwb3NpdGlvbnMgd2l0aG91dCB0aGUgb2Zmc2V0cwoJCW9wdGlvbnNbIHRoaXMgXSA9IFsKCQkJcnBvc2l0aW9uLmV4ZWMoIHBvc1sgMCBdIClbIDAgXSwKCQkJcnBvc2l0aW9uLmV4ZWMoIHBvc1sgMSBdIClbIDAgXQoJCV07Cgl9ICk7CgoJLy8gTm9ybWFsaXplIGNvbGxpc2lvbiBvcHRpb24KCWlmICggY29sbGlzaW9uLmxlbmd0aCA9PT0gMSApIHsKCQljb2xsaXNpb25bIDEgXSA9IGNvbGxpc2lvblsgMCBdOwoJfQoKCWlmICggb3B0aW9ucy5hdFsgMCBdID09PSAicmlnaHQiICkgewoJCWJhc2VQb3NpdGlvbi5sZWZ0ICs9IHRhcmdldFdpZHRoOwoJfSBlbHNlIGlmICggb3B0aW9ucy5hdFsgMCBdID09PSAiY2VudGVyIiApIHsKCQliYXNlUG9zaXRpb24ubGVmdCArPSB0YXJnZXRXaWR0aCAvIDI7Cgl9CgoJaWYgKCBvcHRpb25zLmF0WyAxIF0gPT09ICJib3R0b20iICkgewoJCWJhc2VQb3NpdGlvbi50b3AgKz0gdGFyZ2V0SGVpZ2h0OwoJfSBlbHNlIGlmICggb3B0aW9ucy5hdFsgMSBdID09PSAiY2VudGVyIiApIHsKCQliYXNlUG9zaXRpb24udG9wICs9IHRhcmdldEhlaWdodCAvIDI7Cgl9CgoJYXRPZmZzZXQgPSBnZXRPZmZzZXRzKCBvZmZzZXRzLmF0LCB0YXJnZXRXaWR0aCwgdGFyZ2V0SGVpZ2h0ICk7CgliYXNlUG9zaXRpb24ubGVmdCArPSBhdE9mZnNldFsgMCBdOwoJYmFzZVBvc2l0aW9uLnRvcCArPSBhdE9mZnNldFsgMSBdOwoKCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCXZhciBjb2xsaXNpb25Qb3NpdGlvbiwgdXNpbmcsCgkJCWVsZW0gPSAkKCB0aGlzICksCgkJCWVsZW1XaWR0aCA9IGVsZW0ub3V0ZXJXaWR0aCgpLAoJCQllbGVtSGVpZ2h0ID0gZWxlbS5vdXRlckhlaWdodCgpLAoJCQltYXJnaW5MZWZ0ID0gcGFyc2VDc3MoIHRoaXMsICJtYXJnaW5MZWZ0IiApLAoJCQltYXJnaW5Ub3AgPSBwYXJzZUNzcyggdGhpcywgIm1hcmdpblRvcCIgKSwKCQkJY29sbGlzaW9uV2lkdGggPSBlbGVtV2lkdGggKyBtYXJnaW5MZWZ0ICsgcGFyc2VDc3MoIHRoaXMsICJtYXJnaW5SaWdodCIgKSArCgkJCQlzY3JvbGxJbmZvLndpZHRoLAoJCQljb2xsaXNpb25IZWlnaHQgPSBlbGVtSGVpZ2h0ICsgbWFyZ2luVG9wICsgcGFyc2VDc3MoIHRoaXMsICJtYXJnaW5Cb3R0b20iICkgKwoJCQkJc2Nyb2xsSW5mby5oZWlnaHQsCgkJCXBvc2l0aW9uID0gJC5leHRlbmQoIHt9LCBiYXNlUG9zaXRpb24gKSwKCQkJbXlPZmZzZXQgPSBnZXRPZmZzZXRzKCBvZmZzZXRzLm15LCBlbGVtLm91dGVyV2lkdGgoKSwgZWxlbS5vdXRlckhlaWdodCgpICk7CgoJCWlmICggb3B0aW9ucy5teVsgMCBdID09PSAicmlnaHQiICkgewoJCQlwb3NpdGlvbi5sZWZ0IC09IGVsZW1XaWR0aDsKCQl9IGVsc2UgaWYgKCBvcHRpb25zLm15WyAwIF0gPT09ICJjZW50ZXIiICkgewoJCQlwb3NpdGlvbi5sZWZ0IC09IGVsZW1XaWR0aCAvIDI7CgkJfQoKCQlpZiAoIG9wdGlvbnMubXlbIDEgXSA9PT0gImJvdHRvbSIgKSB7CgkJCXBvc2l0aW9uLnRvcCAtPSBlbGVtSGVpZ2h0OwoJCX0gZWxzZSBpZiAoIG9wdGlvbnMubXlbIDEgXSA9PT0gImNlbnRlciIgKSB7CgkJCXBvc2l0aW9uLnRvcCAtPSBlbGVtSGVpZ2h0IC8gMjsKCQl9CgoJCXBvc2l0aW9uLmxlZnQgKz0gbXlPZmZzZXRbIDAgXTsKCQlwb3NpdGlvbi50b3AgKz0gbXlPZmZzZXRbIDEgXTsKCgkJY29sbGlzaW9uUG9zaXRpb24gPSB7CgkJCW1hcmdpbkxlZnQ6IG1hcmdpbkxlZnQsCgkJCW1hcmdpblRvcDogbWFyZ2luVG9wCgkJfTsKCgkJJC5lYWNoKCBbICJsZWZ0IiwgInRvcCIgXSwgZnVuY3Rpb24oIGksIGRpciApIHsKCQkJaWYgKCAkLnVpLnBvc2l0aW9uWyBjb2xsaXNpb25bIGkgXSBdICkgewoJCQkJJC51aS5wb3NpdGlvblsgY29sbGlzaW9uWyBpIF0gXVsgZGlyIF0oIHBvc2l0aW9uLCB7CgkJCQkJdGFyZ2V0V2lkdGg6IHRhcmdldFdpZHRoLAoJCQkJCXRhcmdldEhlaWdodDogdGFyZ2V0SGVpZ2h0LAoJCQkJCWVsZW1XaWR0aDogZWxlbVdpZHRoLAoJCQkJCWVsZW1IZWlnaHQ6IGVsZW1IZWlnaHQsCgkJCQkJY29sbGlzaW9uUG9zaXRpb246IGNvbGxpc2lvblBvc2l0aW9uLAoJCQkJCWNvbGxpc2lvbldpZHRoOiBjb2xsaXNpb25XaWR0aCwKCQkJCQljb2xsaXNpb25IZWlnaHQ6IGNvbGxpc2lvbkhlaWdodCwKCQkJCQlvZmZzZXQ6IFsgYXRPZmZzZXRbIDAgXSArIG15T2Zmc2V0WyAwIF0sIGF0T2Zmc2V0IFsgMSBdICsgbXlPZmZzZXRbIDEgXSBdLAoJCQkJCW15OiBvcHRpb25zLm15LAoJCQkJCWF0OiBvcHRpb25zLmF0LAoJCQkJCXdpdGhpbjogd2l0aGluLAoJCQkJCWVsZW06IGVsZW0KCQkJCX0gKTsKCQkJfQoJCX0gKTsKCgkJaWYgKCBvcHRpb25zLnVzaW5nICkgewoKCQkJLy8gQWRkcyBmZWVkYmFjayBhcyBzZWNvbmQgYXJndW1lbnQgdG8gdXNpbmcgY2FsbGJhY2ssIGlmIHByZXNlbnQKCQkJdXNpbmcgPSBmdW5jdGlvbiggcHJvcHMgKSB7CgkJCQl2YXIgbGVmdCA9IHRhcmdldE9mZnNldC5sZWZ0IC0gcG9zaXRpb24ubGVmdCwKCQkJCQlyaWdodCA9IGxlZnQgKyB0YXJnZXRXaWR0aCAtIGVsZW1XaWR0aCwKCQkJCQl0b3AgPSB0YXJnZXRPZmZzZXQudG9wIC0gcG9zaXRpb24udG9wLAoJCQkJCWJvdHRvbSA9IHRvcCArIHRhcmdldEhlaWdodCAtIGVsZW1IZWlnaHQsCgkJCQkJZmVlZGJhY2sgPSB7CgkJCQkJCXRhcmdldDogewoJCQkJCQkJZWxlbWVudDogdGFyZ2V0LAoJCQkJCQkJbGVmdDogdGFyZ2V0T2Zmc2V0LmxlZnQsCgkJCQkJCQl0b3A6IHRhcmdldE9mZnNldC50b3AsCgkJCQkJCQl3aWR0aDogdGFyZ2V0V2lkdGgsCgkJCQkJCQloZWlnaHQ6IHRhcmdldEhlaWdodAoJCQkJCQl9LAoJCQkJCQllbGVtZW50OiB7CgkJCQkJCQllbGVtZW50OiBlbGVtLAoJCQkJCQkJbGVmdDogcG9zaXRpb24ubGVmdCwKCQkJCQkJCXRvcDogcG9zaXRpb24udG9wLAoJCQkJCQkJd2lkdGg6IGVsZW1XaWR0aCwKCQkJCQkJCWhlaWdodDogZWxlbUhlaWdodAoJCQkJCQl9LAoJCQkJCQlob3Jpem9udGFsOiByaWdodCA8IDAgPyAibGVmdCIgOiBsZWZ0ID4gMCA/ICJyaWdodCIgOiAiY2VudGVyIiwKCQkJCQkJdmVydGljYWw6IGJvdHRvbSA8IDAgPyAidG9wIiA6IHRvcCA+IDAgPyAiYm90dG9tIiA6ICJtaWRkbGUiCgkJCQkJfTsKCQkJCWlmICggdGFyZ2V0V2lkdGggPCBlbGVtV2lkdGggJiYgYWJzKCBsZWZ0ICsgcmlnaHQgKSA8IHRhcmdldFdpZHRoICkgewoJCQkJCWZlZWRiYWNrLmhvcml6b250YWwgPSAiY2VudGVyIjsKCQkJCX0KCQkJCWlmICggdGFyZ2V0SGVpZ2h0IDwgZWxlbUhlaWdodCAmJiBhYnMoIHRvcCArIGJvdHRvbSApIDwgdGFyZ2V0SGVpZ2h0ICkgewoJCQkJCWZlZWRiYWNrLnZlcnRpY2FsID0gIm1pZGRsZSI7CgkJCQl9CgkJCQlpZiAoIG1heCggYWJzKCBsZWZ0ICksIGFicyggcmlnaHQgKSApID4gbWF4KCBhYnMoIHRvcCApLCBhYnMoIGJvdHRvbSApICkgKSB7CgkJCQkJZmVlZGJhY2suaW1wb3J0YW50ID0gImhvcml6b250YWwiOwoJCQkJfSBlbHNlIHsKCQkJCQlmZWVkYmFjay5pbXBvcnRhbnQgPSAidmVydGljYWwiOwoJCQkJfQoJCQkJb3B0aW9ucy51c2luZy5jYWxsKCB0aGlzLCBwcm9wcywgZmVlZGJhY2sgKTsKCQkJfTsKCQl9CgoJCWVsZW0ub2Zmc2V0KCAkLmV4dGVuZCggcG9zaXRpb24sIHsgdXNpbmc6IHVzaW5nIH0gKSApOwoJfSApOwp9OwoKJC51aS5wb3NpdGlvbiA9IHsKCWZpdDogewoJCWxlZnQ6IGZ1bmN0aW9uKCBwb3NpdGlvbiwgZGF0YSApIHsKCQkJdmFyIHdpdGhpbiA9IGRhdGEud2l0aGluLAoJCQkJd2l0aGluT2Zmc2V0ID0gd2l0aGluLmlzV2luZG93ID8gd2l0aGluLnNjcm9sbExlZnQgOiB3aXRoaW4ub2Zmc2V0LmxlZnQsCgkJCQlvdXRlcldpZHRoID0gd2l0aGluLndpZHRoLAoJCQkJY29sbGlzaW9uUG9zTGVmdCA9IHBvc2l0aW9uLmxlZnQgLSBkYXRhLmNvbGxpc2lvblBvc2l0aW9uLm1hcmdpbkxlZnQsCgkJCQlvdmVyTGVmdCA9IHdpdGhpbk9mZnNldCAtIGNvbGxpc2lvblBvc0xlZnQsCgkJCQlvdmVyUmlnaHQgPSBjb2xsaXNpb25Qb3NMZWZ0ICsgZGF0YS5jb2xsaXNpb25XaWR0aCAtIG91dGVyV2lkdGggLSB3aXRoaW5PZmZzZXQsCgkJCQluZXdPdmVyUmlnaHQ7CgoJCQkvLyBFbGVtZW50IGlzIHdpZGVyIHRoYW4gd2l0aGluCgkJCWlmICggZGF0YS5jb2xsaXNpb25XaWR0aCA+IG91dGVyV2lkdGggKSB7CgoJCQkJLy8gRWxlbWVudCBpcyBpbml0aWFsbHkgb3ZlciB0aGUgbGVmdCBzaWRlIG9mIHdpdGhpbgoJCQkJaWYgKCBvdmVyTGVmdCA+IDAgJiYgb3ZlclJpZ2h0IDw9IDAgKSB7CgkJCQkJbmV3T3ZlclJpZ2h0ID0gcG9zaXRpb24ubGVmdCArIG92ZXJMZWZ0ICsgZGF0YS5jb2xsaXNpb25XaWR0aCAtIG91dGVyV2lkdGggLQoJCQkJCQl3aXRoaW5PZmZzZXQ7CgkJCQkJcG9zaXRpb24ubGVmdCArPSBvdmVyTGVmdCAtIG5ld092ZXJSaWdodDsKCgkJCQkvLyBFbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIHJpZ2h0IHNpZGUgb2Ygd2l0aGluCgkJCQl9IGVsc2UgaWYgKCBvdmVyUmlnaHQgPiAwICYmIG92ZXJMZWZ0IDw9IDAgKSB7CgkJCQkJcG9zaXRpb24ubGVmdCA9IHdpdGhpbk9mZnNldDsKCgkJCQkvLyBFbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIGJvdGggbGVmdCBhbmQgcmlnaHQgc2lkZXMgb2Ygd2l0aGluCgkJCQl9IGVsc2UgewoJCQkJCWlmICggb3ZlckxlZnQgPiBvdmVyUmlnaHQgKSB7CgkJCQkJCXBvc2l0aW9uLmxlZnQgPSB3aXRoaW5PZmZzZXQgKyBvdXRlcldpZHRoIC0gZGF0YS5jb2xsaXNpb25XaWR0aDsKCQkJCQl9IGVsc2UgewoJCQkJCQlwb3NpdGlvbi5sZWZ0ID0gd2l0aGluT2Zmc2V0OwoJCQkJCX0KCQkJCX0KCgkJCS8vIFRvbyBmYXIgbGVmdCAtPiBhbGlnbiB3aXRoIGxlZnQgZWRnZQoJCQl9IGVsc2UgaWYgKCBvdmVyTGVmdCA+IDAgKSB7CgkJCQlwb3NpdGlvbi5sZWZ0ICs9IG92ZXJMZWZ0OwoKCQkJLy8gVG9vIGZhciByaWdodCAtPiBhbGlnbiB3aXRoIHJpZ2h0IGVkZ2UKCQkJfSBlbHNlIGlmICggb3ZlclJpZ2h0ID4gMCApIHsKCQkJCXBvc2l0aW9uLmxlZnQgLT0gb3ZlclJpZ2h0OwoKCQkJLy8gQWRqdXN0IGJhc2VkIG9uIHBvc2l0aW9uIGFuZCBtYXJnaW4KCQkJfSBlbHNlIHsKCQkJCXBvc2l0aW9uLmxlZnQgPSBtYXgoIHBvc2l0aW9uLmxlZnQgLSBjb2xsaXNpb25Qb3NMZWZ0LCBwb3NpdGlvbi5sZWZ0ICk7CgkJCX0KCQl9LAoJCXRvcDogZnVuY3Rpb24oIHBvc2l0aW9uLCBkYXRhICkgewoJCQl2YXIgd2l0aGluID0gZGF0YS53aXRoaW4sCgkJCQl3aXRoaW5PZmZzZXQgPSB3aXRoaW4uaXNXaW5kb3cgPyB3aXRoaW4uc2Nyb2xsVG9wIDogd2l0aGluLm9mZnNldC50b3AsCgkJCQlvdXRlckhlaWdodCA9IGRhdGEud2l0aGluLmhlaWdodCwKCQkJCWNvbGxpc2lvblBvc1RvcCA9IHBvc2l0aW9uLnRvcCAtIGRhdGEuY29sbGlzaW9uUG9zaXRpb24ubWFyZ2luVG9wLAoJCQkJb3ZlclRvcCA9IHdpdGhpbk9mZnNldCAtIGNvbGxpc2lvblBvc1RvcCwKCQkJCW92ZXJCb3R0b20gPSBjb2xsaXNpb25Qb3NUb3AgKyBkYXRhLmNvbGxpc2lvbkhlaWdodCAtIG91dGVySGVpZ2h0IC0gd2l0aGluT2Zmc2V0LAoJCQkJbmV3T3ZlckJvdHRvbTsKCgkJCS8vIEVsZW1lbnQgaXMgdGFsbGVyIHRoYW4gd2l0aGluCgkJCWlmICggZGF0YS5jb2xsaXNpb25IZWlnaHQgPiBvdXRlckhlaWdodCApIHsKCgkJCQkvLyBFbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIHRoZSB0b3Agb2Ygd2l0aGluCgkJCQlpZiAoIG92ZXJUb3AgPiAwICYmIG92ZXJCb3R0b20gPD0gMCApIHsKCQkJCQluZXdPdmVyQm90dG9tID0gcG9zaXRpb24udG9wICsgb3ZlclRvcCArIGRhdGEuY29sbGlzaW9uSGVpZ2h0IC0gb3V0ZXJIZWlnaHQgLQoJCQkJCQl3aXRoaW5PZmZzZXQ7CgkJCQkJcG9zaXRpb24udG9wICs9IG92ZXJUb3AgLSBuZXdPdmVyQm90dG9tOwoKCQkJCS8vIEVsZW1lbnQgaXMgaW5pdGlhbGx5IG92ZXIgYm90dG9tIG9mIHdpdGhpbgoJCQkJfSBlbHNlIGlmICggb3ZlckJvdHRvbSA+IDAgJiYgb3ZlclRvcCA8PSAwICkgewoJCQkJCXBvc2l0aW9uLnRvcCA9IHdpdGhpbk9mZnNldDsKCgkJCQkvLyBFbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIGJvdGggdG9wIGFuZCBib3R0b20gb2Ygd2l0aGluCgkJCQl9IGVsc2UgewoJCQkJCWlmICggb3ZlclRvcCA+IG92ZXJCb3R0b20gKSB7CgkJCQkJCXBvc2l0aW9uLnRvcCA9IHdpdGhpbk9mZnNldCArIG91dGVySGVpZ2h0IC0gZGF0YS5jb2xsaXNpb25IZWlnaHQ7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcG9zaXRpb24udG9wID0gd2l0aGluT2Zmc2V0OwoJCQkJCX0KCQkJCX0KCgkJCS8vIFRvbyBmYXIgdXAgLT4gYWxpZ24gd2l0aCB0b3AKCQkJfSBlbHNlIGlmICggb3ZlclRvcCA+IDAgKSB7CgkJCQlwb3NpdGlvbi50b3AgKz0gb3ZlclRvcDsKCgkJCS8vIFRvbyBmYXIgZG93biAtPiBhbGlnbiB3aXRoIGJvdHRvbSBlZGdlCgkJCX0gZWxzZSBpZiAoIG92ZXJCb3R0b20gPiAwICkgewoJCQkJcG9zaXRpb24udG9wIC09IG92ZXJCb3R0b207CgoJCQkvLyBBZGp1c3QgYmFzZWQgb24gcG9zaXRpb24gYW5kIG1hcmdpbgoJCQl9IGVsc2UgewoJCQkJcG9zaXRpb24udG9wID0gbWF4KCBwb3NpdGlvbi50b3AgLSBjb2xsaXNpb25Qb3NUb3AsIHBvc2l0aW9uLnRvcCApOwoJCQl9CgkJfQoJfSwKCWZsaXA6IHsKCQlsZWZ0OiBmdW5jdGlvbiggcG9zaXRpb24sIGRhdGEgKSB7CgkJCXZhciB3aXRoaW4gPSBkYXRhLndpdGhpbiwKCQkJCXdpdGhpbk9mZnNldCA9IHdpdGhpbi5vZmZzZXQubGVmdCArIHdpdGhpbi5zY3JvbGxMZWZ0LAoJCQkJb3V0ZXJXaWR0aCA9IHdpdGhpbi53aWR0aCwKCQkJCW9mZnNldExlZnQgPSB3aXRoaW4uaXNXaW5kb3cgPyB3aXRoaW4uc2Nyb2xsTGVmdCA6IHdpdGhpbi5vZmZzZXQubGVmdCwKCQkJCWNvbGxpc2lvblBvc0xlZnQgPSBwb3NpdGlvbi5sZWZ0IC0gZGF0YS5jb2xsaXNpb25Qb3NpdGlvbi5tYXJnaW5MZWZ0LAoJCQkJb3ZlckxlZnQgPSBjb2xsaXNpb25Qb3NMZWZ0IC0gb2Zmc2V0TGVmdCwKCQkJCW92ZXJSaWdodCA9IGNvbGxpc2lvblBvc0xlZnQgKyBkYXRhLmNvbGxpc2lvbldpZHRoIC0gb3V0ZXJXaWR0aCAtIG9mZnNldExlZnQsCgkJCQlteU9mZnNldCA9IGRhdGEubXlbIDAgXSA9PT0gImxlZnQiID8KCQkJCQktZGF0YS5lbGVtV2lkdGggOgoJCQkJCWRhdGEubXlbIDAgXSA9PT0gInJpZ2h0IiA/CgkJCQkJCWRhdGEuZWxlbVdpZHRoIDoKCQkJCQkJMCwKCQkJCWF0T2Zmc2V0ID0gZGF0YS5hdFsgMCBdID09PSAibGVmdCIgPwoJCQkJCWRhdGEudGFyZ2V0V2lkdGggOgoJCQkJCWRhdGEuYXRbIDAgXSA9PT0gInJpZ2h0IiA/CgkJCQkJCS1kYXRhLnRhcmdldFdpZHRoIDoKCQkJCQkJMCwKCQkJCW9mZnNldCA9IC0yICogZGF0YS5vZmZzZXRbIDAgXSwKCQkJCW5ld092ZXJSaWdodCwKCQkJCW5ld092ZXJMZWZ0OwoKCQkJaWYgKCBvdmVyTGVmdCA8IDAgKSB7CgkJCQluZXdPdmVyUmlnaHQgPSBwb3NpdGlvbi5sZWZ0ICsgbXlPZmZzZXQgKyBhdE9mZnNldCArIG9mZnNldCArIGRhdGEuY29sbGlzaW9uV2lkdGggLQoJCQkJCW91dGVyV2lkdGggLSB3aXRoaW5PZmZzZXQ7CgkJCQlpZiAoIG5ld092ZXJSaWdodCA8IDAgfHwgbmV3T3ZlclJpZ2h0IDwgYWJzKCBvdmVyTGVmdCApICkgewoJCQkJCXBvc2l0aW9uLmxlZnQgKz0gbXlPZmZzZXQgKyBhdE9mZnNldCArIG9mZnNldDsKCQkJCX0KCQkJfSBlbHNlIGlmICggb3ZlclJpZ2h0ID4gMCApIHsKCQkJCW5ld092ZXJMZWZ0ID0gcG9zaXRpb24ubGVmdCAtIGRhdGEuY29sbGlzaW9uUG9zaXRpb24ubWFyZ2luTGVmdCArIG15T2Zmc2V0ICsKCQkJCQlhdE9mZnNldCArIG9mZnNldCAtIG9mZnNldExlZnQ7CgkJCQlpZiAoIG5ld092ZXJMZWZ0ID4gMCB8fCBhYnMoIG5ld092ZXJMZWZ0ICkgPCBvdmVyUmlnaHQgKSB7CgkJCQkJcG9zaXRpb24ubGVmdCArPSBteU9mZnNldCArIGF0T2Zmc2V0ICsgb2Zmc2V0OwoJCQkJfQoJCQl9CgkJfSwKCQl0b3A6IGZ1bmN0aW9uKCBwb3NpdGlvbiwgZGF0YSApIHsKCQkJdmFyIHdpdGhpbiA9IGRhdGEud2l0aGluLAoJCQkJd2l0aGluT2Zmc2V0ID0gd2l0aGluLm9mZnNldC50b3AgKyB3aXRoaW4uc2Nyb2xsVG9wLAoJCQkJb3V0ZXJIZWlnaHQgPSB3aXRoaW4uaGVpZ2h0LAoJCQkJb2Zmc2V0VG9wID0gd2l0aGluLmlzV2luZG93ID8gd2l0aGluLnNjcm9sbFRvcCA6IHdpdGhpbi5vZmZzZXQudG9wLAoJCQkJY29sbGlzaW9uUG9zVG9wID0gcG9zaXRpb24udG9wIC0gZGF0YS5jb2xsaXNpb25Qb3NpdGlvbi5tYXJnaW5Ub3AsCgkJCQlvdmVyVG9wID0gY29sbGlzaW9uUG9zVG9wIC0gb2Zmc2V0VG9wLAoJCQkJb3ZlckJvdHRvbSA9IGNvbGxpc2lvblBvc1RvcCArIGRhdGEuY29sbGlzaW9uSGVpZ2h0IC0gb3V0ZXJIZWlnaHQgLSBvZmZzZXRUb3AsCgkJCQl0b3AgPSBkYXRhLm15WyAxIF0gPT09ICJ0b3AiLAoJCQkJbXlPZmZzZXQgPSB0b3AgPwoJCQkJCS1kYXRhLmVsZW1IZWlnaHQgOgoJCQkJCWRhdGEubXlbIDEgXSA9PT0gImJvdHRvbSIgPwoJCQkJCQlkYXRhLmVsZW1IZWlnaHQgOgoJCQkJCQkwLAoJCQkJYXRPZmZzZXQgPSBkYXRhLmF0WyAxIF0gPT09ICJ0b3AiID8KCQkJCQlkYXRhLnRhcmdldEhlaWdodCA6CgkJCQkJZGF0YS5hdFsgMSBdID09PSAiYm90dG9tIiA/CgkJCQkJCS1kYXRhLnRhcmdldEhlaWdodCA6CgkJCQkJCTAsCgkJCQlvZmZzZXQgPSAtMiAqIGRhdGEub2Zmc2V0WyAxIF0sCgkJCQluZXdPdmVyVG9wLAoJCQkJbmV3T3ZlckJvdHRvbTsKCQkJaWYgKCBvdmVyVG9wIDwgMCApIHsKCQkJCW5ld092ZXJCb3R0b20gPSBwb3NpdGlvbi50b3AgKyBteU9mZnNldCArIGF0T2Zmc2V0ICsgb2Zmc2V0ICsgZGF0YS5jb2xsaXNpb25IZWlnaHQgLQoJCQkJCW91dGVySGVpZ2h0IC0gd2l0aGluT2Zmc2V0OwoJCQkJaWYgKCBuZXdPdmVyQm90dG9tIDwgMCB8fCBuZXdPdmVyQm90dG9tIDwgYWJzKCBvdmVyVG9wICkgKSB7CgkJCQkJcG9zaXRpb24udG9wICs9IG15T2Zmc2V0ICsgYXRPZmZzZXQgKyBvZmZzZXQ7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIG92ZXJCb3R0b20gPiAwICkgewoJCQkJbmV3T3ZlclRvcCA9IHBvc2l0aW9uLnRvcCAtIGRhdGEuY29sbGlzaW9uUG9zaXRpb24ubWFyZ2luVG9wICsgbXlPZmZzZXQgKyBhdE9mZnNldCArCgkJCQkJb2Zmc2V0IC0gb2Zmc2V0VG9wOwoJCQkJaWYgKCBuZXdPdmVyVG9wID4gMCB8fCBhYnMoIG5ld092ZXJUb3AgKSA8IG92ZXJCb3R0b20gKSB7CgkJCQkJcG9zaXRpb24udG9wICs9IG15T2Zmc2V0ICsgYXRPZmZzZXQgKyBvZmZzZXQ7CgkJCQl9CgkJCX0KCQl9Cgl9LAoJZmxpcGZpdDogewoJCWxlZnQ6IGZ1bmN0aW9uKCkgewoJCQkkLnVpLnBvc2l0aW9uLmZsaXAubGVmdC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCSQudWkucG9zaXRpb24uZml0LmxlZnQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCX0sCgkJdG9wOiBmdW5jdGlvbigpIHsKCQkJJC51aS5wb3NpdGlvbi5mbGlwLnRvcC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCSQudWkucG9zaXRpb24uZml0LnRvcC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfQoJfQp9OwoKfSApKCk7Cgp2YXIgcG9zaXRpb24gPSAkLnVpLnBvc2l0aW9uOwoKCi8qIQogKiBqUXVlcnkgVUkgOmRhdGEgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiA6ZGF0YSBTZWxlY3RvcgovLz4+Z3JvdXA6IENvcmUKLy8+PmRlc2NyaXB0aW9uOiBTZWxlY3RzIGVsZW1lbnRzIHdoaWNoIGhhdmUgZGF0YSBzdG9yZWQgdW5kZXIgdGhlIHNwZWNpZmllZCBrZXkuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9kYXRhLXNlbGVjdG9yLwoKCnZhciBkYXRhID0gJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWRhdGE6ICQuZXhwci5jcmVhdGVQc2V1ZG8gPwoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oIGZ1bmN0aW9uKCBkYXRhTmFtZSApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBkYXRhTmFtZSApOwoJCQl9OwoJCX0gKSA6CgoJCS8vIFN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG1hdGNoWyAzIF0gKTsKCQl9Cn0gKTsKCi8qIQogKiBqUXVlcnkgVUkgRGlzYWJsZSBTZWxlY3Rpb24gMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBkaXNhYmxlU2VsZWN0aW9uCi8vPj5ncm91cDogQ29yZQovLz4+ZGVzY3JpcHRpb246IERpc2FibGUgc2VsZWN0aW9uIG9mIHRleHQgY29udGVudCB3aXRoaW4gdGhlIHNldCBvZiBtYXRjaGVkIGVsZW1lbnRzLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZGlzYWJsZVNlbGVjdGlvbi8KCi8vIFRoaXMgZmlsZSBpcyBkZXByZWNhdGVkCgoKdmFyIGRpc2FibGVTZWxlY3Rpb24gPSAkLmZuLmV4dGVuZCggewoJZGlzYWJsZVNlbGVjdGlvbjogKCBmdW5jdGlvbigpIHsKCQl2YXIgZXZlbnRUeXBlID0gIm9uc2VsZWN0c3RhcnQiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICkgPwoJCQkic2VsZWN0c3RhcnQiIDoKCQkJIm1vdXNlZG93biI7CgoJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMub24oIGV2ZW50VHlwZSArICIudWktZGlzYWJsZVNlbGVjdGlvbiIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0gKTsKCQl9OwoJfSApKCksCgoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5vZmYoICIudWktZGlzYWJsZVNlbGVjdGlvbiIgKTsKCX0KfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRm9jdXNhYmxlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogOmZvY3VzYWJsZSBTZWxlY3RvcgovLz4+Z3JvdXA6IENvcmUKLy8+PmRlc2NyaXB0aW9uOiBTZWxlY3RzIGVsZW1lbnRzIHdoaWNoIGNhbiBiZSBmb2N1c2VkLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZm9jdXNhYmxlLXNlbGVjdG9yLwoKCgovLyBTZWxlY3RvcnMKJC51aS5mb2N1c2FibGUgPSBmdW5jdGlvbiggZWxlbWVudCwgaGFzVGFiaW5kZXggKSB7Cgl2YXIgbWFwLCBtYXBOYW1lLCBpbWcsIGZvY3VzYWJsZUlmVmlzaWJsZSwgZmllbGRzZXQsCgkJbm9kZU5hbWUgPSBlbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgoJaWYgKCAiYXJlYSIgPT09IG5vZGVOYW1lICkgewoJCW1hcCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQltYXBOYW1lID0gbWFwLm5hbWU7CgkJaWYgKCAhZWxlbWVudC5ocmVmIHx8ICFtYXBOYW1lIHx8IG1hcC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAibWFwIiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpbWcgPSAkKCAiaW1nW3VzZW1hcD0nIyIgKyBtYXBOYW1lICsgIiddIiApOwoJCXJldHVybiBpbWcubGVuZ3RoID4gMCAmJiBpbWcuaXMoICI6dmlzaWJsZSIgKTsKCX0KCglpZiAoIC9eKGlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0KSQvLnRlc3QoIG5vZGVOYW1lICkgKSB7CgkJZm9jdXNhYmxlSWZWaXNpYmxlID0gIWVsZW1lbnQuZGlzYWJsZWQ7CgoJCWlmICggZm9jdXNhYmxlSWZWaXNpYmxlICkgewoKCQkJLy8gRm9ybSBjb250cm9scyB3aXRoaW4gYSBkaXNhYmxlZCBmaWVsZHNldCBhcmUgZGlzYWJsZWQuCgkJCS8vIEhvd2V2ZXIsIGNvbnRyb2xzIHdpdGhpbiB0aGUgZmllbGRzZXQncyBsZWdlbmQgZG8gbm90IGdldCBkaXNhYmxlZC4KCQkJLy8gU2luY2UgY29udHJvbHMgZ2VuZXJhbGx5IGFyZW4ndCBwbGFjZWQgaW5zaWRlIGxlZ2VuZHMsIHdlIHNraXAKCQkJLy8gdGhpcyBwb3J0aW9uIG9mIHRoZSBjaGVjay4KCQkJZmllbGRzZXQgPSAkKCBlbGVtZW50ICkuY2xvc2VzdCggImZpZWxkc2V0IiApWyAwIF07CgkJCWlmICggZmllbGRzZXQgKSB7CgkJCQlmb2N1c2FibGVJZlZpc2libGUgPSAhZmllbGRzZXQuZGlzYWJsZWQ7CgkJCX0KCQl9Cgl9IGVsc2UgaWYgKCAiYSIgPT09IG5vZGVOYW1lICkgewoJCWZvY3VzYWJsZUlmVmlzaWJsZSA9IGVsZW1lbnQuaHJlZiB8fCBoYXNUYWJpbmRleDsKCX0gZWxzZSB7CgkJZm9jdXNhYmxlSWZWaXNpYmxlID0gaGFzVGFiaW5kZXg7Cgl9CgoJcmV0dXJuIGZvY3VzYWJsZUlmVmlzaWJsZSAmJiAkKCBlbGVtZW50ICkuaXMoICI6dmlzaWJsZSIgKSAmJiB2aXNpYmxlKCAkKCBlbGVtZW50ICkgKTsKfTsKCi8vIFN1cHBvcnQ6IElFIDggb25seQovLyBJRSA4IGRvZXNuJ3QgcmVzb2x2ZSBpbmhlcml0IHRvIHZpc2libGUvaGlkZGVuIGZvciBjb21wdXRlZCB2YWx1ZXMKZnVuY3Rpb24gdmlzaWJsZSggZWxlbWVudCApIHsKCXZhciB2aXNpYmlsaXR5ID0gZWxlbWVudC5jc3MoICJ2aXNpYmlsaXR5IiApOwoJd2hpbGUgKCB2aXNpYmlsaXR5ID09PSAiaW5oZXJpdCIgKSB7CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50KCk7CgkJdmlzaWJpbGl0eSA9IGVsZW1lbnQuY3NzKCAidmlzaWJpbGl0eSIgKTsKCX0KCXJldHVybiB2aXNpYmlsaXR5ICE9PSAiaGlkZGVuIjsKfQoKJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJcmV0dXJuICQudWkuZm9jdXNhYmxlKCBlbGVtZW50LCAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSAhPSBudWxsICk7Cgl9Cn0gKTsKCnZhciBmb2N1c2FibGUgPSAkLnVpLmZvY3VzYWJsZTsKCgoKCi8vIFN1cHBvcnQ6IElFOCBPbmx5Ci8vIElFOCBkb2VzIG5vdCBzdXBwb3J0IHRoZSBmb3JtIGF0dHJpYnV0ZSBhbmQgd2hlbiBpdCBpcyBzdXBwbGllZC4gSXQgb3ZlcndyaXRlcyB0aGUgZm9ybSBwcm9wCi8vIHdpdGggYSBzdHJpbmcsIHNvIHdlIG5lZWQgdG8gZmluZCB0aGUgcHJvcGVyIGZvcm0uCnZhciBmb3JtID0gJC5mbi5mb3JtID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gdHlwZW9mIHRoaXNbIDAgXS5mb3JtID09PSAic3RyaW5nIiA/IHRoaXMuY2xvc2VzdCggImZvcm0iICkgOiAkKCB0aGlzWyAwIF0uZm9ybSApOwp9OwoKCi8qIQogKiBqUXVlcnkgVUkgRm9ybSBSZXNldCBNaXhpbiAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IEZvcm0gUmVzZXQgTWl4aW4KLy8+Pmdyb3VwOiBDb3JlCi8vPj5kZXNjcmlwdGlvbjogUmVmcmVzaCBpbnB1dCB3aWRnZXRzIHdoZW4gdGhlaXIgZm9ybSBpcyByZXNldAovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZm9ybS1yZXNldC1taXhpbi8KCgoKdmFyIGZvcm1SZXNldE1peGluID0gJC51aS5mb3JtUmVzZXRNaXhpbiA9IHsKCV9mb3JtUmVzZXRIYW5kbGVyOiBmdW5jdGlvbigpIHsKCQl2YXIgZm9ybSA9ICQoIHRoaXMgKTsKCgkJLy8gV2FpdCBmb3IgdGhlIGZvcm0gcmVzZXQgdG8gYWN0dWFsbHkgaGFwcGVuIGJlZm9yZSByZWZyZXNoaW5nCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXZhciBpbnN0YW5jZXMgPSBmb3JtLmRhdGEoICJ1aS1mb3JtLXJlc2V0LWluc3RhbmNlcyIgKTsKCQkJJC5lYWNoKCBpbnN0YW5jZXMsIGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5yZWZyZXNoKCk7CgkJCX0gKTsKCQl9ICk7Cgl9LAoKCV9iaW5kRm9ybVJlc2V0SGFuZGxlcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5mb3JtID0gdGhpcy5lbGVtZW50LmZvcm0oKTsKCQlpZiAoICF0aGlzLmZvcm0ubGVuZ3RoICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgaW5zdGFuY2VzID0gdGhpcy5mb3JtLmRhdGEoICJ1aS1mb3JtLXJlc2V0LWluc3RhbmNlcyIgKSB8fCBbXTsKCQlpZiAoICFpbnN0YW5jZXMubGVuZ3RoICkgewoKCQkJLy8gV2UgZG9uJ3QgdXNlIF9vbigpIGhlcmUgYmVjYXVzZSB3ZSB1c2UgYSBzaW5nbGUgZXZlbnQgaGFuZGxlciBwZXIgZm9ybQoJCQl0aGlzLmZvcm0ub24oICJyZXNldC51aS1mb3JtLXJlc2V0IiwgdGhpcy5fZm9ybVJlc2V0SGFuZGxlciApOwoJCX0KCQlpbnN0YW5jZXMucHVzaCggdGhpcyApOwoJCXRoaXMuZm9ybS5kYXRhKCAidWktZm9ybS1yZXNldC1pbnN0YW5jZXMiLCBpbnN0YW5jZXMgKTsKCX0sCgoJX3VuYmluZEZvcm1SZXNldEhhbmRsZXI6IGZ1bmN0aW9uKCkgewoJCWlmICggIXRoaXMuZm9ybS5sZW5ndGggKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBpbnN0YW5jZXMgPSB0aGlzLmZvcm0uZGF0YSggInVpLWZvcm0tcmVzZXQtaW5zdGFuY2VzIiApOwoJCWluc3RhbmNlcy5zcGxpY2UoICQuaW5BcnJheSggdGhpcywgaW5zdGFuY2VzICksIDEgKTsKCQlpZiAoIGluc3RhbmNlcy5sZW5ndGggKSB7CgkJCXRoaXMuZm9ybS5kYXRhKCAidWktZm9ybS1yZXNldC1pbnN0YW5jZXMiLCBpbnN0YW5jZXMgKTsKCQl9IGVsc2UgewoJCQl0aGlzLmZvcm0KCQkJCS5yZW1vdmVEYXRhKCAidWktZm9ybS1yZXNldC1pbnN0YW5jZXMiICkKCQkJCS5vZmYoICJyZXNldC51aS1mb3JtLXJlc2V0IiApOwoJCX0KCX0KfTsKCgovKiEKICogalF1ZXJ5IFVJIFN1cHBvcnQgZm9yIGpRdWVyeSBjb3JlIDEuNy54IDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKi8KCi8vPj5sYWJlbDogalF1ZXJ5IDEuNyBTdXBwb3J0Ci8vPj5ncm91cDogQ29yZQovLz4+ZGVzY3JpcHRpb246IFN1cHBvcnQgdmVyc2lvbiAxLjcueCBvZiBqUXVlcnkgY29yZQoKCgovLyBTdXBwb3J0OiBqUXVlcnkgMS43IG9ubHkKLy8gTm90IGEgZ3JlYXQgd2F5IHRvIGNoZWNrIHZlcnNpb25zLCBidXQgc2luY2Ugd2Ugb25seSBzdXBwb3J0IDEuNysgYW5kIG9ubHkKLy8gbmVlZCB0byBkZXRlY3QgPDEuOCwgdGhpcyBpcyBhIHNpbXBsZSBjaGVjayB0aGF0IHNob3VsZCBzdWZmaWNlLiBDaGVja2luZwovLyBmb3IgIjEuNy4iIHdvdWxkIGJlIGEgYml0IHNhZmVyLCBidXQgdGhlIHZlcnNpb24gc3RyaW5nIGlzIDEuNywgbm90IDEuNy4wCi8vIGFuZCB3ZSdsbCBuZXZlciByZWFjaCAxLjcwLjAgKGlmIHdlIGRvLCB3ZSBjZXJ0YWlubHkgd29uJ3QgYmUgc3VwcG9ydGluZwovLyAxLjcgYW55bW9yZSkuIFNlZSAjMTExOTcgZm9yIHdoeSB3ZSdyZSBub3QgdXNpbmcgZmVhdHVyZSBkZXRlY3Rpb24uCmlmICggJC5mbi5qcXVlcnkuc3Vic3RyaW5nKCAwLCAzICkgPT09ICIxLjciICkgewoKCS8vIFNldHRlcnMgZm9yIC5pbm5lcldpZHRoKCksIC5pbm5lckhlaWdodCgpLCAub3V0ZXJXaWR0aCgpLCAub3V0ZXJIZWlnaHQoKQoJLy8gVW5saWtlIGpRdWVyeSBDb3JlIDEuOCssIHRoZXNlIG9ubHkgc3VwcG9ydCBudW1lcmljIHZhbHVlcyB0byBzZXQgdGhlCgkvLyBkaW1lbnNpb25zIGluIHBpeGVscwoJJC5lYWNoKCBbICJXaWR0aCIsICJIZWlnaHQiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJCXZhciBzaWRlID0gbmFtZSA9PT0gIldpZHRoIiA/IFsgIkxlZnQiLCAiUmlnaHQiIF0gOiBbICJUb3AiLCAiQm90dG9tIiBdLAoJCQl0eXBlID0gbmFtZS50b0xvd2VyQ2FzZSgpLAoJCQlvcmlnID0gewoJCQkJaW5uZXJXaWR0aDogJC5mbi5pbm5lcldpZHRoLAoJCQkJaW5uZXJIZWlnaHQ6ICQuZm4uaW5uZXJIZWlnaHQsCgkJCQlvdXRlcldpZHRoOiAkLmZuLm91dGVyV2lkdGgsCgkJCQlvdXRlckhlaWdodDogJC5mbi5vdXRlckhlaWdodAoJCQl9OwoKCQlmdW5jdGlvbiByZWR1Y2UoIGVsZW0sIHNpemUsIGJvcmRlciwgbWFyZ2luICkgewoJCQkkLmVhY2goIHNpZGUsIGZ1bmN0aW9uKCkgewoJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgInBhZGRpbmciICsgdGhpcyApICkgfHwgMDsKCQkJCWlmICggYm9yZGVyICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJib3JkZXIiICsgdGhpcyArICJXaWR0aCIgKSApIHx8IDA7CgkJCQl9CgkJCQlpZiAoIG1hcmdpbiApIHsKCQkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAibWFyZ2luIiArIHRoaXMgKSApIHx8IDA7CgkJCQl9CgkJCX0gKTsKCQkJcmV0dXJuIHNpemU7CgkJfQoKCQkkLmZuWyAiaW5uZXIiICsgbmFtZSBdID0gZnVuY3Rpb24oIHNpemUgKSB7CgkJCWlmICggc2l6ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIG9yaWdbICJpbm5lciIgKyBuYW1lIF0uY2FsbCggdGhpcyApOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSApICsgInB4IiApOwoJCQl9ICk7CgkJfTsKCgkJJC5mblsgIm91dGVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uKCBzaXplLCBtYXJnaW4gKSB7CgkJCWlmICggdHlwZW9mIHNpemUgIT09ICJudW1iZXIiICkgewoJCQkJcmV0dXJuIG9yaWdbICJvdXRlciIgKyBuYW1lIF0uY2FsbCggdGhpcywgc2l6ZSApOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSwgdHJ1ZSwgbWFyZ2luICkgKyAicHgiICk7CgkJCX0gKTsKCQl9OwoJfSApOwoKCSQuZm4uYWRkQmFjayA9IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5hZGQoIHNlbGVjdG9yID09IG51bGwgPwoJCQl0aGlzLnByZXZPYmplY3QgOiB0aGlzLnByZXZPYmplY3QuZmlsdGVyKCBzZWxlY3RvciApCgkJKTsKCX07Cn0KCjsKLyohCiAqIGpRdWVyeSBVSSBLZXljb2RlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogS2V5Y29kZQovLz4+Z3JvdXA6IENvcmUKLy8+PmRlc2NyaXB0aW9uOiBQcm92aWRlIGtleWNvZGVzIGFzIGtleW5hbWVzCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9qUXVlcnkudWkua2V5Q29kZS8KCgp2YXIga2V5Y29kZSA9ICQudWkua2V5Q29kZSA9IHsKCUJBQ0tTUEFDRTogOCwKCUNPTU1BOiAxODgsCglERUxFVEU6IDQ2LAoJRE9XTjogNDAsCglFTkQ6IDM1LAoJRU5URVI6IDEzLAoJRVNDQVBFOiAyNywKCUhPTUU6IDM2LAoJTEVGVDogMzcsCglQQUdFX0RPV046IDM0LAoJUEFHRV9VUDogMzMsCglQRVJJT0Q6IDE5MCwKCVJJR0hUOiAzOSwKCVNQQUNFOiAzMiwKCVRBQjogOSwKCVVQOiAzOAp9OwoKCgoKLy8gSW50ZXJuYWwgdXNlIG9ubHkKdmFyIGVzY2FwZVNlbGVjdG9yID0gJC51aS5lc2NhcGVTZWxlY3RvciA9ICggZnVuY3Rpb24oKSB7Cgl2YXIgc2VsZWN0b3JFc2NhcGUgPSAvKFshIiMkJSYnKCkqKywuLzo7PD0+P0BbXF1eYHt8fX5dKS9nOwoJcmV0dXJuIGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gc2VsZWN0b3IucmVwbGFjZSggc2VsZWN0b3JFc2NhcGUsICJcXCQxIiApOwoJfTsKfSApKCk7CgoKLyohCiAqIGpRdWVyeSBVSSBMYWJlbHMgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBsYWJlbHMKLy8+Pmdyb3VwOiBDb3JlCi8vPj5kZXNjcmlwdGlvbjogRmluZCBhbGwgdGhlIGxhYmVscyBhc3NvY2lhdGVkIHdpdGggYSBnaXZlbiBpbnB1dAovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vbGFiZWxzLwoKCgp2YXIgbGFiZWxzID0gJC5mbi5sYWJlbHMgPSBmdW5jdGlvbigpIHsKCXZhciBhbmNlc3Rvciwgc2VsZWN0b3IsIGlkLCBsYWJlbHMsIGFuY2VzdG9yczsKCgkvLyBDaGVjayBjb250cm9sLmxhYmVscyBmaXJzdAoJaWYgKCB0aGlzWyAwIF0ubGFiZWxzICYmIHRoaXNbIDAgXS5sYWJlbHMubGVuZ3RoICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggdGhpc1sgMCBdLmxhYmVscyApOwoJfQoKCS8vIFN1cHBvcnQ6IElFIDw9IDExLCBGRiA8PSAzNywgQW5kcm9pZCA8PSAyLjMgb25seQoJLy8gQWJvdmUgYnJvd3NlcnMgZG8gbm90IHN1cHBvcnQgY29udHJvbC5sYWJlbHMuIEV2ZXJ5dGhpbmcgYmVsb3cgaXMgdG8gc3VwcG9ydCB0aGVtCgkvLyBhcyB3ZWxsIGFzIGRvY3VtZW50IGZyYWdtZW50cy4gY29udHJvbC5sYWJlbHMgZG9lcyBub3Qgd29yayBvbiBkb2N1bWVudCBmcmFnbWVudHMKCWxhYmVscyA9IHRoaXMuZXEoIDAgKS5wYXJlbnRzKCAibGFiZWwiICk7CgoJLy8gTG9vayBmb3IgdGhlIGxhYmVsIGJhc2VkIG9uIHRoZSBpZAoJaWQgPSB0aGlzLmF0dHIoICJpZCIgKTsKCWlmICggaWQgKSB7CgoJCS8vIFdlIGRvbid0IHNlYXJjaCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBpbiBjYXNlIHRoZSBlbGVtZW50CgkJLy8gaXMgZGlzY29ubmVjdGVkIGZyb20gdGhlIERPTQoJCWFuY2VzdG9yID0gdGhpcy5lcSggMCApLnBhcmVudHMoKS5sYXN0KCk7CgoJCS8vIEdldCBhIGZ1bGwgc2V0IG9mIHRvcCBsZXZlbCBhbmNlc3RvcnMKCQlhbmNlc3RvcnMgPSBhbmNlc3Rvci5hZGQoIGFuY2VzdG9yLmxlbmd0aCA/IGFuY2VzdG9yLnNpYmxpbmdzKCkgOiB0aGlzLnNpYmxpbmdzKCkgKTsKCgkJLy8gQ3JlYXRlIGEgc2VsZWN0b3IgZm9yIHRoZSBsYWJlbCBiYXNlZCBvbiB0aGUgaWQKCQlzZWxlY3RvciA9ICJsYWJlbFtmb3I9JyIgKyAkLnVpLmVzY2FwZVNlbGVjdG9yKCBpZCApICsgIiddIjsKCgkJbGFiZWxzID0gbGFiZWxzLmFkZCggYW5jZXN0b3JzLmZpbmQoIHNlbGVjdG9yICkuYWRkQmFjayggc2VsZWN0b3IgKSApOwoKCX0KCgkvLyBSZXR1cm4gd2hhdGV2ZXIgd2UgaGF2ZSBmb3VuZCBmb3IgbGFiZWxzCglyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGxhYmVscyApOwp9OwoKCi8qIQogKiBqUXVlcnkgVUkgU2Nyb2xsIFBhcmVudCAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IHNjcm9sbFBhcmVudAovLz4+Z3JvdXA6IENvcmUKLy8+PmRlc2NyaXB0aW9uOiBHZXQgdGhlIGNsb3Nlc3QgYW5jZXN0b3IgZWxlbWVudCB0aGF0IGlzIHNjcm9sbGFibGUuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9zY3JvbGxQYXJlbnQvCgoKCnZhciBzY3JvbGxQYXJlbnQgPSAkLmZuLnNjcm9sbFBhcmVudCA9IGZ1bmN0aW9uKCBpbmNsdWRlSGlkZGVuICkgewoJdmFyIHBvc2l0aW9uID0gdGhpcy5jc3MoICJwb3NpdGlvbiIgKSwKCQlleGNsdWRlU3RhdGljUGFyZW50ID0gcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIsCgkJb3ZlcmZsb3dSZWdleCA9IGluY2x1ZGVIaWRkZW4gPyAvKGF1dG98c2Nyb2xsfGhpZGRlbikvIDogLyhhdXRvfHNjcm9sbCkvLAoJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCXZhciBwYXJlbnQgPSAkKCB0aGlzICk7CgkJCWlmICggZXhjbHVkZVN0YXRpY1BhcmVudCAmJiBwYXJlbnQuY3NzKCAicG9zaXRpb24iICkgPT09ICJzdGF0aWMiICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCXJldHVybiBvdmVyZmxvd1JlZ2V4LnRlc3QoIHBhcmVudC5jc3MoICJvdmVyZmxvdyIgKSArIHBhcmVudC5jc3MoICJvdmVyZmxvdy15IiApICsKCQkJCXBhcmVudC5jc3MoICJvdmVyZmxvdy14IiApICk7CgkJfSApLmVxKCAwICk7CgoJcmV0dXJuIHBvc2l0aW9uID09PSAiZml4ZWQiIHx8ICFzY3JvbGxQYXJlbnQubGVuZ3RoID8KCQkkKCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApIDoKCQlzY3JvbGxQYXJlbnQ7Cn07CgoKLyohCiAqIGpRdWVyeSBVSSBUYWJiYWJsZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IDp0YWJiYWJsZSBTZWxlY3RvcgovLz4+Z3JvdXA6IENvcmUKLy8+PmRlc2NyaXB0aW9uOiBTZWxlY3RzIGVsZW1lbnRzIHdoaWNoIGNhbiBiZSB0YWJiZWQgdG8uCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS90YWJiYWJsZS1zZWxlY3Rvci8KCgoKdmFyIHRhYmJhYmxlID0gJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCXRhYmJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgdGFiSW5kZXggPSAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSwKCQkJaGFzVGFiaW5kZXggPSB0YWJJbmRleCAhPSBudWxsOwoJCXJldHVybiAoICFoYXNUYWJpbmRleCB8fCB0YWJJbmRleCA+PSAwICkgJiYgJC51aS5mb2N1c2FibGUoIGVsZW1lbnQsIGhhc1RhYmluZGV4ICk7Cgl9Cn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIFVuaXF1ZSBJRCAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IHVuaXF1ZUlkCi8vPj5ncm91cDogQ29yZQovLz4+ZGVzY3JpcHRpb246IEZ1bmN0aW9ucyB0byBnZW5lcmF0ZSBhbmQgcmVtb3ZlIHVuaXF1ZUlkJ3MKLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3VuaXF1ZUlkLwoKCgp2YXIgdW5pcXVlSWQgPSAkLmZuLmV4dGVuZCggewoJdW5pcXVlSWQ6ICggZnVuY3Rpb24oKSB7CgkJdmFyIHV1aWQgPSAwOwoKCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAhdGhpcy5pZCApIHsKCQkJCQl0aGlzLmlkID0gInVpLWlkLSIgKyAoICsrdXVpZCApOwoJCQkJfQoJCQl9ICk7CgkJfTsKCX0gKSgpLAoKCXJlbW92ZVVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJaWYgKCAvXnVpLWlkLVxkKyQvLnRlc3QoIHRoaXMuaWQgKSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmVBdHRyKCAiaWQiICk7CgkJCX0KCQl9ICk7Cgl9Cn0gKTsKCgoKCi8vIFRoaXMgZmlsZSBpcyBkZXByZWNhdGVkCnZhciBpZSA9ICQudWkuaWUgPSAhIS9tc2llIFtcdy5dKy8uZXhlYyggbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpICk7CgovKiEKICogalF1ZXJ5IFVJIE1vdXNlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogTW91c2UKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vPj5kZXNjcmlwdGlvbjogQWJzdHJhY3RzIG1vdXNlLWJhc2VkIGludGVyYWN0aW9ucyB0byBhc3Npc3QgaW4gY3JlYXRpbmcgY2VydGFpbiB3aWRnZXRzLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vbW91c2UvCgoKCnZhciBtb3VzZUhhbmRsZWQgPSBmYWxzZTsKJCggZG9jdW1lbnQgKS5vbiggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCW1vdXNlSGFuZGxlZCA9IGZhbHNlOwp9ICk7Cgp2YXIgd2lkZ2V0c01vdXNlID0gJC53aWRnZXQoICJ1aS5tb3VzZSIsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJb3B0aW9uczogewoJCWNhbmNlbDogImlucHV0LCB0ZXh0YXJlYSwgYnV0dG9uLCBzZWxlY3QsIG9wdGlvbiIsCgkJZGlzdGFuY2U6IDEsCgkJZGVsYXk6IDAKCX0sCglfbW91c2VJbml0OiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCXRoaXMuZWxlbWVudAoJCQkub24oICJtb3VzZWRvd24uIiArIHRoaXMud2lkZ2V0TmFtZSwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJcmV0dXJuIHRoYXQuX21vdXNlRG93biggZXZlbnQgKTsKCQkJfSApCgkJCS5vbiggImNsaWNrLiIgKyB0aGlzLndpZGdldE5hbWUsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdHJ1ZSA9PT0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRoYXQud2lkZ2V0TmFtZSArICIucHJldmVudENsaWNrRXZlbnQiICkgKSB7CgkJCQkJJC5yZW1vdmVEYXRhKCBldmVudC50YXJnZXQsIHRoYXQud2lkZ2V0TmFtZSArICIucHJldmVudENsaWNrRXZlbnQiICk7CgkJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9ICk7CgoJCXRoaXMuc3RhcnRlZCA9IGZhbHNlOwoJfSwKCgkvLyBUT0RPOiBtYWtlIHN1cmUgZGVzdHJveWluZyBvbmUgaW5zdGFuY2Ugb2YgbW91c2UgZG9lc24ndCBtZXNzIHdpdGgKCS8vIG90aGVyIGluc3RhbmNlcyBvZiBtb3VzZQoJX21vdXNlRGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50Lm9mZiggIi4iICsgdGhpcy53aWRnZXROYW1lICk7CgkJaWYgKCB0aGlzLl9tb3VzZU1vdmVEZWxlZ2F0ZSApIHsKCQkJdGhpcy5kb2N1bWVudAoJCQkJLm9mZiggIm1vdXNlbW92ZS4iICsgdGhpcy53aWRnZXROYW1lLCB0aGlzLl9tb3VzZU1vdmVEZWxlZ2F0ZSApCgkJCQkub2ZmKCAibW91c2V1cC4iICsgdGhpcy53aWRnZXROYW1lLCB0aGlzLl9tb3VzZVVwRGVsZWdhdGUgKTsKCQl9Cgl9LAoKCV9tb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJLy8gZG9uJ3QgbGV0IG1vcmUgdGhhbiBvbmUgd2lkZ2V0IGhhbmRsZSBtb3VzZVN0YXJ0CgkJaWYgKCBtb3VzZUhhbmRsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX21vdXNlTW92ZWQgPSBmYWxzZTsKCgkJLy8gV2UgbWF5IGhhdmUgbWlzc2VkIG1vdXNldXAgKG91dCBvZiB3aW5kb3cpCgkJKCB0aGlzLl9tb3VzZVN0YXJ0ZWQgJiYgdGhpcy5fbW91c2VVcCggZXZlbnQgKSApOwoKCQl0aGlzLl9tb3VzZURvd25FdmVudCA9IGV2ZW50OwoKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCWJ0bklzTGVmdCA9ICggZXZlbnQud2hpY2ggPT09IDEgKSwKCgkJCS8vIGV2ZW50LnRhcmdldC5ub2RlTmFtZSB3b3JrcyBhcm91bmQgYSBidWcgaW4gSUUgOCB3aXRoCgkJCS8vIGRpc2FibGVkIGlucHV0cyAoIzc2MjApCgkJCWVsSXNDYW5jZWwgPSAoIHR5cGVvZiB0aGlzLm9wdGlvbnMuY2FuY2VsID09PSAic3RyaW5nIiAmJiBldmVudC50YXJnZXQubm9kZU5hbWUgPwoJCQkJJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggdGhpcy5vcHRpb25zLmNhbmNlbCApLmxlbmd0aCA6IGZhbHNlICk7CgkJaWYgKCAhYnRuSXNMZWZ0IHx8IGVsSXNDYW5jZWwgfHwgIXRoaXMuX21vdXNlQ2FwdHVyZSggZXZlbnQgKSApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQl0aGlzLm1vdXNlRGVsYXlNZXQgPSAhdGhpcy5vcHRpb25zLmRlbGF5OwoJCWlmICggIXRoaXMubW91c2VEZWxheU1ldCApIHsKCQkJdGhpcy5fbW91c2VEZWxheVRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQl0aGF0Lm1vdXNlRGVsYXlNZXQgPSB0cnVlOwoJCQl9LCB0aGlzLm9wdGlvbnMuZGVsYXkgKTsKCQl9CgoJCWlmICggdGhpcy5fbW91c2VEaXN0YW5jZU1ldCggZXZlbnQgKSAmJiB0aGlzLl9tb3VzZURlbGF5TWV0KCBldmVudCApICkgewoJCQl0aGlzLl9tb3VzZVN0YXJ0ZWQgPSAoIHRoaXMuX21vdXNlU3RhcnQoIGV2ZW50ICkgIT09IGZhbHNlICk7CgkJCWlmICggIXRoaXMuX21vdXNlU3RhcnRlZCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCgkJLy8gQ2xpY2sgZXZlbnQgbWF5IG5ldmVyIGhhdmUgZmlyZWQgKEdlY2tvICYgT3BlcmEpCgkJaWYgKCB0cnVlID09PSAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdGhpcy53aWRnZXROYW1lICsgIi5wcmV2ZW50Q2xpY2tFdmVudCIgKSApIHsKCQkJJC5yZW1vdmVEYXRhKCBldmVudC50YXJnZXQsIHRoaXMud2lkZ2V0TmFtZSArICIucHJldmVudENsaWNrRXZlbnQiICk7CgkJfQoKCQkvLyBUaGVzZSBkZWxlZ2F0ZXMgYXJlIHJlcXVpcmVkIHRvIGtlZXAgY29udGV4dAoJCXRoaXMuX21vdXNlTW92ZURlbGVnYXRlID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlyZXR1cm4gdGhhdC5fbW91c2VNb3ZlKCBldmVudCApOwoJCX07CgkJdGhpcy5fbW91c2VVcERlbGVnYXRlID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlyZXR1cm4gdGhhdC5fbW91c2VVcCggZXZlbnQgKTsKCQl9OwoKCQl0aGlzLmRvY3VtZW50CgkJCS5vbiggIm1vdXNlbW92ZS4iICsgdGhpcy53aWRnZXROYW1lLCB0aGlzLl9tb3VzZU1vdmVEZWxlZ2F0ZSApCgkJCS5vbiggIm1vdXNldXAuIiArIHRoaXMud2lkZ2V0TmFtZSwgdGhpcy5fbW91c2VVcERlbGVnYXRlICk7CgoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCW1vdXNlSGFuZGxlZCA9IHRydWU7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9tb3VzZU1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJLy8gT25seSBjaGVjayBmb3IgbW91c2V1cHMgb3V0c2lkZSB0aGUgZG9jdW1lbnQgaWYgeW91J3ZlIG1vdmVkIGluc2lkZSB0aGUgZG9jdW1lbnQKCQkvLyBhdCBsZWFzdCBvbmNlLiBUaGlzIHByZXZlbnRzIHRoZSBmaXJpbmcgb2YgbW91c2V1cCBpbiB0aGUgY2FzZSBvZiBJRTw5LCB3aGljaCB3aWxsCgkJLy8gZmlyZSBhIG1vdXNlbW92ZSBldmVudCBpZiBjb250ZW50IGlzIHBsYWNlZCB1bmRlciB0aGUgY3Vyc29yLiBTZWUgIzc3NzgKCQkvLyBTdXBwb3J0OiBJRSA8OQoJCWlmICggdGhpcy5fbW91c2VNb3ZlZCApIHsKCgkJCS8vIElFIG1vdXNldXAgY2hlY2sgLSBtb3VzZXVwIGhhcHBlbmVkIHdoZW4gbW91c2Ugd2FzIG91dCBvZiB3aW5kb3cKCQkJaWYgKCAkLnVpLmllICYmICggIWRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCBkb2N1bWVudC5kb2N1bWVudE1vZGUgPCA5ICkgJiYKCQkJCQkhZXZlbnQuYnV0dG9uICkgewoJCQkJcmV0dXJuIHRoaXMuX21vdXNlVXAoIGV2ZW50ICk7CgoJCQkvLyBJZnJhbWUgbW91c2V1cCBjaGVjayAtIG1vdXNldXAgb2NjdXJyZWQgaW4gYW5vdGhlciBkb2N1bWVudAoJCQl9IGVsc2UgaWYgKCAhZXZlbnQud2hpY2ggKSB7CgoJCQkJLy8gU3VwcG9ydDogU2FmYXJpIDw9OCAtIDkKCQkJCS8vIFNhZmFyaSBzZXRzIHdoaWNoIHRvIDAgaWYgeW91IHByZXNzIGFueSBvZiB0aGUgZm9sbG93aW5nIGtleXMKCQkJCS8vIGR1cmluZyBhIGRyYWcgKCMxNDQ2MSkKCQkJCWlmICggZXZlbnQub3JpZ2luYWxFdmVudC5hbHRLZXkgfHwgZXZlbnQub3JpZ2luYWxFdmVudC5jdHJsS2V5IHx8CgkJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQubWV0YUtleSB8fCBldmVudC5vcmlnaW5hbEV2ZW50LnNoaWZ0S2V5ICkgewoJCQkJCXRoaXMuaWdub3JlTWlzc2luZ1doaWNoID0gdHJ1ZTsKCQkJCX0gZWxzZSBpZiAoICF0aGlzLmlnbm9yZU1pc3NpbmdXaGljaCApIHsKCQkJCQlyZXR1cm4gdGhpcy5fbW91c2VVcCggZXZlbnQgKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBldmVudC53aGljaCB8fCBldmVudC5idXR0b24gKSB7CgkJCXRoaXMuX21vdXNlTW92ZWQgPSB0cnVlOwoJCX0KCgkJaWYgKCB0aGlzLl9tb3VzZVN0YXJ0ZWQgKSB7CgkJCXRoaXMuX21vdXNlRHJhZyggZXZlbnQgKTsKCQkJcmV0dXJuIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfQoKCQlpZiAoIHRoaXMuX21vdXNlRGlzdGFuY2VNZXQoIGV2ZW50ICkgJiYgdGhpcy5fbW91c2VEZWxheU1ldCggZXZlbnQgKSApIHsKCQkJdGhpcy5fbW91c2VTdGFydGVkID0KCQkJCSggdGhpcy5fbW91c2VTdGFydCggdGhpcy5fbW91c2VEb3duRXZlbnQsIGV2ZW50ICkgIT09IGZhbHNlICk7CgkJCSggdGhpcy5fbW91c2VTdGFydGVkID8gdGhpcy5fbW91c2VEcmFnKCBldmVudCApIDogdGhpcy5fbW91c2VVcCggZXZlbnQgKSApOwoJCX0KCgkJcmV0dXJuICF0aGlzLl9tb3VzZVN0YXJ0ZWQ7Cgl9LAoKCV9tb3VzZVVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5kb2N1bWVudAoJCQkub2ZmKCAibW91c2Vtb3ZlLiIgKyB0aGlzLndpZGdldE5hbWUsIHRoaXMuX21vdXNlTW92ZURlbGVnYXRlICkKCQkJLm9mZiggIm1vdXNldXAuIiArIHRoaXMud2lkZ2V0TmFtZSwgdGhpcy5fbW91c2VVcERlbGVnYXRlICk7CgoJCWlmICggdGhpcy5fbW91c2VTdGFydGVkICkgewoJCQl0aGlzLl9tb3VzZVN0YXJ0ZWQgPSBmYWxzZTsKCgkJCWlmICggZXZlbnQudGFyZ2V0ID09PSB0aGlzLl9tb3VzZURvd25FdmVudC50YXJnZXQgKSB7CgkJCQkkLmRhdGEoIGV2ZW50LnRhcmdldCwgdGhpcy53aWRnZXROYW1lICsgIi5wcmV2ZW50Q2xpY2tFdmVudCIsIHRydWUgKTsKCQkJfQoKCQkJdGhpcy5fbW91c2VTdG9wKCBldmVudCApOwoJCX0KCgkJaWYgKCB0aGlzLl9tb3VzZURlbGF5VGltZXIgKSB7CgkJCWNsZWFyVGltZW91dCggdGhpcy5fbW91c2VEZWxheVRpbWVyICk7CgkJCWRlbGV0ZSB0aGlzLl9tb3VzZURlbGF5VGltZXI7CgkJfQoKCQl0aGlzLmlnbm9yZU1pc3NpbmdXaGljaCA9IGZhbHNlOwoJCW1vdXNlSGFuZGxlZCA9IGZhbHNlOwoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cgl9LAoKCV9tb3VzZURpc3RhbmNlTWV0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJcmV0dXJuICggTWF0aC5tYXgoCgkJCQlNYXRoLmFicyggdGhpcy5fbW91c2VEb3duRXZlbnQucGFnZVggLSBldmVudC5wYWdlWCApLAoJCQkJTWF0aC5hYnMoIHRoaXMuX21vdXNlRG93bkV2ZW50LnBhZ2VZIC0gZXZlbnQucGFnZVkgKQoJCQkpID49IHRoaXMub3B0aW9ucy5kaXN0YW5jZQoJCSk7Cgl9LAoKCV9tb3VzZURlbGF5TWV0OiBmdW5jdGlvbiggLyogZXZlbnQgKi8gKSB7CgkJcmV0dXJuIHRoaXMubW91c2VEZWxheU1ldDsKCX0sCgoJLy8gVGhlc2UgYXJlIHBsYWNlaG9sZGVyIG1ldGhvZHMsIHRvIGJlIG92ZXJyaWRlbiBieSBleHRlbmRpbmcgcGx1Z2luCglfbW91c2VTdGFydDogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkge30sCglfbW91c2VEcmFnOiBmdW5jdGlvbiggLyogZXZlbnQgKi8gKSB7fSwKCV9tb3VzZVN0b3A6IGZ1bmN0aW9uKCAvKiBldmVudCAqLyApIHt9LAoJX21vdXNlQ2FwdHVyZTogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgeyByZXR1cm4gdHJ1ZTsgfQp9ICk7CgoKCgovLyAkLnVpLnBsdWdpbiBpcyBkZXByZWNhdGVkLiBVc2UgJC53aWRnZXQoKSBleHRlbnNpb25zIGluc3RlYWQuCnZhciBwbHVnaW4gPSAkLnVpLnBsdWdpbiA9IHsKCWFkZDogZnVuY3Rpb24oIG1vZHVsZSwgb3B0aW9uLCBzZXQgKSB7CgkJdmFyIGksCgkJCXByb3RvID0gJC51aVsgbW9kdWxlIF0ucHJvdG90eXBlOwoJCWZvciAoIGkgaW4gc2V0ICkgewoJCQlwcm90by5wbHVnaW5zWyBpIF0gPSBwcm90by5wbHVnaW5zWyBpIF0gfHwgW107CgkJCXByb3RvLnBsdWdpbnNbIGkgXS5wdXNoKCBbIG9wdGlvbiwgc2V0WyBpIF0gXSApOwoJCX0KCX0sCgljYWxsOiBmdW5jdGlvbiggaW5zdGFuY2UsIG5hbWUsIGFyZ3MsIGFsbG93RGlzY29ubmVjdGVkICkgewoJCXZhciBpLAoJCQlzZXQgPSBpbnN0YW5jZS5wbHVnaW5zWyBuYW1lIF07CgoJCWlmICggIXNldCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCAhYWxsb3dEaXNjb25uZWN0ZWQgJiYgKCAhaW5zdGFuY2UuZWxlbWVudFsgMCBdLnBhcmVudE5vZGUgfHwKCQkJCWluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7CgkJCQlzZXRbIGkgXVsgMSBdLmFwcGx5KCBpbnN0YW5jZS5lbGVtZW50LCBhcmdzICk7CgkJCX0KCQl9Cgl9Cn07CgoKCnZhciBzYWZlQWN0aXZlRWxlbWVudCA9ICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQgPSBmdW5jdGlvbiggZG9jdW1lbnQgKSB7Cgl2YXIgYWN0aXZlRWxlbWVudDsKCgkvLyBTdXBwb3J0OiBJRSA5IG9ubHkKCS8vIElFOSB0aHJvd3MgYW4gIlVuc3BlY2lmaWVkIGVycm9yIiBhY2Nlc3NpbmcgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBmcm9tIGFuIDxpZnJhbWU+Cgl0cnkgewoJCWFjdGl2ZUVsZW1lbnQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwoJfSBjYXRjaCAoIGVycm9yICkgewoJCWFjdGl2ZUVsZW1lbnQgPSBkb2N1bWVudC5ib2R5OwoJfQoKCS8vIFN1cHBvcnQ6IElFIDkgLSAxMSBvbmx5CgkvLyBJRSBtYXkgcmV0dXJuIG51bGwgaW5zdGVhZCBvZiBhbiBlbGVtZW50CgkvLyBJbnRlcmVzdGluZ2x5LCB0aGlzIG9ubHkgc2VlbXMgdG8gb2NjdXIgd2hlbiBOT1QgaW4gYW4gaWZyYW1lCglpZiAoICFhY3RpdmVFbGVtZW50ICkgewoJCWFjdGl2ZUVsZW1lbnQgPSBkb2N1bWVudC5ib2R5OwoJfQoKCS8vIFN1cHBvcnQ6IElFIDExIG9ubHkKCS8vIElFMTEgcmV0dXJucyBhIHNlZW1pbmdseSBlbXB0eSBvYmplY3QgaW4gc29tZSBjYXNlcyB3aGVuIGFjY2Vzc2luZwoJLy8gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBmcm9tIGFuIDxpZnJhbWU+CglpZiAoICFhY3RpdmVFbGVtZW50Lm5vZGVOYW1lICkgewoJCWFjdGl2ZUVsZW1lbnQgPSBkb2N1bWVudC5ib2R5OwoJfQoKCXJldHVybiBhY3RpdmVFbGVtZW50Owp9OwoKCgp2YXIgc2FmZUJsdXIgPSAkLnVpLnNhZmVCbHVyID0gZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgoJLy8gU3VwcG9ydDogSUU5IC0gMTAgb25seQoJLy8gSWYgdGhlIDxib2R5PiBpcyBibHVycmVkLCBJRSB3aWxsIHN3aXRjaCB3aW5kb3dzLCBzZWUgIzk0MjAKCWlmICggZWxlbWVudCAmJiBlbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJib2R5IiApIHsKCQkkKCBlbGVtZW50ICkudHJpZ2dlciggImJsdXIiICk7Cgl9Cn07CgoKLyohCiAqIGpRdWVyeSBVSSBEcmFnZ2FibGUgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBEcmFnZ2FibGUKLy8+Pmdyb3VwOiBJbnRlcmFjdGlvbnMKLy8+PmRlc2NyaXB0aW9uOiBFbmFibGVzIGRyYWdnaW5nIGZ1bmN0aW9uYWxpdHkgZm9yIGFueSBlbGVtZW50LgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZHJhZ2dhYmxlLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZHJhZ2dhYmxlLwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvZHJhZ2dhYmxlLmNzcwoKCgokLndpZGdldCggInVpLmRyYWdnYWJsZSIsICQudWkubW91c2UsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJkcmFnIiwKCW9wdGlvbnM6IHsKCQlhZGRDbGFzc2VzOiB0cnVlLAoJCWFwcGVuZFRvOiAicGFyZW50IiwKCQlheGlzOiBmYWxzZSwKCQljb25uZWN0VG9Tb3J0YWJsZTogZmFsc2UsCgkJY29udGFpbm1lbnQ6IGZhbHNlLAoJCWN1cnNvcjogImF1dG8iLAoJCWN1cnNvckF0OiBmYWxzZSwKCQlncmlkOiBmYWxzZSwKCQloYW5kbGU6IGZhbHNlLAoJCWhlbHBlcjogIm9yaWdpbmFsIiwKCQlpZnJhbWVGaXg6IGZhbHNlLAoJCW9wYWNpdHk6IGZhbHNlLAoJCXJlZnJlc2hQb3NpdGlvbnM6IGZhbHNlLAoJCXJldmVydDogZmFsc2UsCgkJcmV2ZXJ0RHVyYXRpb246IDUwMCwKCQlzY29wZTogImRlZmF1bHQiLAoJCXNjcm9sbDogdHJ1ZSwKCQlzY3JvbGxTZW5zaXRpdml0eTogMjAsCgkJc2Nyb2xsU3BlZWQ6IDIwLAoJCXNuYXA6IGZhbHNlLAoJCXNuYXBNb2RlOiAiYm90aCIsCgkJc25hcFRvbGVyYW5jZTogMjAsCgkJc3RhY2s6IGZhbHNlLAoJCXpJbmRleDogZmFsc2UsCgoJCS8vIENhbGxiYWNrcwoJCWRyYWc6IG51bGwsCgkJc3RhcnQ6IG51bGwsCgkJc3RvcDogbnVsbAoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQlpZiAoIHRoaXMub3B0aW9ucy5oZWxwZXIgPT09ICJvcmlnaW5hbCIgKSB7CgkJCXRoaXMuX3NldFBvc2l0aW9uUmVsYXRpdmUoKTsKCQl9CgkJaWYgKCB0aGlzLm9wdGlvbnMuYWRkQ2xhc3NlcyApIHsKCQkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1kcmFnZ2FibGUiICk7CgkJfQoJCXRoaXMuX3NldEhhbmRsZUNsYXNzTmFtZSgpOwoKCQl0aGlzLl9tb3VzZUluaXQoKTsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCQlpZiAoIGtleSA9PT0gImhhbmRsZSIgKSB7CgkJCXRoaXMuX3JlbW92ZUhhbmRsZUNsYXNzTmFtZSgpOwoJCQl0aGlzLl9zZXRIYW5kbGVDbGFzc05hbWUoKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoICggdGhpcy5oZWxwZXIgfHwgdGhpcy5lbGVtZW50ICkuaXMoICIudWktZHJhZ2dhYmxlLWRyYWdnaW5nIiApICkgewoJCQl0aGlzLmRlc3Ryb3lPbkNsZWFyID0gdHJ1ZTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9yZW1vdmVIYW5kbGVDbGFzc05hbWUoKTsKCQl0aGlzLl9tb3VzZURlc3Ryb3koKTsKCX0sCgoJX21vdXNlQ2FwdHVyZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBBbW9uZyBvdGhlcnMsIHByZXZlbnQgYSBkcmFnIG9uIGEgcmVzaXphYmxlLWhhbmRsZQoJCWlmICggdGhpcy5oZWxwZXIgfHwgby5kaXNhYmxlZCB8fAoJCQkJJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1yZXNpemFibGUtaGFuZGxlIiApLmxlbmd0aCA+IDAgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vUXVpdCBpZiB3ZSdyZSBub3Qgb24gYSB2YWxpZCBoYW5kbGUKCQl0aGlzLmhhbmRsZSA9IHRoaXMuX2dldEhhbmRsZSggZXZlbnQgKTsKCQlpZiAoICF0aGlzLmhhbmRsZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdGhpcy5fYmx1ckFjdGl2ZUVsZW1lbnQoIGV2ZW50ICk7CgoJCXRoaXMuX2Jsb2NrRnJhbWVzKCBvLmlmcmFtZUZpeCA9PT0gdHJ1ZSA/ICJpZnJhbWUiIDogby5pZnJhbWVGaXggKTsKCgkJcmV0dXJuIHRydWU7CgoJfSwKCglfYmxvY2tGcmFtZXM6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl0aGlzLmlmcmFtZUJsb2NrcyA9IHRoaXMuZG9jdW1lbnQuZmluZCggc2VsZWN0b3IgKS5tYXAoIGZ1bmN0aW9uKCkgewoJCQl2YXIgaWZyYW1lID0gJCggdGhpcyApOwoKCQkJcmV0dXJuICQoICI8ZGl2PiIgKQoJCQkJLmNzcyggInBvc2l0aW9uIiwgImFic29sdXRlIiApCgkJCQkuYXBwZW5kVG8oIGlmcmFtZS5wYXJlbnQoKSApCgkJCQkub3V0ZXJXaWR0aCggaWZyYW1lLm91dGVyV2lkdGgoKSApCgkJCQkub3V0ZXJIZWlnaHQoIGlmcmFtZS5vdXRlckhlaWdodCgpICkKCQkJCS5vZmZzZXQoIGlmcmFtZS5vZmZzZXQoKSApWyAwIF07CgkJfSApOwoJfSwKCglfdW5ibG9ja0ZyYW1lczogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmlmcmFtZUJsb2NrcyApIHsKCQkJdGhpcy5pZnJhbWVCbG9ja3MucmVtb3ZlKCk7CgkJCWRlbGV0ZSB0aGlzLmlmcmFtZUJsb2NrczsKCQl9Cgl9LAoKCV9ibHVyQWN0aXZlRWxlbWVudDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBhY3RpdmVFbGVtZW50ID0gJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICksCgkJCXRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApOwoKCQkvLyBEb24ndCBibHVyIGlmIHRoZSBldmVudCBvY2N1cnJlZCBvbiBhbiBlbGVtZW50IHRoYXQgaXMgd2l0aGluCgkJLy8gdGhlIGN1cnJlbnRseSBmb2N1c2VkIGVsZW1lbnQKCQkvLyBTZWUgIzEwNTI3LCAjMTI0NzIKCQlpZiAoIHRhcmdldC5jbG9zZXN0KCBhY3RpdmVFbGVtZW50ICkubGVuZ3RoICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBCbHVyIGFueSBlbGVtZW50IHRoYXQgY3VycmVudGx5IGhhcyBmb2N1cywgc2VlICM0MjYxCgkJJC51aS5zYWZlQmx1ciggYWN0aXZlRWxlbWVudCApOwoJfSwKCglfbW91c2VTdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCgkJLy9DcmVhdGUgYW5kIGFwcGVuZCB0aGUgdmlzaWJsZSBoZWxwZXIKCQl0aGlzLmhlbHBlciA9IHRoaXMuX2NyZWF0ZUhlbHBlciggZXZlbnQgKTsKCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaGVscGVyLCAidWktZHJhZ2dhYmxlLWRyYWdnaW5nIiApOwoKCQkvL0NhY2hlIHRoZSBoZWxwZXIgc2l6ZQoJCXRoaXMuX2NhY2hlSGVscGVyUHJvcG9ydGlvbnMoKTsKCgkJLy9JZiBkZG1hbmFnZXIgaXMgdXNlZCBmb3IgZHJvcHBhYmxlcywgc2V0IHRoZSBnbG9iYWwgZHJhZ2dhYmxlCgkJaWYgKCAkLnVpLmRkbWFuYWdlciApIHsKCQkJJC51aS5kZG1hbmFnZXIuY3VycmVudCA9IHRoaXM7CgkJfQoKCQkvKgoJCSAqIC0gUG9zaXRpb24gZ2VuZXJhdGlvbiAtCgkJICogVGhpcyBibG9jayBnZW5lcmF0ZXMgZXZlcnl0aGluZyBwb3NpdGlvbiByZWxhdGVkIC0gaXQncyB0aGUgY29yZSBvZiBkcmFnZ2FibGVzLgoJCSAqLwoKCQkvL0NhY2hlIHRoZSBtYXJnaW5zIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50CgkJdGhpcy5fY2FjaGVNYXJnaW5zKCk7CgoJCS8vU3RvcmUgdGhlIGhlbHBlcidzIGNzcyBwb3NpdGlvbgoJCXRoaXMuY3NzUG9zaXRpb24gPSB0aGlzLmhlbHBlci5jc3MoICJwb3NpdGlvbiIgKTsKCQl0aGlzLnNjcm9sbFBhcmVudCA9IHRoaXMuaGVscGVyLnNjcm9sbFBhcmVudCggdHJ1ZSApOwoJCXRoaXMub2Zmc2V0UGFyZW50ID0gdGhpcy5oZWxwZXIub2Zmc2V0UGFyZW50KCk7CgkJdGhpcy5oYXNGaXhlZEFuY2VzdG9yID0gdGhpcy5oZWxwZXIucGFyZW50cygpLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggdGhpcyApLmNzcyggInBvc2l0aW9uIiApID09PSAiZml4ZWQiOwoJCQl9ICkubGVuZ3RoID4gMDsKCgkJLy9UaGUgZWxlbWVudCdzIGFic29sdXRlIHBvc2l0aW9uIG9uIHRoZSBwYWdlIG1pbnVzIG1hcmdpbnMKCQl0aGlzLnBvc2l0aW9uQWJzID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpOwoJCXRoaXMuX3JlZnJlc2hPZmZzZXRzKCBldmVudCApOwoKCQkvL0dlbmVyYXRlIHRoZSBvcmlnaW5hbCBwb3NpdGlvbgoJCXRoaXMub3JpZ2luYWxQb3NpdGlvbiA9IHRoaXMucG9zaXRpb24gPSB0aGlzLl9nZW5lcmF0ZVBvc2l0aW9uKCBldmVudCwgZmFsc2UgKTsKCQl0aGlzLm9yaWdpbmFsUGFnZVggPSBldmVudC5wYWdlWDsKCQl0aGlzLm9yaWdpbmFsUGFnZVkgPSBldmVudC5wYWdlWTsKCgkJLy9BZGp1c3QgdGhlIG1vdXNlIG9mZnNldCByZWxhdGl2ZSB0byB0aGUgaGVscGVyIGlmICJjdXJzb3JBdCIgaXMgc3VwcGxpZWQKCQkoIG8uY3Vyc29yQXQgJiYgdGhpcy5fYWRqdXN0T2Zmc2V0RnJvbUhlbHBlciggby5jdXJzb3JBdCApICk7CgoJCS8vU2V0IGEgY29udGFpbm1lbnQgaWYgZ2l2ZW4gaW4gdGhlIG9wdGlvbnMKCQl0aGlzLl9zZXRDb250YWlubWVudCgpOwoKCQkvL1RyaWdnZXIgZXZlbnQgKyBjYWxsYmFja3MKCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJzdGFydCIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQl0aGlzLl9jbGVhcigpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvL1JlY2FjaGUgdGhlIGhlbHBlciBzaXplCgkJdGhpcy5fY2FjaGVIZWxwZXJQcm9wb3J0aW9ucygpOwoKCQkvL1ByZXBhcmUgdGhlIGRyb3BwYWJsZSBvZmZzZXRzCgkJaWYgKCAkLnVpLmRkbWFuYWdlciAmJiAhby5kcm9wQmVoYXZpb3VyICkgewoJCQkkLnVpLmRkbWFuYWdlci5wcmVwYXJlT2Zmc2V0cyggdGhpcywgZXZlbnQgKTsKCQl9CgoJCS8vIEV4ZWN1dGUgdGhlIGRyYWcgb25jZSAtIHRoaXMgY2F1c2VzIHRoZSBoZWxwZXIgbm90IHRvIGJlIHZpc2libGUgYmVmb3JlIGdldHRpbmcgaXRzCgkJLy8gY29ycmVjdCBwb3NpdGlvbgoJCXRoaXMuX21vdXNlRHJhZyggZXZlbnQsIHRydWUgKTsKCgkJLy8gSWYgdGhlIGRkbWFuYWdlciBpcyB1c2VkIGZvciBkcm9wcGFibGVzLCBpbmZvcm0gdGhlIG1hbmFnZXIgdGhhdCBkcmFnZ2luZyBoYXMgc3RhcnRlZAoJCS8vIChzZWUgIzUwMDMpCgkJaWYgKCAkLnVpLmRkbWFuYWdlciApIHsKCQkJJC51aS5kZG1hbmFnZXIuZHJhZ1N0YXJ0KCB0aGlzLCBldmVudCApOwoJCX0KCgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9yZWZyZXNoT2Zmc2V0czogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMub2Zmc2V0ID0gewoJCQl0b3A6IHRoaXMucG9zaXRpb25BYnMudG9wIC0gdGhpcy5tYXJnaW5zLnRvcCwKCQkJbGVmdDogdGhpcy5wb3NpdGlvbkFicy5sZWZ0IC0gdGhpcy5tYXJnaW5zLmxlZnQsCgkJCXNjcm9sbDogZmFsc2UsCgkJCXBhcmVudDogdGhpcy5fZ2V0UGFyZW50T2Zmc2V0KCksCgkJCXJlbGF0aXZlOiB0aGlzLl9nZXRSZWxhdGl2ZU9mZnNldCgpCgkJfTsKCgkJdGhpcy5vZmZzZXQuY2xpY2sgPSB7CgkJCWxlZnQ6IGV2ZW50LnBhZ2VYIC0gdGhpcy5vZmZzZXQubGVmdCwKCQkJdG9wOiBldmVudC5wYWdlWSAtIHRoaXMub2Zmc2V0LnRvcAoJCX07Cgl9LAoKCV9tb3VzZURyYWc6IGZ1bmN0aW9uKCBldmVudCwgbm9Qcm9wYWdhdGlvbiApIHsKCgkJLy8gcmVzZXQgYW55IG5lY2Vzc2FyeSBjYWNoZWQgcHJvcGVydGllcyAoc2VlICM1MDA5KQoJCWlmICggdGhpcy5oYXNGaXhlZEFuY2VzdG9yICkgewoJCQl0aGlzLm9mZnNldC5wYXJlbnQgPSB0aGlzLl9nZXRQYXJlbnRPZmZzZXQoKTsKCQl9CgoJCS8vQ29tcHV0ZSB0aGUgaGVscGVycyBwb3NpdGlvbgoJCXRoaXMucG9zaXRpb24gPSB0aGlzLl9nZW5lcmF0ZVBvc2l0aW9uKCBldmVudCwgdHJ1ZSApOwoJCXRoaXMucG9zaXRpb25BYnMgPSB0aGlzLl9jb252ZXJ0UG9zaXRpb25UbyggImFic29sdXRlIiApOwoKCQkvL0NhbGwgcGx1Z2lucyBhbmQgY2FsbGJhY2tzIGFuZCB1c2UgdGhlIHJlc3VsdGluZyBwb3NpdGlvbiBpZiBzb21ldGhpbmcgaXMgcmV0dXJuZWQKCQlpZiAoICFub1Byb3BhZ2F0aW9uICkgewoJCQl2YXIgdWkgPSB0aGlzLl91aUhhc2goKTsKCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiZHJhZyIsIGV2ZW50LCB1aSApID09PSBmYWxzZSApIHsKCQkJCXRoaXMuX21vdXNlVXAoIG5ldyAkLkV2ZW50KCAibW91c2V1cCIsIGV2ZW50ICkgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQl0aGlzLnBvc2l0aW9uID0gdWkucG9zaXRpb247CgkJfQoKCQl0aGlzLmhlbHBlclsgMCBdLnN0eWxlLmxlZnQgPSB0aGlzLnBvc2l0aW9uLmxlZnQgKyAicHgiOwoJCXRoaXMuaGVscGVyWyAwIF0uc3R5bGUudG9wID0gdGhpcy5wb3NpdGlvbi50b3AgKyAicHgiOwoKCQlpZiAoICQudWkuZGRtYW5hZ2VyICkgewoJCQkkLnVpLmRkbWFuYWdlci5kcmFnKCB0aGlzLCBldmVudCApOwoJCX0KCgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfbW91c2VTdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCS8vSWYgd2UgYXJlIHVzaW5nIGRyb3BwYWJsZXMsIGluZm9ybSB0aGUgbWFuYWdlciBhYm91dCB0aGUgZHJvcAoJCXZhciB0aGF0ID0gdGhpcywKCQkJZHJvcHBlZCA9IGZhbHNlOwoJCWlmICggJC51aS5kZG1hbmFnZXIgJiYgIXRoaXMub3B0aW9ucy5kcm9wQmVoYXZpb3VyICkgewoJCQlkcm9wcGVkID0gJC51aS5kZG1hbmFnZXIuZHJvcCggdGhpcywgZXZlbnQgKTsKCQl9CgoJCS8vaWYgYSBkcm9wIGNvbWVzIGZyb20gb3V0c2lkZSAoYSBzb3J0YWJsZSkKCQlpZiAoIHRoaXMuZHJvcHBlZCApIHsKCQkJZHJvcHBlZCA9IHRoaXMuZHJvcHBlZDsKCQkJdGhpcy5kcm9wcGVkID0gZmFsc2U7CgkJfQoKCQlpZiAoICggdGhpcy5vcHRpb25zLnJldmVydCA9PT0gImludmFsaWQiICYmICFkcm9wcGVkICkgfHwKCQkJCSggdGhpcy5vcHRpb25zLnJldmVydCA9PT0gInZhbGlkIiAmJiBkcm9wcGVkICkgfHwKCQkJCXRoaXMub3B0aW9ucy5yZXZlcnQgPT09IHRydWUgfHwgKCAkLmlzRnVuY3Rpb24oIHRoaXMub3B0aW9ucy5yZXZlcnQgKSAmJgoJCQkJdGhpcy5vcHRpb25zLnJldmVydC5jYWxsKCB0aGlzLmVsZW1lbnQsIGRyb3BwZWQgKSApCgkJKSB7CgkJCSQoIHRoaXMuaGVscGVyICkuYW5pbWF0ZSgKCQkJCXRoaXMub3JpZ2luYWxQb3NpdGlvbiwKCQkJCXBhcnNlSW50KCB0aGlzLm9wdGlvbnMucmV2ZXJ0RHVyYXRpb24sIDEwICksCgkJCQlmdW5jdGlvbigpIHsKCQkJCQlpZiAoIHRoYXQuX3RyaWdnZXIoICJzdG9wIiwgZXZlbnQgKSAhPT0gZmFsc2UgKSB7CgkJCQkJCXRoYXQuX2NsZWFyKCk7CgkJCQkJfQoJCQkJfQoJCQkpOwoJCX0gZWxzZSB7CgkJCWlmICggdGhpcy5fdHJpZ2dlciggInN0b3AiLCBldmVudCApICE9PSBmYWxzZSApIHsKCQkJCXRoaXMuX2NsZWFyKCk7CgkJCX0KCQl9CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJX21vdXNlVXA6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLl91bmJsb2NrRnJhbWVzKCk7CgoJCS8vIElmIHRoZSBkZG1hbmFnZXIgaXMgdXNlZCBmb3IgZHJvcHBhYmxlcywgaW5mb3JtIHRoZSBtYW5hZ2VyIHRoYXQgZHJhZ2dpbmcgaGFzIHN0b3BwZWQKCQkvLyAoc2VlICM1MDAzKQoJCWlmICggJC51aS5kZG1hbmFnZXIgKSB7CgkJCSQudWkuZGRtYW5hZ2VyLmRyYWdTdG9wKCB0aGlzLCBldmVudCApOwoJCX0KCgkJLy8gT25seSBuZWVkIHRvIGZvY3VzIGlmIHRoZSBldmVudCBvY2N1cnJlZCBvbiB0aGUgZHJhZ2dhYmxlIGl0c2VsZiwgc2VlICMxMDUyNwoJCWlmICggdGhpcy5oYW5kbGVFbGVtZW50LmlzKCBldmVudC50YXJnZXQgKSApIHsKCgkJCS8vIFRoZSBpbnRlcmFjdGlvbiBpcyBvdmVyOyB3aGV0aGVyIG9yIG5vdCB0aGUgY2xpY2sgcmVzdWx0ZWQgaW4gYSBkcmFnLAoJCQkvLyBmb2N1cyB0aGUgZWxlbWVudAoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImZvY3VzIiApOwoJCX0KCgkJcmV0dXJuICQudWkubW91c2UucHJvdG90eXBlLl9tb3VzZVVwLmNhbGwoIHRoaXMsIGV2ZW50ICk7Cgl9LAoKCWNhbmNlbDogZnVuY3Rpb24oKSB7CgoJCWlmICggdGhpcy5oZWxwZXIuaXMoICIudWktZHJhZ2dhYmxlLWRyYWdnaW5nIiApICkgewoJCQl0aGlzLl9tb3VzZVVwKCBuZXcgJC5FdmVudCggIm1vdXNldXAiLCB7IHRhcmdldDogdGhpcy5lbGVtZW50WyAwIF0gfSApICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fY2xlYXIoKTsKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJX2dldEhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMuaGFuZGxlID8KCQkJISEkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5vcHRpb25zLmhhbmRsZSApICkubGVuZ3RoIDoKCQkJdHJ1ZTsKCX0sCgoJX3NldEhhbmRsZUNsYXNzTmFtZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5oYW5kbGVFbGVtZW50ID0gdGhpcy5vcHRpb25zLmhhbmRsZSA/CgkJCXRoaXMuZWxlbWVudC5maW5kKCB0aGlzLm9wdGlvbnMuaGFuZGxlICkgOiB0aGlzLmVsZW1lbnQ7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaGFuZGxlRWxlbWVudCwgInVpLWRyYWdnYWJsZS1oYW5kbGUiICk7Cgl9LAoKCV9yZW1vdmVIYW5kbGVDbGFzc05hbWU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmhhbmRsZUVsZW1lbnQsICJ1aS1kcmFnZ2FibGUtaGFuZGxlIiApOwoJfSwKCglfY3JlYXRlSGVscGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQloZWxwZXJJc0Z1bmN0aW9uID0gJC5pc0Z1bmN0aW9uKCBvLmhlbHBlciApLAoJCQloZWxwZXIgPSBoZWxwZXJJc0Z1bmN0aW9uID8KCQkJCSQoIG8uaGVscGVyLmFwcGx5KCB0aGlzLmVsZW1lbnRbIDAgXSwgWyBldmVudCBdICkgKSA6CgkJCQkoIG8uaGVscGVyID09PSAiY2xvbmUiID8KCQkJCQl0aGlzLmVsZW1lbnQuY2xvbmUoKS5yZW1vdmVBdHRyKCAiaWQiICkgOgoJCQkJCXRoaXMuZWxlbWVudCApOwoKCQlpZiAoICFoZWxwZXIucGFyZW50cyggImJvZHkiICkubGVuZ3RoICkgewoJCQloZWxwZXIuYXBwZW5kVG8oICggby5hcHBlbmRUbyA9PT0gInBhcmVudCIgPwoJCQkJdGhpcy5lbGVtZW50WyAwIF0ucGFyZW50Tm9kZSA6CgkJCQlvLmFwcGVuZFRvICkgKTsKCQl9CgoJCS8vIEh0dHA6Ly9idWdzLmpxdWVyeXVpLmNvbS90aWNrZXQvOTQ0NgoJCS8vIGEgaGVscGVyIGZ1bmN0aW9uIGNhbiByZXR1cm4gdGhlIG9yaWdpbmFsIGVsZW1lbnQKCQkvLyB3aGljaCB3b3VsZG4ndCBoYXZlIGJlZW4gc2V0IHRvIHJlbGF0aXZlIGluIF9jcmVhdGUKCQlpZiAoIGhlbHBlcklzRnVuY3Rpb24gJiYgaGVscGVyWyAwIF0gPT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQl0aGlzLl9zZXRQb3NpdGlvblJlbGF0aXZlKCk7CgkJfQoKCQlpZiAoIGhlbHBlclsgMCBdICE9PSB0aGlzLmVsZW1lbnRbIDAgXSAmJgoJCQkJISggLyhmaXhlZHxhYnNvbHV0ZSkvICkudGVzdCggaGVscGVyLmNzcyggInBvc2l0aW9uIiApICkgKSB7CgkJCWhlbHBlci5jc3MoICJwb3NpdGlvbiIsICJhYnNvbHV0ZSIgKTsKCQl9CgoJCXJldHVybiBoZWxwZXI7CgoJfSwKCglfc2V0UG9zaXRpb25SZWxhdGl2ZTogZnVuY3Rpb24oKSB7CgkJaWYgKCAhKCAvXig/OnJ8YXxmKS8gKS50ZXN0KCB0aGlzLmVsZW1lbnQuY3NzKCAicG9zaXRpb24iICkgKSApIHsKCQkJdGhpcy5lbGVtZW50WyAwIF0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwoJCX0KCX0sCgoJX2FkanVzdE9mZnNldEZyb21IZWxwZXI6IGZ1bmN0aW9uKCBvYmogKSB7CgkJaWYgKCB0eXBlb2Ygb2JqID09PSAic3RyaW5nIiApIHsKCQkJb2JqID0gb2JqLnNwbGl0KCAiICIgKTsKCQl9CgkJaWYgKCAkLmlzQXJyYXkoIG9iaiApICkgewoJCQlvYmogPSB7IGxlZnQ6ICtvYmpbIDAgXSwgdG9wOiArb2JqWyAxIF0gfHwgMCB9OwoJCX0KCQlpZiAoICJsZWZ0IiBpbiBvYmogKSB7CgkJCXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPSBvYmoubGVmdCArIHRoaXMubWFyZ2lucy5sZWZ0OwoJCX0KCQlpZiAoICJyaWdodCIgaW4gb2JqICkgewoJCQl0aGlzLm9mZnNldC5jbGljay5sZWZ0ID0gdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAtIG9iai5yaWdodCArIHRoaXMubWFyZ2lucy5sZWZ0OwoJCX0KCQlpZiAoICJ0b3AiIGluIG9iaiApIHsKCQkJdGhpcy5vZmZzZXQuY2xpY2sudG9wID0gb2JqLnRvcCArIHRoaXMubWFyZ2lucy50b3A7CgkJfQoJCWlmICggImJvdHRvbSIgaW4gb2JqICkgewoJCQl0aGlzLm9mZnNldC5jbGljay50b3AgPSB0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAtIG9iai5ib3R0b20gKyB0aGlzLm1hcmdpbnMudG9wOwoJCX0KCX0sCgoJX2lzUm9vdE5vZGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXJldHVybiAoIC8oaHRtbHxib2R5KS9pICkudGVzdCggZWxlbWVudC50YWdOYW1lICkgfHwgZWxlbWVudCA9PT0gdGhpcy5kb2N1bWVudFsgMCBdOwoJfSwKCglfZ2V0UGFyZW50T2Zmc2V0OiBmdW5jdGlvbigpIHsKCgkJLy9HZXQgdGhlIG9mZnNldFBhcmVudCBhbmQgY2FjaGUgaXRzIHBvc2l0aW9uCgkJdmFyIHBvID0gdGhpcy5vZmZzZXRQYXJlbnQub2Zmc2V0KCksCgkJCWRvY3VtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdOwoKCQkvLyBUaGlzIGlzIGEgc3BlY2lhbCBjYXNlIHdoZXJlIHdlIG5lZWQgdG8gbW9kaWZ5IGEgb2Zmc2V0IGNhbGN1bGF0ZWQgb24gc3RhcnQsIHNpbmNlIHRoZQoJCS8vIGZvbGxvd2luZyBoYXBwZW5lZDoKCQkvLyAxLiBUaGUgcG9zaXRpb24gb2YgdGhlIGhlbHBlciBpcyBhYnNvbHV0ZSwgc28gaXQncyBwb3NpdGlvbiBpcyBjYWxjdWxhdGVkIGJhc2VkIG9uIHRoZQoJCS8vIG5leHQgcG9zaXRpb25lZCBwYXJlbnQKCQkvLyAyLiBUaGUgYWN0dWFsIG9mZnNldCBwYXJlbnQgaXMgYSBjaGlsZCBvZiB0aGUgc2Nyb2xsIHBhcmVudCwgYW5kIHRoZSBzY3JvbGwgcGFyZW50IGlzbid0CgkJLy8gdGhlIGRvY3VtZW50LCB3aGljaCBtZWFucyB0aGF0IHRoZSBzY3JvbGwgaXMgaW5jbHVkZWQgaW4gdGhlIGluaXRpYWwgY2FsY3VsYXRpb24gb2YgdGhlCgkJLy8gb2Zmc2V0IG9mIHRoZSBwYXJlbnQsIGFuZCBuZXZlciByZWNhbGN1bGF0ZWQgdXBvbiBkcmFnCgkJaWYgKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAiYWJzb2x1dGUiICYmIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gIT09IGRvY3VtZW50ICYmCgkJCQkkLmNvbnRhaW5zKCB0aGlzLnNjcm9sbFBhcmVudFsgMCBdLCB0aGlzLm9mZnNldFBhcmVudFsgMCBdICkgKSB7CgkJCXBvLmxlZnQgKz0gdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsTGVmdCgpOwoJCQlwby50b3AgKz0gdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsVG9wKCk7CgkJfQoKCQlpZiAoIHRoaXMuX2lzUm9vdE5vZGUoIHRoaXMub2Zmc2V0UGFyZW50WyAwIF0gKSApIHsKCQkJcG8gPSB7IHRvcDogMCwgbGVmdDogMCB9OwoJCX0KCgkJcmV0dXJuIHsKCQkJdG9wOiBwby50b3AgKyAoIHBhcnNlSW50KCB0aGlzLm9mZnNldFBhcmVudC5jc3MoICJib3JkZXJUb3BXaWR0aCIgKSwgMTAgKSB8fCAwICksCgkJCWxlZnQ6IHBvLmxlZnQgKyAoIHBhcnNlSW50KCB0aGlzLm9mZnNldFBhcmVudC5jc3MoICJib3JkZXJMZWZ0V2lkdGgiICksIDEwICkgfHwgMCApCgkJfTsKCgl9LAoKCV9nZXRSZWxhdGl2ZU9mZnNldDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmNzc1Bvc2l0aW9uICE9PSAicmVsYXRpdmUiICkgewoJCQlyZXR1cm4geyB0b3A6IDAsIGxlZnQ6IDAgfTsKCQl9CgoJCXZhciBwID0gdGhpcy5lbGVtZW50LnBvc2l0aW9uKCksCgkJCXNjcm9sbElzUm9vdE5vZGUgPSB0aGlzLl9pc1Jvb3ROb2RlKCB0aGlzLnNjcm9sbFBhcmVudFsgMCBdICk7CgoJCXJldHVybiB7CgkJCXRvcDogcC50b3AgLSAoIHBhcnNlSW50KCB0aGlzLmhlbHBlci5jc3MoICJ0b3AiICksIDEwICkgfHwgMCApICsKCQkJCSggIXNjcm9sbElzUm9vdE5vZGUgPyB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKSA6IDAgKSwKCQkJbGVmdDogcC5sZWZ0IC0gKCBwYXJzZUludCggdGhpcy5oZWxwZXIuY3NzKCAibGVmdCIgKSwgMTAgKSB8fCAwICkgKwoJCQkJKCAhc2Nyb2xsSXNSb290Tm9kZSA/IHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKSA6IDAgKQoJCX07CgoJfSwKCglfY2FjaGVNYXJnaW5zOiBmdW5jdGlvbigpIHsKCQl0aGlzLm1hcmdpbnMgPSB7CgkJCWxlZnQ6ICggcGFyc2VJbnQoIHRoaXMuZWxlbWVudC5jc3MoICJtYXJnaW5MZWZ0IiApLCAxMCApIHx8IDAgKSwKCQkJdG9wOiAoIHBhcnNlSW50KCB0aGlzLmVsZW1lbnQuY3NzKCAibWFyZ2luVG9wIiApLCAxMCApIHx8IDAgKSwKCQkJcmlnaHQ6ICggcGFyc2VJbnQoIHRoaXMuZWxlbWVudC5jc3MoICJtYXJnaW5SaWdodCIgKSwgMTAgKSB8fCAwICksCgkJCWJvdHRvbTogKCBwYXJzZUludCggdGhpcy5lbGVtZW50LmNzcyggIm1hcmdpbkJvdHRvbSIgKSwgMTAgKSB8fCAwICkKCQl9OwoJfSwKCglfY2FjaGVIZWxwZXJQcm9wb3J0aW9uczogZnVuY3Rpb24oKSB7CgkJdGhpcy5oZWxwZXJQcm9wb3J0aW9ucyA9IHsKCQkJd2lkdGg6IHRoaXMuaGVscGVyLm91dGVyV2lkdGgoKSwKCQkJaGVpZ2h0OiB0aGlzLmhlbHBlci5vdXRlckhlaWdodCgpCgkJfTsKCX0sCgoJX3NldENvbnRhaW5tZW50OiBmdW5jdGlvbigpIHsKCgkJdmFyIGlzVXNlclNjcm9sbGFibGUsIGMsIGNlLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlkb2N1bWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXTsKCgkJdGhpcy5yZWxhdGl2ZUNvbnRhaW5lciA9IG51bGw7CgoJCWlmICggIW8uY29udGFpbm1lbnQgKSB7CgkJCXRoaXMuY29udGFpbm1lbnQgPSBudWxsOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIG8uY29udGFpbm1lbnQgPT09ICJ3aW5kb3ciICkgewoJCQl0aGlzLmNvbnRhaW5tZW50ID0gWwoJCQkJJCggd2luZG93ICkuc2Nyb2xsTGVmdCgpIC0gdGhpcy5vZmZzZXQucmVsYXRpdmUubGVmdCAtIHRoaXMub2Zmc2V0LnBhcmVudC5sZWZ0LAoJCQkJJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgLSB0aGlzLm9mZnNldC5yZWxhdGl2ZS50b3AgLSB0aGlzLm9mZnNldC5wYXJlbnQudG9wLAoJCQkJJCggd2luZG93ICkuc2Nyb2xsTGVmdCgpICsgJCggd2luZG93ICkud2lkdGgoKSAtCgkJCQkJdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAtIHRoaXMubWFyZ2lucy5sZWZ0LAoJCQkJJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgKwoJCQkJCSggJCggd2luZG93ICkuaGVpZ2h0KCkgfHwgZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlLnNjcm9sbEhlaWdodCApIC0KCQkJCQl0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAtIHRoaXMubWFyZ2lucy50b3AKCQkJXTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBvLmNvbnRhaW5tZW50ID09PSAiZG9jdW1lbnQiICkgewoJCQl0aGlzLmNvbnRhaW5tZW50ID0gWwoJCQkJMCwKCQkJCTAsCgkJCQkkKCBkb2N1bWVudCApLndpZHRoKCkgLSB0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC0gdGhpcy5tYXJnaW5zLmxlZnQsCgkJCQkoICQoIGRvY3VtZW50ICkuaGVpZ2h0KCkgfHwgZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlLnNjcm9sbEhlaWdodCApIC0KCQkJCQl0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAtIHRoaXMubWFyZ2lucy50b3AKCQkJXTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBvLmNvbnRhaW5tZW50LmNvbnN0cnVjdG9yID09PSBBcnJheSApIHsKCQkJdGhpcy5jb250YWlubWVudCA9IG8uY29udGFpbm1lbnQ7CgkJCXJldHVybjsKCQl9CgoJCWlmICggby5jb250YWlubWVudCA9PT0gInBhcmVudCIgKSB7CgkJCW8uY29udGFpbm1lbnQgPSB0aGlzLmhlbHBlclsgMCBdLnBhcmVudE5vZGU7CgkJfQoKCQljID0gJCggby5jb250YWlubWVudCApOwoJCWNlID0gY1sgMCBdOwoKCQlpZiAoICFjZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaXNVc2VyU2Nyb2xsYWJsZSA9IC8oc2Nyb2xsfGF1dG8pLy50ZXN0KCBjLmNzcyggIm92ZXJmbG93IiApICk7CgoJCXRoaXMuY29udGFpbm1lbnQgPSBbCgkJCSggcGFyc2VJbnQoIGMuY3NzKCAiYm9yZGVyTGVmdFdpZHRoIiApLCAxMCApIHx8IDAgKSArCgkJCQkoIHBhcnNlSW50KCBjLmNzcyggInBhZGRpbmdMZWZ0IiApLCAxMCApIHx8IDAgKSwKCQkJKCBwYXJzZUludCggYy5jc3MoICJib3JkZXJUb3BXaWR0aCIgKSwgMTAgKSB8fCAwICkgKwoJCQkJKCBwYXJzZUludCggYy5jc3MoICJwYWRkaW5nVG9wIiApLCAxMCApIHx8IDAgKSwKCQkJKCBpc1VzZXJTY3JvbGxhYmxlID8gTWF0aC5tYXgoIGNlLnNjcm9sbFdpZHRoLCBjZS5vZmZzZXRXaWR0aCApIDogY2Uub2Zmc2V0V2lkdGggKSAtCgkJCQkoIHBhcnNlSW50KCBjLmNzcyggImJvcmRlclJpZ2h0V2lkdGgiICksIDEwICkgfHwgMCApIC0KCQkJCSggcGFyc2VJbnQoIGMuY3NzKCAicGFkZGluZ1JpZ2h0IiApLCAxMCApIHx8IDAgKSAtCgkJCQl0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC0KCQkJCXRoaXMubWFyZ2lucy5sZWZ0IC0KCQkJCXRoaXMubWFyZ2lucy5yaWdodCwKCQkJKCBpc1VzZXJTY3JvbGxhYmxlID8gTWF0aC5tYXgoIGNlLnNjcm9sbEhlaWdodCwgY2Uub2Zmc2V0SGVpZ2h0ICkgOiBjZS5vZmZzZXRIZWlnaHQgKSAtCgkJCQkoIHBhcnNlSW50KCBjLmNzcyggImJvcmRlckJvdHRvbVdpZHRoIiApLCAxMCApIHx8IDAgKSAtCgkJCQkoIHBhcnNlSW50KCBjLmNzcyggInBhZGRpbmdCb3R0b20iICksIDEwICkgfHwgMCApIC0KCQkJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0KCQkJCXRoaXMubWFyZ2lucy50b3AgLQoJCQkJdGhpcy5tYXJnaW5zLmJvdHRvbQoJCV07CgkJdGhpcy5yZWxhdGl2ZUNvbnRhaW5lciA9IGM7Cgl9LAoKCV9jb252ZXJ0UG9zaXRpb25UbzogZnVuY3Rpb24oIGQsIHBvcyApIHsKCgkJaWYgKCAhcG9zICkgewoJCQlwb3MgPSB0aGlzLnBvc2l0aW9uOwoJCX0KCgkJdmFyIG1vZCA9IGQgPT09ICJhYnNvbHV0ZSIgPyAxIDogLTEsCgkJCXNjcm9sbElzUm9vdE5vZGUgPSB0aGlzLl9pc1Jvb3ROb2RlKCB0aGlzLnNjcm9sbFBhcmVudFsgMCBdICk7CgoJCXJldHVybiB7CgkJCXRvcDogKAoKCQkJCS8vIFRoZSBhYnNvbHV0ZSBtb3VzZSBwb3NpdGlvbgoJCQkJcG9zLnRvcAkrCgoJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50CgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS50b3AgKiBtb2QgKwoKCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpCgkJCQl0aGlzLm9mZnNldC5wYXJlbnQudG9wICogbW9kIC0KCQkJCSggKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAiZml4ZWQiID8KCQkJCQktdGhpcy5vZmZzZXQuc2Nyb2xsLnRvcCA6CgkJCQkJKCBzY3JvbGxJc1Jvb3ROb2RlID8gMCA6IHRoaXMub2Zmc2V0LnNjcm9sbC50b3AgKSApICogbW9kICkKCQkJKSwKCQkJbGVmdDogKAoKCQkJCS8vIFRoZSBhYnNvbHV0ZSBtb3VzZSBwb3NpdGlvbgoJCQkJcG9zLmxlZnQgKwoKCQkJCS8vIE9ubHkgZm9yIHJlbGF0aXZlIHBvc2l0aW9uZWQgbm9kZXM6IFJlbGF0aXZlIG9mZnNldCBmcm9tIGVsZW1lbnQgdG8gb2Zmc2V0IHBhcmVudAoJCQkJdGhpcy5vZmZzZXQucmVsYXRpdmUubGVmdCAqIG1vZCArCgoJCQkJLy8gVGhlIG9mZnNldFBhcmVudCdzIG9mZnNldCB3aXRob3V0IGJvcmRlcnMgKG9mZnNldCArIGJvcmRlcikKCQkJCXRoaXMub2Zmc2V0LnBhcmVudC5sZWZ0ICogbW9kCS0KCQkJCSggKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAiZml4ZWQiID8KCQkJCQktdGhpcy5vZmZzZXQuc2Nyb2xsLmxlZnQgOgoJCQkJCSggc2Nyb2xsSXNSb290Tm9kZSA/IDAgOiB0aGlzLm9mZnNldC5zY3JvbGwubGVmdCApICkgKiBtb2QgKQoJCQkpCgkJfTsKCgl9LAoKCV9nZW5lcmF0ZVBvc2l0aW9uOiBmdW5jdGlvbiggZXZlbnQsIGNvbnN0cmFpblBvc2l0aW9uICkgewoKCQl2YXIgY29udGFpbm1lbnQsIGNvLCB0b3AsIGxlZnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXNjcm9sbElzUm9vdE5vZGUgPSB0aGlzLl9pc1Jvb3ROb2RlKCB0aGlzLnNjcm9sbFBhcmVudFsgMCBdICksCgkJCXBhZ2VYID0gZXZlbnQucGFnZVgsCgkJCXBhZ2VZID0gZXZlbnQucGFnZVk7CgoJCS8vIENhY2hlIHRoZSBzY3JvbGwKCQlpZiAoICFzY3JvbGxJc1Jvb3ROb2RlIHx8ICF0aGlzLm9mZnNldC5zY3JvbGwgKSB7CgkJCXRoaXMub2Zmc2V0LnNjcm9sbCA9IHsKCQkJCXRvcDogdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsVG9wKCksCgkJCQlsZWZ0OiB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCkKCQkJfTsKCQl9CgoJCS8qCgkJICogLSBQb3NpdGlvbiBjb25zdHJhaW5pbmcgLQoJCSAqIENvbnN0cmFpbiB0aGUgcG9zaXRpb24gdG8gYSBtaXggb2YgZ3JpZCwgY29udGFpbm1lbnQuCgkJICovCgoJCS8vIElmIHdlIGFyZSBub3QgZHJhZ2dpbmcgeWV0LCB3ZSB3b24ndCBjaGVjayBmb3Igb3B0aW9ucwoJCWlmICggY29uc3RyYWluUG9zaXRpb24gKSB7CgkJCWlmICggdGhpcy5jb250YWlubWVudCApIHsKCQkJCWlmICggdGhpcy5yZWxhdGl2ZUNvbnRhaW5lciApIHsKCQkJCQljbyA9IHRoaXMucmVsYXRpdmVDb250YWluZXIub2Zmc2V0KCk7CgkJCQkJY29udGFpbm1lbnQgPSBbCgkJCQkJCXRoaXMuY29udGFpbm1lbnRbIDAgXSArIGNvLmxlZnQsCgkJCQkJCXRoaXMuY29udGFpbm1lbnRbIDEgXSArIGNvLnRvcCwKCQkJCQkJdGhpcy5jb250YWlubWVudFsgMiBdICsgY28ubGVmdCwKCQkJCQkJdGhpcy5jb250YWlubWVudFsgMyBdICsgY28udG9wCgkJCQkJXTsKCQkJCX0gZWxzZSB7CgkJCQkJY29udGFpbm1lbnQgPSB0aGlzLmNvbnRhaW5tZW50OwoJCQkJfQoKCQkJCWlmICggZXZlbnQucGFnZVggLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0IDwgY29udGFpbm1lbnRbIDAgXSApIHsKCQkJCQlwYWdlWCA9IGNvbnRhaW5tZW50WyAwIF0gKyB0aGlzLm9mZnNldC5jbGljay5sZWZ0OwoJCQkJfQoJCQkJaWYgKCBldmVudC5wYWdlWSAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA8IGNvbnRhaW5tZW50WyAxIF0gKSB7CgkJCQkJcGFnZVkgPSBjb250YWlubWVudFsgMSBdICsgdGhpcy5vZmZzZXQuY2xpY2sudG9wOwoJCQkJfQoJCQkJaWYgKCBldmVudC5wYWdlWCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPiBjb250YWlubWVudFsgMiBdICkgewoJCQkJCXBhZ2VYID0gY29udGFpbm1lbnRbIDIgXSArIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQ7CgkJCQl9CgkJCQlpZiAoIGV2ZW50LnBhZ2VZIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID4gY29udGFpbm1lbnRbIDMgXSApIHsKCQkJCQlwYWdlWSA9IGNvbnRhaW5tZW50WyAzIF0gKyB0aGlzLm9mZnNldC5jbGljay50b3A7CgkJCQl9CgkJCX0KCgkJCWlmICggby5ncmlkICkgewoKCQkJCS8vQ2hlY2sgZm9yIGdyaWQgZWxlbWVudHMgc2V0IHRvIDAgdG8gcHJldmVudCBkaXZpZGUgYnkgMCBlcnJvciBjYXVzaW5nIGludmFsaWQKCQkJCS8vIGFyZ3VtZW50IGVycm9ycyBpbiBJRSAoc2VlIHRpY2tldCAjNjk1MCkKCQkJCXRvcCA9IG8uZ3JpZFsgMSBdID8gdGhpcy5vcmlnaW5hbFBhZ2VZICsgTWF0aC5yb3VuZCggKCBwYWdlWSAtCgkJCQkJdGhpcy5vcmlnaW5hbFBhZ2VZICkgLyBvLmdyaWRbIDEgXSApICogby5ncmlkWyAxIF0gOiB0aGlzLm9yaWdpbmFsUGFnZVk7CgkJCQlwYWdlWSA9IGNvbnRhaW5tZW50ID8gKCAoIHRvcCAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA+PSBjb250YWlubWVudFsgMSBdIHx8CgkJCQkJdG9wIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID4gY29udGFpbm1lbnRbIDMgXSApID8KCQkJCQkJdG9wIDoKCQkJCQkJKCAoIHRvcCAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA+PSBjb250YWlubWVudFsgMSBdICkgPwoJCQkJCQkJdG9wIC0gby5ncmlkWyAxIF0gOiB0b3AgKyBvLmdyaWRbIDEgXSApICkgOiB0b3A7CgoJCQkJbGVmdCA9IG8uZ3JpZFsgMCBdID8gdGhpcy5vcmlnaW5hbFBhZ2VYICsKCQkJCQlNYXRoLnJvdW5kKCAoIHBhZ2VYIC0gdGhpcy5vcmlnaW5hbFBhZ2VYICkgLyBvLmdyaWRbIDAgXSApICogby5ncmlkWyAwIF0gOgoJCQkJCXRoaXMub3JpZ2luYWxQYWdlWDsKCQkJCXBhZ2VYID0gY29udGFpbm1lbnQgPyAoICggbGVmdCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPj0gY29udGFpbm1lbnRbIDAgXSB8fAoJCQkJCWxlZnQgLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0ID4gY29udGFpbm1lbnRbIDIgXSApID8KCQkJCQkJbGVmdCA6CgkJCQkJCSggKCBsZWZ0IC0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCA+PSBjb250YWlubWVudFsgMCBdICkgPwoJCQkJCQkJbGVmdCAtIG8uZ3JpZFsgMCBdIDogbGVmdCArIG8uZ3JpZFsgMCBdICkgKSA6IGxlZnQ7CgkJCX0KCgkJCWlmICggby5heGlzID09PSAieSIgKSB7CgkJCQlwYWdlWCA9IHRoaXMub3JpZ2luYWxQYWdlWDsKCQkJfQoKCQkJaWYgKCBvLmF4aXMgPT09ICJ4IiApIHsKCQkJCXBhZ2VZID0gdGhpcy5vcmlnaW5hbFBhZ2VZOwoJCQl9CgkJfQoKCQlyZXR1cm4gewoJCQl0b3A6ICgKCgkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24KCQkJCXBhZ2VZIC0KCgkJCQkvLyBDbGljayBvZmZzZXQgKHJlbGF0aXZlIHRvIHRoZSBlbGVtZW50KQoJCQkJdGhpcy5vZmZzZXQuY2xpY2sudG9wIC0KCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQKCQkJCXRoaXMub2Zmc2V0LnJlbGF0aXZlLnRvcCAtCgoJCQkJLy8gVGhlIG9mZnNldFBhcmVudCdzIG9mZnNldCB3aXRob3V0IGJvcmRlcnMgKG9mZnNldCArIGJvcmRlcikKCQkJCXRoaXMub2Zmc2V0LnBhcmVudC50b3AgKwoJCQkJKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAiZml4ZWQiID8KCQkJCQktdGhpcy5vZmZzZXQuc2Nyb2xsLnRvcCA6CgkJCQkJKCBzY3JvbGxJc1Jvb3ROb2RlID8gMCA6IHRoaXMub2Zmc2V0LnNjcm9sbC50b3AgKSApCgkJCSksCgkJCWxlZnQ6ICgKCgkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24KCQkJCXBhZ2VYIC0KCgkJCQkvLyBDbGljayBvZmZzZXQgKHJlbGF0aXZlIHRvIHRoZSBlbGVtZW50KQoJCQkJdGhpcy5vZmZzZXQuY2xpY2subGVmdCAtCgoJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50CgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0IC0KCgkJCQkvLyBUaGUgb2Zmc2V0UGFyZW50J3Mgb2Zmc2V0IHdpdGhvdXQgYm9yZGVycyAob2Zmc2V0ICsgYm9yZGVyKQoJCQkJdGhpcy5vZmZzZXQucGFyZW50LmxlZnQgKwoJCQkJKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAiZml4ZWQiID8KCQkJCQktdGhpcy5vZmZzZXQuc2Nyb2xsLmxlZnQgOgoJCQkJCSggc2Nyb2xsSXNSb290Tm9kZSA/IDAgOiB0aGlzLm9mZnNldC5zY3JvbGwubGVmdCApICkKCQkJKQoJCX07CgoJfSwKCglfY2xlYXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmhlbHBlciwgInVpLWRyYWdnYWJsZS1kcmFnZ2luZyIgKTsKCQlpZiAoIHRoaXMuaGVscGVyWyAwIF0gIT09IHRoaXMuZWxlbWVudFsgMCBdICYmICF0aGlzLmNhbmNlbEhlbHBlclJlbW92YWwgKSB7CgkJCXRoaXMuaGVscGVyLnJlbW92ZSgpOwoJCX0KCQl0aGlzLmhlbHBlciA9IG51bGw7CgkJdGhpcy5jYW5jZWxIZWxwZXJSZW1vdmFsID0gZmFsc2U7CgkJaWYgKCB0aGlzLmRlc3Ryb3lPbkNsZWFyICkgewoJCQl0aGlzLmRlc3Ryb3koKTsKCQl9Cgl9LAoKCS8vIEZyb20gbm93IG9uIGJ1bGsgc3R1ZmYgLSBtYWlubHkgaGVscGVycwoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIHVpICkgewoJCXVpID0gdWkgfHwgdGhpcy5fdWlIYXNoKCk7CgkJJC51aS5wbHVnaW4uY2FsbCggdGhpcywgdHlwZSwgWyBldmVudCwgdWksIHRoaXMgXSwgdHJ1ZSApOwoKCQkvLyBBYnNvbHV0ZSBwb3NpdGlvbiBhbmQgb2Zmc2V0IChzZWUgIzY4ODQgKSBoYXZlIHRvIGJlIHJlY2FsY3VsYXRlZCBhZnRlciBwbHVnaW5zCgkJaWYgKCAvXihkcmFnfHN0YXJ0fHN0b3ApLy50ZXN0KCB0eXBlICkgKSB7CgkJCXRoaXMucG9zaXRpb25BYnMgPSB0aGlzLl9jb252ZXJ0UG9zaXRpb25UbyggImFic29sdXRlIiApOwoJCQl1aS5vZmZzZXQgPSB0aGlzLnBvc2l0aW9uQWJzOwoJCX0KCQlyZXR1cm4gJC5XaWRnZXQucHJvdG90eXBlLl90cmlnZ2VyLmNhbGwoIHRoaXMsIHR5cGUsIGV2ZW50LCB1aSApOwoJfSwKCglwbHVnaW5zOiB7fSwKCglfdWlIYXNoOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gewoJCQloZWxwZXI6IHRoaXMuaGVscGVyLAoJCQlwb3NpdGlvbjogdGhpcy5wb3NpdGlvbiwKCQkJb3JpZ2luYWxQb3NpdGlvbjogdGhpcy5vcmlnaW5hbFBvc2l0aW9uLAoJCQlvZmZzZXQ6IHRoaXMucG9zaXRpb25BYnMKCQl9OwoJfQoKfSApOwoKJC51aS5wbHVnaW4uYWRkKCAiZHJhZ2dhYmxlIiwgImNvbm5lY3RUb1NvcnRhYmxlIiwgewoJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgdWksIGRyYWdnYWJsZSApIHsKCQl2YXIgdWlTb3J0YWJsZSA9ICQuZXh0ZW5kKCB7fSwgdWksIHsKCQkJaXRlbTogZHJhZ2dhYmxlLmVsZW1lbnQKCQl9ICk7CgoJCWRyYWdnYWJsZS5zb3J0YWJsZXMgPSBbXTsKCQkkKCBkcmFnZ2FibGUub3B0aW9ucy5jb25uZWN0VG9Tb3J0YWJsZSApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgc29ydGFibGUgPSAkKCB0aGlzICkuc29ydGFibGUoICJpbnN0YW5jZSIgKTsKCgkJCWlmICggc29ydGFibGUgJiYgIXNvcnRhYmxlLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQlkcmFnZ2FibGUuc29ydGFibGVzLnB1c2goIHNvcnRhYmxlICk7CgoJCQkJLy8gUmVmcmVzaFBvc2l0aW9ucyBpcyBjYWxsZWQgYXQgZHJhZyBzdGFydCB0byByZWZyZXNoIHRoZSBjb250YWluZXJDYWNoZQoJCQkJLy8gd2hpY2ggaXMgdXNlZCBpbiBkcmFnLiBUaGlzIGVuc3VyZXMgaXQncyBpbml0aWFsaXplZCBhbmQgc3luY2hyb25pemVkCgkJCQkvLyB3aXRoIGFueSBjaGFuZ2VzIHRoYXQgbWlnaHQgaGF2ZSBoYXBwZW5lZCBvbiB0aGUgcGFnZSBzaW5jZSBpbml0aWFsaXphdGlvbi4KCQkJCXNvcnRhYmxlLnJlZnJlc2hQb3NpdGlvbnMoKTsKCQkJCXNvcnRhYmxlLl90cmlnZ2VyKCAiYWN0aXZhdGUiLCBldmVudCwgdWlTb3J0YWJsZSApOwoJCQl9CgkJfSApOwoJfSwKCXN0b3A6IGZ1bmN0aW9uKCBldmVudCwgdWksIGRyYWdnYWJsZSApIHsKCQl2YXIgdWlTb3J0YWJsZSA9ICQuZXh0ZW5kKCB7fSwgdWksIHsKCQkJaXRlbTogZHJhZ2dhYmxlLmVsZW1lbnQKCQl9ICk7CgoJCWRyYWdnYWJsZS5jYW5jZWxIZWxwZXJSZW1vdmFsID0gZmFsc2U7CgoJCSQuZWFjaCggZHJhZ2dhYmxlLnNvcnRhYmxlcywgZnVuY3Rpb24oKSB7CgkJCXZhciBzb3J0YWJsZSA9IHRoaXM7CgoJCQlpZiAoIHNvcnRhYmxlLmlzT3ZlciApIHsKCQkJCXNvcnRhYmxlLmlzT3ZlciA9IDA7CgoJCQkJLy8gQWxsb3cgdGhpcyBzb3J0YWJsZSB0byBoYW5kbGUgcmVtb3ZpbmcgdGhlIGhlbHBlcgoJCQkJZHJhZ2dhYmxlLmNhbmNlbEhlbHBlclJlbW92YWwgPSB0cnVlOwoJCQkJc29ydGFibGUuY2FuY2VsSGVscGVyUmVtb3ZhbCA9IGZhbHNlOwoKCQkJCS8vIFVzZSBfc3RvcmVkQ1NTIFRvIHJlc3RvcmUgcHJvcGVydGllcyBpbiB0aGUgc29ydGFibGUsCgkJCQkvLyBhcyB0aGlzIGFsc28gaGFuZGxlcyByZXZlcnQgKCM5Njc1KSBzaW5jZSB0aGUgZHJhZ2dhYmxlCgkJCQkvLyBtYXkgaGF2ZSBtb2RpZmllZCB0aGVtIGluIHVuZXhwZWN0ZWQgd2F5cyAoIzg4MDkpCgkJCQlzb3J0YWJsZS5fc3RvcmVkQ1NTID0gewoJCQkJCXBvc2l0aW9uOiBzb3J0YWJsZS5wbGFjZWhvbGRlci5jc3MoICJwb3NpdGlvbiIgKSwKCQkJCQl0b3A6IHNvcnRhYmxlLnBsYWNlaG9sZGVyLmNzcyggInRvcCIgKSwKCQkJCQlsZWZ0OiBzb3J0YWJsZS5wbGFjZWhvbGRlci5jc3MoICJsZWZ0IiApCgkJCQl9OwoKCQkJCXNvcnRhYmxlLl9tb3VzZVN0b3AoIGV2ZW50ICk7CgoJCQkJLy8gT25jZSBkcmFnIGhhcyBlbmRlZCwgdGhlIHNvcnRhYmxlIHNob3VsZCByZXR1cm4gdG8gdXNpbmcKCQkJCS8vIGl0cyBvcmlnaW5hbCBoZWxwZXIsIG5vdCB0aGUgc2hhcmVkIGhlbHBlciBmcm9tIGRyYWdnYWJsZQoJCQkJc29ydGFibGUub3B0aW9ucy5oZWxwZXIgPSBzb3J0YWJsZS5vcHRpb25zLl9oZWxwZXI7CgkJCX0gZWxzZSB7CgoJCQkJLy8gUHJldmVudCB0aGlzIFNvcnRhYmxlIGZyb20gcmVtb3ZpbmcgdGhlIGhlbHBlci4KCQkJCS8vIEhvd2V2ZXIsIGRvbid0IHNldCB0aGUgZHJhZ2dhYmxlIHRvIHJlbW92ZSB0aGUgaGVscGVyCgkJCQkvLyBlaXRoZXIgYXMgYW5vdGhlciBjb25uZWN0ZWQgU29ydGFibGUgbWF5IHlldCBoYW5kbGUgdGhlIHJlbW92YWwuCgkJCQlzb3J0YWJsZS5jYW5jZWxIZWxwZXJSZW1vdmFsID0gdHJ1ZTsKCgkJCQlzb3J0YWJsZS5fdHJpZ2dlciggImRlYWN0aXZhdGUiLCBldmVudCwgdWlTb3J0YWJsZSApOwoJCQl9CgkJfSApOwoJfSwKCWRyYWc6IGZ1bmN0aW9uKCBldmVudCwgdWksIGRyYWdnYWJsZSApIHsKCQkkLmVhY2goIGRyYWdnYWJsZS5zb3J0YWJsZXMsIGZ1bmN0aW9uKCkgewoJCQl2YXIgaW5uZXJtb3N0SW50ZXJzZWN0aW5nID0gZmFsc2UsCgkJCQlzb3J0YWJsZSA9IHRoaXM7CgoJCQkvLyBDb3B5IG92ZXIgdmFyaWFibGVzIHRoYXQgc29ydGFibGUncyBfaW50ZXJzZWN0c1dpdGggdXNlcwoJCQlzb3J0YWJsZS5wb3NpdGlvbkFicyA9IGRyYWdnYWJsZS5wb3NpdGlvbkFiczsKCQkJc29ydGFibGUuaGVscGVyUHJvcG9ydGlvbnMgPSBkcmFnZ2FibGUuaGVscGVyUHJvcG9ydGlvbnM7CgkJCXNvcnRhYmxlLm9mZnNldC5jbGljayA9IGRyYWdnYWJsZS5vZmZzZXQuY2xpY2s7CgoJCQlpZiAoIHNvcnRhYmxlLl9pbnRlcnNlY3RzV2l0aCggc29ydGFibGUuY29udGFpbmVyQ2FjaGUgKSApIHsKCQkJCWlubmVybW9zdEludGVyc2VjdGluZyA9IHRydWU7CgoJCQkJJC5lYWNoKCBkcmFnZ2FibGUuc29ydGFibGVzLCBmdW5jdGlvbigpIHsKCgkJCQkJLy8gQ29weSBvdmVyIHZhcmlhYmxlcyB0aGF0IHNvcnRhYmxlJ3MgX2ludGVyc2VjdHNXaXRoIHVzZXMKCQkJCQl0aGlzLnBvc2l0aW9uQWJzID0gZHJhZ2dhYmxlLnBvc2l0aW9uQWJzOwoJCQkJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMgPSBkcmFnZ2FibGUuaGVscGVyUHJvcG9ydGlvbnM7CgkJCQkJdGhpcy5vZmZzZXQuY2xpY2sgPSBkcmFnZ2FibGUub2Zmc2V0LmNsaWNrOwoKCQkJCQlpZiAoIHRoaXMgIT09IHNvcnRhYmxlICYmCgkJCQkJCQl0aGlzLl9pbnRlcnNlY3RzV2l0aCggdGhpcy5jb250YWluZXJDYWNoZSApICYmCgkJCQkJCQkkLmNvbnRhaW5zKCBzb3J0YWJsZS5lbGVtZW50WyAwIF0sIHRoaXMuZWxlbWVudFsgMCBdICkgKSB7CgkJCQkJCWlubmVybW9zdEludGVyc2VjdGluZyA9IGZhbHNlOwoJCQkJCX0KCgkJCQkJcmV0dXJuIGlubmVybW9zdEludGVyc2VjdGluZzsKCQkJCX0gKTsKCQkJfQoKCQkJaWYgKCBpbm5lcm1vc3RJbnRlcnNlY3RpbmcgKSB7CgoJCQkJLy8gSWYgaXQgaW50ZXJzZWN0cywgd2UgdXNlIGEgbGl0dGxlIGlzT3ZlciB2YXJpYWJsZSBhbmQgc2V0IGl0IG9uY2UsCgkJCQkvLyBzbyB0aGF0IHRoZSBtb3ZlLWluIHN0dWZmIGdldHMgZmlyZWQgb25seSBvbmNlLgoJCQkJaWYgKCAhc29ydGFibGUuaXNPdmVyICkgewoJCQkJCXNvcnRhYmxlLmlzT3ZlciA9IDE7CgoJCQkJCS8vIFN0b3JlIGRyYWdnYWJsZSdzIHBhcmVudCBpbiBjYXNlIHdlIG5lZWQgdG8gcmVhcHBlbmQgdG8gaXQgbGF0ZXIuCgkJCQkJZHJhZ2dhYmxlLl9wYXJlbnQgPSB1aS5oZWxwZXIucGFyZW50KCk7CgoJCQkJCXNvcnRhYmxlLmN1cnJlbnRJdGVtID0gdWkuaGVscGVyCgkJCQkJCS5hcHBlbmRUbyggc29ydGFibGUuZWxlbWVudCApCgkJCQkJCS5kYXRhKCAidWktc29ydGFibGUtaXRlbSIsIHRydWUgKTsKCgkJCQkJLy8gU3RvcmUgaGVscGVyIG9wdGlvbiB0byBsYXRlciByZXN0b3JlIGl0CgkJCQkJc29ydGFibGUub3B0aW9ucy5faGVscGVyID0gc29ydGFibGUub3B0aW9ucy5oZWxwZXI7CgoJCQkJCXNvcnRhYmxlLm9wdGlvbnMuaGVscGVyID0gZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiB1aS5oZWxwZXJbIDAgXTsKCQkJCQl9OwoKCQkJCQkvLyBGaXJlIHRoZSBzdGFydCBldmVudHMgb2YgdGhlIHNvcnRhYmxlIHdpdGggb3VyIHBhc3NlZCBicm93c2VyIGV2ZW50LAoJCQkJCS8vIGFuZCBvdXIgb3duIGhlbHBlciAoc28gaXQgZG9lc24ndCBjcmVhdGUgYSBuZXcgb25lKQoJCQkJCWV2ZW50LnRhcmdldCA9IHNvcnRhYmxlLmN1cnJlbnRJdGVtWyAwIF07CgkJCQkJc29ydGFibGUuX21vdXNlQ2FwdHVyZSggZXZlbnQsIHRydWUgKTsKCQkJCQlzb3J0YWJsZS5fbW91c2VTdGFydCggZXZlbnQsIHRydWUsIHRydWUgKTsKCgkJCQkJLy8gQmVjYXVzZSB0aGUgYnJvd3NlciBldmVudCBpcyB3YXkgb2ZmIHRoZSBuZXcgYXBwZW5kZWQgcG9ydGxldCwKCQkJCQkvLyBtb2RpZnkgbmVjZXNzYXJ5IHZhcmlhYmxlcyB0byByZWZsZWN0IHRoZSBjaGFuZ2VzCgkJCQkJc29ydGFibGUub2Zmc2V0LmNsaWNrLnRvcCA9IGRyYWdnYWJsZS5vZmZzZXQuY2xpY2sudG9wOwoJCQkJCXNvcnRhYmxlLm9mZnNldC5jbGljay5sZWZ0ID0gZHJhZ2dhYmxlLm9mZnNldC5jbGljay5sZWZ0OwoJCQkJCXNvcnRhYmxlLm9mZnNldC5wYXJlbnQubGVmdCAtPSBkcmFnZ2FibGUub2Zmc2V0LnBhcmVudC5sZWZ0IC0KCQkJCQkJc29ydGFibGUub2Zmc2V0LnBhcmVudC5sZWZ0OwoJCQkJCXNvcnRhYmxlLm9mZnNldC5wYXJlbnQudG9wIC09IGRyYWdnYWJsZS5vZmZzZXQucGFyZW50LnRvcCAtCgkJCQkJCXNvcnRhYmxlLm9mZnNldC5wYXJlbnQudG9wOwoKCQkJCQlkcmFnZ2FibGUuX3RyaWdnZXIoICJ0b1NvcnRhYmxlIiwgZXZlbnQgKTsKCgkJCQkJLy8gSW5mb3JtIGRyYWdnYWJsZSB0aGF0IHRoZSBoZWxwZXIgaXMgaW4gYSB2YWxpZCBkcm9wIHpvbmUsCgkJCQkJLy8gdXNlZCBzb2xlbHkgaW4gdGhlIHJldmVydCBvcHRpb24gdG8gaGFuZGxlICJ2YWxpZC9pbnZhbGlkIi4KCQkJCQlkcmFnZ2FibGUuZHJvcHBlZCA9IHNvcnRhYmxlLmVsZW1lbnQ7CgoJCQkJCS8vIE5lZWQgdG8gcmVmcmVzaFBvc2l0aW9ucyBvZiBhbGwgc29ydGFibGVzIGluIHRoZSBjYXNlIHRoYXQKCQkJCQkvLyBhZGRpbmcgdG8gb25lIHNvcnRhYmxlIGNoYW5nZXMgdGhlIGxvY2F0aW9uIG9mIHRoZSBvdGhlciBzb3J0YWJsZXMgKCM5Njc1KQoJCQkJCSQuZWFjaCggZHJhZ2dhYmxlLnNvcnRhYmxlcywgZnVuY3Rpb24oKSB7CgkJCQkJCXRoaXMucmVmcmVzaFBvc2l0aW9ucygpOwoJCQkJCX0gKTsKCgkJCQkJLy8gSGFjayBzbyByZWNlaXZlL3VwZGF0ZSBjYWxsYmFja3Mgd29yayAobW9zdGx5KQoJCQkJCWRyYWdnYWJsZS5jdXJyZW50SXRlbSA9IGRyYWdnYWJsZS5lbGVtZW50OwoJCQkJCXNvcnRhYmxlLmZyb21PdXRzaWRlID0gZHJhZ2dhYmxlOwoJCQkJfQoKCQkJCWlmICggc29ydGFibGUuY3VycmVudEl0ZW0gKSB7CgkJCQkJc29ydGFibGUuX21vdXNlRHJhZyggZXZlbnQgKTsKCgkJCQkJLy8gQ29weSB0aGUgc29ydGFibGUncyBwb3NpdGlvbiBiZWNhdXNlIHRoZSBkcmFnZ2FibGUncyBjYW4gcG90ZW50aWFsbHkgcmVmbGVjdAoJCQkJCS8vIGEgcmVsYXRpdmUgcG9zaXRpb24sIHdoaWxlIHNvcnRhYmxlIGlzIGFsd2F5cyBhYnNvbHV0ZSwgd2hpY2ggdGhlIGRyYWdnZWQKCQkJCQkvLyBlbGVtZW50IGhhcyBub3cgYmVjb21lLiAoIzg4MDkpCgkJCQkJdWkucG9zaXRpb24gPSBzb3J0YWJsZS5wb3NpdGlvbjsKCQkJCX0KCQkJfSBlbHNlIHsKCgkJCQkvLyBJZiBpdCBkb2Vzbid0IGludGVyc2VjdCB3aXRoIHRoZSBzb3J0YWJsZSwgYW5kIGl0IGludGVyc2VjdGVkIGJlZm9yZSwKCQkJCS8vIHdlIGZha2UgdGhlIGRyYWcgc3RvcCBvZiB0aGUgc29ydGFibGUsIGJ1dCBtYWtlIHN1cmUgaXQgZG9lc24ndCByZW1vdmUKCQkJCS8vIHRoZSBoZWxwZXIgYnkgdXNpbmcgY2FuY2VsSGVscGVyUmVtb3ZhbC4KCQkJCWlmICggc29ydGFibGUuaXNPdmVyICkgewoKCQkJCQlzb3J0YWJsZS5pc092ZXIgPSAwOwoJCQkJCXNvcnRhYmxlLmNhbmNlbEhlbHBlclJlbW92YWwgPSB0cnVlOwoKCQkJCQkvLyBDYWxsaW5nIHNvcnRhYmxlJ3MgbW91c2VTdG9wIHdvdWxkIHRyaWdnZXIgYSByZXZlcnQsCgkJCQkJLy8gc28gcmV2ZXJ0IG11c3QgYmUgdGVtcG9yYXJpbHkgZmFsc2UgdW50aWwgYWZ0ZXIgbW91c2VTdG9wIGlzIGNhbGxlZC4KCQkJCQlzb3J0YWJsZS5vcHRpb25zLl9yZXZlcnQgPSBzb3J0YWJsZS5vcHRpb25zLnJldmVydDsKCQkJCQlzb3J0YWJsZS5vcHRpb25zLnJldmVydCA9IGZhbHNlOwoKCQkJCQlzb3J0YWJsZS5fdHJpZ2dlciggIm91dCIsIGV2ZW50LCBzb3J0YWJsZS5fdWlIYXNoKCBzb3J0YWJsZSApICk7CgkJCQkJc29ydGFibGUuX21vdXNlU3RvcCggZXZlbnQsIHRydWUgKTsKCgkJCQkJLy8gUmVzdG9yZSBzb3J0YWJsZSBiZWhhdmlvcnMgdGhhdCB3ZXJlIG1vZGZpZWQKCQkJCQkvLyB3aGVuIHRoZSBkcmFnZ2FibGUgZW50ZXJlZCB0aGUgc29ydGFibGUgYXJlYSAoIzk0ODEpCgkJCQkJc29ydGFibGUub3B0aW9ucy5yZXZlcnQgPSBzb3J0YWJsZS5vcHRpb25zLl9yZXZlcnQ7CgkJCQkJc29ydGFibGUub3B0aW9ucy5oZWxwZXIgPSBzb3J0YWJsZS5vcHRpb25zLl9oZWxwZXI7CgoJCQkJCWlmICggc29ydGFibGUucGxhY2Vob2xkZXIgKSB7CgkJCQkJCXNvcnRhYmxlLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoJCQkJCX0KCgkJCQkJLy8gUmVzdG9yZSBhbmQgcmVjYWxjdWxhdGUgdGhlIGRyYWdnYWJsZSdzIG9mZnNldCBjb25zaWRlcmluZyB0aGUgc29ydGFibGUKCQkJCQkvLyBtYXkgaGF2ZSBtb2RpZmllZCB0aGVtIGluIHVuZXhwZWN0ZWQgd2F5cy4gKCM4ODA5LCAjMTA2NjkpCgkJCQkJdWkuaGVscGVyLmFwcGVuZFRvKCBkcmFnZ2FibGUuX3BhcmVudCApOwoJCQkJCWRyYWdnYWJsZS5fcmVmcmVzaE9mZnNldHMoIGV2ZW50ICk7CgkJCQkJdWkucG9zaXRpb24gPSBkcmFnZ2FibGUuX2dlbmVyYXRlUG9zaXRpb24oIGV2ZW50LCB0cnVlICk7CgoJCQkJCWRyYWdnYWJsZS5fdHJpZ2dlciggImZyb21Tb3J0YWJsZSIsIGV2ZW50ICk7CgoJCQkJCS8vIEluZm9ybSBkcmFnZ2FibGUgdGhhdCB0aGUgaGVscGVyIGlzIG5vIGxvbmdlciBpbiBhIHZhbGlkIGRyb3Agem9uZQoJCQkJCWRyYWdnYWJsZS5kcm9wcGVkID0gZmFsc2U7CgoJCQkJCS8vIE5lZWQgdG8gcmVmcmVzaFBvc2l0aW9ucyBvZiBhbGwgc29ydGFibGVzIGp1c3QgaW4gY2FzZSByZW1vdmluZwoJCQkJCS8vIGZyb20gb25lIHNvcnRhYmxlIGNoYW5nZXMgdGhlIGxvY2F0aW9uIG9mIG90aGVyIHNvcnRhYmxlcyAoIzk2NzUpCgkJCQkJJC5lYWNoKCBkcmFnZ2FibGUuc29ydGFibGVzLCBmdW5jdGlvbigpIHsKCQkJCQkJdGhpcy5yZWZyZXNoUG9zaXRpb25zKCk7CgkJCQkJfSApOwoJCQkJfQoJCQl9CgkJfSApOwoJfQp9ICk7CgokLnVpLnBsdWdpbi5hZGQoICJkcmFnZ2FibGUiLCAiY3Vyc29yIiwgewoJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgdWksIGluc3RhbmNlICkgewoJCXZhciB0ID0gJCggImJvZHkiICksCgkJCW8gPSBpbnN0YW5jZS5vcHRpb25zOwoKCQlpZiAoIHQuY3NzKCAiY3Vyc29yIiApICkgewoJCQlvLl9jdXJzb3IgPSB0LmNzcyggImN1cnNvciIgKTsKCQl9CgkJdC5jc3MoICJjdXJzb3IiLCBvLmN1cnNvciApOwoJfSwKCXN0b3A6IGZ1bmN0aW9uKCBldmVudCwgdWksIGluc3RhbmNlICkgewoJCXZhciBvID0gaW5zdGFuY2Uub3B0aW9uczsKCQlpZiAoIG8uX2N1cnNvciApIHsKCQkJJCggImJvZHkiICkuY3NzKCAiY3Vyc29yIiwgby5fY3Vyc29yICk7CgkJfQoJfQp9ICk7CgokLnVpLnBsdWdpbi5hZGQoICJkcmFnZ2FibGUiLCAib3BhY2l0eSIsIHsKCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpbnN0YW5jZSApIHsKCQl2YXIgdCA9ICQoIHVpLmhlbHBlciApLAoJCQlvID0gaW5zdGFuY2Uub3B0aW9uczsKCQlpZiAoIHQuY3NzKCAib3BhY2l0eSIgKSApIHsKCQkJby5fb3BhY2l0eSA9IHQuY3NzKCAib3BhY2l0eSIgKTsKCQl9CgkJdC5jc3MoICJvcGFjaXR5Iiwgby5vcGFjaXR5ICk7Cgl9LAoJc3RvcDogZnVuY3Rpb24oIGV2ZW50LCB1aSwgaW5zdGFuY2UgKSB7CgkJdmFyIG8gPSBpbnN0YW5jZS5vcHRpb25zOwoJCWlmICggby5fb3BhY2l0eSApIHsKCQkJJCggdWkuaGVscGVyICkuY3NzKCAib3BhY2l0eSIsIG8uX29wYWNpdHkgKTsKCQl9Cgl9Cn0gKTsKCiQudWkucGx1Z2luLmFkZCggImRyYWdnYWJsZSIsICJzY3JvbGwiLCB7CglzdGFydDogZnVuY3Rpb24oIGV2ZW50LCB1aSwgaSApIHsKCQlpZiAoICFpLnNjcm9sbFBhcmVudE5vdEhpZGRlbiApIHsKCQkJaS5zY3JvbGxQYXJlbnROb3RIaWRkZW4gPSBpLmhlbHBlci5zY3JvbGxQYXJlbnQoIGZhbHNlICk7CgkJfQoKCQlpZiAoIGkuc2Nyb2xsUGFyZW50Tm90SGlkZGVuWyAwIF0gIT09IGkuZG9jdW1lbnRbIDAgXSAmJgoJCQkJaS5zY3JvbGxQYXJlbnROb3RIaWRkZW5bIDAgXS50YWdOYW1lICE9PSAiSFRNTCIgKSB7CgkJCWkub3ZlcmZsb3dPZmZzZXQgPSBpLnNjcm9sbFBhcmVudE5vdEhpZGRlbi5vZmZzZXQoKTsKCQl9Cgl9LAoJZHJhZzogZnVuY3Rpb24oIGV2ZW50LCB1aSwgaSAgKSB7CgoJCXZhciBvID0gaS5vcHRpb25zLAoJCQlzY3JvbGxlZCA9IGZhbHNlLAoJCQlzY3JvbGxQYXJlbnQgPSBpLnNjcm9sbFBhcmVudE5vdEhpZGRlblsgMCBdLAoJCQlkb2N1bWVudCA9IGkuZG9jdW1lbnRbIDAgXTsKCgkJaWYgKCBzY3JvbGxQYXJlbnQgIT09IGRvY3VtZW50ICYmIHNjcm9sbFBhcmVudC50YWdOYW1lICE9PSAiSFRNTCIgKSB7CgkJCWlmICggIW8uYXhpcyB8fCBvLmF4aXMgIT09ICJ4IiApIHsKCQkJCWlmICggKCBpLm92ZXJmbG93T2Zmc2V0LnRvcCArIHNjcm9sbFBhcmVudC5vZmZzZXRIZWlnaHQgKSAtIGV2ZW50LnBhZ2VZIDwKCQkJCQkJby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQlzY3JvbGxQYXJlbnQuc2Nyb2xsVG9wID0gc2Nyb2xsZWQgPSBzY3JvbGxQYXJlbnQuc2Nyb2xsVG9wICsgby5zY3JvbGxTcGVlZDsKCQkJCX0gZWxzZSBpZiAoIGV2ZW50LnBhZ2VZIC0gaS5vdmVyZmxvd09mZnNldC50b3AgPCBvLnNjcm9sbFNlbnNpdGl2aXR5ICkgewoJCQkJCXNjcm9sbFBhcmVudC5zY3JvbGxUb3AgPSBzY3JvbGxlZCA9IHNjcm9sbFBhcmVudC5zY3JvbGxUb3AgLSBvLnNjcm9sbFNwZWVkOwoJCQkJfQoJCQl9CgoJCQlpZiAoICFvLmF4aXMgfHwgby5heGlzICE9PSAieSIgKSB7CgkJCQlpZiAoICggaS5vdmVyZmxvd09mZnNldC5sZWZ0ICsgc2Nyb2xsUGFyZW50Lm9mZnNldFdpZHRoICkgLSBldmVudC5wYWdlWCA8CgkJCQkJCW8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7CgkJCQkJc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQgPSBzY3JvbGxlZCA9IHNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0ICsgby5zY3JvbGxTcGVlZDsKCQkJCX0gZWxzZSBpZiAoIGV2ZW50LnBhZ2VYIC0gaS5vdmVyZmxvd09mZnNldC5sZWZ0IDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQlzY3JvbGxQYXJlbnQuc2Nyb2xsTGVmdCA9IHNjcm9sbGVkID0gc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQgLSBvLnNjcm9sbFNwZWVkOwoJCQkJfQoJCQl9CgoJCX0gZWxzZSB7CgoJCQlpZiAoICFvLmF4aXMgfHwgby5heGlzICE9PSAieCIgKSB7CgkJCQlpZiAoIGV2ZW50LnBhZ2VZIC0gJCggZG9jdW1lbnQgKS5zY3JvbGxUb3AoKSA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7CgkJCQkJc2Nyb2xsZWQgPSAkKCBkb2N1bWVudCApLnNjcm9sbFRvcCggJCggZG9jdW1lbnQgKS5zY3JvbGxUb3AoKSAtIG8uc2Nyb2xsU3BlZWQgKTsKCQkJCX0gZWxzZSBpZiAoICQoIHdpbmRvdyApLmhlaWdodCgpIC0gKCBldmVudC5wYWdlWSAtICQoIGRvY3VtZW50ICkuc2Nyb2xsVG9wKCkgKSA8CgkJCQkJCW8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7CgkJCQkJc2Nyb2xsZWQgPSAkKCBkb2N1bWVudCApLnNjcm9sbFRvcCggJCggZG9jdW1lbnQgKS5zY3JvbGxUb3AoKSArIG8uc2Nyb2xsU3BlZWQgKTsKCQkJCX0KCQkJfQoKCQkJaWYgKCAhby5heGlzIHx8IG8uYXhpcyAhPT0gInkiICkgewoJCQkJaWYgKCBldmVudC5wYWdlWCAtICQoIGRvY3VtZW50ICkuc2Nyb2xsTGVmdCgpIDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQlzY3JvbGxlZCA9ICQoIGRvY3VtZW50ICkuc2Nyb2xsTGVmdCgKCQkJCQkJJCggZG9jdW1lbnQgKS5zY3JvbGxMZWZ0KCkgLSBvLnNjcm9sbFNwZWVkCgkJCQkJKTsKCQkJCX0gZWxzZSBpZiAoICQoIHdpbmRvdyApLndpZHRoKCkgLSAoIGV2ZW50LnBhZ2VYIC0gJCggZG9jdW1lbnQgKS5zY3JvbGxMZWZ0KCkgKSA8CgkJCQkJCW8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7CgkJCQkJc2Nyb2xsZWQgPSAkKCBkb2N1bWVudCApLnNjcm9sbExlZnQoCgkJCQkJCSQoIGRvY3VtZW50ICkuc2Nyb2xsTGVmdCgpICsgby5zY3JvbGxTcGVlZAoJCQkJCSk7CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAoIHNjcm9sbGVkICE9PSBmYWxzZSAmJiAkLnVpLmRkbWFuYWdlciAmJiAhby5kcm9wQmVoYXZpb3VyICkgewoJCQkkLnVpLmRkbWFuYWdlci5wcmVwYXJlT2Zmc2V0cyggaSwgZXZlbnQgKTsKCQl9CgoJfQp9ICk7CgokLnVpLnBsdWdpbi5hZGQoICJkcmFnZ2FibGUiLCAic25hcCIsIHsKCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpICkgewoKCQl2YXIgbyA9IGkub3B0aW9uczsKCgkJaS5zbmFwRWxlbWVudHMgPSBbXTsKCgkJJCggby5zbmFwLmNvbnN0cnVjdG9yICE9PSBTdHJpbmcgPyAoIG8uc25hcC5pdGVtcyB8fCAiOmRhdGEodWktZHJhZ2dhYmxlKSIgKSA6IG8uc25hcCApCgkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciAkdCA9ICQoIHRoaXMgKSwKCQkJCQkkbyA9ICR0Lm9mZnNldCgpOwoJCQkJaWYgKCB0aGlzICE9PSBpLmVsZW1lbnRbIDAgXSApIHsKCQkJCQlpLnNuYXBFbGVtZW50cy5wdXNoKCB7CgkJCQkJCWl0ZW06IHRoaXMsCgkJCQkJCXdpZHRoOiAkdC5vdXRlcldpZHRoKCksIGhlaWdodDogJHQub3V0ZXJIZWlnaHQoKSwKCQkJCQkJdG9wOiAkby50b3AsIGxlZnQ6ICRvLmxlZnQKCQkJCQl9ICk7CgkJCQl9CgkJCX0gKTsKCgl9LAoJZHJhZzogZnVuY3Rpb24oIGV2ZW50LCB1aSwgaW5zdCApIHsKCgkJdmFyIHRzLCBicywgbHMsIHJzLCBsLCByLCB0LCBiLCBpLCBmaXJzdCwKCQkJbyA9IGluc3Qub3B0aW9ucywKCQkJZCA9IG8uc25hcFRvbGVyYW5jZSwKCQkJeDEgPSB1aS5vZmZzZXQubGVmdCwgeDIgPSB4MSArIGluc3QuaGVscGVyUHJvcG9ydGlvbnMud2lkdGgsCgkJCXkxID0gdWkub2Zmc2V0LnRvcCwgeTIgPSB5MSArIGluc3QuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0OwoKCQlmb3IgKCBpID0gaW5zdC5zbmFwRWxlbWVudHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgoJCQlsID0gaW5zdC5zbmFwRWxlbWVudHNbIGkgXS5sZWZ0IC0gaW5zdC5tYXJnaW5zLmxlZnQ7CgkJCXIgPSBsICsgaW5zdC5zbmFwRWxlbWVudHNbIGkgXS53aWR0aDsKCQkJdCA9IGluc3Quc25hcEVsZW1lbnRzWyBpIF0udG9wIC0gaW5zdC5tYXJnaW5zLnRvcDsKCQkJYiA9IHQgKyBpbnN0LnNuYXBFbGVtZW50c1sgaSBdLmhlaWdodDsKCgkJCWlmICggeDIgPCBsIC0gZCB8fCB4MSA+IHIgKyBkIHx8IHkyIDwgdCAtIGQgfHwgeTEgPiBiICsgZCB8fAoJCQkJCSEkLmNvbnRhaW5zKCBpbnN0LnNuYXBFbGVtZW50c1sgaSBdLml0ZW0ub3duZXJEb2N1bWVudCwKCQkJCQlpbnN0LnNuYXBFbGVtZW50c1sgaSBdLml0ZW0gKSApIHsKCQkJCWlmICggaW5zdC5zbmFwRWxlbWVudHNbIGkgXS5zbmFwcGluZyApIHsKCQkJCQkoIGluc3Qub3B0aW9ucy5zbmFwLnJlbGVhc2UgJiYKCQkJCQkJaW5zdC5vcHRpb25zLnNuYXAucmVsZWFzZS5jYWxsKAoJCQkJCQkJaW5zdC5lbGVtZW50LAoJCQkJCQkJZXZlbnQsCgkJCQkJCQkkLmV4dGVuZCggaW5zdC5fdWlIYXNoKCksIHsgc25hcEl0ZW06IGluc3Quc25hcEVsZW1lbnRzWyBpIF0uaXRlbSB9ICkKCQkJCQkJKSApOwoJCQkJfQoJCQkJaW5zdC5zbmFwRWxlbWVudHNbIGkgXS5zbmFwcGluZyA9IGZhbHNlOwoJCQkJY29udGludWU7CgkJCX0KCgkJCWlmICggby5zbmFwTW9kZSAhPT0gImlubmVyIiApIHsKCQkJCXRzID0gTWF0aC5hYnMoIHQgLSB5MiApIDw9IGQ7CgkJCQlicyA9IE1hdGguYWJzKCBiIC0geTEgKSA8PSBkOwoJCQkJbHMgPSBNYXRoLmFicyggbCAtIHgyICkgPD0gZDsKCQkJCXJzID0gTWF0aC5hYnMoIHIgLSB4MSApIDw9IGQ7CgkJCQlpZiAoIHRzICkgewoJCQkJCXVpLnBvc2l0aW9uLnRvcCA9IGluc3QuX2NvbnZlcnRQb3NpdGlvblRvKCAicmVsYXRpdmUiLCB7CgkJCQkJCXRvcDogdCAtIGluc3QuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0LAoJCQkJCQlsZWZ0OiAwCgkJCQkJfSApLnRvcDsKCQkJCX0KCQkJCWlmICggYnMgKSB7CgkJCQkJdWkucG9zaXRpb24udG9wID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsKCQkJCQkJdG9wOiBiLAoJCQkJCQlsZWZ0OiAwCgkJCQkJfSApLnRvcDsKCQkJCX0KCQkJCWlmICggbHMgKSB7CgkJCQkJdWkucG9zaXRpb24ubGVmdCA9IGluc3QuX2NvbnZlcnRQb3NpdGlvblRvKCAicmVsYXRpdmUiLCB7CgkJCQkJCXRvcDogMCwKCQkJCQkJbGVmdDogbCAtIGluc3QuaGVscGVyUHJvcG9ydGlvbnMud2lkdGgKCQkJCQl9ICkubGVmdDsKCQkJCX0KCQkJCWlmICggcnMgKSB7CgkJCQkJdWkucG9zaXRpb24ubGVmdCA9IGluc3QuX2NvbnZlcnRQb3NpdGlvblRvKCAicmVsYXRpdmUiLCB7CgkJCQkJCXRvcDogMCwKCQkJCQkJbGVmdDogcgoJCQkJCX0gKS5sZWZ0OwoJCQkJfQoJCQl9CgoJCQlmaXJzdCA9ICggdHMgfHwgYnMgfHwgbHMgfHwgcnMgKTsKCgkJCWlmICggby5zbmFwTW9kZSAhPT0gIm91dGVyIiApIHsKCQkJCXRzID0gTWF0aC5hYnMoIHQgLSB5MSApIDw9IGQ7CgkJCQlicyA9IE1hdGguYWJzKCBiIC0geTIgKSA8PSBkOwoJCQkJbHMgPSBNYXRoLmFicyggbCAtIHgxICkgPD0gZDsKCQkJCXJzID0gTWF0aC5hYnMoIHIgLSB4MiApIDw9IGQ7CgkJCQlpZiAoIHRzICkgewoJCQkJCXVpLnBvc2l0aW9uLnRvcCA9IGluc3QuX2NvbnZlcnRQb3NpdGlvblRvKCAicmVsYXRpdmUiLCB7CgkJCQkJCXRvcDogdCwKCQkJCQkJbGVmdDogMAoJCQkJCX0gKS50b3A7CgkJCQl9CgkJCQlpZiAoIGJzICkgewoJCQkJCXVpLnBvc2l0aW9uLnRvcCA9IGluc3QuX2NvbnZlcnRQb3NpdGlvblRvKCAicmVsYXRpdmUiLCB7CgkJCQkJCXRvcDogYiAtIGluc3QuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0LAoJCQkJCQlsZWZ0OiAwCgkJCQkJfSApLnRvcDsKCQkJCX0KCQkJCWlmICggbHMgKSB7CgkJCQkJdWkucG9zaXRpb24ubGVmdCA9IGluc3QuX2NvbnZlcnRQb3NpdGlvblRvKCAicmVsYXRpdmUiLCB7CgkJCQkJCXRvcDogMCwKCQkJCQkJbGVmdDogbAoJCQkJCX0gKS5sZWZ0OwoJCQkJfQoJCQkJaWYgKCBycyApIHsKCQkJCQl1aS5wb3NpdGlvbi5sZWZ0ID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsKCQkJCQkJdG9wOiAwLAoJCQkJCQlsZWZ0OiByIC0gaW5zdC5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aAoJCQkJCX0gKS5sZWZ0OwoJCQkJfQoJCQl9CgoJCQlpZiAoICFpbnN0LnNuYXBFbGVtZW50c1sgaSBdLnNuYXBwaW5nICYmICggdHMgfHwgYnMgfHwgbHMgfHwgcnMgfHwgZmlyc3QgKSApIHsKCQkJCSggaW5zdC5vcHRpb25zLnNuYXAuc25hcCAmJgoJCQkJCWluc3Qub3B0aW9ucy5zbmFwLnNuYXAuY2FsbCgKCQkJCQkJaW5zdC5lbGVtZW50LAoJCQkJCQlldmVudCwKCQkJCQkJJC5leHRlbmQoIGluc3QuX3VpSGFzaCgpLCB7CgkJCQkJCQlzbmFwSXRlbTogaW5zdC5zbmFwRWxlbWVudHNbIGkgXS5pdGVtCgkJCQkJCX0gKSApICk7CgkJCX0KCQkJaW5zdC5zbmFwRWxlbWVudHNbIGkgXS5zbmFwcGluZyA9ICggdHMgfHwgYnMgfHwgbHMgfHwgcnMgfHwgZmlyc3QgKTsKCgkJfQoKCX0KfSApOwoKJC51aS5wbHVnaW4uYWRkKCAiZHJhZ2dhYmxlIiwgInN0YWNrIiwgewoJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgdWksIGluc3RhbmNlICkgewoJCXZhciBtaW4sCgkJCW8gPSBpbnN0YW5jZS5vcHRpb25zLAoJCQlncm91cCA9ICQubWFrZUFycmF5KCAkKCBvLnN0YWNrICkgKS5zb3J0KCBmdW5jdGlvbiggYSwgYiApIHsKCQkJCXJldHVybiAoIHBhcnNlSW50KCAkKCBhICkuY3NzKCAiekluZGV4IiApLCAxMCApIHx8IDAgKSAtCgkJCQkJKCBwYXJzZUludCggJCggYiApLmNzcyggInpJbmRleCIgKSwgMTAgKSB8fCAwICk7CgkJCX0gKTsKCgkJaWYgKCAhZ3JvdXAubGVuZ3RoICkgeyByZXR1cm47IH0KCgkJbWluID0gcGFyc2VJbnQoICQoIGdyb3VwWyAwIF0gKS5jc3MoICJ6SW5kZXgiICksIDEwICkgfHwgMDsKCQkkKCBncm91cCApLmVhY2goIGZ1bmN0aW9uKCBpICkgewoJCQkkKCB0aGlzICkuY3NzKCAiekluZGV4IiwgbWluICsgaSApOwoJCX0gKTsKCQl0aGlzLmNzcyggInpJbmRleCIsICggbWluICsgZ3JvdXAubGVuZ3RoICkgKTsKCX0KfSApOwoKJC51aS5wbHVnaW4uYWRkKCAiZHJhZ2dhYmxlIiwgInpJbmRleCIsIHsKCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpbnN0YW5jZSApIHsKCQl2YXIgdCA9ICQoIHVpLmhlbHBlciApLAoJCQlvID0gaW5zdGFuY2Uub3B0aW9uczsKCgkJaWYgKCB0LmNzcyggInpJbmRleCIgKSApIHsKCQkJby5fekluZGV4ID0gdC5jc3MoICJ6SW5kZXgiICk7CgkJfQoJCXQuY3NzKCAiekluZGV4Iiwgby56SW5kZXggKTsKCX0sCglzdG9wOiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpbnN0YW5jZSApIHsKCQl2YXIgbyA9IGluc3RhbmNlLm9wdGlvbnM7CgoJCWlmICggby5fekluZGV4ICkgewoJCQkkKCB1aS5oZWxwZXIgKS5jc3MoICJ6SW5kZXgiLCBvLl96SW5kZXggKTsKCQl9Cgl9Cn0gKTsKCnZhciB3aWRnZXRzRHJhZ2dhYmxlID0gJC51aS5kcmFnZ2FibGU7CgoKLyohCiAqIGpRdWVyeSBVSSBEcm9wcGFibGUgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBEcm9wcGFibGUKLy8+Pmdyb3VwOiBJbnRlcmFjdGlvbnMKLy8+PmRlc2NyaXB0aW9uOiBFbmFibGVzIGRyb3AgdGFyZ2V0cyBmb3IgZHJhZ2dhYmxlIGVsZW1lbnRzLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZHJvcHBhYmxlLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZHJvcHBhYmxlLwoKCgokLndpZGdldCggInVpLmRyb3BwYWJsZSIsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJkcm9wIiwKCW9wdGlvbnM6IHsKCQlhY2NlcHQ6ICIqIiwKCQlhZGRDbGFzc2VzOiB0cnVlLAoJCWdyZWVkeTogZmFsc2UsCgkJc2NvcGU6ICJkZWZhdWx0IiwKCQl0b2xlcmFuY2U6ICJpbnRlcnNlY3QiLAoKCQkvLyBDYWxsYmFja3MKCQlhY3RpdmF0ZTogbnVsbCwKCQlkZWFjdGl2YXRlOiBudWxsLAoJCWRyb3A6IG51bGwsCgkJb3V0OiBudWxsLAoJCW92ZXI6IG51bGwKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIHByb3BvcnRpb25zLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlhY2NlcHQgPSBvLmFjY2VwdDsKCgkJdGhpcy5pc292ZXIgPSBmYWxzZTsKCQl0aGlzLmlzb3V0ID0gdHJ1ZTsKCgkJdGhpcy5hY2NlcHQgPSAkLmlzRnVuY3Rpb24oIGFjY2VwdCApID8gYWNjZXB0IDogZnVuY3Rpb24oIGQgKSB7CgkJCXJldHVybiBkLmlzKCBhY2NlcHQgKTsKCQl9OwoKCQl0aGlzLnByb3BvcnRpb25zID0gZnVuY3Rpb24oIC8qIHZhbHVlVG9Xcml0ZSAqLyApIHsKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoKCQkJCS8vIFN0b3JlIHRoZSBkcm9wcGFibGUncyBwcm9wb3J0aW9ucwoJCQkJcHJvcG9ydGlvbnMgPSBhcmd1bWVudHNbIDAgXTsKCQkJfSBlbHNlIHsKCgkJCQkvLyBSZXRyaWV2ZSBvciBkZXJpdmUgdGhlIGRyb3BwYWJsZSdzIHByb3BvcnRpb25zCgkJCQlyZXR1cm4gcHJvcG9ydGlvbnMgPwoJCQkJCXByb3BvcnRpb25zIDoKCQkJCQlwcm9wb3J0aW9ucyA9IHsKCQkJCQkJd2lkdGg6IHRoaXMuZWxlbWVudFsgMCBdLm9mZnNldFdpZHRoLAoJCQkJCQloZWlnaHQ6IHRoaXMuZWxlbWVudFsgMCBdLm9mZnNldEhlaWdodAoJCQkJCX07CgkJCX0KCQl9OwoKCQl0aGlzLl9hZGRUb01hbmFnZXIoIG8uc2NvcGUgKTsKCgkJby5hZGRDbGFzc2VzICYmIHRoaXMuX2FkZENsYXNzKCAidWktZHJvcHBhYmxlIiApOwoKCX0sCgoJX2FkZFRvTWFuYWdlcjogZnVuY3Rpb24oIHNjb3BlICkgewoKCQkvLyBBZGQgdGhlIHJlZmVyZW5jZSBhbmQgcG9zaXRpb25zIHRvIHRoZSBtYW5hZ2VyCgkJJC51aS5kZG1hbmFnZXIuZHJvcHBhYmxlc1sgc2NvcGUgXSA9ICQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbIHNjb3BlIF0gfHwgW107CgkJJC51aS5kZG1hbmFnZXIuZHJvcHBhYmxlc1sgc2NvcGUgXS5wdXNoKCB0aGlzICk7Cgl9LAoKCV9zcGxpY2U6IGZ1bmN0aW9uKCBkcm9wICkgewoJCXZhciBpID0gMDsKCQlmb3IgKCA7IGkgPCBkcm9wLmxlbmd0aDsgaSsrICkgewoJCQlpZiAoIGRyb3BbIGkgXSA9PT0gdGhpcyApIHsKCQkJCWRyb3Auc3BsaWNlKCBpLCAxICk7CgkJCX0KCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgZHJvcCA9ICQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbIHRoaXMub3B0aW9ucy5zY29wZSBdOwoKCQl0aGlzLl9zcGxpY2UoIGRyb3AgKTsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgoJCWlmICgga2V5ID09PSAiYWNjZXB0IiApIHsKCQkJdGhpcy5hY2NlcHQgPSAkLmlzRnVuY3Rpb24oIHZhbHVlICkgPyB2YWx1ZSA6IGZ1bmN0aW9uKCBkICkgewoJCQkJcmV0dXJuIGQuaXMoIHZhbHVlICk7CgkJCX07CgkJfSBlbHNlIGlmICgga2V5ID09PSAic2NvcGUiICkgewoJCQl2YXIgZHJvcCA9ICQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbIHRoaXMub3B0aW9ucy5zY29wZSBdOwoKCQkJdGhpcy5fc3BsaWNlKCBkcm9wICk7CgkJCXRoaXMuX2FkZFRvTWFuYWdlciggdmFsdWUgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7Cgl9LAoKCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBkcmFnZ2FibGUgPSAkLnVpLmRkbWFuYWdlci5jdXJyZW50OwoKCQl0aGlzLl9hZGRBY3RpdmVDbGFzcygpOwoJCWlmICggZHJhZ2dhYmxlICkgewoJCQl0aGlzLl90cmlnZ2VyKCAiYWN0aXZhdGUiLCBldmVudCwgdGhpcy51aSggZHJhZ2dhYmxlICkgKTsKCQl9Cgl9LAoKCV9kZWFjdGl2YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGRyYWdnYWJsZSA9ICQudWkuZGRtYW5hZ2VyLmN1cnJlbnQ7CgoJCXRoaXMuX3JlbW92ZUFjdGl2ZUNsYXNzKCk7CgkJaWYgKCBkcmFnZ2FibGUgKSB7CgkJCXRoaXMuX3RyaWdnZXIoICJkZWFjdGl2YXRlIiwgZXZlbnQsIHRoaXMudWkoIGRyYWdnYWJsZSApICk7CgkJfQoJfSwKCglfb3ZlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQl2YXIgZHJhZ2dhYmxlID0gJC51aS5kZG1hbmFnZXIuY3VycmVudDsKCgkJLy8gQmFpbCBpZiBkcmFnZ2FibGUgYW5kIGRyb3BwYWJsZSBhcmUgc2FtZSBlbGVtZW50CgkJaWYgKCAhZHJhZ2dhYmxlIHx8ICggZHJhZ2dhYmxlLmN1cnJlbnRJdGVtIHx8CgkJCQlkcmFnZ2FibGUuZWxlbWVudCApWyAwIF0gPT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRoaXMuYWNjZXB0LmNhbGwoIHRoaXMuZWxlbWVudFsgMCBdLCAoIGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fAoJCQkJZHJhZ2dhYmxlLmVsZW1lbnQgKSApICkgewoJCQl0aGlzLl9hZGRIb3ZlckNsYXNzKCk7CgkJCXRoaXMuX3RyaWdnZXIoICJvdmVyIiwgZXZlbnQsIHRoaXMudWkoIGRyYWdnYWJsZSApICk7CgkJfQoKCX0sCgoJX291dDogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQl2YXIgZHJhZ2dhYmxlID0gJC51aS5kZG1hbmFnZXIuY3VycmVudDsKCgkJLy8gQmFpbCBpZiBkcmFnZ2FibGUgYW5kIGRyb3BwYWJsZSBhcmUgc2FtZSBlbGVtZW50CgkJaWYgKCAhZHJhZ2dhYmxlIHx8ICggZHJhZ2dhYmxlLmN1cnJlbnRJdGVtIHx8CgkJCQlkcmFnZ2FibGUuZWxlbWVudCApWyAwIF0gPT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRoaXMuYWNjZXB0LmNhbGwoIHRoaXMuZWxlbWVudFsgMCBdLCAoIGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fAoJCQkJZHJhZ2dhYmxlLmVsZW1lbnQgKSApICkgewoJCQl0aGlzLl9yZW1vdmVIb3ZlckNsYXNzKCk7CgkJCXRoaXMuX3RyaWdnZXIoICJvdXQiLCBldmVudCwgdGhpcy51aSggZHJhZ2dhYmxlICkgKTsKCQl9CgoJfSwKCglfZHJvcDogZnVuY3Rpb24oIGV2ZW50LCBjdXN0b20gKSB7CgoJCXZhciBkcmFnZ2FibGUgPSBjdXN0b20gfHwgJC51aS5kZG1hbmFnZXIuY3VycmVudCwKCQkJY2hpbGRyZW5JbnRlcnNlY3Rpb24gPSBmYWxzZTsKCgkJLy8gQmFpbCBpZiBkcmFnZ2FibGUgYW5kIGRyb3BwYWJsZSBhcmUgc2FtZSBlbGVtZW50CgkJaWYgKCAhZHJhZ2dhYmxlIHx8ICggZHJhZ2dhYmxlLmN1cnJlbnRJdGVtIHx8CgkJCQlkcmFnZ2FibGUuZWxlbWVudCApWyAwIF0gPT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQl0aGlzLmVsZW1lbnQKCQkJLmZpbmQoICI6ZGF0YSh1aS1kcm9wcGFibGUpIiApCgkJCS5ub3QoICIudWktZHJhZ2dhYmxlLWRyYWdnaW5nIiApCgkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0ID0gJCggdGhpcyApLmRyb3BwYWJsZSggImluc3RhbmNlIiApOwoJCQkJaWYgKAoJCQkJCWluc3Qub3B0aW9ucy5ncmVlZHkgJiYKCQkJCQkhaW5zdC5vcHRpb25zLmRpc2FibGVkICYmCgkJCQkJaW5zdC5vcHRpb25zLnNjb3BlID09PSBkcmFnZ2FibGUub3B0aW9ucy5zY29wZSAmJgoJCQkJCWluc3QuYWNjZXB0LmNhbGwoCgkJCQkJCWluc3QuZWxlbWVudFsgMCBdLCAoIGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fCBkcmFnZ2FibGUuZWxlbWVudCApCgkJCQkJKSAmJgoJCQkJCWludGVyc2VjdCgKCQkJCQkJZHJhZ2dhYmxlLAoJCQkJCQkkLmV4dGVuZCggaW5zdCwgeyBvZmZzZXQ6IGluc3QuZWxlbWVudC5vZmZzZXQoKSB9ICksCgkJCQkJCWluc3Qub3B0aW9ucy50b2xlcmFuY2UsIGV2ZW50CgkJCQkJKQoJCQkJKSB7CgkJCQkJY2hpbGRyZW5JbnRlcnNlY3Rpb24gPSB0cnVlOwoJCQkJCXJldHVybiBmYWxzZTsgfQoJCQl9ICk7CgkJaWYgKCBjaGlsZHJlbkludGVyc2VjdGlvbiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCB0aGlzLmFjY2VwdC5jYWxsKCB0aGlzLmVsZW1lbnRbIDAgXSwKCQkJCSggZHJhZ2dhYmxlLmN1cnJlbnRJdGVtIHx8IGRyYWdnYWJsZS5lbGVtZW50ICkgKSApIHsKCQkJdGhpcy5fcmVtb3ZlQWN0aXZlQ2xhc3MoKTsKCQkJdGhpcy5fcmVtb3ZlSG92ZXJDbGFzcygpOwoKCQkJdGhpcy5fdHJpZ2dlciggImRyb3AiLCBldmVudCwgdGhpcy51aSggZHJhZ2dhYmxlICkgKTsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQl9CgoJCXJldHVybiBmYWxzZTsKCgl9LAoKCXVpOiBmdW5jdGlvbiggYyApIHsKCQlyZXR1cm4gewoJCQlkcmFnZ2FibGU6ICggYy5jdXJyZW50SXRlbSB8fCBjLmVsZW1lbnQgKSwKCQkJaGVscGVyOiBjLmhlbHBlciwKCQkJcG9zaXRpb246IGMucG9zaXRpb24sCgkJCW9mZnNldDogYy5wb3NpdGlvbkFicwoJCX07Cgl9LAoKCS8vIEV4dGVuc2lvbiBwb2ludHMganVzdCB0byBtYWtlIGJhY2tjb21wYXQgc2FuZSBhbmQgYXZvaWQgZHVwbGljYXRpbmcgbG9naWMKCS8vIFRPRE86IFJlbW92ZSBpbiAxLjEzIGFsb25nIHdpdGggY2FsbCB0byBpdCBiZWxvdwoJX2FkZEhvdmVyQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2FkZENsYXNzKCAidWktZHJvcHBhYmxlLWhvdmVyIiApOwoJfSwKCglfcmVtb3ZlSG92ZXJDbGFzczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVtb3ZlQ2xhc3MoICJ1aS1kcm9wcGFibGUtaG92ZXIiICk7Cgl9LAoKCV9hZGRBY3RpdmVDbGFzczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1kcm9wcGFibGUtYWN0aXZlIiApOwoJfSwKCglfcmVtb3ZlQWN0aXZlQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlbW92ZUNsYXNzKCAidWktZHJvcHBhYmxlLWFjdGl2ZSIgKTsKCX0KfSApOwoKdmFyIGludGVyc2VjdCA9ICQudWkuaW50ZXJzZWN0ID0gKCBmdW5jdGlvbigpIHsKCWZ1bmN0aW9uIGlzT3ZlckF4aXMoIHgsIHJlZmVyZW5jZSwgc2l6ZSApIHsKCQlyZXR1cm4gKCB4ID49IHJlZmVyZW5jZSApICYmICggeCA8ICggcmVmZXJlbmNlICsgc2l6ZSApICk7Cgl9CgoJcmV0dXJuIGZ1bmN0aW9uKCBkcmFnZ2FibGUsIGRyb3BwYWJsZSwgdG9sZXJhbmNlTW9kZSwgZXZlbnQgKSB7CgoJCWlmICggIWRyb3BwYWJsZS5vZmZzZXQgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXZhciB4MSA9ICggZHJhZ2dhYmxlLnBvc2l0aW9uQWJzIHx8CgkJCQlkcmFnZ2FibGUucG9zaXRpb24uYWJzb2x1dGUgKS5sZWZ0ICsgZHJhZ2dhYmxlLm1hcmdpbnMubGVmdCwKCQkJeTEgPSAoIGRyYWdnYWJsZS5wb3NpdGlvbkFicyB8fAoJCQkJZHJhZ2dhYmxlLnBvc2l0aW9uLmFic29sdXRlICkudG9wICsgZHJhZ2dhYmxlLm1hcmdpbnMudG9wLAoJCQl4MiA9IHgxICsgZHJhZ2dhYmxlLmhlbHBlclByb3BvcnRpb25zLndpZHRoLAoJCQl5MiA9IHkxICsgZHJhZ2dhYmxlLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCwKCQkJbCA9IGRyb3BwYWJsZS5vZmZzZXQubGVmdCwKCQkJdCA9IGRyb3BwYWJsZS5vZmZzZXQudG9wLAoJCQlyID0gbCArIGRyb3BwYWJsZS5wcm9wb3J0aW9ucygpLndpZHRoLAoJCQliID0gdCArIGRyb3BwYWJsZS5wcm9wb3J0aW9ucygpLmhlaWdodDsKCgkJc3dpdGNoICggdG9sZXJhbmNlTW9kZSApIHsKCQljYXNlICJmaXQiOgoJCQlyZXR1cm4gKCBsIDw9IHgxICYmIHgyIDw9IHIgJiYgdCA8PSB5MSAmJiB5MiA8PSBiICk7CgkJY2FzZSAiaW50ZXJzZWN0IjoKCQkJcmV0dXJuICggbCA8IHgxICsgKCBkcmFnZ2FibGUuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLyAyICkgJiYgLy8gUmlnaHQgSGFsZgoJCQkJeDIgLSAoIGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAvIDIgKSA8IHIgJiYgLy8gTGVmdCBIYWxmCgkJCQl0IDwgeTEgKyAoIGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLyAyICkgJiYgLy8gQm90dG9tIEhhbGYKCQkJCXkyIC0gKCBkcmFnZ2FibGUuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC8gMiApIDwgYiApOyAvLyBUb3AgSGFsZgoJCWNhc2UgInBvaW50ZXIiOgoJCQlyZXR1cm4gaXNPdmVyQXhpcyggZXZlbnQucGFnZVksIHQsIGRyb3BwYWJsZS5wcm9wb3J0aW9ucygpLmhlaWdodCApICYmCgkJCQlpc092ZXJBeGlzKCBldmVudC5wYWdlWCwgbCwgZHJvcHBhYmxlLnByb3BvcnRpb25zKCkud2lkdGggKTsKCQljYXNlICJ0b3VjaCI6CgkJCXJldHVybiAoCgkJCQkoIHkxID49IHQgJiYgeTEgPD0gYiApIHx8IC8vIFRvcCBlZGdlIHRvdWNoaW5nCgkJCQkoIHkyID49IHQgJiYgeTIgPD0gYiApIHx8IC8vIEJvdHRvbSBlZGdlIHRvdWNoaW5nCgkJCQkoIHkxIDwgdCAmJiB5MiA+IGIgKSAvLyBTdXJyb3VuZGVkIHZlcnRpY2FsbHkKCQkJKSAmJiAoCgkJCQkoIHgxID49IGwgJiYgeDEgPD0gciApIHx8IC8vIExlZnQgZWRnZSB0b3VjaGluZwoJCQkJKCB4MiA+PSBsICYmIHgyIDw9IHIgKSB8fCAvLyBSaWdodCBlZGdlIHRvdWNoaW5nCgkJCQkoIHgxIDwgbCAmJiB4MiA+IHIgKSAvLyBTdXJyb3VuZGVkIGhvcml6b250YWxseQoJCQkpOwoJCWRlZmF1bHQ6CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9Owp9ICkoKTsKCi8qCglUaGlzIG1hbmFnZXIgdHJhY2tzIG9mZnNldHMgb2YgZHJhZ2dhYmxlcyBhbmQgZHJvcHBhYmxlcwoqLwokLnVpLmRkbWFuYWdlciA9IHsKCWN1cnJlbnQ6IG51bGwsCglkcm9wcGFibGVzOiB7ICJkZWZhdWx0IjogW10gfSwKCXByZXBhcmVPZmZzZXRzOiBmdW5jdGlvbiggdCwgZXZlbnQgKSB7CgoJCXZhciBpLCBqLAoJCQltID0gJC51aS5kZG1hbmFnZXIuZHJvcHBhYmxlc1sgdC5vcHRpb25zLnNjb3BlIF0gfHwgW10sCgkJCXR5cGUgPSBldmVudCA/IGV2ZW50LnR5cGUgOiBudWxsLCAvLyB3b3JrYXJvdW5kIGZvciAjMjMxNwoJCQlsaXN0ID0gKCB0LmN1cnJlbnRJdGVtIHx8IHQuZWxlbWVudCApLmZpbmQoICI6ZGF0YSh1aS1kcm9wcGFibGUpIiApLmFkZEJhY2soKTsKCgkJZHJvcHBhYmxlc0xvb3A6IGZvciAoIGkgPSAwOyBpIDwgbS5sZW5ndGg7IGkrKyApIHsKCgkJCS8vIE5vIGRpc2FibGVkIGFuZCBub24tYWNjZXB0ZWQKCQkJaWYgKCBtWyBpIF0ub3B0aW9ucy5kaXNhYmxlZCB8fCAoIHQgJiYgIW1bIGkgXS5hY2NlcHQuY2FsbCggbVsgaSBdLmVsZW1lbnRbIDAgXSwKCQkJCQkoIHQuY3VycmVudEl0ZW0gfHwgdC5lbGVtZW50ICkgKSApICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCS8vIEZpbHRlciBvdXQgZWxlbWVudHMgaW4gdGhlIGN1cnJlbnQgZHJhZ2dlZCBpdGVtCgkJCWZvciAoIGogPSAwOyBqIDwgbGlzdC5sZW5ndGg7IGorKyApIHsKCQkJCWlmICggbGlzdFsgaiBdID09PSBtWyBpIF0uZWxlbWVudFsgMCBdICkgewoJCQkJCW1bIGkgXS5wcm9wb3J0aW9ucygpLmhlaWdodCA9IDA7CgkJCQkJY29udGludWUgZHJvcHBhYmxlc0xvb3A7CgkJCQl9CgkJCX0KCgkJCW1bIGkgXS52aXNpYmxlID0gbVsgaSBdLmVsZW1lbnQuY3NzKCAiZGlzcGxheSIgKSAhPT0gIm5vbmUiOwoJCQlpZiAoICFtWyBpIF0udmlzaWJsZSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQkvLyBBY3RpdmF0ZSB0aGUgZHJvcHBhYmxlIGlmIHVzZWQgZGlyZWN0bHkgZnJvbSBkcmFnZ2FibGVzCgkJCWlmICggdHlwZSA9PT0gIm1vdXNlZG93biIgKSB7CgkJCQltWyBpIF0uX2FjdGl2YXRlLmNhbGwoIG1bIGkgXSwgZXZlbnQgKTsKCQkJfQoKCQkJbVsgaSBdLm9mZnNldCA9IG1bIGkgXS5lbGVtZW50Lm9mZnNldCgpOwoJCQltWyBpIF0ucHJvcG9ydGlvbnMoIHsKCQkJCXdpZHRoOiBtWyBpIF0uZWxlbWVudFsgMCBdLm9mZnNldFdpZHRoLAoJCQkJaGVpZ2h0OiBtWyBpIF0uZWxlbWVudFsgMCBdLm9mZnNldEhlaWdodAoJCQl9ICk7CgoJCX0KCgl9LAoJZHJvcDogZnVuY3Rpb24oIGRyYWdnYWJsZSwgZXZlbnQgKSB7CgoJCXZhciBkcm9wcGVkID0gZmFsc2U7CgoJCS8vIENyZWF0ZSBhIGNvcHkgb2YgdGhlIGRyb3BwYWJsZXMgaW4gY2FzZSB0aGUgbGlzdCBjaGFuZ2VzIGR1cmluZyB0aGUgZHJvcCAoIzkxMTYpCgkJJC5lYWNoKCAoICQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbIGRyYWdnYWJsZS5vcHRpb25zLnNjb3BlIF0gfHwgW10gKS5zbGljZSgpLCBmdW5jdGlvbigpIHsKCgkJCWlmICggIXRoaXMub3B0aW9ucyApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZGlzYWJsZWQgJiYgdGhpcy52aXNpYmxlICYmCgkJCQkJaW50ZXJzZWN0KCBkcmFnZ2FibGUsIHRoaXMsIHRoaXMub3B0aW9ucy50b2xlcmFuY2UsIGV2ZW50ICkgKSB7CgkJCQlkcm9wcGVkID0gdGhpcy5fZHJvcC5jYWxsKCB0aGlzLCBldmVudCApIHx8IGRyb3BwZWQ7CgkJCX0KCgkJCWlmICggIXRoaXMub3B0aW9ucy5kaXNhYmxlZCAmJiB0aGlzLnZpc2libGUgJiYgdGhpcy5hY2NlcHQuY2FsbCggdGhpcy5lbGVtZW50WyAwIF0sCgkJCQkJKCBkcmFnZ2FibGUuY3VycmVudEl0ZW0gfHwgZHJhZ2dhYmxlLmVsZW1lbnQgKSApICkgewoJCQkJdGhpcy5pc291dCA9IHRydWU7CgkJCQl0aGlzLmlzb3ZlciA9IGZhbHNlOwoJCQkJdGhpcy5fZGVhY3RpdmF0ZS5jYWxsKCB0aGlzLCBldmVudCApOwoJCQl9CgoJCX0gKTsKCQlyZXR1cm4gZHJvcHBlZDsKCgl9LAoJZHJhZ1N0YXJ0OiBmdW5jdGlvbiggZHJhZ2dhYmxlLCBldmVudCApIHsKCgkJLy8gTGlzdGVuIGZvciBzY3JvbGxpbmcgc28gdGhhdCBpZiB0aGUgZHJhZ2dpbmcgY2F1c2VzIHNjcm9sbGluZyB0aGUgcG9zaXRpb24gb2YgdGhlCgkJLy8gZHJvcHBhYmxlcyBjYW4gYmUgcmVjYWxjdWxhdGVkIChzZWUgIzUwMDMpCgkJZHJhZ2dhYmxlLmVsZW1lbnQucGFyZW50c1VudGlsKCAiYm9keSIgKS5vbiggInNjcm9sbC5kcm9wcGFibGUiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCAhZHJhZ2dhYmxlLm9wdGlvbnMucmVmcmVzaFBvc2l0aW9ucyApIHsKCQkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCBkcmFnZ2FibGUsIGV2ZW50ICk7CgkJCX0KCQl9ICk7Cgl9LAoJZHJhZzogZnVuY3Rpb24oIGRyYWdnYWJsZSwgZXZlbnQgKSB7CgoJCS8vIElmIHlvdSBoYXZlIGEgaGlnaGx5IGR5bmFtaWMgcGFnZSwgeW91IG1pZ2h0IHRyeSB0aGlzIG9wdGlvbi4gSXQgcmVuZGVycyBwb3NpdGlvbnMKCQkvLyBldmVyeSB0aW1lIHlvdSBtb3ZlIHRoZSBtb3VzZS4KCQlpZiAoIGRyYWdnYWJsZS5vcHRpb25zLnJlZnJlc2hQb3NpdGlvbnMgKSB7CgkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCBkcmFnZ2FibGUsIGV2ZW50ICk7CgkJfQoKCQkvLyBSdW4gdGhyb3VnaCBhbGwgZHJvcHBhYmxlcyBhbmQgY2hlY2sgdGhlaXIgcG9zaXRpb25zIGJhc2VkIG9uIHNwZWNpZmljIHRvbGVyYW5jZSBvcHRpb25zCgkJJC5lYWNoKCAkLnVpLmRkbWFuYWdlci5kcm9wcGFibGVzWyBkcmFnZ2FibGUub3B0aW9ucy5zY29wZSBdIHx8IFtdLCBmdW5jdGlvbigpIHsKCgkJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZ3JlZWR5Q2hpbGQgfHwgIXRoaXMudmlzaWJsZSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIHBhcmVudEluc3RhbmNlLCBzY29wZSwgcGFyZW50LAoJCQkJaW50ZXJzZWN0cyA9IGludGVyc2VjdCggZHJhZ2dhYmxlLCB0aGlzLCB0aGlzLm9wdGlvbnMudG9sZXJhbmNlLCBldmVudCApLAoJCQkJYyA9ICFpbnRlcnNlY3RzICYmIHRoaXMuaXNvdmVyID8KCQkJCQkiaXNvdXQiIDoKCQkJCQkoIGludGVyc2VjdHMgJiYgIXRoaXMuaXNvdmVyID8gImlzb3ZlciIgOiBudWxsICk7CgkJCWlmICggIWMgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGhpcy5vcHRpb25zLmdyZWVkeSApIHsKCgkJCQkvLyBmaW5kIGRyb3BwYWJsZSBwYXJlbnRzIHdpdGggc2FtZSBzY29wZQoJCQkJc2NvcGUgPSB0aGlzLm9wdGlvbnMuc2NvcGU7CgkJCQlwYXJlbnQgPSB0aGlzLmVsZW1lbnQucGFyZW50cyggIjpkYXRhKHVpLWRyb3BwYWJsZSkiICkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLmRyb3BwYWJsZSggImluc3RhbmNlIiApLm9wdGlvbnMuc2NvcGUgPT09IHNjb3BlOwoJCQkJfSApOwoKCQkJCWlmICggcGFyZW50Lmxlbmd0aCApIHsKCQkJCQlwYXJlbnRJbnN0YW5jZSA9ICQoIHBhcmVudFsgMCBdICkuZHJvcHBhYmxlKCAiaW5zdGFuY2UiICk7CgkJCQkJcGFyZW50SW5zdGFuY2UuZ3JlZWR5Q2hpbGQgPSAoIGMgPT09ICJpc292ZXIiICk7CgkJCQl9CgkJCX0KCgkJCS8vIFdlIGp1c3QgbW92ZWQgaW50byBhIGdyZWVkeSBjaGlsZAoJCQlpZiAoIHBhcmVudEluc3RhbmNlICYmIGMgPT09ICJpc292ZXIiICkgewoJCQkJcGFyZW50SW5zdGFuY2UuaXNvdmVyID0gZmFsc2U7CgkJCQlwYXJlbnRJbnN0YW5jZS5pc291dCA9IHRydWU7CgkJCQlwYXJlbnRJbnN0YW5jZS5fb3V0LmNhbGwoIHBhcmVudEluc3RhbmNlLCBldmVudCApOwoJCQl9CgoJCQl0aGlzWyBjIF0gPSB0cnVlOwoJCQl0aGlzWyBjID09PSAiaXNvdXQiID8gImlzb3ZlciIgOiAiaXNvdXQiIF0gPSBmYWxzZTsKCQkJdGhpc1sgYyA9PT0gImlzb3ZlciIgPyAiX292ZXIiIDogIl9vdXQiIF0uY2FsbCggdGhpcywgZXZlbnQgKTsKCgkJCS8vIFdlIGp1c3QgbW92ZWQgb3V0IG9mIGEgZ3JlZWR5IGNoaWxkCgkJCWlmICggcGFyZW50SW5zdGFuY2UgJiYgYyA9PT0gImlzb3V0IiApIHsKCQkJCXBhcmVudEluc3RhbmNlLmlzb3V0ID0gZmFsc2U7CgkJCQlwYXJlbnRJbnN0YW5jZS5pc292ZXIgPSB0cnVlOwoJCQkJcGFyZW50SW5zdGFuY2UuX292ZXIuY2FsbCggcGFyZW50SW5zdGFuY2UsIGV2ZW50ICk7CgkJCX0KCQl9ICk7CgoJfSwKCWRyYWdTdG9wOiBmdW5jdGlvbiggZHJhZ2dhYmxlLCBldmVudCApIHsKCQlkcmFnZ2FibGUuZWxlbWVudC5wYXJlbnRzVW50aWwoICJib2R5IiApLm9mZiggInNjcm9sbC5kcm9wcGFibGUiICk7CgoJCS8vIENhbGwgcHJlcGFyZU9mZnNldHMgb25lIGZpbmFsIHRpbWUgc2luY2UgSUUgZG9lcyBub3QgZmlyZSByZXR1cm4gc2Nyb2xsIGV2ZW50cyB3aGVuCgkJLy8gb3ZlcmZsb3cgd2FzIGNhdXNlZCBieSBkcmFnIChzZWUgIzUwMDMpCgkJaWYgKCAhZHJhZ2dhYmxlLm9wdGlvbnMucmVmcmVzaFBvc2l0aW9ucyApIHsKCQkJJC51aS5kZG1hbmFnZXIucHJlcGFyZU9mZnNldHMoIGRyYWdnYWJsZSwgZXZlbnQgKTsKCQl9Cgl9Cn07CgovLyBERVBSRUNBVEVECi8vIFRPRE86IHN3aXRjaCByZXR1cm4gYmFjayB0byB3aWRnZXQgZGVjbGFyYXRpb24gYXQgdG9wIG9mIGZpbGUgd2hlbiB0aGlzIGlzIHJlbW92ZWQKaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgKSB7CgoJLy8gQmFja2NvbXBhdCBmb3IgYWN0aXZlQ2xhc3MgYW5kIGhvdmVyQ2xhc3Mgb3B0aW9ucwoJJC53aWRnZXQoICJ1aS5kcm9wcGFibGUiLCAkLnVpLmRyb3BwYWJsZSwgewoJCW9wdGlvbnM6IHsKCQkJaG92ZXJDbGFzczogZmFsc2UsCgkJCWFjdGl2ZUNsYXNzOiBmYWxzZQoJCX0sCgkJX2FkZEFjdGl2ZUNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlQ2xhc3MgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5hY3RpdmVDbGFzcyApOwoJCQl9CgkJfSwKCQlfcmVtb3ZlQWN0aXZlQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQlpZiAoIHRoaXMub3B0aW9ucy5hY3RpdmVDbGFzcyApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLmFjdGl2ZUNsYXNzICk7CgkJCX0KCQl9LAoJCV9hZGRIb3ZlckNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuaG92ZXJDbGFzcyApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmhvdmVyQ2xhc3MgKTsKCQkJfQoJCX0sCgkJX3JlbW92ZUhvdmVyQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQlpZiAoIHRoaXMub3B0aW9ucy5ob3ZlckNsYXNzICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuaG92ZXJDbGFzcyApOwoJCQl9CgkJfQoJfSApOwp9Cgp2YXIgd2lkZ2V0c0Ryb3BwYWJsZSA9ICQudWkuZHJvcHBhYmxlOwoKCi8qIQogKiBqUXVlcnkgVUkgUmVzaXphYmxlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogUmVzaXphYmxlCi8vPj5ncm91cDogSW50ZXJhY3Rpb25zCi8vPj5kZXNjcmlwdGlvbjogRW5hYmxlcyByZXNpemUgZnVuY3Rpb25hbGl0eSBmb3IgYW55IGVsZW1lbnQuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9yZXNpemFibGUvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9yZXNpemFibGUvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvcmVzaXphYmxlLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKJC53aWRnZXQoICJ1aS5yZXNpemFibGUiLCAkLnVpLm1vdXNlLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCXdpZGdldEV2ZW50UHJlZml4OiAicmVzaXplIiwKCW9wdGlvbnM6IHsKCQlhbHNvUmVzaXplOiBmYWxzZSwKCQlhbmltYXRlOiBmYWxzZSwKCQlhbmltYXRlRHVyYXRpb246ICJzbG93IiwKCQlhbmltYXRlRWFzaW5nOiAic3dpbmciLAoJCWFzcGVjdFJhdGlvOiBmYWxzZSwKCQlhdXRvSGlkZTogZmFsc2UsCgkJY2xhc3NlczogewoJCQkidWktcmVzaXphYmxlLXNlIjogInVpLWljb24gdWktaWNvbi1ncmlwc21hbGwtZGlhZ29uYWwtc2UiCgkJfSwKCQljb250YWlubWVudDogZmFsc2UsCgkJZ2hvc3Q6IGZhbHNlLAoJCWdyaWQ6IGZhbHNlLAoJCWhhbmRsZXM6ICJlLHMsc2UiLAoJCWhlbHBlcjogZmFsc2UsCgkJbWF4SGVpZ2h0OiBudWxsLAoJCW1heFdpZHRoOiBudWxsLAoJCW1pbkhlaWdodDogMTAsCgkJbWluV2lkdGg6IDEwLAoKCQkvLyBTZWUgIzc5NjAKCQl6SW5kZXg6IDkwLAoKCQkvLyBDYWxsYmFja3MKCQlyZXNpemU6IG51bGwsCgkJc3RhcnQ6IG51bGwsCgkJc3RvcDogbnVsbAoJfSwKCglfbnVtOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuIHBhcnNlRmxvYXQoIHZhbHVlICkgfHwgMDsKCX0sCgoJX2lzTnVtYmVyOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuICFpc05hTiggcGFyc2VGbG9hdCggdmFsdWUgKSApOwoJfSwKCglfaGFzU2Nyb2xsOiBmdW5jdGlvbiggZWwsIGEgKSB7CgoJCWlmICggJCggZWwgKS5jc3MoICJvdmVyZmxvdyIgKSA9PT0gImhpZGRlbiIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXZhciBzY3JvbGwgPSAoIGEgJiYgYSA9PT0gImxlZnQiICkgPyAic2Nyb2xsTGVmdCIgOiAic2Nyb2xsVG9wIiwKCQkJaGFzID0gZmFsc2U7CgoJCWlmICggZWxbIHNjcm9sbCBdID4gMCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQkvLyBUT0RPOiBkZXRlcm1pbmUgd2hpY2ggY2FzZXMgYWN0dWFsbHkgY2F1c2UgdGhpcyB0byBoYXBwZW4KCQkvLyBpZiB0aGUgZWxlbWVudCBkb2Vzbid0IGhhdmUgdGhlIHNjcm9sbCBzZXQsIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvCgkJLy8gc2V0IHRoZSBzY3JvbGwKCQllbFsgc2Nyb2xsIF0gPSAxOwoJCWhhcyA9ICggZWxbIHNjcm9sbCBdID4gMCApOwoJCWVsWyBzY3JvbGwgXSA9IDA7CgkJcmV0dXJuIGhhczsKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBtYXJnaW5zLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQl0aGF0ID0gdGhpczsKCQl0aGlzLl9hZGRDbGFzcyggInVpLXJlc2l6YWJsZSIgKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2FzcGVjdFJhdGlvOiAhISggby5hc3BlY3RSYXRpbyApLAoJCQlhc3BlY3RSYXRpbzogby5hc3BlY3RSYXRpbywKCQkJb3JpZ2luYWxFbGVtZW50OiB0aGlzLmVsZW1lbnQsCgkJCV9wcm9wb3J0aW9uYWxseVJlc2l6ZUVsZW1lbnRzOiBbXSwKCQkJX2hlbHBlcjogby5oZWxwZXIgfHwgby5naG9zdCB8fCBvLmFuaW1hdGUgPyBvLmhlbHBlciB8fCAidWktcmVzaXphYmxlLWhlbHBlciIgOiBudWxsCgkJfSApOwoKCQkvLyBXcmFwIHRoZSBlbGVtZW50IGlmIGl0IGNhbm5vdCBob2xkIGNoaWxkIG5vZGVzCgkJaWYgKCB0aGlzLmVsZW1lbnRbIDAgXS5ub2RlTmFtZS5tYXRjaCggL14oY2FudmFzfHRleHRhcmVhfGlucHV0fHNlbGVjdHxidXR0b258aW1nKSQvaSApICkgewoKCQkJdGhpcy5lbGVtZW50LndyYXAoCgkJCQkkKCAiPGRpdiBjbGFzcz0ndWktd3JhcHBlcicgc3R5bGU9J292ZXJmbG93OiBoaWRkZW47Jz48L2Rpdj4iICkuY3NzKCB7CgkJCQkJcG9zaXRpb246IHRoaXMuZWxlbWVudC5jc3MoICJwb3NpdGlvbiIgKSwKCQkJCQl3aWR0aDogdGhpcy5lbGVtZW50Lm91dGVyV2lkdGgoKSwKCQkJCQloZWlnaHQ6IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpLAoJCQkJCXRvcDogdGhpcy5lbGVtZW50LmNzcyggInRvcCIgKSwKCQkJCQlsZWZ0OiB0aGlzLmVsZW1lbnQuY3NzKCAibGVmdCIgKQoJCQkJfSApCgkJCSk7CgoJCQl0aGlzLmVsZW1lbnQgPSB0aGlzLmVsZW1lbnQucGFyZW50KCkuZGF0YSgKCQkJCSJ1aS1yZXNpemFibGUiLCB0aGlzLmVsZW1lbnQucmVzaXphYmxlKCAiaW5zdGFuY2UiICkKCQkJKTsKCgkJCXRoaXMuZWxlbWVudElzV3JhcHBlciA9IHRydWU7CgoJCQltYXJnaW5zID0gewoJCQkJbWFyZ2luVG9wOiB0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoICJtYXJnaW5Ub3AiICksCgkJCQltYXJnaW5SaWdodDogdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCAibWFyZ2luUmlnaHQiICksCgkJCQltYXJnaW5Cb3R0b206IHRoaXMub3JpZ2luYWxFbGVtZW50LmNzcyggIm1hcmdpbkJvdHRvbSIgKSwKCQkJCW1hcmdpbkxlZnQ6IHRoaXMub3JpZ2luYWxFbGVtZW50LmNzcyggIm1hcmdpbkxlZnQiICkKCQkJfTsKCgkJCXRoaXMuZWxlbWVudC5jc3MoIG1hcmdpbnMgKTsKCQkJdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCAibWFyZ2luIiwgMCApOwoKCQkJLy8gc3VwcG9ydDogU2FmYXJpCgkJCS8vIFByZXZlbnQgU2FmYXJpIHRleHRhcmVhIHJlc2l6ZQoJCQl0aGlzLm9yaWdpbmFsUmVzaXplU3R5bGUgPSB0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoICJyZXNpemUiICk7CgkJCXRoaXMub3JpZ2luYWxFbGVtZW50LmNzcyggInJlc2l6ZSIsICJub25lIiApOwoKCQkJdGhpcy5fcHJvcG9ydGlvbmFsbHlSZXNpemVFbGVtZW50cy5wdXNoKCB0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoIHsKCQkJCXBvc2l0aW9uOiAic3RhdGljIiwKCQkJCXpvb206IDEsCgkJCQlkaXNwbGF5OiAiYmxvY2siCgkJCX0gKSApOwoKCQkJLy8gU3VwcG9ydDogSUU5CgkJCS8vIGF2b2lkIElFIGp1bXAgKGhhcmQgc2V0IHRoZSBtYXJnaW4pCgkJCXRoaXMub3JpZ2luYWxFbGVtZW50LmNzcyggbWFyZ2lucyApOwoKCQkJdGhpcy5fcHJvcG9ydGlvbmFsbHlSZXNpemUoKTsKCQl9CgoJCXRoaXMuX3NldHVwSGFuZGxlcygpOwoKCQlpZiAoIG8uYXV0b0hpZGUgKSB7CgkJCSQoIHRoaXMuZWxlbWVudCApCgkJCQkub24oICJtb3VzZWVudGVyIiwgZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCBvLmRpc2FibGVkICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCXRoYXQuX3JlbW92ZUNsYXNzKCAidWktcmVzaXphYmxlLWF1dG9oaWRlIiApOwoJCQkJCXRoYXQuX2hhbmRsZXMuc2hvdygpOwoJCQkJfSApCgkJCQkub24oICJtb3VzZWxlYXZlIiwgZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCBvLmRpc2FibGVkICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCWlmICggIXRoYXQucmVzaXppbmcgKSB7CgkJCQkJCXRoYXQuX2FkZENsYXNzKCAidWktcmVzaXphYmxlLWF1dG9oaWRlIiApOwoJCQkJCQl0aGF0Ll9oYW5kbGVzLmhpZGUoKTsKCQkJCQl9CgkJCQl9ICk7CgkJfQoKCQl0aGlzLl9tb3VzZUluaXQoKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoKCQl0aGlzLl9tb3VzZURlc3Ryb3koKTsKCgkJdmFyIHdyYXBwZXIsCgkJCV9kZXN0cm95ID0gZnVuY3Rpb24oIGV4cCApIHsKCQkJCSQoIGV4cCApCgkJCQkJLnJlbW92ZURhdGEoICJyZXNpemFibGUiICkKCQkJCQkucmVtb3ZlRGF0YSggInVpLXJlc2l6YWJsZSIgKQoJCQkJCS5vZmYoICIucmVzaXphYmxlIiApCgkJCQkJLmZpbmQoICIudWktcmVzaXphYmxlLWhhbmRsZSIgKQoJCQkJCQkucmVtb3ZlKCk7CgkJCX07CgoJCS8vIFRPRE86IFVud3JhcCBhdCBzYW1lIERPTSBwb3NpdGlvbgoJCWlmICggdGhpcy5lbGVtZW50SXNXcmFwcGVyICkgewoJCQlfZGVzdHJveSggdGhpcy5lbGVtZW50ICk7CgkJCXdyYXBwZXIgPSB0aGlzLmVsZW1lbnQ7CgkJCXRoaXMub3JpZ2luYWxFbGVtZW50LmNzcyggewoJCQkJcG9zaXRpb246IHdyYXBwZXIuY3NzKCAicG9zaXRpb24iICksCgkJCQl3aWR0aDogd3JhcHBlci5vdXRlcldpZHRoKCksCgkJCQloZWlnaHQ6IHdyYXBwZXIub3V0ZXJIZWlnaHQoKSwKCQkJCXRvcDogd3JhcHBlci5jc3MoICJ0b3AiICksCgkJCQlsZWZ0OiB3cmFwcGVyLmNzcyggImxlZnQiICkKCQkJfSApLmluc2VydEFmdGVyKCB3cmFwcGVyICk7CgkJCXdyYXBwZXIucmVtb3ZlKCk7CgkJfQoKCQl0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoICJyZXNpemUiLCB0aGlzLm9yaWdpbmFsUmVzaXplU3R5bGUgKTsKCQlfZGVzdHJveSggdGhpcy5vcmlnaW5hbEVsZW1lbnQgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7CgoJCXN3aXRjaCAoIGtleSApIHsKCQljYXNlICJoYW5kbGVzIjoKCQkJdGhpcy5fcmVtb3ZlSGFuZGxlcygpOwoJCQl0aGlzLl9zZXR1cEhhbmRsZXMoKTsKCQkJYnJlYWs7CgkJZGVmYXVsdDoKCQkJYnJlYWs7CgkJfQoJfSwKCglfc2V0dXBIYW5kbGVzOiBmdW5jdGlvbigpIHsKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywgaGFuZGxlLCBpLCBuLCBobmFtZSwgYXhpcywgdGhhdCA9IHRoaXM7CgkJdGhpcy5oYW5kbGVzID0gby5oYW5kbGVzIHx8CgkJCSggISQoICIudWktcmVzaXphYmxlLWhhbmRsZSIsIHRoaXMuZWxlbWVudCApLmxlbmd0aCA/CgkJCQkiZSxzLHNlIiA6IHsKCQkJCQluOiAiLnVpLXJlc2l6YWJsZS1uIiwKCQkJCQllOiAiLnVpLXJlc2l6YWJsZS1lIiwKCQkJCQlzOiAiLnVpLXJlc2l6YWJsZS1zIiwKCQkJCQl3OiAiLnVpLXJlc2l6YWJsZS13IiwKCQkJCQlzZTogIi51aS1yZXNpemFibGUtc2UiLAoJCQkJCXN3OiAiLnVpLXJlc2l6YWJsZS1zdyIsCgkJCQkJbmU6ICIudWktcmVzaXphYmxlLW5lIiwKCQkJCQludzogIi51aS1yZXNpemFibGUtbnciCgkJCQl9ICk7CgoJCXRoaXMuX2hhbmRsZXMgPSAkKCk7CgkJaWYgKCB0aGlzLmhhbmRsZXMuY29uc3RydWN0b3IgPT09IFN0cmluZyApIHsKCgkJCWlmICggdGhpcy5oYW5kbGVzID09PSAiYWxsIiApIHsKCQkJCXRoaXMuaGFuZGxlcyA9ICJuLGUscyx3LHNlLHN3LG5lLG53IjsKCQkJfQoKCQkJbiA9IHRoaXMuaGFuZGxlcy5zcGxpdCggIiwiICk7CgkJCXRoaXMuaGFuZGxlcyA9IHt9OwoKCQkJZm9yICggaSA9IDA7IGkgPCBuLmxlbmd0aDsgaSsrICkgewoKCQkJCWhhbmRsZSA9ICQudHJpbSggblsgaSBdICk7CgkJCQlobmFtZSA9ICJ1aS1yZXNpemFibGUtIiArIGhhbmRsZTsKCQkJCWF4aXMgPSAkKCAiPGRpdj4iICk7CgkJCQl0aGlzLl9hZGRDbGFzcyggYXhpcywgInVpLXJlc2l6YWJsZS1oYW5kbGUgIiArIGhuYW1lICk7CgoJCQkJYXhpcy5jc3MoIHsgekluZGV4OiBvLnpJbmRleCB9ICk7CgoJCQkJdGhpcy5oYW5kbGVzWyBoYW5kbGUgXSA9ICIudWktcmVzaXphYmxlLSIgKyBoYW5kbGU7CgkJCQl0aGlzLmVsZW1lbnQuYXBwZW5kKCBheGlzICk7CgkJCX0KCgkJfQoKCQl0aGlzLl9yZW5kZXJBeGlzID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCgkJCXZhciBpLCBheGlzLCBwYWRQb3MsIHBhZFdyYXBwZXI7CgoJCQl0YXJnZXQgPSB0YXJnZXQgfHwgdGhpcy5lbGVtZW50OwoKCQkJZm9yICggaSBpbiB0aGlzLmhhbmRsZXMgKSB7CgoJCQkJaWYgKCB0aGlzLmhhbmRsZXNbIGkgXS5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nICkgewoJCQkJCXRoaXMuaGFuZGxlc1sgaSBdID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCB0aGlzLmhhbmRsZXNbIGkgXSApLmZpcnN0KCkuc2hvdygpOwoJCQkJfSBlbHNlIGlmICggdGhpcy5oYW5kbGVzWyBpIF0uanF1ZXJ5IHx8IHRoaXMuaGFuZGxlc1sgaSBdLm5vZGVUeXBlICkgewoJCQkJCXRoaXMuaGFuZGxlc1sgaSBdID0gJCggdGhpcy5oYW5kbGVzWyBpIF0gKTsKCQkJCQl0aGlzLl9vbiggdGhpcy5oYW5kbGVzWyBpIF0sIHsgIm1vdXNlZG93biI6IHRoYXQuX21vdXNlRG93biB9ICk7CgkJCQl9CgoJCQkJaWYgKCB0aGlzLmVsZW1lbnRJc1dyYXBwZXIgJiYKCQkJCQkJdGhpcy5vcmlnaW5hbEVsZW1lbnRbIDAgXQoJCQkJCQkJLm5vZGVOYW1lCgkJCQkJCQkubWF0Y2goIC9eKHRleHRhcmVhfGlucHV0fHNlbGVjdHxidXR0b24pJC9pICkgKSB7CgkJCQkJYXhpcyA9ICQoIHRoaXMuaGFuZGxlc1sgaSBdLCB0aGlzLmVsZW1lbnQgKTsKCgkJCQkJcGFkV3JhcHBlciA9IC9zd3xuZXxud3xzZXxufHMvLnRlc3QoIGkgKSA/CgkJCQkJCWF4aXMub3V0ZXJIZWlnaHQoKSA6CgkJCQkJCWF4aXMub3V0ZXJXaWR0aCgpOwoKCQkJCQlwYWRQb3MgPSBbICJwYWRkaW5nIiwKCQkJCQkJL25lfG53fG4vLnRlc3QoIGkgKSA/ICJUb3AiIDoKCQkJCQkJL3NlfHN3fHMvLnRlc3QoIGkgKSA/ICJCb3R0b20iIDoKCQkJCQkJL15lJC8udGVzdCggaSApID8gIlJpZ2h0IiA6ICJMZWZ0IiBdLmpvaW4oICIiICk7CgoJCQkJCXRhcmdldC5jc3MoIHBhZFBvcywgcGFkV3JhcHBlciApOwoKCQkJCQl0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZSgpOwoJCQkJfQoKCQkJCXRoaXMuX2hhbmRsZXMgPSB0aGlzLl9oYW5kbGVzLmFkZCggdGhpcy5oYW5kbGVzWyBpIF0gKTsKCQkJfQoJCX07CgoJCS8vIFRPRE86IG1ha2UgcmVuZGVyQXhpcyBhIHByb3RvdHlwZSBmdW5jdGlvbgoJCXRoaXMuX3JlbmRlckF4aXMoIHRoaXMuZWxlbWVudCApOwoKCQl0aGlzLl9oYW5kbGVzID0gdGhpcy5faGFuZGxlcy5hZGQoIHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXJlc2l6YWJsZS1oYW5kbGUiICkgKTsKCQl0aGlzLl9oYW5kbGVzLmRpc2FibGVTZWxlY3Rpb24oKTsKCgkJdGhpcy5faGFuZGxlcy5vbiggIm1vdXNlb3ZlciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoICF0aGF0LnJlc2l6aW5nICkgewoJCQkJaWYgKCB0aGlzLmNsYXNzTmFtZSApIHsKCQkJCQlheGlzID0gdGhpcy5jbGFzc05hbWUubWF0Y2goIC91aS1yZXNpemFibGUtKHNlfHN3fG5lfG53fG58ZXxzfHcpL2kgKTsKCQkJCX0KCQkJCXRoYXQuYXhpcyA9IGF4aXMgJiYgYXhpc1sgMSBdID8gYXhpc1sgMSBdIDogInNlIjsKCQkJfQoJCX0gKTsKCgkJaWYgKCBvLmF1dG9IaWRlICkgewoJCQl0aGlzLl9oYW5kbGVzLmhpZGUoKTsKCQkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1yZXNpemFibGUtYXV0b2hpZGUiICk7CgkJfQoJfSwKCglfcmVtb3ZlSGFuZGxlczogZnVuY3Rpb24oKSB7CgkJdGhpcy5faGFuZGxlcy5yZW1vdmUoKTsKCX0sCgoJX21vdXNlQ2FwdHVyZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpLCBoYW5kbGUsCgkJCWNhcHR1cmUgPSBmYWxzZTsKCgkJZm9yICggaSBpbiB0aGlzLmhhbmRsZXMgKSB7CgkJCWhhbmRsZSA9ICQoIHRoaXMuaGFuZGxlc1sgaSBdIClbIDAgXTsKCQkJaWYgKCBoYW5kbGUgPT09IGV2ZW50LnRhcmdldCB8fCAkLmNvbnRhaW5zKCBoYW5kbGUsIGV2ZW50LnRhcmdldCApICkgewoJCQkJY2FwdHVyZSA9IHRydWU7CgkJCX0KCQl9CgoJCXJldHVybiAhdGhpcy5vcHRpb25zLmRpc2FibGVkICYmIGNhcHR1cmU7Cgl9LAoKCV9tb3VzZVN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCXZhciBjdXJsZWZ0LCBjdXJ0b3AsIGN1cnNvciwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCXRoaXMucmVzaXppbmcgPSB0cnVlOwoKCQl0aGlzLl9yZW5kZXJQcm94eSgpOwoKCQljdXJsZWZ0ID0gdGhpcy5fbnVtKCB0aGlzLmhlbHBlci5jc3MoICJsZWZ0IiApICk7CgkJY3VydG9wID0gdGhpcy5fbnVtKCB0aGlzLmhlbHBlci5jc3MoICJ0b3AiICkgKTsKCgkJaWYgKCBvLmNvbnRhaW5tZW50ICkgewoJCQljdXJsZWZ0ICs9ICQoIG8uY29udGFpbm1lbnQgKS5zY3JvbGxMZWZ0KCkgfHwgMDsKCQkJY3VydG9wICs9ICQoIG8uY29udGFpbm1lbnQgKS5zY3JvbGxUb3AoKSB8fCAwOwoJCX0KCgkJdGhpcy5vZmZzZXQgPSB0aGlzLmhlbHBlci5vZmZzZXQoKTsKCQl0aGlzLnBvc2l0aW9uID0geyBsZWZ0OiBjdXJsZWZ0LCB0b3A6IGN1cnRvcCB9OwoKCQl0aGlzLnNpemUgPSB0aGlzLl9oZWxwZXIgPyB7CgkJCQl3aWR0aDogdGhpcy5oZWxwZXIud2lkdGgoKSwKCQkJCWhlaWdodDogdGhpcy5oZWxwZXIuaGVpZ2h0KCkKCQkJfSA6IHsKCQkJCXdpZHRoOiBlbC53aWR0aCgpLAoJCQkJaGVpZ2h0OiBlbC5oZWlnaHQoKQoJCQl9OwoKCQl0aGlzLm9yaWdpbmFsU2l6ZSA9IHRoaXMuX2hlbHBlciA/IHsKCQkJCXdpZHRoOiBlbC5vdXRlcldpZHRoKCksCgkJCQloZWlnaHQ6IGVsLm91dGVySGVpZ2h0KCkKCQkJfSA6IHsKCQkJCXdpZHRoOiBlbC53aWR0aCgpLAoJCQkJaGVpZ2h0OiBlbC5oZWlnaHQoKQoJCQl9OwoKCQl0aGlzLnNpemVEaWZmID0gewoJCQl3aWR0aDogZWwub3V0ZXJXaWR0aCgpIC0gZWwud2lkdGgoKSwKCQkJaGVpZ2h0OiBlbC5vdXRlckhlaWdodCgpIC0gZWwuaGVpZ2h0KCkKCQl9OwoKCQl0aGlzLm9yaWdpbmFsUG9zaXRpb24gPSB7IGxlZnQ6IGN1cmxlZnQsIHRvcDogY3VydG9wIH07CgkJdGhpcy5vcmlnaW5hbE1vdXNlUG9zaXRpb24gPSB7IGxlZnQ6IGV2ZW50LnBhZ2VYLCB0b3A6IGV2ZW50LnBhZ2VZIH07CgoJCXRoaXMuYXNwZWN0UmF0aW8gPSAoIHR5cGVvZiBvLmFzcGVjdFJhdGlvID09PSAibnVtYmVyIiApID8KCQkJby5hc3BlY3RSYXRpbyA6CgkJCSggKCB0aGlzLm9yaWdpbmFsU2l6ZS53aWR0aCAvIHRoaXMub3JpZ2luYWxTaXplLmhlaWdodCApIHx8IDEgKTsKCgkJY3Vyc29yID0gJCggIi51aS1yZXNpemFibGUtIiArIHRoaXMuYXhpcyApLmNzcyggImN1cnNvciIgKTsKCQkkKCAiYm9keSIgKS5jc3MoICJjdXJzb3IiLCBjdXJzb3IgPT09ICJhdXRvIiA/IHRoaXMuYXhpcyArICItcmVzaXplIiA6IGN1cnNvciApOwoKCQl0aGlzLl9hZGRDbGFzcyggInVpLXJlc2l6YWJsZS1yZXNpemluZyIgKTsKCQl0aGlzLl9wcm9wYWdhdGUoICJzdGFydCIsIGV2ZW50ICk7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9tb3VzZURyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJdmFyIGRhdGEsIHByb3BzLAoJCQlzbXAgPSB0aGlzLm9yaWdpbmFsTW91c2VQb3NpdGlvbiwKCQkJYSA9IHRoaXMuYXhpcywKCQkJZHggPSAoIGV2ZW50LnBhZ2VYIC0gc21wLmxlZnQgKSB8fCAwLAoJCQlkeSA9ICggZXZlbnQucGFnZVkgLSBzbXAudG9wICkgfHwgMCwKCQkJdHJpZ2dlciA9IHRoaXMuX2NoYW5nZVsgYSBdOwoKCQl0aGlzLl91cGRhdGVQcmV2UHJvcGVydGllcygpOwoKCQlpZiAoICF0cmlnZ2VyICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlkYXRhID0gdHJpZ2dlci5hcHBseSggdGhpcywgWyBldmVudCwgZHgsIGR5IF0gKTsKCgkJdGhpcy5fdXBkYXRlVmlydHVhbEJvdW5kYXJpZXMoIGV2ZW50LnNoaWZ0S2V5ICk7CgkJaWYgKCB0aGlzLl9hc3BlY3RSYXRpbyB8fCBldmVudC5zaGlmdEtleSApIHsKCQkJZGF0YSA9IHRoaXMuX3VwZGF0ZVJhdGlvKCBkYXRhLCBldmVudCApOwoJCX0KCgkJZGF0YSA9IHRoaXMuX3Jlc3BlY3RTaXplKCBkYXRhLCBldmVudCApOwoKCQl0aGlzLl91cGRhdGVDYWNoZSggZGF0YSApOwoKCQl0aGlzLl9wcm9wYWdhdGUoICJyZXNpemUiLCBldmVudCApOwoKCQlwcm9wcyA9IHRoaXMuX2FwcGx5Q2hhbmdlcygpOwoKCQlpZiAoICF0aGlzLl9oZWxwZXIgJiYgdGhpcy5fcHJvcG9ydGlvbmFsbHlSZXNpemVFbGVtZW50cy5sZW5ndGggKSB7CgkJCXRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplKCk7CgkJfQoKCQlpZiAoICEkLmlzRW1wdHlPYmplY3QoIHByb3BzICkgKSB7CgkJCXRoaXMuX3VwZGF0ZVByZXZQcm9wZXJ0aWVzKCk7CgkJCXRoaXMuX3RyaWdnZXIoICJyZXNpemUiLCBldmVudCwgdGhpcy51aSgpICk7CgkJCXRoaXMuX2FwcGx5Q2hhbmdlcygpOwoJCX0KCgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfbW91c2VTdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCXRoaXMucmVzaXppbmcgPSBmYWxzZTsKCQl2YXIgcHIsIGlzdGEsIHNvZmZzZXRoLCBzb2Zmc2V0dywgcywgbGVmdCwgdG9wLAoJCQlvID0gdGhpcy5vcHRpb25zLCB0aGF0ID0gdGhpczsKCgkJaWYgKCB0aGlzLl9oZWxwZXIgKSB7CgoJCQlwciA9IHRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHM7CgkJCWlzdGEgPSBwci5sZW5ndGggJiYgKCAvdGV4dGFyZWEvaSApLnRlc3QoIHByWyAwIF0ubm9kZU5hbWUgKTsKCQkJc29mZnNldGggPSBpc3RhICYmIHRoaXMuX2hhc1Njcm9sbCggcHJbIDAgXSwgImxlZnQiICkgPyAwIDogdGhhdC5zaXplRGlmZi5oZWlnaHQ7CgkJCXNvZmZzZXR3ID0gaXN0YSA/IDAgOiB0aGF0LnNpemVEaWZmLndpZHRoOwoKCQkJcyA9IHsKCQkJCXdpZHRoOiAoIHRoYXQuaGVscGVyLndpZHRoKCkgIC0gc29mZnNldHcgKSwKCQkJCWhlaWdodDogKCB0aGF0LmhlbHBlci5oZWlnaHQoKSAtIHNvZmZzZXRoICkKCQkJfTsKCQkJbGVmdCA9ICggcGFyc2VGbG9hdCggdGhhdC5lbGVtZW50LmNzcyggImxlZnQiICkgKSArCgkJCQkoIHRoYXQucG9zaXRpb24ubGVmdCAtIHRoYXQub3JpZ2luYWxQb3NpdGlvbi5sZWZ0ICkgKSB8fCBudWxsOwoJCQl0b3AgPSAoIHBhcnNlRmxvYXQoIHRoYXQuZWxlbWVudC5jc3MoICJ0b3AiICkgKSArCgkJCQkoIHRoYXQucG9zaXRpb24udG9wIC0gdGhhdC5vcmlnaW5hbFBvc2l0aW9uLnRvcCApICkgfHwgbnVsbDsKCgkJCWlmICggIW8uYW5pbWF0ZSApIHsKCQkJCXRoaXMuZWxlbWVudC5jc3MoICQuZXh0ZW5kKCBzLCB7IHRvcDogdG9wLCBsZWZ0OiBsZWZ0IH0gKSApOwoJCQl9CgoJCQl0aGF0LmhlbHBlci5oZWlnaHQoIHRoYXQuc2l6ZS5oZWlnaHQgKTsKCQkJdGhhdC5oZWxwZXIud2lkdGgoIHRoYXQuc2l6ZS53aWR0aCApOwoKCQkJaWYgKCB0aGlzLl9oZWxwZXIgJiYgIW8uYW5pbWF0ZSApIHsKCQkJCXRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplKCk7CgkJCX0KCQl9CgoJCSQoICJib2R5IiApLmNzcyggImN1cnNvciIsICJhdXRvIiApOwoKCQl0aGlzLl9yZW1vdmVDbGFzcyggInVpLXJlc2l6YWJsZS1yZXNpemluZyIgKTsKCgkJdGhpcy5fcHJvcGFnYXRlKCAic3RvcCIsIGV2ZW50ICk7CgoJCWlmICggdGhpcy5faGVscGVyICkgewoJCQl0aGlzLmhlbHBlci5yZW1vdmUoKTsKCQl9CgoJCXJldHVybiBmYWxzZTsKCgl9LAoKCV91cGRhdGVQcmV2UHJvcGVydGllczogZnVuY3Rpb24oKSB7CgkJdGhpcy5wcmV2UG9zaXRpb24gPSB7CgkJCXRvcDogdGhpcy5wb3NpdGlvbi50b3AsCgkJCWxlZnQ6IHRoaXMucG9zaXRpb24ubGVmdAoJCX07CgkJdGhpcy5wcmV2U2l6ZSA9IHsKCQkJd2lkdGg6IHRoaXMuc2l6ZS53aWR0aCwKCQkJaGVpZ2h0OiB0aGlzLnNpemUuaGVpZ2h0CgkJfTsKCX0sCgoJX2FwcGx5Q2hhbmdlczogZnVuY3Rpb24oKSB7CgkJdmFyIHByb3BzID0ge307CgoJCWlmICggdGhpcy5wb3NpdGlvbi50b3AgIT09IHRoaXMucHJldlBvc2l0aW9uLnRvcCApIHsKCQkJcHJvcHMudG9wID0gdGhpcy5wb3NpdGlvbi50b3AgKyAicHgiOwoJCX0KCQlpZiAoIHRoaXMucG9zaXRpb24ubGVmdCAhPT0gdGhpcy5wcmV2UG9zaXRpb24ubGVmdCApIHsKCQkJcHJvcHMubGVmdCA9IHRoaXMucG9zaXRpb24ubGVmdCArICJweCI7CgkJfQoJCWlmICggdGhpcy5zaXplLndpZHRoICE9PSB0aGlzLnByZXZTaXplLndpZHRoICkgewoJCQlwcm9wcy53aWR0aCA9IHRoaXMuc2l6ZS53aWR0aCArICJweCI7CgkJfQoJCWlmICggdGhpcy5zaXplLmhlaWdodCAhPT0gdGhpcy5wcmV2U2l6ZS5oZWlnaHQgKSB7CgkJCXByb3BzLmhlaWdodCA9IHRoaXMuc2l6ZS5oZWlnaHQgKyAicHgiOwoJCX0KCgkJdGhpcy5oZWxwZXIuY3NzKCBwcm9wcyApOwoKCQlyZXR1cm4gcHJvcHM7Cgl9LAoKCV91cGRhdGVWaXJ0dWFsQm91bmRhcmllczogZnVuY3Rpb24oIGZvcmNlQXNwZWN0UmF0aW8gKSB7CgkJdmFyIHBNaW5XaWR0aCwgcE1heFdpZHRoLCBwTWluSGVpZ2h0LCBwTWF4SGVpZ2h0LCBiLAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQliID0gewoJCQltaW5XaWR0aDogdGhpcy5faXNOdW1iZXIoIG8ubWluV2lkdGggKSA/IG8ubWluV2lkdGggOiAwLAoJCQltYXhXaWR0aDogdGhpcy5faXNOdW1iZXIoIG8ubWF4V2lkdGggKSA/IG8ubWF4V2lkdGggOiBJbmZpbml0eSwKCQkJbWluSGVpZ2h0OiB0aGlzLl9pc051bWJlciggby5taW5IZWlnaHQgKSA/IG8ubWluSGVpZ2h0IDogMCwKCQkJbWF4SGVpZ2h0OiB0aGlzLl9pc051bWJlciggby5tYXhIZWlnaHQgKSA/IG8ubWF4SGVpZ2h0IDogSW5maW5pdHkKCQl9OwoKCQlpZiAoIHRoaXMuX2FzcGVjdFJhdGlvIHx8IGZvcmNlQXNwZWN0UmF0aW8gKSB7CgkJCXBNaW5XaWR0aCA9IGIubWluSGVpZ2h0ICogdGhpcy5hc3BlY3RSYXRpbzsKCQkJcE1pbkhlaWdodCA9IGIubWluV2lkdGggLyB0aGlzLmFzcGVjdFJhdGlvOwoJCQlwTWF4V2lkdGggPSBiLm1heEhlaWdodCAqIHRoaXMuYXNwZWN0UmF0aW87CgkJCXBNYXhIZWlnaHQgPSBiLm1heFdpZHRoIC8gdGhpcy5hc3BlY3RSYXRpbzsKCgkJCWlmICggcE1pbldpZHRoID4gYi5taW5XaWR0aCApIHsKCQkJCWIubWluV2lkdGggPSBwTWluV2lkdGg7CgkJCX0KCQkJaWYgKCBwTWluSGVpZ2h0ID4gYi5taW5IZWlnaHQgKSB7CgkJCQliLm1pbkhlaWdodCA9IHBNaW5IZWlnaHQ7CgkJCX0KCQkJaWYgKCBwTWF4V2lkdGggPCBiLm1heFdpZHRoICkgewoJCQkJYi5tYXhXaWR0aCA9IHBNYXhXaWR0aDsKCQkJfQoJCQlpZiAoIHBNYXhIZWlnaHQgPCBiLm1heEhlaWdodCApIHsKCQkJCWIubWF4SGVpZ2h0ID0gcE1heEhlaWdodDsKCQkJfQoJCX0KCQl0aGlzLl92Qm91bmRhcmllcyA9IGI7Cgl9LAoKCV91cGRhdGVDYWNoZTogZnVuY3Rpb24oIGRhdGEgKSB7CgkJdGhpcy5vZmZzZXQgPSB0aGlzLmhlbHBlci5vZmZzZXQoKTsKCQlpZiAoIHRoaXMuX2lzTnVtYmVyKCBkYXRhLmxlZnQgKSApIHsKCQkJdGhpcy5wb3NpdGlvbi5sZWZ0ID0gZGF0YS5sZWZ0OwoJCX0KCQlpZiAoIHRoaXMuX2lzTnVtYmVyKCBkYXRhLnRvcCApICkgewoJCQl0aGlzLnBvc2l0aW9uLnRvcCA9IGRhdGEudG9wOwoJCX0KCQlpZiAoIHRoaXMuX2lzTnVtYmVyKCBkYXRhLmhlaWdodCApICkgewoJCQl0aGlzLnNpemUuaGVpZ2h0ID0gZGF0YS5oZWlnaHQ7CgkJfQoJCWlmICggdGhpcy5faXNOdW1iZXIoIGRhdGEud2lkdGggKSApIHsKCQkJdGhpcy5zaXplLndpZHRoID0gZGF0YS53aWR0aDsKCQl9Cgl9LAoKCV91cGRhdGVSYXRpbzogZnVuY3Rpb24oIGRhdGEgKSB7CgoJCXZhciBjcG9zID0gdGhpcy5wb3NpdGlvbiwKCQkJY3NpemUgPSB0aGlzLnNpemUsCgkJCWEgPSB0aGlzLmF4aXM7CgoJCWlmICggdGhpcy5faXNOdW1iZXIoIGRhdGEuaGVpZ2h0ICkgKSB7CgkJCWRhdGEud2lkdGggPSAoIGRhdGEuaGVpZ2h0ICogdGhpcy5hc3BlY3RSYXRpbyApOwoJCX0gZWxzZSBpZiAoIHRoaXMuX2lzTnVtYmVyKCBkYXRhLndpZHRoICkgKSB7CgkJCWRhdGEuaGVpZ2h0ID0gKCBkYXRhLndpZHRoIC8gdGhpcy5hc3BlY3RSYXRpbyApOwoJCX0KCgkJaWYgKCBhID09PSAic3ciICkgewoJCQlkYXRhLmxlZnQgPSBjcG9zLmxlZnQgKyAoIGNzaXplLndpZHRoIC0gZGF0YS53aWR0aCApOwoJCQlkYXRhLnRvcCA9IG51bGw7CgkJfQoJCWlmICggYSA9PT0gIm53IiApIHsKCQkJZGF0YS50b3AgPSBjcG9zLnRvcCArICggY3NpemUuaGVpZ2h0IC0gZGF0YS5oZWlnaHQgKTsKCQkJZGF0YS5sZWZ0ID0gY3Bvcy5sZWZ0ICsgKCBjc2l6ZS53aWR0aCAtIGRhdGEud2lkdGggKTsKCQl9CgoJCXJldHVybiBkYXRhOwoJfSwKCglfcmVzcGVjdFNpemU6IGZ1bmN0aW9uKCBkYXRhICkgewoKCQl2YXIgbyA9IHRoaXMuX3ZCb3VuZGFyaWVzLAoJCQlhID0gdGhpcy5heGlzLAoJCQlpc21heHcgPSB0aGlzLl9pc051bWJlciggZGF0YS53aWR0aCApICYmIG8ubWF4V2lkdGggJiYgKCBvLm1heFdpZHRoIDwgZGF0YS53aWR0aCApLAoJCQlpc21heGggPSB0aGlzLl9pc051bWJlciggZGF0YS5oZWlnaHQgKSAmJiBvLm1heEhlaWdodCAmJiAoIG8ubWF4SGVpZ2h0IDwgZGF0YS5oZWlnaHQgKSwKCQkJaXNtaW53ID0gdGhpcy5faXNOdW1iZXIoIGRhdGEud2lkdGggKSAmJiBvLm1pbldpZHRoICYmICggby5taW5XaWR0aCA+IGRhdGEud2lkdGggKSwKCQkJaXNtaW5oID0gdGhpcy5faXNOdW1iZXIoIGRhdGEuaGVpZ2h0ICkgJiYgby5taW5IZWlnaHQgJiYgKCBvLm1pbkhlaWdodCA+IGRhdGEuaGVpZ2h0ICksCgkJCWR3ID0gdGhpcy5vcmlnaW5hbFBvc2l0aW9uLmxlZnQgKyB0aGlzLm9yaWdpbmFsU2l6ZS53aWR0aCwKCQkJZGggPSB0aGlzLm9yaWdpbmFsUG9zaXRpb24udG9wICsgdGhpcy5vcmlnaW5hbFNpemUuaGVpZ2h0LAoJCQljdyA9IC9zd3xud3x3Ly50ZXN0KCBhICksIGNoID0gL253fG5lfG4vLnRlc3QoIGEgKTsKCQlpZiAoIGlzbWludyApIHsKCQkJZGF0YS53aWR0aCA9IG8ubWluV2lkdGg7CgkJfQoJCWlmICggaXNtaW5oICkgewoJCQlkYXRhLmhlaWdodCA9IG8ubWluSGVpZ2h0OwoJCX0KCQlpZiAoIGlzbWF4dyApIHsKCQkJZGF0YS53aWR0aCA9IG8ubWF4V2lkdGg7CgkJfQoJCWlmICggaXNtYXhoICkgewoJCQlkYXRhLmhlaWdodCA9IG8ubWF4SGVpZ2h0OwoJCX0KCgkJaWYgKCBpc21pbncgJiYgY3cgKSB7CgkJCWRhdGEubGVmdCA9IGR3IC0gby5taW5XaWR0aDsKCQl9CgkJaWYgKCBpc21heHcgJiYgY3cgKSB7CgkJCWRhdGEubGVmdCA9IGR3IC0gby5tYXhXaWR0aDsKCQl9CgkJaWYgKCBpc21pbmggJiYgY2ggKSB7CgkJCWRhdGEudG9wID0gZGggLSBvLm1pbkhlaWdodDsKCQl9CgkJaWYgKCBpc21heGggJiYgY2ggKSB7CgkJCWRhdGEudG9wID0gZGggLSBvLm1heEhlaWdodDsKCQl9CgoJCS8vIEZpeGluZyBqdW1wIGVycm9yIG9uIHRvcC9sZWZ0IC0gYnVnICMyMzMwCgkJaWYgKCAhZGF0YS53aWR0aCAmJiAhZGF0YS5oZWlnaHQgJiYgIWRhdGEubGVmdCAmJiBkYXRhLnRvcCApIHsKCQkJZGF0YS50b3AgPSBudWxsOwoJCX0gZWxzZSBpZiAoICFkYXRhLndpZHRoICYmICFkYXRhLmhlaWdodCAmJiAhZGF0YS50b3AgJiYgZGF0YS5sZWZ0ICkgewoJCQlkYXRhLmxlZnQgPSBudWxsOwoJCX0KCgkJcmV0dXJuIGRhdGE7Cgl9LAoKCV9nZXRQYWRkaW5nUGx1c0JvcmRlckRpbWVuc2lvbnM6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXZhciBpID0gMCwKCQkJd2lkdGhzID0gW10sCgkJCWJvcmRlcnMgPSBbCgkJCQllbGVtZW50LmNzcyggImJvcmRlclRvcFdpZHRoIiApLAoJCQkJZWxlbWVudC5jc3MoICJib3JkZXJSaWdodFdpZHRoIiApLAoJCQkJZWxlbWVudC5jc3MoICJib3JkZXJCb3R0b21XaWR0aCIgKSwKCQkJCWVsZW1lbnQuY3NzKCAiYm9yZGVyTGVmdFdpZHRoIiApCgkJCV0sCgkJCXBhZGRpbmdzID0gWwoJCQkJZWxlbWVudC5jc3MoICJwYWRkaW5nVG9wIiApLAoJCQkJZWxlbWVudC5jc3MoICJwYWRkaW5nUmlnaHQiICksCgkJCQllbGVtZW50LmNzcyggInBhZGRpbmdCb3R0b20iICksCgkJCQllbGVtZW50LmNzcyggInBhZGRpbmdMZWZ0IiApCgkJCV07CgoJCWZvciAoIDsgaSA8IDQ7IGkrKyApIHsKCQkJd2lkdGhzWyBpIF0gPSAoIHBhcnNlRmxvYXQoIGJvcmRlcnNbIGkgXSApIHx8IDAgKTsKCQkJd2lkdGhzWyBpIF0gKz0gKCBwYXJzZUZsb2F0KCBwYWRkaW5nc1sgaSBdICkgfHwgMCApOwoJCX0KCgkJcmV0dXJuIHsKCQkJaGVpZ2h0OiB3aWR0aHNbIDAgXSArIHdpZHRoc1sgMiBdLAoJCQl3aWR0aDogd2lkdGhzWyAxIF0gKyB3aWR0aHNbIDMgXQoJCX07Cgl9LAoKCV9wcm9wb3J0aW9uYWxseVJlc2l6ZTogZnVuY3Rpb24oKSB7CgoJCWlmICggIXRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHMubGVuZ3RoICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgcHJlbCwKCQkJaSA9IDAsCgkJCWVsZW1lbnQgPSB0aGlzLmhlbHBlciB8fCB0aGlzLmVsZW1lbnQ7CgoJCWZvciAoIDsgaSA8IHRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHMubGVuZ3RoOyBpKysgKSB7CgoJCQlwcmVsID0gdGhpcy5fcHJvcG9ydGlvbmFsbHlSZXNpemVFbGVtZW50c1sgaSBdOwoKCQkJLy8gVE9ETzogU2VlbXMgbGlrZSBhIGJ1ZyB0byBjYWNoZSB0aGlzLm91dGVyRGltZW5zaW9ucwoJCQkvLyBjb25zaWRlcmluZyB0aGF0IHdlIGFyZSBpbiBhIGxvb3AuCgkJCWlmICggIXRoaXMub3V0ZXJEaW1lbnNpb25zICkgewoJCQkJdGhpcy5vdXRlckRpbWVuc2lvbnMgPSB0aGlzLl9nZXRQYWRkaW5nUGx1c0JvcmRlckRpbWVuc2lvbnMoIHByZWwgKTsKCQkJfQoKCQkJcHJlbC5jc3MoIHsKCQkJCWhlaWdodDogKCBlbGVtZW50LmhlaWdodCgpIC0gdGhpcy5vdXRlckRpbWVuc2lvbnMuaGVpZ2h0ICkgfHwgMCwKCQkJCXdpZHRoOiAoIGVsZW1lbnQud2lkdGgoKSAtIHRoaXMub3V0ZXJEaW1lbnNpb25zLndpZHRoICkgfHwgMAoJCQl9ICk7CgoJCX0KCgl9LAoKCV9yZW5kZXJQcm94eTogZnVuY3Rpb24oKSB7CgoJCXZhciBlbCA9IHRoaXMuZWxlbWVudCwgbyA9IHRoaXMub3B0aW9uczsKCQl0aGlzLmVsZW1lbnRPZmZzZXQgPSBlbC5vZmZzZXQoKTsKCgkJaWYgKCB0aGlzLl9oZWxwZXIgKSB7CgoJCQl0aGlzLmhlbHBlciA9IHRoaXMuaGVscGVyIHx8ICQoICI8ZGl2IHN0eWxlPSdvdmVyZmxvdzpoaWRkZW47Jz48L2Rpdj4iICk7CgoJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5oZWxwZXIsIHRoaXMuX2hlbHBlciApOwoJCQl0aGlzLmhlbHBlci5jc3MoIHsKCQkJCXdpZHRoOiB0aGlzLmVsZW1lbnQub3V0ZXJXaWR0aCgpLAoJCQkJaGVpZ2h0OiB0aGlzLmVsZW1lbnQub3V0ZXJIZWlnaHQoKSwKCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLAoJCQkJbGVmdDogdGhpcy5lbGVtZW50T2Zmc2V0LmxlZnQgKyAicHgiLAoJCQkJdG9wOiB0aGlzLmVsZW1lbnRPZmZzZXQudG9wICsgInB4IiwKCQkJCXpJbmRleDogKytvLnpJbmRleCAvL1RPRE86IERvbid0IG1vZGlmeSBvcHRpb24KCQkJfSApOwoKCQkJdGhpcy5oZWxwZXIKCQkJCS5hcHBlbmRUbyggImJvZHkiICkKCQkJCS5kaXNhYmxlU2VsZWN0aW9uKCk7CgoJCX0gZWxzZSB7CgkJCXRoaXMuaGVscGVyID0gdGhpcy5lbGVtZW50OwoJCX0KCgl9LAoKCV9jaGFuZ2U6IHsKCQllOiBmdW5jdGlvbiggZXZlbnQsIGR4ICkgewoJCQlyZXR1cm4geyB3aWR0aDogdGhpcy5vcmlnaW5hbFNpemUud2lkdGggKyBkeCB9OwoJCX0sCgkJdzogZnVuY3Rpb24oIGV2ZW50LCBkeCApIHsKCQkJdmFyIGNzID0gdGhpcy5vcmlnaW5hbFNpemUsIHNwID0gdGhpcy5vcmlnaW5hbFBvc2l0aW9uOwoJCQlyZXR1cm4geyBsZWZ0OiBzcC5sZWZ0ICsgZHgsIHdpZHRoOiBjcy53aWR0aCAtIGR4IH07CgkJfSwKCQluOiBmdW5jdGlvbiggZXZlbnQsIGR4LCBkeSApIHsKCQkJdmFyIGNzID0gdGhpcy5vcmlnaW5hbFNpemUsIHNwID0gdGhpcy5vcmlnaW5hbFBvc2l0aW9uOwoJCQlyZXR1cm4geyB0b3A6IHNwLnRvcCArIGR5LCBoZWlnaHQ6IGNzLmhlaWdodCAtIGR5IH07CgkJfSwKCQlzOiBmdW5jdGlvbiggZXZlbnQsIGR4LCBkeSApIHsKCQkJcmV0dXJuIHsgaGVpZ2h0OiB0aGlzLm9yaWdpbmFsU2l6ZS5oZWlnaHQgKyBkeSB9OwoJCX0sCgkJc2U6IGZ1bmN0aW9uKCBldmVudCwgZHgsIGR5ICkgewoJCQlyZXR1cm4gJC5leHRlbmQoIHRoaXMuX2NoYW5nZS5zLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJCXRoaXMuX2NoYW5nZS5lLmFwcGx5KCB0aGlzLCBbIGV2ZW50LCBkeCwgZHkgXSApICk7CgkJfSwKCQlzdzogZnVuY3Rpb24oIGV2ZW50LCBkeCwgZHkgKSB7CgkJCXJldHVybiAkLmV4dGVuZCggdGhpcy5fY2hhbmdlLnMuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApLAoJCQkJdGhpcy5fY2hhbmdlLncuYXBwbHkoIHRoaXMsIFsgZXZlbnQsIGR4LCBkeSBdICkgKTsKCQl9LAoJCW5lOiBmdW5jdGlvbiggZXZlbnQsIGR4LCBkeSApIHsKCQkJcmV0dXJuICQuZXh0ZW5kKCB0aGlzLl9jaGFuZ2Uubi5hcHBseSggdGhpcywgYXJndW1lbnRzICksCgkJCQl0aGlzLl9jaGFuZ2UuZS5hcHBseSggdGhpcywgWyBldmVudCwgZHgsIGR5IF0gKSApOwoJCX0sCgkJbnc6IGZ1bmN0aW9uKCBldmVudCwgZHgsIGR5ICkgewoJCQlyZXR1cm4gJC5leHRlbmQoIHRoaXMuX2NoYW5nZS5uLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJCXRoaXMuX2NoYW5nZS53LmFwcGx5KCB0aGlzLCBbIGV2ZW50LCBkeCwgZHkgXSApICk7CgkJfQoJfSwKCglfcHJvcGFnYXRlOiBmdW5jdGlvbiggbiwgZXZlbnQgKSB7CgkJJC51aS5wbHVnaW4uY2FsbCggdGhpcywgbiwgWyBldmVudCwgdGhpcy51aSgpIF0gKTsKCQkoIG4gIT09ICJyZXNpemUiICYmIHRoaXMuX3RyaWdnZXIoIG4sIGV2ZW50LCB0aGlzLnVpKCkgKSApOwoJfSwKCglwbHVnaW5zOiB7fSwKCgl1aTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJb3JpZ2luYWxFbGVtZW50OiB0aGlzLm9yaWdpbmFsRWxlbWVudCwKCQkJZWxlbWVudDogdGhpcy5lbGVtZW50LAoJCQloZWxwZXI6IHRoaXMuaGVscGVyLAoJCQlwb3NpdGlvbjogdGhpcy5wb3NpdGlvbiwKCQkJc2l6ZTogdGhpcy5zaXplLAoJCQlvcmlnaW5hbFNpemU6IHRoaXMub3JpZ2luYWxTaXplLAoJCQlvcmlnaW5hbFBvc2l0aW9uOiB0aGlzLm9yaWdpbmFsUG9zaXRpb24KCQl9OwoJfQoKfSApOwoKLyoKICogUmVzaXphYmxlIEV4dGVuc2lvbnMKICovCgokLnVpLnBsdWdpbi5hZGQoICJyZXNpemFibGUiLCAiYW5pbWF0ZSIsIHsKCglzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRoYXQgPSAkKCB0aGlzICkucmVzaXphYmxlKCAiaW5zdGFuY2UiICksCgkJCW8gPSB0aGF0Lm9wdGlvbnMsCgkJCXByID0gdGhhdC5fcHJvcG9ydGlvbmFsbHlSZXNpemVFbGVtZW50cywKCQkJaXN0YSA9IHByLmxlbmd0aCAmJiAoIC90ZXh0YXJlYS9pICkudGVzdCggcHJbIDAgXS5ub2RlTmFtZSApLAoJCQlzb2Zmc2V0aCA9IGlzdGEgJiYgdGhhdC5faGFzU2Nyb2xsKCBwclsgMCBdLCAibGVmdCIgKSA/IDAgOiB0aGF0LnNpemVEaWZmLmhlaWdodCwKCQkJc29mZnNldHcgPSBpc3RhID8gMCA6IHRoYXQuc2l6ZURpZmYud2lkdGgsCgkJCXN0eWxlID0gewoJCQkJd2lkdGg6ICggdGhhdC5zaXplLndpZHRoIC0gc29mZnNldHcgKSwKCQkJCWhlaWdodDogKCB0aGF0LnNpemUuaGVpZ2h0IC0gc29mZnNldGggKQoJCQl9LAoJCQlsZWZ0ID0gKCBwYXJzZUZsb2F0KCB0aGF0LmVsZW1lbnQuY3NzKCAibGVmdCIgKSApICsKCQkJCSggdGhhdC5wb3NpdGlvbi5sZWZ0IC0gdGhhdC5vcmlnaW5hbFBvc2l0aW9uLmxlZnQgKSApIHx8IG51bGwsCgkJCXRvcCA9ICggcGFyc2VGbG9hdCggdGhhdC5lbGVtZW50LmNzcyggInRvcCIgKSApICsKCQkJCSggdGhhdC5wb3NpdGlvbi50b3AgLSB0aGF0Lm9yaWdpbmFsUG9zaXRpb24udG9wICkgKSB8fCBudWxsOwoKCQl0aGF0LmVsZW1lbnQuYW5pbWF0ZSgKCQkJJC5leHRlbmQoIHN0eWxlLCB0b3AgJiYgbGVmdCA/IHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfSA6IHt9ICksIHsKCQkJCWR1cmF0aW9uOiBvLmFuaW1hdGVEdXJhdGlvbiwKCQkJCWVhc2luZzogby5hbmltYXRlRWFzaW5nLAoJCQkJc3RlcDogZnVuY3Rpb24oKSB7CgoJCQkJCXZhciBkYXRhID0gewoJCQkJCQl3aWR0aDogcGFyc2VGbG9hdCggdGhhdC5lbGVtZW50LmNzcyggIndpZHRoIiApICksCgkJCQkJCWhlaWdodDogcGFyc2VGbG9hdCggdGhhdC5lbGVtZW50LmNzcyggImhlaWdodCIgKSApLAoJCQkJCQl0b3A6IHBhcnNlRmxvYXQoIHRoYXQuZWxlbWVudC5jc3MoICJ0b3AiICkgKSwKCQkJCQkJbGVmdDogcGFyc2VGbG9hdCggdGhhdC5lbGVtZW50LmNzcyggImxlZnQiICkgKQoJCQkJCX07CgoJCQkJCWlmICggcHIgJiYgcHIubGVuZ3RoICkgewoJCQkJCQkkKCBwclsgMCBdICkuY3NzKCB7IHdpZHRoOiBkYXRhLndpZHRoLCBoZWlnaHQ6IGRhdGEuaGVpZ2h0IH0gKTsKCQkJCQl9CgoJCQkJCS8vIFByb3BhZ2F0aW5nIHJlc2l6ZSwgYW5kIHVwZGF0aW5nIHZhbHVlcyBmb3IgZWFjaCBhbmltYXRpb24gc3RlcAoJCQkJCXRoYXQuX3VwZGF0ZUNhY2hlKCBkYXRhICk7CgkJCQkJdGhhdC5fcHJvcGFnYXRlKCAicmVzaXplIiwgZXZlbnQgKTsKCgkJCQl9CgkJCX0KCQkpOwoJfQoKfSApOwoKJC51aS5wbHVnaW4uYWRkKCAicmVzaXphYmxlIiwgImNvbnRhaW5tZW50IiwgewoKCXN0YXJ0OiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbWVudCwgcCwgY28sIGNoLCBjdywgd2lkdGgsIGhlaWdodCwKCQkJdGhhdCA9ICQoIHRoaXMgKS5yZXNpemFibGUoICJpbnN0YW5jZSIgKSwKCQkJbyA9IHRoYXQub3B0aW9ucywKCQkJZWwgPSB0aGF0LmVsZW1lbnQsCgkJCW9jID0gby5jb250YWlubWVudCwKCQkJY2UgPSAoIG9jIGluc3RhbmNlb2YgJCApID8KCQkJCW9jLmdldCggMCApIDoKCQkJCSggL3BhcmVudC8udGVzdCggb2MgKSApID8gZWwucGFyZW50KCkuZ2V0KCAwICkgOiBvYzsKCgkJaWYgKCAhY2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoYXQuY29udGFpbmVyRWxlbWVudCA9ICQoIGNlICk7CgoJCWlmICggL2RvY3VtZW50Ly50ZXN0KCBvYyApIHx8IG9jID09PSBkb2N1bWVudCApIHsKCQkJdGhhdC5jb250YWluZXJPZmZzZXQgPSB7CgkJCQlsZWZ0OiAwLAoJCQkJdG9wOiAwCgkJCX07CgkJCXRoYXQuY29udGFpbmVyUG9zaXRpb24gPSB7CgkJCQlsZWZ0OiAwLAoJCQkJdG9wOiAwCgkJCX07CgoJCQl0aGF0LnBhcmVudERhdGEgPSB7CgkJCQllbGVtZW50OiAkKCBkb2N1bWVudCApLAoJCQkJbGVmdDogMCwKCQkJCXRvcDogMCwKCQkJCXdpZHRoOiAkKCBkb2N1bWVudCApLndpZHRoKCksCgkJCQloZWlnaHQ6ICQoIGRvY3VtZW50ICkuaGVpZ2h0KCkgfHwgZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlLnNjcm9sbEhlaWdodAoJCQl9OwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQgPSAkKCBjZSApOwoJCQlwID0gW107CgkJCSQoIFsgIlRvcCIsICJSaWdodCIsICJMZWZ0IiwgIkJvdHRvbSIgXSApLmVhY2goIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJCQkJcFsgaSBdID0gdGhhdC5fbnVtKCBlbGVtZW50LmNzcyggInBhZGRpbmciICsgbmFtZSApICk7CgkJCX0gKTsKCgkJCXRoYXQuY29udGFpbmVyT2Zmc2V0ID0gZWxlbWVudC5vZmZzZXQoKTsKCQkJdGhhdC5jb250YWluZXJQb3NpdGlvbiA9IGVsZW1lbnQucG9zaXRpb24oKTsKCQkJdGhhdC5jb250YWluZXJTaXplID0gewoJCQkJaGVpZ2h0OiAoIGVsZW1lbnQuaW5uZXJIZWlnaHQoKSAtIHBbIDMgXSApLAoJCQkJd2lkdGg6ICggZWxlbWVudC5pbm5lcldpZHRoKCkgLSBwWyAxIF0gKQoJCQl9OwoKCQkJY28gPSB0aGF0LmNvbnRhaW5lck9mZnNldDsKCQkJY2ggPSB0aGF0LmNvbnRhaW5lclNpemUuaGVpZ2h0OwoJCQljdyA9IHRoYXQuY29udGFpbmVyU2l6ZS53aWR0aDsKCQkJd2lkdGggPSAoIHRoYXQuX2hhc1Njcm9sbCAoIGNlLCAibGVmdCIgKSA/IGNlLnNjcm9sbFdpZHRoIDogY3cgKTsKCQkJaGVpZ2h0ID0gKCB0aGF0Ll9oYXNTY3JvbGwgKCBjZSApID8gY2Uuc2Nyb2xsSGVpZ2h0IDogY2ggKSA7CgoJCQl0aGF0LnBhcmVudERhdGEgPSB7CgkJCQllbGVtZW50OiBjZSwKCQkJCWxlZnQ6IGNvLmxlZnQsCgkJCQl0b3A6IGNvLnRvcCwKCQkJCXdpZHRoOiB3aWR0aCwKCQkJCWhlaWdodDogaGVpZ2h0CgkJCX07CgkJfQoJfSwKCglyZXNpemU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgd29zZXQsIGhvc2V0LCBpc1BhcmVudCwgaXNPZmZzZXRSZWxhdGl2ZSwKCQkJdGhhdCA9ICQoIHRoaXMgKS5yZXNpemFibGUoICJpbnN0YW5jZSIgKSwKCQkJbyA9IHRoYXQub3B0aW9ucywKCQkJY28gPSB0aGF0LmNvbnRhaW5lck9mZnNldCwKCQkJY3AgPSB0aGF0LnBvc2l0aW9uLAoJCQlwUmF0aW8gPSB0aGF0Ll9hc3BlY3RSYXRpbyB8fCBldmVudC5zaGlmdEtleSwKCQkJY29wID0gewoJCQkJdG9wOiAwLAoJCQkJbGVmdDogMAoJCQl9LAoJCQljZSA9IHRoYXQuY29udGFpbmVyRWxlbWVudCwKCQkJY29udGludWVSZXNpemUgPSB0cnVlOwoKCQlpZiAoIGNlWyAwIF0gIT09IGRvY3VtZW50ICYmICggL3N0YXRpYy8gKS50ZXN0KCBjZS5jc3MoICJwb3NpdGlvbiIgKSApICkgewoJCQljb3AgPSBjbzsKCQl9CgoJCWlmICggY3AubGVmdCA8ICggdGhhdC5faGVscGVyID8gY28ubGVmdCA6IDAgKSApIHsKCQkJdGhhdC5zaXplLndpZHRoID0gdGhhdC5zaXplLndpZHRoICsKCQkJCSggdGhhdC5faGVscGVyID8KCQkJCQkoIHRoYXQucG9zaXRpb24ubGVmdCAtIGNvLmxlZnQgKSA6CgkJCQkJKCB0aGF0LnBvc2l0aW9uLmxlZnQgLSBjb3AubGVmdCApICk7CgoJCQlpZiAoIHBSYXRpbyApIHsKCQkJCXRoYXQuc2l6ZS5oZWlnaHQgPSB0aGF0LnNpemUud2lkdGggLyB0aGF0LmFzcGVjdFJhdGlvOwoJCQkJY29udGludWVSZXNpemUgPSBmYWxzZTsKCQkJfQoJCQl0aGF0LnBvc2l0aW9uLmxlZnQgPSBvLmhlbHBlciA/IGNvLmxlZnQgOiAwOwoJCX0KCgkJaWYgKCBjcC50b3AgPCAoIHRoYXQuX2hlbHBlciA/IGNvLnRvcCA6IDAgKSApIHsKCQkJdGhhdC5zaXplLmhlaWdodCA9IHRoYXQuc2l6ZS5oZWlnaHQgKwoJCQkJKCB0aGF0Ll9oZWxwZXIgPwoJCQkJCSggdGhhdC5wb3NpdGlvbi50b3AgLSBjby50b3AgKSA6CgkJCQkJdGhhdC5wb3NpdGlvbi50b3AgKTsKCgkJCWlmICggcFJhdGlvICkgewoJCQkJdGhhdC5zaXplLndpZHRoID0gdGhhdC5zaXplLmhlaWdodCAqIHRoYXQuYXNwZWN0UmF0aW87CgkJCQljb250aW51ZVJlc2l6ZSA9IGZhbHNlOwoJCQl9CgkJCXRoYXQucG9zaXRpb24udG9wID0gdGhhdC5faGVscGVyID8gY28udG9wIDogMDsKCQl9CgoJCWlzUGFyZW50ID0gdGhhdC5jb250YWluZXJFbGVtZW50LmdldCggMCApID09PSB0aGF0LmVsZW1lbnQucGFyZW50KCkuZ2V0KCAwICk7CgkJaXNPZmZzZXRSZWxhdGl2ZSA9IC9yZWxhdGl2ZXxhYnNvbHV0ZS8udGVzdCggdGhhdC5jb250YWluZXJFbGVtZW50LmNzcyggInBvc2l0aW9uIiApICk7CgoJCWlmICggaXNQYXJlbnQgJiYgaXNPZmZzZXRSZWxhdGl2ZSApIHsKCQkJdGhhdC5vZmZzZXQubGVmdCA9IHRoYXQucGFyZW50RGF0YS5sZWZ0ICsgdGhhdC5wb3NpdGlvbi5sZWZ0OwoJCQl0aGF0Lm9mZnNldC50b3AgPSB0aGF0LnBhcmVudERhdGEudG9wICsgdGhhdC5wb3NpdGlvbi50b3A7CgkJfSBlbHNlIHsKCQkJdGhhdC5vZmZzZXQubGVmdCA9IHRoYXQuZWxlbWVudC5vZmZzZXQoKS5sZWZ0OwoJCQl0aGF0Lm9mZnNldC50b3AgPSB0aGF0LmVsZW1lbnQub2Zmc2V0KCkudG9wOwoJCX0KCgkJd29zZXQgPSBNYXRoLmFicyggdGhhdC5zaXplRGlmZi53aWR0aCArCgkJCSggdGhhdC5faGVscGVyID8KCQkJCXRoYXQub2Zmc2V0LmxlZnQgLSBjb3AubGVmdCA6CgkJCQkoIHRoYXQub2Zmc2V0LmxlZnQgLSBjby5sZWZ0ICkgKSApOwoKCQlob3NldCA9IE1hdGguYWJzKCB0aGF0LnNpemVEaWZmLmhlaWdodCArCgkJCSggdGhhdC5faGVscGVyID8KCQkJCXRoYXQub2Zmc2V0LnRvcCAtIGNvcC50b3AgOgoJCQkJKCB0aGF0Lm9mZnNldC50b3AgLSBjby50b3AgKSApICk7CgoJCWlmICggd29zZXQgKyB0aGF0LnNpemUud2lkdGggPj0gdGhhdC5wYXJlbnREYXRhLndpZHRoICkgewoJCQl0aGF0LnNpemUud2lkdGggPSB0aGF0LnBhcmVudERhdGEud2lkdGggLSB3b3NldDsKCQkJaWYgKCBwUmF0aW8gKSB7CgkJCQl0aGF0LnNpemUuaGVpZ2h0ID0gdGhhdC5zaXplLndpZHRoIC8gdGhhdC5hc3BlY3RSYXRpbzsKCQkJCWNvbnRpbnVlUmVzaXplID0gZmFsc2U7CgkJCX0KCQl9CgoJCWlmICggaG9zZXQgKyB0aGF0LnNpemUuaGVpZ2h0ID49IHRoYXQucGFyZW50RGF0YS5oZWlnaHQgKSB7CgkJCXRoYXQuc2l6ZS5oZWlnaHQgPSB0aGF0LnBhcmVudERhdGEuaGVpZ2h0IC0gaG9zZXQ7CgkJCWlmICggcFJhdGlvICkgewoJCQkJdGhhdC5zaXplLndpZHRoID0gdGhhdC5zaXplLmhlaWdodCAqIHRoYXQuYXNwZWN0UmF0aW87CgkJCQljb250aW51ZVJlc2l6ZSA9IGZhbHNlOwoJCQl9CgkJfQoKCQlpZiAoICFjb250aW51ZVJlc2l6ZSApIHsKCQkJdGhhdC5wb3NpdGlvbi5sZWZ0ID0gdGhhdC5wcmV2UG9zaXRpb24ubGVmdDsKCQkJdGhhdC5wb3NpdGlvbi50b3AgPSB0aGF0LnByZXZQb3NpdGlvbi50b3A7CgkJCXRoYXQuc2l6ZS53aWR0aCA9IHRoYXQucHJldlNpemUud2lkdGg7CgkJCXRoYXQuc2l6ZS5oZWlnaHQgPSB0aGF0LnByZXZTaXplLmhlaWdodDsKCQl9Cgl9LAoKCXN0b3A6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gJCggdGhpcyApLnJlc2l6YWJsZSggImluc3RhbmNlIiApLAoJCQlvID0gdGhhdC5vcHRpb25zLAoJCQljbyA9IHRoYXQuY29udGFpbmVyT2Zmc2V0LAoJCQljb3AgPSB0aGF0LmNvbnRhaW5lclBvc2l0aW9uLAoJCQljZSA9IHRoYXQuY29udGFpbmVyRWxlbWVudCwKCQkJaGVscGVyID0gJCggdGhhdC5oZWxwZXIgKSwKCQkJaG8gPSBoZWxwZXIub2Zmc2V0KCksCgkJCXcgPSBoZWxwZXIub3V0ZXJXaWR0aCgpIC0gdGhhdC5zaXplRGlmZi53aWR0aCwKCQkJaCA9IGhlbHBlci5vdXRlckhlaWdodCgpIC0gdGhhdC5zaXplRGlmZi5oZWlnaHQ7CgoJCWlmICggdGhhdC5faGVscGVyICYmICFvLmFuaW1hdGUgJiYgKCAvcmVsYXRpdmUvICkudGVzdCggY2UuY3NzKCAicG9zaXRpb24iICkgKSApIHsKCQkJJCggdGhpcyApLmNzcyggewoJCQkJbGVmdDogaG8ubGVmdCAtIGNvcC5sZWZ0IC0gY28ubGVmdCwKCQkJCXdpZHRoOiB3LAoJCQkJaGVpZ2h0OiBoCgkJCX0gKTsKCQl9CgoJCWlmICggdGhhdC5faGVscGVyICYmICFvLmFuaW1hdGUgJiYgKCAvc3RhdGljLyApLnRlc3QoIGNlLmNzcyggInBvc2l0aW9uIiApICkgKSB7CgkJCSQoIHRoaXMgKS5jc3MoIHsKCQkJCWxlZnQ6IGhvLmxlZnQgLSBjb3AubGVmdCAtIGNvLmxlZnQsCgkJCQl3aWR0aDogdywKCQkJCWhlaWdodDogaAoJCQl9ICk7CgkJfQoJfQp9ICk7CgokLnVpLnBsdWdpbi5hZGQoICJyZXNpemFibGUiLCAiYWxzb1Jlc2l6ZSIsIHsKCglzdGFydDogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSAkKCB0aGlzICkucmVzaXphYmxlKCAiaW5zdGFuY2UiICksCgkJCW8gPSB0aGF0Lm9wdGlvbnM7CgoJCSQoIG8uYWxzb1Jlc2l6ZSApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgZWwgPSAkKCB0aGlzICk7CgkJCWVsLmRhdGEoICJ1aS1yZXNpemFibGUtYWxzb3Jlc2l6ZSIsIHsKCQkJCXdpZHRoOiBwYXJzZUZsb2F0KCBlbC53aWR0aCgpICksIGhlaWdodDogcGFyc2VGbG9hdCggZWwuaGVpZ2h0KCkgKSwKCQkJCWxlZnQ6IHBhcnNlRmxvYXQoIGVsLmNzcyggImxlZnQiICkgKSwgdG9wOiBwYXJzZUZsb2F0KCBlbC5jc3MoICJ0b3AiICkgKQoJCQl9ICk7CgkJfSApOwoJfSwKCglyZXNpemU6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJdmFyIHRoYXQgPSAkKCB0aGlzICkucmVzaXphYmxlKCAiaW5zdGFuY2UiICksCgkJCW8gPSB0aGF0Lm9wdGlvbnMsCgkJCW9zID0gdGhhdC5vcmlnaW5hbFNpemUsCgkJCW9wID0gdGhhdC5vcmlnaW5hbFBvc2l0aW9uLAoJCQlkZWx0YSA9IHsKCQkJCWhlaWdodDogKCB0aGF0LnNpemUuaGVpZ2h0IC0gb3MuaGVpZ2h0ICkgfHwgMCwKCQkJCXdpZHRoOiAoIHRoYXQuc2l6ZS53aWR0aCAtIG9zLndpZHRoICkgfHwgMCwKCQkJCXRvcDogKCB0aGF0LnBvc2l0aW9uLnRvcCAtIG9wLnRvcCApIHx8IDAsCgkJCQlsZWZ0OiAoIHRoYXQucG9zaXRpb24ubGVmdCAtIG9wLmxlZnQgKSB8fCAwCgkJCX07CgoJCQkkKCBvLmFsc29SZXNpemUgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBlbCA9ICQoIHRoaXMgKSwgc3RhcnQgPSAkKCB0aGlzICkuZGF0YSggInVpLXJlc2l6YWJsZS1hbHNvcmVzaXplIiApLCBzdHlsZSA9IHt9LAoJCQkJCWNzcyA9IGVsLnBhcmVudHMoIHVpLm9yaWdpbmFsRWxlbWVudFsgMCBdICkubGVuZ3RoID8KCQkJCQkJCVsgIndpZHRoIiwgImhlaWdodCIgXSA6CgkJCQkJCQlbICJ3aWR0aCIsICJoZWlnaHQiLCAidG9wIiwgImxlZnQiIF07CgoJCQkJJC5lYWNoKCBjc3MsIGZ1bmN0aW9uKCBpLCBwcm9wICkgewoJCQkJCXZhciBzdW0gPSAoIHN0YXJ0WyBwcm9wIF0gfHwgMCApICsgKCBkZWx0YVsgcHJvcCBdIHx8IDAgKTsKCQkJCQlpZiAoIHN1bSAmJiBzdW0gPj0gMCApIHsKCQkJCQkJc3R5bGVbIHByb3AgXSA9IHN1bSB8fCBudWxsOwoJCQkJCX0KCQkJCX0gKTsKCgkJCQllbC5jc3MoIHN0eWxlICk7CgkJCX0gKTsKCX0sCgoJc3RvcDogZnVuY3Rpb24oKSB7CgkJJCggdGhpcyApLnJlbW92ZURhdGEoICJ1aS1yZXNpemFibGUtYWxzb3Jlc2l6ZSIgKTsKCX0KfSApOwoKJC51aS5wbHVnaW4uYWRkKCAicmVzaXphYmxlIiwgImdob3N0IiwgewoKCXN0YXJ0OiBmdW5jdGlvbigpIHsKCgkJdmFyIHRoYXQgPSAkKCB0aGlzICkucmVzaXphYmxlKCAiaW5zdGFuY2UiICksIGNzID0gdGhhdC5zaXplOwoKCQl0aGF0Lmdob3N0ID0gdGhhdC5vcmlnaW5hbEVsZW1lbnQuY2xvbmUoKTsKCQl0aGF0Lmdob3N0LmNzcyggewoJCQlvcGFjaXR5OiAwLjI1LAoJCQlkaXNwbGF5OiAiYmxvY2siLAoJCQlwb3NpdGlvbjogInJlbGF0aXZlIiwKCQkJaGVpZ2h0OiBjcy5oZWlnaHQsCgkJCXdpZHRoOiBjcy53aWR0aCwKCQkJbWFyZ2luOiAwLAoJCQlsZWZ0OiAwLAoJCQl0b3A6IDAKCQl9ICk7CgoJCXRoYXQuX2FkZENsYXNzKCB0aGF0Lmdob3N0LCAidWktcmVzaXphYmxlLWdob3N0IiApOwoKCQkvLyBERVBSRUNBVEVECgkJLy8gVE9ETzogcmVtb3ZlIGFmdGVyIDEuMTIKCQlpZiAoICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSAmJiB0eXBlb2YgdGhhdC5vcHRpb25zLmdob3N0ID09PSAic3RyaW5nIiApIHsKCgkJCS8vIEdob3N0IG9wdGlvbgoJCQl0aGF0Lmdob3N0LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuZ2hvc3QgKTsKCQl9CgoJCXRoYXQuZ2hvc3QuYXBwZW5kVG8oIHRoYXQuaGVscGVyICk7CgoJfSwKCglyZXNpemU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gJCggdGhpcyApLnJlc2l6YWJsZSggImluc3RhbmNlIiApOwoJCWlmICggdGhhdC5naG9zdCApIHsKCQkJdGhhdC5naG9zdC5jc3MoIHsKCQkJCXBvc2l0aW9uOiAicmVsYXRpdmUiLAoJCQkJaGVpZ2h0OiB0aGF0LnNpemUuaGVpZ2h0LAoJCQkJd2lkdGg6IHRoYXQuc2l6ZS53aWR0aAoJCQl9ICk7CgkJfQoJfSwKCglzdG9wOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9ICQoIHRoaXMgKS5yZXNpemFibGUoICJpbnN0YW5jZSIgKTsKCQlpZiAoIHRoYXQuZ2hvc3QgJiYgdGhhdC5oZWxwZXIgKSB7CgkJCXRoYXQuaGVscGVyLmdldCggMCApLnJlbW92ZUNoaWxkKCB0aGF0Lmdob3N0LmdldCggMCApICk7CgkJfQoJfQoKfSApOwoKJC51aS5wbHVnaW4uYWRkKCAicmVzaXphYmxlIiwgImdyaWQiLCB7CgoJcmVzaXplOiBmdW5jdGlvbigpIHsKCQl2YXIgb3V0ZXJEaW1lbnNpb25zLAoJCQl0aGF0ID0gJCggdGhpcyApLnJlc2l6YWJsZSggImluc3RhbmNlIiApLAoJCQlvID0gdGhhdC5vcHRpb25zLAoJCQljcyA9IHRoYXQuc2l6ZSwKCQkJb3MgPSB0aGF0Lm9yaWdpbmFsU2l6ZSwKCQkJb3AgPSB0aGF0Lm9yaWdpbmFsUG9zaXRpb24sCgkJCWEgPSB0aGF0LmF4aXMsCgkJCWdyaWQgPSB0eXBlb2Ygby5ncmlkID09PSAibnVtYmVyIiA/IFsgby5ncmlkLCBvLmdyaWQgXSA6IG8uZ3JpZCwKCQkJZ3JpZFggPSAoIGdyaWRbIDAgXSB8fCAxICksCgkJCWdyaWRZID0gKCBncmlkWyAxIF0gfHwgMSApLAoJCQlveCA9IE1hdGgucm91bmQoICggY3Mud2lkdGggLSBvcy53aWR0aCApIC8gZ3JpZFggKSAqIGdyaWRYLAoJCQlveSA9IE1hdGgucm91bmQoICggY3MuaGVpZ2h0IC0gb3MuaGVpZ2h0ICkgLyBncmlkWSApICogZ3JpZFksCgkJCW5ld1dpZHRoID0gb3Mud2lkdGggKyBveCwKCQkJbmV3SGVpZ2h0ID0gb3MuaGVpZ2h0ICsgb3ksCgkJCWlzTWF4V2lkdGggPSBvLm1heFdpZHRoICYmICggby5tYXhXaWR0aCA8IG5ld1dpZHRoICksCgkJCWlzTWF4SGVpZ2h0ID0gby5tYXhIZWlnaHQgJiYgKCBvLm1heEhlaWdodCA8IG5ld0hlaWdodCApLAoJCQlpc01pbldpZHRoID0gby5taW5XaWR0aCAmJiAoIG8ubWluV2lkdGggPiBuZXdXaWR0aCApLAoJCQlpc01pbkhlaWdodCA9IG8ubWluSGVpZ2h0ICYmICggby5taW5IZWlnaHQgPiBuZXdIZWlnaHQgKTsKCgkJby5ncmlkID0gZ3JpZDsKCgkJaWYgKCBpc01pbldpZHRoICkgewoJCQluZXdXaWR0aCArPSBncmlkWDsKCQl9CgkJaWYgKCBpc01pbkhlaWdodCApIHsKCQkJbmV3SGVpZ2h0ICs9IGdyaWRZOwoJCX0KCQlpZiAoIGlzTWF4V2lkdGggKSB7CgkJCW5ld1dpZHRoIC09IGdyaWRYOwoJCX0KCQlpZiAoIGlzTWF4SGVpZ2h0ICkgewoJCQluZXdIZWlnaHQgLT0gZ3JpZFk7CgkJfQoKCQlpZiAoIC9eKHNlfHN8ZSkkLy50ZXN0KCBhICkgKSB7CgkJCXRoYXQuc2l6ZS53aWR0aCA9IG5ld1dpZHRoOwoJCQl0aGF0LnNpemUuaGVpZ2h0ID0gbmV3SGVpZ2h0OwoJCX0gZWxzZSBpZiAoIC9eKG5lKSQvLnRlc3QoIGEgKSApIHsKCQkJdGhhdC5zaXplLndpZHRoID0gbmV3V2lkdGg7CgkJCXRoYXQuc2l6ZS5oZWlnaHQgPSBuZXdIZWlnaHQ7CgkJCXRoYXQucG9zaXRpb24udG9wID0gb3AudG9wIC0gb3k7CgkJfSBlbHNlIGlmICggL14oc3cpJC8udGVzdCggYSApICkgewoJCQl0aGF0LnNpemUud2lkdGggPSBuZXdXaWR0aDsKCQkJdGhhdC5zaXplLmhlaWdodCA9IG5ld0hlaWdodDsKCQkJdGhhdC5wb3NpdGlvbi5sZWZ0ID0gb3AubGVmdCAtIG94OwoJCX0gZWxzZSB7CgkJCWlmICggbmV3SGVpZ2h0IC0gZ3JpZFkgPD0gMCB8fCBuZXdXaWR0aCAtIGdyaWRYIDw9IDAgKSB7CgkJCQlvdXRlckRpbWVuc2lvbnMgPSB0aGF0Ll9nZXRQYWRkaW5nUGx1c0JvcmRlckRpbWVuc2lvbnMoIHRoaXMgKTsKCQkJfQoKCQkJaWYgKCBuZXdIZWlnaHQgLSBncmlkWSA+IDAgKSB7CgkJCQl0aGF0LnNpemUuaGVpZ2h0ID0gbmV3SGVpZ2h0OwoJCQkJdGhhdC5wb3NpdGlvbi50b3AgPSBvcC50b3AgLSBveTsKCQkJfSBlbHNlIHsKCQkJCW5ld0hlaWdodCA9IGdyaWRZIC0gb3V0ZXJEaW1lbnNpb25zLmhlaWdodDsKCQkJCXRoYXQuc2l6ZS5oZWlnaHQgPSBuZXdIZWlnaHQ7CgkJCQl0aGF0LnBvc2l0aW9uLnRvcCA9IG9wLnRvcCArIG9zLmhlaWdodCAtIG5ld0hlaWdodDsKCQkJfQoJCQlpZiAoIG5ld1dpZHRoIC0gZ3JpZFggPiAwICkgewoJCQkJdGhhdC5zaXplLndpZHRoID0gbmV3V2lkdGg7CgkJCQl0aGF0LnBvc2l0aW9uLmxlZnQgPSBvcC5sZWZ0IC0gb3g7CgkJCX0gZWxzZSB7CgkJCQluZXdXaWR0aCA9IGdyaWRYIC0gb3V0ZXJEaW1lbnNpb25zLndpZHRoOwoJCQkJdGhhdC5zaXplLndpZHRoID0gbmV3V2lkdGg7CgkJCQl0aGF0LnBvc2l0aW9uLmxlZnQgPSBvcC5sZWZ0ICsgb3Mud2lkdGggLSBuZXdXaWR0aDsKCQkJfQoJCX0KCX0KCn0gKTsKCnZhciB3aWRnZXRzUmVzaXphYmxlID0gJC51aS5yZXNpemFibGU7CgoKLyohCiAqIGpRdWVyeSBVSSBTZWxlY3RhYmxlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogU2VsZWN0YWJsZQovLz4+Z3JvdXA6IEludGVyYWN0aW9ucwovLz4+ZGVzY3JpcHRpb246IEFsbG93cyBncm91cHMgb2YgZWxlbWVudHMgdG8gYmUgc2VsZWN0ZWQgd2l0aCB0aGUgbW91c2UuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9zZWxlY3RhYmxlLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vc2VsZWN0YWJsZS8KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3NlbGVjdGFibGUuY3NzCgoKCnZhciB3aWRnZXRzU2VsZWN0YWJsZSA9ICQud2lkZ2V0KCAidWkuc2VsZWN0YWJsZSIsICQudWkubW91c2UsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJb3B0aW9uczogewoJCWFwcGVuZFRvOiAiYm9keSIsCgkJYXV0b1JlZnJlc2g6IHRydWUsCgkJZGlzdGFuY2U6IDAsCgkJZmlsdGVyOiAiKiIsCgkJdG9sZXJhbmNlOiAidG91Y2giLAoKCQkvLyBDYWxsYmFja3MKCQlzZWxlY3RlZDogbnVsbCwKCQlzZWxlY3Rpbmc6IG51bGwsCgkJc3RhcnQ6IG51bGwsCgkJc3RvcDogbnVsbCwKCQl1bnNlbGVjdGVkOiBudWxsLAoJCXVuc2VsZWN0aW5nOiBudWxsCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQl0aGlzLl9hZGRDbGFzcyggInVpLXNlbGVjdGFibGUiICk7CgoJCXRoaXMuZHJhZ2dlZCA9IGZhbHNlOwoKCQkvLyBDYWNoZSBzZWxlY3RlZSBjaGlsZHJlbiBiYXNlZCBvbiBmaWx0ZXIKCQl0aGlzLnJlZnJlc2ggPSBmdW5jdGlvbigpIHsKCQkJdGhhdC5lbGVtZW50UG9zID0gJCggdGhhdC5lbGVtZW50WyAwIF0gKS5vZmZzZXQoKTsKCQkJdGhhdC5zZWxlY3RlZXMgPSAkKCB0aGF0Lm9wdGlvbnMuZmlsdGVyLCB0aGF0LmVsZW1lbnRbIDAgXSApOwoJCQl0aGF0Ll9hZGRDbGFzcyggdGhhdC5zZWxlY3RlZXMsICJ1aS1zZWxlY3RlZSIgKTsKCQkJdGhhdC5zZWxlY3RlZXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJc2VsZWN0ZWVPZmZzZXQgPSAkdGhpcy5vZmZzZXQoKSwKCQkJCQlwb3MgPSB7CgkJCQkJCWxlZnQ6IHNlbGVjdGVlT2Zmc2V0LmxlZnQgLSB0aGF0LmVsZW1lbnRQb3MubGVmdCwKCQkJCQkJdG9wOiBzZWxlY3RlZU9mZnNldC50b3AgLSB0aGF0LmVsZW1lbnRQb3MudG9wCgkJCQkJfTsKCQkJCSQuZGF0YSggdGhpcywgInNlbGVjdGFibGUtaXRlbSIsIHsKCQkJCQllbGVtZW50OiB0aGlzLAoJCQkJCSRlbGVtZW50OiAkdGhpcywKCQkJCQlsZWZ0OiBwb3MubGVmdCwKCQkJCQl0b3A6IHBvcy50b3AsCgkJCQkJcmlnaHQ6IHBvcy5sZWZ0ICsgJHRoaXMub3V0ZXJXaWR0aCgpLAoJCQkJCWJvdHRvbTogcG9zLnRvcCArICR0aGlzLm91dGVySGVpZ2h0KCksCgkJCQkJc3RhcnRzZWxlY3RlZDogZmFsc2UsCgkJCQkJc2VsZWN0ZWQ6ICR0aGlzLmhhc0NsYXNzKCAidWktc2VsZWN0ZWQiICksCgkJCQkJc2VsZWN0aW5nOiAkdGhpcy5oYXNDbGFzcyggInVpLXNlbGVjdGluZyIgKSwKCQkJCQl1bnNlbGVjdGluZzogJHRoaXMuaGFzQ2xhc3MoICJ1aS11bnNlbGVjdGluZyIgKQoJCQkJfSApOwoJCQl9ICk7CgkJfTsKCQl0aGlzLnJlZnJlc2goKTsKCgkJdGhpcy5fbW91c2VJbml0KCk7CgoJCXRoaXMuaGVscGVyID0gJCggIjxkaXY+IiApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmhlbHBlciwgInVpLXNlbGVjdGFibGUtaGVscGVyIiApOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZWxlY3RlZXMucmVtb3ZlRGF0YSggInNlbGVjdGFibGUtaXRlbSIgKTsKCQl0aGlzLl9tb3VzZURlc3Ryb3koKTsKCX0sCgoJX21vdXNlU3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCXRoaXMub3BvcyA9IFsgZXZlbnQucGFnZVgsIGV2ZW50LnBhZ2VZIF07CgkJdGhpcy5lbGVtZW50UG9zID0gJCggdGhpcy5lbGVtZW50WyAwIF0gKS5vZmZzZXQoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuc2VsZWN0ZWVzID0gJCggb3B0aW9ucy5maWx0ZXIsIHRoaXMuZWxlbWVudFsgMCBdICk7CgoJCXRoaXMuX3RyaWdnZXIoICJzdGFydCIsIGV2ZW50ICk7CgoJCSQoIG9wdGlvbnMuYXBwZW5kVG8gKS5hcHBlbmQoIHRoaXMuaGVscGVyICk7CgoJCS8vIHBvc2l0aW9uIGhlbHBlciAobGFzc28pCgkJdGhpcy5oZWxwZXIuY3NzKCB7CgkJCSJsZWZ0IjogZXZlbnQucGFnZVgsCgkJCSJ0b3AiOiBldmVudC5wYWdlWSwKCQkJIndpZHRoIjogMCwKCQkJImhlaWdodCI6IDAKCQl9ICk7CgoJCWlmICggb3B0aW9ucy5hdXRvUmVmcmVzaCApIHsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfQoKCQl0aGlzLnNlbGVjdGVlcy5maWx0ZXIoICIudWktc2VsZWN0ZWQiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxlY3RlZSA9ICQuZGF0YSggdGhpcywgInNlbGVjdGFibGUtaXRlbSIgKTsKCQkJc2VsZWN0ZWUuc3RhcnRzZWxlY3RlZCA9IHRydWU7CgkJCWlmICggIWV2ZW50Lm1ldGFLZXkgJiYgIWV2ZW50LmN0cmxLZXkgKSB7CgkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RlZCIgKTsKCQkJCXNlbGVjdGVlLnNlbGVjdGVkID0gZmFsc2U7CgkJCQl0aGF0Ll9hZGRDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS11bnNlbGVjdGluZyIgKTsKCQkJCXNlbGVjdGVlLnVuc2VsZWN0aW5nID0gdHJ1ZTsKCgkJCQkvLyBzZWxlY3RhYmxlIFVOU0VMRUNUSU5HIGNhbGxiYWNrCgkJCQl0aGF0Ll90cmlnZ2VyKCAidW5zZWxlY3RpbmciLCBldmVudCwgewoJCQkJCXVuc2VsZWN0aW5nOiBzZWxlY3RlZS5lbGVtZW50CgkJCQl9ICk7CgkJCX0KCQl9ICk7CgoJCSQoIGV2ZW50LnRhcmdldCApLnBhcmVudHMoKS5hZGRCYWNrKCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBkb1NlbGVjdCwKCQkJCXNlbGVjdGVlID0gJC5kYXRhKCB0aGlzLCAic2VsZWN0YWJsZS1pdGVtIiApOwoJCQlpZiAoIHNlbGVjdGVlICkgewoJCQkJZG9TZWxlY3QgPSAoICFldmVudC5tZXRhS2V5ICYmICFldmVudC5jdHJsS2V5ICkgfHwKCQkJCQkhc2VsZWN0ZWUuJGVsZW1lbnQuaGFzQ2xhc3MoICJ1aS1zZWxlY3RlZCIgKTsKCQkJCXRoYXQuX3JlbW92ZUNsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgZG9TZWxlY3QgPyAidWktdW5zZWxlY3RpbmciIDogInVpLXNlbGVjdGVkIiApCgkJCQkJLl9hZGRDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsIGRvU2VsZWN0ID8gInVpLXNlbGVjdGluZyIgOiAidWktdW5zZWxlY3RpbmciICk7CgkJCQlzZWxlY3RlZS51bnNlbGVjdGluZyA9ICFkb1NlbGVjdDsKCQkJCXNlbGVjdGVlLnNlbGVjdGluZyA9IGRvU2VsZWN0OwoJCQkJc2VsZWN0ZWUuc2VsZWN0ZWQgPSBkb1NlbGVjdDsKCgkJCQkvLyBzZWxlY3RhYmxlIChVTilTRUxFQ1RJTkcgY2FsbGJhY2sKCQkJCWlmICggZG9TZWxlY3QgKSB7CgkJCQkJdGhhdC5fdHJpZ2dlciggInNlbGVjdGluZyIsIGV2ZW50LCB7CgkJCQkJCXNlbGVjdGluZzogc2VsZWN0ZWUuZWxlbWVudAoJCQkJCX0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhhdC5fdHJpZ2dlciggInVuc2VsZWN0aW5nIiwgZXZlbnQsIHsKCQkJCQkJdW5zZWxlY3Rpbmc6IHNlbGVjdGVlLmVsZW1lbnQKCQkJCQl9ICk7CgkJCQl9CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9ICk7CgoJfSwKCglfbW91c2VEcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCXRoaXMuZHJhZ2dlZCA9IHRydWU7CgoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgdG1wLAoJCQl0aGF0ID0gdGhpcywKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJeDEgPSB0aGlzLm9wb3NbIDAgXSwKCQkJeTEgPSB0aGlzLm9wb3NbIDEgXSwKCQkJeDIgPSBldmVudC5wYWdlWCwKCQkJeTIgPSBldmVudC5wYWdlWTsKCgkJaWYgKCB4MSA+IHgyICkgeyB0bXAgPSB4MjsgeDIgPSB4MTsgeDEgPSB0bXA7IH0KCQlpZiAoIHkxID4geTIgKSB7IHRtcCA9IHkyOyB5MiA9IHkxOyB5MSA9IHRtcDsgfQoJCXRoaXMuaGVscGVyLmNzcyggeyBsZWZ0OiB4MSwgdG9wOiB5MSwgd2lkdGg6IHgyIC0geDEsIGhlaWdodDogeTIgLSB5MSB9ICk7CgoJCXRoaXMuc2VsZWN0ZWVzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZWN0ZWUgPSAkLmRhdGEoIHRoaXMsICJzZWxlY3RhYmxlLWl0ZW0iICksCgkJCQloaXQgPSBmYWxzZSwKCQkJCW9mZnNldCA9IHt9OwoKCQkJLy9wcmV2ZW50IGhlbHBlciBmcm9tIGJlaW5nIHNlbGVjdGVkIGlmIGFwcGVuZFRvOiBzZWxlY3RhYmxlCgkJCWlmICggIXNlbGVjdGVlIHx8IHNlbGVjdGVlLmVsZW1lbnQgPT09IHRoYXQuZWxlbWVudFsgMCBdICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlvZmZzZXQubGVmdCAgID0gc2VsZWN0ZWUubGVmdCAgICsgdGhhdC5lbGVtZW50UG9zLmxlZnQ7CgkJCW9mZnNldC5yaWdodCAgPSBzZWxlY3RlZS5yaWdodCAgKyB0aGF0LmVsZW1lbnRQb3MubGVmdDsKCQkJb2Zmc2V0LnRvcCAgICA9IHNlbGVjdGVlLnRvcCAgICArIHRoYXQuZWxlbWVudFBvcy50b3A7CgkJCW9mZnNldC5ib3R0b20gPSBzZWxlY3RlZS5ib3R0b20gKyB0aGF0LmVsZW1lbnRQb3MudG9wOwoKCQkJaWYgKCBvcHRpb25zLnRvbGVyYW5jZSA9PT0gInRvdWNoIiApIHsKCQkJCWhpdCA9ICggISggb2Zmc2V0LmxlZnQgPiB4MiB8fCBvZmZzZXQucmlnaHQgPCB4MSB8fCBvZmZzZXQudG9wID4geTIgfHwKICAgICAgICAgICAgICAgICAgICBvZmZzZXQuYm90dG9tIDwgeTEgKSApOwoJCQl9IGVsc2UgaWYgKCBvcHRpb25zLnRvbGVyYW5jZSA9PT0gImZpdCIgKSB7CgkJCQloaXQgPSAoIG9mZnNldC5sZWZ0ID4geDEgJiYgb2Zmc2V0LnJpZ2h0IDwgeDIgJiYgb2Zmc2V0LnRvcCA+IHkxICYmCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LmJvdHRvbSA8IHkyICk7CgkJCX0KCgkJCWlmICggaGl0ICkgewoKCQkJCS8vIFNFTEVDVAoJCQkJaWYgKCBzZWxlY3RlZS5zZWxlY3RlZCApIHsKCQkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RlZCIgKTsKCQkJCQlzZWxlY3RlZS5zZWxlY3RlZCA9IGZhbHNlOwoJCQkJfQoJCQkJaWYgKCBzZWxlY3RlZS51bnNlbGVjdGluZyApIHsKCQkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS11bnNlbGVjdGluZyIgKTsKCQkJCQlzZWxlY3RlZS51bnNlbGVjdGluZyA9IGZhbHNlOwoJCQkJfQoJCQkJaWYgKCAhc2VsZWN0ZWUuc2VsZWN0aW5nICkgewoJCQkJCXRoYXQuX2FkZENsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgInVpLXNlbGVjdGluZyIgKTsKCQkJCQlzZWxlY3RlZS5zZWxlY3RpbmcgPSB0cnVlOwoKCQkJCQkvLyBzZWxlY3RhYmxlIFNFTEVDVElORyBjYWxsYmFjawoJCQkJCXRoYXQuX3RyaWdnZXIoICJzZWxlY3RpbmciLCBldmVudCwgewoJCQkJCQlzZWxlY3Rpbmc6IHNlbGVjdGVlLmVsZW1lbnQKCQkJCQl9ICk7CgkJCQl9CgkJCX0gZWxzZSB7CgoJCQkJLy8gVU5TRUxFQ1QKCQkJCWlmICggc2VsZWN0ZWUuc2VsZWN0aW5nICkgewoJCQkJCWlmICggKCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LmN0cmxLZXkgKSAmJiBzZWxlY3RlZS5zdGFydHNlbGVjdGVkICkgewoJCQkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RpbmciICk7CgkJCQkJCXNlbGVjdGVlLnNlbGVjdGluZyA9IGZhbHNlOwoJCQkJCQl0aGF0Ll9hZGRDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RlZCIgKTsKCQkJCQkJc2VsZWN0ZWUuc2VsZWN0ZWQgPSB0cnVlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoYXQuX3JlbW92ZUNsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgInVpLXNlbGVjdGluZyIgKTsKCQkJCQkJc2VsZWN0ZWUuc2VsZWN0aW5nID0gZmFsc2U7CgkJCQkJCWlmICggc2VsZWN0ZWUuc3RhcnRzZWxlY3RlZCApIHsKCQkJCQkJCXRoYXQuX2FkZENsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgInVpLXVuc2VsZWN0aW5nIiApOwoJCQkJCQkJc2VsZWN0ZWUudW5zZWxlY3RpbmcgPSB0cnVlOwoJCQkJCQl9CgoJCQkJCQkvLyBzZWxlY3RhYmxlIFVOU0VMRUNUSU5HIGNhbGxiYWNrCgkJCQkJCXRoYXQuX3RyaWdnZXIoICJ1bnNlbGVjdGluZyIsIGV2ZW50LCB7CgkJCQkJCQl1bnNlbGVjdGluZzogc2VsZWN0ZWUuZWxlbWVudAoJCQkJCQl9ICk7CgkJCQkJfQoJCQkJfQoJCQkJaWYgKCBzZWxlY3RlZS5zZWxlY3RlZCApIHsKCQkJCQlpZiAoICFldmVudC5tZXRhS2V5ICYmICFldmVudC5jdHJsS2V5ICYmICFzZWxlY3RlZS5zdGFydHNlbGVjdGVkICkgewoJCQkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RlZCIgKTsKCQkJCQkJc2VsZWN0ZWUuc2VsZWN0ZWQgPSBmYWxzZTsKCgkJCQkJCXRoYXQuX2FkZENsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgInVpLXVuc2VsZWN0aW5nIiApOwoJCQkJCQlzZWxlY3RlZS51bnNlbGVjdGluZyA9IHRydWU7CgoJCQkJCQkvLyBzZWxlY3RhYmxlIFVOU0VMRUNUSU5HIGNhbGxiYWNrCgkJCQkJCXRoYXQuX3RyaWdnZXIoICJ1bnNlbGVjdGluZyIsIGV2ZW50LCB7CgkJCQkJCQl1bnNlbGVjdGluZzogc2VsZWN0ZWUuZWxlbWVudAoJCQkJCQl9ICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSApOwoKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9tb3VzZVN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCXRoaXMuZHJhZ2dlZCA9IGZhbHNlOwoKCQkkKCAiLnVpLXVuc2VsZWN0aW5nIiwgdGhpcy5lbGVtZW50WyAwIF0gKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGVjdGVlID0gJC5kYXRhKCB0aGlzLCAic2VsZWN0YWJsZS1pdGVtIiApOwoJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS11bnNlbGVjdGluZyIgKTsKCQkJc2VsZWN0ZWUudW5zZWxlY3RpbmcgPSBmYWxzZTsKCQkJc2VsZWN0ZWUuc3RhcnRzZWxlY3RlZCA9IGZhbHNlOwoJCQl0aGF0Ll90cmlnZ2VyKCAidW5zZWxlY3RlZCIsIGV2ZW50LCB7CgkJCQl1bnNlbGVjdGVkOiBzZWxlY3RlZS5lbGVtZW50CgkJCX0gKTsKCQl9ICk7CgkJJCggIi51aS1zZWxlY3RpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZWN0ZWUgPSAkLmRhdGEoIHRoaXMsICJzZWxlY3RhYmxlLWl0ZW0iICk7CgkJCXRoYXQuX3JlbW92ZUNsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgInVpLXNlbGVjdGluZyIgKQoJCQkJLl9hZGRDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RlZCIgKTsKCQkJc2VsZWN0ZWUuc2VsZWN0aW5nID0gZmFsc2U7CgkJCXNlbGVjdGVlLnNlbGVjdGVkID0gdHJ1ZTsKCQkJc2VsZWN0ZWUuc3RhcnRzZWxlY3RlZCA9IHRydWU7CgkJCXRoYXQuX3RyaWdnZXIoICJzZWxlY3RlZCIsIGV2ZW50LCB7CgkJCQlzZWxlY3RlZDogc2VsZWN0ZWUuZWxlbWVudAoJCQl9ICk7CgkJfSApOwoJCXRoaXMuX3RyaWdnZXIoICJzdG9wIiwgZXZlbnQgKTsKCgkJdGhpcy5oZWxwZXIucmVtb3ZlKCk7CgoJCXJldHVybiBmYWxzZTsKCX0KCn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIFNvcnRhYmxlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogU29ydGFibGUKLy8+Pmdyb3VwOiBJbnRlcmFjdGlvbnMKLy8+PmRlc2NyaXB0aW9uOiBFbmFibGVzIGl0ZW1zIGluIGEgbGlzdCB0byBiZSBzb3J0ZWQgdXNpbmcgdGhlIG1vdXNlLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc29ydGFibGUvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9zb3J0YWJsZS8KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3NvcnRhYmxlLmNzcwoKCgp2YXIgd2lkZ2V0c1NvcnRhYmxlID0gJC53aWRnZXQoICJ1aS5zb3J0YWJsZSIsICQudWkubW91c2UsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzb3J0IiwKCXJlYWR5OiBmYWxzZSwKCW9wdGlvbnM6IHsKCQlhcHBlbmRUbzogInBhcmVudCIsCgkJYXhpczogZmFsc2UsCgkJY29ubmVjdFdpdGg6IGZhbHNlLAoJCWNvbnRhaW5tZW50OiBmYWxzZSwKCQljdXJzb3I6ICJhdXRvIiwKCQljdXJzb3JBdDogZmFsc2UsCgkJZHJvcE9uRW1wdHk6IHRydWUsCgkJZm9yY2VQbGFjZWhvbGRlclNpemU6IGZhbHNlLAoJCWZvcmNlSGVscGVyU2l6ZTogZmFsc2UsCgkJZ3JpZDogZmFsc2UsCgkJaGFuZGxlOiBmYWxzZSwKCQloZWxwZXI6ICJvcmlnaW5hbCIsCgkJaXRlbXM6ICI+ICoiLAoJCW9wYWNpdHk6IGZhbHNlLAoJCXBsYWNlaG9sZGVyOiBmYWxzZSwKCQlyZXZlcnQ6IGZhbHNlLAoJCXNjcm9sbDogdHJ1ZSwKCQlzY3JvbGxTZW5zaXRpdml0eTogMjAsCgkJc2Nyb2xsU3BlZWQ6IDIwLAoJCXNjb3BlOiAiZGVmYXVsdCIsCgkJdG9sZXJhbmNlOiAiaW50ZXJzZWN0IiwKCQl6SW5kZXg6IDEwMDAsCgoJCS8vIENhbGxiYWNrcwoJCWFjdGl2YXRlOiBudWxsLAoJCWJlZm9yZVN0b3A6IG51bGwsCgkJY2hhbmdlOiBudWxsLAoJCWRlYWN0aXZhdGU6IG51bGwsCgkJb3V0OiBudWxsLAoJCW92ZXI6IG51bGwsCgkJcmVjZWl2ZTogbnVsbCwKCQlyZW1vdmU6IG51bGwsCgkJc29ydDogbnVsbCwKCQlzdGFydDogbnVsbCwKCQlzdG9wOiBudWxsLAoJCXVwZGF0ZTogbnVsbAoJfSwKCglfaXNPdmVyQXhpczogZnVuY3Rpb24oIHgsIHJlZmVyZW5jZSwgc2l6ZSApIHsKCQlyZXR1cm4gKCB4ID49IHJlZmVyZW5jZSApICYmICggeCA8ICggcmVmZXJlbmNlICsgc2l6ZSApICk7Cgl9LAoKCV9pc0Zsb2F0aW5nOiBmdW5jdGlvbiggaXRlbSApIHsKCQlyZXR1cm4gKCAvbGVmdHxyaWdodC8gKS50ZXN0KCBpdGVtLmNzcyggImZsb2F0IiApICkgfHwKCQkJKCAvaW5saW5lfHRhYmxlLWNlbGwvICkudGVzdCggaXRlbS5jc3MoICJkaXNwbGF5IiApICk7Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuY29udGFpbmVyQ2FjaGUgPSB7fTsKCQl0aGlzLl9hZGRDbGFzcyggInVpLXNvcnRhYmxlIiApOwoKCQkvL0dldCB0aGUgaXRlbXMKCQl0aGlzLnJlZnJlc2goKTsKCgkJLy9MZXQncyBkZXRlcm1pbmUgdGhlIHBhcmVudCdzIG9mZnNldAoJCXRoaXMub2Zmc2V0ID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpOwoKCQkvL0luaXRpYWxpemUgbW91c2UgZXZlbnRzIGZvciBpbnRlcmFjdGlvbgoJCXRoaXMuX21vdXNlSW5pdCgpOwoKCQl0aGlzLl9zZXRIYW5kbGVDbGFzc05hbWUoKTsKCgkJLy9XZSdyZSByZWFkeSB0byBnbwoJCXRoaXMucmVhZHkgPSB0cnVlOwoKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCgkJaWYgKCBrZXkgPT09ICJoYW5kbGUiICkgewoJCQl0aGlzLl9zZXRIYW5kbGVDbGFzc05hbWUoKTsKCQl9Cgl9LAoKCV9zZXRIYW5kbGVDbGFzc05hbWU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpczsKCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5lbGVtZW50LmZpbmQoICIudWktc29ydGFibGUtaGFuZGxlIiApLCAidWktc29ydGFibGUtaGFuZGxlIiApOwoJCSQuZWFjaCggdGhpcy5pdGVtcywgZnVuY3Rpb24oKSB7CgkJCXRoYXQuX2FkZENsYXNzKAoJCQkJdGhpcy5pbnN0YW5jZS5vcHRpb25zLmhhbmRsZSA/CgkJCQkJdGhpcy5pdGVtLmZpbmQoIHRoaXMuaW5zdGFuY2Uub3B0aW9ucy5oYW5kbGUgKSA6CgkJCQkJdGhpcy5pdGVtLAoJCQkJInVpLXNvcnRhYmxlLWhhbmRsZSIKCQkJKTsKCQl9ICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9tb3VzZURlc3Ryb3koKTsKCgkJZm9yICggdmFyIGkgPSB0aGlzLml0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQl0aGlzLml0ZW1zWyBpIF0uaXRlbS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldE5hbWUgKyAiLWl0ZW0iICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX21vdXNlQ2FwdHVyZTogZnVuY3Rpb24oIGV2ZW50LCBvdmVycmlkZUhhbmRsZSApIHsKCQl2YXIgY3VycmVudEl0ZW0gPSBudWxsLAoJCQl2YWxpZEhhbmRsZSA9IGZhbHNlLAoJCQl0aGF0ID0gdGhpczsKCgkJaWYgKCB0aGlzLnJldmVydGluZyApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5vcHRpb25zLnR5cGUgPT09ICJzdGF0aWMiICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvL1dlIGhhdmUgdG8gcmVmcmVzaCB0aGUgaXRlbXMgZGF0YSBvbmNlIGZpcnN0CgkJdGhpcy5fcmVmcmVzaEl0ZW1zKCBldmVudCApOwoKCQkvL0ZpbmQgb3V0IGlmIHRoZSBjbGlja2VkIG5vZGUgKG9yIG9uZSBvZiBpdHMgcGFyZW50cykgaXMgYSBhY3R1YWwgaXRlbSBpbiB0aGlzLml0ZW1zCgkJJCggZXZlbnQudGFyZ2V0ICkucGFyZW50cygpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlpZiAoICQuZGF0YSggdGhpcywgdGhhdC53aWRnZXROYW1lICsgIi1pdGVtIiApID09PSB0aGF0ICkgewoJCQkJY3VycmVudEl0ZW0gPSAkKCB0aGlzICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9ICk7CgkJaWYgKCAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdGhhdC53aWRnZXROYW1lICsgIi1pdGVtIiApID09PSB0aGF0ICkgewoJCQljdXJyZW50SXRlbSA9ICQoIGV2ZW50LnRhcmdldCApOwoJCX0KCgkJaWYgKCAhY3VycmVudEl0ZW0gKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCB0aGlzLm9wdGlvbnMuaGFuZGxlICYmICFvdmVycmlkZUhhbmRsZSApIHsKCQkJJCggdGhpcy5vcHRpb25zLmhhbmRsZSwgY3VycmVudEl0ZW0gKS5maW5kKCAiKiIgKS5hZGRCYWNrKCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQl2YWxpZEhhbmRsZSA9IHRydWU7CgkJCQl9CgkJCX0gKTsKCQkJaWYgKCAhdmFsaWRIYW5kbGUgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9CgoJCXRoaXMuY3VycmVudEl0ZW0gPSBjdXJyZW50SXRlbTsKCQl0aGlzLl9yZW1vdmVDdXJyZW50c0Zyb21JdGVtcygpOwoJCXJldHVybiB0cnVlOwoKCX0sCgoJX21vdXNlU3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgb3ZlcnJpZGVIYW5kbGUsIG5vQWN0aXZhdGlvbiApIHsKCgkJdmFyIGksIGJvZHksCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCXRoaXMuY3VycmVudENvbnRhaW5lciA9IHRoaXM7CgoJCS8vV2Ugb25seSBuZWVkIHRvIGNhbGwgcmVmcmVzaFBvc2l0aW9ucywgYmVjYXVzZSB0aGUgcmVmcmVzaEl0ZW1zIGNhbGwgaGFzIGJlZW4gbW92ZWQgdG8KCQkvLyBtb3VzZUNhcHR1cmUKCQl0aGlzLnJlZnJlc2hQb3NpdGlvbnMoKTsKCgkJLy9DcmVhdGUgYW5kIGFwcGVuZCB0aGUgdmlzaWJsZSBoZWxwZXIKCQl0aGlzLmhlbHBlciA9IHRoaXMuX2NyZWF0ZUhlbHBlciggZXZlbnQgKTsKCgkJLy9DYWNoZSB0aGUgaGVscGVyIHNpemUKCQl0aGlzLl9jYWNoZUhlbHBlclByb3BvcnRpb25zKCk7CgoJCS8qCgkJICogLSBQb3NpdGlvbiBnZW5lcmF0aW9uIC0KCQkgKiBUaGlzIGJsb2NrIGdlbmVyYXRlcyBldmVyeXRoaW5nIHBvc2l0aW9uIHJlbGF0ZWQgLSBpdCdzIHRoZSBjb3JlIG9mIGRyYWdnYWJsZXMuCgkJICovCgoJCS8vQ2FjaGUgdGhlIG1hcmdpbnMgb2YgdGhlIG9yaWdpbmFsIGVsZW1lbnQKCQl0aGlzLl9jYWNoZU1hcmdpbnMoKTsKCgkJLy9HZXQgdGhlIG5leHQgc2Nyb2xsaW5nIHBhcmVudAoJCXRoaXMuc2Nyb2xsUGFyZW50ID0gdGhpcy5oZWxwZXIuc2Nyb2xsUGFyZW50KCk7CgoJCS8vVGhlIGVsZW1lbnQncyBhYnNvbHV0ZSBwb3NpdGlvbiBvbiB0aGUgcGFnZSBtaW51cyBtYXJnaW5zCgkJdGhpcy5vZmZzZXQgPSB0aGlzLmN1cnJlbnRJdGVtLm9mZnNldCgpOwoJCXRoaXMub2Zmc2V0ID0gewoJCQl0b3A6IHRoaXMub2Zmc2V0LnRvcCAtIHRoaXMubWFyZ2lucy50b3AsCgkJCWxlZnQ6IHRoaXMub2Zmc2V0LmxlZnQgLSB0aGlzLm1hcmdpbnMubGVmdAoJCX07CgoJCSQuZXh0ZW5kKCB0aGlzLm9mZnNldCwgewoJCQljbGljazogeyAvL1doZXJlIHRoZSBjbGljayBoYXBwZW5lZCwgcmVsYXRpdmUgdG8gdGhlIGVsZW1lbnQKCQkJCWxlZnQ6IGV2ZW50LnBhZ2VYIC0gdGhpcy5vZmZzZXQubGVmdCwKCQkJCXRvcDogZXZlbnQucGFnZVkgLSB0aGlzLm9mZnNldC50b3AKCQkJfSwKCQkJcGFyZW50OiB0aGlzLl9nZXRQYXJlbnRPZmZzZXQoKSwKCgkJCS8vIFRoaXMgaXMgYSByZWxhdGl2ZSB0byBhYnNvbHV0ZSBwb3NpdGlvbiBtaW51cyB0aGUgYWN0dWFsIHBvc2l0aW9uIGNhbGN1bGF0aW9uIC0KCQkJLy8gb25seSB1c2VkIGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIGhlbHBlcgoJCQlyZWxhdGl2ZTogdGhpcy5fZ2V0UmVsYXRpdmVPZmZzZXQoKQoJCX0gKTsKCgkJLy8gT25seSBhZnRlciB3ZSBnb3QgdGhlIG9mZnNldCwgd2UgY2FuIGNoYW5nZSB0aGUgaGVscGVyJ3MgcG9zaXRpb24gdG8gYWJzb2x1dGUKCQkvLyBUT0RPOiBTdGlsbCBuZWVkIHRvIGZpZ3VyZSBvdXQgYSB3YXkgdG8gbWFrZSByZWxhdGl2ZSBzb3J0aW5nIHBvc3NpYmxlCgkJdGhpcy5oZWxwZXIuY3NzKCAicG9zaXRpb24iLCAiYWJzb2x1dGUiICk7CgkJdGhpcy5jc3NQb3NpdGlvbiA9IHRoaXMuaGVscGVyLmNzcyggInBvc2l0aW9uIiApOwoKCQkvL0dlbmVyYXRlIHRoZSBvcmlnaW5hbCBwb3NpdGlvbgoJCXRoaXMub3JpZ2luYWxQb3NpdGlvbiA9IHRoaXMuX2dlbmVyYXRlUG9zaXRpb24oIGV2ZW50ICk7CgkJdGhpcy5vcmlnaW5hbFBhZ2VYID0gZXZlbnQucGFnZVg7CgkJdGhpcy5vcmlnaW5hbFBhZ2VZID0gZXZlbnQucGFnZVk7CgoJCS8vQWRqdXN0IHRoZSBtb3VzZSBvZmZzZXQgcmVsYXRpdmUgdG8gdGhlIGhlbHBlciBpZiAiY3Vyc29yQXQiIGlzIHN1cHBsaWVkCgkJKCBvLmN1cnNvckF0ICYmIHRoaXMuX2FkanVzdE9mZnNldEZyb21IZWxwZXIoIG8uY3Vyc29yQXQgKSApOwoKCQkvL0NhY2hlIHRoZSBmb3JtZXIgRE9NIHBvc2l0aW9uCgkJdGhpcy5kb21Qb3NpdGlvbiA9IHsKCQkJcHJldjogdGhpcy5jdXJyZW50SXRlbS5wcmV2KClbIDAgXSwKCQkJcGFyZW50OiB0aGlzLmN1cnJlbnRJdGVtLnBhcmVudCgpWyAwIF0KCQl9OwoKCQkvLyBJZiB0aGUgaGVscGVyIGlzIG5vdCB0aGUgb3JpZ2luYWwsIGhpZGUgdGhlIG9yaWdpbmFsIHNvIGl0J3Mgbm90IHBsYXlpbmcgYW55IHJvbGUgZHVyaW5nCgkJLy8gdGhlIGRyYWcsIHdvbid0IGNhdXNlIGFueXRoaW5nIGJhZCB0aGlzIHdheQoJCWlmICggdGhpcy5oZWxwZXJbIDAgXSAhPT0gdGhpcy5jdXJyZW50SXRlbVsgMCBdICkgewoJCQl0aGlzLmN1cnJlbnRJdGVtLmhpZGUoKTsKCQl9CgoJCS8vQ3JlYXRlIHRoZSBwbGFjZWhvbGRlcgoJCXRoaXMuX2NyZWF0ZVBsYWNlaG9sZGVyKCk7CgoJCS8vU2V0IGEgY29udGFpbm1lbnQgaWYgZ2l2ZW4gaW4gdGhlIG9wdGlvbnMKCQlpZiAoIG8uY29udGFpbm1lbnQgKSB7CgkJCXRoaXMuX3NldENvbnRhaW5tZW50KCk7CgkJfQoKCQlpZiAoIG8uY3Vyc29yICYmIG8uY3Vyc29yICE9PSAiYXV0byIgKSB7IC8vIGN1cnNvciBvcHRpb24KCQkJYm9keSA9IHRoaXMuZG9jdW1lbnQuZmluZCggImJvZHkiICk7CgoJCQkvLyBTdXBwb3J0OiBJRQoJCQl0aGlzLnN0b3JlZEN1cnNvciA9IGJvZHkuY3NzKCAiY3Vyc29yIiApOwoJCQlib2R5LmNzcyggImN1cnNvciIsIG8uY3Vyc29yICk7CgoJCQl0aGlzLnN0b3JlZFN0eWxlc2hlZXQgPQoJCQkJJCggIjxzdHlsZT4qeyBjdXJzb3I6ICIgKyBvLmN1cnNvciArICIgIWltcG9ydGFudDsgfTwvc3R5bGU+IiApLmFwcGVuZFRvKCBib2R5ICk7CgkJfQoKCQlpZiAoIG8ub3BhY2l0eSApIHsgLy8gb3BhY2l0eSBvcHRpb24KCQkJaWYgKCB0aGlzLmhlbHBlci5jc3MoICJvcGFjaXR5IiApICkgewoJCQkJdGhpcy5fc3RvcmVkT3BhY2l0eSA9IHRoaXMuaGVscGVyLmNzcyggIm9wYWNpdHkiICk7CgkJCX0KCQkJdGhpcy5oZWxwZXIuY3NzKCAib3BhY2l0eSIsIG8ub3BhY2l0eSApOwoJCX0KCgkJaWYgKCBvLnpJbmRleCApIHsgLy8gekluZGV4IG9wdGlvbgoJCQlpZiAoIHRoaXMuaGVscGVyLmNzcyggInpJbmRleCIgKSApIHsKCQkJCXRoaXMuX3N0b3JlZFpJbmRleCA9IHRoaXMuaGVscGVyLmNzcyggInpJbmRleCIgKTsKCQkJfQoJCQl0aGlzLmhlbHBlci5jc3MoICJ6SW5kZXgiLCBvLnpJbmRleCApOwoJCX0KCgkJLy9QcmVwYXJlIHNjcm9sbGluZwoJCWlmICggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSAhPT0gdGhpcy5kb2N1bWVudFsgMCBdICYmCgkJCQl0aGlzLnNjcm9sbFBhcmVudFsgMCBdLnRhZ05hbWUgIT09ICJIVE1MIiApIHsKCQkJdGhpcy5vdmVyZmxvd09mZnNldCA9IHRoaXMuc2Nyb2xsUGFyZW50Lm9mZnNldCgpOwoJCX0KCgkJLy9DYWxsIGNhbGxiYWNrcwoJCXRoaXMuX3RyaWdnZXIoICJzdGFydCIsIGV2ZW50LCB0aGlzLl91aUhhc2goKSApOwoKCQkvL1JlY2FjaGUgdGhlIGhlbHBlciBzaXplCgkJaWYgKCAhdGhpcy5fcHJlc2VydmVIZWxwZXJQcm9wb3J0aW9ucyApIHsKCQkJdGhpcy5fY2FjaGVIZWxwZXJQcm9wb3J0aW9ucygpOwoJCX0KCgkJLy9Qb3N0ICJhY3RpdmF0ZSIgZXZlbnRzIHRvIHBvc3NpYmxlIGNvbnRhaW5lcnMKCQlpZiAoICFub0FjdGl2YXRpb24gKSB7CgkJCWZvciAoIGkgPSB0aGlzLmNvbnRhaW5lcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5fdHJpZ2dlciggImFjdGl2YXRlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggdGhpcyApICk7CgkJCX0KCQl9CgoJCS8vUHJlcGFyZSBwb3NzaWJsZSBkcm9wcGFibGVzCgkJaWYgKCAkLnVpLmRkbWFuYWdlciApIHsKCQkJJC51aS5kZG1hbmFnZXIuY3VycmVudCA9IHRoaXM7CgkJfQoKCQlpZiAoICQudWkuZGRtYW5hZ2VyICYmICFvLmRyb3BCZWhhdmlvdXIgKSB7CgkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCB0aGlzLCBldmVudCApOwoJCX0KCgkJdGhpcy5kcmFnZ2luZyA9IHRydWU7CgoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmhlbHBlciwgInVpLXNvcnRhYmxlLWhlbHBlciIgKTsKCgkJLy8gRXhlY3V0ZSB0aGUgZHJhZyBvbmNlIC0gdGhpcyBjYXVzZXMgdGhlIGhlbHBlciBub3QgdG8gYmUgdmlzaWJsZWJlZm9yZSBnZXR0aW5nIGl0cwoJCS8vIGNvcnJlY3QgcG9zaXRpb24KCQl0aGlzLl9tb3VzZURyYWcoIGV2ZW50ICk7CgkJcmV0dXJuIHRydWU7CgoJfSwKCglfbW91c2VEcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGksIGl0ZW0sIGl0ZW1FbGVtZW50LCBpbnRlcnNlY3Rpb24sCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXNjcm9sbGVkID0gZmFsc2U7CgoJCS8vQ29tcHV0ZSB0aGUgaGVscGVycyBwb3NpdGlvbgoJCXRoaXMucG9zaXRpb24gPSB0aGlzLl9nZW5lcmF0ZVBvc2l0aW9uKCBldmVudCApOwoJCXRoaXMucG9zaXRpb25BYnMgPSB0aGlzLl9jb252ZXJ0UG9zaXRpb25UbyggImFic29sdXRlIiApOwoKCQlpZiAoICF0aGlzLmxhc3RQb3NpdGlvbkFicyApIHsKCQkJdGhpcy5sYXN0UG9zaXRpb25BYnMgPSB0aGlzLnBvc2l0aW9uQWJzOwoJCX0KCgkJLy9EbyBzY3JvbGxpbmcKCQlpZiAoIHRoaXMub3B0aW9ucy5zY3JvbGwgKSB7CgkJCWlmICggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSAhPT0gdGhpcy5kb2N1bWVudFsgMCBdICYmCgkJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS50YWdOYW1lICE9PSAiSFRNTCIgKSB7CgoJCQkJaWYgKCAoIHRoaXMub3ZlcmZsb3dPZmZzZXQudG9wICsgdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS5vZmZzZXRIZWlnaHQgKSAtCgkJCQkJCWV2ZW50LnBhZ2VZIDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQl0aGlzLnNjcm9sbFBhcmVudFsgMCBdLnNjcm9sbFRvcCA9CgkJCQkJCXNjcm9sbGVkID0gdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS5zY3JvbGxUb3AgKyBvLnNjcm9sbFNwZWVkOwoJCQkJfSBlbHNlIGlmICggZXZlbnQucGFnZVkgLSB0aGlzLm92ZXJmbG93T2Zmc2V0LnRvcCA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7CgkJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS5zY3JvbGxUb3AgPQoJCQkJCQlzY3JvbGxlZCA9IHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0uc2Nyb2xsVG9wIC0gby5zY3JvbGxTcGVlZDsKCQkJCX0KCgkJCQlpZiAoICggdGhpcy5vdmVyZmxvd09mZnNldC5sZWZ0ICsgdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS5vZmZzZXRXaWR0aCApIC0KCQkJCQkJZXZlbnQucGFnZVggPCBvLnNjcm9sbFNlbnNpdGl2aXR5ICkgewoJCQkJCXRoaXMuc2Nyb2xsUGFyZW50WyAwIF0uc2Nyb2xsTGVmdCA9IHNjcm9sbGVkID0KCQkJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS5zY3JvbGxMZWZ0ICsgby5zY3JvbGxTcGVlZDsKCQkJCX0gZWxzZSBpZiAoIGV2ZW50LnBhZ2VYIC0gdGhpcy5vdmVyZmxvd09mZnNldC5sZWZ0IDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQl0aGlzLnNjcm9sbFBhcmVudFsgMCBdLnNjcm9sbExlZnQgPSBzY3JvbGxlZCA9CgkJCQkJCXRoaXMuc2Nyb2xsUGFyZW50WyAwIF0uc2Nyb2xsTGVmdCAtIG8uc2Nyb2xsU3BlZWQ7CgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCWlmICggZXZlbnQucGFnZVkgLSB0aGlzLmRvY3VtZW50LnNjcm9sbFRvcCgpIDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQlzY3JvbGxlZCA9IHRoaXMuZG9jdW1lbnQuc2Nyb2xsVG9wKCB0aGlzLmRvY3VtZW50LnNjcm9sbFRvcCgpIC0gby5zY3JvbGxTcGVlZCApOwoJCQkJfSBlbHNlIGlmICggdGhpcy53aW5kb3cuaGVpZ2h0KCkgLSAoIGV2ZW50LnBhZ2VZIC0gdGhpcy5kb2N1bWVudC5zY3JvbGxUb3AoKSApIDwKCQkJCQkJby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQlzY3JvbGxlZCA9IHRoaXMuZG9jdW1lbnQuc2Nyb2xsVG9wKCB0aGlzLmRvY3VtZW50LnNjcm9sbFRvcCgpICsgby5zY3JvbGxTcGVlZCApOwoJCQkJfQoKCQkJCWlmICggZXZlbnQucGFnZVggLSB0aGlzLmRvY3VtZW50LnNjcm9sbExlZnQoKSA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7CgkJCQkJc2Nyb2xsZWQgPSB0aGlzLmRvY3VtZW50LnNjcm9sbExlZnQoCgkJCQkJCXRoaXMuZG9jdW1lbnQuc2Nyb2xsTGVmdCgpIC0gby5zY3JvbGxTcGVlZAoJCQkJCSk7CgkJCQl9IGVsc2UgaWYgKCB0aGlzLndpbmRvdy53aWR0aCgpIC0gKCBldmVudC5wYWdlWCAtIHRoaXMuZG9jdW1lbnQuc2Nyb2xsTGVmdCgpICkgPAoJCQkJCQlvLnNjcm9sbFNlbnNpdGl2aXR5ICkgewoJCQkJCXNjcm9sbGVkID0gdGhpcy5kb2N1bWVudC5zY3JvbGxMZWZ0KAoJCQkJCQl0aGlzLmRvY3VtZW50LnNjcm9sbExlZnQoKSArIG8uc2Nyb2xsU3BlZWQKCQkJCQkpOwoJCQkJfQoKCQkJfQoKCQkJaWYgKCBzY3JvbGxlZCAhPT0gZmFsc2UgJiYgJC51aS5kZG1hbmFnZXIgJiYgIW8uZHJvcEJlaGF2aW91ciApIHsKCQkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCB0aGlzLCBldmVudCApOwoJCQl9CgkJfQoKCQkvL1JlZ2VuZXJhdGUgdGhlIGFic29sdXRlIHBvc2l0aW9uIHVzZWQgZm9yIHBvc2l0aW9uIGNoZWNrcwoJCXRoaXMucG9zaXRpb25BYnMgPSB0aGlzLl9jb252ZXJ0UG9zaXRpb25UbyggImFic29sdXRlIiApOwoKCQkvL1NldCB0aGUgaGVscGVyIHBvc2l0aW9uCgkJaWYgKCAhdGhpcy5vcHRpb25zLmF4aXMgfHwgdGhpcy5vcHRpb25zLmF4aXMgIT09ICJ5IiApIHsKCQkJdGhpcy5oZWxwZXJbIDAgXS5zdHlsZS5sZWZ0ID0gdGhpcy5wb3NpdGlvbi5sZWZ0ICsgInB4IjsKCQl9CgkJaWYgKCAhdGhpcy5vcHRpb25zLmF4aXMgfHwgdGhpcy5vcHRpb25zLmF4aXMgIT09ICJ4IiApIHsKCQkJdGhpcy5oZWxwZXJbIDAgXS5zdHlsZS50b3AgPSB0aGlzLnBvc2l0aW9uLnRvcCArICJweCI7CgkJfQoKCQkvL1JlYXJyYW5nZQoJCWZvciAoIGkgPSB0aGlzLml0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoKCQkJLy9DYWNoZSB2YXJpYWJsZXMgYW5kIGludGVyc2VjdGlvbiwgY29udGludWUgaWYgbm8gaW50ZXJzZWN0aW9uCgkJCWl0ZW0gPSB0aGlzLml0ZW1zWyBpIF07CgkJCWl0ZW1FbGVtZW50ID0gaXRlbS5pdGVtWyAwIF07CgkJCWludGVyc2VjdGlvbiA9IHRoaXMuX2ludGVyc2VjdHNXaXRoUG9pbnRlciggaXRlbSApOwoJCQlpZiAoICFpbnRlcnNlY3Rpb24gKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gT25seSBwdXQgdGhlIHBsYWNlaG9sZGVyIGluc2lkZSB0aGUgY3VycmVudCBDb250YWluZXIsIHNraXAgYWxsCgkJCS8vIGl0ZW1zIGZyb20gb3RoZXIgY29udGFpbmVycy4gVGhpcyB3b3JrcyBiZWNhdXNlIHdoZW4gbW92aW5nCgkJCS8vIGFuIGl0ZW0gZnJvbSBvbmUgY29udGFpbmVyIHRvIGFub3RoZXIgdGhlCgkJCS8vIGN1cnJlbnRDb250YWluZXIgaXMgc3dpdGNoZWQgYmVmb3JlIHRoZSBwbGFjZWhvbGRlciBpcyBtb3ZlZC4KCQkJLy8KCQkJLy8gV2l0aG91dCB0aGlzLCBtb3ZpbmcgaXRlbXMgaW4gInN1Yi1zb3J0YWJsZXMiIGNhbiBjYXVzZQoJCQkvLyB0aGUgcGxhY2Vob2xkZXIgdG8gaml0dGVyIGJldHdlZW4gdGhlIG91dGVyIGFuZCBpbm5lciBjb250YWluZXIuCgkJCWlmICggaXRlbS5pbnN0YW5jZSAhPT0gdGhpcy5jdXJyZW50Q29udGFpbmVyICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCS8vIENhbm5vdCBpbnRlcnNlY3Qgd2l0aCBpdHNlbGYKCQkJLy8gbm8gdXNlbGVzcyBhY3Rpb25zIHRoYXQgaGF2ZSBiZWVuIGRvbmUgYmVmb3JlCgkJCS8vIG5vIGFjdGlvbiBpZiB0aGUgaXRlbSBtb3ZlZCBpcyB0aGUgcGFyZW50IG9mIHRoZSBpdGVtIGNoZWNrZWQKCQkJaWYgKCBpdGVtRWxlbWVudCAhPT0gdGhpcy5jdXJyZW50SXRlbVsgMCBdICYmCgkJCQl0aGlzLnBsYWNlaG9sZGVyWyBpbnRlcnNlY3Rpb24gPT09IDEgPyAibmV4dCIgOiAicHJldiIgXSgpWyAwIF0gIT09IGl0ZW1FbGVtZW50ICYmCgkJCQkhJC5jb250YWlucyggdGhpcy5wbGFjZWhvbGRlclsgMCBdLCBpdGVtRWxlbWVudCApICYmCgkJCQkoIHRoaXMub3B0aW9ucy50eXBlID09PSAic2VtaS1keW5hbWljIiA/CgkJCQkJISQuY29udGFpbnMoIHRoaXMuZWxlbWVudFsgMCBdLCBpdGVtRWxlbWVudCApIDoKCQkJCQl0cnVlCgkJCQkpCgkJCSkgewoKCQkJCXRoaXMuZGlyZWN0aW9uID0gaW50ZXJzZWN0aW9uID09PSAxID8gImRvd24iIDogInVwIjsKCgkJCQlpZiAoIHRoaXMub3B0aW9ucy50b2xlcmFuY2UgPT09ICJwb2ludGVyIiB8fCB0aGlzLl9pbnRlcnNlY3RzV2l0aFNpZGVzKCBpdGVtICkgKSB7CgkJCQkJdGhpcy5fcmVhcnJhbmdlKCBldmVudCwgaXRlbSApOwoJCQkJfSBlbHNlIHsKCQkJCQlicmVhazsKCQkJCX0KCgkJCQl0aGlzLl90cmlnZ2VyKCAiY2hhbmdlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpICk7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJLy9Qb3N0IGV2ZW50cyB0byBjb250YWluZXJzCgkJdGhpcy5fY29udGFjdENvbnRhaW5lcnMoIGV2ZW50ICk7CgoJCS8vSW50ZXJjb25uZWN0IHdpdGggZHJvcHBhYmxlcwoJCWlmICggJC51aS5kZG1hbmFnZXIgKSB7CgkJCSQudWkuZGRtYW5hZ2VyLmRyYWcoIHRoaXMsIGV2ZW50ICk7CgkJfQoKCQkvL0NhbGwgY2FsbGJhY2tzCgkJdGhpcy5fdHJpZ2dlciggInNvcnQiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkgKTsKCgkJdGhpcy5sYXN0UG9zaXRpb25BYnMgPSB0aGlzLnBvc2l0aW9uQWJzOwoJCXJldHVybiBmYWxzZTsKCgl9LAoKCV9tb3VzZVN0b3A6IGZ1bmN0aW9uKCBldmVudCwgbm9Qcm9wYWdhdGlvbiApIHsKCgkJaWYgKCAhZXZlbnQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vSWYgd2UgYXJlIHVzaW5nIGRyb3BwYWJsZXMsIGluZm9ybSB0aGUgbWFuYWdlciBhYm91dCB0aGUgZHJvcAoJCWlmICggJC51aS5kZG1hbmFnZXIgJiYgIXRoaXMub3B0aW9ucy5kcm9wQmVoYXZpb3VyICkgewoJCQkkLnVpLmRkbWFuYWdlci5kcm9wKCB0aGlzLCBldmVudCApOwoJCX0KCgkJaWYgKCB0aGlzLm9wdGlvbnMucmV2ZXJ0ICkgewoJCQl2YXIgdGhhdCA9IHRoaXMsCgkJCQljdXIgPSB0aGlzLnBsYWNlaG9sZGVyLm9mZnNldCgpLAoJCQkJYXhpcyA9IHRoaXMub3B0aW9ucy5heGlzLAoJCQkJYW5pbWF0aW9uID0ge307CgoJCQlpZiAoICFheGlzIHx8IGF4aXMgPT09ICJ4IiApIHsKCQkJCWFuaW1hdGlvbi5sZWZ0ID0gY3VyLmxlZnQgLSB0aGlzLm9mZnNldC5wYXJlbnQubGVmdCAtIHRoaXMubWFyZ2lucy5sZWZ0ICsKCQkJCQkoIHRoaXMub2Zmc2V0UGFyZW50WyAwIF0gPT09IHRoaXMuZG9jdW1lbnRbIDAgXS5ib2R5ID8KCQkJCQkJMCA6CgkJCQkJCXRoaXMub2Zmc2V0UGFyZW50WyAwIF0uc2Nyb2xsTGVmdAoJCQkJCSk7CgkJCX0KCQkJaWYgKCAhYXhpcyB8fCBheGlzID09PSAieSIgKSB7CgkJCQlhbmltYXRpb24udG9wID0gY3VyLnRvcCAtIHRoaXMub2Zmc2V0LnBhcmVudC50b3AgLSB0aGlzLm1hcmdpbnMudG9wICsKCQkJCQkoIHRoaXMub2Zmc2V0UGFyZW50WyAwIF0gPT09IHRoaXMuZG9jdW1lbnRbIDAgXS5ib2R5ID8KCQkJCQkJMCA6CgkJCQkJCXRoaXMub2Zmc2V0UGFyZW50WyAwIF0uc2Nyb2xsVG9wCgkJCQkJKTsKCQkJfQoJCQl0aGlzLnJldmVydGluZyA9IHRydWU7CgkJCSQoIHRoaXMuaGVscGVyICkuYW5pbWF0ZSgKCQkJCWFuaW1hdGlvbiwKCQkJCXBhcnNlSW50KCB0aGlzLm9wdGlvbnMucmV2ZXJ0LCAxMCApIHx8IDUwMCwKCQkJCWZ1bmN0aW9uKCkgewoJCQkJCXRoYXQuX2NsZWFyKCBldmVudCApOwoJCQkJfQoJCQkpOwoJCX0gZWxzZSB7CgkJCXRoaXMuX2NsZWFyKCBldmVudCwgbm9Qcm9wYWdhdGlvbiApOwoJCX0KCgkJcmV0dXJuIGZhbHNlOwoKCX0sCgoJY2FuY2VsOiBmdW5jdGlvbigpIHsKCgkJaWYgKCB0aGlzLmRyYWdnaW5nICkgewoKCQkJdGhpcy5fbW91c2VVcCggbmV3ICQuRXZlbnQoICJtb3VzZXVwIiwgeyB0YXJnZXQ6IG51bGwgfSApICk7CgoJCQlpZiAoIHRoaXMub3B0aW9ucy5oZWxwZXIgPT09ICJvcmlnaW5hbCIgKSB7CgkJCQl0aGlzLmN1cnJlbnRJdGVtLmNzcyggdGhpcy5fc3RvcmVkQ1NTICk7CgkJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5jdXJyZW50SXRlbSwgInVpLXNvcnRhYmxlLWhlbHBlciIgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuY3VycmVudEl0ZW0uc2hvdygpOwoJCQl9CgoJCQkvL1Bvc3QgZGVhY3RpdmF0aW5nIGV2ZW50cyB0byBjb250YWluZXJzCgkJCWZvciAoIHZhciBpID0gdGhpcy5jb250YWluZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uX3RyaWdnZXIoICJkZWFjdGl2YXRlIiwgbnVsbCwgdGhpcy5fdWlIYXNoKCB0aGlzICkgKTsKCQkJCWlmICggdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUub3ZlciApIHsKCQkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5fdHJpZ2dlciggIm91dCIsIG51bGwsIHRoaXMuX3VpSGFzaCggdGhpcyApICk7CgkJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUub3ZlciA9IDA7CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAoIHRoaXMucGxhY2Vob2xkZXIgKSB7CgoJCQkvLyQodGhpcy5wbGFjZWhvbGRlclswXSkucmVtb3ZlKCk7IHdvdWxkIGhhdmUgYmVlbiB0aGUgalF1ZXJ5IHdheSAtIHVuZm9ydHVuYXRlbHksCgkJCS8vIGl0IHVuYmluZHMgQUxMIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCBub2RlIQoJCQlpZiAoIHRoaXMucGxhY2Vob2xkZXJbIDAgXS5wYXJlbnROb2RlICkgewoJCQkJdGhpcy5wbGFjZWhvbGRlclsgMCBdLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHRoaXMucGxhY2Vob2xkZXJbIDAgXSApOwoJCQl9CgkJCWlmICggdGhpcy5vcHRpb25zLmhlbHBlciAhPT0gIm9yaWdpbmFsIiAmJiB0aGlzLmhlbHBlciAmJgoJCQkJCXRoaXMuaGVscGVyWyAwIF0ucGFyZW50Tm9kZSApIHsKCQkJCXRoaXMuaGVscGVyLnJlbW92ZSgpOwoJCQl9CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJaGVscGVyOiBudWxsLAoJCQkJZHJhZ2dpbmc6IGZhbHNlLAoJCQkJcmV2ZXJ0aW5nOiBmYWxzZSwKCQkJCV9ub0ZpbmFsU29ydDogbnVsbAoJCQl9ICk7CgoJCQlpZiAoIHRoaXMuZG9tUG9zaXRpb24ucHJldiApIHsKCQkJCSQoIHRoaXMuZG9tUG9zaXRpb24ucHJldiApLmFmdGVyKCB0aGlzLmN1cnJlbnRJdGVtICk7CgkJCX0gZWxzZSB7CgkJCQkkKCB0aGlzLmRvbVBvc2l0aW9uLnBhcmVudCApLnByZXBlbmQoIHRoaXMuY3VycmVudEl0ZW0gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfSwKCglzZXJpYWxpemU6IGZ1bmN0aW9uKCBvICkgewoKCQl2YXIgaXRlbXMgPSB0aGlzLl9nZXRJdGVtc0FzalF1ZXJ5KCBvICYmIG8uY29ubmVjdGVkICksCgkJCXN0ciA9IFtdOwoJCW8gPSBvIHx8IHt9OwoKCQkkKCBpdGVtcyApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgcmVzID0gKCAkKCBvLml0ZW0gfHwgdGhpcyApLmF0dHIoIG8uYXR0cmlidXRlIHx8ICJpZCIgKSB8fCAiIiApCgkJCQkubWF0Y2goIG8uZXhwcmVzc2lvbiB8fCAoIC8oLispW1wtPV9dKC4rKS8gKSApOwoJCQlpZiAoIHJlcyApIHsKCQkJCXN0ci5wdXNoKAoJCQkJCSggby5rZXkgfHwgcmVzWyAxIF0gKyAiW10iICkgKwoJCQkJCSI9IiArICggby5rZXkgJiYgby5leHByZXNzaW9uID8gcmVzWyAxIF0gOiByZXNbIDIgXSApICk7CgkJCX0KCQl9ICk7CgoJCWlmICggIXN0ci5sZW5ndGggJiYgby5rZXkgKSB7CgkJCXN0ci5wdXNoKCBvLmtleSArICI9IiApOwoJCX0KCgkJcmV0dXJuIHN0ci5qb2luKCAiJiIgKTsKCgl9LAoKCXRvQXJyYXk6IGZ1bmN0aW9uKCBvICkgewoKCQl2YXIgaXRlbXMgPSB0aGlzLl9nZXRJdGVtc0FzalF1ZXJ5KCBvICYmIG8uY29ubmVjdGVkICksCgkJCXJldCA9IFtdOwoKCQlvID0gbyB8fCB7fTsKCgkJaXRlbXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXJldC5wdXNoKCAkKCBvLml0ZW0gfHwgdGhpcyApLmF0dHIoIG8uYXR0cmlidXRlIHx8ICJpZCIgKSB8fCAiIiApOwoJCX0gKTsKCQlyZXR1cm4gcmV0OwoKCX0sCgoJLyogQmUgY2FyZWZ1bCB3aXRoIHRoZSBmb2xsb3dpbmcgY29yZSBmdW5jdGlvbnMgKi8KCV9pbnRlcnNlY3RzV2l0aDogZnVuY3Rpb24oIGl0ZW0gKSB7CgoJCXZhciB4MSA9IHRoaXMucG9zaXRpb25BYnMubGVmdCwKCQkJeDIgPSB4MSArIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGgsCgkJCXkxID0gdGhpcy5wb3NpdGlvbkFicy50b3AsCgkJCXkyID0geTEgKyB0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCwKCQkJbCA9IGl0ZW0ubGVmdCwKCQkJciA9IGwgKyBpdGVtLndpZHRoLAoJCQl0ID0gaXRlbS50b3AsCgkJCWIgPSB0ICsgaXRlbS5oZWlnaHQsCgkJCWR5Q2xpY2sgPSB0aGlzLm9mZnNldC5jbGljay50b3AsCgkJCWR4Q2xpY2sgPSB0aGlzLm9mZnNldC5jbGljay5sZWZ0LAoJCQlpc092ZXJFbGVtZW50SGVpZ2h0ID0gKCB0aGlzLm9wdGlvbnMuYXhpcyA9PT0gIngiICkgfHwgKCAoIHkxICsgZHlDbGljayApID4gdCAmJgoJCQkJKCB5MSArIGR5Q2xpY2sgKSA8IGIgKSwKCQkJaXNPdmVyRWxlbWVudFdpZHRoID0gKCB0aGlzLm9wdGlvbnMuYXhpcyA9PT0gInkiICkgfHwgKCAoIHgxICsgZHhDbGljayApID4gbCAmJgoJCQkJKCB4MSArIGR4Q2xpY2sgKSA8IHIgKSwKCQkJaXNPdmVyRWxlbWVudCA9IGlzT3ZlckVsZW1lbnRIZWlnaHQgJiYgaXNPdmVyRWxlbWVudFdpZHRoOwoKCQlpZiAoIHRoaXMub3B0aW9ucy50b2xlcmFuY2UgPT09ICJwb2ludGVyIiB8fAoJCQl0aGlzLm9wdGlvbnMuZm9yY2VQb2ludGVyRm9yQ29udGFpbmVycyB8fAoJCQkoIHRoaXMub3B0aW9ucy50b2xlcmFuY2UgIT09ICJwb2ludGVyIiAmJgoJCQkJdGhpcy5oZWxwZXJQcm9wb3J0aW9uc1sgdGhpcy5mbG9hdGluZyA/ICJ3aWR0aCIgOiAiaGVpZ2h0IiBdID4KCQkJCWl0ZW1bIHRoaXMuZmxvYXRpbmcgPyAid2lkdGgiIDogImhlaWdodCIgXSApCgkJKSB7CgkJCXJldHVybiBpc092ZXJFbGVtZW50OwoJCX0gZWxzZSB7CgoJCQlyZXR1cm4gKCBsIDwgeDEgKyAoIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLyAyICkgJiYgLy8gUmlnaHQgSGFsZgoJCQkJeDIgLSAoIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLyAyICkgPCByICYmIC8vIExlZnQgSGFsZgoJCQkJdCA8IHkxICsgKCB0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAvIDIgKSAmJiAvLyBCb3R0b20gSGFsZgoJCQkJeTIgLSAoIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC8gMiApIDwgYiApOyAvLyBUb3AgSGFsZgoKCQl9Cgl9LAoKCV9pbnRlcnNlY3RzV2l0aFBvaW50ZXI6IGZ1bmN0aW9uKCBpdGVtICkgewoJCXZhciB2ZXJ0aWNhbERpcmVjdGlvbiwgaG9yaXpvbnRhbERpcmVjdGlvbiwKCQkJaXNPdmVyRWxlbWVudEhlaWdodCA9ICggdGhpcy5vcHRpb25zLmF4aXMgPT09ICJ4IiApIHx8CgkJCQl0aGlzLl9pc092ZXJBeGlzKAoJCQkJCXRoaXMucG9zaXRpb25BYnMudG9wICsgdGhpcy5vZmZzZXQuY2xpY2sudG9wLCBpdGVtLnRvcCwgaXRlbS5oZWlnaHQgKSwKCQkJaXNPdmVyRWxlbWVudFdpZHRoID0gKCB0aGlzLm9wdGlvbnMuYXhpcyA9PT0gInkiICkgfHwKCQkJCXRoaXMuX2lzT3ZlckF4aXMoCgkJCQkJdGhpcy5wb3NpdGlvbkFicy5sZWZ0ICsgdGhpcy5vZmZzZXQuY2xpY2subGVmdCwgaXRlbS5sZWZ0LCBpdGVtLndpZHRoICksCgkJCWlzT3ZlckVsZW1lbnQgPSBpc092ZXJFbGVtZW50SGVpZ2h0ICYmIGlzT3ZlckVsZW1lbnRXaWR0aDsKCgkJaWYgKCAhaXNPdmVyRWxlbWVudCApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdmVydGljYWxEaXJlY3Rpb24gPSB0aGlzLl9nZXREcmFnVmVydGljYWxEaXJlY3Rpb24oKTsKCQlob3Jpem9udGFsRGlyZWN0aW9uID0gdGhpcy5fZ2V0RHJhZ0hvcml6b250YWxEaXJlY3Rpb24oKTsKCgkJcmV0dXJuIHRoaXMuZmxvYXRpbmcgPwoJCQkoICggaG9yaXpvbnRhbERpcmVjdGlvbiA9PT0gInJpZ2h0IiB8fCB2ZXJ0aWNhbERpcmVjdGlvbiA9PT0gImRvd24iICkgPyAyIDogMSApCgkJCTogKCB2ZXJ0aWNhbERpcmVjdGlvbiAmJiAoIHZlcnRpY2FsRGlyZWN0aW9uID09PSAiZG93biIgPyAyIDogMSApICk7CgoJfSwKCglfaW50ZXJzZWN0c1dpdGhTaWRlczogZnVuY3Rpb24oIGl0ZW0gKSB7CgoJCXZhciBpc092ZXJCb3R0b21IYWxmID0gdGhpcy5faXNPdmVyQXhpcyggdGhpcy5wb3NpdGlvbkFicy50b3AgKwoJCQkJdGhpcy5vZmZzZXQuY2xpY2sudG9wLCBpdGVtLnRvcCArICggaXRlbS5oZWlnaHQgLyAyICksIGl0ZW0uaGVpZ2h0ICksCgkJCWlzT3ZlclJpZ2h0SGFsZiA9IHRoaXMuX2lzT3ZlckF4aXMoIHRoaXMucG9zaXRpb25BYnMubGVmdCArCgkJCQl0aGlzLm9mZnNldC5jbGljay5sZWZ0LCBpdGVtLmxlZnQgKyAoIGl0ZW0ud2lkdGggLyAyICksIGl0ZW0ud2lkdGggKSwKCQkJdmVydGljYWxEaXJlY3Rpb24gPSB0aGlzLl9nZXREcmFnVmVydGljYWxEaXJlY3Rpb24oKSwKCQkJaG9yaXpvbnRhbERpcmVjdGlvbiA9IHRoaXMuX2dldERyYWdIb3Jpem9udGFsRGlyZWN0aW9uKCk7CgoJCWlmICggdGhpcy5mbG9hdGluZyAmJiBob3Jpem9udGFsRGlyZWN0aW9uICkgewoJCQlyZXR1cm4gKCAoIGhvcml6b250YWxEaXJlY3Rpb24gPT09ICJyaWdodCIgJiYgaXNPdmVyUmlnaHRIYWxmICkgfHwKCQkJCSggaG9yaXpvbnRhbERpcmVjdGlvbiA9PT0gImxlZnQiICYmICFpc092ZXJSaWdodEhhbGYgKSApOwoJCX0gZWxzZSB7CgkJCXJldHVybiB2ZXJ0aWNhbERpcmVjdGlvbiAmJiAoICggdmVydGljYWxEaXJlY3Rpb24gPT09ICJkb3duIiAmJiBpc092ZXJCb3R0b21IYWxmICkgfHwKCQkJCSggdmVydGljYWxEaXJlY3Rpb24gPT09ICJ1cCIgJiYgIWlzT3ZlckJvdHRvbUhhbGYgKSApOwoJCX0KCgl9LAoKCV9nZXREcmFnVmVydGljYWxEaXJlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXZhciBkZWx0YSA9IHRoaXMucG9zaXRpb25BYnMudG9wIC0gdGhpcy5sYXN0UG9zaXRpb25BYnMudG9wOwoJCXJldHVybiBkZWx0YSAhPT0gMCAmJiAoIGRlbHRhID4gMCA/ICJkb3duIiA6ICJ1cCIgKTsKCX0sCgoJX2dldERyYWdIb3Jpem9udGFsRGlyZWN0aW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgZGVsdGEgPSB0aGlzLnBvc2l0aW9uQWJzLmxlZnQgLSB0aGlzLmxhc3RQb3NpdGlvbkFicy5sZWZ0OwoJCXJldHVybiBkZWx0YSAhPT0gMCAmJiAoIGRlbHRhID4gMCA/ICJyaWdodCIgOiAibGVmdCIgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMuX3JlZnJlc2hJdGVtcyggZXZlbnQgKTsKCQl0aGlzLl9zZXRIYW5kbGVDbGFzc05hbWUoKTsKCQl0aGlzLnJlZnJlc2hQb3NpdGlvbnMoKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2Nvbm5lY3RXaXRoOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCQlyZXR1cm4gb3B0aW9ucy5jb25uZWN0V2l0aC5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nID8KCQkJWyBvcHRpb25zLmNvbm5lY3RXaXRoIF0gOgoJCQlvcHRpb25zLmNvbm5lY3RXaXRoOwoJfSwKCglfZ2V0SXRlbXNBc2pRdWVyeTogZnVuY3Rpb24oIGNvbm5lY3RlZCApIHsKCgkJdmFyIGksIGosIGN1ciwgaW5zdCwKCQkJaXRlbXMgPSBbXSwKCQkJcXVlcmllcyA9IFtdLAoJCQljb25uZWN0V2l0aCA9IHRoaXMuX2Nvbm5lY3RXaXRoKCk7CgoJCWlmICggY29ubmVjdFdpdGggJiYgY29ubmVjdGVkICkgewoJCQlmb3IgKCBpID0gY29ubmVjdFdpdGgubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQljdXIgPSAkKCBjb25uZWN0V2l0aFsgaSBdLCB0aGlzLmRvY3VtZW50WyAwIF0gKTsKCQkJCWZvciAoIGogPSBjdXIubGVuZ3RoIC0gMTsgaiA+PSAwOyBqLS0gKSB7CgkJCQkJaW5zdCA9ICQuZGF0YSggY3VyWyBqIF0sIHRoaXMud2lkZ2V0RnVsbE5hbWUgKTsKCQkJCQlpZiAoIGluc3QgJiYgaW5zdCAhPT0gdGhpcyAmJiAhaW5zdC5vcHRpb25zLmRpc2FibGVkICkgewoJCQkJCQlxdWVyaWVzLnB1c2goIFsgJC5pc0Z1bmN0aW9uKCBpbnN0Lm9wdGlvbnMuaXRlbXMgKSA/CgkJCQkJCQlpbnN0Lm9wdGlvbnMuaXRlbXMuY2FsbCggaW5zdC5lbGVtZW50ICkgOgoJCQkJCQkJJCggaW5zdC5vcHRpb25zLml0ZW1zLCBpbnN0LmVsZW1lbnQgKQoJCQkJCQkJCS5ub3QoICIudWktc29ydGFibGUtaGVscGVyIiApCgkJCQkJCQkJLm5vdCggIi51aS1zb3J0YWJsZS1wbGFjZWhvbGRlciIgKSwgaW5zdCBdICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlxdWVyaWVzLnB1c2goIFsgJC5pc0Z1bmN0aW9uKCB0aGlzLm9wdGlvbnMuaXRlbXMgKSA/CgkJCXRoaXMub3B0aW9ucy5pdGVtcwoJCQkJLmNhbGwoIHRoaXMuZWxlbWVudCwgbnVsbCwgeyBvcHRpb25zOiB0aGlzLm9wdGlvbnMsIGl0ZW06IHRoaXMuY3VycmVudEl0ZW0gfSApIDoKCQkJJCggdGhpcy5vcHRpb25zLml0ZW1zLCB0aGlzLmVsZW1lbnQgKQoJCQkJLm5vdCggIi51aS1zb3J0YWJsZS1oZWxwZXIiICkKCQkJCS5ub3QoICIudWktc29ydGFibGUtcGxhY2Vob2xkZXIiICksIHRoaXMgXSApOwoKCQlmdW5jdGlvbiBhZGRJdGVtcygpIHsKCQkJaXRlbXMucHVzaCggdGhpcyApOwoJCX0KCQlmb3IgKCBpID0gcXVlcmllcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJcXVlcmllc1sgaSBdWyAwIF0uZWFjaCggYWRkSXRlbXMgKTsKCQl9CgoJCXJldHVybiAkKCBpdGVtcyApOwoKCX0sCgoJX3JlbW92ZUN1cnJlbnRzRnJvbUl0ZW1zOiBmdW5jdGlvbigpIHsKCgkJdmFyIGxpc3QgPSB0aGlzLmN1cnJlbnRJdGVtLmZpbmQoICI6ZGF0YSgiICsgdGhpcy53aWRnZXROYW1lICsgIi1pdGVtKSIgKTsKCgkJdGhpcy5pdGVtcyA9ICQuZ3JlcCggdGhpcy5pdGVtcywgZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCWZvciAoIHZhciBqID0gMDsgaiA8IGxpc3QubGVuZ3RoOyBqKysgKSB7CgkJCQlpZiAoIGxpc3RbIGogXSA9PT0gaXRlbS5pdGVtWyAwIF0gKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gKTsKCgl9LAoKCV9yZWZyZXNoSXRlbXM6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJdGhpcy5pdGVtcyA9IFtdOwoJCXRoaXMuY29udGFpbmVycyA9IFsgdGhpcyBdOwoKCQl2YXIgaSwgaiwgY3VyLCBpbnN0LCB0YXJnZXREYXRhLCBfcXVlcmllcywgaXRlbSwgcXVlcmllc0xlbmd0aCwKCQkJaXRlbXMgPSB0aGlzLml0ZW1zLAoJCQlxdWVyaWVzID0gWyBbICQuaXNGdW5jdGlvbiggdGhpcy5vcHRpb25zLml0ZW1zICkgPwoJCQkJdGhpcy5vcHRpb25zLml0ZW1zLmNhbGwoIHRoaXMuZWxlbWVudFsgMCBdLCBldmVudCwgeyBpdGVtOiB0aGlzLmN1cnJlbnRJdGVtIH0gKSA6CgkJCQkkKCB0aGlzLm9wdGlvbnMuaXRlbXMsIHRoaXMuZWxlbWVudCApLCB0aGlzIF0gXSwKCQkJY29ubmVjdFdpdGggPSB0aGlzLl9jb25uZWN0V2l0aCgpOwoKCQkvL1Nob3VsZG4ndCBiZSBydW4gdGhlIGZpcnN0IHRpbWUgdGhyb3VnaCBkdWUgdG8gbWFzc2l2ZSBzbG93LWRvd24KCQlpZiAoIGNvbm5lY3RXaXRoICYmIHRoaXMucmVhZHkgKSB7CgkJCWZvciAoIGkgPSBjb25uZWN0V2l0aC5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJCWN1ciA9ICQoIGNvbm5lY3RXaXRoWyBpIF0sIHRoaXMuZG9jdW1lbnRbIDAgXSApOwoJCQkJZm9yICggaiA9IGN1ci5sZW5ndGggLSAxOyBqID49IDA7IGotLSApIHsKCQkJCQlpbnN0ID0gJC5kYXRhKCBjdXJbIGogXSwgdGhpcy53aWRnZXRGdWxsTmFtZSApOwoJCQkJCWlmICggaW5zdCAmJiBpbnN0ICE9PSB0aGlzICYmICFpbnN0Lm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJCXF1ZXJpZXMucHVzaCggWyAkLmlzRnVuY3Rpb24oIGluc3Qub3B0aW9ucy5pdGVtcyApID8KCQkJCQkJCWluc3Qub3B0aW9ucy5pdGVtcwoJCQkJCQkJCS5jYWxsKCBpbnN0LmVsZW1lbnRbIDAgXSwgZXZlbnQsIHsgaXRlbTogdGhpcy5jdXJyZW50SXRlbSB9ICkgOgoJCQkJCQkJJCggaW5zdC5vcHRpb25zLml0ZW1zLCBpbnN0LmVsZW1lbnQgKSwgaW5zdCBdICk7CgkJCQkJCXRoaXMuY29udGFpbmVycy5wdXNoKCBpbnN0ICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlmb3IgKCBpID0gcXVlcmllcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJdGFyZ2V0RGF0YSA9IHF1ZXJpZXNbIGkgXVsgMSBdOwoJCQlfcXVlcmllcyA9IHF1ZXJpZXNbIGkgXVsgMCBdOwoKCQkJZm9yICggaiA9IDAsIHF1ZXJpZXNMZW5ndGggPSBfcXVlcmllcy5sZW5ndGg7IGogPCBxdWVyaWVzTGVuZ3RoOyBqKysgKSB7CgkJCQlpdGVtID0gJCggX3F1ZXJpZXNbIGogXSApOwoKCQkJCS8vIERhdGEgZm9yIHRhcmdldCBjaGVja2luZyAobW91c2UgbWFuYWdlcikKCQkJCWl0ZW0uZGF0YSggdGhpcy53aWRnZXROYW1lICsgIi1pdGVtIiwgdGFyZ2V0RGF0YSApOwoKCQkJCWl0ZW1zLnB1c2goIHsKCQkJCQlpdGVtOiBpdGVtLAoJCQkJCWluc3RhbmNlOiB0YXJnZXREYXRhLAoJCQkJCXdpZHRoOiAwLCBoZWlnaHQ6IDAsCgkJCQkJbGVmdDogMCwgdG9wOiAwCgkJCQl9ICk7CgkJCX0KCQl9CgoJfSwKCglyZWZyZXNoUG9zaXRpb25zOiBmdW5jdGlvbiggZmFzdCApIHsKCgkJLy8gRGV0ZXJtaW5lIHdoZXRoZXIgaXRlbXMgYXJlIGJlaW5nIGRpc3BsYXllZCBob3Jpem9udGFsbHkKCQl0aGlzLmZsb2F0aW5nID0gdGhpcy5pdGVtcy5sZW5ndGggPwoJCQl0aGlzLm9wdGlvbnMuYXhpcyA9PT0gIngiIHx8IHRoaXMuX2lzRmxvYXRpbmcoIHRoaXMuaXRlbXNbIDAgXS5pdGVtICkgOgoJCQlmYWxzZTsKCgkJLy9UaGlzIGhhcyB0byBiZSByZWRvbmUgYmVjYXVzZSBkdWUgdG8gdGhlIGl0ZW0gYmVpbmcgbW92ZWQgb3V0L2ludG8gdGhlIG9mZnNldFBhcmVudCwKCQkvLyB0aGUgb2Zmc2V0UGFyZW50J3MgcG9zaXRpb24gd2lsbCBjaGFuZ2UKCQlpZiAoIHRoaXMub2Zmc2V0UGFyZW50ICYmIHRoaXMuaGVscGVyICkgewoJCQl0aGlzLm9mZnNldC5wYXJlbnQgPSB0aGlzLl9nZXRQYXJlbnRPZmZzZXQoKTsKCQl9CgoJCXZhciBpLCBpdGVtLCB0LCBwOwoKCQlmb3IgKCBpID0gdGhpcy5pdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJaXRlbSA9IHRoaXMuaXRlbXNbIGkgXTsKCgkJCS8vV2UgaWdub3JlIGNhbGN1bGF0aW5nIHBvc2l0aW9ucyBvZiBhbGwgY29ubmVjdGVkIGNvbnRhaW5lcnMgd2hlbiB3ZSdyZSBub3Qgb3ZlciB0aGVtCgkJCWlmICggaXRlbS5pbnN0YW5jZSAhPT0gdGhpcy5jdXJyZW50Q29udGFpbmVyICYmIHRoaXMuY3VycmVudENvbnRhaW5lciAmJgoJCQkJCWl0ZW0uaXRlbVsgMCBdICE9PSB0aGlzLmN1cnJlbnRJdGVtWyAwIF0gKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJdCA9IHRoaXMub3B0aW9ucy50b2xlcmFuY2VFbGVtZW50ID8KCQkJCSQoIHRoaXMub3B0aW9ucy50b2xlcmFuY2VFbGVtZW50LCBpdGVtLml0ZW0gKSA6CgkJCQlpdGVtLml0ZW07CgoJCQlpZiAoICFmYXN0ICkgewoJCQkJaXRlbS53aWR0aCA9IHQub3V0ZXJXaWR0aCgpOwoJCQkJaXRlbS5oZWlnaHQgPSB0Lm91dGVySGVpZ2h0KCk7CgkJCX0KCgkJCXAgPSB0Lm9mZnNldCgpOwoJCQlpdGVtLmxlZnQgPSBwLmxlZnQ7CgkJCWl0ZW0udG9wID0gcC50b3A7CgkJfQoKCQlpZiAoIHRoaXMub3B0aW9ucy5jdXN0b20gJiYgdGhpcy5vcHRpb25zLmN1c3RvbS5yZWZyZXNoQ29udGFpbmVycyApIHsKCQkJdGhpcy5vcHRpb25zLmN1c3RvbS5yZWZyZXNoQ29udGFpbmVycy5jYWxsKCB0aGlzICk7CgkJfSBlbHNlIHsKCQkJZm9yICggaSA9IHRoaXMuY29udGFpbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJCXAgPSB0aGlzLmNvbnRhaW5lcnNbIGkgXS5lbGVtZW50Lm9mZnNldCgpOwoJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUubGVmdCA9IHAubGVmdDsKCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLnRvcCA9IHAudG9wOwoJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUud2lkdGggPQoJCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLmVsZW1lbnQub3V0ZXJXaWR0aCgpOwoJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUuaGVpZ2h0ID0KCQkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5lbGVtZW50Lm91dGVySGVpZ2h0KCk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglfY3JlYXRlUGxhY2Vob2xkZXI6IGZ1bmN0aW9uKCB0aGF0ICkgewoJCXRoYXQgPSB0aGF0IHx8IHRoaXM7CgkJdmFyIGNsYXNzTmFtZSwKCQkJbyA9IHRoYXQub3B0aW9uczsKCgkJaWYgKCAhby5wbGFjZWhvbGRlciB8fCBvLnBsYWNlaG9sZGVyLmNvbnN0cnVjdG9yID09PSBTdHJpbmcgKSB7CgkJCWNsYXNzTmFtZSA9IG8ucGxhY2Vob2xkZXI7CgkJCW8ucGxhY2Vob2xkZXIgPSB7CgkJCQllbGVtZW50OiBmdW5jdGlvbigpIHsKCgkJCQkJdmFyIG5vZGVOYW1lID0gdGhhdC5jdXJyZW50SXRlbVsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCQkJCWVsZW1lbnQgPSAkKCAiPCIgKyBub2RlTmFtZSArICI+IiwgdGhhdC5kb2N1bWVudFsgMCBdICk7CgoJCQkJCQl0aGF0Ll9hZGRDbGFzcyggZWxlbWVudCwgInVpLXNvcnRhYmxlLXBsYWNlaG9sZGVyIiwKCQkJCQkJCQljbGFzc05hbWUgfHwgdGhhdC5jdXJyZW50SXRlbVsgMCBdLmNsYXNzTmFtZSApCgkJCQkJCQkuX3JlbW92ZUNsYXNzKCBlbGVtZW50LCAidWktc29ydGFibGUtaGVscGVyIiApOwoKCQkJCQlpZiAoIG5vZGVOYW1lID09PSAidGJvZHkiICkgewoJCQkJCQl0aGF0Ll9jcmVhdGVUclBsYWNlaG9sZGVyKAoJCQkJCQkJdGhhdC5jdXJyZW50SXRlbS5maW5kKCAidHIiICkuZXEoIDAgKSwKCQkJCQkJCSQoICI8dHI+IiwgdGhhdC5kb2N1bWVudFsgMCBdICkuYXBwZW5kVG8oIGVsZW1lbnQgKQoJCQkJCQkpOwoJCQkJCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAidHIiICkgewoJCQkJCQl0aGF0Ll9jcmVhdGVUclBsYWNlaG9sZGVyKCB0aGF0LmN1cnJlbnRJdGVtLCBlbGVtZW50ICk7CgkJCQkJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJpbWciICkgewoJCQkJCQllbGVtZW50LmF0dHIoICJzcmMiLCB0aGF0LmN1cnJlbnRJdGVtLmF0dHIoICJzcmMiICkgKTsKCQkJCQl9CgoJCQkJCWlmICggIWNsYXNzTmFtZSApIHsKCQkJCQkJZWxlbWVudC5jc3MoICJ2aXNpYmlsaXR5IiwgImhpZGRlbiIgKTsKCQkJCQl9CgoJCQkJCXJldHVybiBlbGVtZW50OwoJCQkJfSwKCQkJCXVwZGF0ZTogZnVuY3Rpb24oIGNvbnRhaW5lciwgcCApIHsKCgkJCQkJLy8gMS4gSWYgYSBjbGFzc05hbWUgaXMgc2V0IGFzICdwbGFjZWhvbGRlciBvcHRpb24sIHdlIGRvbid0IGZvcmNlIHNpemVzIC0KCQkJCQkvLyB0aGUgY2xhc3MgaXMgcmVzcG9uc2libGUgZm9yIHRoYXQKCQkJCQkvLyAyLiBUaGUgb3B0aW9uICdmb3JjZVBsYWNlaG9sZGVyU2l6ZSBjYW4gYmUgZW5hYmxlZCB0byBmb3JjZSBpdCBldmVuIGlmIGEKCQkJCQkvLyBjbGFzcyBuYW1lIGlzIHNwZWNpZmllZAoJCQkJCWlmICggY2xhc3NOYW1lICYmICFvLmZvcmNlUGxhY2Vob2xkZXJTaXplICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQkvL0lmIHRoZSBlbGVtZW50IGRvZXNuJ3QgaGF2ZSBhIGFjdHVhbCBoZWlnaHQgYnkgaXRzZWxmICh3aXRob3V0IHN0eWxlcyBjb21pbmcKCQkJCQkvLyBmcm9tIGEgc3R5bGVzaGVldCksIGl0IHJlY2VpdmVzIHRoZSBpbmxpbmUgaGVpZ2h0IGZyb20gdGhlIGRyYWdnZWQgaXRlbQoJCQkJCWlmICggIXAuaGVpZ2h0KCkgKSB7CgkJCQkJCXAuaGVpZ2h0KAoJCQkJCQkJdGhhdC5jdXJyZW50SXRlbS5pbm5lckhlaWdodCgpIC0KCQkJCQkJCXBhcnNlSW50KCB0aGF0LmN1cnJlbnRJdGVtLmNzcyggInBhZGRpbmdUb3AiICkgfHwgMCwgMTAgKSAtCgkJCQkJCQlwYXJzZUludCggdGhhdC5jdXJyZW50SXRlbS5jc3MoICJwYWRkaW5nQm90dG9tIiApIHx8IDAsIDEwICkgKTsKCQkJCQl9CgkJCQkJaWYgKCAhcC53aWR0aCgpICkgewoJCQkJCQlwLndpZHRoKAoJCQkJCQkJdGhhdC5jdXJyZW50SXRlbS5pbm5lcldpZHRoKCkgLQoJCQkJCQkJcGFyc2VJbnQoIHRoYXQuY3VycmVudEl0ZW0uY3NzKCAicGFkZGluZ0xlZnQiICkgfHwgMCwgMTAgKSAtCgkJCQkJCQlwYXJzZUludCggdGhhdC5jdXJyZW50SXRlbS5jc3MoICJwYWRkaW5nUmlnaHQiICkgfHwgMCwgMTAgKSApOwoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9CgoJCS8vQ3JlYXRlIHRoZSBwbGFjZWhvbGRlcgoJCXRoYXQucGxhY2Vob2xkZXIgPSAkKCBvLnBsYWNlaG9sZGVyLmVsZW1lbnQuY2FsbCggdGhhdC5lbGVtZW50LCB0aGF0LmN1cnJlbnRJdGVtICkgKTsKCgkJLy9BcHBlbmQgaXQgYWZ0ZXIgdGhlIGFjdHVhbCBjdXJyZW50IGl0ZW0KCQl0aGF0LmN1cnJlbnRJdGVtLmFmdGVyKCB0aGF0LnBsYWNlaG9sZGVyICk7CgoJCS8vVXBkYXRlIHRoZSBzaXplIG9mIHRoZSBwbGFjZWhvbGRlciAoVE9ETzogTG9naWMgdG8gZnV6enksIHNlZSBsaW5lIDMxNi8zMTcpCgkJby5wbGFjZWhvbGRlci51cGRhdGUoIHRoYXQsIHRoYXQucGxhY2Vob2xkZXIgKTsKCgl9LAoKCV9jcmVhdGVUclBsYWNlaG9sZGVyOiBmdW5jdGlvbiggc291cmNlVHIsIHRhcmdldFRyICkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJc291cmNlVHIuY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJJCggIjx0ZD4mIzE2MDs8L3RkPiIsIHRoYXQuZG9jdW1lbnRbIDAgXSApCgkJCQkuYXR0ciggImNvbHNwYW4iLCAkKCB0aGlzICkuYXR0ciggImNvbHNwYW4iICkgfHwgMSApCgkJCQkuYXBwZW5kVG8oIHRhcmdldFRyICk7CgkJfSApOwoJfSwKCglfY29udGFjdENvbnRhaW5lcnM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaSwgaiwgZGlzdCwgaXRlbVdpdGhMZWFzdERpc3RhbmNlLCBwb3NQcm9wZXJ0eSwgc2l6ZVByb3BlcnR5LCBjdXIsIG5lYXJCb3R0b20sCgkJCWZsb2F0aW5nLCBheGlzLAoJCQlpbm5lcm1vc3RDb250YWluZXIgPSBudWxsLAoJCQlpbm5lcm1vc3RJbmRleCA9IG51bGw7CgoJCS8vIEdldCBpbm5lcm1vc3QgY29udGFpbmVyIHRoYXQgaW50ZXJzZWN0cyB3aXRoIGl0ZW0KCQlmb3IgKCBpID0gdGhpcy5jb250YWluZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoKCQkJLy8gTmV2ZXIgY29uc2lkZXIgYSBjb250YWluZXIgdGhhdCdzIGxvY2F0ZWQgd2l0aGluIHRoZSBpdGVtIGl0c2VsZgoJCQlpZiAoICQuY29udGFpbnMoIHRoaXMuY3VycmVudEl0ZW1bIDAgXSwgdGhpcy5jb250YWluZXJzWyBpIF0uZWxlbWVudFsgMCBdICkgKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJaWYgKCB0aGlzLl9pbnRlcnNlY3RzV2l0aCggdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUgKSApIHsKCgkJCQkvLyBJZiB3ZSd2ZSBhbHJlYWR5IGZvdW5kIGEgY29udGFpbmVyIGFuZCBpdCdzIG1vcmUgImlubmVyIiB0aGFuIHRoaXMsIHRoZW4gY29udGludWUKCQkJCWlmICggaW5uZXJtb3N0Q29udGFpbmVyICYmCgkJCQkJCSQuY29udGFpbnMoCgkJCQkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5lbGVtZW50WyAwIF0sCgkJCQkJCQlpbm5lcm1vc3RDb250YWluZXIuZWxlbWVudFsgMCBdICkgKSB7CgkJCQkJY29udGludWU7CgkJCQl9CgoJCQkJaW5uZXJtb3N0Q29udGFpbmVyID0gdGhpcy5jb250YWluZXJzWyBpIF07CgkJCQlpbm5lcm1vc3RJbmRleCA9IGk7CgoJCQl9IGVsc2UgewoKCQkJCS8vIGNvbnRhaW5lciBkb2Vzbid0IGludGVyc2VjdC4gdHJpZ2dlciAib3V0IiBldmVudCBpZiBuZWNlc3NhcnkKCQkJCWlmICggdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUub3ZlciApIHsKCQkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5fdHJpZ2dlciggIm91dCIsIGV2ZW50LCB0aGlzLl91aUhhc2goIHRoaXMgKSApOwoJCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLm92ZXIgPSAwOwoJCQkJfQoJCQl9CgoJCX0KCgkJLy8gSWYgbm8gaW50ZXJzZWN0aW5nIGNvbnRhaW5lcnMgZm91bmQsIHJldHVybgoJCWlmICggIWlubmVybW9zdENvbnRhaW5lciApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gTW92ZSB0aGUgaXRlbSBpbnRvIHRoZSBjb250YWluZXIgaWYgaXQncyBub3QgdGhlcmUgYWxyZWFkeQoJCWlmICggdGhpcy5jb250YWluZXJzLmxlbmd0aCA9PT0gMSApIHsKCQkJaWYgKCAhdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLmNvbnRhaW5lckNhY2hlLm92ZXIgKSB7CgkJCQl0aGlzLmNvbnRhaW5lcnNbIGlubmVybW9zdEluZGV4IF0uX3RyaWdnZXIoICJvdmVyIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggdGhpcyApICk7CgkJCQl0aGlzLmNvbnRhaW5lcnNbIGlubmVybW9zdEluZGV4IF0uY29udGFpbmVyQ2FjaGUub3ZlciA9IDE7CgkJCX0KCQl9IGVsc2UgewoKCQkJLy8gV2hlbiBlbnRlcmluZyBhIG5ldyBjb250YWluZXIsIHdlIHdpbGwgZmluZCB0aGUgaXRlbSB3aXRoIHRoZSBsZWFzdCBkaXN0YW5jZSBhbmQKCQkJLy8gYXBwZW5kIG91ciBpdGVtIG5lYXIgaXQKCQkJZGlzdCA9IDEwMDAwOwoJCQlpdGVtV2l0aExlYXN0RGlzdGFuY2UgPSBudWxsOwoJCQlmbG9hdGluZyA9IGlubmVybW9zdENvbnRhaW5lci5mbG9hdGluZyB8fCB0aGlzLl9pc0Zsb2F0aW5nKCB0aGlzLmN1cnJlbnRJdGVtICk7CgkJCXBvc1Byb3BlcnR5ID0gZmxvYXRpbmcgPyAibGVmdCIgOiAidG9wIjsKCQkJc2l6ZVByb3BlcnR5ID0gZmxvYXRpbmcgPyAid2lkdGgiIDogImhlaWdodCI7CgkJCWF4aXMgPSBmbG9hdGluZyA/ICJwYWdlWCIgOiAicGFnZVkiOwoKCQkJZm9yICggaiA9IHRoaXMuaXRlbXMubGVuZ3RoIC0gMTsgaiA+PSAwOyBqLS0gKSB7CgkJCQlpZiAoICEkLmNvbnRhaW5zKAoJCQkJCQl0aGlzLmNvbnRhaW5lcnNbIGlubmVybW9zdEluZGV4IF0uZWxlbWVudFsgMCBdLCB0aGlzLml0ZW1zWyBqIF0uaXRlbVsgMCBdICkKCQkJCSkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQkJaWYgKCB0aGlzLml0ZW1zWyBqIF0uaXRlbVsgMCBdID09PSB0aGlzLmN1cnJlbnRJdGVtWyAwIF0gKSB7CgkJCQkJY29udGludWU7CgkJCQl9CgoJCQkJY3VyID0gdGhpcy5pdGVtc1sgaiBdLml0ZW0ub2Zmc2V0KClbIHBvc1Byb3BlcnR5IF07CgkJCQluZWFyQm90dG9tID0gZmFsc2U7CgkJCQlpZiAoIGV2ZW50WyBheGlzIF0gLSBjdXIgPiB0aGlzLml0ZW1zWyBqIF1bIHNpemVQcm9wZXJ0eSBdIC8gMiApIHsKCQkJCQluZWFyQm90dG9tID0gdHJ1ZTsKCQkJCX0KCgkJCQlpZiAoIE1hdGguYWJzKCBldmVudFsgYXhpcyBdIC0gY3VyICkgPCBkaXN0ICkgewoJCQkJCWRpc3QgPSBNYXRoLmFicyggZXZlbnRbIGF4aXMgXSAtIGN1ciApOwoJCQkJCWl0ZW1XaXRoTGVhc3REaXN0YW5jZSA9IHRoaXMuaXRlbXNbIGogXTsKCQkJCQl0aGlzLmRpcmVjdGlvbiA9IG5lYXJCb3R0b20gPyAidXAiIDogImRvd24iOwoJCQkJfQoJCQl9CgoJCQkvL0NoZWNrIGlmIGRyb3BPbkVtcHR5IGlzIGVuYWJsZWQKCQkJaWYgKCAhaXRlbVdpdGhMZWFzdERpc3RhbmNlICYmICF0aGlzLm9wdGlvbnMuZHJvcE9uRW1wdHkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGhpcy5jdXJyZW50Q29udGFpbmVyID09PSB0aGlzLmNvbnRhaW5lcnNbIGlubmVybW9zdEluZGV4IF0gKSB7CgkJCQlpZiAoICF0aGlzLmN1cnJlbnRDb250YWluZXIuY29udGFpbmVyQ2FjaGUub3ZlciApIHsKCQkJCQl0aGlzLmNvbnRhaW5lcnNbIGlubmVybW9zdEluZGV4IF0uX3RyaWdnZXIoICJvdmVyIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpICk7CgkJCQkJdGhpcy5jdXJyZW50Q29udGFpbmVyLmNvbnRhaW5lckNhY2hlLm92ZXIgPSAxOwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpdGVtV2l0aExlYXN0RGlzdGFuY2UgPwoJCQkJdGhpcy5fcmVhcnJhbmdlKCBldmVudCwgaXRlbVdpdGhMZWFzdERpc3RhbmNlLCBudWxsLCB0cnVlICkgOgoJCQkJdGhpcy5fcmVhcnJhbmdlKCBldmVudCwgbnVsbCwgdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLmVsZW1lbnQsIHRydWUgKTsKCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goKSApOwoJCQl0aGlzLmNvbnRhaW5lcnNbIGlubmVybW9zdEluZGV4IF0uX3RyaWdnZXIoICJjaGFuZ2UiLCBldmVudCwgdGhpcy5fdWlIYXNoKCB0aGlzICkgKTsKCQkJdGhpcy5jdXJyZW50Q29udGFpbmVyID0gdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdOwoKCQkJLy9VcGRhdGUgdGhlIHBsYWNlaG9sZGVyCgkJCXRoaXMub3B0aW9ucy5wbGFjZWhvbGRlci51cGRhdGUoIHRoaXMuY3VycmVudENvbnRhaW5lciwgdGhpcy5wbGFjZWhvbGRlciApOwoKCQkJdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLl90cmlnZ2VyKCAib3ZlciIsIGV2ZW50LCB0aGlzLl91aUhhc2goIHRoaXMgKSApOwoJCQl0aGlzLmNvbnRhaW5lcnNbIGlubmVybW9zdEluZGV4IF0uY29udGFpbmVyQ2FjaGUub3ZlciA9IDE7CgkJfQoKCX0sCgoJX2NyZWF0ZUhlbHBlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJaGVscGVyID0gJC5pc0Z1bmN0aW9uKCBvLmhlbHBlciApID8KCQkJCSQoIG8uaGVscGVyLmFwcGx5KCB0aGlzLmVsZW1lbnRbIDAgXSwgWyBldmVudCwgdGhpcy5jdXJyZW50SXRlbSBdICkgKSA6CgkJCQkoIG8uaGVscGVyID09PSAiY2xvbmUiID8gdGhpcy5jdXJyZW50SXRlbS5jbG9uZSgpIDogdGhpcy5jdXJyZW50SXRlbSApOwoKCQkvL0FkZCB0aGUgaGVscGVyIHRvIHRoZSBET00gaWYgdGhhdCBkaWRuJ3QgaGFwcGVuIGFscmVhZHkKCQlpZiAoICFoZWxwZXIucGFyZW50cyggImJvZHkiICkubGVuZ3RoICkgewoJCQkkKCBvLmFwcGVuZFRvICE9PSAicGFyZW50IiA/CgkJCQlvLmFwcGVuZFRvIDoKCQkJCXRoaXMuY3VycmVudEl0ZW1bIDAgXS5wYXJlbnROb2RlIClbIDAgXS5hcHBlbmRDaGlsZCggaGVscGVyWyAwIF0gKTsKCQl9CgoJCWlmICggaGVscGVyWyAwIF0gPT09IHRoaXMuY3VycmVudEl0ZW1bIDAgXSApIHsKCQkJdGhpcy5fc3RvcmVkQ1NTID0gewoJCQkJd2lkdGg6IHRoaXMuY3VycmVudEl0ZW1bIDAgXS5zdHlsZS53aWR0aCwKCQkJCWhlaWdodDogdGhpcy5jdXJyZW50SXRlbVsgMCBdLnN0eWxlLmhlaWdodCwKCQkJCXBvc2l0aW9uOiB0aGlzLmN1cnJlbnRJdGVtLmNzcyggInBvc2l0aW9uIiApLAoJCQkJdG9wOiB0aGlzLmN1cnJlbnRJdGVtLmNzcyggInRvcCIgKSwKCQkJCWxlZnQ6IHRoaXMuY3VycmVudEl0ZW0uY3NzKCAibGVmdCIgKQoJCQl9OwoJCX0KCgkJaWYgKCAhaGVscGVyWyAwIF0uc3R5bGUud2lkdGggfHwgby5mb3JjZUhlbHBlclNpemUgKSB7CgkJCWhlbHBlci53aWR0aCggdGhpcy5jdXJyZW50SXRlbS53aWR0aCgpICk7CgkJfQoJCWlmICggIWhlbHBlclsgMCBdLnN0eWxlLmhlaWdodCB8fCBvLmZvcmNlSGVscGVyU2l6ZSApIHsKCQkJaGVscGVyLmhlaWdodCggdGhpcy5jdXJyZW50SXRlbS5oZWlnaHQoKSApOwoJCX0KCgkJcmV0dXJuIGhlbHBlcjsKCgl9LAoKCV9hZGp1c3RPZmZzZXRGcm9tSGVscGVyOiBmdW5jdGlvbiggb2JqICkgewoJCWlmICggdHlwZW9mIG9iaiA9PT0gInN0cmluZyIgKSB7CgkJCW9iaiA9IG9iai5zcGxpdCggIiAiICk7CgkJfQoJCWlmICggJC5pc0FycmF5KCBvYmogKSApIHsKCQkJb2JqID0geyBsZWZ0OiArb2JqWyAwIF0sIHRvcDogK29ialsgMSBdIHx8IDAgfTsKCQl9CgkJaWYgKCAibGVmdCIgaW4gb2JqICkgewoJCQl0aGlzLm9mZnNldC5jbGljay5sZWZ0ID0gb2JqLmxlZnQgKyB0aGlzLm1hcmdpbnMubGVmdDsKCQl9CgkJaWYgKCAicmlnaHQiIGluIG9iaiApIHsKCQkJdGhpcy5vZmZzZXQuY2xpY2subGVmdCA9IHRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLSBvYmoucmlnaHQgKyB0aGlzLm1hcmdpbnMubGVmdDsKCQl9CgkJaWYgKCAidG9wIiBpbiBvYmogKSB7CgkJCXRoaXMub2Zmc2V0LmNsaWNrLnRvcCA9IG9iai50b3AgKyB0aGlzLm1hcmdpbnMudG9wOwoJCX0KCQlpZiAoICJib3R0b20iIGluIG9iaiApIHsKCQkJdGhpcy5vZmZzZXQuY2xpY2sudG9wID0gdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLSBvYmouYm90dG9tICsgdGhpcy5tYXJnaW5zLnRvcDsKCQl9Cgl9LAoKCV9nZXRQYXJlbnRPZmZzZXQ6IGZ1bmN0aW9uKCkgewoKCQkvL0dldCB0aGUgb2Zmc2V0UGFyZW50IGFuZCBjYWNoZSBpdHMgcG9zaXRpb24KCQl0aGlzLm9mZnNldFBhcmVudCA9IHRoaXMuaGVscGVyLm9mZnNldFBhcmVudCgpOwoJCXZhciBwbyA9IHRoaXMub2Zmc2V0UGFyZW50Lm9mZnNldCgpOwoKCQkvLyBUaGlzIGlzIGEgc3BlY2lhbCBjYXNlIHdoZXJlIHdlIG5lZWQgdG8gbW9kaWZ5IGEgb2Zmc2V0IGNhbGN1bGF0ZWQgb24gc3RhcnQsIHNpbmNlIHRoZQoJCS8vIGZvbGxvd2luZyBoYXBwZW5lZDoKCQkvLyAxLiBUaGUgcG9zaXRpb24gb2YgdGhlIGhlbHBlciBpcyBhYnNvbHV0ZSwgc28gaXQncyBwb3NpdGlvbiBpcyBjYWxjdWxhdGVkIGJhc2VkIG9uIHRoZQoJCS8vIG5leHQgcG9zaXRpb25lZCBwYXJlbnQKCQkvLyAyLiBUaGUgYWN0dWFsIG9mZnNldCBwYXJlbnQgaXMgYSBjaGlsZCBvZiB0aGUgc2Nyb2xsIHBhcmVudCwgYW5kIHRoZSBzY3JvbGwgcGFyZW50IGlzbid0CgkJLy8gdGhlIGRvY3VtZW50LCB3aGljaCBtZWFucyB0aGF0IHRoZSBzY3JvbGwgaXMgaW5jbHVkZWQgaW4gdGhlIGluaXRpYWwgY2FsY3VsYXRpb24gb2YgdGhlCgkJLy8gb2Zmc2V0IG9mIHRoZSBwYXJlbnQsIGFuZCBuZXZlciByZWNhbGN1bGF0ZWQgdXBvbiBkcmFnCgkJaWYgKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAiYWJzb2x1dGUiICYmIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gIT09IHRoaXMuZG9jdW1lbnRbIDAgXSAmJgoJCQkJJC5jb250YWlucyggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSwgdGhpcy5vZmZzZXRQYXJlbnRbIDAgXSApICkgewoJCQlwby5sZWZ0ICs9IHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKTsKCQkJcG8udG9wICs9IHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCgpOwoJCX0KCgkJLy8gVGhpcyBuZWVkcyB0byBiZSBhY3R1YWxseSBkb25lIGZvciBhbGwgYnJvd3NlcnMsIHNpbmNlIHBhZ2VYL3BhZ2VZIGluY2x1ZGVzIHRoaXMKCQkvLyBpbmZvcm1hdGlvbiB3aXRoIGFuIHVnbHkgSUUgZml4CgkJaWYgKCB0aGlzLm9mZnNldFBhcmVudFsgMCBdID09PSB0aGlzLmRvY3VtZW50WyAwIF0uYm9keSB8fAoJCQkJKCB0aGlzLm9mZnNldFBhcmVudFsgMCBdLnRhZ05hbWUgJiYKCQkJCXRoaXMub2Zmc2V0UGFyZW50WyAwIF0udGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaHRtbCIgJiYgJC51aS5pZSApICkgewoJCQlwbyA9IHsgdG9wOiAwLCBsZWZ0OiAwIH07CgkJfQoKCQlyZXR1cm4gewoJCQl0b3A6IHBvLnRvcCArICggcGFyc2VJbnQoIHRoaXMub2Zmc2V0UGFyZW50LmNzcyggImJvcmRlclRvcFdpZHRoIiApLCAxMCApIHx8IDAgKSwKCQkJbGVmdDogcG8ubGVmdCArICggcGFyc2VJbnQoIHRoaXMub2Zmc2V0UGFyZW50LmNzcyggImJvcmRlckxlZnRXaWR0aCIgKSwgMTAgKSB8fCAwICkKCQl9OwoKCX0sCgoJX2dldFJlbGF0aXZlT2Zmc2V0OiBmdW5jdGlvbigpIHsKCgkJaWYgKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAicmVsYXRpdmUiICkgewoJCQl2YXIgcCA9IHRoaXMuY3VycmVudEl0ZW0ucG9zaXRpb24oKTsKCQkJcmV0dXJuIHsKCQkJCXRvcDogcC50b3AgLSAoIHBhcnNlSW50KCB0aGlzLmhlbHBlci5jc3MoICJ0b3AiICksIDEwICkgfHwgMCApICsKCQkJCQl0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKSwKCQkJCWxlZnQ6IHAubGVmdCAtICggcGFyc2VJbnQoIHRoaXMuaGVscGVyLmNzcyggImxlZnQiICksIDEwICkgfHwgMCApICsKCQkJCQl0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCkKCQkJfTsKCQl9IGVsc2UgewoJCQlyZXR1cm4geyB0b3A6IDAsIGxlZnQ6IDAgfTsKCQl9CgoJfSwKCglfY2FjaGVNYXJnaW5zOiBmdW5jdGlvbigpIHsKCQl0aGlzLm1hcmdpbnMgPSB7CgkJCWxlZnQ6ICggcGFyc2VJbnQoIHRoaXMuY3VycmVudEl0ZW0uY3NzKCAibWFyZ2luTGVmdCIgKSwgMTAgKSB8fCAwICksCgkJCXRvcDogKCBwYXJzZUludCggdGhpcy5jdXJyZW50SXRlbS5jc3MoICJtYXJnaW5Ub3AiICksIDEwICkgfHwgMCApCgkJfTsKCX0sCgoJX2NhY2hlSGVscGVyUHJvcG9ydGlvbnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMgPSB7CgkJCXdpZHRoOiB0aGlzLmhlbHBlci5vdXRlcldpZHRoKCksCgkJCWhlaWdodDogdGhpcy5oZWxwZXIub3V0ZXJIZWlnaHQoKQoJCX07Cgl9LAoKCV9zZXRDb250YWlubWVudDogZnVuY3Rpb24oKSB7CgoJCXZhciBjZSwgY28sIG92ZXIsCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgkJaWYgKCBvLmNvbnRhaW5tZW50ID09PSAicGFyZW50IiApIHsKCQkJby5jb250YWlubWVudCA9IHRoaXMuaGVscGVyWyAwIF0ucGFyZW50Tm9kZTsKCQl9CgkJaWYgKCBvLmNvbnRhaW5tZW50ID09PSAiZG9jdW1lbnQiIHx8IG8uY29udGFpbm1lbnQgPT09ICJ3aW5kb3ciICkgewoJCQl0aGlzLmNvbnRhaW5tZW50ID0gWwoJCQkJMCAtIHRoaXMub2Zmc2V0LnJlbGF0aXZlLmxlZnQgLSB0aGlzLm9mZnNldC5wYXJlbnQubGVmdCwKCQkJCTAgLSB0aGlzLm9mZnNldC5yZWxhdGl2ZS50b3AgLSB0aGlzLm9mZnNldC5wYXJlbnQudG9wLAoJCQkJby5jb250YWlubWVudCA9PT0gImRvY3VtZW50IiA/CgkJCQkJdGhpcy5kb2N1bWVudC53aWR0aCgpIDoKCQkJCQl0aGlzLndpbmRvdy53aWR0aCgpIC0gdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAtIHRoaXMubWFyZ2lucy5sZWZ0LAoJCQkJKCBvLmNvbnRhaW5tZW50ID09PSAiZG9jdW1lbnQiID8KCQkJCQkoIHRoaXMuZG9jdW1lbnQuaGVpZ2h0KCkgfHwgZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlLnNjcm9sbEhlaWdodCApIDoKCQkJCQl0aGlzLndpbmRvdy5oZWlnaHQoKSB8fCB0aGlzLmRvY3VtZW50WyAwIF0uYm9keS5wYXJlbnROb2RlLnNjcm9sbEhlaWdodAoJCQkJKSAtIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0gdGhpcy5tYXJnaW5zLnRvcAoJCQldOwoJCX0KCgkJaWYgKCAhKCAvXihkb2N1bWVudHx3aW5kb3d8cGFyZW50KSQvICkudGVzdCggby5jb250YWlubWVudCApICkgewoJCQljZSA9ICQoIG8uY29udGFpbm1lbnQgKVsgMCBdOwoJCQljbyA9ICQoIG8uY29udGFpbm1lbnQgKS5vZmZzZXQoKTsKCQkJb3ZlciA9ICggJCggY2UgKS5jc3MoICJvdmVyZmxvdyIgKSAhPT0gImhpZGRlbiIgKTsKCgkJCXRoaXMuY29udGFpbm1lbnQgPSBbCgkJCQljby5sZWZ0ICsgKCBwYXJzZUludCggJCggY2UgKS5jc3MoICJib3JkZXJMZWZ0V2lkdGgiICksIDEwICkgfHwgMCApICsKCQkJCQkoIHBhcnNlSW50KCAkKCBjZSApLmNzcyggInBhZGRpbmdMZWZ0IiApLCAxMCApIHx8IDAgKSAtIHRoaXMubWFyZ2lucy5sZWZ0LAoJCQkJY28udG9wICsgKCBwYXJzZUludCggJCggY2UgKS5jc3MoICJib3JkZXJUb3BXaWR0aCIgKSwgMTAgKSB8fCAwICkgKwoJCQkJCSggcGFyc2VJbnQoICQoIGNlICkuY3NzKCAicGFkZGluZ1RvcCIgKSwgMTAgKSB8fCAwICkgLSB0aGlzLm1hcmdpbnMudG9wLAoJCQkJY28ubGVmdCArICggb3ZlciA/IE1hdGgubWF4KCBjZS5zY3JvbGxXaWR0aCwgY2Uub2Zmc2V0V2lkdGggKSA6IGNlLm9mZnNldFdpZHRoICkgLQoJCQkJCSggcGFyc2VJbnQoICQoIGNlICkuY3NzKCAiYm9yZGVyTGVmdFdpZHRoIiApLCAxMCApIHx8IDAgKSAtCgkJCQkJKCBwYXJzZUludCggJCggY2UgKS5jc3MoICJwYWRkaW5nUmlnaHQiICksIDEwICkgfHwgMCApIC0KCQkJCQl0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC0gdGhpcy5tYXJnaW5zLmxlZnQsCgkJCQljby50b3AgKyAoIG92ZXIgPyBNYXRoLm1heCggY2Uuc2Nyb2xsSGVpZ2h0LCBjZS5vZmZzZXRIZWlnaHQgKSA6IGNlLm9mZnNldEhlaWdodCApIC0KCQkJCQkoIHBhcnNlSW50KCAkKCBjZSApLmNzcyggImJvcmRlclRvcFdpZHRoIiApLCAxMCApIHx8IDAgKSAtCgkJCQkJKCBwYXJzZUludCggJCggY2UgKS5jc3MoICJwYWRkaW5nQm90dG9tIiApLCAxMCApIHx8IDAgKSAtCgkJCQkJdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLSB0aGlzLm1hcmdpbnMudG9wCgkJCV07CgkJfQoKCX0sCgoJX2NvbnZlcnRQb3NpdGlvblRvOiBmdW5jdGlvbiggZCwgcG9zICkgewoKCQlpZiAoICFwb3MgKSB7CgkJCXBvcyA9IHRoaXMucG9zaXRpb247CgkJfQoJCXZhciBtb2QgPSBkID09PSAiYWJzb2x1dGUiID8gMSA6IC0xLAoJCQlzY3JvbGwgPSB0aGlzLmNzc1Bvc2l0aW9uID09PSAiYWJzb2x1dGUiICYmCgkJCQkhKCB0aGlzLnNjcm9sbFBhcmVudFsgMCBdICE9PSB0aGlzLmRvY3VtZW50WyAwIF0gJiYKCQkJCSQuY29udGFpbnMoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0sIHRoaXMub2Zmc2V0UGFyZW50WyAwIF0gKSApID8KCQkJCQl0aGlzLm9mZnNldFBhcmVudCA6CgkJCQkJdGhpcy5zY3JvbGxQYXJlbnQsCgkJCXNjcm9sbElzUm9vdE5vZGUgPSAoIC8oaHRtbHxib2R5KS9pICkudGVzdCggc2Nyb2xsWyAwIF0udGFnTmFtZSApOwoKCQlyZXR1cm4gewoJCQl0b3A6ICgKCgkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24KCQkJCXBvcy50b3AJKwoKCQkJCS8vIE9ubHkgZm9yIHJlbGF0aXZlIHBvc2l0aW9uZWQgbm9kZXM6IFJlbGF0aXZlIG9mZnNldCBmcm9tIGVsZW1lbnQgdG8gb2Zmc2V0IHBhcmVudAoJCQkJdGhpcy5vZmZzZXQucmVsYXRpdmUudG9wICogbW9kICsKCgkJCQkvLyBUaGUgb2Zmc2V0UGFyZW50J3Mgb2Zmc2V0IHdpdGhvdXQgYm9yZGVycyAob2Zmc2V0ICsgYm9yZGVyKQoJCQkJdGhpcy5vZmZzZXQucGFyZW50LnRvcCAqIG1vZCAtCgkJCQkoICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA/CgkJCQkJLXRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCgpIDoKCQkJCQkoIHNjcm9sbElzUm9vdE5vZGUgPyAwIDogc2Nyb2xsLnNjcm9sbFRvcCgpICkgKSAqIG1vZCApCgkJCSksCgkJCWxlZnQ6ICgKCgkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24KCQkJCXBvcy5sZWZ0ICsKCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQKCQkJCXRoaXMub2Zmc2V0LnJlbGF0aXZlLmxlZnQgKiBtb2QgKwoKCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpCgkJCQl0aGlzLm9mZnNldC5wYXJlbnQubGVmdCAqIG1vZAktCgkJCQkoICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA/CgkJCQkJLXRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKSA6IHNjcm9sbElzUm9vdE5vZGUgPyAwIDoKCQkJCQlzY3JvbGwuc2Nyb2xsTGVmdCgpICkgKiBtb2QgKQoJCQkpCgkJfTsKCgl9LAoKCV9nZW5lcmF0ZVBvc2l0aW9uOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCXZhciB0b3AsIGxlZnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXBhZ2VYID0gZXZlbnQucGFnZVgsCgkJCXBhZ2VZID0gZXZlbnQucGFnZVksCgkJCXNjcm9sbCA9IHRoaXMuY3NzUG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgJiYKCQkJCSEoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gIT09IHRoaXMuZG9jdW1lbnRbIDAgXSAmJgoJCQkJJC5jb250YWlucyggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSwgdGhpcy5vZmZzZXRQYXJlbnRbIDAgXSApICkgPwoJCQkJCXRoaXMub2Zmc2V0UGFyZW50IDoKCQkJCQl0aGlzLnNjcm9sbFBhcmVudCwKCQkJCXNjcm9sbElzUm9vdE5vZGUgPSAoIC8oaHRtbHxib2R5KS9pICkudGVzdCggc2Nyb2xsWyAwIF0udGFnTmFtZSApOwoKCQkvLyBUaGlzIGlzIGFub3RoZXIgdmVyeSB3ZWlyZCBzcGVjaWFsIGNhc2UgdGhhdCBvbmx5IGhhcHBlbnMgZm9yIHJlbGF0aXZlIGVsZW1lbnRzOgoJCS8vIDEuIElmIHRoZSBjc3MgcG9zaXRpb24gaXMgcmVsYXRpdmUKCQkvLyAyLiBhbmQgdGhlIHNjcm9sbCBwYXJlbnQgaXMgdGhlIGRvY3VtZW50IG9yIHNpbWlsYXIgdG8gdGhlIG9mZnNldCBwYXJlbnQKCQkvLyB3ZSBoYXZlIHRvIHJlZnJlc2ggdGhlIHJlbGF0aXZlIG9mZnNldCBkdXJpbmcgdGhlIHNjcm9sbCBzbyB0aGVyZSBhcmUgbm8ganVtcHMKCQlpZiAoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJyZWxhdGl2ZSIgJiYgISggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSAhPT0gdGhpcy5kb2N1bWVudFsgMCBdICYmCgkJCQl0aGlzLnNjcm9sbFBhcmVudFsgMCBdICE9PSB0aGlzLm9mZnNldFBhcmVudFsgMCBdICkgKSB7CgkJCXRoaXMub2Zmc2V0LnJlbGF0aXZlID0gdGhpcy5fZ2V0UmVsYXRpdmVPZmZzZXQoKTsKCQl9CgoJCS8qCgkJICogLSBQb3NpdGlvbiBjb25zdHJhaW5pbmcgLQoJCSAqIENvbnN0cmFpbiB0aGUgcG9zaXRpb24gdG8gYSBtaXggb2YgZ3JpZCwgY29udGFpbm1lbnQuCgkJICovCgoJCWlmICggdGhpcy5vcmlnaW5hbFBvc2l0aW9uICkgeyAvL0lmIHdlIGFyZSBub3QgZHJhZ2dpbmcgeWV0LCB3ZSB3b24ndCBjaGVjayBmb3Igb3B0aW9ucwoKCQkJaWYgKCB0aGlzLmNvbnRhaW5tZW50ICkgewoJCQkJaWYgKCBldmVudC5wYWdlWCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPCB0aGlzLmNvbnRhaW5tZW50WyAwIF0gKSB7CgkJCQkJcGFnZVggPSB0aGlzLmNvbnRhaW5tZW50WyAwIF0gKyB0aGlzLm9mZnNldC5jbGljay5sZWZ0OwoJCQkJfQoJCQkJaWYgKCBldmVudC5wYWdlWSAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA8IHRoaXMuY29udGFpbm1lbnRbIDEgXSApIHsKCQkJCQlwYWdlWSA9IHRoaXMuY29udGFpbm1lbnRbIDEgXSArIHRoaXMub2Zmc2V0LmNsaWNrLnRvcDsKCQkJCX0KCQkJCWlmICggZXZlbnQucGFnZVggLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0ID4gdGhpcy5jb250YWlubWVudFsgMiBdICkgewoJCQkJCXBhZ2VYID0gdGhpcy5jb250YWlubWVudFsgMiBdICsgdGhpcy5vZmZzZXQuY2xpY2subGVmdDsKCQkJCX0KCQkJCWlmICggZXZlbnQucGFnZVkgLSB0aGlzLm9mZnNldC5jbGljay50b3AgPiB0aGlzLmNvbnRhaW5tZW50WyAzIF0gKSB7CgkJCQkJcGFnZVkgPSB0aGlzLmNvbnRhaW5tZW50WyAzIF0gKyB0aGlzLm9mZnNldC5jbGljay50b3A7CgkJCQl9CgkJCX0KCgkJCWlmICggby5ncmlkICkgewoJCQkJdG9wID0gdGhpcy5vcmlnaW5hbFBhZ2VZICsgTWF0aC5yb3VuZCggKCBwYWdlWSAtIHRoaXMub3JpZ2luYWxQYWdlWSApIC8KCQkJCQlvLmdyaWRbIDEgXSApICogby5ncmlkWyAxIF07CgkJCQlwYWdlWSA9IHRoaXMuY29udGFpbm1lbnQgPwoJCQkJCSggKCB0b3AgLSB0aGlzLm9mZnNldC5jbGljay50b3AgPj0gdGhpcy5jb250YWlubWVudFsgMSBdICYmCgkJCQkJCXRvcCAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA8PSB0aGlzLmNvbnRhaW5tZW50WyAzIF0gKSA/CgkJCQkJCQl0b3AgOgoJCQkJCQkJKCAoIHRvcCAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA+PSB0aGlzLmNvbnRhaW5tZW50WyAxIF0gKSA/CgkJCQkJCQkJdG9wIC0gby5ncmlkWyAxIF0gOiB0b3AgKyBvLmdyaWRbIDEgXSApICkgOgoJCQkJCQkJCXRvcDsKCgkJCQlsZWZ0ID0gdGhpcy5vcmlnaW5hbFBhZ2VYICsgTWF0aC5yb3VuZCggKCBwYWdlWCAtIHRoaXMub3JpZ2luYWxQYWdlWCApIC8KCQkJCQlvLmdyaWRbIDAgXSApICogby5ncmlkWyAwIF07CgkJCQlwYWdlWCA9IHRoaXMuY29udGFpbm1lbnQgPwoJCQkJCSggKCBsZWZ0IC0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCA+PSB0aGlzLmNvbnRhaW5tZW50WyAwIF0gJiYKCQkJCQkJbGVmdCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPD0gdGhpcy5jb250YWlubWVudFsgMiBdICkgPwoJCQkJCQkJbGVmdCA6CgkJCQkJCQkoICggbGVmdCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPj0gdGhpcy5jb250YWlubWVudFsgMCBdICkgPwoJCQkJCQkJCWxlZnQgLSBvLmdyaWRbIDAgXSA6IGxlZnQgKyBvLmdyaWRbIDAgXSApICkgOgoJCQkJCQkJCWxlZnQ7CgkJCX0KCgkJfQoKCQlyZXR1cm4gewoJCQl0b3A6ICgKCgkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24KCQkJCXBhZ2VZIC0KCgkJCQkvLyBDbGljayBvZmZzZXQgKHJlbGF0aXZlIHRvIHRoZSBlbGVtZW50KQoJCQkJdGhpcy5vZmZzZXQuY2xpY2sudG9wIC0KCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQKCQkJCXRoaXMub2Zmc2V0LnJlbGF0aXZlLnRvcCAtCgoJCQkJLy8gVGhlIG9mZnNldFBhcmVudCdzIG9mZnNldCB3aXRob3V0IGJvcmRlcnMgKG9mZnNldCArIGJvcmRlcikKCQkJCXRoaXMub2Zmc2V0LnBhcmVudC50b3AgKwoJCQkJKCAoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJmaXhlZCIgPwoJCQkJCS10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKSA6CgkJCQkJKCBzY3JvbGxJc1Jvb3ROb2RlID8gMCA6IHNjcm9sbC5zY3JvbGxUb3AoKSApICkgKQoJCQkpLAoJCQlsZWZ0OiAoCgoJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uCgkJCQlwYWdlWCAtCgoJCQkJLy8gQ2xpY2sgb2Zmc2V0IChyZWxhdGl2ZSB0byB0aGUgZWxlbWVudCkKCQkJCXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgLQoKCQkJCS8vIE9ubHkgZm9yIHJlbGF0aXZlIHBvc2l0aW9uZWQgbm9kZXM6IFJlbGF0aXZlIG9mZnNldCBmcm9tIGVsZW1lbnQgdG8gb2Zmc2V0IHBhcmVudAoJCQkJdGhpcy5vZmZzZXQucmVsYXRpdmUubGVmdCAtCgoJCQkJLy8gVGhlIG9mZnNldFBhcmVudCdzIG9mZnNldCB3aXRob3V0IGJvcmRlcnMgKG9mZnNldCArIGJvcmRlcikKCQkJCXRoaXMub2Zmc2V0LnBhcmVudC5sZWZ0ICsKCQkJCSggKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAiZml4ZWQiID8KCQkJCQktdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsTGVmdCgpIDoKCQkJCQlzY3JvbGxJc1Jvb3ROb2RlID8gMCA6IHNjcm9sbC5zY3JvbGxMZWZ0KCkgKSApCgkJCSkKCQl9OwoKCX0sCgoJX3JlYXJyYW5nZTogZnVuY3Rpb24oIGV2ZW50LCBpLCBhLCBoYXJkUmVmcmVzaCApIHsKCgkJYSA/IGFbIDAgXS5hcHBlbmRDaGlsZCggdGhpcy5wbGFjZWhvbGRlclsgMCBdICkgOgoJCQlpLml0ZW1bIDAgXS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggdGhpcy5wbGFjZWhvbGRlclsgMCBdLAoJCQkJKCB0aGlzLmRpcmVjdGlvbiA9PT0gImRvd24iID8gaS5pdGVtWyAwIF0gOiBpLml0ZW1bIDAgXS5uZXh0U2libGluZyApICk7CgoJCS8vVmFyaW91cyB0aGluZ3MgZG9uZSBoZXJlIHRvIGltcHJvdmUgdGhlIHBlcmZvcm1hbmNlOgoJCS8vIDEuIHdlIGNyZWF0ZSBhIHNldFRpbWVvdXQsIHRoYXQgY2FsbHMgcmVmcmVzaFBvc2l0aW9ucwoJCS8vIDIuIG9uIHRoZSBpbnN0YW5jZSwgd2UgaGF2ZSBhIGNvdW50ZXIgdmFyaWFibGUsIHRoYXQgZ2V0J3MgaGlnaGVyIGFmdGVyIGV2ZXJ5IGFwcGVuZAoJCS8vIDMuIG9uIHRoZSBsb2NhbCBzY29wZSwgd2UgY29weSB0aGUgY291bnRlciB2YXJpYWJsZSwgYW5kIGNoZWNrIGluIHRoZSB0aW1lb3V0LAoJCS8vIGlmIGl0J3Mgc3RpbGwgdGhlIHNhbWUKCQkvLyA0LiB0aGlzIGxldHMgb25seSB0aGUgbGFzdCBhZGRpdGlvbiB0byB0aGUgdGltZW91dCBzdGFjayB0aHJvdWdoCgkJdGhpcy5jb3VudGVyID0gdGhpcy5jb3VudGVyID8gKyt0aGlzLmNvdW50ZXIgOiAxOwoJCXZhciBjb3VudGVyID0gdGhpcy5jb3VudGVyOwoKCQl0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCWlmICggY291bnRlciA9PT0gdGhpcy5jb3VudGVyICkgewoKCQkJCS8vUHJlY29tcHV0ZSBhZnRlciBlYWNoIERPTSBpbnNlcnRpb24sIE5PVCBvbiBtb3VzZW1vdmUKCQkJCXRoaXMucmVmcmVzaFBvc2l0aW9ucyggIWhhcmRSZWZyZXNoICk7CgkJCX0KCQl9ICk7CgoJfSwKCglfY2xlYXI6IGZ1bmN0aW9uKCBldmVudCwgbm9Qcm9wYWdhdGlvbiApIHsKCgkJdGhpcy5yZXZlcnRpbmcgPSBmYWxzZTsKCgkJLy8gV2UgZGVsYXkgYWxsIGV2ZW50cyB0aGF0IGhhdmUgdG8gYmUgdHJpZ2dlcmVkIHRvIGFmdGVyIHRoZSBwb2ludCB3aGVyZSB0aGUgcGxhY2Vob2xkZXIKCQkvLyBoYXMgYmVlbiByZW1vdmVkIGFuZCBldmVyeXRoaW5nIGVsc2Ugbm9ybWFsaXplZCBhZ2FpbgoJCXZhciBpLAoJCQlkZWxheWVkVHJpZ2dlcnMgPSBbXTsKCgkJLy8gV2UgZmlyc3QgaGF2ZSB0byB1cGRhdGUgdGhlIGRvbSBwb3NpdGlvbiBvZiB0aGUgYWN0dWFsIGN1cnJlbnRJdGVtCgkJLy8gTm90ZTogZG9uJ3QgZG8gaXQgaWYgdGhlIGN1cnJlbnQgaXRlbSBpcyBhbHJlYWR5IHJlbW92ZWQgKGJ5IGEgdXNlciksIG9yIGl0IGdldHMKCQkvLyByZWFwcGVuZGVkIChzZWUgIzQwODgpCgkJaWYgKCAhdGhpcy5fbm9GaW5hbFNvcnQgJiYgdGhpcy5jdXJyZW50SXRlbS5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCXRoaXMucGxhY2Vob2xkZXIuYmVmb3JlKCB0aGlzLmN1cnJlbnRJdGVtICk7CgkJfQoJCXRoaXMuX25vRmluYWxTb3J0ID0gbnVsbDsKCgkJaWYgKCB0aGlzLmhlbHBlclsgMCBdID09PSB0aGlzLmN1cnJlbnRJdGVtWyAwIF0gKSB7CgkJCWZvciAoIGkgaW4gdGhpcy5fc3RvcmVkQ1NTICkgewoJCQkJaWYgKCB0aGlzLl9zdG9yZWRDU1NbIGkgXSA9PT0gImF1dG8iIHx8IHRoaXMuX3N0b3JlZENTU1sgaSBdID09PSAic3RhdGljIiApIHsKCQkJCQl0aGlzLl9zdG9yZWRDU1NbIGkgXSA9ICIiOwoJCQkJfQoJCQl9CgkJCXRoaXMuY3VycmVudEl0ZW0uY3NzKCB0aGlzLl9zdG9yZWRDU1MgKTsKCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuY3VycmVudEl0ZW0sICJ1aS1zb3J0YWJsZS1oZWxwZXIiICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5jdXJyZW50SXRlbS5zaG93KCk7CgkJfQoKCQlpZiAoIHRoaXMuZnJvbU91dHNpZGUgJiYgIW5vUHJvcGFnYXRpb24gKSB7CgkJCWRlbGF5ZWRUcmlnZ2Vycy5wdXNoKCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl90cmlnZ2VyKCAicmVjZWl2ZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goIHRoaXMuZnJvbU91dHNpZGUgKSApOwoJCQl9ICk7CgkJfQoJCWlmICggKCB0aGlzLmZyb21PdXRzaWRlIHx8CgkJCQl0aGlzLmRvbVBvc2l0aW9uLnByZXYgIT09CgkJCQl0aGlzLmN1cnJlbnRJdGVtLnByZXYoKS5ub3QoICIudWktc29ydGFibGUtaGVscGVyIiApWyAwIF0gfHwKCQkJCXRoaXMuZG9tUG9zaXRpb24ucGFyZW50ICE9PSB0aGlzLmN1cnJlbnRJdGVtLnBhcmVudCgpWyAwIF0gKSAmJiAhbm9Qcm9wYWdhdGlvbiApIHsKCgkJCS8vIFRyaWdnZXIgdXBkYXRlIGNhbGxiYWNrIGlmIHRoZSBET00gcG9zaXRpb24gaGFzIGNoYW5nZWQKCQkJZGVsYXllZFRyaWdnZXJzLnB1c2goIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXRoaXMuX3RyaWdnZXIoICJ1cGRhdGUiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkgKTsKCQkJfSApOwoJCX0KCgkJLy8gQ2hlY2sgaWYgdGhlIGl0ZW1zIENvbnRhaW5lciBoYXMgQ2hhbmdlZCBhbmQgdHJpZ2dlciBhcHByb3ByaWF0ZQoJCS8vIGV2ZW50cy4KCQlpZiAoIHRoaXMgIT09IHRoaXMuY3VycmVudENvbnRhaW5lciApIHsKCQkJaWYgKCAhbm9Qcm9wYWdhdGlvbiApIHsKCQkJCWRlbGF5ZWRUcmlnZ2Vycy5wdXNoKCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJdGhpcy5fdHJpZ2dlciggInJlbW92ZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goKSApOwoJCQkJfSApOwoJCQkJZGVsYXllZFRyaWdnZXJzLnB1c2goICggZnVuY3Rpb24oIGMgKSB7CgkJCQkJcmV0dXJuIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJYy5fdHJpZ2dlciggInJlY2VpdmUiLCBldmVudCwgdGhpcy5fdWlIYXNoKCB0aGlzICkgKTsKCQkJCQl9OwoJCQkJfSApLmNhbGwoIHRoaXMsIHRoaXMuY3VycmVudENvbnRhaW5lciApICk7CgkJCQlkZWxheWVkVHJpZ2dlcnMucHVzaCggKCBmdW5jdGlvbiggYyApIHsKCQkJCQlyZXR1cm4gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCQljLl90cmlnZ2VyKCAidXBkYXRlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggdGhpcyApICk7CgkJCQkJfTsKCQkJCX0gKS5jYWxsKCB0aGlzLCB0aGlzLmN1cnJlbnRDb250YWluZXIgKSApOwoJCQl9CgkJfQoKCQkvL1Bvc3QgZXZlbnRzIHRvIGNvbnRhaW5lcnMKCQlmdW5jdGlvbiBkZWxheUV2ZW50KCB0eXBlLCBpbnN0YW5jZSwgY29udGFpbmVyICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJY29udGFpbmVyLl90cmlnZ2VyKCB0eXBlLCBldmVudCwgaW5zdGFuY2UuX3VpSGFzaCggaW5zdGFuY2UgKSApOwoJCQl9OwoJCX0KCQlmb3IgKCBpID0gdGhpcy5jb250YWluZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQlpZiAoICFub1Byb3BhZ2F0aW9uICkgewoJCQkJZGVsYXllZFRyaWdnZXJzLnB1c2goIGRlbGF5RXZlbnQoICJkZWFjdGl2YXRlIiwgdGhpcywgdGhpcy5jb250YWluZXJzWyBpIF0gKSApOwoJCQl9CgkJCWlmICggdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUub3ZlciApIHsKCQkJCWRlbGF5ZWRUcmlnZ2Vycy5wdXNoKCBkZWxheUV2ZW50KCAib3V0IiwgdGhpcywgdGhpcy5jb250YWluZXJzWyBpIF0gKSApOwoJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUub3ZlciA9IDA7CgkJCX0KCQl9CgoJCS8vRG8gd2hhdCB3YXMgb3JpZ2luYWxseSBpbiBwbHVnaW5zCgkJaWYgKCB0aGlzLnN0b3JlZEN1cnNvciApIHsKCQkJdGhpcy5kb2N1bWVudC5maW5kKCAiYm9keSIgKS5jc3MoICJjdXJzb3IiLCB0aGlzLnN0b3JlZEN1cnNvciApOwoJCQl0aGlzLnN0b3JlZFN0eWxlc2hlZXQucmVtb3ZlKCk7CgkJfQoJCWlmICggdGhpcy5fc3RvcmVkT3BhY2l0eSApIHsKCQkJdGhpcy5oZWxwZXIuY3NzKCAib3BhY2l0eSIsIHRoaXMuX3N0b3JlZE9wYWNpdHkgKTsKCQl9CgkJaWYgKCB0aGlzLl9zdG9yZWRaSW5kZXggKSB7CgkJCXRoaXMuaGVscGVyLmNzcyggInpJbmRleCIsIHRoaXMuX3N0b3JlZFpJbmRleCA9PT0gImF1dG8iID8gIiIgOiB0aGlzLl9zdG9yZWRaSW5kZXggKTsKCQl9CgoJCXRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJaWYgKCAhbm9Qcm9wYWdhdGlvbiApIHsKCQkJdGhpcy5fdHJpZ2dlciggImJlZm9yZVN0b3AiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkgKTsKCQl9CgoJCS8vJCh0aGlzLnBsYWNlaG9sZGVyWzBdKS5yZW1vdmUoKTsgd291bGQgaGF2ZSBiZWVuIHRoZSBqUXVlcnkgd2F5IC0gdW5mb3J0dW5hdGVseSwKCQkvLyBpdCB1bmJpbmRzIEFMTCBldmVudHMgZnJvbSB0aGUgb3JpZ2luYWwgbm9kZSEKCQl0aGlzLnBsYWNlaG9sZGVyWyAwIF0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggdGhpcy5wbGFjZWhvbGRlclsgMCBdICk7CgoJCWlmICggIXRoaXMuY2FuY2VsSGVscGVyUmVtb3ZhbCApIHsKCQkJaWYgKCB0aGlzLmhlbHBlclsgMCBdICE9PSB0aGlzLmN1cnJlbnRJdGVtWyAwIF0gKSB7CgkJCQl0aGlzLmhlbHBlci5yZW1vdmUoKTsKCQkJfQoJCQl0aGlzLmhlbHBlciA9IG51bGw7CgkJfQoKCQlpZiAoICFub1Byb3BhZ2F0aW9uICkgewoJCQlmb3IgKCBpID0gMDsgaSA8IGRlbGF5ZWRUcmlnZ2Vycy5sZW5ndGg7IGkrKyApIHsKCgkJCQkvLyBUcmlnZ2VyIGFsbCBkZWxheWVkIGV2ZW50cwoJCQkJZGVsYXllZFRyaWdnZXJzWyBpIF0uY2FsbCggdGhpcywgZXZlbnQgKTsKCQkJfQoJCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIsIGV2ZW50LCB0aGlzLl91aUhhc2goKSApOwoJCX0KCgkJdGhpcy5mcm9tT3V0c2lkZSA9IGZhbHNlOwoJCXJldHVybiAhdGhpcy5jYW5jZWxIZWxwZXJSZW1vdmFsOwoKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCkgewoJCWlmICggJC5XaWRnZXQucHJvdG90eXBlLl90cmlnZ2VyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSA9PT0gZmFsc2UgKSB7CgkJCXRoaXMuY2FuY2VsKCk7CgkJfQoJfSwKCglfdWlIYXNoOiBmdW5jdGlvbiggX2luc3QgKSB7CgkJdmFyIGluc3QgPSBfaW5zdCB8fCB0aGlzOwoJCXJldHVybiB7CgkJCWhlbHBlcjogaW5zdC5oZWxwZXIsCgkJCXBsYWNlaG9sZGVyOiBpbnN0LnBsYWNlaG9sZGVyIHx8ICQoIFtdICksCgkJCXBvc2l0aW9uOiBpbnN0LnBvc2l0aW9uLAoJCQlvcmlnaW5hbFBvc2l0aW9uOiBpbnN0Lm9yaWdpbmFsUG9zaXRpb24sCgkJCW9mZnNldDogaW5zdC5wb3NpdGlvbkFicywKCQkJaXRlbTogaW5zdC5jdXJyZW50SXRlbSwKCQkJc2VuZGVyOiBfaW5zdCA/IF9pbnN0LmVsZW1lbnQgOiBudWxsCgkJfTsKCX0KCn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIEFjY29yZGlvbiAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IEFjY29yZGlvbgovLz4+Z3JvdXA6IFdpZGdldHMKLy8ganNjczpkaXNhYmxlIG1heGltdW1MaW5lTGVuZ3RoCi8vPj5kZXNjcmlwdGlvbjogRGlzcGxheXMgY29sbGFwc2libGUgY29udGVudCBwYW5lbHMgZm9yIHByZXNlbnRpbmcgaW5mb3JtYXRpb24gaW4gYSBsaW1pdGVkIGFtb3VudCBvZiBzcGFjZS4KLy8ganNjczplbmFibGUgbWF4aW11bUxpbmVMZW5ndGgKLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2FjY29yZGlvbi8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2FjY29yZGlvbi8KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9hY2NvcmRpb24uY3NzCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcwoKCgp2YXIgd2lkZ2V0c0FjY29yZGlvbiA9ICQud2lkZ2V0KCAidWkuYWNjb3JkaW9uIiwgewoJdmVyc2lvbjogIjEuMTIuMSIsCglvcHRpb25zOiB7CgkJYWN0aXZlOiAwLAoJCWFuaW1hdGU6IHt9LAoJCWNsYXNzZXM6IHsKCQkJInVpLWFjY29yZGlvbi1oZWFkZXIiOiAidWktY29ybmVyLXRvcCIsCgkJCSJ1aS1hY2NvcmRpb24taGVhZGVyLWNvbGxhcHNlZCI6ICJ1aS1jb3JuZXItYWxsIiwKCQkJInVpLWFjY29yZGlvbi1jb250ZW50IjogInVpLWNvcm5lci1ib3R0b20iCgkJfSwKCQljb2xsYXBzaWJsZTogZmFsc2UsCgkJZXZlbnQ6ICJjbGljayIsCgkJaGVhZGVyOiAiPiBsaSA+IDpmaXJzdC1jaGlsZCwgPiA6bm90KGxpKTpldmVuIiwKCQloZWlnaHRTdHlsZTogImF1dG8iLAoJCWljb25zOiB7CgkJCWFjdGl2ZUhlYWRlcjogInVpLWljb24tdHJpYW5nbGUtMS1zIiwKCQkJaGVhZGVyOiAidWktaWNvbi10cmlhbmdsZS0xLWUiCgkJfSwKCgkJLy8gQ2FsbGJhY2tzCgkJYWN0aXZhdGU6IG51bGwsCgkJYmVmb3JlQWN0aXZhdGU6IG51bGwKCX0sCgoJaGlkZVByb3BzOiB7CgkJYm9yZGVyVG9wV2lkdGg6ICJoaWRlIiwKCQlib3JkZXJCb3R0b21XaWR0aDogImhpZGUiLAoJCXBhZGRpbmdUb3A6ICJoaWRlIiwKCQlwYWRkaW5nQm90dG9tOiAiaGlkZSIsCgkJaGVpZ2h0OiAiaGlkZSIKCX0sCgoJc2hvd1Byb3BzOiB7CgkJYm9yZGVyVG9wV2lkdGg6ICJzaG93IiwKCQlib3JkZXJCb3R0b21XaWR0aDogInNob3ciLAoJCXBhZGRpbmdUb3A6ICJzaG93IiwKCQlwYWRkaW5nQm90dG9tOiAic2hvdyIsCgkJaGVpZ2h0OiAic2hvdyIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCXRoaXMucHJldlNob3cgPSB0aGlzLnByZXZIaWRlID0gJCgpOwoJCXRoaXMuX2FkZENsYXNzKCAidWktYWNjb3JkaW9uIiwgInVpLXdpZGdldCB1aS1oZWxwZXItcmVzZXQiICk7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJyb2xlIiwgInRhYmxpc3QiICk7CgoJCS8vIERvbid0IGFsbG93IGNvbGxhcHNpYmxlOiBmYWxzZSBhbmQgYWN0aXZlOiBmYWxzZSAvIG51bGwKCQlpZiAoICFvcHRpb25zLmNvbGxhcHNpYmxlICYmICggb3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlIHx8IG9wdGlvbnMuYWN0aXZlID09IG51bGwgKSApIHsKCQkJb3B0aW9ucy5hY3RpdmUgPSAwOwoJCX0KCgkJdGhpcy5fcHJvY2Vzc1BhbmVscygpOwoKCQkvLyBoYW5kbGUgbmVnYXRpdmUgdmFsdWVzCgkJaWYgKCBvcHRpb25zLmFjdGl2ZSA8IDAgKSB7CgkJCW9wdGlvbnMuYWN0aXZlICs9IHRoaXMuaGVhZGVycy5sZW5ndGg7CgkJfQoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJaGVhZGVyOiB0aGlzLmFjdGl2ZSwKCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLmFjdGl2ZS5uZXh0KCkKCQl9OwoJfSwKCglfY3JlYXRlSWNvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBpY29uLCBjaGlsZHJlbiwKCQkJaWNvbnMgPSB0aGlzLm9wdGlvbnMuaWNvbnM7CgoJCWlmICggaWNvbnMgKSB7CgkJCWljb24gPSAkKCAiPHNwYW4+IiApOwoJCQl0aGlzLl9hZGRDbGFzcyggaWNvbiwgInVpLWFjY29yZGlvbi1oZWFkZXItaWNvbiIsICJ1aS1pY29uICIgKyBpY29ucy5oZWFkZXIgKTsKCQkJaWNvbi5wcmVwZW5kVG8oIHRoaXMuaGVhZGVycyApOwoJCQljaGlsZHJlbiA9IHRoaXMuYWN0aXZlLmNoaWxkcmVuKCAiLnVpLWFjY29yZGlvbi1oZWFkZXItaWNvbiIgKTsKCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGNoaWxkcmVuLCBpY29ucy5oZWFkZXIgKQoJCQkJLl9hZGRDbGFzcyggY2hpbGRyZW4sIG51bGwsIGljb25zLmFjdGl2ZUhlYWRlciApCgkJCQkuX2FkZENsYXNzKCB0aGlzLmhlYWRlcnMsICJ1aS1hY2NvcmRpb24taWNvbnMiICk7CgkJfQoJfSwKCglfZGVzdHJveUljb25zOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5oZWFkZXJzLCAidWktYWNjb3JkaW9uLWljb25zIiApOwoJCXRoaXMuaGVhZGVycy5jaGlsZHJlbiggIi51aS1hY2NvcmRpb24taGVhZGVyLWljb24iICkucmVtb3ZlKCk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgY29udGVudHM7CgoJCS8vIENsZWFuIHVwIG1haW4gZWxlbWVudAoJCXRoaXMuZWxlbWVudC5yZW1vdmVBdHRyKCAicm9sZSIgKTsKCgkJLy8gQ2xlYW4gdXAgaGVhZGVycwoJCXRoaXMuaGVhZGVycwoJCQkucmVtb3ZlQXR0ciggInJvbGUgYXJpYS1leHBhbmRlZCBhcmlhLXNlbGVjdGVkIGFyaWEtY29udHJvbHMgdGFiSW5kZXgiICkKCQkJLnJlbW92ZVVuaXF1ZUlkKCk7CgoJCXRoaXMuX2Rlc3Ryb3lJY29ucygpOwoKCQkvLyBDbGVhbiB1cCBjb250ZW50IHBhbmVscwoJCWNvbnRlbnRzID0gdGhpcy5oZWFkZXJzLm5leHQoKQoJCQkuY3NzKCAiZGlzcGxheSIsICIiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIGFyaWEtaGlkZGVuIGFyaWEtbGFiZWxsZWRieSIgKQoJCQkucmVtb3ZlVW5pcXVlSWQoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuaGVpZ2h0U3R5bGUgIT09ICJjb250ZW50IiApIHsKCQkJY29udGVudHMuY3NzKCAiaGVpZ2h0IiwgIiIgKTsKCQl9Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCWlmICgga2V5ID09PSAiYWN0aXZlIiApIHsKCgkJCS8vIF9hY3RpdmF0ZSgpIHdpbGwgaGFuZGxlIGludmFsaWQgdmFsdWVzIGFuZCB1cGRhdGUgdGhpcy5vcHRpb25zCgkJCXRoaXMuX2FjdGl2YXRlKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGtleSA9PT0gImV2ZW50IiApIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuZXZlbnQgKSB7CgkJCQl0aGlzLl9vZmYoIHRoaXMuaGVhZGVycywgdGhpcy5vcHRpb25zLmV2ZW50ICk7CgkJCX0KCQkJdGhpcy5fc2V0dXBFdmVudHMoIHZhbHVlICk7CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQkvLyBTZXR0aW5nIGNvbGxhcHNpYmxlOiBmYWxzZSB3aGlsZSBjb2xsYXBzZWQ7IG9wZW4gZmlyc3QgcGFuZWwKCQlpZiAoIGtleSA9PT0gImNvbGxhcHNpYmxlIiAmJiAhdmFsdWUgJiYgdGhpcy5vcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCAwICk7CgkJfQoKCQlpZiAoIGtleSA9PT0gImljb25zIiApIHsKCQkJdGhpcy5fZGVzdHJveUljb25zKCk7CgkJCWlmICggdmFsdWUgKSB7CgkJCQl0aGlzLl9jcmVhdGVJY29ucygpOwoJCQl9CgkJfQoJfSwKCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlciggdmFsdWUgKTsKCgkJdGhpcy5lbGVtZW50LmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCgkJLy8gU3VwcG9ydDogSUU4IE9ubHkKCQkvLyAjNTMzMiAvICM2MDU5IC0gb3BhY2l0eSBkb2Vzbid0IGNhc2NhZGUgdG8gcG9zaXRpb25lZCBlbGVtZW50cyBpbiBJRQoJCS8vIHNvIHdlIG5lZWQgdG8gYWRkIHRoZSBkaXNhYmxlZCBjbGFzcyB0byB0aGUgaGVhZGVycyBhbmQgcGFuZWxzCgkJdGhpcy5fdG9nZ2xlQ2xhc3MoIG51bGwsICJ1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKTsKCQl0aGlzLl90b2dnbGVDbGFzcyggdGhpcy5oZWFkZXJzLmFkZCggdGhpcy5oZWFkZXJzLm5leHQoKSApLCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiLAoJCQkhIXZhbHVlICk7Cgl9LAoKCV9rZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCBldmVudC5hbHRLZXkgfHwgZXZlbnQuY3RybEtleSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGtleUNvZGUgPSAkLnVpLmtleUNvZGUsCgkJCWxlbmd0aCA9IHRoaXMuaGVhZGVycy5sZW5ndGgsCgkJCWN1cnJlbnRJbmRleCA9IHRoaXMuaGVhZGVycy5pbmRleCggZXZlbnQudGFyZ2V0ICksCgkJCXRvRm9jdXMgPSBmYWxzZTsKCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQljYXNlIGtleUNvZGUuUklHSFQ6CgkJY2FzZSBrZXlDb2RlLkRPV046CgkJCXRvRm9jdXMgPSB0aGlzLmhlYWRlcnNbICggY3VycmVudEluZGV4ICsgMSApICUgbGVuZ3RoIF07CgkJCWJyZWFrOwoJCWNhc2Uga2V5Q29kZS5MRUZUOgoJCWNhc2Uga2V5Q29kZS5VUDoKCQkJdG9Gb2N1cyA9IHRoaXMuaGVhZGVyc1sgKCBjdXJyZW50SW5kZXggLSAxICsgbGVuZ3RoICkgJSBsZW5ndGggXTsKCQkJYnJlYWs7CgkJY2FzZSBrZXlDb2RlLlNQQUNFOgoJCWNhc2Uga2V5Q29kZS5FTlRFUjoKCQkJdGhpcy5fZXZlbnRIYW5kbGVyKCBldmVudCApOwoJCQlicmVhazsKCQljYXNlIGtleUNvZGUuSE9NRToKCQkJdG9Gb2N1cyA9IHRoaXMuaGVhZGVyc1sgMCBdOwoJCQlicmVhazsKCQljYXNlIGtleUNvZGUuRU5EOgoJCQl0b0ZvY3VzID0gdGhpcy5oZWFkZXJzWyBsZW5ndGggLSAxIF07CgkJCWJyZWFrOwoJCX0KCgkJaWYgKCB0b0ZvY3VzICkgewoJCQkkKCBldmVudC50YXJnZXQgKS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCQkkKCB0b0ZvY3VzICkuYXR0ciggInRhYkluZGV4IiwgMCApOwoJCQkkKCB0b0ZvY3VzICkudHJpZ2dlciggImZvY3VzIiApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0sCgoJX3BhbmVsS2V5RG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlVQICYmIGV2ZW50LmN0cmxLZXkgKSB7CgkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5wcmV2KCkudHJpZ2dlciggImZvY3VzIiApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgkJdGhpcy5fcHJvY2Vzc1BhbmVscygpOwoKCQkvLyBXYXMgY29sbGFwc2VkIG9yIG5vIHBhbmVsCgkJaWYgKCAoIG9wdGlvbnMuYWN0aXZlID09PSBmYWxzZSAmJiBvcHRpb25zLmNvbGxhcHNpYmxlID09PSB0cnVlICkgfHwKCQkJCSF0aGlzLmhlYWRlcnMubGVuZ3RoICkgewoJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCgkJLy8gYWN0aXZlIGZhbHNlIG9ubHkgd2hlbiBjb2xsYXBzaWJsZSBpcyB0cnVlCgkJfSBlbHNlIGlmICggb3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggMCApOwoKCQkvLyB3YXMgYWN0aXZlLCBidXQgYWN0aXZlIHBhbmVsIGlzIGdvbmUKCQl9IGVsc2UgaWYgKCB0aGlzLmFjdGl2ZS5sZW5ndGggJiYgISQuY29udGFpbnMoIHRoaXMuZWxlbWVudFsgMCBdLCB0aGlzLmFjdGl2ZVsgMCBdICkgKSB7CgoJCQkvLyBhbGwgcmVtYWluaW5nIHBhbmVsIGFyZSBkaXNhYmxlZAoJCQlpZiAoIHRoaXMuaGVhZGVycy5sZW5ndGggPT09IHRoaXMuaGVhZGVycy5maW5kKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLmxlbmd0aCApIHsKCQkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCgkJCS8vIGFjdGl2YXRlIHByZXZpb3VzIHBhbmVsCgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggTWF0aC5tYXgoIDAsIG9wdGlvbnMuYWN0aXZlIC0gMSApICk7CgkJCX0KCgkJLy8gd2FzIGFjdGl2ZSwgYWN0aXZlIHBhbmVsIHN0aWxsIGV4aXN0cwoJCX0gZWxzZSB7CgoJCQkvLyBtYWtlIHN1cmUgYWN0aXZlIGluZGV4IGlzIGNvcnJlY3QKCQkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLmhlYWRlcnMuaW5kZXgoIHRoaXMuYWN0aXZlICk7CgkJfQoKCQl0aGlzLl9kZXN0cm95SWNvbnMoKTsKCgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcHJvY2Vzc1BhbmVsczogZnVuY3Rpb24oKSB7CgkJdmFyIHByZXZIZWFkZXJzID0gdGhpcy5oZWFkZXJzLAoJCQlwcmV2UGFuZWxzID0gdGhpcy5wYW5lbHM7CgoJCXRoaXMuaGVhZGVycyA9IHRoaXMuZWxlbWVudC5maW5kKCB0aGlzLm9wdGlvbnMuaGVhZGVyICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaGVhZGVycywgInVpLWFjY29yZGlvbi1oZWFkZXIgdWktYWNjb3JkaW9uLWhlYWRlci1jb2xsYXBzZWQiLAoJCQkidWktc3RhdGUtZGVmYXVsdCIgKTsKCgkJdGhpcy5wYW5lbHMgPSB0aGlzLmhlYWRlcnMubmV4dCgpLmZpbHRlciggIjpub3QoLnVpLWFjY29yZGlvbi1jb250ZW50LWFjdGl2ZSkiICkuaGlkZSgpOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnBhbmVscywgInVpLWFjY29yZGlvbi1jb250ZW50IiwgInVpLWhlbHBlci1yZXNldCB1aS13aWRnZXQtY29udGVudCIgKTsKCgkJLy8gQXZvaWQgbWVtb3J5IGxlYWtzICgjMTAwNTYpCgkJaWYgKCBwcmV2UGFuZWxzICkgewoJCQl0aGlzLl9vZmYoIHByZXZIZWFkZXJzLm5vdCggdGhpcy5oZWFkZXJzICkgKTsKCQkJdGhpcy5fb2ZmKCBwcmV2UGFuZWxzLm5vdCggdGhpcy5wYW5lbHMgKSApOwoJCX0KCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBtYXhIZWlnaHQsCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWhlaWdodFN0eWxlID0gb3B0aW9ucy5oZWlnaHRTdHlsZSwKCQkJcGFyZW50ID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoKCQl0aGlzLmFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIG9wdGlvbnMuYWN0aXZlICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuYWN0aXZlLCAidWktYWNjb3JkaW9uLWhlYWRlci1hY3RpdmUiLCAidWktc3RhdGUtYWN0aXZlIiApCgkJCS5fcmVtb3ZlQ2xhc3MoIHRoaXMuYWN0aXZlLCAidWktYWNjb3JkaW9uLWhlYWRlci1jb2xsYXBzZWQiICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuYWN0aXZlLm5leHQoKSwgInVpLWFjY29yZGlvbi1jb250ZW50LWFjdGl2ZSIgKTsKCQl0aGlzLmFjdGl2ZS5uZXh0KCkuc2hvdygpOwoKCQl0aGlzLmhlYWRlcnMKCQkJLmF0dHIoICJyb2xlIiwgInRhYiIgKQoJCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgaGVhZGVyID0gJCggdGhpcyApLAoJCQkJCWhlYWRlcklkID0gaGVhZGVyLnVuaXF1ZUlkKCkuYXR0ciggImlkIiApLAoJCQkJCXBhbmVsID0gaGVhZGVyLm5leHQoKSwKCQkJCQlwYW5lbElkID0gcGFuZWwudW5pcXVlSWQoKS5hdHRyKCAiaWQiICk7CgkJCQloZWFkZXIuYXR0ciggImFyaWEtY29udHJvbHMiLCBwYW5lbElkICk7CgkJCQlwYW5lbC5hdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiwgaGVhZGVySWQgKTsKCQkJfSApCgkJCS5uZXh0KCkKCQkJCS5hdHRyKCAicm9sZSIsICJ0YWJwYW5lbCIgKTsKCgkJdGhpcy5oZWFkZXJzCgkJCS5ub3QoIHRoaXMuYWN0aXZlICkKCQkJCS5hdHRyKCB7CgkJCQkJImFyaWEtc2VsZWN0ZWQiOiAiZmFsc2UiLAoJCQkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJCQl0YWJJbmRleDogLTEKCQkJCX0gKQoJCQkJLm5leHQoKQoJCQkJCS5hdHRyKCB7CgkJCQkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCQkJCX0gKQoJCQkJCS5oaWRlKCk7CgoJCS8vIE1ha2Ugc3VyZSBhdCBsZWFzdCBvbmUgaGVhZGVyIGlzIGluIHRoZSB0YWIgb3JkZXIKCQlpZiAoICF0aGlzLmFjdGl2ZS5sZW5ndGggKSB7CgkJCXRoaXMuaGVhZGVycy5lcSggMCApLmF0dHIoICJ0YWJJbmRleCIsIDAgKTsKCQl9IGVsc2UgewoJCQl0aGlzLmFjdGl2ZS5hdHRyKCB7CgkJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLAoJCQkJdGFiSW5kZXg6IDAKCQkJfSApCgkJCQkubmV4dCgpCgkJCQkJLmF0dHIoIHsKCQkJCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCQkJCX0gKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZUljb25zKCk7CgoJCXRoaXMuX3NldHVwRXZlbnRzKCBvcHRpb25zLmV2ZW50ICk7CgoJCWlmICggaGVpZ2h0U3R5bGUgPT09ICJmaWxsIiApIHsKCQkJbWF4SGVpZ2h0ID0gcGFyZW50LmhlaWdodCgpOwoJCQl0aGlzLmVsZW1lbnQuc2libGluZ3MoICI6dmlzaWJsZSIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gJCggdGhpcyApLAoJCQkJCXBvc2l0aW9uID0gZWxlbS5jc3MoICJwb3NpdGlvbiIgKTsKCgkJCQlpZiAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCW1heEhlaWdodCAtPSBlbGVtLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0gKTsKCgkJCXRoaXMuaGVhZGVycy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCAtPSAkKCB0aGlzICkub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSApOwoKCQkJdGhpcy5oZWFkZXJzLm5leHQoKQoJCQkJLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5oZWlnaHQoIE1hdGgubWF4KCAwLCBtYXhIZWlnaHQgLQoJCQkJCQkkKCB0aGlzICkuaW5uZXJIZWlnaHQoKSArICQoIHRoaXMgKS5oZWlnaHQoKSApICk7CgkJCQl9ICkKCQkJCS5jc3MoICJvdmVyZmxvdyIsICJhdXRvIiApOwoJCX0gZWxzZSBpZiAoIGhlaWdodFN0eWxlID09PSAiYXV0byIgKSB7CgkJCW1heEhlaWdodCA9IDA7CgkJCXRoaXMuaGVhZGVycy5uZXh0KCkKCQkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgaXNWaXNpYmxlID0gJCggdGhpcyApLmlzKCAiOnZpc2libGUiICk7CgkJCQkJaWYgKCAhaXNWaXNpYmxlICkgewoJCQkJCQkkKCB0aGlzICkuc2hvdygpOwoJCQkJCX0KCQkJCQltYXhIZWlnaHQgPSBNYXRoLm1heCggbWF4SGVpZ2h0LCAkKCB0aGlzICkuY3NzKCAiaGVpZ2h0IiwgIiIgKS5oZWlnaHQoKSApOwoJCQkJCWlmICggIWlzVmlzaWJsZSApIHsKCQkJCQkJJCggdGhpcyApLmhpZGUoKTsKCQkJCQl9CgkJCQl9ICkKCQkJCS5oZWlnaHQoIG1heEhlaWdodCApOwoJCX0KCX0sCgoJX2FjdGl2YXRlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIGluZGV4IClbIDAgXTsKCgkJLy8gVHJ5aW5nIHRvIGFjdGl2YXRlIHRoZSBhbHJlYWR5IGFjdGl2ZSBwYW5lbAoJCWlmICggYWN0aXZlID09PSB0aGlzLmFjdGl2ZVsgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBUcnlpbmcgdG8gY29sbGFwc2UsIHNpbXVsYXRlIGEgY2xpY2sgb24gdGhlIGN1cnJlbnRseSBhY3RpdmUgaGVhZGVyCgkJYWN0aXZlID0gYWN0aXZlIHx8IHRoaXMuYWN0aXZlWyAwIF07CgoJCXRoaXMuX2V2ZW50SGFuZGxlciggewoJCQl0YXJnZXQ6IGFjdGl2ZSwKCQkJY3VycmVudFRhcmdldDogYWN0aXZlLAoJCQlwcmV2ZW50RGVmYXVsdDogJC5ub29wCgkJfSApOwoJfSwKCglfZmluZEFjdGl2ZTogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0eXBlb2Ygc2VsZWN0b3IgPT09ICJudW1iZXIiID8gdGhpcy5oZWFkZXJzLmVxKCBzZWxlY3RvciApIDogJCgpOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgZXZlbnRzID0gewoJCQlrZXlkb3duOiAiX2tleWRvd24iCgkJfTsKCQlpZiAoIGV2ZW50ICkgewoJCQkkLmVhY2goIGV2ZW50LnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGluZGV4LCBldmVudE5hbWUgKSB7CgkJCQlldmVudHNbIGV2ZW50TmFtZSBdID0gIl9ldmVudEhhbmRsZXIiOwoJCQl9ICk7CgkJfQoKCQl0aGlzLl9vZmYoIHRoaXMuaGVhZGVycy5hZGQoIHRoaXMuaGVhZGVycy5uZXh0KCkgKSApOwoJCXRoaXMuX29uKCB0aGlzLmhlYWRlcnMsIGV2ZW50cyApOwoJCXRoaXMuX29uKCB0aGlzLmhlYWRlcnMubmV4dCgpLCB7IGtleWRvd246ICJfcGFuZWxLZXlEb3duIiB9ICk7CgkJdGhpcy5faG92ZXJhYmxlKCB0aGlzLmhlYWRlcnMgKTsKCQl0aGlzLl9mb2N1c2FibGUoIHRoaXMuaGVhZGVycyApOwoJfSwKCglfZXZlbnRIYW5kbGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGFjdGl2ZUNoaWxkcmVuLCBjbGlja2VkQ2hpbGRyZW4sCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWFjdGl2ZSA9IHRoaXMuYWN0aXZlLAoJCQljbGlja2VkID0gJCggZXZlbnQuY3VycmVudFRhcmdldCApLAoJCQljbGlja2VkSXNBY3RpdmUgPSBjbGlja2VkWyAwIF0gPT09IGFjdGl2ZVsgMCBdLAoJCQljb2xsYXBzaW5nID0gY2xpY2tlZElzQWN0aXZlICYmIG9wdGlvbnMuY29sbGFwc2libGUsCgkJCXRvU2hvdyA9IGNvbGxhcHNpbmcgPyAkKCkgOiBjbGlja2VkLm5leHQoKSwKCQkJdG9IaWRlID0gYWN0aXZlLm5leHQoKSwKCQkJZXZlbnREYXRhID0gewoJCQkJb2xkSGVhZGVyOiBhY3RpdmUsCgkJCQlvbGRQYW5lbDogdG9IaWRlLAoJCQkJbmV3SGVhZGVyOiBjb2xsYXBzaW5nID8gJCgpIDogY2xpY2tlZCwKCQkJCW5ld1BhbmVsOiB0b1Nob3cKCQkJfTsKCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJaWYgKAoKCQkJCS8vIGNsaWNrIG9uIGFjdGl2ZSBoZWFkZXIsIGJ1dCBub3QgY29sbGFwc2libGUKCQkJCSggY2xpY2tlZElzQWN0aXZlICYmICFvcHRpb25zLmNvbGxhcHNpYmxlICkgfHwKCgkJCQkvLyBhbGxvdyBjYW5jZWxpbmcgYWN0aXZhdGlvbgoJCQkJKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQWN0aXZhdGUiLCBldmVudCwgZXZlbnREYXRhICkgPT09IGZhbHNlICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCW9wdGlvbnMuYWN0aXZlID0gY29sbGFwc2luZyA/IGZhbHNlIDogdGhpcy5oZWFkZXJzLmluZGV4KCBjbGlja2VkICk7CgoJCS8vIFdoZW4gdGhlIGNhbGwgdG8gLl90b2dnbGUoKSBjb21lcyBhZnRlciB0aGUgY2xhc3MgY2hhbmdlcwoJCS8vIGl0IGNhdXNlcyBhIHZlcnkgb2RkIGJ1ZyBpbiBJRSA4IChzZWUgIzY3MjApCgkJdGhpcy5hY3RpdmUgPSBjbGlja2VkSXNBY3RpdmUgPyAkKCkgOiBjbGlja2VkOwoJCXRoaXMuX3RvZ2dsZSggZXZlbnREYXRhICk7CgoJCS8vIFN3aXRjaCBjbGFzc2VzCgkJLy8gY29ybmVyIGNsYXNzZXMgb24gdGhlIHByZXZpb3VzbHkgYWN0aXZlIGhlYWRlciBzdGF5IGFmdGVyIHRoZSBhbmltYXRpb24KCQl0aGlzLl9yZW1vdmVDbGFzcyggYWN0aXZlLCAidWktYWNjb3JkaW9uLWhlYWRlci1hY3RpdmUiLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCWlmICggb3B0aW9ucy5pY29ucyApIHsKCQkJYWN0aXZlQ2hpbGRyZW4gPSBhY3RpdmUuY2hpbGRyZW4oICIudWktYWNjb3JkaW9uLWhlYWRlci1pY29uIiApOwoJCQl0aGlzLl9yZW1vdmVDbGFzcyggYWN0aXZlQ2hpbGRyZW4sIG51bGwsIG9wdGlvbnMuaWNvbnMuYWN0aXZlSGVhZGVyICkKCQkJCS5fYWRkQ2xhc3MoIGFjdGl2ZUNoaWxkcmVuLCBudWxsLCBvcHRpb25zLmljb25zLmhlYWRlciApOwoJCX0KCgkJaWYgKCAhY2xpY2tlZElzQWN0aXZlICkgewoJCQl0aGlzLl9yZW1vdmVDbGFzcyggY2xpY2tlZCwgInVpLWFjY29yZGlvbi1oZWFkZXItY29sbGFwc2VkIiApCgkJCQkuX2FkZENsYXNzKCBjbGlja2VkLCAidWktYWNjb3JkaW9uLWhlYWRlci1hY3RpdmUiLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQlpZiAoIG9wdGlvbnMuaWNvbnMgKSB7CgkJCQljbGlja2VkQ2hpbGRyZW4gPSBjbGlja2VkLmNoaWxkcmVuKCAiLnVpLWFjY29yZGlvbi1oZWFkZXItaWNvbiIgKTsKCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCBjbGlja2VkQ2hpbGRyZW4sIG51bGwsIG9wdGlvbnMuaWNvbnMuaGVhZGVyICkKCQkJCQkuX2FkZENsYXNzKCBjbGlja2VkQ2hpbGRyZW4sIG51bGwsIG9wdGlvbnMuaWNvbnMuYWN0aXZlSGVhZGVyICk7CgkJCX0KCgkJCXRoaXMuX2FkZENsYXNzKCBjbGlja2VkLm5leHQoKSwgInVpLWFjY29yZGlvbi1jb250ZW50LWFjdGl2ZSIgKTsKCQl9Cgl9LAoKCV90b2dnbGU6IGZ1bmN0aW9uKCBkYXRhICkgewoJCXZhciB0b1Nob3cgPSBkYXRhLm5ld1BhbmVsLAoJCQl0b0hpZGUgPSB0aGlzLnByZXZTaG93Lmxlbmd0aCA/IHRoaXMucHJldlNob3cgOiBkYXRhLm9sZFBhbmVsOwoKCQkvLyBIYW5kbGUgYWN0aXZhdGluZyBhIHBhbmVsIGR1cmluZyB0aGUgYW5pbWF0aW9uIGZvciBhbm90aGVyIGFjdGl2YXRpb24KCQl0aGlzLnByZXZTaG93LmFkZCggdGhpcy5wcmV2SGlkZSApLnN0b3AoIHRydWUsIHRydWUgKTsKCQl0aGlzLnByZXZTaG93ID0gdG9TaG93OwoJCXRoaXMucHJldkhpZGUgPSB0b0hpZGU7CgoJCWlmICggdGhpcy5vcHRpb25zLmFuaW1hdGUgKSB7CgkJCXRoaXMuX2FuaW1hdGUoIHRvU2hvdywgdG9IaWRlLCBkYXRhICk7CgkJfSBlbHNlIHsKCQkJdG9IaWRlLmhpZGUoKTsKCQkJdG9TaG93LnNob3coKTsKCQkJdGhpcy5fdG9nZ2xlQ29tcGxldGUoIGRhdGEgKTsKCQl9CgoJCXRvSGlkZS5hdHRyKCB7CgkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCX0gKTsKCQl0b0hpZGUucHJldigpLmF0dHIoIHsKCQkJImFyaWEtc2VsZWN0ZWQiOiAiZmFsc2UiLAoJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIKCQl9ICk7CgoJCS8vIGlmIHdlJ3JlIHN3aXRjaGluZyBwYW5lbHMsIHJlbW92ZSB0aGUgb2xkIGhlYWRlciBmcm9tIHRoZSB0YWIgb3JkZXIKCQkvLyBpZiB3ZSdyZSBvcGVuaW5nIGZyb20gY29sbGFwc2VkIHN0YXRlLCByZW1vdmUgdGhlIHByZXZpb3VzIGhlYWRlciBmcm9tIHRoZSB0YWIgb3JkZXIKCQkvLyBpZiB3ZSdyZSBjb2xsYXBzaW5nLCB0aGVuIGtlZXAgdGhlIGNvbGxhcHNpbmcgaGVhZGVyIGluIHRoZSB0YWIgb3JkZXIKCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdG9IaWRlLmxlbmd0aCApIHsKCQkJdG9IaWRlLnByZXYoKS5hdHRyKCB7CgkJCQkidGFiSW5kZXgiOiAtMSwKCQkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIgoJCQl9ICk7CgkJfSBlbHNlIGlmICggdG9TaG93Lmxlbmd0aCApIHsKCQkJdGhpcy5oZWFkZXJzLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gcGFyc2VJbnQoICQoIHRoaXMgKS5hdHRyKCAidGFiSW5kZXgiICksIDEwICkgPT09IDA7CgkJCX0gKQoJCQkJLmF0dHIoICJ0YWJJbmRleCIsIC0xICk7CgkJfQoKCQl0b1Nob3cKCQkJLmF0dHIoICJhcmlhLWhpZGRlbiIsICJmYWxzZSIgKQoJCQkucHJldigpCgkJCQkuYXR0ciggewoJCQkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLAoJCQkJCXRhYkluZGV4OiAwCgkJCQl9ICk7Cgl9LAoKCV9hbmltYXRlOiBmdW5jdGlvbiggdG9TaG93LCB0b0hpZGUsIGRhdGEgKSB7CgkJdmFyIHRvdGFsLCBlYXNpbmcsIGR1cmF0aW9uLAoJCQl0aGF0ID0gdGhpcywKCQkJYWRqdXN0ID0gMCwKCQkJYm94U2l6aW5nID0gdG9TaG93LmNzcyggImJveC1zaXppbmciICksCgkJCWRvd24gPSB0b1Nob3cubGVuZ3RoICYmCgkJCQkoICF0b0hpZGUubGVuZ3RoIHx8ICggdG9TaG93LmluZGV4KCkgPCB0b0hpZGUuaW5kZXgoKSApICksCgkJCWFuaW1hdGUgPSB0aGlzLm9wdGlvbnMuYW5pbWF0ZSB8fCB7fSwKCQkJb3B0aW9ucyA9IGRvd24gJiYgYW5pbWF0ZS5kb3duIHx8IGFuaW1hdGUsCgkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQl0aGF0Ll90b2dnbGVDb21wbGV0ZSggZGF0YSApOwoJCQl9OwoKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiApIHsKCQkJZHVyYXRpb24gPSBvcHRpb25zOwoJCX0KCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJZWFzaW5nID0gb3B0aW9uczsKCQl9CgoJCS8vIGZhbGwgYmFjayBmcm9tIG9wdGlvbnMgdG8gYW5pbWF0aW9uIGluIGNhc2Ugb2YgcGFydGlhbCBkb3duIHNldHRpbmdzCgkJZWFzaW5nID0gZWFzaW5nIHx8IG9wdGlvbnMuZWFzaW5nIHx8IGFuaW1hdGUuZWFzaW5nOwoJCWR1cmF0aW9uID0gZHVyYXRpb24gfHwgb3B0aW9ucy5kdXJhdGlvbiB8fCBhbmltYXRlLmR1cmF0aW9uOwoKCQlpZiAoICF0b0hpZGUubGVuZ3RoICkgewoJCQlyZXR1cm4gdG9TaG93LmFuaW1hdGUoIHRoaXMuc2hvd1Byb3BzLCBkdXJhdGlvbiwgZWFzaW5nLCBjb21wbGV0ZSApOwoJCX0KCQlpZiAoICF0b1Nob3cubGVuZ3RoICkgewoJCQlyZXR1cm4gdG9IaWRlLmFuaW1hdGUoIHRoaXMuaGlkZVByb3BzLCBkdXJhdGlvbiwgZWFzaW5nLCBjb21wbGV0ZSApOwoJCX0KCgkJdG90YWwgPSB0b1Nob3cuc2hvdygpLm91dGVySGVpZ2h0KCk7CgkJdG9IaWRlLmFuaW1hdGUoIHRoaXMuaGlkZVByb3BzLCB7CgkJCWR1cmF0aW9uOiBkdXJhdGlvbiwKCQkJZWFzaW5nOiBlYXNpbmcsCgkJCXN0ZXA6IGZ1bmN0aW9uKCBub3csIGZ4ICkgewoJCQkJZngubm93ID0gTWF0aC5yb3VuZCggbm93ICk7CgkJCX0KCQl9ICk7CgkJdG9TaG93CgkJCS5oaWRlKCkKCQkJLmFuaW1hdGUoIHRoaXMuc2hvd1Byb3BzLCB7CgkJCQlkdXJhdGlvbjogZHVyYXRpb24sCgkJCQllYXNpbmc6IGVhc2luZywKCQkJCWNvbXBsZXRlOiBjb21wbGV0ZSwKCQkJCXN0ZXA6IGZ1bmN0aW9uKCBub3csIGZ4ICkgewoJCQkJCWZ4Lm5vdyA9IE1hdGgucm91bmQoIG5vdyApOwoJCQkJCWlmICggZngucHJvcCAhPT0gImhlaWdodCIgKSB7CgkJCQkJCWlmICggYm94U2l6aW5nID09PSAiY29udGVudC1ib3giICkgewoJCQkJCQkJYWRqdXN0ICs9IGZ4Lm5vdzsKCQkJCQkJfQoJCQkJCX0gZWxzZSBpZiAoIHRoYXQub3B0aW9ucy5oZWlnaHRTdHlsZSAhPT0gImNvbnRlbnQiICkgewoJCQkJCQlmeC5ub3cgPSBNYXRoLnJvdW5kKCB0b3RhbCAtIHRvSGlkZS5vdXRlckhlaWdodCgpIC0gYWRqdXN0ICk7CgkJCQkJCWFkanVzdCA9IDA7CgkJCQkJfQoJCQkJfQoJCQl9ICk7Cgl9LAoKCV90b2dnbGVDb21wbGV0ZTogZnVuY3Rpb24oIGRhdGEgKSB7CgkJdmFyIHRvSGlkZSA9IGRhdGEub2xkUGFuZWwsCgkJCXByZXYgPSB0b0hpZGUucHJldigpOwoKCQl0aGlzLl9yZW1vdmVDbGFzcyggdG9IaWRlLCAidWktYWNjb3JkaW9uLWNvbnRlbnQtYWN0aXZlIiApOwoJCXRoaXMuX3JlbW92ZUNsYXNzKCBwcmV2LCAidWktYWNjb3JkaW9uLWhlYWRlci1hY3RpdmUiICkKCQkJLl9hZGRDbGFzcyggcHJldiwgInVpLWFjY29yZGlvbi1oZWFkZXItY29sbGFwc2VkIiApOwoKCQkvLyBXb3JrIGFyb3VuZCBmb3IgcmVuZGVyaW5nIGJ1ZyBpbiBJRSAoIzU0MjEpCgkJaWYgKCB0b0hpZGUubGVuZ3RoICkgewoJCQl0b0hpZGUucGFyZW50KClbIDAgXS5jbGFzc05hbWUgPSB0b0hpZGUucGFyZW50KClbIDAgXS5jbGFzc05hbWU7CgkJfQoJCXRoaXMuX3RyaWdnZXIoICJhY3RpdmF0ZSIsIG51bGwsIGRhdGEgKTsKCX0KfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgTWVudSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IE1lbnUKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vPj5kZXNjcmlwdGlvbjogQ3JlYXRlcyBuZXN0YWJsZSBtZW51cy4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL21lbnUvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9tZW51LwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MKLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL21lbnUuY3NzCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcwoKCgp2YXIgd2lkZ2V0c01lbnUgPSAkLndpZGdldCggInVpLm1lbnUiLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCWRlZmF1bHRFbGVtZW50OiAiPHVsPiIsCglkZWxheTogMzAwLAoJb3B0aW9uczogewoJCWljb25zOiB7CgkJCXN1Ym1lbnU6ICJ1aS1pY29uLWNhcmV0LTEtZSIKCQl9LAoJCWl0ZW1zOiAiPiAqIiwKCQltZW51czogInVsIiwKCQlwb3NpdGlvbjogewoJCQlteTogImxlZnQgdG9wIiwKCQkJYXQ6ICJyaWdodCB0b3AiCgkJfSwKCQlyb2xlOiAibWVudSIsCgoJCS8vIENhbGxiYWNrcwoJCWJsdXI6IG51bGwsCgkJZm9jdXM6IG51bGwsCgkJc2VsZWN0OiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuYWN0aXZlTWVudSA9IHRoaXMuZWxlbWVudDsKCgkJLy8gRmxhZyB1c2VkIHRvIHByZXZlbnQgZmlyaW5nIG9mIHRoZSBjbGljayBoYW5kbGVyCgkJLy8gYXMgdGhlIGV2ZW50IGJ1YmJsZXMgdXAgdGhyb3VnaCBuZXN0ZWQgbWVudXMKCQl0aGlzLm1vdXNlSGFuZGxlZCA9IGZhbHNlOwoJCXRoaXMuZWxlbWVudAoJCQkudW5pcXVlSWQoKQoJCQkuYXR0ciggewoJCQkJcm9sZTogdGhpcy5vcHRpb25zLnJvbGUsCgkJCQl0YWJJbmRleDogMAoJCQl9ICk7CgoJCXRoaXMuX2FkZENsYXNzKCAidWktbWVudSIsICJ1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQiICk7CgkJdGhpcy5fb24oIHsKCgkJCS8vIFByZXZlbnQgZm9jdXMgZnJvbSBzdGlja2luZyB0byBsaW5rcyBpbnNpZGUgbWVudSBhZnRlciBjbGlja2luZwoJCQkvLyB0aGVtIChmb2N1cyBzaG91bGQgYWx3YXlzIHN0YXkgb24gVUwgZHVyaW5nIG5hdmlnYXRpb24pLgoJCQkibW91c2Vkb3duIC51aS1tZW51LWl0ZW0iOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9LAoJCQkiY2xpY2sgLnVpLW1lbnUtaXRlbSI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKTsKCQkJCXZhciBhY3RpdmUgPSAkKCAkLnVpLnNhZmVBY3RpdmVFbGVtZW50KCB0aGlzLmRvY3VtZW50WyAwIF0gKSApOwoJCQkJaWYgKCAhdGhpcy5tb3VzZUhhbmRsZWQgJiYgdGFyZ2V0Lm5vdCggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKS5sZW5ndGggKSB7CgkJCQkJdGhpcy5zZWxlY3QoIGV2ZW50ICk7CgoJCQkJCS8vIE9ubHkgc2V0IHRoZSBtb3VzZUhhbmRsZWQgZmxhZyBpZiB0aGUgZXZlbnQgd2lsbCBidWJibGUsIHNlZSAjOTQ2OS4KCQkJCQlpZiAoICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJCQl0aGlzLm1vdXNlSGFuZGxlZCA9IHRydWU7CgkJCQkJfQoKCQkJCQkvLyBPcGVuIHN1Ym1lbnUgb24gY2xpY2sKCQkJCQlpZiAoIHRhcmdldC5oYXMoICIudWktbWVudSIgKS5sZW5ndGggKSB7CgkJCQkJCXRoaXMuZXhwYW5kKCBldmVudCApOwoJCQkJCX0gZWxzZSBpZiAoICF0aGlzLmVsZW1lbnQuaXMoICI6Zm9jdXMiICkgJiYKCQkJCQkJCWFjdGl2ZS5jbG9zZXN0KCAiLnVpLW1lbnUiICkubGVuZ3RoICkgewoKCQkJCQkJLy8gUmVkaXJlY3QgZm9jdXMgdG8gdGhlIG1lbnUKCQkJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJmb2N1cyIsIFsgdHJ1ZSBdICk7CgoJCQkJCQkvLyBJZiB0aGUgYWN0aXZlIGl0ZW0gaXMgb24gdGhlIHRvcCBsZXZlbCwgbGV0IGl0IHN0YXkgYWN0aXZlLgoJCQkJCQkvLyBPdGhlcndpc2UsIGJsdXIgdGhlIGFjdGl2ZSBpdGVtIHNpbmNlIGl0IGlzIG5vIGxvbmdlciB2aXNpYmxlLgoJCQkJCQlpZiAoIHRoaXMuYWN0aXZlICYmIHRoaXMuYWN0aXZlLnBhcmVudHMoICIudWktbWVudSIgKS5sZW5ndGggPT09IDEgKSB7CgkJCQkJCQljbGVhclRpbWVvdXQoIHRoaXMudGltZXIgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSwKCQkJIm1vdXNlZW50ZXIgLnVpLW1lbnUtaXRlbSI6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkvLyBJZ25vcmUgbW91c2UgZXZlbnRzIHdoaWxlIHR5cGVhaGVhZCBpcyBhY3RpdmUsIHNlZSAjMTA0NTguCgkJCQkvLyBQcmV2ZW50cyBmb2N1c2luZyB0aGUgd3JvbmcgaXRlbSB3aGVuIHR5cGVhaGVhZCBjYXVzZXMgYSBzY3JvbGwgd2hpbGUgdGhlIG1vdXNlCgkJCQkvLyBpcyBvdmVyIGFuIGl0ZW0gaW4gdGhlIG1lbnUKCQkJCWlmICggdGhpcy5wcmV2aW91c0ZpbHRlciApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdmFyIGFjdHVhbFRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktbWVudS1pdGVtIiApLAoJCQkJCXRhcmdldCA9ICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKTsKCgkJCQkvLyBJZ25vcmUgYnViYmxlZCBldmVudHMgb24gcGFyZW50IGl0ZW1zLCBzZWUgIzExNjQxCgkJCQlpZiAoIGFjdHVhbFRhcmdldFsgMCBdICE9PSB0YXJnZXRbIDAgXSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIHVpLXN0YXRlLWFjdGl2ZSBjbGFzcyBmcm9tIHNpYmxpbmdzIG9mIHRoZSBuZXdseSBmb2N1c2VkIG1lbnUgaXRlbQoJCQkJLy8gdG8gYXZvaWQgYSBqdW1wIGNhdXNlZCBieSBhZGphY2VudCBlbGVtZW50cyBib3RoIGhhdmluZyBhIGNsYXNzIHdpdGggYSBib3JkZXIKCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0YXJnZXQuc2libGluZ3MoKS5jaGlsZHJlbiggIi51aS1zdGF0ZS1hY3RpdmUiICksCgkJCQkJbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCXRoaXMuZm9jdXMoIGV2ZW50LCB0YXJnZXQgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogImNvbGxhcHNlQWxsIiwKCQkJIm1vdXNlbGVhdmUgLnVpLW1lbnUiOiAiY29sbGFwc2VBbGwiLAoJCQlmb2N1czogZnVuY3Rpb24oIGV2ZW50LCBrZWVwQWN0aXZlSXRlbSApIHsKCgkJCQkvLyBJZiB0aGVyZSdzIGFscmVhZHkgYW4gYWN0aXZlIGl0ZW0sIGtlZXAgaXQgYWN0aXZlCgkJCQkvLyBJZiBub3QsIGFjdGl2YXRlIHRoZSBmaXJzdCBpdGVtCgkJCQl2YXIgaXRlbSA9IHRoaXMuYWN0aXZlIHx8IHRoaXMuZWxlbWVudC5maW5kKCB0aGlzLm9wdGlvbnMuaXRlbXMgKS5lcSggMCApOwoKCQkJCWlmICggIWtlZXBBY3RpdmVJdGVtICkgewoJCQkJCXRoaXMuZm9jdXMoIGV2ZW50LCBpdGVtICk7CgkJCQl9CgkJCX0sCgkJCWJsdXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgbm90Q29udGFpbmVkID0gISQuY29udGFpbnMoCgkJCQkJCXRoaXMuZWxlbWVudFsgMCBdLAoJCQkJCQkkLnVpLnNhZmVBY3RpdmVFbGVtZW50KCB0aGlzLmRvY3VtZW50WyAwIF0gKQoJCQkJCSk7CgkJCQkJaWYgKCBub3RDb250YWluZWQgKSB7CgkJCQkJCXRoaXMuY29sbGFwc2VBbGwoIGV2ZW50ICk7CgkJCQkJfQoJCQkJfSApOwoJCQl9LAoJCQlrZXlkb3duOiAiX2tleWRvd24iCgkJfSApOwoKCQl0aGlzLnJlZnJlc2goKTsKCgkJLy8gQ2xpY2tzIG91dHNpZGUgb2YgYSBtZW51IGNvbGxhcHNlIGFueSBvcGVuIG1lbnVzCgkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsKCQkJY2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdGhpcy5fY2xvc2VPbkRvY3VtZW50Q2xpY2soIGV2ZW50ICkgKSB7CgkJCQkJdGhpcy5jb2xsYXBzZUFsbCggZXZlbnQgKTsKCQkJCX0KCgkJCQkvLyBSZXNldCB0aGUgbW91c2VIYW5kbGVkIGZsYWcKCQkJCXRoaXMubW91c2VIYW5kbGVkID0gZmFsc2U7CgkJCX0KCQl9ICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgaXRlbXMgPSB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1tZW51LWl0ZW0iICkKCQkJCS5yZW1vdmVBdHRyKCAicm9sZSBhcmlhLWRpc2FibGVkIiApLAoJCQlzdWJtZW51cyA9IGl0ZW1zLmNoaWxkcmVuKCAiLnVpLW1lbnUtaXRlbS13cmFwcGVyIiApCgkJCQkucmVtb3ZlVW5pcXVlSWQoKQoJCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCByb2xlIGFyaWEtaGFzcG9wdXAiICk7CgoJCS8vIERlc3Ryb3kgKHN1YiltZW51cwoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQXR0ciggImFyaWEtYWN0aXZlZGVzY2VuZGFudCIgKQoJCQkuZmluZCggIi51aS1tZW51IiApLmFkZEJhY2soKQoJCQkJLnJlbW92ZUF0dHIoICJyb2xlIGFyaWEtbGFiZWxsZWRieSBhcmlhLWV4cGFuZGVkIGFyaWEtaGlkZGVuIGFyaWEtZGlzYWJsZWQgIiArCgkJCQkJInRhYkluZGV4IiApCgkJCQkucmVtb3ZlVW5pcXVlSWQoKQoJCQkJLnNob3coKTsKCgkJc3VibWVudXMuY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzICk7CgkJCWlmICggZWxlbS5kYXRhKCAidWktbWVudS1zdWJtZW51LWNhcmV0IiApICkgewoJCQkJZWxlbS5yZW1vdmUoKTsKCQkJfQoJCX0gKTsKCX0sCgoJX2tleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgbWF0Y2gsIHByZXYsIGNoYXJhY3Rlciwgc2tpcCwKCQkJcHJldmVudERlZmF1bHQgPSB0cnVlOwoKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCWNhc2UgJC51aS5rZXlDb2RlLlBBR0VfVVA6CgkJCXRoaXMucHJldmlvdXNQYWdlKCBldmVudCApOwoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5QQUdFX0RPV046CgkJCXRoaXMubmV4dFBhZ2UoIGV2ZW50ICk7CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLkhPTUU6CgkJCXRoaXMuX21vdmUoICJmaXJzdCIsICJmaXJzdCIsIGV2ZW50ICk7CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoKCQkJdGhpcy5fbW92ZSggImxhc3QiLCAibGFzdCIsIGV2ZW50ICk7CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLlVQOgoJCQl0aGlzLnByZXZpb3VzKCBldmVudCApOwoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5ET1dOOgoJCQl0aGlzLm5leHQoIGV2ZW50ICk7CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLkxFRlQ6CgkJCXRoaXMuY29sbGFwc2UoIGV2ZW50ICk7CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLlJJR0hUOgoJCQlpZiAoIHRoaXMuYWN0aXZlICYmICF0aGlzLmFjdGl2ZS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCXRoaXMuZXhwYW5kKCBldmVudCApOwoJCQl9CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLkVOVEVSOgoJCWNhc2UgJC51aS5rZXlDb2RlLlNQQUNFOgoJCQl0aGlzLl9hY3RpdmF0ZSggZXZlbnQgKTsKCQkJYnJlYWs7CgkJY2FzZSAkLnVpLmtleUNvZGUuRVNDQVBFOgoJCQl0aGlzLmNvbGxhcHNlKCBldmVudCApOwoJCQlicmVhazsKCQlkZWZhdWx0OgoJCQlwcmV2ZW50RGVmYXVsdCA9IGZhbHNlOwoJCQlwcmV2ID0gdGhpcy5wcmV2aW91c0ZpbHRlciB8fCAiIjsKCQkJc2tpcCA9IGZhbHNlOwoKCQkJLy8gU3VwcG9ydCBudW1iZXIgcGFkIHZhbHVlcwoJCQljaGFyYWN0ZXIgPSBldmVudC5rZXlDb2RlID49IDk2ICYmIGV2ZW50LmtleUNvZGUgPD0gMTA1ID8KCQkJCSggZXZlbnQua2V5Q29kZSAtIDk2ICkudG9TdHJpbmcoKSA6IFN0cmluZy5mcm9tQ2hhckNvZGUoIGV2ZW50LmtleUNvZGUgKTsKCgkJCWNsZWFyVGltZW91dCggdGhpcy5maWx0ZXJUaW1lciApOwoKCQkJaWYgKCBjaGFyYWN0ZXIgPT09IHByZXYgKSB7CgkJCQlza2lwID0gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCWNoYXJhY3RlciA9IHByZXYgKyBjaGFyYWN0ZXI7CgkJCX0KCgkJCW1hdGNoID0gdGhpcy5fZmlsdGVyTWVudUl0ZW1zKCBjaGFyYWN0ZXIgKTsKCQkJbWF0Y2ggPSBza2lwICYmIG1hdGNoLmluZGV4KCB0aGlzLmFjdGl2ZS5uZXh0KCkgKSAhPT0gLTEgPwoJCQkJdGhpcy5hY3RpdmUubmV4dEFsbCggIi51aS1tZW51LWl0ZW0iICkgOgoJCQkJbWF0Y2g7CgoJCQkvLyBJZiBubyBtYXRjaGVzIG9uIHRoZSBjdXJyZW50IGZpbHRlciwgcmVzZXQgdG8gdGhlIGxhc3QgY2hhcmFjdGVyIHByZXNzZWQKCQkJLy8gdG8gbW92ZSBkb3duIHRoZSBtZW51IHRvIHRoZSBmaXJzdCBpdGVtIHRoYXQgc3RhcnRzIHdpdGggdGhhdCBjaGFyYWN0ZXIKCQkJaWYgKCAhbWF0Y2gubGVuZ3RoICkgewoJCQkJY2hhcmFjdGVyID0gU3RyaW5nLmZyb21DaGFyQ29kZSggZXZlbnQua2V5Q29kZSApOwoJCQkJbWF0Y2ggPSB0aGlzLl9maWx0ZXJNZW51SXRlbXMoIGNoYXJhY3RlciApOwoJCQl9CgoJCQlpZiAoIG1hdGNoLmxlbmd0aCApIHsKCQkJCXRoaXMuZm9jdXMoIGV2ZW50LCBtYXRjaCApOwoJCQkJdGhpcy5wcmV2aW91c0ZpbHRlciA9IGNoYXJhY3RlcjsKCQkJCXRoaXMuZmlsdGVyVGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQkJZGVsZXRlIHRoaXMucHJldmlvdXNGaWx0ZXI7CgkJCQl9LCAxMDAwICk7CgkJCX0gZWxzZSB7CgkJCQlkZWxldGUgdGhpcy5wcmV2aW91c0ZpbHRlcjsKCQkJfQoJCX0KCgkJaWYgKCBwcmV2ZW50RGVmYXVsdCApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9LAoKCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5hY3RpdmUgJiYgIXRoaXMuYWN0aXZlLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQlpZiAoIHRoaXMuYWN0aXZlLmNoaWxkcmVuKCAiW2FyaWEtaGFzcG9wdXA9J3RydWUnXSIgKS5sZW5ndGggKSB7CgkJCQl0aGlzLmV4cGFuZCggZXZlbnQgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuc2VsZWN0KCBldmVudCApOwoJCQl9CgkJfQoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgbWVudXMsIGl0ZW1zLCBuZXdTdWJtZW51cywgbmV3SXRlbXMsIG5ld1dyYXBwZXJzLAoJCQl0aGF0ID0gdGhpcywKCQkJaWNvbiA9IHRoaXMub3B0aW9ucy5pY29ucy5zdWJtZW51LAoJCQlzdWJtZW51cyA9IHRoaXMuZWxlbWVudC5maW5kKCB0aGlzLm9wdGlvbnMubWVudXMgKTsKCgkJdGhpcy5fdG9nZ2xlQ2xhc3MoICJ1aS1tZW51LWljb25zIiwgbnVsbCwgISF0aGlzLmVsZW1lbnQuZmluZCggIi51aS1pY29uIiApLmxlbmd0aCApOwoKCQkvLyBJbml0aWFsaXplIG5lc3RlZCBtZW51cwoJCW5ld1N1Ym1lbnVzID0gc3VibWVudXMuZmlsdGVyKCAiOm5vdCgudWktbWVudSkiICkKCQkJLmhpZGUoKQoJCQkuYXR0ciggewoJCQkJcm9sZTogdGhpcy5vcHRpb25zLnJvbGUsCgkJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIsCgkJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIKCQkJfSApCgkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBtZW51ID0gJCggdGhpcyApLAoJCQkJCWl0ZW0gPSBtZW51LnByZXYoKSwKCQkJCQlzdWJtZW51Q2FyZXQgPSAkKCAiPHNwYW4+IiApLmRhdGEoICJ1aS1tZW51LXN1Ym1lbnUtY2FyZXQiLCB0cnVlICk7CgoJCQkJdGhhdC5fYWRkQ2xhc3MoIHN1Ym1lbnVDYXJldCwgInVpLW1lbnUtaWNvbiIsICJ1aS1pY29uICIgKyBpY29uICk7CgkJCQlpdGVtCgkJCQkJLmF0dHIoICJhcmlhLWhhc3BvcHVwIiwgInRydWUiICkKCQkJCQkucHJlcGVuZCggc3VibWVudUNhcmV0ICk7CgkJCQltZW51LmF0dHIoICJhcmlhLWxhYmVsbGVkYnkiLCBpdGVtLmF0dHIoICJpZCIgKSApOwoJCQl9ICk7CgoJCXRoaXMuX2FkZENsYXNzKCBuZXdTdWJtZW51cywgInVpLW1lbnUiLCAidWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWZyb250IiApOwoKCQltZW51cyA9IHN1Ym1lbnVzLmFkZCggdGhpcy5lbGVtZW50ICk7CgkJaXRlbXMgPSBtZW51cy5maW5kKCB0aGlzLm9wdGlvbnMuaXRlbXMgKTsKCgkJLy8gSW5pdGlhbGl6ZSBtZW51LWl0ZW1zIGNvbnRhaW5pbmcgc3BhY2VzIGFuZC9vciBkYXNoZXMgb25seSBhcyBkaXZpZGVycwoJCWl0ZW1zLm5vdCggIi51aS1tZW51LWl0ZW0iICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBpdGVtID0gJCggdGhpcyApOwoJCQlpZiAoIHRoYXQuX2lzRGl2aWRlciggaXRlbSApICkgewoJCQkJdGhhdC5fYWRkQ2xhc3MoIGl0ZW0sICJ1aS1tZW51LWRpdmlkZXIiLCAidWktd2lkZ2V0LWNvbnRlbnQiICk7CgkJCX0KCQl9ICk7CgoJCS8vIERvbid0IHJlZnJlc2ggbGlzdCBpdGVtcyB0aGF0IGFyZSBhbHJlYWR5IGFkYXB0ZWQKCQluZXdJdGVtcyA9IGl0ZW1zLm5vdCggIi51aS1tZW51LWl0ZW0sIC51aS1tZW51LWRpdmlkZXIiICk7CgkJbmV3V3JhcHBlcnMgPSBuZXdJdGVtcy5jaGlsZHJlbigpCgkJCS5ub3QoICIudWktbWVudSIgKQoJCQkJLnVuaXF1ZUlkKCkKCQkJCS5hdHRyKCB7CgkJCQkJdGFiSW5kZXg6IC0xLAoJCQkJCXJvbGU6IHRoaXMuX2l0ZW1Sb2xlKCkKCQkJCX0gKTsKCQl0aGlzLl9hZGRDbGFzcyggbmV3SXRlbXMsICJ1aS1tZW51LWl0ZW0iICkKCQkJLl9hZGRDbGFzcyggbmV3V3JhcHBlcnMsICJ1aS1tZW51LWl0ZW0td3JhcHBlciIgKTsKCgkJLy8gQWRkIGFyaWEtZGlzYWJsZWQgYXR0cmlidXRlIHRvIGFueSBkaXNhYmxlZCBtZW51IGl0ZW0KCQlpdGVtcy5maWx0ZXIoICIudWktc3RhdGUtZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCAidHJ1ZSIgKTsKCgkJLy8gSWYgdGhlIGFjdGl2ZSBpdGVtIGhhcyBiZWVuIHJlbW92ZWQsIGJsdXIgdGhlIG1lbnUKCQlpZiAoIHRoaXMuYWN0aXZlICYmICEkLmNvbnRhaW5zKCB0aGlzLmVsZW1lbnRbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgewoJCQl0aGlzLmJsdXIoKTsKCQl9Cgl9LAoKCV9pdGVtUm9sZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJbWVudTogIm1lbnVpdGVtIiwKCQkJbGlzdGJveDogIm9wdGlvbiIKCQl9WyB0aGlzLm9wdGlvbnMucm9sZSBdOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImljb25zIiApIHsKCQkJdmFyIGljb25zID0gdGhpcy5lbGVtZW50LmZpbmQoICIudWktbWVudS1pY29uIiApOwoJCQl0aGlzLl9yZW1vdmVDbGFzcyggaWNvbnMsIG51bGwsIHRoaXMub3B0aW9ucy5pY29ucy5zdWJtZW51ICkKCQkJCS5fYWRkQ2xhc3MoIGljb25zLCBudWxsLCB2YWx1ZS5zdWJtZW51ICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7Cgl9LAoKCV9zZXRPcHRpb25EaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuX3N1cGVyKCB2YWx1ZSApOwoKCQl0aGlzLmVsZW1lbnQuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBTdHJpbmcoIHZhbHVlICkgKTsKCQl0aGlzLl90b2dnbGVDbGFzcyggbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiwgISF2YWx1ZSApOwoJfSwKCglmb2N1czogZnVuY3Rpb24oIGV2ZW50LCBpdGVtICkgewoJCXZhciBuZXN0ZWQsIGZvY3VzZWQsIGFjdGl2ZVBhcmVudDsKCQl0aGlzLmJsdXIoIGV2ZW50LCBldmVudCAmJiBldmVudC50eXBlID09PSAiZm9jdXMiICk7CgoJCXRoaXMuX3Njcm9sbEludG9WaWV3KCBpdGVtICk7CgoJCXRoaXMuYWN0aXZlID0gaXRlbS5maXJzdCgpOwoKCQlmb2N1c2VkID0gdGhpcy5hY3RpdmUuY2hpbGRyZW4oICIudWktbWVudS1pdGVtLXdyYXBwZXIiICk7CgkJdGhpcy5fYWRkQ2xhc3MoIGZvY3VzZWQsIG51bGwsICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgoJCS8vIE9ubHkgdXBkYXRlIGFyaWEtYWN0aXZlZGVzY2VuZGFudCBpZiB0aGVyZSdzIGEgcm9sZQoJCS8vIG90aGVyd2lzZSB3ZSBhc3N1bWUgZm9jdXMgaXMgbWFuYWdlZCBlbHNld2hlcmUKCQlpZiAoIHRoaXMub3B0aW9ucy5yb2xlICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggImFyaWEtYWN0aXZlZGVzY2VuZGFudCIsIGZvY3VzZWQuYXR0ciggImlkIiApICk7CgkJfQoKCQkvLyBIaWdobGlnaHQgYWN0aXZlIHBhcmVudCBtZW51IGl0ZW0sIGlmIGFueQoJCWFjdGl2ZVBhcmVudCA9IHRoaXMuYWN0aXZlCgkJCS5wYXJlbnQoKQoJCQkJLmNsb3Nlc3QoICIudWktbWVudS1pdGVtIiApCgkJCQkJLmNoaWxkcmVuKCAiLnVpLW1lbnUtaXRlbS13cmFwcGVyIiApOwoJCXRoaXMuX2FkZENsYXNzKCBhY3RpdmVQYXJlbnQsIG51bGwsICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgoJCWlmICggZXZlbnQgJiYgZXZlbnQudHlwZSA9PT0gImtleWRvd24iICkgewoJCQl0aGlzLl9jbG9zZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMudGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9jbG9zZSgpOwoJCQl9LCB0aGlzLmRlbGF5ICk7CgkJfQoKCQluZXN0ZWQgPSBpdGVtLmNoaWxkcmVuKCAiLnVpLW1lbnUiICk7CgkJaWYgKCBuZXN0ZWQubGVuZ3RoICYmIGV2ZW50ICYmICggL15tb3VzZS8udGVzdCggZXZlbnQudHlwZSApICkgKSB7CgkJCXRoaXMuX3N0YXJ0T3BlbmluZyggbmVzdGVkICk7CgkJfQoJCXRoaXMuYWN0aXZlTWVudSA9IGl0ZW0ucGFyZW50KCk7CgoJCXRoaXMuX3RyaWdnZXIoICJmb2N1cyIsIGV2ZW50LCB7IGl0ZW06IGl0ZW0gfSApOwoJfSwKCglfc2Nyb2xsSW50b1ZpZXc6IGZ1bmN0aW9uKCBpdGVtICkgewoJCXZhciBib3JkZXJUb3AsIHBhZGRpbmdUb3AsIG9mZnNldCwgc2Nyb2xsLCBlbGVtZW50SGVpZ2h0LCBpdGVtSGVpZ2h0OwoJCWlmICggdGhpcy5faGFzU2Nyb2xsKCkgKSB7CgkJCWJvcmRlclRvcCA9IHBhcnNlRmxvYXQoICQuY3NzKCB0aGlzLmFjdGl2ZU1lbnVbIDAgXSwgImJvcmRlclRvcFdpZHRoIiApICkgfHwgMDsKCQkJcGFkZGluZ1RvcCA9IHBhcnNlRmxvYXQoICQuY3NzKCB0aGlzLmFjdGl2ZU1lbnVbIDAgXSwgInBhZGRpbmdUb3AiICkgKSB8fCAwOwoJCQlvZmZzZXQgPSBpdGVtLm9mZnNldCgpLnRvcCAtIHRoaXMuYWN0aXZlTWVudS5vZmZzZXQoKS50b3AgLSBib3JkZXJUb3AgLSBwYWRkaW5nVG9wOwoJCQlzY3JvbGwgPSB0aGlzLmFjdGl2ZU1lbnUuc2Nyb2xsVG9wKCk7CgkJCWVsZW1lbnRIZWlnaHQgPSB0aGlzLmFjdGl2ZU1lbnUuaGVpZ2h0KCk7CgkJCWl0ZW1IZWlnaHQgPSBpdGVtLm91dGVySGVpZ2h0KCk7CgoJCQlpZiAoIG9mZnNldCA8IDAgKSB7CgkJCQl0aGlzLmFjdGl2ZU1lbnUuc2Nyb2xsVG9wKCBzY3JvbGwgKyBvZmZzZXQgKTsKCQkJfSBlbHNlIGlmICggb2Zmc2V0ICsgaXRlbUhlaWdodCA+IGVsZW1lbnRIZWlnaHQgKSB7CgkJCQl0aGlzLmFjdGl2ZU1lbnUuc2Nyb2xsVG9wKCBzY3JvbGwgKyBvZmZzZXQgLSBlbGVtZW50SGVpZ2h0ICsgaXRlbUhlaWdodCApOwoJCQl9CgkJfQoJfSwKCglibHVyOiBmdW5jdGlvbiggZXZlbnQsIGZyb21Gb2N1cyApIHsKCQlpZiAoICFmcm9tRm9jdXMgKSB7CgkJCWNsZWFyVGltZW91dCggdGhpcy50aW1lciApOwoJCX0KCgkJaWYgKCAhdGhpcy5hY3RpdmUgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmFjdGl2ZS5jaGlsZHJlbiggIi51aS1tZW51LWl0ZW0td3JhcHBlciIgKSwKCQkJbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCgkJdGhpcy5fdHJpZ2dlciggImJsdXIiLCBldmVudCwgeyBpdGVtOiB0aGlzLmFjdGl2ZSB9ICk7CgkJdGhpcy5hY3RpdmUgPSBudWxsOwoJfSwKCglfc3RhcnRPcGVuaW5nOiBmdW5jdGlvbiggc3VibWVudSApIHsKCQljbGVhclRpbWVvdXQoIHRoaXMudGltZXIgKTsKCgkJLy8gRG9uJ3Qgb3BlbiBpZiBhbHJlYWR5IG9wZW4gZml4ZXMgYSBGaXJlZm94IGJ1ZyB0aGF0IGNhdXNlZCBhIC41IHBpeGVsCgkJLy8gc2hpZnQgaW4gdGhlIHN1Ym1lbnUgcG9zaXRpb24gd2hlbiBtb3VzaW5nIG92ZXIgdGhlIGNhcmV0IGljb24KCQlpZiAoIHN1Ym1lbnUuYXR0ciggImFyaWEtaGlkZGVuIiApICE9PSAidHJ1ZSIgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMudGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2Nsb3NlKCk7CgkJCXRoaXMuX29wZW4oIHN1Ym1lbnUgKTsKCQl9LCB0aGlzLmRlbGF5ICk7Cgl9LAoKCV9vcGVuOiBmdW5jdGlvbiggc3VibWVudSApIHsKCQl2YXIgcG9zaXRpb24gPSAkLmV4dGVuZCggewoJCQlvZjogdGhpcy5hY3RpdmUKCQl9LCB0aGlzLm9wdGlvbnMucG9zaXRpb24gKTsKCgkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7CgkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktbWVudSIgKS5ub3QoIHN1Ym1lbnUucGFyZW50cyggIi51aS1tZW51IiApICkKCQkJLmhpZGUoKQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgInRydWUiICk7CgoJCXN1Ym1lbnUKCQkJLnNob3coKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtaGlkZGVuIiApCgkJCS5hdHRyKCAiYXJpYS1leHBhbmRlZCIsICJ0cnVlIiApCgkJCS5wb3NpdGlvbiggcG9zaXRpb24gKTsKCX0sCgoJY29sbGFwc2VBbGw6IGZ1bmN0aW9uKCBldmVudCwgYWxsICkgewoJCWNsZWFyVGltZW91dCggdGhpcy50aW1lciApOwoJCXRoaXMudGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgoJCQkvLyBJZiB3ZSB3ZXJlIHBhc3NlZCBhbiBldmVudCwgbG9vayBmb3IgdGhlIHN1Ym1lbnUgdGhhdCBjb250YWlucyB0aGUgZXZlbnQKCQkJdmFyIGN1cnJlbnRNZW51ID0gYWxsID8gdGhpcy5lbGVtZW50IDoKCQkJCSQoIGV2ZW50ICYmIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLW1lbnUiICkgKTsKCgkJCS8vIElmIHdlIGZvdW5kIG5vIHZhbGlkIHN1Ym1lbnUgYW5jZXN0b3IsIHVzZSB0aGUgbWFpbiBtZW51IHRvIGNsb3NlIGFsbAoJCQkvLyBzdWIgbWVudXMgYW55d2F5CgkJCWlmICggIWN1cnJlbnRNZW51Lmxlbmd0aCApIHsKCQkJCWN1cnJlbnRNZW51ID0gdGhpcy5lbGVtZW50OwoJCQl9CgoJCQl0aGlzLl9jbG9zZSggY3VycmVudE1lbnUgKTsKCgkJCXRoaXMuYmx1ciggZXZlbnQgKTsKCgkJCS8vIFdvcmsgYXJvdW5kIGFjdGl2ZSBpdGVtIHN0YXlpbmcgYWN0aXZlIGFmdGVyIG1lbnUgaXMgYmx1cnJlZAoJCQl0aGlzLl9yZW1vdmVDbGFzcyggY3VycmVudE1lbnUuZmluZCggIi51aS1zdGF0ZS1hY3RpdmUiICksIG51bGwsICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgoJCQl0aGlzLmFjdGl2ZU1lbnUgPSBjdXJyZW50TWVudTsKCQl9LCB0aGlzLmRlbGF5ICk7Cgl9LAoKCS8vIFdpdGggbm8gYXJndW1lbnRzLCBjbG9zZXMgdGhlIGN1cnJlbnRseSBhY3RpdmUgbWVudSAtIGlmIG5vdGhpbmcgaXMgYWN0aXZlCgkvLyBpdCBjbG9zZXMgYWxsIG1lbnVzLiAgSWYgcGFzc2VkIGFuIGFyZ3VtZW50LCBpdCB3aWxsIHNlYXJjaCBmb3IgbWVudXMgQkVMT1cKCV9jbG9zZTogZnVuY3Rpb24oIHN0YXJ0TWVudSApIHsKCQlpZiAoICFzdGFydE1lbnUgKSB7CgkJCXN0YXJ0TWVudSA9IHRoaXMuYWN0aXZlID8gdGhpcy5hY3RpdmUucGFyZW50KCkgOiB0aGlzLmVsZW1lbnQ7CgkJfQoKCQlzdGFydE1lbnUuZmluZCggIi51aS1tZW51IiApCgkJCS5oaWRlKCkKCQkJLmF0dHIoICJhcmlhLWhpZGRlbiIsICJ0cnVlIiApCgkJCS5hdHRyKCAiYXJpYS1leHBhbmRlZCIsICJmYWxzZSIgKTsKCX0sCgoJX2Nsb3NlT25Eb2N1bWVudENsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJcmV0dXJuICEkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLW1lbnUiICkubGVuZ3RoOwoJfSwKCglfaXNEaXZpZGVyOiBmdW5jdGlvbiggaXRlbSApIHsKCgkJLy8gTWF0Y2ggaHlwaGVuLCBlbSBkYXNoLCBlbiBkYXNoCgkJcmV0dXJuICEvW15cLVx1MjAxNFx1MjAxM1xzXS8udGVzdCggaXRlbS50ZXh0KCkgKTsKCX0sCgoJY29sbGFwc2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgbmV3SXRlbSA9IHRoaXMuYWN0aXZlICYmCgkJCXRoaXMuYWN0aXZlLnBhcmVudCgpLmNsb3Nlc3QoICIudWktbWVudS1pdGVtIiwgdGhpcy5lbGVtZW50ICk7CgkJaWYgKCBuZXdJdGVtICYmIG5ld0l0ZW0ubGVuZ3RoICkgewoJCQl0aGlzLl9jbG9zZSgpOwoJCQl0aGlzLmZvY3VzKCBldmVudCwgbmV3SXRlbSApOwoJCX0KCX0sCgoJZXhwYW5kOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIG5ld0l0ZW0gPSB0aGlzLmFjdGl2ZSAmJgoJCQl0aGlzLmFjdGl2ZQoJCQkJLmNoaWxkcmVuKCAiLnVpLW1lbnUgIiApCgkJCQkJLmZpbmQoIHRoaXMub3B0aW9ucy5pdGVtcyApCgkJCQkJCS5maXJzdCgpOwoKCQlpZiAoIG5ld0l0ZW0gJiYgbmV3SXRlbS5sZW5ndGggKSB7CgkJCXRoaXMuX29wZW4oIG5ld0l0ZW0ucGFyZW50KCkgKTsKCgkJCS8vIERlbGF5IHNvIEZpcmVmb3ggd2lsbCBub3QgaGlkZSBhY3RpdmVkZXNjZW5kYW50IGNoYW5nZSBpbiBleHBhbmRpbmcgc3VibWVudSBmcm9tIEFUCgkJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCXRoaXMuZm9jdXMoIGV2ZW50LCBuZXdJdGVtICk7CgkJCX0gKTsKCQl9Cgl9LAoKCW5leHQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLl9tb3ZlKCAibmV4dCIsICJmaXJzdCIsIGV2ZW50ICk7Cgl9LAoKCXByZXZpb3VzOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fbW92ZSggInByZXYiLCAibGFzdCIsIGV2ZW50ICk7Cgl9LAoKCWlzRmlyc3RJdGVtOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5hY3RpdmUgJiYgIXRoaXMuYWN0aXZlLnByZXZBbGwoICIudWktbWVudS1pdGVtIiApLmxlbmd0aDsKCX0sCgoJaXNMYXN0SXRlbTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuYWN0aXZlICYmICF0aGlzLmFjdGl2ZS5uZXh0QWxsKCAiLnVpLW1lbnUtaXRlbSIgKS5sZW5ndGg7Cgl9LAoKCV9tb3ZlOiBmdW5jdGlvbiggZGlyZWN0aW9uLCBmaWx0ZXIsIGV2ZW50ICkgewoJCXZhciBuZXh0OwoJCWlmICggdGhpcy5hY3RpdmUgKSB7CgkJCWlmICggZGlyZWN0aW9uID09PSAiZmlyc3QiIHx8IGRpcmVjdGlvbiA9PT0gImxhc3QiICkgewoJCQkJbmV4dCA9IHRoaXMuYWN0aXZlCgkJCQkJWyBkaXJlY3Rpb24gPT09ICJmaXJzdCIgPyAicHJldkFsbCIgOiAibmV4dEFsbCIgXSggIi51aS1tZW51LWl0ZW0iICkKCQkJCQkuZXEoIC0xICk7CgkJCX0gZWxzZSB7CgkJCQluZXh0ID0gdGhpcy5hY3RpdmUKCQkJCQlbIGRpcmVjdGlvbiArICJBbGwiIF0oICIudWktbWVudS1pdGVtIiApCgkJCQkJLmVxKCAwICk7CgkJCX0KCQl9CgkJaWYgKCAhbmV4dCB8fCAhbmV4dC5sZW5ndGggfHwgIXRoaXMuYWN0aXZlICkgewoJCQluZXh0ID0gdGhpcy5hY3RpdmVNZW51LmZpbmQoIHRoaXMub3B0aW9ucy5pdGVtcyApWyBmaWx0ZXIgXSgpOwoJCX0KCgkJdGhpcy5mb2N1cyggZXZlbnQsIG5leHQgKTsKCX0sCgoJbmV4dFBhZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaXRlbSwgYmFzZSwgaGVpZ2h0OwoKCQlpZiAoICF0aGlzLmFjdGl2ZSApIHsKCQkJdGhpcy5uZXh0KCBldmVudCApOwoJCQlyZXR1cm47CgkJfQoJCWlmICggdGhpcy5pc0xhc3RJdGVtKCkgKSB7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLl9oYXNTY3JvbGwoKSApIHsKCQkJYmFzZSA9IHRoaXMuYWN0aXZlLm9mZnNldCgpLnRvcDsKCQkJaGVpZ2h0ID0gdGhpcy5lbGVtZW50LmhlaWdodCgpOwoJCQl0aGlzLmFjdGl2ZS5uZXh0QWxsKCAiLnVpLW1lbnUtaXRlbSIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCWl0ZW0gPSAkKCB0aGlzICk7CgkJCQlyZXR1cm4gaXRlbS5vZmZzZXQoKS50b3AgLSBiYXNlIC0gaGVpZ2h0IDwgMDsKCQkJfSApOwoKCQkJdGhpcy5mb2N1cyggZXZlbnQsIGl0ZW0gKTsKCQl9IGVsc2UgewoJCQl0aGlzLmZvY3VzKCBldmVudCwgdGhpcy5hY3RpdmVNZW51LmZpbmQoIHRoaXMub3B0aW9ucy5pdGVtcyApCgkJCQlbICF0aGlzLmFjdGl2ZSA/ICJmaXJzdCIgOiAibGFzdCIgXSgpICk7CgkJfQoJfSwKCglwcmV2aW91c1BhZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaXRlbSwgYmFzZSwgaGVpZ2h0OwoJCWlmICggIXRoaXMuYWN0aXZlICkgewoJCQl0aGlzLm5leHQoIGV2ZW50ICk7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLmlzRmlyc3RJdGVtKCkgKSB7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLl9oYXNTY3JvbGwoKSApIHsKCQkJYmFzZSA9IHRoaXMuYWN0aXZlLm9mZnNldCgpLnRvcDsKCQkJaGVpZ2h0ID0gdGhpcy5lbGVtZW50LmhlaWdodCgpOwoJCQl0aGlzLmFjdGl2ZS5wcmV2QWxsKCAiLnVpLW1lbnUtaXRlbSIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCWl0ZW0gPSAkKCB0aGlzICk7CgkJCQlyZXR1cm4gaXRlbS5vZmZzZXQoKS50b3AgLSBiYXNlICsgaGVpZ2h0ID4gMDsKCQkJfSApOwoKCQkJdGhpcy5mb2N1cyggZXZlbnQsIGl0ZW0gKTsKCQl9IGVsc2UgewoJCQl0aGlzLmZvY3VzKCBldmVudCwgdGhpcy5hY3RpdmVNZW51LmZpbmQoIHRoaXMub3B0aW9ucy5pdGVtcyApLmZpcnN0KCkgKTsKCQl9Cgl9LAoKCV9oYXNTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQub3V0ZXJIZWlnaHQoKSA8IHRoaXMuZWxlbWVudC5wcm9wKCAic2Nyb2xsSGVpZ2h0IiApOwoJfSwKCglzZWxlY3Q6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJLy8gVE9ETzogSXQgc2hvdWxkIG5ldmVyIGJlIHBvc3NpYmxlIHRvIG5vdCBoYXZlIGFuIGFjdGl2ZSBpdGVtIGF0IHRoaXMKCQkvLyBwb2ludCwgYnV0IHRoZSB0ZXN0cyBkb24ndCB0cmlnZ2VyIG1vdXNlZW50ZXIgYmVmb3JlIGNsaWNrLgoJCXRoaXMuYWN0aXZlID0gdGhpcy5hY3RpdmUgfHwgJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1tZW51LWl0ZW0iICk7CgkJdmFyIHVpID0geyBpdGVtOiB0aGlzLmFjdGl2ZSB9OwoJCWlmICggIXRoaXMuYWN0aXZlLmhhcyggIi51aS1tZW51IiApLmxlbmd0aCApIHsKCQkJdGhpcy5jb2xsYXBzZUFsbCggZXZlbnQsIHRydWUgKTsKCQl9CgkJdGhpcy5fdHJpZ2dlciggInNlbGVjdCIsIGV2ZW50LCB1aSApOwoJfSwKCglfZmlsdGVyTWVudUl0ZW1zOiBmdW5jdGlvbiggY2hhcmFjdGVyICkgewoJCXZhciBlc2NhcGVkQ2hhcmFjdGVyID0gY2hhcmFjdGVyLnJlcGxhY2UoIC9bXC1cW1xde30oKSorPy4sXFxcXiR8I1xzXS9nLCAiXFwkJiIgKSwKCQkJcmVnZXggPSBuZXcgUmVnRXhwKCAiXiIgKyBlc2NhcGVkQ2hhcmFjdGVyLCAiaSIgKTsKCgkJcmV0dXJuIHRoaXMuYWN0aXZlTWVudQoJCQkuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zICkKCgkJCQkvLyBPbmx5IG1hdGNoIG9uIGl0ZW1zLCBub3QgZGl2aWRlcnMgb3Igb3RoZXIgY29udGVudCAoIzEwNTcxKQoJCQkJLmZpbHRlciggIi51aS1tZW51LWl0ZW0iICkKCQkJCQkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIHJlZ2V4LnRlc3QoCgkJCQkJCQkkLnRyaW0oICQoIHRoaXMgKS5jaGlsZHJlbiggIi51aS1tZW51LWl0ZW0td3JhcHBlciIgKS50ZXh0KCkgKSApOwoJCQkJCX0gKTsKCX0KfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgQXV0b2NvbXBsZXRlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogQXV0b2NvbXBsZXRlCi8vPj5ncm91cDogV2lkZ2V0cwovLz4+ZGVzY3JpcHRpb246IExpc3RzIHN1Z2dlc3RlZCB3b3JkcyBhcyB0aGUgdXNlciBpcyB0eXBpbmcuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9hdXRvY29tcGxldGUvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9hdXRvY29tcGxldGUvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvYXV0b2NvbXBsZXRlLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKJC53aWRnZXQoICJ1aS5hdXRvY29tcGxldGUiLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCWRlZmF1bHRFbGVtZW50OiAiPGlucHV0PiIsCglvcHRpb25zOiB7CgkJYXBwZW5kVG86IG51bGwsCgkJYXV0b0ZvY3VzOiBmYWxzZSwKCQlkZWxheTogMzAwLAoJCW1pbkxlbmd0aDogMSwKCQlwb3NpdGlvbjogewoJCQlteTogImxlZnQgdG9wIiwKCQkJYXQ6ICJsZWZ0IGJvdHRvbSIsCgkJCWNvbGxpc2lvbjogIm5vbmUiCgkJfSwKCQlzb3VyY2U6IG51bGwsCgoJCS8vIENhbGxiYWNrcwoJCWNoYW5nZTogbnVsbCwKCQljbG9zZTogbnVsbCwKCQlmb2N1czogbnVsbCwKCQlvcGVuOiBudWxsLAoJCXJlc3BvbnNlOiBudWxsLAoJCXNlYXJjaDogbnVsbCwKCQlzZWxlY3Q6IG51bGwKCX0sCgoJcmVxdWVzdEluZGV4OiAwLAoJcGVuZGluZzogMCwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gU29tZSBicm93c2VycyBvbmx5IHJlcGVhdCBrZXlkb3duIGV2ZW50cywgbm90IGtleXByZXNzIGV2ZW50cywKCQkvLyBzbyB3ZSB1c2UgdGhlIHN1cHByZXNzS2V5UHJlc3MgZmxhZyB0byBkZXRlcm1pbmUgaWYgd2UndmUgYWxyZWFkeQoJCS8vIGhhbmRsZWQgdGhlIGtleWRvd24gZXZlbnQuICM3MjY5CgkJLy8gVW5mb3J0dW5hdGVseSB0aGUgY29kZSBmb3IgJiBpbiBrZXlwcmVzcyBpcyB0aGUgc2FtZSBhcyB0aGUgdXAgYXJyb3csCgkJLy8gc28gd2UgdXNlIHRoZSBzdXBwcmVzc0tleVByZXNzUmVwZWF0IGZsYWcgdG8gYXZvaWQgaGFuZGxpbmcga2V5cHJlc3MKCQkvLyBldmVudHMgd2hlbiB3ZSBrbm93IHRoZSBrZXlkb3duIGV2ZW50IHdhcyB1c2VkIHRvIG1vZGlmeSB0aGUKCQkvLyBzZWFyY2ggdGVybS4gIzc3OTkKCQl2YXIgc3VwcHJlc3NLZXlQcmVzcywgc3VwcHJlc3NLZXlQcmVzc1JlcGVhdCwgc3VwcHJlc3NJbnB1dCwKCQkJbm9kZU5hbWUgPSB0aGlzLmVsZW1lbnRbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQlpc1RleHRhcmVhID0gbm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIsCgkJCWlzSW5wdXQgPSBub2RlTmFtZSA9PT0gImlucHV0IjsKCgkJLy8gVGV4dGFyZWFzIGFyZSBhbHdheXMgbXVsdGktbGluZQoJCS8vIElucHV0cyBhcmUgYWx3YXlzIHNpbmdsZS1saW5lLCBldmVuIGlmIGluc2lkZSBhIGNvbnRlbnRFZGl0YWJsZSBlbGVtZW50CgkJLy8gSUUgYWxzbyB0cmVhdHMgaW5wdXRzIGFzIGNvbnRlbnRFZGl0YWJsZQoJCS8vIEFsbCBvdGhlciBlbGVtZW50IHR5cGVzIGFyZSBkZXRlcm1pbmVkIGJ5IHdoZXRoZXIgb3Igbm90IHRoZXkncmUgY29udGVudEVkaXRhYmxlCgkJdGhpcy5pc011bHRpTGluZSA9IGlzVGV4dGFyZWEgfHwgIWlzSW5wdXQgJiYgdGhpcy5faXNDb250ZW50RWRpdGFibGUoIHRoaXMuZWxlbWVudCApOwoKCQl0aGlzLnZhbHVlTWV0aG9kID0gdGhpcy5lbGVtZW50WyBpc1RleHRhcmVhIHx8IGlzSW5wdXQgPyAidmFsIiA6ICJ0ZXh0IiBdOwoJCXRoaXMuaXNOZXdNZW51ID0gdHJ1ZTsKCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1hdXRvY29tcGxldGUtaW5wdXQiICk7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LCB7CgkJCWtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdGhpcy5lbGVtZW50LnByb3AoICJyZWFkT25seSIgKSApIHsKCQkJCQlzdXBwcmVzc0tleVByZXNzID0gdHJ1ZTsKCQkJCQlzdXBwcmVzc0lucHV0ID0gdHJ1ZTsKCQkJCQlzdXBwcmVzc0tleVByZXNzUmVwZWF0ID0gdHJ1ZTsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJc3VwcHJlc3NLZXlQcmVzcyA9IGZhbHNlOwoJCQkJc3VwcHJlc3NJbnB1dCA9IGZhbHNlOwoJCQkJc3VwcHJlc3NLZXlQcmVzc1JlcGVhdCA9IGZhbHNlOwoJCQkJdmFyIGtleUNvZGUgPSAkLnVpLmtleUNvZGU7CgkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJY2FzZSBrZXlDb2RlLlBBR0VfVVA6CgkJCQkJc3VwcHJlc3NLZXlQcmVzcyA9IHRydWU7CgkJCQkJdGhpcy5fbW92ZSggInByZXZpb3VzUGFnZSIsIGV2ZW50ICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIGtleUNvZGUuUEFHRV9ET1dOOgoJCQkJCXN1cHByZXNzS2V5UHJlc3MgPSB0cnVlOwoJCQkJCXRoaXMuX21vdmUoICJuZXh0UGFnZSIsIGV2ZW50ICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIGtleUNvZGUuVVA6CgkJCQkJc3VwcHJlc3NLZXlQcmVzcyA9IHRydWU7CgkJCQkJdGhpcy5fa2V5RXZlbnQoICJwcmV2aW91cyIsIGV2ZW50ICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIGtleUNvZGUuRE9XTjoKCQkJCQlzdXBwcmVzc0tleVByZXNzID0gdHJ1ZTsKCQkJCQl0aGlzLl9rZXlFdmVudCggIm5leHQiLCBldmVudCApOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSBrZXlDb2RlLkVOVEVSOgoKCQkJCQkvLyB3aGVuIG1lbnUgaXMgb3BlbiBhbmQgaGFzIGZvY3VzCgkJCQkJaWYgKCB0aGlzLm1lbnUuYWN0aXZlICkgewoKCQkJCQkJLy8gIzYwNTUgLSBPcGVyYSBzdGlsbCBhbGxvd3MgdGhlIGtleXByZXNzIHRvIG9jY3VyCgkJCQkJCS8vIHdoaWNoIGNhdXNlcyBmb3JtcyB0byBzdWJtaXQKCQkJCQkJc3VwcHJlc3NLZXlQcmVzcyA9IHRydWU7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCXRoaXMubWVudS5zZWxlY3QoIGV2ZW50ICk7CgkJCQkJfQoJCQkJCWJyZWFrOwoJCQkJY2FzZSBrZXlDb2RlLlRBQjoKCQkJCQlpZiAoIHRoaXMubWVudS5hY3RpdmUgKSB7CgkJCQkJCXRoaXMubWVudS5zZWxlY3QoIGV2ZW50ICk7CgkJCQkJfQoJCQkJCWJyZWFrOwoJCQkJY2FzZSBrZXlDb2RlLkVTQ0FQRToKCQkJCQlpZiAoIHRoaXMubWVudS5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7CgkJCQkJCWlmICggIXRoaXMuaXNNdWx0aUxpbmUgKSB7CgkJCQkJCQl0aGlzLl92YWx1ZSggdGhpcy50ZXJtICk7CgkJCQkJCX0KCQkJCQkJdGhpcy5jbG9zZSggZXZlbnQgKTsKCgkJCQkJCS8vIERpZmZlcmVudCBicm93c2VycyBoYXZlIGRpZmZlcmVudCBkZWZhdWx0IGJlaGF2aW9yIGZvciBlc2NhcGUKCQkJCQkJLy8gU2luZ2xlIHByZXNzIGNhbiBtZWFuIHVuZG8gb3IgY2xlYXIKCQkJCQkJLy8gRG91YmxlIHByZXNzIGluIElFIG1lYW5zIGNsZWFyIHRoZSB3aG9sZSBmb3JtCgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJCWJyZWFrOwoJCQkJZGVmYXVsdDoKCQkJCQlzdXBwcmVzc0tleVByZXNzUmVwZWF0ID0gdHJ1ZTsKCgkJCQkJLy8gc2VhcmNoIHRpbWVvdXQgc2hvdWxkIGJlIHRyaWdnZXJlZCBiZWZvcmUgdGhlIGlucHV0IHZhbHVlIGlzIGNoYW5nZWQKCQkJCQl0aGlzLl9zZWFyY2hUaW1lb3V0KCBldmVudCApOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9LAoJCQlrZXlwcmVzczogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBzdXBwcmVzc0tleVByZXNzICkgewoJCQkJCXN1cHByZXNzS2V5UHJlc3MgPSBmYWxzZTsKCQkJCQlpZiAoICF0aGlzLmlzTXVsdGlMaW5lIHx8IHRoaXMubWVudS5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICggc3VwcHJlc3NLZXlQcmVzc1JlcGVhdCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gUmVwbGljYXRlIHNvbWUga2V5IGhhbmRsZXJzIHRvIGFsbG93IHRoZW0gdG8gcmVwZWF0IGluIEZpcmVmb3ggYW5kIE9wZXJhCgkJCQl2YXIga2V5Q29kZSA9ICQudWkua2V5Q29kZTsKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQljYXNlIGtleUNvZGUuUEFHRV9VUDoKCQkJCQl0aGlzLl9tb3ZlKCAicHJldmlvdXNQYWdlIiwgZXZlbnQgKTsKCQkJCQlicmVhazsKCQkJCWNhc2Uga2V5Q29kZS5QQUdFX0RPV046CgkJCQkJdGhpcy5fbW92ZSggIm5leHRQYWdlIiwgZXZlbnQgKTsKCQkJCQlicmVhazsKCQkJCWNhc2Uga2V5Q29kZS5VUDoKCQkJCQl0aGlzLl9rZXlFdmVudCggInByZXZpb3VzIiwgZXZlbnQgKTsKCQkJCQlicmVhazsKCQkJCWNhc2Uga2V5Q29kZS5ET1dOOgoJCQkJCXRoaXMuX2tleUV2ZW50KCAibmV4dCIsIGV2ZW50ICk7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0sCgkJCWlucHV0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIHN1cHByZXNzSW5wdXQgKSB7CgkJCQkJc3VwcHJlc3NJbnB1dCA9IGZhbHNlOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJdGhpcy5fc2VhcmNoVGltZW91dCggZXZlbnQgKTsKCQkJfSwKCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5zZWxlY3RlZEl0ZW0gPSBudWxsOwoJCQkJdGhpcy5wcmV2aW91cyA9IHRoaXMuX3ZhbHVlKCk7CgkJCX0sCgkJCWJsdXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdGhpcy5jYW5jZWxCbHVyICkgewoJCQkJCWRlbGV0ZSB0aGlzLmNhbmNlbEJsdXI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGhpcy5zZWFyY2hpbmcgKTsKCQkJCXRoaXMuY2xvc2UoIGV2ZW50ICk7CgkJCQl0aGlzLl9jaGFuZ2UoIGV2ZW50ICk7CgkJCX0KCQl9ICk7CgoJCXRoaXMuX2luaXRTb3VyY2UoKTsKCQl0aGlzLm1lbnUgPSAkKCAiPHVsPiIgKQoJCQkuYXBwZW5kVG8oIHRoaXMuX2FwcGVuZFRvKCkgKQoJCQkubWVudSggewoKCQkJCS8vIGRpc2FibGUgQVJJQSBzdXBwb3J0LCB0aGUgbGl2ZSByZWdpb24gdGFrZXMgY2FyZSBvZiB0aGF0CgkJCQlyb2xlOiBudWxsCgkJCX0gKQoJCQkuaGlkZSgpCgkJCS5tZW51KCAiaW5zdGFuY2UiICk7CgoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLm1lbnUuZWxlbWVudCwgInVpLWF1dG9jb21wbGV0ZSIsICJ1aS1mcm9udCIgKTsKCQl0aGlzLl9vbiggdGhpcy5tZW51LmVsZW1lbnQsIHsKCQkJbW91c2Vkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJLy8gcHJldmVudCBtb3ZpbmcgZm9jdXMgb3V0IG9mIHRoZSB0ZXh0IGZpZWxkCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCS8vIElFIGRvZXNuJ3QgcHJldmVudCBtb3ZpbmcgZm9jdXMgZXZlbiB3aXRoIGV2ZW50LnByZXZlbnREZWZhdWx0KCkKCQkJCS8vIHNvIHdlIHNldCBhIGZsYWcgdG8ga25vdyB3aGVuIHdlIHNob3VsZCBpZ25vcmUgdGhlIGJsdXIgZXZlbnQKCQkJCXRoaXMuY2FuY2VsQmx1ciA9IHRydWU7CgkJCQl0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQkJZGVsZXRlIHRoaXMuY2FuY2VsQmx1cjsKCgkJCQkJLy8gU3VwcG9ydDogSUUgOCBvbmx5CgkJCQkJLy8gUmlnaHQgY2xpY2tpbmcgYSBtZW51IGl0ZW0gb3Igc2VsZWN0aW5nIHRleHQgZnJvbSB0aGUgbWVudSBpdGVtcyB3aWxsCgkJCQkJLy8gcmVzdWx0IGluIGZvY3VzIG1vdmluZyBvdXQgb2YgdGhlIGlucHV0LiBIb3dldmVyLCB3ZSd2ZSBhbHJlYWR5IHJlY2VpdmVkCgkJCQkJLy8gYW5kIGlnbm9yZWQgdGhlIGJsdXIgZXZlbnQgYmVjYXVzZSBvZiB0aGUgY2FuY2VsQmx1ciBmbGFnIHNldCBhYm92ZS4gU28KCQkJCQkvLyB3ZSByZXN0b3JlIGZvY3VzIHRvIGVuc3VyZSB0aGF0IHRoZSBtZW51IGNsb3NlcyBwcm9wZXJseSBiYXNlZCBvbiB0aGUgdXNlcidzCgkJCQkJLy8gbmV4dCBhY3Rpb25zLgoJCQkJCWlmICggdGhpcy5lbGVtZW50WyAwIF0gIT09ICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApICkgewoJCQkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImZvY3VzIiApOwoJCQkJCX0KCQkJCX0gKTsKCQkJfSwKCQkJbWVudWZvY3VzOiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCQkJdmFyIGxhYmVsLCBpdGVtOwoKCQkJCS8vIHN1cHBvcnQ6IEZpcmVmb3gKCQkJCS8vIFByZXZlbnQgYWNjaWRlbnRhbCBhY3RpdmF0aW9uIG9mIG1lbnUgaXRlbXMgaW4gRmlyZWZveCAoIzcwMjQgIzkxMTgpCgkJCQlpZiAoIHRoaXMuaXNOZXdNZW51ICkgewoJCQkJCXRoaXMuaXNOZXdNZW51ID0gZmFsc2U7CgkJCQkJaWYgKCBldmVudC5vcmlnaW5hbEV2ZW50ICYmIC9ebW91c2UvLnRlc3QoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudHlwZSApICkgewoJCQkJCQl0aGlzLm1lbnUuYmx1cigpOwoKCQkJCQkJdGhpcy5kb2N1bWVudC5vbmUoICJtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCQkJCSQoIGV2ZW50LnRhcmdldCApLnRyaWdnZXIoIGV2ZW50Lm9yaWdpbmFsRXZlbnQgKTsKCQkJCQkJfSApOwoKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCgkJCQlpdGVtID0gdWkuaXRlbS5kYXRhKCAidWktYXV0b2NvbXBsZXRlLWl0ZW0iICk7CgkJCQlpZiAoIGZhbHNlICE9PSB0aGlzLl90cmlnZ2VyKCAiZm9jdXMiLCBldmVudCwgeyBpdGVtOiBpdGVtIH0gKSApIHsKCgkJCQkJLy8gdXNlIHZhbHVlIHRvIG1hdGNoIHdoYXQgd2lsbCBlbmQgdXAgaW4gdGhlIGlucHV0LCBpZiBpdCB3YXMgYSBrZXkgZXZlbnQKCQkJCQlpZiAoIGV2ZW50Lm9yaWdpbmFsRXZlbnQgJiYgL15rZXkvLnRlc3QoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudHlwZSApICkgewoJCQkJCQl0aGlzLl92YWx1ZSggaXRlbS52YWx1ZSApOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBBbm5vdW5jZSB0aGUgdmFsdWUgaW4gdGhlIGxpdmVSZWdpb24KCQkJCWxhYmVsID0gdWkuaXRlbS5hdHRyKCAiYXJpYS1sYWJlbCIgKSB8fCBpdGVtLnZhbHVlOwoJCQkJaWYgKCBsYWJlbCAmJiAkLnRyaW0oIGxhYmVsICkubGVuZ3RoICkgewoJCQkJCXRoaXMubGl2ZVJlZ2lvbi5jaGlsZHJlbigpLmhpZGUoKTsKCQkJCQkkKCAiPGRpdj4iICkudGV4dCggbGFiZWwgKS5hcHBlbmRUbyggdGhpcy5saXZlUmVnaW9uICk7CgkJCQl9CgkJCX0sCgkJCW1lbnVzZWxlY3Q6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCQl2YXIgaXRlbSA9IHVpLml0ZW0uZGF0YSggInVpLWF1dG9jb21wbGV0ZS1pdGVtIiApLAoJCQkJCXByZXZpb3VzID0gdGhpcy5wcmV2aW91czsKCgkJCQkvLyBPbmx5IHRyaWdnZXIgd2hlbiBmb2N1cyB3YXMgbG9zdCAoY2xpY2sgb24gbWVudSkKCQkJCWlmICggdGhpcy5lbGVtZW50WyAwIF0gIT09ICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApICkgewoJCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiZm9jdXMiICk7CgkJCQkJdGhpcy5wcmV2aW91cyA9IHByZXZpb3VzOwoKCQkJCQkvLyAjNjEwOSAtIElFIHRyaWdnZXJzIHR3byBmb2N1cyBldmVudHMgYW5kIHRoZSBzZWNvbmQKCQkJCQkvLyBpcyBhc3luY2hyb25vdXMsIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHByZXZpb3VzCgkJCQkJLy8gdGVybSBzeW5jaHJvbm91c2x5IGFuZCBhc3luY2hyb25vdXNseSA6LSgKCQkJCQl0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQkJCXRoaXMucHJldmlvdXMgPSBwcmV2aW91czsKCQkJCQkJdGhpcy5zZWxlY3RlZEl0ZW0gPSBpdGVtOwoJCQkJCX0gKTsKCQkJCX0KCgkJCQlpZiAoIGZhbHNlICE9PSB0aGlzLl90cmlnZ2VyKCAic2VsZWN0IiwgZXZlbnQsIHsgaXRlbTogaXRlbSB9ICkgKSB7CgkJCQkJdGhpcy5fdmFsdWUoIGl0ZW0udmFsdWUgKTsKCQkJCX0KCgkJCQkvLyByZXNldCB0aGUgdGVybSBhZnRlciB0aGUgc2VsZWN0IGV2ZW50CgkJCQkvLyB0aGlzIGFsbG93cyBjdXN0b20gc2VsZWN0IGhhbmRsaW5nIHRvIHdvcmsgcHJvcGVybHkKCQkJCXRoaXMudGVybSA9IHRoaXMuX3ZhbHVlKCk7CgoJCQkJdGhpcy5jbG9zZSggZXZlbnQgKTsKCQkJCXRoaXMuc2VsZWN0ZWRJdGVtID0gaXRlbTsKCQkJfQoJCX0gKTsKCgkJdGhpcy5saXZlUmVnaW9uID0gJCggIjxkaXY+IiwgewoJCQlyb2xlOiAic3RhdHVzIiwKCQkJImFyaWEtbGl2ZSI6ICJhc3NlcnRpdmUiLAoJCQkiYXJpYS1yZWxldmFudCI6ICJhZGRpdGlvbnMiCgkJfSApCgkJCS5hcHBlbmRUbyggdGhpcy5kb2N1bWVudFsgMCBdLmJvZHkgKTsKCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMubGl2ZVJlZ2lvbiwgbnVsbCwgInVpLWhlbHBlci1oaWRkZW4tYWNjZXNzaWJsZSIgKTsKCgkJLy8gVHVybmluZyBvZmYgYXV0b2NvbXBsZXRlIHByZXZlbnRzIHRoZSBicm93c2VyIGZyb20gcmVtZW1iZXJpbmcgdGhlCgkJLy8gdmFsdWUgd2hlbiBuYXZpZ2F0aW5nIHRocm91Z2ggaGlzdG9yeSwgc28gd2UgcmUtZW5hYmxlIGF1dG9jb21wbGV0ZQoJCS8vIGlmIHRoZSBwYWdlIGlzIHVubG9hZGVkIGJlZm9yZSB0aGUgd2lkZ2V0IGlzIGRlc3Ryb3llZC4gIzc3OTAKCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsKCQkJYmVmb3JldW5sb2FkOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVBdHRyKCAiYXV0b2NvbXBsZXRlIiApOwoJCQl9CgkJfSApOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLnNlYXJjaGluZyApOwoJCXRoaXMuZWxlbWVudC5yZW1vdmVBdHRyKCAiYXV0b2NvbXBsZXRlIiApOwoJCXRoaXMubWVudS5lbGVtZW50LnJlbW92ZSgpOwoJCXRoaXMubGl2ZVJlZ2lvbi5yZW1vdmUoKTsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCQlpZiAoIGtleSA9PT0gInNvdXJjZSIgKSB7CgkJCXRoaXMuX2luaXRTb3VyY2UoKTsKCQl9CgkJaWYgKCBrZXkgPT09ICJhcHBlbmRUbyIgKSB7CgkJCXRoaXMubWVudS5lbGVtZW50LmFwcGVuZFRvKCB0aGlzLl9hcHBlbmRUbygpICk7CgkJfQoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICYmIHZhbHVlICYmIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCX0sCgoJX2lzRXZlbnRUYXJnZXRJbldpZGdldDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBtZW51RWxlbWVudCA9IHRoaXMubWVudS5lbGVtZW50WyAwIF07CgoJCXJldHVybiBldmVudC50YXJnZXQgPT09IHRoaXMuZWxlbWVudFsgMCBdIHx8CgkJCWV2ZW50LnRhcmdldCA9PT0gbWVudUVsZW1lbnQgfHwKCQkJJC5jb250YWlucyggbWVudUVsZW1lbnQsIGV2ZW50LnRhcmdldCApOwoJfSwKCglfY2xvc2VPbkNsaWNrT3V0c2lkZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggIXRoaXMuX2lzRXZlbnRUYXJnZXRJbldpZGdldCggZXZlbnQgKSApIHsKCQkJdGhpcy5jbG9zZSgpOwoJCX0KCX0sCgoJX2FwcGVuZFRvOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbWVudCA9IHRoaXMub3B0aW9ucy5hcHBlbmRUbzsKCgkJaWYgKCBlbGVtZW50ICkgewoJCQllbGVtZW50ID0gZWxlbWVudC5qcXVlcnkgfHwgZWxlbWVudC5ub2RlVHlwZSA/CgkJCQkkKCBlbGVtZW50ICkgOgoJCQkJdGhpcy5kb2N1bWVudC5maW5kKCBlbGVtZW50ICkuZXEoIDAgKTsKCQl9CgoJCWlmICggIWVsZW1lbnQgfHwgIWVsZW1lbnRbIDAgXSApIHsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLWZyb250LCBkaWFsb2ciICk7CgkJfQoKCQlpZiAoICFlbGVtZW50Lmxlbmd0aCApIHsKCQkJZWxlbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5ib2R5OwoJCX0KCgkJcmV0dXJuIGVsZW1lbnQ7Cgl9LAoKCV9pbml0U291cmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgYXJyYXksIHVybCwKCQkJdGhhdCA9IHRoaXM7CgkJaWYgKCAkLmlzQXJyYXkoIHRoaXMub3B0aW9ucy5zb3VyY2UgKSApIHsKCQkJYXJyYXkgPSB0aGlzLm9wdGlvbnMuc291cmNlOwoJCQl0aGlzLnNvdXJjZSA9IGZ1bmN0aW9uKCByZXF1ZXN0LCByZXNwb25zZSApIHsKCQkJCXJlc3BvbnNlKCAkLnVpLmF1dG9jb21wbGV0ZS5maWx0ZXIoIGFycmF5LCByZXF1ZXN0LnRlcm0gKSApOwoJCQl9OwoJCX0gZWxzZSBpZiAoIHR5cGVvZiB0aGlzLm9wdGlvbnMuc291cmNlID09PSAic3RyaW5nIiApIHsKCQkJdXJsID0gdGhpcy5vcHRpb25zLnNvdXJjZTsKCQkJdGhpcy5zb3VyY2UgPSBmdW5jdGlvbiggcmVxdWVzdCwgcmVzcG9uc2UgKSB7CgkJCQlpZiAoIHRoYXQueGhyICkgewoJCQkJCXRoYXQueGhyLmFib3J0KCk7CgkJCQl9CgkJCQl0aGF0LnhociA9ICQuYWpheCggewoJCQkJCXVybDogdXJsLAoJCQkJCWRhdGE6IHJlcXVlc3QsCgkJCQkJZGF0YVR5cGU6ICJqc29uIiwKCQkJCQlzdWNjZXNzOiBmdW5jdGlvbiggZGF0YSApIHsKCQkJCQkJcmVzcG9uc2UoIGRhdGEgKTsKCQkJCQl9LAoJCQkJCWVycm9yOiBmdW5jdGlvbigpIHsKCQkJCQkJcmVzcG9uc2UoIFtdICk7CgkJCQkJfQoJCQkJfSApOwoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuc291cmNlID0gdGhpcy5vcHRpb25zLnNvdXJjZTsKCQl9Cgl9LAoKCV9zZWFyY2hUaW1lb3V0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLnNlYXJjaGluZyApOwoJCXRoaXMuc2VhcmNoaW5nID0gdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgewoKCQkJLy8gU2VhcmNoIGlmIHRoZSB2YWx1ZSBoYXMgY2hhbmdlZCwgb3IgaWYgdGhlIHVzZXIgcmV0eXBlcyB0aGUgc2FtZSB2YWx1ZSAoc2VlICM3NDM0KQoJCQl2YXIgZXF1YWxWYWx1ZXMgPSB0aGlzLnRlcm0gPT09IHRoaXMuX3ZhbHVlKCksCgkJCQltZW51VmlzaWJsZSA9IHRoaXMubWVudS5lbGVtZW50LmlzKCAiOnZpc2libGUiICksCgkJCQltb2RpZmllcktleSA9IGV2ZW50LmFsdEtleSB8fCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgfHwgZXZlbnQuc2hpZnRLZXk7CgoJCQlpZiAoICFlcXVhbFZhbHVlcyB8fCAoIGVxdWFsVmFsdWVzICYmICFtZW51VmlzaWJsZSAmJiAhbW9kaWZpZXJLZXkgKSApIHsKCQkJCXRoaXMuc2VsZWN0ZWRJdGVtID0gbnVsbDsKCQkJCXRoaXMuc2VhcmNoKCBudWxsLCBldmVudCApOwoJCQl9CgkJfSwgdGhpcy5vcHRpb25zLmRlbGF5ICk7Cgl9LAoKCXNlYXJjaDogZnVuY3Rpb24oIHZhbHVlLCBldmVudCApIHsKCQl2YWx1ZSA9IHZhbHVlICE9IG51bGwgPyB2YWx1ZSA6IHRoaXMuX3ZhbHVlKCk7CgoJCS8vIEFsd2F5cyBzYXZlIHRoZSBhY3R1YWwgdmFsdWUsIG5vdCB0aGUgb25lIHBhc3NlZCBhcyBhbiBhcmd1bWVudAoJCXRoaXMudGVybSA9IHRoaXMuX3ZhbHVlKCk7CgoJCWlmICggdmFsdWUubGVuZ3RoIDwgdGhpcy5vcHRpb25zLm1pbkxlbmd0aCApIHsKCQkJcmV0dXJuIHRoaXMuY2xvc2UoIGV2ZW50ICk7CgkJfQoKCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJzZWFyY2giLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3NlYXJjaCggdmFsdWUgKTsKCX0sCgoJX3NlYXJjaDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMucGVuZGluZysrOwoJCXRoaXMuX2FkZENsYXNzKCAidWktYXV0b2NvbXBsZXRlLWxvYWRpbmciICk7CgkJdGhpcy5jYW5jZWxTZWFyY2ggPSBmYWxzZTsKCgkJdGhpcy5zb3VyY2UoIHsgdGVybTogdmFsdWUgfSwgdGhpcy5fcmVzcG9uc2UoKSApOwoJfSwKCglfcmVzcG9uc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBpbmRleCA9ICsrdGhpcy5yZXF1ZXN0SW5kZXg7CgoJCXJldHVybiAkLnByb3h5KCBmdW5jdGlvbiggY29udGVudCApIHsKCQkJaWYgKCBpbmRleCA9PT0gdGhpcy5yZXF1ZXN0SW5kZXggKSB7CgkJCQl0aGlzLl9fcmVzcG9uc2UoIGNvbnRlbnQgKTsKCQkJfQoKCQkJdGhpcy5wZW5kaW5nLS07CgkJCWlmICggIXRoaXMucGVuZGluZyApIHsKCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCAidWktYXV0b2NvbXBsZXRlLWxvYWRpbmciICk7CgkJCX0KCQl9LCB0aGlzICk7Cgl9LAoKCV9fcmVzcG9uc2U6IGZ1bmN0aW9uKCBjb250ZW50ICkgewoJCWlmICggY29udGVudCApIHsKCQkJY29udGVudCA9IHRoaXMuX25vcm1hbGl6ZSggY29udGVudCApOwoJCX0KCQl0aGlzLl90cmlnZ2VyKCAicmVzcG9uc2UiLCBudWxsLCB7IGNvbnRlbnQ6IGNvbnRlbnQgfSApOwoJCWlmICggIXRoaXMub3B0aW9ucy5kaXNhYmxlZCAmJiBjb250ZW50ICYmIGNvbnRlbnQubGVuZ3RoICYmICF0aGlzLmNhbmNlbFNlYXJjaCApIHsKCQkJdGhpcy5fc3VnZ2VzdCggY29udGVudCApOwoJCQl0aGlzLl90cmlnZ2VyKCAib3BlbiIgKTsKCQl9IGVsc2UgewoKCQkJLy8gdXNlIC5fY2xvc2UoKSBpbnN0ZWFkIG9mIC5jbG9zZSgpIHNvIHdlIGRvbid0IGNhbmNlbCBmdXR1cmUgc2VhcmNoZXMKCQkJdGhpcy5fY2xvc2UoKTsKCQl9Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5jYW5jZWxTZWFyY2ggPSB0cnVlOwoJCXRoaXMuX2Nsb3NlKCBldmVudCApOwoJfSwKCglfY2xvc2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJLy8gUmVtb3ZlIHRoZSBoYW5kbGVyIHRoYXQgY2xvc2VzIHRoZSBtZW51IG9uIG91dHNpZGUgY2xpY2tzCgkJdGhpcy5fb2ZmKCB0aGlzLmRvY3VtZW50LCAibW91c2Vkb3duIiApOwoKCQlpZiAoIHRoaXMubWVudS5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7CgkJCXRoaXMubWVudS5lbGVtZW50LmhpZGUoKTsKCQkJdGhpcy5tZW51LmJsdXIoKTsKCQkJdGhpcy5pc05ld01lbnUgPSB0cnVlOwoJCQl0aGlzLl90cmlnZ2VyKCAiY2xvc2UiLCBldmVudCApOwoJCX0KCX0sCgoJX2NoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5wcmV2aW91cyAhPT0gdGhpcy5fdmFsdWUoKSApIHsKCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIsIGV2ZW50LCB7IGl0ZW06IHRoaXMuc2VsZWN0ZWRJdGVtIH0gKTsKCQl9Cgl9LAoKCV9ub3JtYWxpemU6IGZ1bmN0aW9uKCBpdGVtcyApIHsKCgkJLy8gYXNzdW1lIGFsbCBpdGVtcyBoYXZlIHRoZSByaWdodCBmb3JtYXQgd2hlbiB0aGUgZmlyc3QgaXRlbSBpcyBjb21wbGV0ZQoJCWlmICggaXRlbXMubGVuZ3RoICYmIGl0ZW1zWyAwIF0ubGFiZWwgJiYgaXRlbXNbIDAgXS52YWx1ZSApIHsKCQkJcmV0dXJuIGl0ZW1zOwoJCX0KCQlyZXR1cm4gJC5tYXAoIGl0ZW1zLCBmdW5jdGlvbiggaXRlbSApIHsKCQkJaWYgKCB0eXBlb2YgaXRlbSA9PT0gInN0cmluZyIgKSB7CgkJCQlyZXR1cm4gewoJCQkJCWxhYmVsOiBpdGVtLAoJCQkJCXZhbHVlOiBpdGVtCgkJCQl9OwoJCQl9CgkJCXJldHVybiAkLmV4dGVuZCgge30sIGl0ZW0sIHsKCQkJCWxhYmVsOiBpdGVtLmxhYmVsIHx8IGl0ZW0udmFsdWUsCgkJCQl2YWx1ZTogaXRlbS52YWx1ZSB8fCBpdGVtLmxhYmVsCgkJCX0gKTsKCQl9ICk7Cgl9LAoKCV9zdWdnZXN0OiBmdW5jdGlvbiggaXRlbXMgKSB7CgkJdmFyIHVsID0gdGhpcy5tZW51LmVsZW1lbnQuZW1wdHkoKTsKCQl0aGlzLl9yZW5kZXJNZW51KCB1bCwgaXRlbXMgKTsKCQl0aGlzLmlzTmV3TWVudSA9IHRydWU7CgkJdGhpcy5tZW51LnJlZnJlc2goKTsKCgkJLy8gU2l6ZSBhbmQgcG9zaXRpb24gbWVudQoJCXVsLnNob3coKTsKCQl0aGlzLl9yZXNpemVNZW51KCk7CgkJdWwucG9zaXRpb24oICQuZXh0ZW5kKCB7CgkJCW9mOiB0aGlzLmVsZW1lbnQKCQl9LCB0aGlzLm9wdGlvbnMucG9zaXRpb24gKSApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvRm9jdXMgKSB7CgkJCXRoaXMubWVudS5uZXh0KCk7CgkJfQoKCQkvLyBMaXN0ZW4gZm9yIGludGVyYWN0aW9ucyBvdXRzaWRlIG9mIHRoZSB3aWRnZXQgKCM2NjQyKQoJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCW1vdXNlZG93bjogIl9jbG9zZU9uQ2xpY2tPdXRzaWRlIgoJCX0gKTsKCX0sCgoJX3Jlc2l6ZU1lbnU6IGZ1bmN0aW9uKCkgewoJCXZhciB1bCA9IHRoaXMubWVudS5lbGVtZW50OwoJCXVsLm91dGVyV2lkdGgoIE1hdGgubWF4KAoKCQkJLy8gRmlyZWZveCB3cmFwcyBsb25nIHRleHQgKHBvc3NpYmx5IGEgcm91bmRpbmcgYnVnKQoJCQkvLyBzbyB3ZSBhZGQgMXB4IHRvIGF2b2lkIHRoZSB3cmFwcGluZyAoIzc1MTMpCgkJCXVsLndpZHRoKCAiIiApLm91dGVyV2lkdGgoKSArIDEsCgkJCXRoaXMuZWxlbWVudC5vdXRlcldpZHRoKCkKCQkpICk7Cgl9LAoKCV9yZW5kZXJNZW51OiBmdW5jdGlvbiggdWwsIGl0ZW1zICkgewoJCXZhciB0aGF0ID0gdGhpczsKCQkkLmVhY2goIGl0ZW1zLCBmdW5jdGlvbiggaW5kZXgsIGl0ZW0gKSB7CgkJCXRoYXQuX3JlbmRlckl0ZW1EYXRhKCB1bCwgaXRlbSApOwoJCX0gKTsKCX0sCgoJX3JlbmRlckl0ZW1EYXRhOiBmdW5jdGlvbiggdWwsIGl0ZW0gKSB7CgkJcmV0dXJuIHRoaXMuX3JlbmRlckl0ZW0oIHVsLCBpdGVtICkuZGF0YSggInVpLWF1dG9jb21wbGV0ZS1pdGVtIiwgaXRlbSApOwoJfSwKCglfcmVuZGVySXRlbTogZnVuY3Rpb24oIHVsLCBpdGVtICkgewoJCXJldHVybiAkKCAiPGxpPiIgKQoJCQkuYXBwZW5kKCAkKCAiPGRpdj4iICkudGV4dCggaXRlbS5sYWJlbCApICkKCQkJLmFwcGVuZFRvKCB1bCApOwoJfSwKCglfbW92ZTogZnVuY3Rpb24oIGRpcmVjdGlvbiwgZXZlbnQgKSB7CgkJaWYgKCAhdGhpcy5tZW51LmVsZW1lbnQuaXMoICI6dmlzaWJsZSIgKSApIHsKCQkJdGhpcy5zZWFyY2goIG51bGwsIGV2ZW50ICk7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLm1lbnUuaXNGaXJzdEl0ZW0oKSAmJiAvXnByZXZpb3VzLy50ZXN0KCBkaXJlY3Rpb24gKSB8fAoJCQkJdGhpcy5tZW51LmlzTGFzdEl0ZW0oKSAmJiAvXm5leHQvLnRlc3QoIGRpcmVjdGlvbiApICkgewoKCQkJaWYgKCAhdGhpcy5pc011bHRpTGluZSApIHsKCQkJCXRoaXMuX3ZhbHVlKCB0aGlzLnRlcm0gKTsKCQkJfQoKCQkJdGhpcy5tZW51LmJsdXIoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLm1lbnVbIGRpcmVjdGlvbiBdKCBldmVudCApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm1lbnUuZWxlbWVudDsKCX0sCgoJX3ZhbHVlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy52YWx1ZU1ldGhvZC5hcHBseSggdGhpcy5lbGVtZW50LCBhcmd1bWVudHMgKTsKCX0sCgoJX2tleUV2ZW50OiBmdW5jdGlvbigga2V5RXZlbnQsIGV2ZW50ICkgewoJCWlmICggIXRoaXMuaXNNdWx0aUxpbmUgfHwgdGhpcy5tZW51LmVsZW1lbnQuaXMoICI6dmlzaWJsZSIgKSApIHsKCQkJdGhpcy5fbW92ZSgga2V5RXZlbnQsIGV2ZW50ICk7CgoJCQkvLyBQcmV2ZW50cyBtb3ZpbmcgY3Vyc29yIHRvIGJlZ2lubmluZy9lbmQgb2YgdGhlIHRleHQgZmllbGQgaW4gc29tZSBicm93c2VycwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0sCgoJLy8gU3VwcG9ydDogQ2hyb21lIDw9NTAKCS8vIFdlIHNob3VsZCBiZSBhYmxlIHRvIGp1c3QgdXNlIHRoaXMuZWxlbWVudC5wcm9wKCAiaXNDb250ZW50RWRpdGFibGUiICkKCS8vIGJ1dCBoaWRkZW4gZWxlbWVudHMgYWx3YXlzIHJlcG9ydCBmYWxzZSBpbiBDaHJvbWUuCgkvLyBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MzEzMDgyCglfaXNDb250ZW50RWRpdGFibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCWlmICggIWVsZW1lbnQubGVuZ3RoICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQl2YXIgZWRpdGFibGUgPSBlbGVtZW50LnByb3AoICJjb250ZW50RWRpdGFibGUiICk7CgoJCWlmICggZWRpdGFibGUgPT09ICJpbmhlcml0IiApIHsKCQkgIHJldHVybiB0aGlzLl9pc0NvbnRlbnRFZGl0YWJsZSggZWxlbWVudC5wYXJlbnQoKSApOwoJCX0KCgkJcmV0dXJuIGVkaXRhYmxlID09PSAidHJ1ZSI7Cgl9Cn0gKTsKCiQuZXh0ZW5kKCAkLnVpLmF1dG9jb21wbGV0ZSwgewoJZXNjYXBlUmVnZXg6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gdmFsdWUucmVwbGFjZSggL1tcLVxbXF17fSgpKis/LixcXFxeJHwjXHNdL2csICJcXCQmIiApOwoJfSwKCWZpbHRlcjogZnVuY3Rpb24oIGFycmF5LCB0ZXJtICkgewoJCXZhciBtYXRjaGVyID0gbmV3IFJlZ0V4cCggJC51aS5hdXRvY29tcGxldGUuZXNjYXBlUmVnZXgoIHRlcm0gKSwgImkiICk7CgkJcmV0dXJuICQuZ3JlcCggYXJyYXksIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJcmV0dXJuIG1hdGNoZXIudGVzdCggdmFsdWUubGFiZWwgfHwgdmFsdWUudmFsdWUgfHwgdmFsdWUgKTsKCQl9ICk7Cgl9Cn0gKTsKCi8vIExpdmUgcmVnaW9uIGV4dGVuc2lvbiwgYWRkaW5nIGEgYG1lc3NhZ2VzYCBvcHRpb24KLy8gTk9URTogVGhpcyBpcyBhbiBleHBlcmltZW50YWwgQVBJLiBXZSBhcmUgc3RpbGwgaW52ZXN0aWdhdGluZwovLyBhIGZ1bGwgc29sdXRpb24gZm9yIHN0cmluZyBtYW5pcHVsYXRpb24gYW5kIGludGVybmF0aW9uYWxpemF0aW9uLgokLndpZGdldCggInVpLmF1dG9jb21wbGV0ZSIsICQudWkuYXV0b2NvbXBsZXRlLCB7CglvcHRpb25zOiB7CgkJbWVzc2FnZXM6IHsKCQkJbm9SZXN1bHRzOiAiTm8gc2VhcmNoIHJlc3VsdHMuIiwKCQkJcmVzdWx0czogZnVuY3Rpb24oIGFtb3VudCApIHsKCQkJCXJldHVybiBhbW91bnQgKyAoIGFtb3VudCA+IDEgPyAiIHJlc3VsdHMgYXJlIiA6ICIgcmVzdWx0IGlzIiApICsKCQkJCQkiIGF2YWlsYWJsZSwgdXNlIHVwIGFuZCBkb3duIGFycm93IGtleXMgdG8gbmF2aWdhdGUuIjsKCQkJfQoJCX0KCX0sCgoJX19yZXNwb25zZTogZnVuY3Rpb24oIGNvbnRlbnQgKSB7CgkJdmFyIG1lc3NhZ2U7CgkJdGhpcy5fc3VwZXJBcHBseSggYXJndW1lbnRzICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5jYW5jZWxTZWFyY2ggKSB7CgkJCXJldHVybjsKCQl9CgkJaWYgKCBjb250ZW50ICYmIGNvbnRlbnQubGVuZ3RoICkgewoJCQltZXNzYWdlID0gdGhpcy5vcHRpb25zLm1lc3NhZ2VzLnJlc3VsdHMoIGNvbnRlbnQubGVuZ3RoICk7CgkJfSBlbHNlIHsKCQkJbWVzc2FnZSA9IHRoaXMub3B0aW9ucy5tZXNzYWdlcy5ub1Jlc3VsdHM7CgkJfQoJCXRoaXMubGl2ZVJlZ2lvbi5jaGlsZHJlbigpLmhpZGUoKTsKCQkkKCAiPGRpdj4iICkudGV4dCggbWVzc2FnZSApLmFwcGVuZFRvKCB0aGlzLmxpdmVSZWdpb24gKTsKCX0KfSApOwoKdmFyIHdpZGdldHNBdXRvY29tcGxldGUgPSAkLnVpLmF1dG9jb21wbGV0ZTsKCgovKiEKICogalF1ZXJ5IFVJIENvbnRyb2xncm91cCAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IENvbnRyb2xncm91cAovLz4+Z3JvdXA6IFdpZGdldHMKLy8+PmRlc2NyaXB0aW9uOiBWaXN1YWxseSBncm91cHMgZm9ybSBjb250cm9sIHdpZGdldHMKLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2NvbnRyb2xncm91cC8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2NvbnRyb2xncm91cC8KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb250cm9sZ3JvdXAuY3NzCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcwoKCnZhciBjb250cm9sZ3JvdXBDb3JuZXJSZWdleCA9IC91aS1jb3JuZXItKFthLXpdKXsyLDZ9L2c7Cgp2YXIgd2lkZ2V0c0NvbnRyb2xncm91cCA9ICQud2lkZ2V0KCAidWkuY29udHJvbGdyb3VwIiwgewoJdmVyc2lvbjogIjEuMTIuMSIsCglkZWZhdWx0RWxlbWVudDogIjxkaXY+IiwKCW9wdGlvbnM6IHsKCQlkaXJlY3Rpb246ICJob3Jpem9udGFsIiwKCQlkaXNhYmxlZDogbnVsbCwKCQlvbmx5VmlzaWJsZTogdHJ1ZSwKCQlpdGVtczogewoJCQkiYnV0dG9uIjogImlucHV0W3R5cGU9YnV0dG9uXSwgaW5wdXRbdHlwZT1zdWJtaXRdLCBpbnB1dFt0eXBlPXJlc2V0XSwgYnV0dG9uLCBhIiwKCQkJImNvbnRyb2xncm91cExhYmVsIjogIi51aS1jb250cm9sZ3JvdXAtbGFiZWwiLAoJCQkiY2hlY2tib3hyYWRpbyI6ICJpbnB1dFt0eXBlPSdjaGVja2JveCddLCBpbnB1dFt0eXBlPSdyYWRpbyddIiwKCQkJInNlbGVjdG1lbnUiOiAic2VsZWN0IiwKCQkJInNwaW5uZXIiOiAiLnVpLXNwaW5uZXItaW5wdXQiCgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9lbmhhbmNlKCk7Cgl9LAoKCS8vIFRvIHN1cHBvcnQgdGhlIGVuaGFuY2VkIG9wdGlvbiBpbiBqUXVlcnkgTW9iaWxlLCB3ZSBpc29sYXRlIERPTSBtYW5pcHVsYXRpb24KCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCAidG9vbGJhciIgKTsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2NhbGxDaGlsZE1ldGhvZCggImRlc3Ryb3kiICk7CgkJdGhpcy5jaGlsZFdpZGdldHMucmVtb3ZlRGF0YSggInVpLWNvbnRyb2xncm91cC1kYXRhIiApOwoJCXRoaXMuZWxlbWVudC5yZW1vdmVBdHRyKCAicm9sZSIgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5pdGVtcy5jb250cm9sZ3JvdXBMYWJlbCApIHsKCQkJdGhpcy5lbGVtZW50CgkJCQkuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zLmNvbnRyb2xncm91cExhYmVsICkKCQkJCS5maW5kKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbC1jb250ZW50cyIgKQoJCQkJLmNvbnRlbnRzKCkudW53cmFwKCk7CgkJfQoJfSwKCglfaW5pdFdpZGdldHM6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJY2hpbGRXaWRnZXRzID0gW107CgoJCS8vIEZpcnN0IHdlIGl0ZXJhdGUgb3ZlciBlYWNoIG9mIHRoZSBpdGVtcyBvcHRpb25zCgkJJC5lYWNoKCB0aGlzLm9wdGlvbnMuaXRlbXMsIGZ1bmN0aW9uKCB3aWRnZXQsIHNlbGVjdG9yICkgewoJCQl2YXIgbGFiZWxzOwoJCQl2YXIgb3B0aW9ucyA9IHt9OwoKCQkJLy8gTWFrZSBzdXJlIHRoZSB3aWRnZXQgaGFzIGEgc2VsZWN0b3Igc2V0CgkJCWlmICggIXNlbGVjdG9yICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHdpZGdldCA9PT0gImNvbnRyb2xncm91cExhYmVsIiApIHsKCQkJCWxhYmVscyA9IHRoYXQuZWxlbWVudC5maW5kKCBzZWxlY3RvciApOwoJCQkJbGFiZWxzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbGVtZW50ID0gJCggdGhpcyApOwoKCQkJCQlpZiAoIGVsZW1lbnQuY2hpbGRyZW4oICIudWktY29udHJvbGdyb3VwLWxhYmVsLWNvbnRlbnRzIiApLmxlbmd0aCApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCQllbGVtZW50LmNvbnRlbnRzKCkKCQkJCQkJLndyYXBBbGwoICI8c3BhbiBjbGFzcz0ndWktY29udHJvbGdyb3VwLWxhYmVsLWNvbnRlbnRzJz48L3NwYW4+IiApOwoJCQkJfSApOwoJCQkJdGhhdC5fYWRkQ2xhc3MoIGxhYmVscywgbnVsbCwgInVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1zdGF0ZS1kZWZhdWx0IiApOwoJCQkJY2hpbGRXaWRnZXRzID0gY2hpbGRXaWRnZXRzLmNvbmNhdCggbGFiZWxzLmdldCgpICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgd2lkZ2V0IGFjdHVhbGx5IGV4aXN0cwoJCQlpZiAoICEkLmZuWyB3aWRnZXQgXSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gV2UgYXNzdW1lIGV2ZXJ5dGhpbmcgaXMgaW4gdGhlIG1pZGRsZSB0byBzdGFydCBiZWNhdXNlIHdlIGNhbid0IGRldGVybWluZQoJCQkvLyBmaXJzdCAvIGxhc3QgZWxlbWVudHMgdW50aWwgYWxsIGVuaGFuY21lbnRzIGFyZSBkb25lLgoJCQlpZiAoIHRoYXRbICJfIiArIHdpZGdldCArICJPcHRpb25zIiBdICkgewoJCQkJb3B0aW9ucyA9IHRoYXRbICJfIiArIHdpZGdldCArICJPcHRpb25zIiBdKCAibWlkZGxlIiApOwoJCQl9IGVsc2UgewoJCQkJb3B0aW9ucyA9IHsgY2xhc3Nlczoge30gfTsKCQkJfQoKCQkJLy8gRmluZCBpbnN0YW5jZXMgb2YgdGhpcyB3aWRnZXQgaW5zaWRlIGNvbnRyb2xncm91cCBhbmQgaW5pdCB0aGVtCgkJCXRoYXQuZWxlbWVudAoJCQkJLmZpbmQoIHNlbGVjdG9yICkKCQkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgZWxlbWVudCA9ICQoIHRoaXMgKTsKCQkJCQl2YXIgaW5zdGFuY2UgPSBlbGVtZW50WyB3aWRnZXQgXSggImluc3RhbmNlIiApOwoKCQkJCQkvLyBXZSBuZWVkIHRvIGNsb25lIHRoZSBkZWZhdWx0IG9wdGlvbnMgZm9yIHRoaXMgdHlwZSBvZiB3aWRnZXQgdG8gYXZvaWQKCQkJCQkvLyBwb2xsdXRpbmcgdGhlIHZhcmlhYmxlIG9wdGlvbnMgd2hpY2ggaGFzIGEgd2lkZXIgc2NvcGUgdGhhbiBhIHNpbmdsZSB3aWRnZXQuCgkJCQkJdmFyIGluc3RhbmNlT3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sIG9wdGlvbnMgKTsKCgkJCQkJLy8gSWYgdGhlIGJ1dHRvbiBpcyB0aGUgY2hpbGQgb2YgYSBzcGlubmVyIGlnbm9yZSBpdAoJCQkJCS8vIFRPRE86IEZpbmQgYSBtb3JlIGdlbmVyaWMgc29sdXRpb24KCQkJCQlpZiAoIHdpZGdldCA9PT0gImJ1dHRvbiIgJiYgZWxlbWVudC5wYXJlbnQoICIudWktc3Bpbm5lciIgKS5sZW5ndGggKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCS8vIENyZWF0ZSB0aGUgd2lkZ2V0IGlmIGl0IGRvZXNuJ3QgZXhpc3QKCQkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQkJaW5zdGFuY2UgPSBlbGVtZW50WyB3aWRnZXQgXSgpWyB3aWRnZXQgXSggImluc3RhbmNlIiApOwoJCQkJCX0KCQkJCQlpZiAoIGluc3RhbmNlICkgewoJCQkJCQlpbnN0YW5jZU9wdGlvbnMuY2xhc3NlcyA9CgkJCQkJCQl0aGF0Ll9yZXNvbHZlQ2xhc3Nlc1ZhbHVlcyggaW5zdGFuY2VPcHRpb25zLmNsYXNzZXMsIGluc3RhbmNlICk7CgkJCQkJfQoJCQkJCWVsZW1lbnRbIHdpZGdldCBdKCBpbnN0YW5jZU9wdGlvbnMgKTsKCgkJCQkJLy8gU3RvcmUgYW4gaW5zdGFuY2Ugb2YgdGhlIGNvbnRyb2xncm91cCB0byBiZSBhYmxlIHRvIHJlZmVyZW5jZQoJCQkJCS8vIGZyb20gdGhlIG91dGVybW9zdCBlbGVtZW50IGZvciBjaGFuZ2luZyBvcHRpb25zIGFuZCByZWZyZXNoCgkJCQkJdmFyIHdpZGdldEVsZW1lbnQgPSBlbGVtZW50WyB3aWRnZXQgXSggIndpZGdldCIgKTsKCQkJCQkkLmRhdGEoIHdpZGdldEVsZW1lbnRbIDAgXSwgInVpLWNvbnRyb2xncm91cC1kYXRhIiwKCQkJCQkJaW5zdGFuY2UgPyBpbnN0YW5jZSA6IGVsZW1lbnRbIHdpZGdldCBdKCAiaW5zdGFuY2UiICkgKTsKCgkJCQkJY2hpbGRXaWRnZXRzLnB1c2goIHdpZGdldEVsZW1lbnRbIDAgXSApOwoJCQkJfSApOwoJCX0gKTsKCgkJdGhpcy5jaGlsZFdpZGdldHMgPSAkKCAkLnVuaXF1ZSggY2hpbGRXaWRnZXRzICkgKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5jaGlsZFdpZGdldHMsICJ1aS1jb250cm9sZ3JvdXAtaXRlbSIgKTsKCX0sCgoJX2NhbGxDaGlsZE1ldGhvZDogZnVuY3Rpb24oIG1ldGhvZCApIHsKCQl0aGlzLmNoaWxkV2lkZ2V0cy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICksCgkJCQlkYXRhID0gZWxlbWVudC5kYXRhKCAidWktY29udHJvbGdyb3VwLWRhdGEiICk7CgkJCWlmICggZGF0YSAmJiBkYXRhWyBtZXRob2QgXSApIHsKCQkJCWRhdGFbIG1ldGhvZCBdKCk7CgkJCX0KCQl9ICk7Cgl9LAoKCV91cGRhdGVDb3JuZXJDbGFzczogZnVuY3Rpb24oIGVsZW1lbnQsIHBvc2l0aW9uICkgewoJCXZhciByZW1vdmUgPSAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIHVpLWNvcm5lci1sZWZ0IHVpLWNvcm5lci1yaWdodCB1aS1jb3JuZXItYWxsIjsKCQl2YXIgYWRkID0gdGhpcy5fYnVpbGRTaW1wbGVPcHRpb25zKCBwb3NpdGlvbiwgImxhYmVsIiApLmNsYXNzZXMubGFiZWw7CgoJCXRoaXMuX3JlbW92ZUNsYXNzKCBlbGVtZW50LCBudWxsLCByZW1vdmUgKTsKCQl0aGlzLl9hZGRDbGFzcyggZWxlbWVudCwgbnVsbCwgYWRkICk7Cgl9LAoKCV9idWlsZFNpbXBsZU9wdGlvbnM6IGZ1bmN0aW9uKCBwb3NpdGlvbiwga2V5ICkgewoJCXZhciBkaXJlY3Rpb24gPSB0aGlzLm9wdGlvbnMuZGlyZWN0aW9uID09PSAidmVydGljYWwiOwoJCXZhciByZXN1bHQgPSB7CgkJCWNsYXNzZXM6IHt9CgkJfTsKCQlyZXN1bHQuY2xhc3Nlc1sga2V5IF0gPSB7CgkJCSJtaWRkbGUiOiAiIiwKCQkJImZpcnN0IjogInVpLWNvcm5lci0iICsgKCBkaXJlY3Rpb24gPyAidG9wIiA6ICJsZWZ0IiApLAoJCQkibGFzdCI6ICJ1aS1jb3JuZXItIiArICggZGlyZWN0aW9uID8gImJvdHRvbSIgOiAicmlnaHQiICksCgkJCSJvbmx5IjogInVpLWNvcm5lci1hbGwiCgkJfVsgcG9zaXRpb24gXTsKCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJX3NwaW5uZXJPcHRpb25zOiBmdW5jdGlvbiggcG9zaXRpb24gKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLl9idWlsZFNpbXBsZU9wdGlvbnMoIHBvc2l0aW9uLCAidWktc3Bpbm5lciIgKTsKCgkJb3B0aW9ucy5jbGFzc2VzWyAidWktc3Bpbm5lci11cCIgXSA9ICIiOwoJCW9wdGlvbnMuY2xhc3Nlc1sgInVpLXNwaW5uZXItZG93biIgXSA9ICIiOwoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJX2J1dHRvbk9wdGlvbnM6IGZ1bmN0aW9uKCBwb3NpdGlvbiApIHsKCQlyZXR1cm4gdGhpcy5fYnVpbGRTaW1wbGVPcHRpb25zKCBwb3NpdGlvbiwgInVpLWJ1dHRvbiIgKTsKCX0sCgoJX2NoZWNrYm94cmFkaW9PcHRpb25zOiBmdW5jdGlvbiggcG9zaXRpb24gKSB7CgkJcmV0dXJuIHRoaXMuX2J1aWxkU2ltcGxlT3B0aW9ucyggcG9zaXRpb24sICJ1aS1jaGVja2JveHJhZGlvLWxhYmVsIiApOwoJfSwKCglfc2VsZWN0bWVudU9wdGlvbnM6IGZ1bmN0aW9uKCBwb3NpdGlvbiApIHsKCQl2YXIgZGlyZWN0aW9uID0gdGhpcy5vcHRpb25zLmRpcmVjdGlvbiA9PT0gInZlcnRpY2FsIjsKCQlyZXR1cm4gewoJCQl3aWR0aDogZGlyZWN0aW9uID8gImF1dG8iIDogZmFsc2UsCgkJCWNsYXNzZXM6IHsKCQkJCW1pZGRsZTogewoJCQkJCSJ1aS1zZWxlY3RtZW51LWJ1dHRvbi1vcGVuIjogIiIsCgkJCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLWNsb3NlZCI6ICIiCgkJCQl9LAoJCQkJZmlyc3Q6IHsKCQkJCQkidWktc2VsZWN0bWVudS1idXR0b24tb3BlbiI6ICJ1aS1jb3JuZXItIiArICggZGlyZWN0aW9uID8gInRvcCIgOiAidGwiICksCgkJCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLWNsb3NlZCI6ICJ1aS1jb3JuZXItIiArICggZGlyZWN0aW9uID8gInRvcCIgOiAibGVmdCIgKQoJCQkJfSwKCQkJCWxhc3Q6IHsKCQkJCQkidWktc2VsZWN0bWVudS1idXR0b24tb3BlbiI6IGRpcmVjdGlvbiA/ICIiIDogInVpLWNvcm5lci10ciIsCgkJCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLWNsb3NlZCI6ICJ1aS1jb3JuZXItIiArICggZGlyZWN0aW9uID8gImJvdHRvbSIgOiAicmlnaHQiICkKCQkJCX0sCgkJCQlvbmx5OiB7CgkJCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLW9wZW4iOiAidWktY29ybmVyLXRvcCIsCgkJCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLWNsb3NlZCI6ICJ1aS1jb3JuZXItYWxsIgoJCQkJfQoKCQkJfVsgcG9zaXRpb24gXQoJCX07Cgl9LAoKCV9yZXNvbHZlQ2xhc3Nlc1ZhbHVlczogZnVuY3Rpb24oIGNsYXNzZXMsIGluc3RhbmNlICkgewoJCXZhciByZXN1bHQgPSB7fTsKCQkkLmVhY2goIGNsYXNzZXMsIGZ1bmN0aW9uKCBrZXkgKSB7CgkJCXZhciBjdXJyZW50ID0gaW5zdGFuY2Uub3B0aW9ucy5jbGFzc2VzWyBrZXkgXSB8fCAiIjsKCQkJY3VycmVudCA9ICQudHJpbSggY3VycmVudC5yZXBsYWNlKCBjb250cm9sZ3JvdXBDb3JuZXJSZWdleCwgIiIgKSApOwoJCQlyZXN1bHRbIGtleSBdID0gKCBjdXJyZW50ICsgIiAiICsgY2xhc3Nlc1sga2V5IF0gKS5yZXBsYWNlKCAvXHMrL2csICIgIiApOwoJCX0gKTsKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImRpcmVjdGlvbiIgKSB7CgkJCXRoaXMuX3JlbW92ZUNsYXNzKCAidWktY29udHJvbGdyb3VwLSIgKyB0aGlzLm9wdGlvbnMuZGlyZWN0aW9uICk7CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLl9jYWxsQ2hpbGRNZXRob2QoIHZhbHVlID8gImRpc2FibGUiIDogImVuYWJsZSIgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBjaGlsZHJlbiwKCQkJdGhhdCA9IHRoaXM7CgoJCXRoaXMuX2FkZENsYXNzKCAidWktY29udHJvbGdyb3VwIHVpLWNvbnRyb2xncm91cC0iICsgdGhpcy5vcHRpb25zLmRpcmVjdGlvbiApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXJlY3Rpb24gPT09ICJob3Jpem9udGFsIiApIHsKCQkJdGhpcy5fYWRkQ2xhc3MoIG51bGwsICJ1aS1oZWxwZXItY2xlYXJmaXgiICk7CgkJfQoJCXRoaXMuX2luaXRXaWRnZXRzKCk7CgoJCWNoaWxkcmVuID0gdGhpcy5jaGlsZFdpZGdldHM7CgoJCS8vIFdlIGZpbHRlciBoZXJlIGJlY2F1c2Ugd2UgbmVlZCB0byB0cmFjayBhbGwgY2hpbGRXaWRnZXRzIG5vdCBqdXN0IHRoZSB2aXNpYmxlIG9uZXMKCQlpZiAoIHRoaXMub3B0aW9ucy5vbmx5VmlzaWJsZSApIHsKCQkJY2hpbGRyZW4gPSBjaGlsZHJlbi5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCQl9CgoJCWlmICggY2hpbGRyZW4ubGVuZ3RoICkgewoKCQkJLy8gV2UgZG8gdGhpcyBsYXN0IGJlY2F1c2Ugd2UgbmVlZCB0byBtYWtlIHN1cmUgYWxsIGVuaGFuY21lbnQgaXMgZG9uZQoJCQkvLyBiZWZvcmUgZGV0ZXJtaW5pbmcgZmlyc3QgYW5kIGxhc3QKCQkJJC5lYWNoKCBbICJmaXJzdCIsICJsYXN0IiBdLCBmdW5jdGlvbiggaW5kZXgsIHZhbHVlICkgewoJCQkJdmFyIGluc3RhbmNlID0gY2hpbGRyZW5bIHZhbHVlIF0oKS5kYXRhKCAidWktY29udHJvbGdyb3VwLWRhdGEiICk7CgoJCQkJaWYgKCBpbnN0YW5jZSAmJiB0aGF0WyAiXyIgKyBpbnN0YW5jZS53aWRnZXROYW1lICsgIk9wdGlvbnMiIF0gKSB7CgkJCQkJdmFyIG9wdGlvbnMgPSB0aGF0WyAiXyIgKyBpbnN0YW5jZS53aWRnZXROYW1lICsgIk9wdGlvbnMiIF0oCgkJCQkJCWNoaWxkcmVuLmxlbmd0aCA9PT0gMSA/ICJvbmx5IiA6IHZhbHVlCgkJCQkJKTsKCQkJCQlvcHRpb25zLmNsYXNzZXMgPSB0aGF0Ll9yZXNvbHZlQ2xhc3Nlc1ZhbHVlcyggb3B0aW9ucy5jbGFzc2VzLCBpbnN0YW5jZSApOwoJCQkJCWluc3RhbmNlLmVsZW1lbnRbIGluc3RhbmNlLndpZGdldE5hbWUgXSggb3B0aW9ucyApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGF0Ll91cGRhdGVDb3JuZXJDbGFzcyggY2hpbGRyZW5bIHZhbHVlIF0oKSwgdmFsdWUgKTsKCQkJCX0KCQkJfSApOwoKCQkJLy8gRmluYWxseSBjYWxsIHRoZSByZWZyZXNoIG1ldGhvZCBvbiBlYWNoIG9mIHRoZSBjaGlsZCB3aWRnZXRzLgoJCQl0aGlzLl9jYWxsQ2hpbGRNZXRob2QoICJyZWZyZXNoIiApOwoJCX0KCX0KfSApOwoKLyohCiAqIGpRdWVyeSBVSSBDaGVja2JveHJhZGlvIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogQ2hlY2tib3hyYWRpbwovLz4+Z3JvdXA6IFdpZGdldHMKLy8+PmRlc2NyaXB0aW9uOiBFbmhhbmNlcyBhIGZvcm0gd2l0aCBtdWx0aXBsZSB0aGVtZWFibGUgY2hlY2tib3hlcyBvciByYWRpbyBidXR0b25zLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vY2hlY2tib3hyYWRpby8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2NoZWNrYm94cmFkaW8vCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvYnV0dG9uLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY2hlY2tib3hyYWRpby5jc3MKLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzCgoKCiQud2lkZ2V0KCAidWkuY2hlY2tib3hyYWRpbyIsIFsgJC51aS5mb3JtUmVzZXRNaXhpbiwgewoJdmVyc2lvbjogIjEuMTIuMSIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IG51bGwsCgkJbGFiZWw6IG51bGwsCgkJaWNvbjogdHJ1ZSwKCQljbGFzc2VzOiB7CgkJCSJ1aS1jaGVja2JveHJhZGlvLWxhYmVsIjogInVpLWNvcm5lci1hbGwiLAoJCQkidWktY2hlY2tib3hyYWRpby1pY29uIjogInVpLWNvcm5lci1hbGwiCgkJfQoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJdmFyIGRpc2FibGVkLCBsYWJlbHM7CgkJdmFyIHRoYXQgPSB0aGlzOwoJCXZhciBvcHRpb25zID0gdGhpcy5fc3VwZXIoKSB8fCB7fTsKCgkJLy8gV2UgcmVhZCB0aGUgdHlwZSBoZXJlLCBiZWNhdXNlIGl0IG1ha2VzIG1vcmUgc2Vuc2UgdG8gdGhyb3cgYSBlbGVtZW50IHR5cGUgZXJyb3IgZmlyc3QsCgkJLy8gcmF0aGVyIHRoZW4gdGhlIGVycm9yIGZvciBsYWNrIG9mIGEgbGFiZWwuIE9mdGVuIGlmIGl0cyB0aGUgd3JvbmcgdHlwZSwgaXQKCQkvLyB3b24ndCBoYXZlIGEgbGFiZWwgKGUuZy4gY2FsbGluZyBvbiBhIGRpdiwgYnRuLCBldGMpCgkJdGhpcy5fcmVhZFR5cGUoKTsKCgkJbGFiZWxzID0gdGhpcy5lbGVtZW50LmxhYmVscygpOwoKCQkvLyBJZiB0aGVyZSBhcmUgbXVsdGlwbGUgbGFiZWxzLCB1c2UgdGhlIGxhc3Qgb25lCgkJdGhpcy5sYWJlbCA9ICQoIGxhYmVsc1sgbGFiZWxzLmxlbmd0aCAtIDEgXSApOwoJCWlmICggIXRoaXMubGFiZWwubGVuZ3RoICkgewoJCQkkLmVycm9yKCAiTm8gbGFiZWwgZm91bmQgZm9yIGNoZWNrYm94cmFkaW8gd2lkZ2V0IiApOwoJCX0KCgkJdGhpcy5vcmlnaW5hbExhYmVsID0gIiI7CgoJCS8vIFdlIG5lZWQgdG8gZ2V0IHRoZSBsYWJlbCB0ZXh0IGJ1dCB0aGlzIG1heSBhbHNvIG5lZWQgdG8gbWFrZSBzdXJlIGl0IGRvZXMgbm90IGNvbnRhaW4gdGhlCgkJLy8gaW5wdXQgaXRzZWxmLgoJCXRoaXMubGFiZWwuY29udGVudHMoKS5ub3QoIHRoaXMuZWxlbWVudFsgMCBdICkuZWFjaCggZnVuY3Rpb24oKSB7CgoJCQkvLyBUaGUgbGFiZWwgY29udGVudHMgY291bGQgYmUgdGV4dCwgaHRtbCwgb3IgYSBtaXguIFdlIGNvbmNhdCBlYWNoIGVsZW1lbnQgdG8gZ2V0IGEKCQkJLy8gc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBsYWJlbCwgd2l0aG91dCB0aGUgaW5wdXQgYXMgcGFydCBvZiBpdC4KCQkJdGhhdC5vcmlnaW5hbExhYmVsICs9IHRoaXMubm9kZVR5cGUgPT09IDMgPyAkKCB0aGlzICkudGV4dCgpIDogdGhpcy5vdXRlckhUTUw7CgkJfSApOwoKCQkvLyBTZXQgdGhlIGxhYmVsIG9wdGlvbiBpZiB3ZSBmb3VuZCBsYWJlbCB0ZXh0CgkJaWYgKCB0aGlzLm9yaWdpbmFsTGFiZWwgKSB7CgkJCW9wdGlvbnMubGFiZWwgPSB0aGlzLm9yaWdpbmFsTGFiZWw7CgkJfQoKCQlkaXNhYmxlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgIT0gbnVsbCApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9IGRpc2FibGVkOwoJCX0KCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGNoZWNrZWQgPSB0aGlzLmVsZW1lbnRbIDAgXS5jaGVja2VkOwoKCQl0aGlzLl9iaW5kRm9ybVJlc2V0SGFuZGxlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA9PSBudWxsICkgewoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZDsKCQl9CgoJCXRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdGhpcy5vcHRpb25zLmRpc2FibGVkICk7CgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1jaGVja2JveHJhZGlvIiwgInVpLWhlbHBlci1oaWRkZW4tYWNjZXNzaWJsZSIgKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5sYWJlbCwgInVpLWNoZWNrYm94cmFkaW8tbGFiZWwiLCAidWktYnV0dG9uIHVpLXdpZGdldCIgKTsKCgkJaWYgKCB0aGlzLnR5cGUgPT09ICJyYWRpbyIgKSB7CgkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmxhYmVsLCAidWktY2hlY2tib3hyYWRpby1yYWRpby1sYWJlbCIgKTsKCQl9CgoJCWlmICggdGhpcy5vcHRpb25zLmxhYmVsICYmIHRoaXMub3B0aW9ucy5sYWJlbCAhPT0gdGhpcy5vcmlnaW5hbExhYmVsICkgewoJCQl0aGlzLl91cGRhdGVMYWJlbCgpOwoJCX0gZWxzZSBpZiAoIHRoaXMub3JpZ2luYWxMYWJlbCApIHsKCQkJdGhpcy5vcHRpb25zLmxhYmVsID0gdGhpcy5vcmlnaW5hbExhYmVsOwoJCX0KCgkJdGhpcy5fZW5oYW5jZSgpOwoKCQlpZiAoIGNoZWNrZWQgKSB7CgkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmxhYmVsLCAidWktY2hlY2tib3hyYWRpby1jaGVja2VkIiwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJaWYgKCB0aGlzLmljb24gKSB7CgkJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5pY29uLCBudWxsLCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0KCQl9CgoJCXRoaXMuX29uKCB7CgkJCWNoYW5nZTogIl90b2dnbGVDbGFzc2VzIiwKCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMubGFiZWwsIG51bGwsICJ1aS1zdGF0ZS1mb2N1cyB1aS12aXN1YWwtZm9jdXMiICk7CgkJCX0sCgkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMubGFiZWwsIG51bGwsICJ1aS1zdGF0ZS1mb2N1cyB1aS12aXN1YWwtZm9jdXMiICk7CgkJCX0KCQl9ICk7Cgl9LAoKCV9yZWFkVHlwZTogZnVuY3Rpb24oKSB7CgkJdmFyIG5vZGVOYW1lID0gdGhpcy5lbGVtZW50WyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQl0aGlzLnR5cGUgPSB0aGlzLmVsZW1lbnRbIDAgXS50eXBlOwoJCWlmICggbm9kZU5hbWUgIT09ICJpbnB1dCIgfHwgIS9yYWRpb3xjaGVja2JveC8udGVzdCggdGhpcy50eXBlICkgKSB7CgkJCSQuZXJyb3IoICJDYW4ndCBjcmVhdGUgY2hlY2tib3hyYWRpbyBvbiBlbGVtZW50Lm5vZGVOYW1lPSIgKyBub2RlTmFtZSArCgkJCQkiIGFuZCBlbGVtZW50LnR5cGU9IiArIHRoaXMudHlwZSApOwoJCX0KCX0sCgoJLy8gU3VwcG9ydCBqUXVlcnkgTW9iaWxlIGVuaGFuY2VkIG9wdGlvbgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VwZGF0ZUljb24oIHRoaXMuZWxlbWVudFsgMCBdLmNoZWNrZWQgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5sYWJlbDsKCX0sCgoJX2dldFJhZGlvR3JvdXA6IGZ1bmN0aW9uKCkgewoJCXZhciBncm91cDsKCQl2YXIgbmFtZSA9IHRoaXMuZWxlbWVudFsgMCBdLm5hbWU7CgkJdmFyIG5hbWVTZWxlY3RvciA9ICJpbnB1dFtuYW1lPSciICsgJC51aS5lc2NhcGVTZWxlY3RvciggbmFtZSApICsgIiddIjsKCgkJaWYgKCAhbmFtZSApIHsKCQkJcmV0dXJuICQoIFtdICk7CgkJfQoKCQlpZiAoIHRoaXMuZm9ybS5sZW5ndGggKSB7CgkJCWdyb3VwID0gJCggdGhpcy5mb3JtWyAwIF0uZWxlbWVudHMgKS5maWx0ZXIoIG5hbWVTZWxlY3RvciApOwoJCX0gZWxzZSB7CgoJCQkvLyBOb3QgaW5zaWRlIGEgZm9ybSwgY2hlY2sgYWxsIGlucHV0cyB0aGF0IGFsc28gYXJlIG5vdCBpbnNpZGUgYSBmb3JtCgkJCWdyb3VwID0gJCggbmFtZVNlbGVjdG9yICkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCB0aGlzICkuZm9ybSgpLmxlbmd0aCA9PT0gMDsKCQkJfSApOwoJCX0KCgkJcmV0dXJuIGdyb3VwLm5vdCggdGhpcy5lbGVtZW50ICk7Cgl9LAoKCV90b2dnbGVDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgY2hlY2tlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmNoZWNrZWQ7CgkJdGhpcy5fdG9nZ2xlQ2xhc3MoIHRoaXMubGFiZWwsICJ1aS1jaGVja2JveHJhZGlvLWNoZWNrZWQiLCAidWktc3RhdGUtYWN0aXZlIiwgY2hlY2tlZCApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5pY29uICYmIHRoaXMudHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJdGhpcy5fdG9nZ2xlQ2xhc3MoIHRoaXMuaWNvbiwgbnVsbCwgInVpLWljb24tY2hlY2sgdWktc3RhdGUtY2hlY2tlZCIsIGNoZWNrZWQgKQoJCQkJLl90b2dnbGVDbGFzcyggdGhpcy5pY29uLCBudWxsLCAidWktaWNvbi1ibGFuayIsICFjaGVja2VkICk7CgkJfQoKCQlpZiAoIHRoaXMudHlwZSA9PT0gInJhZGlvIiApIHsKCQkJdGhpcy5fZ2V0UmFkaW9Hcm91cCgpCgkJCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGluc3RhbmNlID0gJCggdGhpcyApLmNoZWNrYm94cmFkaW8oICJpbnN0YW5jZSIgKTsKCgkJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQkJaW5zdGFuY2UuX3JlbW92ZUNsYXNzKCBpbnN0YW5jZS5sYWJlbCwKCQkJCQkJCSJ1aS1jaGVja2JveHJhZGlvLWNoZWNrZWQiLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJCX0KCQkJCX0gKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl91bmJpbmRGb3JtUmVzZXRIYW5kbGVyKCk7CgoJCWlmICggdGhpcy5pY29uICkgewoJCQl0aGlzLmljb24ucmVtb3ZlKCk7CgkJCXRoaXMuaWNvblNwYWNlLnJlbW92ZSgpOwoJCX0KCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgoJCS8vIFdlIGRvbid0IGFsbG93IHRoZSB2YWx1ZSB0byBiZSBzZXQgdG8gbm90aGluZwoJCWlmICgga2V5ID09PSAibGFiZWwiICYmICF2YWx1ZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMuX3RvZ2dsZUNsYXNzKCB0aGlzLmxhYmVsLCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZCA9IHZhbHVlOwoKCQkJLy8gRG9uJ3QgcmVmcmVzaCB3aGVuIHNldHRpbmcgZGlzYWJsZWQKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX3VwZGF0ZUljb246IGZ1bmN0aW9uKCBjaGVja2VkICkgewoJCXZhciB0b0FkZCA9ICJ1aS1pY29uIHVpLWljb24tYmFja2dyb3VuZCAiOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5pY29uICkgewoJCQlpZiAoICF0aGlzLmljb24gKSB7CgkJCQl0aGlzLmljb24gPSAkKCAiPHNwYW4+IiApOwoJCQkJdGhpcy5pY29uU3BhY2UgPSAkKCAiPHNwYW4+IDwvc3Bhbj4iICk7CgkJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5pY29uU3BhY2UsICJ1aS1jaGVja2JveHJhZGlvLWljb24tc3BhY2UiICk7CgkJCX0KCgkJCWlmICggdGhpcy50eXBlID09PSAiY2hlY2tib3giICkgewoJCQkJdG9BZGQgKz0gY2hlY2tlZCA/ICJ1aS1pY29uLWNoZWNrIHVpLXN0YXRlLWNoZWNrZWQiIDogInVpLWljb24tYmxhbmsiOwoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuaWNvbiwgbnVsbCwgY2hlY2tlZCA/ICJ1aS1pY29uLWJsYW5rIiA6ICJ1aS1pY29uLWNoZWNrIiApOwoJCQl9IGVsc2UgewoJCQkJdG9BZGQgKz0gInVpLWljb24tYmxhbmsiOwoJCQl9CgkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmljb24sICJ1aS1jaGVja2JveHJhZGlvLWljb24iLCB0b0FkZCApOwoJCQlpZiAoICFjaGVja2VkICkgewoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuaWNvbiwgbnVsbCwgInVpLWljb24tY2hlY2sgdWktc3RhdGUtY2hlY2tlZCIgKTsKCQkJfQoJCQl0aGlzLmljb24ucHJlcGVuZFRvKCB0aGlzLmxhYmVsICkuYWZ0ZXIoIHRoaXMuaWNvblNwYWNlICk7CgkJfSBlbHNlIGlmICggdGhpcy5pY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuaWNvbi5yZW1vdmUoKTsKCQkJdGhpcy5pY29uU3BhY2UucmVtb3ZlKCk7CgkJCWRlbGV0ZSB0aGlzLmljb247CgkJfQoJfSwKCglfdXBkYXRlTGFiZWw6IGZ1bmN0aW9uKCkgewoKCQkvLyBSZW1vdmUgdGhlIGNvbnRlbnRzIG9mIHRoZSBsYWJlbCAoIG1pbnVzIHRoZSBpY29uLCBpY29uIHNwYWNlLCBhbmQgaW5wdXQgKQoJCXZhciBjb250ZW50cyA9IHRoaXMubGFiZWwuY29udGVudHMoKS5ub3QoIHRoaXMuZWxlbWVudFsgMCBdICk7CgkJaWYgKCB0aGlzLmljb24gKSB7CgkJCWNvbnRlbnRzID0gY29udGVudHMubm90KCB0aGlzLmljb25bIDAgXSApOwoJCX0KCQlpZiAoIHRoaXMuaWNvblNwYWNlICkgewoJCQljb250ZW50cyA9IGNvbnRlbnRzLm5vdCggdGhpcy5pY29uU3BhY2VbIDAgXSApOwoJCX0KCQljb250ZW50cy5yZW1vdmUoKTsKCgkJdGhpcy5sYWJlbC5hcHBlbmQoIHRoaXMub3B0aW9ucy5sYWJlbCApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgY2hlY2tlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmNoZWNrZWQsCgkJCWlzRGlzYWJsZWQgPSB0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZDsKCgkJdGhpcy5fdXBkYXRlSWNvbiggY2hlY2tlZCApOwoJCXRoaXMuX3RvZ2dsZUNsYXNzKCB0aGlzLmxhYmVsLCAidWktY2hlY2tib3hyYWRpby1jaGVja2VkIiwgInVpLXN0YXRlLWFjdGl2ZSIsIGNoZWNrZWQgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5sYWJlbCAhPT0gbnVsbCApIHsKCQkJdGhpcy5fdXBkYXRlTGFiZWwoKTsKCQl9CgoJCWlmICggaXNEaXNhYmxlZCAhPT0gdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQl0aGlzLl9zZXRPcHRpb25zKCB7ICJkaXNhYmxlZCI6IGlzRGlzYWJsZWQgfSApOwoJCX0KCX0KCn0gXSApOwoKdmFyIHdpZGdldHNDaGVja2JveHJhZGlvID0gJC51aS5jaGVja2JveHJhZGlvOwoKCi8qIQogKiBqUXVlcnkgVUkgQnV0dG9uIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogQnV0dG9uCi8vPj5ncm91cDogV2lkZ2V0cwovLz4+ZGVzY3JpcHRpb246IEVuaGFuY2VzIGEgZm9ybSB3aXRoIHRoZW1lYWJsZSBidXR0b25zLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vYnV0dG9uLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vYnV0dG9uLwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MKLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2J1dHRvbi5jc3MKLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzCgoKCiQud2lkZ2V0KCAidWkuYnV0dG9uIiwgewoJdmVyc2lvbjogIjEuMTIuMSIsCglkZWZhdWx0RWxlbWVudDogIjxidXR0b24+IiwKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCSJ1aS1idXR0b24iOiAidWktY29ybmVyLWFsbCIKCQl9LAoJCWRpc2FibGVkOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvblBvc2l0aW9uOiAiYmVnaW5uaW5nIiwKCQlsYWJlbDogbnVsbCwKCQlzaG93TGFiZWw6IHRydWUKCX0sCgoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBkaXNhYmxlZCwKCgkJCS8vIFRoaXMgaXMgdG8gc3VwcG9ydCBjYXNlcyBsaWtlIGluIGpRdWVyeSBNb2JpbGUgd2hlcmUgdGhlIGJhc2Ugd2lkZ2V0IGRvZXMgaGF2ZQoJCQkvLyBhbiBpbXBsZW1lbnRhdGlvbiBvZiBfZ2V0Q3JlYXRlT3B0aW9ucwoJCQlvcHRpb25zID0gdGhpcy5fc3VwZXIoKSB8fCB7fTsKCgkJdGhpcy5pc0lucHV0ID0gdGhpcy5lbGVtZW50LmlzKCAiaW5wdXQiICk7CgoJCWRpc2FibGVkID0gdGhpcy5lbGVtZW50WyAwIF0uZGlzYWJsZWQ7CgkJaWYgKCBkaXNhYmxlZCAhPSBudWxsICkgewoJCQlvcHRpb25zLmRpc2FibGVkID0gZGlzYWJsZWQ7CgkJfQoKCQl0aGlzLm9yaWdpbmFsTGFiZWwgPSB0aGlzLmlzSW5wdXQgPyB0aGlzLmVsZW1lbnQudmFsKCkgOiB0aGlzLmVsZW1lbnQuaHRtbCgpOwoJCWlmICggdGhpcy5vcmlnaW5hbExhYmVsICkgewoJCQlvcHRpb25zLmxhYmVsID0gdGhpcy5vcmlnaW5hbExhYmVsOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCWlmICggIXRoaXMub3B0aW9uLnNob3dMYWJlbCAmICF0aGlzLm9wdGlvbnMuaWNvbiApIHsKCQkJdGhpcy5vcHRpb25zLnNob3dMYWJlbCA9IHRydWU7CgkJfQoKCQkvLyBXZSBoYXZlIHRvIGNoZWNrIHRoZSBvcHRpb24gYWdhaW4gaGVyZSBldmVuIHRob3VnaCB3ZSBkaWQgaW4gX2dldENyZWF0ZU9wdGlvbnMsCgkJLy8gYmVjYXVzZSBudWxsIG1heSBoYXZlIGJlZW4gcGFzc2VkIG9uIGluaXQgd2hpY2ggd291bGQgb3ZlcnJpZGUgd2hhdCB3YXMgc2V0IGluCgkJLy8gX2dldENyZWF0ZU9wdGlvbnMKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA9PSBudWxsICkgewoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZCB8fCBmYWxzZTsKCQl9CgoJCXRoaXMuaGFzVGl0bGUgPSAhIXRoaXMuZWxlbWVudC5hdHRyKCAidGl0bGUiICk7CgoJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgbGFiZWwgbmVlZHMgdG8gYmUgc2V0IG9yIGlmIGl0cyBhbHJlYWR5IGNvcnJlY3QKCQlpZiAoIHRoaXMub3B0aW9ucy5sYWJlbCAmJiB0aGlzLm9wdGlvbnMubGFiZWwgIT09IHRoaXMub3JpZ2luYWxMYWJlbCApIHsKCQkJaWYgKCB0aGlzLmlzSW5wdXQgKSB7CgkJCQl0aGlzLmVsZW1lbnQudmFsKCB0aGlzLm9wdGlvbnMubGFiZWwgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZWxlbWVudC5odG1sKCB0aGlzLm9wdGlvbnMubGFiZWwgKTsKCQkJfQoJCX0KCQl0aGlzLl9hZGRDbGFzcyggInVpLWJ1dHRvbiIsICJ1aS13aWRnZXQiICk7CgkJdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKTsKCQl0aGlzLl9lbmhhbmNlKCk7CgoJCWlmICggdGhpcy5lbGVtZW50LmlzKCAiYSIgKSApIHsKCQkJdGhpcy5fb24oIHsKCQkJCSJrZXl1cCI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5TUEFDRSApIHsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJCS8vIFN1cHBvcnQ6IFBoYW50b21KUyA8PSAxLjksIElFIDggT25seQoJCQkJCQkvLyBJZiBhIG5hdGl2ZSBjbGljayBpcyBhdmFpbGFibGUgdXNlIGl0IHNvIHdlIGFjdHVhbGx5IGNhdXNlIG5hdmlnYXRpb24KCQkJCQkJLy8gb3RoZXJ3aXNlIGp1c3QgdHJpZ2dlciBhIGNsaWNrIGV2ZW50CgkJCQkJCWlmICggdGhpcy5lbGVtZW50WyAwIF0uY2xpY2sgKSB7CgkJCQkJCQl0aGlzLmVsZW1lbnRbIDAgXS5jbGljaygpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjbGljayIgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSApOwoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCWlmICggIXRoaXMuZWxlbWVudC5pcyggImJ1dHRvbiIgKSApIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJyb2xlIiwgImJ1dHRvbiIgKTsKCQl9CgoJCWlmICggdGhpcy5vcHRpb25zLmljb24gKSB7CgkJCXRoaXMuX3VwZGF0ZUljb24oICJpY29uIiwgdGhpcy5vcHRpb25zLmljb24gKTsKCQkJdGhpcy5fdXBkYXRlVG9vbHRpcCgpOwoJCX0KCX0sCgoJX3VwZGF0ZVRvb2x0aXA6IGZ1bmN0aW9uKCkgewoJCXRoaXMudGl0bGUgPSB0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiApOwoKCQlpZiAoICF0aGlzLm9wdGlvbnMuc2hvd0xhYmVsICYmICF0aGlzLnRpdGxlICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiwgdGhpcy5vcHRpb25zLmxhYmVsICk7CgkJfQoJfSwKCglfdXBkYXRlSWNvbjogZnVuY3Rpb24oIG9wdGlvbiwgdmFsdWUgKSB7CgkJdmFyIGljb24gPSBvcHRpb24gIT09ICJpY29uUG9zaXRpb24iLAoJCQlwb3NpdGlvbiA9IGljb24gPyB0aGlzLm9wdGlvbnMuaWNvblBvc2l0aW9uIDogdmFsdWUsCgkJCWRpc3BsYXlCbG9jayA9IHBvc2l0aW9uID09PSAidG9wIiB8fCBwb3NpdGlvbiA9PT0gImJvdHRvbSI7CgoJCS8vIENyZWF0ZSBpY29uCgkJaWYgKCAhdGhpcy5pY29uICkgewoJCQl0aGlzLmljb24gPSAkKCAiPHNwYW4+IiApOwoKCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaWNvbiwgInVpLWJ1dHRvbi1pY29uIiwgInVpLWljb24iICk7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMuc2hvd0xhYmVsICkgewoJCQkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1idXR0b24taWNvbi1vbmx5IiApOwoJCQl9CgkJfSBlbHNlIGlmICggaWNvbiApIHsKCgkJCS8vIElmIHdlIGFyZSB1cGRhdGluZyB0aGUgaWNvbiByZW1vdmUgdGhlIG9sZCBpY29uIGNsYXNzCgkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmljb24sIG51bGwsIHRoaXMub3B0aW9ucy5pY29uICk7CgkJfQoKCQkvLyBJZiB3ZSBhcmUgdXBkYXRpbmcgdGhlIGljb24gYWRkIHRoZSBuZXcgaWNvbiBjbGFzcwoJCWlmICggaWNvbiApIHsKCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaWNvbiwgbnVsbCwgdmFsdWUgKTsKCQl9CgoJCXRoaXMuX2F0dGFjaEljb24oIHBvc2l0aW9uICk7CgoJCS8vIElmIHRoZSBpY29uIGlzIG9uIHRvcCBvciBib3R0b20gd2UgbmVlZCB0byBhZGQgdGhlIHVpLXdpZGdldC1pY29uLWJsb2NrIGNsYXNzIGFuZCByZW1vdmUKCQkvLyB0aGUgaWNvblNwYWNlIGlmIHRoZXJlIGlzIG9uZS4KCQlpZiAoIGRpc3BsYXlCbG9jayApIHsKCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaWNvbiwgbnVsbCwgInVpLXdpZGdldC1pY29uLWJsb2NrIiApOwoJCQlpZiAoIHRoaXMuaWNvblNwYWNlICkgewoJCQkJdGhpcy5pY29uU3BhY2UucmVtb3ZlKCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJLy8gUG9zaXRpb24gaXMgYmVnaW5uaW5nIG9yIGVuZCBzbyByZW1vdmUgdGhlIHVpLXdpZGdldC1pY29uLWJsb2NrIGNsYXNzIGFuZCBhZGQgdGhlCgkJCS8vIHNwYWNlIGlmIGl0IGRvZXMgbm90IGV4aXN0CgkJCWlmICggIXRoaXMuaWNvblNwYWNlICkgewoJCQkJdGhpcy5pY29uU3BhY2UgPSAkKCAiPHNwYW4+IDwvc3Bhbj4iICk7CgkJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5pY29uU3BhY2UsICJ1aS1idXR0b24taWNvbi1zcGFjZSIgKTsKCQkJfQoJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5pY29uLCBudWxsLCAidWktd2lnZXQtaWNvbi1ibG9jayIgKTsKCQkJdGhpcy5fYXR0YWNoSWNvblNwYWNlKCBwb3NpdGlvbiApOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5yZW1vdmVBdHRyKCAicm9sZSIgKTsKCgkJaWYgKCB0aGlzLmljb24gKSB7CgkJCXRoaXMuaWNvbi5yZW1vdmUoKTsKCQl9CgkJaWYgKCB0aGlzLmljb25TcGFjZSApIHsKCQkJdGhpcy5pY29uU3BhY2UucmVtb3ZlKCk7CgkJfQoJCWlmICggIXRoaXMuaGFzVGl0bGUgKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVBdHRyKCAidGl0bGUiICk7CgkJfQoJfSwKCglfYXR0YWNoSWNvblNwYWNlOiBmdW5jdGlvbiggaWNvblBvc2l0aW9uICkgewoJCXRoaXMuaWNvblsgL14oPzplbmR8Ym90dG9tKS8udGVzdCggaWNvblBvc2l0aW9uICkgPyAiYmVmb3JlIiA6ICJhZnRlciIgXSggdGhpcy5pY29uU3BhY2UgKTsKCX0sCgoJX2F0dGFjaEljb246IGZ1bmN0aW9uKCBpY29uUG9zaXRpb24gKSB7CgkJdGhpcy5lbGVtZW50WyAvXig/OmVuZHxib3R0b20pLy50ZXN0KCBpY29uUG9zaXRpb24gKSA/ICJhcHBlbmQiIDogInByZXBlbmQiIF0oIHRoaXMuaWNvbiApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIG5ld1Nob3dMYWJlbCA9IG9wdGlvbnMuc2hvd0xhYmVsID09PSB1bmRlZmluZWQgPwoJCQkJdGhpcy5vcHRpb25zLnNob3dMYWJlbCA6CgkJCQlvcHRpb25zLnNob3dMYWJlbCwKCQkJbmV3SWNvbiA9IG9wdGlvbnMuaWNvbiA9PT0gdW5kZWZpbmVkID8gdGhpcy5vcHRpb25zLmljb24gOiBvcHRpb25zLmljb247CgoJCWlmICggIW5ld1Nob3dMYWJlbCAmJiAhbmV3SWNvbiApIHsKCQkJb3B0aW9ucy5zaG93TGFiZWwgPSB0cnVlOwoJCX0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImljb24iICkgewoJCQlpZiAoIHZhbHVlICkgewoJCQkJdGhpcy5fdXBkYXRlSWNvbigga2V5LCB2YWx1ZSApOwoJCQl9IGVsc2UgaWYgKCB0aGlzLmljb24gKSB7CgkJCQl0aGlzLmljb24ucmVtb3ZlKCk7CgkJCQlpZiAoIHRoaXMuaWNvblNwYWNlICkgewoJCQkJCXRoaXMuaWNvblNwYWNlLnJlbW92ZSgpOwoJCQkJfQoJCQl9CgkJfQoKCQlpZiAoIGtleSA9PT0gImljb25Qb3NpdGlvbiIgKSB7CgkJCXRoaXMuX3VwZGF0ZUljb24oIGtleSwgdmFsdWUgKTsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB3ZSBjYW4ndCBlbmQgdXAgd2l0aCBhIGJ1dHRvbiB0aGF0IGhhcyBuZWl0aGVyIHRleHQgbm9yIGljb24KCQlpZiAoIGtleSA9PT0gInNob3dMYWJlbCIgKSB7CgkJCQl0aGlzLl90b2dnbGVDbGFzcyggInVpLWJ1dHRvbi1pY29uLW9ubHkiLCBudWxsLCAhdmFsdWUgKTsKCQkJCXRoaXMuX3VwZGF0ZVRvb2x0aXAoKTsKCQl9CgoJCWlmICgga2V5ID09PSAibGFiZWwiICkgewoJCQlpZiAoIHRoaXMuaXNJbnB1dCApIHsKCQkJCXRoaXMuZWxlbWVudC52YWwoIHZhbHVlICk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gSWYgdGhlcmUgaXMgYW4gaWNvbiwgYXBwZW5kIGl0LCBlbHNlIG5vdGhpbmcgdGhlbiBhcHBlbmQgdGhlIHZhbHVlCgkJCQkvLyB0aGlzIGF2b2lkcyByZW1vdmFsIG9mIHRoZSBpY29uIHdoZW4gc2V0dGluZyBsYWJlbCB0ZXh0CgkJCQl0aGlzLmVsZW1lbnQuaHRtbCggdmFsdWUgKTsKCQkJCWlmICggdGhpcy5pY29uICkgewoJCQkJCXRoaXMuX2F0dGFjaEljb24oIHRoaXMub3B0aW9ucy5pY29uUG9zaXRpb24gKTsKCQkJCQl0aGlzLl9hdHRhY2hJY29uU3BhY2UoIHRoaXMub3B0aW9ucy5pY29uUG9zaXRpb24gKTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMuX3RvZ2dsZUNsYXNzKCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZCA9IHZhbHVlOwoJCQlpZiAoIHZhbHVlICkgewoJCQkJdGhpcy5lbGVtZW50LmJsdXIoKTsKCQkJfQoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgoJCS8vIE1ha2Ugc3VyZSB0byBvbmx5IGNoZWNrIGRpc2FibGVkIGlmIGl0cyBhbiBlbGVtZW50IHRoYXQgc3VwcG9ydHMgdGhpcyBvdGhlcndpc2UKCQkvLyBjaGVjayBmb3IgdGhlIGRpc2FibGVkIGNsYXNzIHRvIGRldGVybWluZSBzdGF0ZQoJCXZhciBpc0Rpc2FibGVkID0gdGhpcy5lbGVtZW50LmlzKCAiaW5wdXQsIGJ1dHRvbiIgKSA/CgkJCXRoaXMuZWxlbWVudFsgMCBdLmRpc2FibGVkIDogdGhpcy5lbGVtZW50Lmhhc0NsYXNzKCAidWktYnV0dG9uLWRpc2FibGVkIiApOwoKCQlpZiAoIGlzRGlzYWJsZWQgIT09IHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJdGhpcy5fc2V0T3B0aW9ucyggeyBkaXNhYmxlZDogaXNEaXNhYmxlZCB9ICk7CgkJfQoKCQl0aGlzLl91cGRhdGVUb29sdGlwKCk7Cgl9Cn0gKTsKCi8vIERFUFJFQ0FURUQKaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgKSB7CgoJLy8gVGV4dCBhbmQgSWNvbnMgb3B0aW9ucwoJJC53aWRnZXQoICJ1aS5idXR0b24iLCAkLnVpLmJ1dHRvbiwgewoJCW9wdGlvbnM6IHsKCQkJdGV4dDogdHJ1ZSwKCQkJaWNvbnM6IHsKCQkJCXByaW1hcnk6IG51bGwsCgkJCQlzZWNvbmRhcnk6IG51bGwKCQkJfQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMub3B0aW9ucy5zaG93TGFiZWwgJiYgIXRoaXMub3B0aW9ucy50ZXh0ICkgewoJCQkJdGhpcy5vcHRpb25zLnNob3dMYWJlbCA9IHRoaXMub3B0aW9ucy50ZXh0OwoJCQl9CgkJCWlmICggIXRoaXMub3B0aW9ucy5zaG93TGFiZWwgJiYgdGhpcy5vcHRpb25zLnRleHQgKSB7CgkJCQl0aGlzLm9wdGlvbnMudGV4dCA9IHRoaXMub3B0aW9ucy5zaG93TGFiZWw7CgkJCX0KCQkJaWYgKCAhdGhpcy5vcHRpb25zLmljb24gJiYgKCB0aGlzLm9wdGlvbnMuaWNvbnMucHJpbWFyeSB8fAoJCQkJCXRoaXMub3B0aW9ucy5pY29ucy5zZWNvbmRhcnkgKSApIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmljb25zLnByaW1hcnkgKSB7CgkJCQkJdGhpcy5vcHRpb25zLmljb24gPSB0aGlzLm9wdGlvbnMuaWNvbnMucHJpbWFyeTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5vcHRpb25zLmljb24gPSB0aGlzLm9wdGlvbnMuaWNvbnMuc2Vjb25kYXJ5OwoJCQkJCXRoaXMub3B0aW9ucy5pY29uUG9zaXRpb24gPSAiZW5kIjsKCQkJCX0KCQkJfSBlbHNlIGlmICggdGhpcy5vcHRpb25zLmljb24gKSB7CgkJCQl0aGlzLm9wdGlvbnMuaWNvbnMucHJpbWFyeSA9IHRoaXMub3B0aW9ucy5pY29uOwoJCQl9CgkJCXRoaXMuX3N1cGVyKCk7CgkJfSwKCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCWlmICgga2V5ID09PSAidGV4dCIgKSB7CgkJCQl0aGlzLl9zdXBlciggInNob3dMYWJlbCIsIHZhbHVlICk7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBrZXkgPT09ICJzaG93TGFiZWwiICkgewoJCQkJdGhpcy5vcHRpb25zLnRleHQgPSB2YWx1ZTsKCQkJfQoJCQlpZiAoIGtleSA9PT0gImljb24iICkgewoJCQkJdGhpcy5vcHRpb25zLmljb25zLnByaW1hcnkgPSB2YWx1ZTsKCQkJfQoJCQlpZiAoIGtleSA9PT0gImljb25zIiApIHsKCQkJCWlmICggdmFsdWUucHJpbWFyeSApIHsKCQkJCQl0aGlzLl9zdXBlciggImljb24iLCB2YWx1ZS5wcmltYXJ5ICk7CgkJCQkJdGhpcy5fc3VwZXIoICJpY29uUG9zaXRpb24iLCAiYmVnaW5uaW5nIiApOwoJCQkJfSBlbHNlIGlmICggdmFsdWUuc2Vjb25kYXJ5ICkgewoJCQkJCXRoaXMuX3N1cGVyKCAiaWNvbiIsIHZhbHVlLnNlY29uZGFyeSApOwoJCQkJCXRoaXMuX3N1cGVyKCAiaWNvblBvc2l0aW9uIiwgImVuZCIgKTsKCQkJCX0KCQkJfQoJCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCQl9Cgl9ICk7CgoJJC5mbi5idXR0b24gPSAoIGZ1bmN0aW9uKCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5sZW5ndGggfHwgKCB0aGlzLmxlbmd0aCAmJiB0aGlzWyAwIF0udGFnTmFtZSAhPT0gIklOUFVUIiApIHx8CgkJCQkJKCB0aGlzLmxlbmd0aCAmJiB0aGlzWyAwIF0udGFnTmFtZSA9PT0gIklOUFVUIiAmJiAoCgkJCQkJCXRoaXMuYXR0ciggInR5cGUiICkgIT09ICJjaGVja2JveCIgJiYgdGhpcy5hdHRyKCAidHlwZSIgKSAhPT0gInJhZGlvIgoJCQkJCSkgKSApIHsKCQkJCXJldHVybiBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfQoJCQlpZiAoICEkLnVpLmNoZWNrYm94cmFkaW8gKSB7CgkJCQkkLmVycm9yKCAiQ2hlY2tib3hyYWRpbyB3aWRnZXQgbWlzc2luZyIgKTsKCQkJfQoJCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgKSB7CgkJCQlyZXR1cm4gdGhpcy5jaGVja2JveHJhZGlvKCB7CgkJCQkJImljb24iOiBmYWxzZQoJCQkJfSApOwoJCQl9CgkJCXJldHVybiB0aGlzLmNoZWNrYm94cmFkaW8uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCX07Cgl9ICkoICQuZm4uYnV0dG9uICk7CgoJJC5mbi5idXR0b25zZXQgPSBmdW5jdGlvbigpIHsKCQlpZiAoICEkLnVpLmNvbnRyb2xncm91cCApIHsKCQkJJC5lcnJvciggIkNvbnRyb2xncm91cCB3aWRnZXQgbWlzc2luZyIgKTsKCQl9CgkJaWYgKCBhcmd1bWVudHNbIDAgXSA9PT0gIm9wdGlvbiIgJiYgYXJndW1lbnRzWyAxIF0gPT09ICJpdGVtcyIgJiYgYXJndW1lbnRzWyAyIF0gKSB7CgkJCXJldHVybiB0aGlzLmNvbnRyb2xncm91cC5hcHBseSggdGhpcywKCQkJCVsgYXJndW1lbnRzWyAwIF0sICJpdGVtcy5idXR0b24iLCBhcmd1bWVudHNbIDIgXSBdICk7CgkJfQoJCWlmICggYXJndW1lbnRzWyAwIF0gPT09ICJvcHRpb24iICYmIGFyZ3VtZW50c1sgMSBdID09PSAiaXRlbXMiICkgewoJCQlyZXR1cm4gdGhpcy5jb250cm9sZ3JvdXAuYXBwbHkoIHRoaXMsIFsgYXJndW1lbnRzWyAwIF0sICJpdGVtcy5idXR0b24iIF0gKTsKCQl9CgkJaWYgKCB0eXBlb2YgYXJndW1lbnRzWyAwIF0gPT09ICJvYmplY3QiICYmIGFyZ3VtZW50c1sgMCBdLml0ZW1zICkgewoJCQlhcmd1bWVudHNbIDAgXS5pdGVtcyA9IHsKCQkJCWJ1dHRvbjogYXJndW1lbnRzWyAwIF0uaXRlbXMKCQkJfTsKCQl9CgkJcmV0dXJuIHRoaXMuY29udHJvbGdyb3VwLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCX07Cn0KCnZhciB3aWRnZXRzQnV0dG9uID0gJC51aS5idXR0b247CgoKLy8ganNjczpkaXNhYmxlIG1heGltdW1MaW5lTGVuZ3RoCi8qIGpzY3M6ZGlzYWJsZSByZXF1aXJlQ2FtZWxDYXNlT3JVcHBlckNhc2VJZGVudGlmaWVycyAqLwovKiEKICogalF1ZXJ5IFVJIERhdGVwaWNrZXIgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBEYXRlcGlja2VyCi8vPj5ncm91cDogV2lkZ2V0cwovLz4+ZGVzY3JpcHRpb246IERpc3BsYXlzIGEgY2FsZW5kYXIgZnJvbSBhbiBpbnB1dCBvciBpbmxpbmUgZm9yIHNlbGVjdGluZyBkYXRlcy4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2RhdGVwaWNrZXIvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9kYXRlcGlja2VyLwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MKLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2RhdGVwaWNrZXIuY3NzCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcwoKCgokLmV4dGVuZCggJC51aSwgeyBkYXRlcGlja2VyOiB7IHZlcnNpb246ICIxLjEyLjEiIH0gfSApOwoKdmFyIGRhdGVwaWNrZXJfaW5zdEFjdGl2ZTsKCmZ1bmN0aW9uIGRhdGVwaWNrZXJfZ2V0WmluZGV4KCBlbGVtICkgewoJdmFyIHBvc2l0aW9uLCB2YWx1ZTsKCXdoaWxlICggZWxlbS5sZW5ndGggJiYgZWxlbVsgMCBdICE9PSBkb2N1bWVudCApIHsKCgkJLy8gSWdub3JlIHotaW5kZXggaWYgcG9zaXRpb24gaXMgc2V0IHRvIGEgdmFsdWUgd2hlcmUgei1pbmRleCBpcyBpZ25vcmVkIGJ5IHRoZSBicm93c2VyCgkJLy8gVGhpcyBtYWtlcyBiZWhhdmlvciBvZiB0aGlzIGZ1bmN0aW9uIGNvbnNpc3RlbnQgYWNyb3NzIGJyb3dzZXJzCgkJLy8gV2ViS2l0IGFsd2F5cyByZXR1cm5zIGF1dG8gaWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZAoJCXBvc2l0aW9uID0gZWxlbS5jc3MoICJwb3NpdGlvbiIgKTsKCQlpZiAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAicmVsYXRpdmUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgewoKCQkJLy8gSUUgcmV0dXJucyAwIHdoZW4gekluZGV4IGlzIG5vdCBzcGVjaWZpZWQKCQkJLy8gb3RoZXIgYnJvd3NlcnMgcmV0dXJuIGEgc3RyaW5nCgkJCS8vIHdlIGlnbm9yZSB0aGUgY2FzZSBvZiBuZXN0ZWQgZWxlbWVudHMgd2l0aCBhbiBleHBsaWNpdCB2YWx1ZSBvZiAwCgkJCS8vIDxkaXYgc3R5bGU9InotaW5kZXg6IC0xMDsiPjxkaXYgc3R5bGU9InotaW5kZXg6IDA7Ij48L2Rpdj48L2Rpdj4KCQkJdmFsdWUgPSBwYXJzZUludCggZWxlbS5jc3MoICJ6SW5kZXgiICksIDEwICk7CgkJCWlmICggIWlzTmFOKCB2YWx1ZSApICYmIHZhbHVlICE9PSAwICkgewoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9CgkJfQoJCWVsZW0gPSBlbGVtLnBhcmVudCgpOwoJfQoKCXJldHVybiAwOwp9Ci8qIERhdGUgcGlja2VyIG1hbmFnZXIuCiAgIFVzZSB0aGUgc2luZ2xldG9uIGluc3RhbmNlIG9mIHRoaXMgY2xhc3MsICQuZGF0ZXBpY2tlciwgdG8gaW50ZXJhY3Qgd2l0aCB0aGUgZGF0ZSBwaWNrZXIuCiAgIFNldHRpbmdzIGZvciAoZ3JvdXBzIG9mKSBkYXRlIHBpY2tlcnMgYXJlIG1haW50YWluZWQgaW4gYW4gaW5zdGFuY2Ugb2JqZWN0LAogICBhbGxvd2luZyBtdWx0aXBsZSBkaWZmZXJlbnQgc2V0dGluZ3Mgb24gdGhlIHNhbWUgcGFnZS4gKi8KCmZ1bmN0aW9uIERhdGVwaWNrZXIoKSB7Cgl0aGlzLl9jdXJJbnN0ID0gbnVsbDsgLy8gVGhlIGN1cnJlbnQgaW5zdGFuY2UgaW4gdXNlCgl0aGlzLl9rZXlFdmVudCA9IGZhbHNlOyAvLyBJZiB0aGUgbGFzdCBldmVudCB3YXMgYSBrZXkgZXZlbnQKCXRoaXMuX2Rpc2FibGVkSW5wdXRzID0gW107IC8vIExpc3Qgb2YgZGF0ZSBwaWNrZXIgaW5wdXRzIHRoYXQgaGF2ZSBiZWVuIGRpc2FibGVkCgl0aGlzLl9kYXRlcGlja2VyU2hvd2luZyA9IGZhbHNlOyAvLyBUcnVlIGlmIHRoZSBwb3B1cCBwaWNrZXIgaXMgc2hvd2luZyAsIGZhbHNlIGlmIG5vdAoJdGhpcy5faW5EaWFsb2cgPSBmYWxzZTsgLy8gVHJ1ZSBpZiBzaG93aW5nIHdpdGhpbiBhICJkaWFsb2ciLCBmYWxzZSBpZiBub3QKCXRoaXMuX21haW5EaXZJZCA9ICJ1aS1kYXRlcGlja2VyLWRpdiI7IC8vIFRoZSBJRCBvZiB0aGUgbWFpbiBkYXRlcGlja2VyIGRpdmlzaW9uCgl0aGlzLl9pbmxpbmVDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLWlubGluZSI7IC8vIFRoZSBuYW1lIG9mIHRoZSBpbmxpbmUgbWFya2VyIGNsYXNzCgl0aGlzLl9hcHBlbmRDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLWFwcGVuZCI7IC8vIFRoZSBuYW1lIG9mIHRoZSBhcHBlbmQgbWFya2VyIGNsYXNzCgl0aGlzLl90cmlnZ2VyQ2xhc3MgPSAidWktZGF0ZXBpY2tlci10cmlnZ2VyIjsgLy8gVGhlIG5hbWUgb2YgdGhlIHRyaWdnZXIgbWFya2VyIGNsYXNzCgl0aGlzLl9kaWFsb2dDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLWRpYWxvZyI7IC8vIFRoZSBuYW1lIG9mIHRoZSBkaWFsb2cgbWFya2VyIGNsYXNzCgl0aGlzLl9kaXNhYmxlQ2xhc3MgPSAidWktZGF0ZXBpY2tlci1kaXNhYmxlZCI7IC8vIFRoZSBuYW1lIG9mIHRoZSBkaXNhYmxlZCBjb3ZlcmluZyBtYXJrZXIgY2xhc3MKCXRoaXMuX3Vuc2VsZWN0YWJsZUNsYXNzID0gInVpLWRhdGVwaWNrZXItdW5zZWxlY3RhYmxlIjsgLy8gVGhlIG5hbWUgb2YgdGhlIHVuc2VsZWN0YWJsZSBjZWxsIG1hcmtlciBjbGFzcwoJdGhpcy5fY3VycmVudENsYXNzID0gInVpLWRhdGVwaWNrZXItY3VycmVudC1kYXkiOyAvLyBUaGUgbmFtZSBvZiB0aGUgY3VycmVudCBkYXkgbWFya2VyIGNsYXNzCgl0aGlzLl9kYXlPdmVyQ2xhc3MgPSAidWktZGF0ZXBpY2tlci1kYXlzLWNlbGwtb3ZlciI7IC8vIFRoZSBuYW1lIG9mIHRoZSBkYXkgaG92ZXIgbWFya2VyIGNsYXNzCgl0aGlzLnJlZ2lvbmFsID0gW107IC8vIEF2YWlsYWJsZSByZWdpb25hbCBzZXR0aW5ncywgaW5kZXhlZCBieSBsYW5ndWFnZSBjb2RlCgl0aGlzLnJlZ2lvbmFsWyAiIiBdID0geyAvLyBEZWZhdWx0IHJlZ2lvbmFsIHNldHRpbmdzCgkJY2xvc2VUZXh0OiAiRG9uZSIsIC8vIERpc3BsYXkgdGV4dCBmb3IgY2xvc2UgbGluawoJCXByZXZUZXh0OiAiUHJldiIsIC8vIERpc3BsYXkgdGV4dCBmb3IgcHJldmlvdXMgbW9udGggbGluawoJCW5leHRUZXh0OiAiTmV4dCIsIC8vIERpc3BsYXkgdGV4dCBmb3IgbmV4dCBtb250aCBsaW5rCgkJY3VycmVudFRleHQ6ICJUb2RheSIsIC8vIERpc3BsYXkgdGV4dCBmb3IgY3VycmVudCBtb250aCBsaW5rCgkJbW9udGhOYW1lczogWyAiSmFudWFyeSIsIkZlYnJ1YXJ5IiwiTWFyY2giLCJBcHJpbCIsIk1heSIsIkp1bmUiLAoJCQkiSnVseSIsIkF1Z3VzdCIsIlNlcHRlbWJlciIsIk9jdG9iZXIiLCJOb3ZlbWJlciIsIkRlY2VtYmVyIiBdLCAvLyBOYW1lcyBvZiBtb250aHMgZm9yIGRyb3AtZG93biBhbmQgZm9ybWF0dGluZwoJCW1vbnRoTmFtZXNTaG9ydDogWyAiSmFuIiwgIkZlYiIsICJNYXIiLCAiQXByIiwgIk1heSIsICJKdW4iLCAiSnVsIiwgIkF1ZyIsICJTZXAiLCAiT2N0IiwgIk5vdiIsICJEZWMiIF0sIC8vIEZvciBmb3JtYXR0aW5nCgkJZGF5TmFtZXM6IFsgIlN1bmRheSIsICJNb25kYXkiLCAiVHVlc2RheSIsICJXZWRuZXNkYXkiLCAiVGh1cnNkYXkiLCAiRnJpZGF5IiwgIlNhdHVyZGF5IiBdLCAvLyBGb3IgZm9ybWF0dGluZwoJCWRheU5hbWVzU2hvcnQ6IFsgIlN1biIsICJNb24iLCAiVHVlIiwgIldlZCIsICJUaHUiLCAiRnJpIiwgIlNhdCIgXSwgLy8gRm9yIGZvcm1hdHRpbmcKCQlkYXlOYW1lc01pbjogWyAiU3UiLCJNbyIsIlR1IiwiV2UiLCJUaCIsIkZyIiwiU2EiIF0sIC8vIENvbHVtbiBoZWFkaW5ncyBmb3IgZGF5cyBzdGFydGluZyBhdCBTdW5kYXkKCQl3ZWVrSGVhZGVyOiAiV2siLCAvLyBDb2x1bW4gaGVhZGVyIGZvciB3ZWVrIG9mIHRoZSB5ZWFyCgkJZGF0ZUZvcm1hdDogIm1tL2RkL3l5IiwgLy8gU2VlIGZvcm1hdCBvcHRpb25zIG9uIHBhcnNlRGF0ZQoJCWZpcnN0RGF5OiAwLCAvLyBUaGUgZmlyc3QgZGF5IG9mIHRoZSB3ZWVrLCBTdW4gPSAwLCBNb24gPSAxLCAuLi4KCQlpc1JUTDogZmFsc2UsIC8vIFRydWUgaWYgcmlnaHQtdG8tbGVmdCBsYW5ndWFnZSwgZmFsc2UgaWYgbGVmdC10by1yaWdodAoJCXNob3dNb250aEFmdGVyWWVhcjogZmFsc2UsIC8vIFRydWUgaWYgdGhlIHllYXIgc2VsZWN0IHByZWNlZGVzIG1vbnRoLCBmYWxzZSBmb3IgbW9udGggdGhlbiB5ZWFyCgkJeWVhclN1ZmZpeDogIiIgLy8gQWRkaXRpb25hbCB0ZXh0IHRvIGFwcGVuZCB0byB0aGUgeWVhciBpbiB0aGUgbW9udGggaGVhZGVycwoJfTsKCXRoaXMuX2RlZmF1bHRzID0geyAvLyBHbG9iYWwgZGVmYXVsdHMgZm9yIGFsbCB0aGUgZGF0ZSBwaWNrZXIgaW5zdGFuY2VzCgkJc2hvd09uOiAiZm9jdXMiLCAvLyAiZm9jdXMiIGZvciBwb3B1cCBvbiBmb2N1cywKCQkJLy8gImJ1dHRvbiIgZm9yIHRyaWdnZXIgYnV0dG9uLCBvciAiYm90aCIgZm9yIGVpdGhlcgoJCXNob3dBbmltOiAiZmFkZUluIiwgLy8gTmFtZSBvZiBqUXVlcnkgYW5pbWF0aW9uIGZvciBwb3B1cAoJCXNob3dPcHRpb25zOiB7fSwgLy8gT3B0aW9ucyBmb3IgZW5oYW5jZWQgYW5pbWF0aW9ucwoJCWRlZmF1bHREYXRlOiBudWxsLCAvLyBVc2VkIHdoZW4gZmllbGQgaXMgYmxhbms6IGFjdHVhbCBkYXRlLAoJCQkvLyArLy1udW1iZXIgZm9yIG9mZnNldCBmcm9tIHRvZGF5LCBudWxsIGZvciB0b2RheQoJCWFwcGVuZFRleHQ6ICIiLCAvLyBEaXNwbGF5IHRleHQgZm9sbG93aW5nIHRoZSBpbnB1dCBib3gsIGUuZy4gc2hvd2luZyB0aGUgZm9ybWF0CgkJYnV0dG9uVGV4dDogIi4uLiIsIC8vIFRleHQgZm9yIHRyaWdnZXIgYnV0dG9uCgkJYnV0dG9uSW1hZ2U6ICIiLCAvLyBVUkwgZm9yIHRyaWdnZXIgYnV0dG9uIGltYWdlCgkJYnV0dG9uSW1hZ2VPbmx5OiBmYWxzZSwgLy8gVHJ1ZSBpZiB0aGUgaW1hZ2UgYXBwZWFycyBhbG9uZSwgZmFsc2UgaWYgaXQgYXBwZWFycyBvbiBhIGJ1dHRvbgoJCWhpZGVJZk5vUHJldk5leHQ6IGZhbHNlLCAvLyBUcnVlIHRvIGhpZGUgbmV4dC9wcmV2aW91cyBtb250aCBsaW5rcwoJCQkvLyBpZiBub3QgYXBwbGljYWJsZSwgZmFsc2UgdG8ganVzdCBkaXNhYmxlIHRoZW0KCQluYXZpZ2F0aW9uQXNEYXRlRm9ybWF0OiBmYWxzZSwgLy8gVHJ1ZSBpZiBkYXRlIGZvcm1hdHRpbmcgYXBwbGllZCB0byBwcmV2L3RvZGF5L25leHQgbGlua3MKCQlnb3RvQ3VycmVudDogZmFsc2UsIC8vIFRydWUgaWYgdG9kYXkgbGluayBnb2VzIGJhY2sgdG8gY3VycmVudCBzZWxlY3Rpb24gaW5zdGVhZAoJCWNoYW5nZU1vbnRoOiBmYWxzZSwgLy8gVHJ1ZSBpZiBtb250aCBjYW4gYmUgc2VsZWN0ZWQgZGlyZWN0bHksIGZhbHNlIGlmIG9ubHkgcHJldi9uZXh0CgkJY2hhbmdlWWVhcjogZmFsc2UsIC8vIFRydWUgaWYgeWVhciBjYW4gYmUgc2VsZWN0ZWQgZGlyZWN0bHksIGZhbHNlIGlmIG9ubHkgcHJldi9uZXh0CgkJeWVhclJhbmdlOiAiYy0xMDpjKzEwIiwgLy8gUmFuZ2Ugb2YgeWVhcnMgdG8gZGlzcGxheSBpbiBkcm9wLWRvd24sCgkJCS8vIGVpdGhlciByZWxhdGl2ZSB0byB0b2RheSdzIHllYXIgKC1ubjorbm4pLCByZWxhdGl2ZSB0byBjdXJyZW50bHkgZGlzcGxheWVkIHllYXIKCQkJLy8gKGMtbm46YytubiksIGFic29sdXRlIChubm5uOm5ubm4pLCBvciBhIGNvbWJpbmF0aW9uIG9mIHRoZSBhYm92ZSAobm5ubjotbikKCQlzaG93T3RoZXJNb250aHM6IGZhbHNlLCAvLyBUcnVlIHRvIHNob3cgZGF0ZXMgaW4gb3RoZXIgbW9udGhzLCBmYWxzZSB0byBsZWF2ZSBibGFuawoJCXNlbGVjdE90aGVyTW9udGhzOiBmYWxzZSwgLy8gVHJ1ZSB0byBhbGxvdyBzZWxlY3Rpb24gb2YgZGF0ZXMgaW4gb3RoZXIgbW9udGhzLCBmYWxzZSBmb3IgdW5zZWxlY3RhYmxlCgkJc2hvd1dlZWs6IGZhbHNlLCAvLyBUcnVlIHRvIHNob3cgd2VlayBvZiB0aGUgeWVhciwgZmFsc2UgdG8gbm90IHNob3cgaXQKCQljYWxjdWxhdGVXZWVrOiB0aGlzLmlzbzg2MDFXZWVrLCAvLyBIb3cgdG8gY2FsY3VsYXRlIHRoZSB3ZWVrIG9mIHRoZSB5ZWFyLAoJCQkvLyB0YWtlcyBhIERhdGUgYW5kIHJldHVybnMgdGhlIG51bWJlciBvZiB0aGUgd2VlayBmb3IgaXQKCQlzaG9ydFllYXJDdXRvZmY6ICIrMTAiLCAvLyBTaG9ydCB5ZWFyIHZhbHVlcyA8IHRoaXMgYXJlIGluIHRoZSBjdXJyZW50IGNlbnR1cnksCgkJCS8vID4gdGhpcyBhcmUgaW4gdGhlIHByZXZpb3VzIGNlbnR1cnksCgkJCS8vIHN0cmluZyB2YWx1ZSBzdGFydGluZyB3aXRoICIrIiBmb3IgY3VycmVudCB5ZWFyICsgdmFsdWUKCQltaW5EYXRlOiBudWxsLCAvLyBUaGUgZWFybGllc3Qgc2VsZWN0YWJsZSBkYXRlLCBvciBudWxsIGZvciBubyBsaW1pdAoJCW1heERhdGU6IG51bGwsIC8vIFRoZSBsYXRlc3Qgc2VsZWN0YWJsZSBkYXRlLCBvciBudWxsIGZvciBubyBsaW1pdAoJCWR1cmF0aW9uOiAiZmFzdCIsIC8vIER1cmF0aW9uIG9mIGRpc3BsYXkvY2xvc3VyZQoJCWJlZm9yZVNob3dEYXk6IG51bGwsIC8vIEZ1bmN0aW9uIHRoYXQgdGFrZXMgYSBkYXRlIGFuZCByZXR1cm5zIGFuIGFycmF5IHdpdGgKCQkJLy8gWzBdID0gdHJ1ZSBpZiBzZWxlY3RhYmxlLCBmYWxzZSBpZiBub3QsIFsxXSA9IGN1c3RvbSBDU1MgY2xhc3MgbmFtZShzKSBvciAiIiwKCQkJLy8gWzJdID0gY2VsbCB0aXRsZSAob3B0aW9uYWwpLCBlLmcuICQuZGF0ZXBpY2tlci5ub1dlZWtlbmRzCgkJYmVmb3JlU2hvdzogbnVsbCwgLy8gRnVuY3Rpb24gdGhhdCB0YWtlcyBhbiBpbnB1dCBmaWVsZCBhbmQKCQkJLy8gcmV0dXJucyBhIHNldCBvZiBjdXN0b20gc2V0dGluZ3MgZm9yIHRoZSBkYXRlIHBpY2tlcgoJCW9uU2VsZWN0OiBudWxsLCAvLyBEZWZpbmUgYSBjYWxsYmFjayBmdW5jdGlvbiB3aGVuIGEgZGF0ZSBpcyBzZWxlY3RlZAoJCW9uQ2hhbmdlTW9udGhZZWFyOiBudWxsLCAvLyBEZWZpbmUgYSBjYWxsYmFjayBmdW5jdGlvbiB3aGVuIHRoZSBtb250aCBvciB5ZWFyIGlzIGNoYW5nZWQKCQlvbkNsb3NlOiBudWxsLCAvLyBEZWZpbmUgYSBjYWxsYmFjayBmdW5jdGlvbiB3aGVuIHRoZSBkYXRlcGlja2VyIGlzIGNsb3NlZAoJCW51bWJlck9mTW9udGhzOiAxLCAvLyBOdW1iZXIgb2YgbW9udGhzIHRvIHNob3cgYXQgYSB0aW1lCgkJc2hvd0N1cnJlbnRBdFBvczogMCwgLy8gVGhlIHBvc2l0aW9uIGluIG11bHRpcGUgbW9udGhzIGF0IHdoaWNoIHRvIHNob3cgdGhlIGN1cnJlbnQgbW9udGggKHN0YXJ0aW5nIGF0IDApCgkJc3RlcE1vbnRoczogMSwgLy8gTnVtYmVyIG9mIG1vbnRocyB0byBzdGVwIGJhY2svZm9yd2FyZAoJCXN0ZXBCaWdNb250aHM6IDEyLCAvLyBOdW1iZXIgb2YgbW9udGhzIHRvIHN0ZXAgYmFjay9mb3J3YXJkIGZvciB0aGUgYmlnIGxpbmtzCgkJYWx0RmllbGQ6ICIiLCAvLyBTZWxlY3RvciBmb3IgYW4gYWx0ZXJuYXRlIGZpZWxkIHRvIHN0b3JlIHNlbGVjdGVkIGRhdGVzIGludG8KCQlhbHRGb3JtYXQ6ICIiLCAvLyBUaGUgZGF0ZSBmb3JtYXQgdG8gdXNlIGZvciB0aGUgYWx0ZXJuYXRlIGZpZWxkCgkJY29uc3RyYWluSW5wdXQ6IHRydWUsIC8vIFRoZSBpbnB1dCBpcyBjb25zdHJhaW5lZCBieSB0aGUgY3VycmVudCBkYXRlIGZvcm1hdAoJCXNob3dCdXR0b25QYW5lbDogZmFsc2UsIC8vIFRydWUgdG8gc2hvdyBidXR0b24gcGFuZWwsIGZhbHNlIHRvIG5vdCBzaG93IGl0CgkJYXV0b1NpemU6IGZhbHNlLCAvLyBUcnVlIHRvIHNpemUgdGhlIGlucHV0IGZvciB0aGUgZGF0ZSBmb3JtYXQsIGZhbHNlIHRvIGxlYXZlIGFzIGlzCgkJZGlzYWJsZWQ6IGZhbHNlIC8vIFRoZSBpbml0aWFsIGRpc2FibGVkIHN0YXRlCgl9OwoJJC5leHRlbmQoIHRoaXMuX2RlZmF1bHRzLCB0aGlzLnJlZ2lvbmFsWyAiIiBdICk7Cgl0aGlzLnJlZ2lvbmFsLmVuID0gJC5leHRlbmQoIHRydWUsIHt9LCB0aGlzLnJlZ2lvbmFsWyAiIiBdICk7Cgl0aGlzLnJlZ2lvbmFsWyAiZW4tVVMiIF0gPSAkLmV4dGVuZCggdHJ1ZSwge30sIHRoaXMucmVnaW9uYWwuZW4gKTsKCXRoaXMuZHBEaXYgPSBkYXRlcGlja2VyX2JpbmRIb3ZlciggJCggIjxkaXYgaWQ9JyIgKyB0aGlzLl9tYWluRGl2SWQgKyAiJyBjbGFzcz0ndWktZGF0ZXBpY2tlciB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktaGVscGVyLWNsZWFyZml4IHVpLWNvcm5lci1hbGwnPjwvZGl2PiIgKSApOwp9CgokLmV4dGVuZCggRGF0ZXBpY2tlci5wcm90b3R5cGUsIHsKCS8qIENsYXNzIG5hbWUgYWRkZWQgdG8gZWxlbWVudHMgdG8gaW5kaWNhdGUgYWxyZWFkeSBjb25maWd1cmVkIHdpdGggYSBkYXRlIHBpY2tlci4gKi8KCW1hcmtlckNsYXNzTmFtZTogImhhc0RhdGVwaWNrZXIiLAoKCS8vS2VlcCB0cmFjayBvZiB0aGUgbWF4aW11bSBudW1iZXIgb2Ygcm93cyBkaXNwbGF5ZWQgKHNlZSAjNzA0MykKCW1heFJvd3M6IDQsCgoJLy8gVE9ETyByZW5hbWUgdG8gIndpZGdldCIgd2hlbiBzd2l0Y2hpbmcgdG8gd2lkZ2V0IGZhY3RvcnkKCV93aWRnZXREYXRlcGlja2VyOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kcERpdjsKCX0sCgoJLyogT3ZlcnJpZGUgdGhlIGRlZmF1bHQgc2V0dGluZ3MgZm9yIGFsbCBpbnN0YW5jZXMgb2YgdGhlIGRhdGUgcGlja2VyLgoJICogQHBhcmFtICBzZXR0aW5ncyAgb2JqZWN0IC0gdGhlIG5ldyBzZXR0aW5ncyB0byB1c2UgYXMgZGVmYXVsdHMgKGFub255bW91cyBvYmplY3QpCgkgKiBAcmV0dXJuIHRoZSBtYW5hZ2VyIG9iamVjdAoJICovCglzZXREZWZhdWx0czogZnVuY3Rpb24oIHNldHRpbmdzICkgewoJCWRhdGVwaWNrZXJfZXh0ZW5kUmVtb3ZlKCB0aGlzLl9kZWZhdWx0cywgc2V0dGluZ3MgfHwge30gKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyogQXR0YWNoIHRoZSBkYXRlIHBpY2tlciB0byBhIGpRdWVyeSBzZWxlY3Rpb24uCgkgKiBAcGFyYW0gIHRhcmdldAllbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuCgkgKiBAcGFyYW0gIHNldHRpbmdzICBvYmplY3QgLSB0aGUgbmV3IHNldHRpbmdzIHRvIHVzZSBmb3IgdGhpcyBkYXRlIHBpY2tlciBpbnN0YW5jZSAoYW5vbnltb3VzKQoJICovCglfYXR0YWNoRGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCwgc2V0dGluZ3MgKSB7CgkJdmFyIG5vZGVOYW1lLCBpbmxpbmUsIGluc3Q7CgkJbm9kZU5hbWUgPSB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQlpbmxpbmUgPSAoIG5vZGVOYW1lID09PSAiZGl2IiB8fCBub2RlTmFtZSA9PT0gInNwYW4iICk7CgkJaWYgKCAhdGFyZ2V0LmlkICkgewoJCQl0aGlzLnV1aWQgKz0gMTsKCQkJdGFyZ2V0LmlkID0gImRwIiArIHRoaXMudXVpZDsKCQl9CgkJaW5zdCA9IHRoaXMuX25ld0luc3QoICQoIHRhcmdldCApLCBpbmxpbmUgKTsKCQlpbnN0LnNldHRpbmdzID0gJC5leHRlbmQoIHt9LCBzZXR0aW5ncyB8fCB7fSApOwoJCWlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgKSB7CgkJCXRoaXMuX2Nvbm5lY3REYXRlcGlja2VyKCB0YXJnZXQsIGluc3QgKTsKCQl9IGVsc2UgaWYgKCBpbmxpbmUgKSB7CgkJCXRoaXMuX2lubGluZURhdGVwaWNrZXIoIHRhcmdldCwgaW5zdCApOwoJCX0KCX0sCgoJLyogQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9iamVjdC4gKi8KCV9uZXdJbnN0OiBmdW5jdGlvbiggdGFyZ2V0LCBpbmxpbmUgKSB7CgkJdmFyIGlkID0gdGFyZ2V0WyAwIF0uaWQucmVwbGFjZSggLyhbXkEtWmEtejAtOV9cLV0pL2csICJcXFxcJDEiICk7IC8vIGVzY2FwZSBqUXVlcnkgbWV0YSBjaGFycwoJCXJldHVybiB7IGlkOiBpZCwgaW5wdXQ6IHRhcmdldCwgLy8gYXNzb2NpYXRlZCB0YXJnZXQKCQkJc2VsZWN0ZWREYXk6IDAsIHNlbGVjdGVkTW9udGg6IDAsIHNlbGVjdGVkWWVhcjogMCwgLy8gY3VycmVudCBzZWxlY3Rpb24KCQkJZHJhd01vbnRoOiAwLCBkcmF3WWVhcjogMCwgLy8gbW9udGggYmVpbmcgZHJhd24KCQkJaW5saW5lOiBpbmxpbmUsIC8vIGlzIGRhdGVwaWNrZXIgaW5saW5lIG9yIG5vdAoJCQlkcERpdjogKCAhaW5saW5lID8gdGhpcy5kcERpdiA6IC8vIHByZXNlbnRhdGlvbiBkaXYKCQkJZGF0ZXBpY2tlcl9iaW5kSG92ZXIoICQoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5faW5saW5lQ2xhc3MgKyAiIHVpLWRhdGVwaWNrZXIgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWhlbHBlci1jbGVhcmZpeCB1aS1jb3JuZXItYWxsJz48L2Rpdj4iICkgKSApIH07Cgl9LAoKCS8qIEF0dGFjaCB0aGUgZGF0ZSBwaWNrZXIgdG8gYW4gaW5wdXQgZmllbGQuICovCglfY29ubmVjdERhdGVwaWNrZXI6IGZ1bmN0aW9uKCB0YXJnZXQsIGluc3QgKSB7CgkJdmFyIGlucHV0ID0gJCggdGFyZ2V0ICk7CgkJaW5zdC5hcHBlbmQgPSAkKCBbXSApOwoJCWluc3QudHJpZ2dlciA9ICQoIFtdICk7CgkJaWYgKCBpbnB1dC5oYXNDbGFzcyggdGhpcy5tYXJrZXJDbGFzc05hbWUgKSApIHsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9hdHRhY2htZW50cyggaW5wdXQsIGluc3QgKTsKCQlpbnB1dC5hZGRDbGFzcyggdGhpcy5tYXJrZXJDbGFzc05hbWUgKS5vbiggImtleWRvd24iLCB0aGlzLl9kb0tleURvd24gKS4KCQkJb24oICJrZXlwcmVzcyIsIHRoaXMuX2RvS2V5UHJlc3MgKS5vbiggImtleXVwIiwgdGhpcy5fZG9LZXlVcCApOwoJCXRoaXMuX2F1dG9TaXplKCBpbnN0ICk7CgkJJC5kYXRhKCB0YXJnZXQsICJkYXRlcGlja2VyIiwgaW5zdCApOwoKCQkvL0lmIGRpc2FibGVkIG9wdGlvbiBpcyB0cnVlLCBkaXNhYmxlIHRoZSBkYXRlcGlja2VyIG9uY2UgaXQgaGFzIGJlZW4gYXR0YWNoZWQgdG8gdGhlIGlucHV0IChzZWUgdGlja2V0ICM1NjY1KQoJCWlmICggaW5zdC5zZXR0aW5ncy5kaXNhYmxlZCApIHsKCQkJdGhpcy5fZGlzYWJsZURhdGVwaWNrZXIoIHRhcmdldCApOwoJCX0KCX0sCgoJLyogTWFrZSBhdHRhY2htZW50cyBiYXNlZCBvbiBzZXR0aW5ncy4gKi8KCV9hdHRhY2htZW50czogZnVuY3Rpb24oIGlucHV0LCBpbnN0ICkgewoJCXZhciBzaG93T24sIGJ1dHRvblRleHQsIGJ1dHRvbkltYWdlLAoJCQlhcHBlbmRUZXh0ID0gdGhpcy5fZ2V0KCBpbnN0LCAiYXBwZW5kVGV4dCIgKSwKCQkJaXNSVEwgPSB0aGlzLl9nZXQoIGluc3QsICJpc1JUTCIgKTsKCgkJaWYgKCBpbnN0LmFwcGVuZCApIHsKCQkJaW5zdC5hcHBlbmQucmVtb3ZlKCk7CgkJfQoJCWlmICggYXBwZW5kVGV4dCApIHsKCQkJaW5zdC5hcHBlbmQgPSAkKCAiPHNwYW4gY2xhc3M9JyIgKyB0aGlzLl9hcHBlbmRDbGFzcyArICInPiIgKyBhcHBlbmRUZXh0ICsgIjwvc3Bhbj4iICk7CgkJCWlucHV0WyBpc1JUTCA/ICJiZWZvcmUiIDogImFmdGVyIiBdKCBpbnN0LmFwcGVuZCApOwoJCX0KCgkJaW5wdXQub2ZmKCAiZm9jdXMiLCB0aGlzLl9zaG93RGF0ZXBpY2tlciApOwoKCQlpZiAoIGluc3QudHJpZ2dlciApIHsKCQkJaW5zdC50cmlnZ2VyLnJlbW92ZSgpOwoJCX0KCgkJc2hvd09uID0gdGhpcy5fZ2V0KCBpbnN0LCAic2hvd09uIiApOwoJCWlmICggc2hvd09uID09PSAiZm9jdXMiIHx8IHNob3dPbiA9PT0gImJvdGgiICkgeyAvLyBwb3AtdXAgZGF0ZSBwaWNrZXIgd2hlbiBpbiB0aGUgbWFya2VkIGZpZWxkCgkJCWlucHV0Lm9uKCAiZm9jdXMiLCB0aGlzLl9zaG93RGF0ZXBpY2tlciApOwoJCX0KCQlpZiAoIHNob3dPbiA9PT0gImJ1dHRvbiIgfHwgc2hvd09uID09PSAiYm90aCIgKSB7IC8vIHBvcC11cCBkYXRlIHBpY2tlciB3aGVuIGJ1dHRvbiBjbGlja2VkCgkJCWJ1dHRvblRleHQgPSB0aGlzLl9nZXQoIGluc3QsICJidXR0b25UZXh0IiApOwoJCQlidXR0b25JbWFnZSA9IHRoaXMuX2dldCggaW5zdCwgImJ1dHRvbkltYWdlIiApOwoJCQlpbnN0LnRyaWdnZXIgPSAkKCB0aGlzLl9nZXQoIGluc3QsICJidXR0b25JbWFnZU9ubHkiICkgPwoJCQkJJCggIjxpbWcvPiIgKS5hZGRDbGFzcyggdGhpcy5fdHJpZ2dlckNsYXNzICkuCgkJCQkJYXR0ciggeyBzcmM6IGJ1dHRvbkltYWdlLCBhbHQ6IGJ1dHRvblRleHQsIHRpdGxlOiBidXR0b25UZXh0IH0gKSA6CgkJCQkkKCAiPGJ1dHRvbiB0eXBlPSdidXR0b24nPjwvYnV0dG9uPiIgKS5hZGRDbGFzcyggdGhpcy5fdHJpZ2dlckNsYXNzICkuCgkJCQkJaHRtbCggIWJ1dHRvbkltYWdlID8gYnV0dG9uVGV4dCA6ICQoICI8aW1nLz4iICkuYXR0cigKCQkJCQl7IHNyYzpidXR0b25JbWFnZSwgYWx0OmJ1dHRvblRleHQsIHRpdGxlOmJ1dHRvblRleHQgfSApICkgKTsKCQkJaW5wdXRbIGlzUlRMID8gImJlZm9yZSIgOiAiYWZ0ZXIiIF0oIGluc3QudHJpZ2dlciApOwoJCQlpbnN0LnRyaWdnZXIub24oICJjbGljayIsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAkLmRhdGVwaWNrZXIuX2RhdGVwaWNrZXJTaG93aW5nICYmICQuZGF0ZXBpY2tlci5fbGFzdElucHV0ID09PSBpbnB1dFsgMCBdICkgewoJCQkJCSQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoKTsKCQkJCX0gZWxzZSBpZiAoICQuZGF0ZXBpY2tlci5fZGF0ZXBpY2tlclNob3dpbmcgJiYgJC5kYXRlcGlja2VyLl9sYXN0SW5wdXQgIT09IGlucHV0WyAwIF0gKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9oaWRlRGF0ZXBpY2tlcigpOwoJCQkJCSQuZGF0ZXBpY2tlci5fc2hvd0RhdGVwaWNrZXIoIGlucHV0WyAwIF0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJJC5kYXRlcGlja2VyLl9zaG93RGF0ZXBpY2tlciggaW5wdXRbIDAgXSApOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9ICk7CgkJfQoJfSwKCgkvKiBBcHBseSB0aGUgbWF4aW11bSBsZW5ndGggZm9yIHRoZSBkYXRlIGZvcm1hdC4gKi8KCV9hdXRvU2l6ZTogZnVuY3Rpb24oIGluc3QgKSB7CgkJaWYgKCB0aGlzLl9nZXQoIGluc3QsICJhdXRvU2l6ZSIgKSAmJiAhaW5zdC5pbmxpbmUgKSB7CgkJCXZhciBmaW5kTWF4LCBtYXgsIG1heEksIGksCgkJCQlkYXRlID0gbmV3IERhdGUoIDIwMDksIDEyIC0gMSwgMjAgKSwgLy8gRW5zdXJlIGRvdWJsZSBkaWdpdHMKCQkJCWRhdGVGb3JtYXQgPSB0aGlzLl9nZXQoIGluc3QsICJkYXRlRm9ybWF0IiApOwoKCQkJaWYgKCBkYXRlRm9ybWF0Lm1hdGNoKCAvW0RNXS8gKSApIHsKCQkJCWZpbmRNYXggPSBmdW5jdGlvbiggbmFtZXMgKSB7CgkJCQkJbWF4ID0gMDsKCQkJCQltYXhJID0gMDsKCQkJCQlmb3IgKCBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrICkgewoJCQkJCQlpZiAoIG5hbWVzWyBpIF0ubGVuZ3RoID4gbWF4ICkgewoJCQkJCQkJbWF4ID0gbmFtZXNbIGkgXS5sZW5ndGg7CgkJCQkJCQltYXhJID0gaTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXR1cm4gbWF4STsKCQkJCX07CgkJCQlkYXRlLnNldE1vbnRoKCBmaW5kTWF4KCB0aGlzLl9nZXQoIGluc3QsICggZGF0ZUZvcm1hdC5tYXRjaCggL01NLyApID8KCQkJCQkibW9udGhOYW1lcyIgOiAibW9udGhOYW1lc1Nob3J0IiApICkgKSApOwoJCQkJZGF0ZS5zZXREYXRlKCBmaW5kTWF4KCB0aGlzLl9nZXQoIGluc3QsICggZGF0ZUZvcm1hdC5tYXRjaCggL0RELyApID8KCQkJCQkiZGF5TmFtZXMiIDogImRheU5hbWVzU2hvcnQiICkgKSApICsgMjAgLSBkYXRlLmdldERheSgpICk7CgkJCX0KCQkJaW5zdC5pbnB1dC5hdHRyKCAic2l6ZSIsIHRoaXMuX2Zvcm1hdERhdGUoIGluc3QsIGRhdGUgKS5sZW5ndGggKTsKCQl9Cgl9LAoKCS8qIEF0dGFjaCBhbiBpbmxpbmUgZGF0ZSBwaWNrZXIgdG8gYSBkaXYuICovCglfaW5saW5lRGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCwgaW5zdCApIHsKCQl2YXIgZGl2U3BhbiA9ICQoIHRhcmdldCApOwoJCWlmICggZGl2U3Bhbi5oYXNDbGFzcyggdGhpcy5tYXJrZXJDbGFzc05hbWUgKSApIHsKCQkJcmV0dXJuOwoJCX0KCQlkaXZTcGFuLmFkZENsYXNzKCB0aGlzLm1hcmtlckNsYXNzTmFtZSApLmFwcGVuZCggaW5zdC5kcERpdiApOwoJCSQuZGF0YSggdGFyZ2V0LCAiZGF0ZXBpY2tlciIsIGluc3QgKTsKCQl0aGlzLl9zZXREYXRlKCBpbnN0LCB0aGlzLl9nZXREZWZhdWx0RGF0ZSggaW5zdCApLCB0cnVlICk7CgkJdGhpcy5fdXBkYXRlRGF0ZXBpY2tlciggaW5zdCApOwoJCXRoaXMuX3VwZGF0ZUFsdGVybmF0ZSggaW5zdCApOwoKCQkvL0lmIGRpc2FibGVkIG9wdGlvbiBpcyB0cnVlLCBkaXNhYmxlIHRoZSBkYXRlcGlja2VyIGJlZm9yZSBzaG93aW5nIGl0IChzZWUgdGlja2V0ICM1NjY1KQoJCWlmICggaW5zdC5zZXR0aW5ncy5kaXNhYmxlZCApIHsKCQkJdGhpcy5fZGlzYWJsZURhdGVwaWNrZXIoIHRhcmdldCApOwoJCX0KCgkJLy8gU2V0IGRpc3BsYXk6YmxvY2sgaW4gcGxhY2Ugb2YgaW5zdC5kcERpdi5zaG93KCkgd2hpY2ggd29uJ3Qgd29yayBvbiBkaXNjb25uZWN0ZWQgZWxlbWVudHMKCQkvLyBodHRwOi8vYnVncy5qcXVlcnl1aS5jb20vdGlja2V0Lzc1NTIgLSBBIERhdGVwaWNrZXIgY3JlYXRlZCBvbiBhIGRldGFjaGVkIGRpdiBoYXMgemVybyBoZWlnaHQKCQlpbnN0LmRwRGl2LmNzcyggImRpc3BsYXkiLCAiYmxvY2siICk7Cgl9LAoKCS8qIFBvcC11cCB0aGUgZGF0ZSBwaWNrZXIgaW4gYSAiZGlhbG9nIiBib3guCgkgKiBAcGFyYW0gIGlucHV0IGVsZW1lbnQgLSBpZ25vcmVkCgkgKiBAcGFyYW0gIGRhdGUJc3RyaW5nIG9yIERhdGUgLSB0aGUgaW5pdGlhbCBkYXRlIHRvIGRpc3BsYXkKCSAqIEBwYXJhbSAgb25TZWxlY3QgIGZ1bmN0aW9uIC0gdGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiBhIGRhdGUgaXMgc2VsZWN0ZWQKCSAqIEBwYXJhbSAgc2V0dGluZ3MgIG9iamVjdCAtIHVwZGF0ZSB0aGUgZGlhbG9nIGRhdGUgcGlja2VyIGluc3RhbmNlJ3Mgc2V0dGluZ3MgKGFub255bW91cyBvYmplY3QpCgkgKiBAcGFyYW0gIHBvcyBpbnRbMl0gLSBjb29yZGluYXRlcyBmb3IgdGhlIGRpYWxvZydzIHBvc2l0aW9uIHdpdGhpbiB0aGUgc2NyZWVuIG9yCgkgKgkJCQkJZXZlbnQgLSB3aXRoIHgveSBjb29yZGluYXRlcyBvcgoJICoJCQkJCWxlYXZlIGVtcHR5IGZvciBkZWZhdWx0IChzY3JlZW4gY2VudHJlKQoJICogQHJldHVybiB0aGUgbWFuYWdlciBvYmplY3QKCSAqLwoJX2RpYWxvZ0RhdGVwaWNrZXI6IGZ1bmN0aW9uKCBpbnB1dCwgZGF0ZSwgb25TZWxlY3QsIHNldHRpbmdzLCBwb3MgKSB7CgkJdmFyIGlkLCBicm93c2VyV2lkdGgsIGJyb3dzZXJIZWlnaHQsIHNjcm9sbFgsIHNjcm9sbFksCgkJCWluc3QgPSB0aGlzLl9kaWFsb2dJbnN0OyAvLyBpbnRlcm5hbCBpbnN0YW5jZQoKCQlpZiAoICFpbnN0ICkgewoJCQl0aGlzLnV1aWQgKz0gMTsKCQkJaWQgPSAiZHAiICsgdGhpcy51dWlkOwoJCQl0aGlzLl9kaWFsb2dJbnB1dCA9ICQoICI8aW5wdXQgdHlwZT0ndGV4dCcgaWQ9JyIgKyBpZCArCgkJCQkiJyBzdHlsZT0ncG9zaXRpb246IGFic29sdXRlOyB0b3A6IC0xMDBweDsgd2lkdGg6IDBweDsnLz4iICk7CgkJCXRoaXMuX2RpYWxvZ0lucHV0Lm9uKCAia2V5ZG93biIsIHRoaXMuX2RvS2V5RG93biApOwoJCQkkKCAiYm9keSIgKS5hcHBlbmQoIHRoaXMuX2RpYWxvZ0lucHV0ICk7CgkJCWluc3QgPSB0aGlzLl9kaWFsb2dJbnN0ID0gdGhpcy5fbmV3SW5zdCggdGhpcy5fZGlhbG9nSW5wdXQsIGZhbHNlICk7CgkJCWluc3Quc2V0dGluZ3MgPSB7fTsKCQkJJC5kYXRhKCB0aGlzLl9kaWFsb2dJbnB1dFsgMCBdLCAiZGF0ZXBpY2tlciIsIGluc3QgKTsKCQl9CgkJZGF0ZXBpY2tlcl9leHRlbmRSZW1vdmUoIGluc3Quc2V0dGluZ3MsIHNldHRpbmdzIHx8IHt9ICk7CgkJZGF0ZSA9ICggZGF0ZSAmJiBkYXRlLmNvbnN0cnVjdG9yID09PSBEYXRlID8gdGhpcy5fZm9ybWF0RGF0ZSggaW5zdCwgZGF0ZSApIDogZGF0ZSApOwoJCXRoaXMuX2RpYWxvZ0lucHV0LnZhbCggZGF0ZSApOwoKCQl0aGlzLl9wb3MgPSAoIHBvcyA/ICggcG9zLmxlbmd0aCA/IHBvcyA6IFsgcG9zLnBhZ2VYLCBwb3MucGFnZVkgXSApIDogbnVsbCApOwoJCWlmICggIXRoaXMuX3BvcyApIHsKCQkJYnJvd3NlcldpZHRoID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoOwoJCQlicm93c2VySGVpZ2h0ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodDsKCQkJc2Nyb2xsWCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0IHx8IGRvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdDsKCQkJc2Nyb2xsWSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3AgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3A7CgkJCXRoaXMuX3BvcyA9IC8vIHNob3VsZCB1c2UgYWN0dWFsIHdpZHRoL2hlaWdodCBiZWxvdwoJCQkJWyAoIGJyb3dzZXJXaWR0aCAvIDIgKSAtIDEwMCArIHNjcm9sbFgsICggYnJvd3NlckhlaWdodCAvIDIgKSAtIDE1MCArIHNjcm9sbFkgXTsKCQl9CgoJCS8vIE1vdmUgaW5wdXQgb24gc2NyZWVuIGZvciBmb2N1cywgYnV0IGhpZGRlbiBiZWhpbmQgZGlhbG9nCgkJdGhpcy5fZGlhbG9nSW5wdXQuY3NzKCAibGVmdCIsICggdGhpcy5fcG9zWyAwIF0gKyAyMCApICsgInB4IiApLmNzcyggInRvcCIsIHRoaXMuX3Bvc1sgMSBdICsgInB4IiApOwoJCWluc3Quc2V0dGluZ3Mub25TZWxlY3QgPSBvblNlbGVjdDsKCQl0aGlzLl9pbkRpYWxvZyA9IHRydWU7CgkJdGhpcy5kcERpdi5hZGRDbGFzcyggdGhpcy5fZGlhbG9nQ2xhc3MgKTsKCQl0aGlzLl9zaG93RGF0ZXBpY2tlciggdGhpcy5fZGlhbG9nSW5wdXRbIDAgXSApOwoJCWlmICggJC5ibG9ja1VJICkgewoJCQkkLmJsb2NrVUkoIHRoaXMuZHBEaXYgKTsKCQl9CgkJJC5kYXRhKCB0aGlzLl9kaWFsb2dJbnB1dFsgMCBdLCAiZGF0ZXBpY2tlciIsIGluc3QgKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyogRGV0YWNoIGEgZGF0ZXBpY2tlciBmcm9tIGl0cyBjb250cm9sLgoJICogQHBhcmFtICB0YXJnZXQJZWxlbWVudCAtIHRoZSB0YXJnZXQgaW5wdXQgZmllbGQgb3IgZGl2aXNpb24gb3Igc3BhbgoJICovCglfZGVzdHJveURhdGVwaWNrZXI6IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkJdmFyIG5vZGVOYW1lLAoJCQkkdGFyZ2V0ID0gJCggdGFyZ2V0ICksCgkJCWluc3QgPSAkLmRhdGEoIHRhcmdldCwgImRhdGVwaWNrZXIiICk7CgoJCWlmICggISR0YXJnZXQuaGFzQ2xhc3MoIHRoaXMubWFya2VyQ2xhc3NOYW1lICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCW5vZGVOYW1lID0gdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJJC5yZW1vdmVEYXRhKCB0YXJnZXQsICJkYXRlcGlja2VyIiApOwoJCWlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgKSB7CgkJCWluc3QuYXBwZW5kLnJlbW92ZSgpOwoJCQlpbnN0LnRyaWdnZXIucmVtb3ZlKCk7CgkJCSR0YXJnZXQucmVtb3ZlQ2xhc3MoIHRoaXMubWFya2VyQ2xhc3NOYW1lICkuCgkJCQlvZmYoICJmb2N1cyIsIHRoaXMuX3Nob3dEYXRlcGlja2VyICkuCgkJCQlvZmYoICJrZXlkb3duIiwgdGhpcy5fZG9LZXlEb3duICkuCgkJCQlvZmYoICJrZXlwcmVzcyIsIHRoaXMuX2RvS2V5UHJlc3MgKS4KCQkJCW9mZiggImtleXVwIiwgdGhpcy5fZG9LZXlVcCApOwoJCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiZGl2IiB8fCBub2RlTmFtZSA9PT0gInNwYW4iICkgewoJCQkkdGFyZ2V0LnJlbW92ZUNsYXNzKCB0aGlzLm1hcmtlckNsYXNzTmFtZSApLmVtcHR5KCk7CgkJfQoKCQlpZiAoIGRhdGVwaWNrZXJfaW5zdEFjdGl2ZSA9PT0gaW5zdCApIHsKCQkJZGF0ZXBpY2tlcl9pbnN0QWN0aXZlID0gbnVsbDsKCQl9Cgl9LAoKCS8qIEVuYWJsZSB0aGUgZGF0ZSBwaWNrZXIgdG8gYSBqUXVlcnkgc2VsZWN0aW9uLgoJICogQHBhcmFtICB0YXJnZXQJZWxlbWVudCAtIHRoZSB0YXJnZXQgaW5wdXQgZmllbGQgb3IgZGl2aXNpb24gb3Igc3BhbgoJICovCglfZW5hYmxlRGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgbm9kZU5hbWUsIGlubGluZSwKCQkJJHRhcmdldCA9ICQoIHRhcmdldCApLAoJCQlpbnN0ID0gJC5kYXRhKCB0YXJnZXQsICJkYXRlcGlja2VyIiApOwoKCQlpZiAoICEkdGFyZ2V0Lmhhc0NsYXNzKCB0aGlzLm1hcmtlckNsYXNzTmFtZSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlub2RlTmFtZSA9IHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCWlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgKSB7CgkJCXRhcmdldC5kaXNhYmxlZCA9IGZhbHNlOwoJCQlpbnN0LnRyaWdnZXIuZmlsdGVyKCAiYnV0dG9uIiApLgoJCQkJZWFjaCggZnVuY3Rpb24oKSB7IHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsgfSApLmVuZCgpLgoJCQkJZmlsdGVyKCAiaW1nIiApLmNzcyggeyBvcGFjaXR5OiAiMS4wIiwgY3Vyc29yOiAiIiB9ICk7CgkJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJkaXYiIHx8IG5vZGVOYW1lID09PSAic3BhbiIgKSB7CgkJCWlubGluZSA9ICR0YXJnZXQuY2hpbGRyZW4oICIuIiArIHRoaXMuX2lubGluZUNsYXNzICk7CgkJCWlubGluZS5jaGlsZHJlbigpLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7CgkJCWlubGluZS5maW5kKCAic2VsZWN0LnVpLWRhdGVwaWNrZXItbW9udGgsIHNlbGVjdC51aS1kYXRlcGlja2VyLXllYXIiICkuCgkJCQlwcm9wKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCX0KCQl0aGlzLl9kaXNhYmxlZElucHV0cyA9ICQubWFwKCB0aGlzLl9kaXNhYmxlZElucHV0cywKCQkJZnVuY3Rpb24oIHZhbHVlICkgeyByZXR1cm4gKCB2YWx1ZSA9PT0gdGFyZ2V0ID8gbnVsbCA6IHZhbHVlICk7IH0gKTsgLy8gZGVsZXRlIGVudHJ5Cgl9LAoKCS8qIERpc2FibGUgdGhlIGRhdGUgcGlja2VyIHRvIGEgalF1ZXJ5IHNlbGVjdGlvbi4KCSAqIEBwYXJhbSAgdGFyZ2V0CWVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4KCSAqLwoJX2Rpc2FibGVEYXRlcGlja2VyOiBmdW5jdGlvbiggdGFyZ2V0ICkgewoJCXZhciBub2RlTmFtZSwgaW5saW5lLAoJCQkkdGFyZ2V0ID0gJCggdGFyZ2V0ICksCgkJCWluc3QgPSAkLmRhdGEoIHRhcmdldCwgImRhdGVwaWNrZXIiICk7CgoJCWlmICggISR0YXJnZXQuaGFzQ2xhc3MoIHRoaXMubWFya2VyQ2xhc3NOYW1lICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCW5vZGVOYW1lID0gdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiApIHsKCQkJdGFyZ2V0LmRpc2FibGVkID0gdHJ1ZTsKCQkJaW5zdC50cmlnZ2VyLmZpbHRlciggImJ1dHRvbiIgKS4KCQkJCWVhY2goIGZ1bmN0aW9uKCkgeyB0aGlzLmRpc2FibGVkID0gdHJ1ZTsgfSApLmVuZCgpLgoJCQkJZmlsdGVyKCAiaW1nIiApLmNzcyggeyBvcGFjaXR5OiAiMC41IiwgY3Vyc29yOiAiZGVmYXVsdCIgfSApOwoJCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiZGl2IiB8fCBub2RlTmFtZSA9PT0gInNwYW4iICkgewoJCQlpbmxpbmUgPSAkdGFyZ2V0LmNoaWxkcmVuKCAiLiIgKyB0aGlzLl9pbmxpbmVDbGFzcyApOwoJCQlpbmxpbmUuY2hpbGRyZW4oKS5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCQlpbmxpbmUuZmluZCggInNlbGVjdC51aS1kYXRlcGlja2VyLW1vbnRoLCBzZWxlY3QudWktZGF0ZXBpY2tlci15ZWFyIiApLgoJCQkJcHJvcCggImRpc2FibGVkIiwgdHJ1ZSApOwoJCX0KCQl0aGlzLl9kaXNhYmxlZElucHV0cyA9ICQubWFwKCB0aGlzLl9kaXNhYmxlZElucHV0cywKCQkJZnVuY3Rpb24oIHZhbHVlICkgeyByZXR1cm4gKCB2YWx1ZSA9PT0gdGFyZ2V0ID8gbnVsbCA6IHZhbHVlICk7IH0gKTsgLy8gZGVsZXRlIGVudHJ5CgkJdGhpcy5fZGlzYWJsZWRJbnB1dHNbIHRoaXMuX2Rpc2FibGVkSW5wdXRzLmxlbmd0aCBdID0gdGFyZ2V0OwoJfSwKCgkvKiBJcyB0aGUgZmlyc3QgZmllbGQgaW4gYSBqUXVlcnkgY29sbGVjdGlvbiBkaXNhYmxlZCBhcyBhIGRhdGVwaWNrZXI/CgkgKiBAcGFyYW0gIHRhcmdldAllbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuCgkgKiBAcmV0dXJuIGJvb2xlYW4gLSB0cnVlIGlmIGRpc2FibGVkLCBmYWxzZSBpZiBlbmFibGVkCgkgKi8KCV9pc0Rpc2FibGVkRGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCApIHsKCQlpZiAoICF0YXJnZXQgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJZm9yICggdmFyIGkgPSAwOyBpIDwgdGhpcy5fZGlzYWJsZWRJbnB1dHMubGVuZ3RoOyBpKysgKSB7CgkJCWlmICggdGhpcy5fZGlzYWJsZWRJbnB1dHNbIGkgXSA9PT0gdGFyZ2V0ICkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCgkvKiBSZXRyaWV2ZSB0aGUgaW5zdGFuY2UgZGF0YSBmb3IgdGhlIHRhcmdldCBjb250cm9sLgoJICogQHBhcmFtICB0YXJnZXQgIGVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4KCSAqIEByZXR1cm4gIG9iamVjdCAtIHRoZSBhc3NvY2lhdGVkIGluc3RhbmNlIGRhdGEKCSAqIEB0aHJvd3MgIGVycm9yIGlmIGEgalF1ZXJ5IHByb2JsZW0gZ2V0dGluZyBkYXRhCgkgKi8KCV9nZXRJbnN0OiBmdW5jdGlvbiggdGFyZ2V0ICkgewoJCXRyeSB7CgkJCXJldHVybiAkLmRhdGEoIHRhcmdldCwgImRhdGVwaWNrZXIiICk7CgkJfQoJCWNhdGNoICggZXJyICkgewoJCQl0aHJvdyAiTWlzc2luZyBpbnN0YW5jZSBkYXRhIGZvciB0aGlzIGRhdGVwaWNrZXIiOwoJCX0KCX0sCgoJLyogVXBkYXRlIG9yIHJldHJpZXZlIHRoZSBzZXR0aW5ncyBmb3IgYSBkYXRlIHBpY2tlciBhdHRhY2hlZCB0byBhbiBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbi4KCSAqIEBwYXJhbSAgdGFyZ2V0ICBlbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuCgkgKiBAcGFyYW0gIG5hbWUJb2JqZWN0IC0gdGhlIG5ldyBzZXR0aW5ncyB0byB1cGRhdGUgb3IKCSAqCQkJCXN0cmluZyAtIHRoZSBuYW1lIG9mIHRoZSBzZXR0aW5nIHRvIGNoYW5nZSBvciByZXRyaWV2ZSwKCSAqCQkJCXdoZW4gcmV0cmlldmluZyBhbHNvICJhbGwiIGZvciBhbGwgaW5zdGFuY2Ugc2V0dGluZ3Mgb3IKCSAqCQkJCSJkZWZhdWx0cyIgZm9yIGFsbCBnbG9iYWwgZGVmYXVsdHMKCSAqIEBwYXJhbSAgdmFsdWUgICBhbnkgLSB0aGUgbmV3IHZhbHVlIGZvciB0aGUgc2V0dGluZwoJICoJCQkJKG9taXQgaWYgYWJvdmUgaXMgYW4gb2JqZWN0IG9yIHRvIHJldHJpZXZlIGEgdmFsdWUpCgkgKi8KCV9vcHRpb25EYXRlcGlja2VyOiBmdW5jdGlvbiggdGFyZ2V0LCBuYW1lLCB2YWx1ZSApIHsKCQl2YXIgc2V0dGluZ3MsIGRhdGUsIG1pbkRhdGUsIG1heERhdGUsCgkJCWluc3QgPSB0aGlzLl9nZXRJbnN0KCB0YXJnZXQgKTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICYmIHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuICggbmFtZSA9PT0gImRlZmF1bHRzIiA/ICQuZXh0ZW5kKCB7fSwgJC5kYXRlcGlja2VyLl9kZWZhdWx0cyApIDoKCQkJCSggaW5zdCA/ICggbmFtZSA9PT0gImFsbCIgPyAkLmV4dGVuZCgge30sIGluc3Quc2V0dGluZ3MgKSA6CgkJCQl0aGlzLl9nZXQoIGluc3QsIG5hbWUgKSApIDogbnVsbCApICk7CgkJfQoKCQlzZXR0aW5ncyA9IG5hbWUgfHwge307CgkJaWYgKCB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgKSB7CgkJCXNldHRpbmdzID0ge307CgkJCXNldHRpbmdzWyBuYW1lIF0gPSB2YWx1ZTsKCQl9CgoJCWlmICggaW5zdCApIHsKCQkJaWYgKCB0aGlzLl9jdXJJbnN0ID09PSBpbnN0ICkgewoJCQkJdGhpcy5faGlkZURhdGVwaWNrZXIoKTsKCQkJfQoKCQkJZGF0ZSA9IHRoaXMuX2dldERhdGVEYXRlcGlja2VyKCB0YXJnZXQsIHRydWUgKTsKCQkJbWluRGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoIGluc3QsICJtaW4iICk7CgkJCW1heERhdGUgPSB0aGlzLl9nZXRNaW5NYXhEYXRlKCBpbnN0LCAibWF4IiApOwoJCQlkYXRlcGlja2VyX2V4dGVuZFJlbW92ZSggaW5zdC5zZXR0aW5ncywgc2V0dGluZ3MgKTsKCgkJCS8vIHJlZm9ybWF0IHRoZSBvbGQgbWluRGF0ZS9tYXhEYXRlIHZhbHVlcyBpZiBkYXRlRm9ybWF0IGNoYW5nZXMgYW5kIGEgbmV3IG1pbkRhdGUvbWF4RGF0ZSBpc24ndCBwcm92aWRlZAoJCQlpZiAoIG1pbkRhdGUgIT09IG51bGwgJiYgc2V0dGluZ3MuZGF0ZUZvcm1hdCAhPT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLm1pbkRhdGUgPT09IHVuZGVmaW5lZCApIHsKCQkJCWluc3Quc2V0dGluZ3MubWluRGF0ZSA9IHRoaXMuX2Zvcm1hdERhdGUoIGluc3QsIG1pbkRhdGUgKTsKCQkJfQoJCQlpZiAoIG1heERhdGUgIT09IG51bGwgJiYgc2V0dGluZ3MuZGF0ZUZvcm1hdCAhPT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLm1heERhdGUgPT09IHVuZGVmaW5lZCApIHsKCQkJCWluc3Quc2V0dGluZ3MubWF4RGF0ZSA9IHRoaXMuX2Zvcm1hdERhdGUoIGluc3QsIG1heERhdGUgKTsKCQkJfQoJCQlpZiAoICJkaXNhYmxlZCIgaW4gc2V0dGluZ3MgKSB7CgkJCQlpZiAoIHNldHRpbmdzLmRpc2FibGVkICkgewoJCQkJCXRoaXMuX2Rpc2FibGVEYXRlcGlja2VyKCB0YXJnZXQgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5fZW5hYmxlRGF0ZXBpY2tlciggdGFyZ2V0ICk7CgkJCQl9CgkJCX0KCQkJdGhpcy5fYXR0YWNobWVudHMoICQoIHRhcmdldCApLCBpbnN0ICk7CgkJCXRoaXMuX2F1dG9TaXplKCBpbnN0ICk7CgkJCXRoaXMuX3NldERhdGUoIGluc3QsIGRhdGUgKTsKCQkJdGhpcy5fdXBkYXRlQWx0ZXJuYXRlKCBpbnN0ICk7CgkJCXRoaXMuX3VwZGF0ZURhdGVwaWNrZXIoIGluc3QgKTsKCQl9Cgl9LAoKCS8vIENoYW5nZSBtZXRob2QgZGVwcmVjYXRlZAoJX2NoYW5nZURhdGVwaWNrZXI6IGZ1bmN0aW9uKCB0YXJnZXQsIG5hbWUsIHZhbHVlICkgewoJCXRoaXMuX29wdGlvbkRhdGVwaWNrZXIoIHRhcmdldCwgbmFtZSwgdmFsdWUgKTsKCX0sCgoJLyogUmVkcmF3IHRoZSBkYXRlIHBpY2tlciBhdHRhY2hlZCB0byBhbiBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbi4KCSAqIEBwYXJhbSAgdGFyZ2V0ICBlbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuCgkgKi8KCV9yZWZyZXNoRGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgaW5zdCA9IHRoaXMuX2dldEluc3QoIHRhcmdldCApOwoJCWlmICggaW5zdCApIHsKCQkJdGhpcy5fdXBkYXRlRGF0ZXBpY2tlciggaW5zdCApOwoJCX0KCX0sCgoJLyogU2V0IHRoZSBkYXRlcyBmb3IgYSBqUXVlcnkgc2VsZWN0aW9uLgoJICogQHBhcmFtICB0YXJnZXQgZWxlbWVudCAtIHRoZSB0YXJnZXQgaW5wdXQgZmllbGQgb3IgZGl2aXNpb24gb3Igc3BhbgoJICogQHBhcmFtICBkYXRlCURhdGUgLSB0aGUgbmV3IGRhdGUKCSAqLwoJX3NldERhdGVEYXRlcGlja2VyOiBmdW5jdGlvbiggdGFyZ2V0LCBkYXRlICkgewoJCXZhciBpbnN0ID0gdGhpcy5fZ2V0SW5zdCggdGFyZ2V0ICk7CgkJaWYgKCBpbnN0ICkgewoJCQl0aGlzLl9zZXREYXRlKCBpbnN0LCBkYXRlICk7CgkJCXRoaXMuX3VwZGF0ZURhdGVwaWNrZXIoIGluc3QgKTsKCQkJdGhpcy5fdXBkYXRlQWx0ZXJuYXRlKCBpbnN0ICk7CgkJfQoJfSwKCgkvKiBHZXQgdGhlIGRhdGUocykgZm9yIHRoZSBmaXJzdCBlbnRyeSBpbiBhIGpRdWVyeSBzZWxlY3Rpb24uCgkgKiBAcGFyYW0gIHRhcmdldCBlbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuCgkgKiBAcGFyYW0gIG5vRGVmYXVsdCBib29sZWFuIC0gdHJ1ZSBpZiBubyBkZWZhdWx0IGRhdGUgaXMgdG8gYmUgdXNlZAoJICogQHJldHVybiBEYXRlIC0gdGhlIGN1cnJlbnQgZGF0ZQoJICovCglfZ2V0RGF0ZURhdGVwaWNrZXI6IGZ1bmN0aW9uKCB0YXJnZXQsIG5vRGVmYXVsdCApIHsKCQl2YXIgaW5zdCA9IHRoaXMuX2dldEluc3QoIHRhcmdldCApOwoJCWlmICggaW5zdCAmJiAhaW5zdC5pbmxpbmUgKSB7CgkJCXRoaXMuX3NldERhdGVGcm9tRmllbGQoIGluc3QsIG5vRGVmYXVsdCApOwoJCX0KCQlyZXR1cm4gKCBpbnN0ID8gdGhpcy5fZ2V0RGF0ZSggaW5zdCApIDogbnVsbCApOwoJfSwKCgkvKiBIYW5kbGUga2V5c3Ryb2tlcy4gKi8KCV9kb0tleURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgb25TZWxlY3QsIGRhdGVTdHIsIHNlbCwKCQkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdCggZXZlbnQudGFyZ2V0ICksCgkJCWhhbmRsZWQgPSB0cnVlLAoJCQlpc1JUTCA9IGluc3QuZHBEaXYuaXMoICIudWktZGF0ZXBpY2tlci1ydGwiICk7CgoJCWluc3QuX2tleUV2ZW50ID0gdHJ1ZTsKCQlpZiAoICQuZGF0ZXBpY2tlci5fZGF0ZXBpY2tlclNob3dpbmcgKSB7CgkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQljYXNlIDk6ICQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoKTsKCQkJCQkJaGFuZGxlZCA9IGZhbHNlOwoJCQkJCQlicmVhazsgLy8gaGlkZSBvbiB0YWIgb3V0CgkJCQljYXNlIDEzOiBzZWwgPSAkKCAidGQuIiArICQuZGF0ZXBpY2tlci5fZGF5T3ZlckNsYXNzICsgIjpub3QoLiIgKwoJCQkJCQkJCQkkLmRhdGVwaWNrZXIuX2N1cnJlbnRDbGFzcyArICIpIiwgaW5zdC5kcERpdiApOwoJCQkJCQlpZiAoIHNlbFsgMCBdICkgewoJCQkJCQkJJC5kYXRlcGlja2VyLl9zZWxlY3REYXkoIGV2ZW50LnRhcmdldCwgaW5zdC5zZWxlY3RlZE1vbnRoLCBpbnN0LnNlbGVjdGVkWWVhciwgc2VsWyAwIF0gKTsKCQkJCQkJfQoKCQkJCQkJb25TZWxlY3QgPSAkLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgIm9uU2VsZWN0IiApOwoJCQkJCQlpZiAoIG9uU2VsZWN0ICkgewoJCQkJCQkJZGF0ZVN0ciA9ICQuZGF0ZXBpY2tlci5fZm9ybWF0RGF0ZSggaW5zdCApOwoKCQkJCQkJCS8vIFRyaWdnZXIgY3VzdG9tIGNhbGxiYWNrCgkJCQkJCQlvblNlbGVjdC5hcHBseSggKCBpbnN0LmlucHV0ID8gaW5zdC5pbnB1dFsgMCBdIDogbnVsbCApLCBbIGRhdGVTdHIsIGluc3QgXSApOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJJC5kYXRlcGlja2VyLl9oaWRlRGF0ZXBpY2tlcigpOwoJCQkJCQl9CgoJCQkJCQlyZXR1cm4gZmFsc2U7IC8vIGRvbid0IHN1Ym1pdCB0aGUgZm9ybQoJCQkJY2FzZSAyNzogJC5kYXRlcGlja2VyLl9oaWRlRGF0ZXBpY2tlcigpOwoJCQkJCQlicmVhazsgLy8gaGlkZSBvbiBlc2NhcGUKCQkJCWNhc2UgMzM6ICQuZGF0ZXBpY2tlci5fYWRqdXN0RGF0ZSggZXZlbnQudGFyZ2V0LCAoIGV2ZW50LmN0cmxLZXkgPwoJCQkJCQkJLSQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic3RlcEJpZ01vbnRocyIgKSA6CgkJCQkJCQktJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJzdGVwTW9udGhzIiApICksICJNIiApOwoJCQkJCQlicmVhazsgLy8gcHJldmlvdXMgbW9udGgveWVhciBvbiBwYWdlIHVwLysgY3RybAoJCQkJY2FzZSAzNDogJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKCBldmVudC50YXJnZXQsICggZXZlbnQuY3RybEtleSA/CgkJCQkJCQkrJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJzdGVwQmlnTW9udGhzIiApIDoKCQkJCQkJCSskLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInN0ZXBNb250aHMiICkgKSwgIk0iICk7CgkJCQkJCWJyZWFrOyAvLyBuZXh0IG1vbnRoL3llYXIgb24gcGFnZSBkb3duLysgY3RybAoJCQkJY2FzZSAzNTogaWYgKCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgKSB7CgkJCQkJCQkkLmRhdGVwaWNrZXIuX2NsZWFyRGF0ZSggZXZlbnQudGFyZ2V0ICk7CgkJCQkJCX0KCQkJCQkJaGFuZGxlZCA9IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleTsKCQkJCQkJYnJlYWs7IC8vIGNsZWFyIG9uIGN0cmwgb3IgY29tbWFuZCArZW5kCgkJCQljYXNlIDM2OiBpZiAoIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSApIHsKCQkJCQkJCSQuZGF0ZXBpY2tlci5fZ290b1RvZGF5KCBldmVudC50YXJnZXQgKTsKCQkJCQkJfQoJCQkJCQloYW5kbGVkID0gZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5OwoJCQkJCQlicmVhazsgLy8gY3VycmVudCBvbiBjdHJsIG9yIGNvbW1hbmQgK2hvbWUKCQkJCWNhc2UgMzc6IGlmICggZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5ICkgewoJCQkJCQkJJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKCBldmVudC50YXJnZXQsICggaXNSVEwgPyArMSA6IC0xICksICJEIiApOwoJCQkJCQl9CgkJCQkJCWhhbmRsZWQgPSBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXk7CgoJCQkJCQkvLyAtMSBkYXkgb24gY3RybCBvciBjb21tYW5kICtsZWZ0CgkJCQkJCWlmICggZXZlbnQub3JpZ2luYWxFdmVudC5hbHRLZXkgKSB7CgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGV2ZW50LnRhcmdldCwgKCBldmVudC5jdHJsS2V5ID8KCQkJCQkJCQktJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJzdGVwQmlnTW9udGhzIiApIDoKCQkJCQkJCQktJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJzdGVwTW9udGhzIiApICksICJNIiApOwoJCQkJCQl9CgoJCQkJCQkvLyBuZXh0IG1vbnRoL3llYXIgb24gYWx0ICtsZWZ0IG9uIE1hYwoJCQkJCQlicmVhazsKCQkJCWNhc2UgMzg6IGlmICggZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5ICkgewoJCQkJCQkJJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKCBldmVudC50YXJnZXQsIC03LCAiRCIgKTsKCQkJCQkJfQoJCQkJCQloYW5kbGVkID0gZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5OwoJCQkJCQlicmVhazsgLy8gLTEgd2VlayBvbiBjdHJsIG9yIGNvbW1hbmQgK3VwCgkJCQljYXNlIDM5OiBpZiAoIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSApIHsKCQkJCQkJCSQuZGF0ZXBpY2tlci5fYWRqdXN0RGF0ZSggZXZlbnQudGFyZ2V0LCAoIGlzUlRMID8gLTEgOiArMSApLCAiRCIgKTsKCQkJCQkJfQoJCQkJCQloYW5kbGVkID0gZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5OwoKCQkJCQkJLy8gKzEgZGF5IG9uIGN0cmwgb3IgY29tbWFuZCArcmlnaHQKCQkJCQkJaWYgKCBldmVudC5vcmlnaW5hbEV2ZW50LmFsdEtleSApIHsKCQkJCQkJCSQuZGF0ZXBpY2tlci5fYWRqdXN0RGF0ZSggZXZlbnQudGFyZ2V0LCAoIGV2ZW50LmN0cmxLZXkgPwoJCQkJCQkJCSskLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInN0ZXBCaWdNb250aHMiICkgOgoJCQkJCQkJCSskLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInN0ZXBNb250aHMiICkgKSwgIk0iICk7CgkJCQkJCX0KCgkJCQkJCS8vIG5leHQgbW9udGgveWVhciBvbiBhbHQgK3JpZ2h0CgkJCQkJCWJyZWFrOwoJCQkJY2FzZSA0MDogaWYgKCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgKSB7CgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGV2ZW50LnRhcmdldCwgKzcsICJEIiApOwoJCQkJCQl9CgkJCQkJCWhhbmRsZWQgPSBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXk7CgkJCQkJCWJyZWFrOyAvLyArMSB3ZWVrIG9uIGN0cmwgb3IgY29tbWFuZCArZG93bgoJCQkJZGVmYXVsdDogaGFuZGxlZCA9IGZhbHNlOwoJCQl9CgkJfSBlbHNlIGlmICggZXZlbnQua2V5Q29kZSA9PT0gMzYgJiYgZXZlbnQuY3RybEtleSApIHsgLy8gZGlzcGxheSB0aGUgZGF0ZSBwaWNrZXIgb24gY3RybCtob21lCgkJCSQuZGF0ZXBpY2tlci5fc2hvd0RhdGVwaWNrZXIoIHRoaXMgKTsKCQl9IGVsc2UgewoJCQloYW5kbGVkID0gZmFsc2U7CgkJfQoKCQlpZiAoIGhhbmRsZWQgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCX0KCX0sCgoJLyogRmlsdGVyIGVudGVyZWQgY2hhcmFjdGVycyAtIGJhc2VkIG9uIGRhdGUgZm9ybWF0LiAqLwoJX2RvS2V5UHJlc3M6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgY2hhcnMsIGNociwKCQkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdCggZXZlbnQudGFyZ2V0ICk7CgoJCWlmICggJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJjb25zdHJhaW5JbnB1dCIgKSApIHsKCQkJY2hhcnMgPSAkLmRhdGVwaWNrZXIuX3Bvc3NpYmxlQ2hhcnMoICQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAiZGF0ZUZvcm1hdCIgKSApOwoJCQljaHIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCBldmVudC5jaGFyQ29kZSA9PSBudWxsID8gZXZlbnQua2V5Q29kZSA6IGV2ZW50LmNoYXJDb2RlICk7CgkJCXJldHVybiBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgfHwgKCBjaHIgPCAiICIgfHwgIWNoYXJzIHx8IGNoYXJzLmluZGV4T2YoIGNociApID4gLTEgKTsKCQl9Cgl9LAoKCS8qIFN5bmNocm9uaXNlIG1hbnVhbCBlbnRyeSBhbmQgZmllbGQvYWx0ZXJuYXRlIGZpZWxkLiAqLwoJX2RvS2V5VXA6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgZGF0ZSwKCQkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdCggZXZlbnQudGFyZ2V0ICk7CgoJCWlmICggaW5zdC5pbnB1dC52YWwoKSAhPT0gaW5zdC5sYXN0VmFsICkgewoJCQl0cnkgewoJCQkJZGF0ZSA9ICQuZGF0ZXBpY2tlci5wYXJzZURhdGUoICQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAiZGF0ZUZvcm1hdCIgKSwKCQkJCQkoIGluc3QuaW5wdXQgPyBpbnN0LmlucHV0LnZhbCgpIDogbnVsbCApLAoJCQkJCSQuZGF0ZXBpY2tlci5fZ2V0Rm9ybWF0Q29uZmlnKCBpbnN0ICkgKTsKCgkJCQlpZiAoIGRhdGUgKSB7IC8vIG9ubHkgaWYgdmFsaWQKCQkJCQkkLmRhdGVwaWNrZXIuX3NldERhdGVGcm9tRmllbGQoIGluc3QgKTsKCQkJCQkkLmRhdGVwaWNrZXIuX3VwZGF0ZUFsdGVybmF0ZSggaW5zdCApOwoJCQkJCSQuZGF0ZXBpY2tlci5fdXBkYXRlRGF0ZXBpY2tlciggaW5zdCApOwoJCQkJfQoJCQl9CgkJCWNhdGNoICggZXJyICkgewoJCQl9CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCgkvKiBQb3AtdXAgdGhlIGRhdGUgcGlja2VyIGZvciBhIGdpdmVuIGlucHV0IGZpZWxkLgoJICogSWYgZmFsc2UgcmV0dXJuZWQgZnJvbSBiZWZvcmVTaG93IGV2ZW50IGhhbmRsZXIgZG8gbm90IHNob3cuCgkgKiBAcGFyYW0gIGlucHV0ICBlbGVtZW50IC0gdGhlIGlucHV0IGZpZWxkIGF0dGFjaGVkIHRvIHRoZSBkYXRlIHBpY2tlciBvcgoJICoJCQkJCWV2ZW50IC0gaWYgdHJpZ2dlcmVkIGJ5IGZvY3VzCgkgKi8KCV9zaG93RGF0ZXBpY2tlcjogZnVuY3Rpb24oIGlucHV0ICkgewoJCWlucHV0ID0gaW5wdXQudGFyZ2V0IHx8IGlucHV0OwoJCWlmICggaW5wdXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gImlucHV0IiApIHsgLy8gZmluZCBmcm9tIGJ1dHRvbi9pbWFnZSB0cmlnZ2VyCgkJCWlucHV0ID0gJCggImlucHV0IiwgaW5wdXQucGFyZW50Tm9kZSApWyAwIF07CgkJfQoKCQlpZiAoICQuZGF0ZXBpY2tlci5faXNEaXNhYmxlZERhdGVwaWNrZXIoIGlucHV0ICkgfHwgJC5kYXRlcGlja2VyLl9sYXN0SW5wdXQgPT09IGlucHV0ICkgeyAvLyBhbHJlYWR5IGhlcmUKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGluc3QsIGJlZm9yZVNob3csIGJlZm9yZVNob3dTZXR0aW5ncywgaXNGaXhlZCwKCQkJb2Zmc2V0LCBzaG93QW5pbSwgZHVyYXRpb247CgoJCWluc3QgPSAkLmRhdGVwaWNrZXIuX2dldEluc3QoIGlucHV0ICk7CgkJaWYgKCAkLmRhdGVwaWNrZXIuX2N1ckluc3QgJiYgJC5kYXRlcGlja2VyLl9jdXJJbnN0ICE9PSBpbnN0ICkgewoJCQkkLmRhdGVwaWNrZXIuX2N1ckluc3QuZHBEaXYuc3RvcCggdHJ1ZSwgdHJ1ZSApOwoJCQlpZiAoIGluc3QgJiYgJC5kYXRlcGlja2VyLl9kYXRlcGlja2VyU2hvd2luZyApIHsKCQkJCSQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoICQuZGF0ZXBpY2tlci5fY3VySW5zdC5pbnB1dFsgMCBdICk7CgkJCX0KCQl9CgoJCWJlZm9yZVNob3cgPSAkLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgImJlZm9yZVNob3ciICk7CgkJYmVmb3JlU2hvd1NldHRpbmdzID0gYmVmb3JlU2hvdyA/IGJlZm9yZVNob3cuYXBwbHkoIGlucHV0LCBbIGlucHV0LCBpbnN0IF0gKSA6IHt9OwoJCWlmICggYmVmb3JlU2hvd1NldHRpbmdzID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCQlkYXRlcGlja2VyX2V4dGVuZFJlbW92ZSggaW5zdC5zZXR0aW5ncywgYmVmb3JlU2hvd1NldHRpbmdzICk7CgoJCWluc3QubGFzdFZhbCA9IG51bGw7CgkJJC5kYXRlcGlja2VyLl9sYXN0SW5wdXQgPSBpbnB1dDsKCQkkLmRhdGVwaWNrZXIuX3NldERhdGVGcm9tRmllbGQoIGluc3QgKTsKCgkJaWYgKCAkLmRhdGVwaWNrZXIuX2luRGlhbG9nICkgeyAvLyBoaWRlIGN1cnNvcgoJCQlpbnB1dC52YWx1ZSA9ICIiOwoJCX0KCQlpZiAoICEkLmRhdGVwaWNrZXIuX3BvcyApIHsgLy8gcG9zaXRpb24gYmVsb3cgaW5wdXQKCQkJJC5kYXRlcGlja2VyLl9wb3MgPSAkLmRhdGVwaWNrZXIuX2ZpbmRQb3MoIGlucHV0ICk7CgkJCSQuZGF0ZXBpY2tlci5fcG9zWyAxIF0gKz0gaW5wdXQub2Zmc2V0SGVpZ2h0OyAvLyBhZGQgdGhlIGhlaWdodAoJCX0KCgkJaXNGaXhlZCA9IGZhbHNlOwoJCSQoIGlucHV0ICkucGFyZW50cygpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlpc0ZpeGVkIHw9ICQoIHRoaXMgKS5jc3MoICJwb3NpdGlvbiIgKSA9PT0gImZpeGVkIjsKCQkJcmV0dXJuICFpc0ZpeGVkOwoJCX0gKTsKCgkJb2Zmc2V0ID0geyBsZWZ0OiAkLmRhdGVwaWNrZXIuX3Bvc1sgMCBdLCB0b3A6ICQuZGF0ZXBpY2tlci5fcG9zWyAxIF0gfTsKCQkkLmRhdGVwaWNrZXIuX3BvcyA9IG51bGw7CgoJCS8vdG8gYXZvaWQgZmxhc2hlcyBvbiBGaXJlZm94CgkJaW5zdC5kcERpdi5lbXB0eSgpOwoKCQkvLyBkZXRlcm1pbmUgc2l6aW5nIG9mZnNjcmVlbgoJCWluc3QuZHBEaXYuY3NzKCB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCBkaXNwbGF5OiAiYmxvY2siLCB0b3A6ICItMTAwMHB4IiB9ICk7CgkJJC5kYXRlcGlja2VyLl91cGRhdGVEYXRlcGlja2VyKCBpbnN0ICk7CgoJCS8vIGZpeCB3aWR0aCBmb3IgZHluYW1pYyBudW1iZXIgb2YgZGF0ZSBwaWNrZXJzCgkJLy8gYW5kIGFkanVzdCBwb3NpdGlvbiBiZWZvcmUgc2hvd2luZwoJCW9mZnNldCA9ICQuZGF0ZXBpY2tlci5fY2hlY2tPZmZzZXQoIGluc3QsIG9mZnNldCwgaXNGaXhlZCApOwoJCWluc3QuZHBEaXYuY3NzKCB7IHBvc2l0aW9uOiAoICQuZGF0ZXBpY2tlci5faW5EaWFsb2cgJiYgJC5ibG9ja1VJID8KCQkJInN0YXRpYyIgOiAoIGlzRml4ZWQgPyAiZml4ZWQiIDogImFic29sdXRlIiApICksIGRpc3BsYXk6ICJub25lIiwKCQkJbGVmdDogb2Zmc2V0LmxlZnQgKyAicHgiLCB0b3A6IG9mZnNldC50b3AgKyAicHgiIH0gKTsKCgkJaWYgKCAhaW5zdC5pbmxpbmUgKSB7CgkJCXNob3dBbmltID0gJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJzaG93QW5pbSIgKTsKCQkJZHVyYXRpb24gPSAkLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgImR1cmF0aW9uIiApOwoJCQlpbnN0LmRwRGl2LmNzcyggInotaW5kZXgiLCBkYXRlcGlja2VyX2dldFppbmRleCggJCggaW5wdXQgKSApICsgMSApOwoJCQkkLmRhdGVwaWNrZXIuX2RhdGVwaWNrZXJTaG93aW5nID0gdHJ1ZTsKCgkJCWlmICggJC5lZmZlY3RzICYmICQuZWZmZWN0cy5lZmZlY3RbIHNob3dBbmltIF0gKSB7CgkJCQlpbnN0LmRwRGl2LnNob3coIHNob3dBbmltLCAkLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInNob3dPcHRpb25zIiApLCBkdXJhdGlvbiApOwoJCQl9IGVsc2UgewoJCQkJaW5zdC5kcERpdlsgc2hvd0FuaW0gfHwgInNob3ciIF0oIHNob3dBbmltID8gZHVyYXRpb24gOiBudWxsICk7CgkJCX0KCgkJCWlmICggJC5kYXRlcGlja2VyLl9zaG91bGRGb2N1c0lucHV0KCBpbnN0ICkgKSB7CgkJCQlpbnN0LmlucHV0LnRyaWdnZXIoICJmb2N1cyIgKTsKCQkJfQoKCQkJJC5kYXRlcGlja2VyLl9jdXJJbnN0ID0gaW5zdDsKCQl9Cgl9LAoKCS8qIEdlbmVyYXRlIHRoZSBkYXRlIHBpY2tlciBjb250ZW50LiAqLwoJX3VwZGF0ZURhdGVwaWNrZXI6IGZ1bmN0aW9uKCBpbnN0ICkgewoJCXRoaXMubWF4Um93cyA9IDQ7IC8vUmVzZXQgdGhlIG1heCBudW1iZXIgb2Ygcm93cyBiZWluZyBkaXNwbGF5ZWQgKHNlZSAjNzA0MykKCQlkYXRlcGlja2VyX2luc3RBY3RpdmUgPSBpbnN0OyAvLyBmb3IgZGVsZWdhdGUgaG92ZXIgZXZlbnRzCgkJaW5zdC5kcERpdi5lbXB0eSgpLmFwcGVuZCggdGhpcy5fZ2VuZXJhdGVIVE1MKCBpbnN0ICkgKTsKCQl0aGlzLl9hdHRhY2hIYW5kbGVycyggaW5zdCApOwoKCQl2YXIgb3JpZ3llYXJzaHRtbCwKCQkJbnVtTW9udGhzID0gdGhpcy5fZ2V0TnVtYmVyT2ZNb250aHMoIGluc3QgKSwKCQkJY29scyA9IG51bU1vbnRoc1sgMSBdLAoJCQl3aWR0aCA9IDE3LAoJCQlhY3RpdmVDZWxsID0gaW5zdC5kcERpdi5maW5kKCAiLiIgKyB0aGlzLl9kYXlPdmVyQ2xhc3MgKyAiIGEiICk7CgoJCWlmICggYWN0aXZlQ2VsbC5sZW5ndGggPiAwICkgewoJCQlkYXRlcGlja2VyX2hhbmRsZU1vdXNlb3Zlci5hcHBseSggYWN0aXZlQ2VsbC5nZXQoIDAgKSApOwoJCX0KCgkJaW5zdC5kcERpdi5yZW1vdmVDbGFzcyggInVpLWRhdGVwaWNrZXItbXVsdGktMiB1aS1kYXRlcGlja2VyLW11bHRpLTMgdWktZGF0ZXBpY2tlci1tdWx0aS00IiApLndpZHRoKCAiIiApOwoJCWlmICggY29scyA+IDEgKSB7CgkJCWluc3QuZHBEaXYuYWRkQ2xhc3MoICJ1aS1kYXRlcGlja2VyLW11bHRpLSIgKyBjb2xzICkuY3NzKCAid2lkdGgiLCAoIHdpZHRoICogY29scyApICsgImVtIiApOwoJCX0KCQlpbnN0LmRwRGl2WyAoIG51bU1vbnRoc1sgMCBdICE9PSAxIHx8IG51bU1vbnRoc1sgMSBdICE9PSAxID8gImFkZCIgOiAicmVtb3ZlIiApICsKCQkJIkNsYXNzIiBdKCAidWktZGF0ZXBpY2tlci1tdWx0aSIgKTsKCQlpbnN0LmRwRGl2WyAoIHRoaXMuX2dldCggaW5zdCwgImlzUlRMIiApID8gImFkZCIgOiAicmVtb3ZlIiApICsKCQkJIkNsYXNzIiBdKCAidWktZGF0ZXBpY2tlci1ydGwiICk7CgoJCWlmICggaW5zdCA9PT0gJC5kYXRlcGlja2VyLl9jdXJJbnN0ICYmICQuZGF0ZXBpY2tlci5fZGF0ZXBpY2tlclNob3dpbmcgJiYgJC5kYXRlcGlja2VyLl9zaG91bGRGb2N1c0lucHV0KCBpbnN0ICkgKSB7CgkJCWluc3QuaW5wdXQudHJpZ2dlciggImZvY3VzIiApOwoJCX0KCgkJLy8gRGVmZmVyZWQgcmVuZGVyIG9mIHRoZSB5ZWFycyBzZWxlY3QgKHRvIGF2b2lkIGZsYXNoZXMgb24gRmlyZWZveCkKCQlpZiAoIGluc3QueWVhcnNodG1sICkgewoJCQlvcmlneWVhcnNodG1sID0gaW5zdC55ZWFyc2h0bWw7CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoKCQkJCS8vYXNzdXJlIHRoYXQgaW5zdC55ZWFyc2h0bWwgZGlkbid0IGNoYW5nZS4KCQkJCWlmICggb3JpZ3llYXJzaHRtbCA9PT0gaW5zdC55ZWFyc2h0bWwgJiYgaW5zdC55ZWFyc2h0bWwgKSB7CgkJCQkJaW5zdC5kcERpdi5maW5kKCAic2VsZWN0LnVpLWRhdGVwaWNrZXIteWVhcjpmaXJzdCIgKS5yZXBsYWNlV2l0aCggaW5zdC55ZWFyc2h0bWwgKTsKCQkJCX0KCQkJCW9yaWd5ZWFyc2h0bWwgPSBpbnN0LnllYXJzaHRtbCA9IG51bGw7CgkJCX0sIDAgKTsKCQl9Cgl9LAoKCS8vICM2Njk0IC0gZG9uJ3QgZm9jdXMgdGhlIGlucHV0IGlmIGl0J3MgYWxyZWFkeSBmb2N1c2VkCgkvLyB0aGlzIGJyZWFrcyB0aGUgY2hhbmdlIGV2ZW50IGluIElFCgkvLyBTdXBwb3J0OiBJRSBhbmQgalF1ZXJ5IDwxLjkKCV9zaG91bGRGb2N1c0lucHV0OiBmdW5jdGlvbiggaW5zdCApIHsKCQlyZXR1cm4gaW5zdC5pbnB1dCAmJiBpbnN0LmlucHV0LmlzKCAiOnZpc2libGUiICkgJiYgIWluc3QuaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgJiYgIWluc3QuaW5wdXQuaXMoICI6Zm9jdXMiICk7Cgl9LAoKCS8qIENoZWNrIHBvc2l0aW9uaW5nIHRvIHJlbWFpbiBvbiBzY3JlZW4uICovCglfY2hlY2tPZmZzZXQ6IGZ1bmN0aW9uKCBpbnN0LCBvZmZzZXQsIGlzRml4ZWQgKSB7CgkJdmFyIGRwV2lkdGggPSBpbnN0LmRwRGl2Lm91dGVyV2lkdGgoKSwKCQkJZHBIZWlnaHQgPSBpbnN0LmRwRGl2Lm91dGVySGVpZ2h0KCksCgkJCWlucHV0V2lkdGggPSBpbnN0LmlucHV0ID8gaW5zdC5pbnB1dC5vdXRlcldpZHRoKCkgOiAwLAoJCQlpbnB1dEhlaWdodCA9IGluc3QuaW5wdXQgPyBpbnN0LmlucHV0Lm91dGVySGVpZ2h0KCkgOiAwLAoJCQl2aWV3V2lkdGggPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGggKyAoIGlzRml4ZWQgPyAwIDogJCggZG9jdW1lbnQgKS5zY3JvbGxMZWZ0KCkgKSwKCQkJdmlld0hlaWdodCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQgKyAoIGlzRml4ZWQgPyAwIDogJCggZG9jdW1lbnQgKS5zY3JvbGxUb3AoKSApOwoKCQlvZmZzZXQubGVmdCAtPSAoIHRoaXMuX2dldCggaW5zdCwgImlzUlRMIiApID8gKCBkcFdpZHRoIC0gaW5wdXRXaWR0aCApIDogMCApOwoJCW9mZnNldC5sZWZ0IC09ICggaXNGaXhlZCAmJiBvZmZzZXQubGVmdCA9PT0gaW5zdC5pbnB1dC5vZmZzZXQoKS5sZWZ0ICkgPyAkKCBkb2N1bWVudCApLnNjcm9sbExlZnQoKSA6IDA7CgkJb2Zmc2V0LnRvcCAtPSAoIGlzRml4ZWQgJiYgb2Zmc2V0LnRvcCA9PT0gKCBpbnN0LmlucHV0Lm9mZnNldCgpLnRvcCArIGlucHV0SGVpZ2h0ICkgKSA/ICQoIGRvY3VtZW50ICkuc2Nyb2xsVG9wKCkgOiAwOwoKCQkvLyBOb3cgY2hlY2sgaWYgZGF0ZXBpY2tlciBpcyBzaG93aW5nIG91dHNpZGUgd2luZG93IHZpZXdwb3J0IC0gbW92ZSB0byBhIGJldHRlciBwbGFjZSBpZiBzby4KCQlvZmZzZXQubGVmdCAtPSBNYXRoLm1pbiggb2Zmc2V0LmxlZnQsICggb2Zmc2V0LmxlZnQgKyBkcFdpZHRoID4gdmlld1dpZHRoICYmIHZpZXdXaWR0aCA+IGRwV2lkdGggKSA/CgkJCU1hdGguYWJzKCBvZmZzZXQubGVmdCArIGRwV2lkdGggLSB2aWV3V2lkdGggKSA6IDAgKTsKCQlvZmZzZXQudG9wIC09IE1hdGgubWluKCBvZmZzZXQudG9wLCAoIG9mZnNldC50b3AgKyBkcEhlaWdodCA+IHZpZXdIZWlnaHQgJiYgdmlld0hlaWdodCA+IGRwSGVpZ2h0ICkgPwoJCQlNYXRoLmFicyggZHBIZWlnaHQgKyBpbnB1dEhlaWdodCApIDogMCApOwoKCQlyZXR1cm4gb2Zmc2V0OwoJfSwKCgkvKiBGaW5kIGFuIG9iamVjdCdzIHBvc2l0aW9uIG9uIHRoZSBzY3JlZW4uICovCglfZmluZFBvczogZnVuY3Rpb24oIG9iaiApIHsKCQl2YXIgcG9zaXRpb24sCgkJCWluc3QgPSB0aGlzLl9nZXRJbnN0KCBvYmogKSwKCQkJaXNSVEwgPSB0aGlzLl9nZXQoIGluc3QsICJpc1JUTCIgKTsKCgkJd2hpbGUgKCBvYmogJiYgKCBvYmoudHlwZSA9PT0gImhpZGRlbiIgfHwgb2JqLm5vZGVUeXBlICE9PSAxIHx8ICQuZXhwci5maWx0ZXJzLmhpZGRlbiggb2JqICkgKSApIHsKCQkJb2JqID0gb2JqWyBpc1JUTCA/ICJwcmV2aW91c1NpYmxpbmciIDogIm5leHRTaWJsaW5nIiBdOwoJCX0KCgkJcG9zaXRpb24gPSAkKCBvYmogKS5vZmZzZXQoKTsKCQlyZXR1cm4gWyBwb3NpdGlvbi5sZWZ0LCBwb3NpdGlvbi50b3AgXTsKCX0sCgoJLyogSGlkZSB0aGUgZGF0ZSBwaWNrZXIgZnJvbSB2aWV3LgoJICogQHBhcmFtICBpbnB1dCAgZWxlbWVudCAtIHRoZSBpbnB1dCBmaWVsZCBhdHRhY2hlZCB0byB0aGUgZGF0ZSBwaWNrZXIKCSAqLwoJX2hpZGVEYXRlcGlja2VyOiBmdW5jdGlvbiggaW5wdXQgKSB7CgkJdmFyIHNob3dBbmltLCBkdXJhdGlvbiwgcG9zdFByb2Nlc3MsIG9uQ2xvc2UsCgkJCWluc3QgPSB0aGlzLl9jdXJJbnN0OwoKCQlpZiAoICFpbnN0IHx8ICggaW5wdXQgJiYgaW5zdCAhPT0gJC5kYXRhKCBpbnB1dCwgImRhdGVwaWNrZXIiICkgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0aGlzLl9kYXRlcGlja2VyU2hvd2luZyApIHsKCQkJc2hvd0FuaW0gPSB0aGlzLl9nZXQoIGluc3QsICJzaG93QW5pbSIgKTsKCQkJZHVyYXRpb24gPSB0aGlzLl9nZXQoIGluc3QsICJkdXJhdGlvbiIgKTsKCQkJcG9zdFByb2Nlc3MgPSBmdW5jdGlvbigpIHsKCQkJCSQuZGF0ZXBpY2tlci5fdGlkeURpYWxvZyggaW5zdCApOwoJCQl9OwoKCQkJLy8gREVQUkVDQVRFRDogYWZ0ZXIgQkMgZm9yIDEuOC54ICQuZWZmZWN0c1sgc2hvd0FuaW0gXSBpcyBub3QgbmVlZGVkCgkJCWlmICggJC5lZmZlY3RzICYmICggJC5lZmZlY3RzLmVmZmVjdFsgc2hvd0FuaW0gXSB8fCAkLmVmZmVjdHNbIHNob3dBbmltIF0gKSApIHsKCQkJCWluc3QuZHBEaXYuaGlkZSggc2hvd0FuaW0sICQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic2hvd09wdGlvbnMiICksIGR1cmF0aW9uLCBwb3N0UHJvY2VzcyApOwoJCQl9IGVsc2UgewoJCQkJaW5zdC5kcERpdlsgKCBzaG93QW5pbSA9PT0gInNsaWRlRG93biIgPyAic2xpZGVVcCIgOgoJCQkJCSggc2hvd0FuaW0gPT09ICJmYWRlSW4iID8gImZhZGVPdXQiIDogImhpZGUiICkgKSBdKCAoIHNob3dBbmltID8gZHVyYXRpb24gOiBudWxsICksIHBvc3RQcm9jZXNzICk7CgkJCX0KCgkJCWlmICggIXNob3dBbmltICkgewoJCQkJcG9zdFByb2Nlc3MoKTsKCQkJfQoJCQl0aGlzLl9kYXRlcGlja2VyU2hvd2luZyA9IGZhbHNlOwoKCQkJb25DbG9zZSA9IHRoaXMuX2dldCggaW5zdCwgIm9uQ2xvc2UiICk7CgkJCWlmICggb25DbG9zZSApIHsKCQkJCW9uQ2xvc2UuYXBwbHkoICggaW5zdC5pbnB1dCA/IGluc3QuaW5wdXRbIDAgXSA6IG51bGwgKSwgWyAoIGluc3QuaW5wdXQgPyBpbnN0LmlucHV0LnZhbCgpIDogIiIgKSwgaW5zdCBdICk7CgkJCX0KCgkJCXRoaXMuX2xhc3RJbnB1dCA9IG51bGw7CgkJCWlmICggdGhpcy5faW5EaWFsb2cgKSB7CgkJCQl0aGlzLl9kaWFsb2dJbnB1dC5jc3MoIHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIGxlZnQ6ICIwIiwgdG9wOiAiLTEwMHB4IiB9ICk7CgkJCQlpZiAoICQuYmxvY2tVSSApIHsKCQkJCQkkLnVuYmxvY2tVSSgpOwoJCQkJCSQoICJib2R5IiApLmFwcGVuZCggdGhpcy5kcERpdiApOwoJCQkJfQoJCQl9CgkJCXRoaXMuX2luRGlhbG9nID0gZmFsc2U7CgkJfQoJfSwKCgkvKiBUaWR5IHVwIGFmdGVyIGEgZGlhbG9nIGRpc3BsYXkuICovCglfdGlkeURpYWxvZzogZnVuY3Rpb24oIGluc3QgKSB7CgkJaW5zdC5kcERpdi5yZW1vdmVDbGFzcyggdGhpcy5fZGlhbG9nQ2xhc3MgKS5vZmYoICIudWktZGF0ZXBpY2tlci1jYWxlbmRhciIgKTsKCX0sCgoJLyogQ2xvc2UgZGF0ZSBwaWNrZXIgaWYgY2xpY2tlZCBlbHNld2hlcmUuICovCglfY2hlY2tFeHRlcm5hbENsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCAhJC5kYXRlcGlja2VyLl9jdXJJbnN0ICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQlpbnN0ID0gJC5kYXRlcGlja2VyLl9nZXRJbnN0KCAkdGFyZ2V0WyAwIF0gKTsKCgkJaWYgKCAoICggJHRhcmdldFsgMCBdLmlkICE9PSAkLmRhdGVwaWNrZXIuX21haW5EaXZJZCAmJgoJCQkJJHRhcmdldC5wYXJlbnRzKCAiIyIgKyAkLmRhdGVwaWNrZXIuX21haW5EaXZJZCApLmxlbmd0aCA9PT0gMCAmJgoJCQkJISR0YXJnZXQuaGFzQ2xhc3MoICQuZGF0ZXBpY2tlci5tYXJrZXJDbGFzc05hbWUgKSAmJgoJCQkJISR0YXJnZXQuY2xvc2VzdCggIi4iICsgJC5kYXRlcGlja2VyLl90cmlnZ2VyQ2xhc3MgKS5sZW5ndGggJiYKCQkJCSQuZGF0ZXBpY2tlci5fZGF0ZXBpY2tlclNob3dpbmcgJiYgISggJC5kYXRlcGlja2VyLl9pbkRpYWxvZyAmJiAkLmJsb2NrVUkgKSApICkgfHwKCQkJKCAkdGFyZ2V0Lmhhc0NsYXNzKCAkLmRhdGVwaWNrZXIubWFya2VyQ2xhc3NOYW1lICkgJiYgJC5kYXRlcGlja2VyLl9jdXJJbnN0ICE9PSBpbnN0ICkgKSB7CgkJCQkkLmRhdGVwaWNrZXIuX2hpZGVEYXRlcGlja2VyKCk7CgkJfQoJfSwKCgkvKiBBZGp1c3Qgb25lIG9mIHRoZSBkYXRlIHN1Yi1maWVsZHMuICovCglfYWRqdXN0RGF0ZTogZnVuY3Rpb24oIGlkLCBvZmZzZXQsIHBlcmlvZCApIHsKCQl2YXIgdGFyZ2V0ID0gJCggaWQgKSwKCQkJaW5zdCA9IHRoaXMuX2dldEluc3QoIHRhcmdldFsgMCBdICk7CgoJCWlmICggdGhpcy5faXNEaXNhYmxlZERhdGVwaWNrZXIoIHRhcmdldFsgMCBdICkgKSB7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fYWRqdXN0SW5zdERhdGUoIGluc3QsIG9mZnNldCArCgkJCSggcGVyaW9kID09PSAiTSIgPyB0aGlzLl9nZXQoIGluc3QsICJzaG93Q3VycmVudEF0UG9zIiApIDogMCApLCAvLyB1bmRvIHBvc2l0aW9uaW5nCgkJCXBlcmlvZCApOwoJCXRoaXMuX3VwZGF0ZURhdGVwaWNrZXIoIGluc3QgKTsKCX0sCgoJLyogQWN0aW9uIGZvciBjdXJyZW50IGxpbmsuICovCglfZ290b1RvZGF5OiBmdW5jdGlvbiggaWQgKSB7CgkJdmFyIGRhdGUsCgkJCXRhcmdldCA9ICQoIGlkICksCgkJCWluc3QgPSB0aGlzLl9nZXRJbnN0KCB0YXJnZXRbIDAgXSApOwoKCQlpZiAoIHRoaXMuX2dldCggaW5zdCwgImdvdG9DdXJyZW50IiApICYmIGluc3QuY3VycmVudERheSApIHsKCQkJaW5zdC5zZWxlY3RlZERheSA9IGluc3QuY3VycmVudERheTsKCQkJaW5zdC5kcmF3TW9udGggPSBpbnN0LnNlbGVjdGVkTW9udGggPSBpbnN0LmN1cnJlbnRNb250aDsKCQkJaW5zdC5kcmF3WWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyID0gaW5zdC5jdXJyZW50WWVhcjsKCQl9IGVsc2UgewoJCQlkYXRlID0gbmV3IERhdGUoKTsKCQkJaW5zdC5zZWxlY3RlZERheSA9IGRhdGUuZ2V0RGF0ZSgpOwoJCQlpbnN0LmRyYXdNb250aCA9IGluc3Quc2VsZWN0ZWRNb250aCA9IGRhdGUuZ2V0TW9udGgoKTsKCQkJaW5zdC5kcmF3WWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpOwoJCX0KCQl0aGlzLl9ub3RpZnlDaGFuZ2UoIGluc3QgKTsKCQl0aGlzLl9hZGp1c3REYXRlKCB0YXJnZXQgKTsKCX0sCgoJLyogQWN0aW9uIGZvciBzZWxlY3RpbmcgYSBuZXcgbW9udGgveWVhci4gKi8KCV9zZWxlY3RNb250aFllYXI6IGZ1bmN0aW9uKCBpZCwgc2VsZWN0LCBwZXJpb2QgKSB7CgkJdmFyIHRhcmdldCA9ICQoIGlkICksCgkJCWluc3QgPSB0aGlzLl9nZXRJbnN0KCB0YXJnZXRbIDAgXSApOwoKCQlpbnN0WyAic2VsZWN0ZWQiICsgKCBwZXJpb2QgPT09ICJNIiA/ICJNb250aCIgOiAiWWVhciIgKSBdID0KCQlpbnN0WyAiZHJhdyIgKyAoIHBlcmlvZCA9PT0gIk0iID8gIk1vbnRoIiA6ICJZZWFyIiApIF0gPQoJCQlwYXJzZUludCggc2VsZWN0Lm9wdGlvbnNbIHNlbGVjdC5zZWxlY3RlZEluZGV4IF0udmFsdWUsIDEwICk7CgoJCXRoaXMuX25vdGlmeUNoYW5nZSggaW5zdCApOwoJCXRoaXMuX2FkanVzdERhdGUoIHRhcmdldCApOwoJfSwKCgkvKiBBY3Rpb24gZm9yIHNlbGVjdGluZyBhIGRheS4gKi8KCV9zZWxlY3REYXk6IGZ1bmN0aW9uKCBpZCwgbW9udGgsIHllYXIsIHRkICkgewoJCXZhciBpbnN0LAoJCQl0YXJnZXQgPSAkKCBpZCApOwoKCQlpZiAoICQoIHRkICkuaGFzQ2xhc3MoIHRoaXMuX3Vuc2VsZWN0YWJsZUNsYXNzICkgfHwgdGhpcy5faXNEaXNhYmxlZERhdGVwaWNrZXIoIHRhcmdldFsgMCBdICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCWluc3QgPSB0aGlzLl9nZXRJbnN0KCB0YXJnZXRbIDAgXSApOwoJCWluc3Quc2VsZWN0ZWREYXkgPSBpbnN0LmN1cnJlbnREYXkgPSAkKCAiYSIsIHRkICkuaHRtbCgpOwoJCWluc3Quc2VsZWN0ZWRNb250aCA9IGluc3QuY3VycmVudE1vbnRoID0gbW9udGg7CgkJaW5zdC5zZWxlY3RlZFllYXIgPSBpbnN0LmN1cnJlbnRZZWFyID0geWVhcjsKCQl0aGlzLl9zZWxlY3REYXRlKCBpZCwgdGhpcy5fZm9ybWF0RGF0ZSggaW5zdCwKCQkJaW5zdC5jdXJyZW50RGF5LCBpbnN0LmN1cnJlbnRNb250aCwgaW5zdC5jdXJyZW50WWVhciApICk7Cgl9LAoKCS8qIEVyYXNlIHRoZSBpbnB1dCBmaWVsZCBhbmQgaGlkZSB0aGUgZGF0ZSBwaWNrZXIuICovCglfY2xlYXJEYXRlOiBmdW5jdGlvbiggaWQgKSB7CgkJdmFyIHRhcmdldCA9ICQoIGlkICk7CgkJdGhpcy5fc2VsZWN0RGF0ZSggdGFyZ2V0LCAiIiApOwoJfSwKCgkvKiBVcGRhdGUgdGhlIGlucHV0IGZpZWxkIHdpdGggdGhlIHNlbGVjdGVkIGRhdGUuICovCglfc2VsZWN0RGF0ZTogZnVuY3Rpb24oIGlkLCBkYXRlU3RyICkgewoJCXZhciBvblNlbGVjdCwKCQkJdGFyZ2V0ID0gJCggaWQgKSwKCQkJaW5zdCA9IHRoaXMuX2dldEluc3QoIHRhcmdldFsgMCBdICk7CgoJCWRhdGVTdHIgPSAoIGRhdGVTdHIgIT0gbnVsbCA/IGRhdGVTdHIgOiB0aGlzLl9mb3JtYXREYXRlKCBpbnN0ICkgKTsKCQlpZiAoIGluc3QuaW5wdXQgKSB7CgkJCWluc3QuaW5wdXQudmFsKCBkYXRlU3RyICk7CgkJfQoJCXRoaXMuX3VwZGF0ZUFsdGVybmF0ZSggaW5zdCApOwoKCQlvblNlbGVjdCA9IHRoaXMuX2dldCggaW5zdCwgIm9uU2VsZWN0IiApOwoJCWlmICggb25TZWxlY3QgKSB7CgkJCW9uU2VsZWN0LmFwcGx5KCAoIGluc3QuaW5wdXQgPyBpbnN0LmlucHV0WyAwIF0gOiBudWxsICksIFsgZGF0ZVN0ciwgaW5zdCBdICk7ICAvLyB0cmlnZ2VyIGN1c3RvbSBjYWxsYmFjawoJCX0gZWxzZSBpZiAoIGluc3QuaW5wdXQgKSB7CgkJCWluc3QuaW5wdXQudHJpZ2dlciggImNoYW5nZSIgKTsgLy8gZmlyZSB0aGUgY2hhbmdlIGV2ZW50CgkJfQoKCQlpZiAoIGluc3QuaW5saW5lICkgewoJCQl0aGlzLl91cGRhdGVEYXRlcGlja2VyKCBpbnN0ICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5faGlkZURhdGVwaWNrZXIoKTsKCQkJdGhpcy5fbGFzdElucHV0ID0gaW5zdC5pbnB1dFsgMCBdOwoJCQlpZiAoIHR5cGVvZiggaW5zdC5pbnB1dFsgMCBdICkgIT09ICJvYmplY3QiICkgewoJCQkJaW5zdC5pbnB1dC50cmlnZ2VyKCAiZm9jdXMiICk7IC8vIHJlc3RvcmUgZm9jdXMKCQkJfQoJCQl0aGlzLl9sYXN0SW5wdXQgPSBudWxsOwoJCX0KCX0sCgoJLyogVXBkYXRlIGFueSBhbHRlcm5hdGUgZmllbGQgdG8gc3luY2hyb25pc2Ugd2l0aCB0aGUgbWFpbiBmaWVsZC4gKi8KCV91cGRhdGVBbHRlcm5hdGU6IGZ1bmN0aW9uKCBpbnN0ICkgewoJCXZhciBhbHRGb3JtYXQsIGRhdGUsIGRhdGVTdHIsCgkJCWFsdEZpZWxkID0gdGhpcy5fZ2V0KCBpbnN0LCAiYWx0RmllbGQiICk7CgoJCWlmICggYWx0RmllbGQgKSB7IC8vIHVwZGF0ZSBhbHRlcm5hdGUgZmllbGQgdG9vCgkJCWFsdEZvcm1hdCA9IHRoaXMuX2dldCggaW5zdCwgImFsdEZvcm1hdCIgKSB8fCB0aGlzLl9nZXQoIGluc3QsICJkYXRlRm9ybWF0IiApOwoJCQlkYXRlID0gdGhpcy5fZ2V0RGF0ZSggaW5zdCApOwoJCQlkYXRlU3RyID0gdGhpcy5mb3JtYXREYXRlKCBhbHRGb3JtYXQsIGRhdGUsIHRoaXMuX2dldEZvcm1hdENvbmZpZyggaW5zdCApICk7CgkJCSQoIGFsdEZpZWxkICkudmFsKCBkYXRlU3RyICk7CgkJfQoJfSwKCgkvKiBTZXQgYXMgYmVmb3JlU2hvd0RheSBmdW5jdGlvbiB0byBwcmV2ZW50IHNlbGVjdGlvbiBvZiB3ZWVrZW5kcy4KCSAqIEBwYXJhbSAgZGF0ZSAgRGF0ZSAtIHRoZSBkYXRlIHRvIGN1c3RvbWlzZQoJICogQHJldHVybiBbYm9vbGVhbiwgc3RyaW5nXSAtIGlzIHRoaXMgZGF0ZSBzZWxlY3RhYmxlPywgd2hhdCBpcyBpdHMgQ1NTIGNsYXNzPwoJICovCglub1dlZWtlbmRzOiBmdW5jdGlvbiggZGF0ZSApIHsKCQl2YXIgZGF5ID0gZGF0ZS5nZXREYXkoKTsKCQlyZXR1cm4gWyAoIGRheSA+IDAgJiYgZGF5IDwgNiApLCAiIiBdOwoJfSwKCgkvKiBTZXQgYXMgY2FsY3VsYXRlV2VlayB0byBkZXRlcm1pbmUgdGhlIHdlZWsgb2YgdGhlIHllYXIgYmFzZWQgb24gdGhlIElTTyA4NjAxIGRlZmluaXRpb24uCgkgKiBAcGFyYW0gIGRhdGUgIERhdGUgLSB0aGUgZGF0ZSB0byBnZXQgdGhlIHdlZWsgZm9yCgkgKiBAcmV0dXJuICBudW1iZXIgLSB0aGUgbnVtYmVyIG9mIHRoZSB3ZWVrIHdpdGhpbiB0aGUgeWVhciB0aGF0IGNvbnRhaW5zIHRoaXMgZGF0ZQoJICovCglpc284NjAxV2VlazogZnVuY3Rpb24oIGRhdGUgKSB7CgkJdmFyIHRpbWUsCgkJCWNoZWNrRGF0ZSA9IG5ldyBEYXRlKCBkYXRlLmdldFRpbWUoKSApOwoKCQkvLyBGaW5kIFRodXJzZGF5IG9mIHRoaXMgd2VlayBzdGFydGluZyBvbiBNb25kYXkKCQljaGVja0RhdGUuc2V0RGF0ZSggY2hlY2tEYXRlLmdldERhdGUoKSArIDQgLSAoIGNoZWNrRGF0ZS5nZXREYXkoKSB8fCA3ICkgKTsKCgkJdGltZSA9IGNoZWNrRGF0ZS5nZXRUaW1lKCk7CgkJY2hlY2tEYXRlLnNldE1vbnRoKCAwICk7IC8vIENvbXBhcmUgd2l0aCBKYW4gMQoJCWNoZWNrRGF0ZS5zZXREYXRlKCAxICk7CgkJcmV0dXJuIE1hdGguZmxvb3IoIE1hdGgucm91bmQoICggdGltZSAtIGNoZWNrRGF0ZSApIC8gODY0MDAwMDAgKSAvIDcgKSArIDE7Cgl9LAoKCS8qIFBhcnNlIGEgc3RyaW5nIHZhbHVlIGludG8gYSBkYXRlIG9iamVjdC4KCSAqIFNlZSBmb3JtYXREYXRlIGJlbG93IGZvciB0aGUgcG9zc2libGUgZm9ybWF0cy4KCSAqCgkgKiBAcGFyYW0gIGZvcm1hdCBzdHJpbmcgLSB0aGUgZXhwZWN0ZWQgZm9ybWF0IG9mIHRoZSBkYXRlCgkgKiBAcGFyYW0gIHZhbHVlIHN0cmluZyAtIHRoZSBkYXRlIGluIHRoZSBhYm92ZSBmb3JtYXQKCSAqIEBwYXJhbSAgc2V0dGluZ3MgT2JqZWN0IC0gYXR0cmlidXRlcyBpbmNsdWRlOgoJICoJCQkJCXNob3J0WWVhckN1dG9mZiAgbnVtYmVyIC0gdGhlIGN1dG9mZiB5ZWFyIGZvciBkZXRlcm1pbmluZyB0aGUgY2VudHVyeSAob3B0aW9uYWwpCgkgKgkJCQkJZGF5TmFtZXNTaG9ydAlzdHJpbmdbN10gLSBhYmJyZXZpYXRlZCBuYW1lcyBvZiB0aGUgZGF5cyBmcm9tIFN1bmRheSAob3B0aW9uYWwpCgkgKgkJCQkJZGF5TmFtZXMJCXN0cmluZ1s3XSAtIG5hbWVzIG9mIHRoZSBkYXlzIGZyb20gU3VuZGF5IChvcHRpb25hbCkKCSAqCQkJCQltb250aE5hbWVzU2hvcnQgc3RyaW5nWzEyXSAtIGFiYnJldmlhdGVkIG5hbWVzIG9mIHRoZSBtb250aHMgKG9wdGlvbmFsKQoJICoJCQkJCW1vbnRoTmFtZXMJCXN0cmluZ1sxMl0gLSBuYW1lcyBvZiB0aGUgbW9udGhzIChvcHRpb25hbCkKCSAqIEByZXR1cm4gIERhdGUgLSB0aGUgZXh0cmFjdGVkIGRhdGUgdmFsdWUgb3IgbnVsbCBpZiB2YWx1ZSBpcyBibGFuawoJICovCglwYXJzZURhdGU6IGZ1bmN0aW9uKCBmb3JtYXQsIHZhbHVlLCBzZXR0aW5ncyApIHsKCQlpZiAoIGZvcm1hdCA9PSBudWxsIHx8IHZhbHVlID09IG51bGwgKSB7CgkJCXRocm93ICJJbnZhbGlkIGFyZ3VtZW50cyI7CgkJfQoKCQl2YWx1ZSA9ICggdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiA/IHZhbHVlLnRvU3RyaW5nKCkgOiB2YWx1ZSArICIiICk7CgkJaWYgKCB2YWx1ZSA9PT0gIiIgKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJdmFyIGlGb3JtYXQsIGRpbSwgZXh0cmEsCgkJCWlWYWx1ZSA9IDAsCgkJCXNob3J0WWVhckN1dG9mZlRlbXAgPSAoIHNldHRpbmdzID8gc2V0dGluZ3Muc2hvcnRZZWFyQ3V0b2ZmIDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLnNob3J0WWVhckN1dG9mZiwKCQkJc2hvcnRZZWFyQ3V0b2ZmID0gKCB0eXBlb2Ygc2hvcnRZZWFyQ3V0b2ZmVGVtcCAhPT0gInN0cmluZyIgPyBzaG9ydFllYXJDdXRvZmZUZW1wIDoKCQkJCW5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSAlIDEwMCArIHBhcnNlSW50KCBzaG9ydFllYXJDdXRvZmZUZW1wLCAxMCApICksCgkJCWRheU5hbWVzU2hvcnQgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MuZGF5TmFtZXNTaG9ydCA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5kYXlOYW1lc1Nob3J0LAoJCQlkYXlOYW1lcyA9ICggc2V0dGluZ3MgPyBzZXR0aW5ncy5kYXlOYW1lcyA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5kYXlOYW1lcywKCQkJbW9udGhOYW1lc1Nob3J0ID0gKCBzZXR0aW5ncyA/IHNldHRpbmdzLm1vbnRoTmFtZXNTaG9ydCA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5tb250aE5hbWVzU2hvcnQsCgkJCW1vbnRoTmFtZXMgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MubW9udGhOYW1lcyA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5tb250aE5hbWVzLAoJCQl5ZWFyID0gLTEsCgkJCW1vbnRoID0gLTEsCgkJCWRheSA9IC0xLAoJCQlkb3kgPSAtMSwKCQkJbGl0ZXJhbCA9IGZhbHNlLAoJCQlkYXRlLAoKCQkJLy8gQ2hlY2sgd2hldGhlciBhIGZvcm1hdCBjaGFyYWN0ZXIgaXMgZG91YmxlZAoJCQlsb29rQWhlYWQgPSBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCQl2YXIgbWF0Y2hlcyA9ICggaUZvcm1hdCArIDEgPCBmb3JtYXQubGVuZ3RoICYmIGZvcm1hdC5jaGFyQXQoIGlGb3JtYXQgKyAxICkgPT09IG1hdGNoICk7CgkJCQlpZiAoIG1hdGNoZXMgKSB7CgkJCQkJaUZvcm1hdCsrOwoJCQkJfQoJCQkJcmV0dXJuIG1hdGNoZXM7CgkJCX0sCgoJCQkvLyBFeHRyYWN0IGEgbnVtYmVyIGZyb20gdGhlIHN0cmluZyB2YWx1ZQoJCQlnZXROdW1iZXIgPSBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCQl2YXIgaXNEb3VibGVkID0gbG9va0FoZWFkKCBtYXRjaCApLAoJCQkJCXNpemUgPSAoIG1hdGNoID09PSAiQCIgPyAxNCA6ICggbWF0Y2ggPT09ICIhIiA/IDIwIDoKCQkJCQkoIG1hdGNoID09PSAieSIgJiYgaXNEb3VibGVkID8gNCA6ICggbWF0Y2ggPT09ICJvIiA/IDMgOiAyICkgKSApICksCgkJCQkJbWluU2l6ZSA9ICggbWF0Y2ggPT09ICJ5IiA/IHNpemUgOiAxICksCgkJCQkJZGlnaXRzID0gbmV3IFJlZ0V4cCggIl5cXGR7IiArIG1pblNpemUgKyAiLCIgKyBzaXplICsgIn0iICksCgkJCQkJbnVtID0gdmFsdWUuc3Vic3RyaW5nKCBpVmFsdWUgKS5tYXRjaCggZGlnaXRzICk7CgkJCQlpZiAoICFudW0gKSB7CgkJCQkJdGhyb3cgIk1pc3NpbmcgbnVtYmVyIGF0IHBvc2l0aW9uICIgKyBpVmFsdWU7CgkJCQl9CgkJCQlpVmFsdWUgKz0gbnVtWyAwIF0ubGVuZ3RoOwoJCQkJcmV0dXJuIHBhcnNlSW50KCBudW1bIDAgXSwgMTAgKTsKCQkJfSwKCgkJCS8vIEV4dHJhY3QgYSBuYW1lIGZyb20gdGhlIHN0cmluZyB2YWx1ZSBhbmQgY29udmVydCB0byBhbiBpbmRleAoJCQlnZXROYW1lID0gZnVuY3Rpb24oIG1hdGNoLCBzaG9ydE5hbWVzLCBsb25nTmFtZXMgKSB7CgkJCQl2YXIgaW5kZXggPSAtMSwKCQkJCQluYW1lcyA9ICQubWFwKCBsb29rQWhlYWQoIG1hdGNoICkgPyBsb25nTmFtZXMgOiBzaG9ydE5hbWVzLCBmdW5jdGlvbiggdiwgayApIHsKCQkJCQkJcmV0dXJuIFsgWyBrLCB2IF0gXTsKCQkJCQl9ICkuc29ydCggZnVuY3Rpb24oIGEsIGIgKSB7CgkJCQkJCXJldHVybiAtKCBhWyAxIF0ubGVuZ3RoIC0gYlsgMSBdLmxlbmd0aCApOwoJCQkJCX0gKTsKCgkJCQkkLmVhY2goIG5hbWVzLCBmdW5jdGlvbiggaSwgcGFpciApIHsKCQkJCQl2YXIgbmFtZSA9IHBhaXJbIDEgXTsKCQkJCQlpZiAoIHZhbHVlLnN1YnN0ciggaVZhbHVlLCBuYW1lLmxlbmd0aCApLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKSApIHsKCQkJCQkJaW5kZXggPSBwYWlyWyAwIF07CgkJCQkJCWlWYWx1ZSArPSBuYW1lLmxlbmd0aDsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0gKTsKCQkJCWlmICggaW5kZXggIT09IC0xICkgewoJCQkJCXJldHVybiBpbmRleCArIDE7CgkJCQl9IGVsc2UgewoJCQkJCXRocm93ICJVbmtub3duIG5hbWUgYXQgcG9zaXRpb24gIiArIGlWYWx1ZTsKCQkJCX0KCQkJfSwKCgkJCS8vIENvbmZpcm0gdGhhdCBhIGxpdGVyYWwgY2hhcmFjdGVyIG1hdGNoZXMgdGhlIHN0cmluZyB2YWx1ZQoJCQljaGVja0xpdGVyYWwgPSBmdW5jdGlvbigpIHsKCQkJCWlmICggdmFsdWUuY2hhckF0KCBpVmFsdWUgKSAhPT0gZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApICkgewoJCQkJCXRocm93ICJVbmV4cGVjdGVkIGxpdGVyYWwgYXQgcG9zaXRpb24gIiArIGlWYWx1ZTsKCQkJCX0KCQkJCWlWYWx1ZSsrOwoJCQl9OwoKCQlmb3IgKCBpRm9ybWF0ID0gMDsgaUZvcm1hdCA8IGZvcm1hdC5sZW5ndGg7IGlGb3JtYXQrKyApIHsKCQkJaWYgKCBsaXRlcmFsICkgewoJCQkJaWYgKCBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICkgPT09ICInIiAmJiAhbG9va0FoZWFkKCAiJyIgKSApIHsKCQkJCQlsaXRlcmFsID0gZmFsc2U7CgkJCQl9IGVsc2UgewoJCQkJCWNoZWNrTGl0ZXJhbCgpOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJc3dpdGNoICggZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApICkgewoJCQkJCWNhc2UgImQiOgoJCQkJCQlkYXkgPSBnZXROdW1iZXIoICJkIiApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJEIjoKCQkJCQkJZ2V0TmFtZSggIkQiLCBkYXlOYW1lc1Nob3J0LCBkYXlOYW1lcyApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJvIjoKCQkJCQkJZG95ID0gZ2V0TnVtYmVyKCAibyIgKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAibSI6CgkJCQkJCW1vbnRoID0gZ2V0TnVtYmVyKCAibSIgKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAiTSI6CgkJCQkJCW1vbnRoID0gZ2V0TmFtZSggIk0iLCBtb250aE5hbWVzU2hvcnQsIG1vbnRoTmFtZXMgKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAieSI6CgkJCQkJCXllYXIgPSBnZXROdW1iZXIoICJ5IiApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJAIjoKCQkJCQkJZGF0ZSA9IG5ldyBEYXRlKCBnZXROdW1iZXIoICJAIiApICk7CgkJCQkJCXllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7CgkJCQkJCW1vbnRoID0gZGF0ZS5nZXRNb250aCgpICsgMTsKCQkJCQkJZGF5ID0gZGF0ZS5nZXREYXRlKCk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIiEiOgoJCQkJCQlkYXRlID0gbmV3IERhdGUoICggZ2V0TnVtYmVyKCAiISIgKSAtIHRoaXMuX3RpY2tzVG8xOTcwICkgLyAxMDAwMCApOwoJCQkJCQl5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpOwoJCQkJCQltb250aCA9IGRhdGUuZ2V0TW9udGgoKSArIDE7CgkJCQkJCWRheSA9IGRhdGUuZ2V0RGF0ZSgpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICInIjoKCQkJCQkJaWYgKCBsb29rQWhlYWQoICInIiApICkgewoJCQkJCQkJY2hlY2tMaXRlcmFsKCk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlsaXRlcmFsID0gdHJ1ZTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCQlkZWZhdWx0OgoJCQkJCQljaGVja0xpdGVyYWwoKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBpVmFsdWUgPCB2YWx1ZS5sZW5ndGggKSB7CgkJCWV4dHJhID0gdmFsdWUuc3Vic3RyKCBpVmFsdWUgKTsKCQkJaWYgKCAhL15ccysvLnRlc3QoIGV4dHJhICkgKSB7CgkJCQl0aHJvdyAiRXh0cmEvdW5wYXJzZWQgY2hhcmFjdGVycyBmb3VuZCBpbiBkYXRlOiAiICsgZXh0cmE7CgkJCX0KCQl9CgoJCWlmICggeWVhciA9PT0gLTEgKSB7CgkJCXllYXIgPSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCk7CgkJfSBlbHNlIGlmICggeWVhciA8IDEwMCApIHsKCQkJeWVhciArPSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCkgLSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCkgJSAxMDAgKwoJCQkJKCB5ZWFyIDw9IHNob3J0WWVhckN1dG9mZiA/IDAgOiAtMTAwICk7CgkJfQoKCQlpZiAoIGRveSA+IC0xICkgewoJCQltb250aCA9IDE7CgkJCWRheSA9IGRveTsKCQkJZG8gewoJCQkJZGltID0gdGhpcy5fZ2V0RGF5c0luTW9udGgoIHllYXIsIG1vbnRoIC0gMSApOwoJCQkJaWYgKCBkYXkgPD0gZGltICkgewoJCQkJCWJyZWFrOwoJCQkJfQoJCQkJbW9udGgrKzsKCQkJCWRheSAtPSBkaW07CgkJCX0gd2hpbGUgKCB0cnVlICk7CgkJfQoKCQlkYXRlID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCB5ZWFyLCBtb250aCAtIDEsIGRheSApICk7CgkJaWYgKCBkYXRlLmdldEZ1bGxZZWFyKCkgIT09IHllYXIgfHwgZGF0ZS5nZXRNb250aCgpICsgMSAhPT0gbW9udGggfHwgZGF0ZS5nZXREYXRlKCkgIT09IGRheSApIHsKCQkJdGhyb3cgIkludmFsaWQgZGF0ZSI7IC8vIEUuZy4gMzEvMDIvMDAKCQl9CgkJcmV0dXJuIGRhdGU7Cgl9LAoKCS8qIFN0YW5kYXJkIGRhdGUgZm9ybWF0cy4gKi8KCUFUT006ICJ5eS1tbS1kZCIsIC8vIFJGQyAzMzM5IChJU08gODYwMSkKCUNPT0tJRTogIkQsIGRkIE0geXkiLAoJSVNPXzg2MDE6ICJ5eS1tbS1kZCIsCglSRkNfODIyOiAiRCwgZCBNIHkiLAoJUkZDXzg1MDogIkRELCBkZC1NLXkiLAoJUkZDXzEwMzY6ICJELCBkIE0geSIsCglSRkNfMTEyMzogIkQsIGQgTSB5eSIsCglSRkNfMjgyMjogIkQsIGQgTSB5eSIsCglSU1M6ICJELCBkIE0geSIsIC8vIFJGQyA4MjIKCVRJQ0tTOiAiISIsCglUSU1FU1RBTVA6ICJAIiwKCVczQzogInl5LW1tLWRkIiwgLy8gSVNPIDg2MDEKCglfdGlja3NUbzE5NzA6ICggKCAoIDE5NzAgLSAxICkgKiAzNjUgKyBNYXRoLmZsb29yKCAxOTcwIC8gNCApIC0gTWF0aC5mbG9vciggMTk3MCAvIDEwMCApICsKCQlNYXRoLmZsb29yKCAxOTcwIC8gNDAwICkgKSAqIDI0ICogNjAgKiA2MCAqIDEwMDAwMDAwICksCgoJLyogRm9ybWF0IGEgZGF0ZSBvYmplY3QgaW50byBhIHN0cmluZyB2YWx1ZS4KCSAqIFRoZSBmb3JtYXQgY2FuIGJlIGNvbWJpbmF0aW9ucyBvZiB0aGUgZm9sbG93aW5nOgoJICogZCAgLSBkYXkgb2YgbW9udGggKG5vIGxlYWRpbmcgemVybykKCSAqIGRkIC0gZGF5IG9mIG1vbnRoICh0d28gZGlnaXQpCgkgKiBvICAtIGRheSBvZiB5ZWFyIChubyBsZWFkaW5nIHplcm9zKQoJICogb28gLSBkYXkgb2YgeWVhciAodGhyZWUgZGlnaXQpCgkgKiBEICAtIGRheSBuYW1lIHNob3J0CgkgKiBERCAtIGRheSBuYW1lIGxvbmcKCSAqIG0gIC0gbW9udGggb2YgeWVhciAobm8gbGVhZGluZyB6ZXJvKQoJICogbW0gLSBtb250aCBvZiB5ZWFyICh0d28gZGlnaXQpCgkgKiBNICAtIG1vbnRoIG5hbWUgc2hvcnQKCSAqIE1NIC0gbW9udGggbmFtZSBsb25nCgkgKiB5ICAtIHllYXIgKHR3byBkaWdpdCkKCSAqIHl5IC0geWVhciAoZm91ciBkaWdpdCkKCSAqIEAgLSBVbml4IHRpbWVzdGFtcCAobXMgc2luY2UgMDEvMDEvMTk3MCkKCSAqICEgLSBXaW5kb3dzIHRpY2tzICgxMDBucyBzaW5jZSAwMS8wMS8wMDAxKQoJICogIi4uLiIgLSBsaXRlcmFsIHRleHQKCSAqICcnIC0gc2luZ2xlIHF1b3RlCgkgKgoJICogQHBhcmFtICBmb3JtYXQgc3RyaW5nIC0gdGhlIGRlc2lyZWQgZm9ybWF0IG9mIHRoZSBkYXRlCgkgKiBAcGFyYW0gIGRhdGUgRGF0ZSAtIHRoZSBkYXRlIHZhbHVlIHRvIGZvcm1hdAoJICogQHBhcmFtICBzZXR0aW5ncyBPYmplY3QgLSBhdHRyaWJ1dGVzIGluY2x1ZGU6CgkgKgkJCQkJZGF5TmFtZXNTaG9ydAlzdHJpbmdbN10gLSBhYmJyZXZpYXRlZCBuYW1lcyBvZiB0aGUgZGF5cyBmcm9tIFN1bmRheSAob3B0aW9uYWwpCgkgKgkJCQkJZGF5TmFtZXMJCXN0cmluZ1s3XSAtIG5hbWVzIG9mIHRoZSBkYXlzIGZyb20gU3VuZGF5IChvcHRpb25hbCkKCSAqCQkJCQltb250aE5hbWVzU2hvcnQgc3RyaW5nWzEyXSAtIGFiYnJldmlhdGVkIG5hbWVzIG9mIHRoZSBtb250aHMgKG9wdGlvbmFsKQoJICoJCQkJCW1vbnRoTmFtZXMJCXN0cmluZ1sxMl0gLSBuYW1lcyBvZiB0aGUgbW9udGhzIChvcHRpb25hbCkKCSAqIEByZXR1cm4gIHN0cmluZyAtIHRoZSBkYXRlIGluIHRoZSBhYm92ZSBmb3JtYXQKCSAqLwoJZm9ybWF0RGF0ZTogZnVuY3Rpb24oIGZvcm1hdCwgZGF0ZSwgc2V0dGluZ3MgKSB7CgkJaWYgKCAhZGF0ZSApIHsKCQkJcmV0dXJuICIiOwoJCX0KCgkJdmFyIGlGb3JtYXQsCgkJCWRheU5hbWVzU2hvcnQgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MuZGF5TmFtZXNTaG9ydCA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5kYXlOYW1lc1Nob3J0LAoJCQlkYXlOYW1lcyA9ICggc2V0dGluZ3MgPyBzZXR0aW5ncy5kYXlOYW1lcyA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5kYXlOYW1lcywKCQkJbW9udGhOYW1lc1Nob3J0ID0gKCBzZXR0aW5ncyA/IHNldHRpbmdzLm1vbnRoTmFtZXNTaG9ydCA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5tb250aE5hbWVzU2hvcnQsCgkJCW1vbnRoTmFtZXMgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MubW9udGhOYW1lcyA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5tb250aE5hbWVzLAoKCQkJLy8gQ2hlY2sgd2hldGhlciBhIGZvcm1hdCBjaGFyYWN0ZXIgaXMgZG91YmxlZAoJCQlsb29rQWhlYWQgPSBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCQl2YXIgbWF0Y2hlcyA9ICggaUZvcm1hdCArIDEgPCBmb3JtYXQubGVuZ3RoICYmIGZvcm1hdC5jaGFyQXQoIGlGb3JtYXQgKyAxICkgPT09IG1hdGNoICk7CgkJCQlpZiAoIG1hdGNoZXMgKSB7CgkJCQkJaUZvcm1hdCsrOwoJCQkJfQoJCQkJcmV0dXJuIG1hdGNoZXM7CgkJCX0sCgoJCQkvLyBGb3JtYXQgYSBudW1iZXIsIHdpdGggbGVhZGluZyB6ZXJvIGlmIG5lY2Vzc2FyeQoJCQlmb3JtYXROdW1iZXIgPSBmdW5jdGlvbiggbWF0Y2gsIHZhbHVlLCBsZW4gKSB7CgkJCQl2YXIgbnVtID0gIiIgKyB2YWx1ZTsKCQkJCWlmICggbG9va0FoZWFkKCBtYXRjaCApICkgewoJCQkJCXdoaWxlICggbnVtLmxlbmd0aCA8IGxlbiApIHsKCQkJCQkJbnVtID0gIjAiICsgbnVtOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiBudW07CgkJCX0sCgoJCQkvLyBGb3JtYXQgYSBuYW1lLCBzaG9ydCBvciBsb25nIGFzIHJlcXVlc3RlZAoJCQlmb3JtYXROYW1lID0gZnVuY3Rpb24oIG1hdGNoLCB2YWx1ZSwgc2hvcnROYW1lcywgbG9uZ05hbWVzICkgewoJCQkJcmV0dXJuICggbG9va0FoZWFkKCBtYXRjaCApID8gbG9uZ05hbWVzWyB2YWx1ZSBdIDogc2hvcnROYW1lc1sgdmFsdWUgXSApOwoJCQl9LAoJCQlvdXRwdXQgPSAiIiwKCQkJbGl0ZXJhbCA9IGZhbHNlOwoKCQlpZiAoIGRhdGUgKSB7CgkJCWZvciAoIGlGb3JtYXQgPSAwOyBpRm9ybWF0IDwgZm9ybWF0Lmxlbmd0aDsgaUZvcm1hdCsrICkgewoJCQkJaWYgKCBsaXRlcmFsICkgewoJCQkJCWlmICggZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApID09PSAiJyIgJiYgIWxvb2tBaGVhZCggIiciICkgKSB7CgkJCQkJCWxpdGVyYWwgPSBmYWxzZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvdXRwdXQgKz0gZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJc3dpdGNoICggZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApICkgewoJCQkJCQljYXNlICJkIjoKCQkJCQkJCW91dHB1dCArPSBmb3JtYXROdW1iZXIoICJkIiwgZGF0ZS5nZXREYXRlKCksIDIgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICJEIjoKCQkJCQkJCW91dHB1dCArPSBmb3JtYXROYW1lKCAiRCIsIGRhdGUuZ2V0RGF5KCksIGRheU5hbWVzU2hvcnQsIGRheU5hbWVzICk7CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAibyI6CgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0TnVtYmVyKCAibyIsCgkJCQkJCQkJTWF0aC5yb3VuZCggKCBuZXcgRGF0ZSggZGF0ZS5nZXRGdWxsWWVhcigpLCBkYXRlLmdldE1vbnRoKCksIGRhdGUuZ2V0RGF0ZSgpICkuZ2V0VGltZSgpIC0gbmV3IERhdGUoIGRhdGUuZ2V0RnVsbFllYXIoKSwgMCwgMCApLmdldFRpbWUoKSApIC8gODY0MDAwMDAgKSwgMyApOwoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIm0iOgoJCQkJCQkJb3V0cHV0ICs9IGZvcm1hdE51bWJlciggIm0iLCBkYXRlLmdldE1vbnRoKCkgKyAxLCAyICk7CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAiTSI6CgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0TmFtZSggIk0iLCBkYXRlLmdldE1vbnRoKCksIG1vbnRoTmFtZXNTaG9ydCwgbW9udGhOYW1lcyApOwoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgInkiOgoJCQkJCQkJb3V0cHV0ICs9ICggbG9va0FoZWFkKCAieSIgKSA/IGRhdGUuZ2V0RnVsbFllYXIoKSA6CgkJCQkJCQkJKCBkYXRlLmdldEZ1bGxZZWFyKCkgJSAxMDAgPCAxMCA/ICIwIiA6ICIiICkgKyBkYXRlLmdldEZ1bGxZZWFyKCkgJSAxMDAgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICJAIjoKCQkJCQkJCW91dHB1dCArPSBkYXRlLmdldFRpbWUoKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICIhIjoKCQkJCQkJCW91dHB1dCArPSBkYXRlLmdldFRpbWUoKSAqIDEwMDAwICsgdGhpcy5fdGlja3NUbzE5NzA7CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAiJyI6CgkJCQkJCQlpZiAoIGxvb2tBaGVhZCggIiciICkgKSB7CgkJCQkJCQkJb3V0cHV0ICs9ICInIjsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJbGl0ZXJhbCA9IHRydWU7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsKCQkJCQkJZGVmYXVsdDoKCQkJCQkJCW91dHB1dCArPSBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiBvdXRwdXQ7Cgl9LAoKCS8qIEV4dHJhY3QgYWxsIHBvc3NpYmxlIGNoYXJhY3RlcnMgZnJvbSB0aGUgZGF0ZSBmb3JtYXQuICovCglfcG9zc2libGVDaGFyczogZnVuY3Rpb24oIGZvcm1hdCApIHsKCQl2YXIgaUZvcm1hdCwKCQkJY2hhcnMgPSAiIiwKCQkJbGl0ZXJhbCA9IGZhbHNlLAoKCQkJLy8gQ2hlY2sgd2hldGhlciBhIGZvcm1hdCBjaGFyYWN0ZXIgaXMgZG91YmxlZAoJCQlsb29rQWhlYWQgPSBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCQl2YXIgbWF0Y2hlcyA9ICggaUZvcm1hdCArIDEgPCBmb3JtYXQubGVuZ3RoICYmIGZvcm1hdC5jaGFyQXQoIGlGb3JtYXQgKyAxICkgPT09IG1hdGNoICk7CgkJCQlpZiAoIG1hdGNoZXMgKSB7CgkJCQkJaUZvcm1hdCsrOwoJCQkJfQoJCQkJcmV0dXJuIG1hdGNoZXM7CgkJCX07CgoJCWZvciAoIGlGb3JtYXQgPSAwOyBpRm9ybWF0IDwgZm9ybWF0Lmxlbmd0aDsgaUZvcm1hdCsrICkgewoJCQlpZiAoIGxpdGVyYWwgKSB7CgkJCQlpZiAoIGZvcm1hdC5jaGFyQXQoIGlGb3JtYXQgKSA9PT0gIiciICYmICFsb29rQWhlYWQoICInIiApICkgewoJCQkJCWxpdGVyYWwgPSBmYWxzZTsKCQkJCX0gZWxzZSB7CgkJCQkJY2hhcnMgKz0gZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJc3dpdGNoICggZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApICkgewoJCQkJCWNhc2UgImQiOiBjYXNlICJtIjogY2FzZSAieSI6IGNhc2UgIkAiOgoJCQkJCQljaGFycyArPSAiMDEyMzQ1Njc4OSI7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIkQiOiBjYXNlICJNIjoKCQkJCQkJcmV0dXJuIG51bGw7IC8vIEFjY2VwdCBhbnl0aGluZwoJCQkJCWNhc2UgIiciOgoJCQkJCQlpZiAoIGxvb2tBaGVhZCggIiciICkgKSB7CgkJCQkJCQljaGFycyArPSAiJyI7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlsaXRlcmFsID0gdHJ1ZTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCQlkZWZhdWx0OgoJCQkJCQljaGFycyArPSBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICk7CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIGNoYXJzOwoJfSwKCgkvKiBHZXQgYSBzZXR0aW5nIHZhbHVlLCBkZWZhdWx0aW5nIGlmIG5lY2Vzc2FyeS4gKi8KCV9nZXQ6IGZ1bmN0aW9uKCBpbnN0LCBuYW1lICkgewoJCXJldHVybiBpbnN0LnNldHRpbmdzWyBuYW1lIF0gIT09IHVuZGVmaW5lZCA/CgkJCWluc3Quc2V0dGluZ3NbIG5hbWUgXSA6IHRoaXMuX2RlZmF1bHRzWyBuYW1lIF07Cgl9LAoKCS8qIFBhcnNlIGV4aXN0aW5nIGRhdGUgYW5kIGluaXRpYWxpc2UgZGF0ZSBwaWNrZXIuICovCglfc2V0RGF0ZUZyb21GaWVsZDogZnVuY3Rpb24oIGluc3QsIG5vRGVmYXVsdCApIHsKCQlpZiAoIGluc3QuaW5wdXQudmFsKCkgPT09IGluc3QubGFzdFZhbCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGRhdGVGb3JtYXQgPSB0aGlzLl9nZXQoIGluc3QsICJkYXRlRm9ybWF0IiApLAoJCQlkYXRlcyA9IGluc3QubGFzdFZhbCA9IGluc3QuaW5wdXQgPyBpbnN0LmlucHV0LnZhbCgpIDogbnVsbCwKCQkJZGVmYXVsdERhdGUgPSB0aGlzLl9nZXREZWZhdWx0RGF0ZSggaW5zdCApLAoJCQlkYXRlID0gZGVmYXVsdERhdGUsCgkJCXNldHRpbmdzID0gdGhpcy5fZ2V0Rm9ybWF0Q29uZmlnKCBpbnN0ICk7CgoJCXRyeSB7CgkJCWRhdGUgPSB0aGlzLnBhcnNlRGF0ZSggZGF0ZUZvcm1hdCwgZGF0ZXMsIHNldHRpbmdzICkgfHwgZGVmYXVsdERhdGU7CgkJfSBjYXRjaCAoIGV2ZW50ICkgewoJCQlkYXRlcyA9ICggbm9EZWZhdWx0ID8gIiIgOiBkYXRlcyApOwoJCX0KCQlpbnN0LnNlbGVjdGVkRGF5ID0gZGF0ZS5nZXREYXRlKCk7CgkJaW5zdC5kcmF3TW9udGggPSBpbnN0LnNlbGVjdGVkTW9udGggPSBkYXRlLmdldE1vbnRoKCk7CgkJaW5zdC5kcmF3WWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpOwoJCWluc3QuY3VycmVudERheSA9ICggZGF0ZXMgPyBkYXRlLmdldERhdGUoKSA6IDAgKTsKCQlpbnN0LmN1cnJlbnRNb250aCA9ICggZGF0ZXMgPyBkYXRlLmdldE1vbnRoKCkgOiAwICk7CgkJaW5zdC5jdXJyZW50WWVhciA9ICggZGF0ZXMgPyBkYXRlLmdldEZ1bGxZZWFyKCkgOiAwICk7CgkJdGhpcy5fYWRqdXN0SW5zdERhdGUoIGluc3QgKTsKCX0sCgoJLyogUmV0cmlldmUgdGhlIGRlZmF1bHQgZGF0ZSBzaG93biBvbiBvcGVuaW5nLiAqLwoJX2dldERlZmF1bHREYXRlOiBmdW5jdGlvbiggaW5zdCApIHsKCQlyZXR1cm4gdGhpcy5fcmVzdHJpY3RNaW5NYXgoIGluc3QsCgkJCXRoaXMuX2RldGVybWluZURhdGUoIGluc3QsIHRoaXMuX2dldCggaW5zdCwgImRlZmF1bHREYXRlIiApLCBuZXcgRGF0ZSgpICkgKTsKCX0sCgoJLyogQSBkYXRlIG1heSBiZSBzcGVjaWZpZWQgYXMgYW4gZXhhY3QgdmFsdWUgb3IgYSByZWxhdGl2ZSBvbmUuICovCglfZGV0ZXJtaW5lRGF0ZTogZnVuY3Rpb24oIGluc3QsIGRhdGUsIGRlZmF1bHREYXRlICkgewoJCXZhciBvZmZzZXROdW1lcmljID0gZnVuY3Rpb24oIG9mZnNldCApIHsKCQkJCXZhciBkYXRlID0gbmV3IERhdGUoKTsKCQkJCWRhdGUuc2V0RGF0ZSggZGF0ZS5nZXREYXRlKCkgKyBvZmZzZXQgKTsKCQkJCXJldHVybiBkYXRlOwoJCQl9LAoJCQlvZmZzZXRTdHJpbmcgPSBmdW5jdGlvbiggb2Zmc2V0ICkgewoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4gJC5kYXRlcGlja2VyLnBhcnNlRGF0ZSggJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJkYXRlRm9ybWF0IiApLAoJCQkJCQlvZmZzZXQsICQuZGF0ZXBpY2tlci5fZ2V0Rm9ybWF0Q29uZmlnKCBpbnN0ICkgKTsKCQkJCX0KCQkJCWNhdGNoICggZSApIHsKCgkJCQkJLy8gSWdub3JlCgkJCQl9CgoJCQkJdmFyIGRhdGUgPSAoIG9mZnNldC50b0xvd2VyQ2FzZSgpLm1hdGNoKCAvXmMvICkgPwoJCQkJCSQuZGF0ZXBpY2tlci5fZ2V0RGF0ZSggaW5zdCApIDogbnVsbCApIHx8IG5ldyBEYXRlKCksCgkJCQkJeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKSwKCQkJCQltb250aCA9IGRhdGUuZ2V0TW9udGgoKSwKCQkJCQlkYXkgPSBkYXRlLmdldERhdGUoKSwKCQkJCQlwYXR0ZXJuID0gLyhbK1wtXT9bMC05XSspXHMqKGR8RHx3fFd8bXxNfHl8WSk/L2csCgkJCQkJbWF0Y2hlcyA9IHBhdHRlcm4uZXhlYyggb2Zmc2V0ICk7CgoJCQkJd2hpbGUgKCBtYXRjaGVzICkgewoJCQkJCXN3aXRjaCAoIG1hdGNoZXNbIDIgXSB8fCAiZCIgKSB7CgkJCQkJCWNhc2UgImQiIDogY2FzZSAiRCIgOgoJCQkJCQkJZGF5ICs9IHBhcnNlSW50KCBtYXRjaGVzWyAxIF0sIDEwICk7IGJyZWFrOwoJCQkJCQljYXNlICJ3IiA6IGNhc2UgIlciIDoKCQkJCQkJCWRheSArPSBwYXJzZUludCggbWF0Y2hlc1sgMSBdLCAxMCApICogNzsgYnJlYWs7CgkJCQkJCWNhc2UgIm0iIDogY2FzZSAiTSIgOgoJCQkJCQkJbW9udGggKz0gcGFyc2VJbnQoIG1hdGNoZXNbIDEgXSwgMTAgKTsKCQkJCQkJCWRheSA9IE1hdGgubWluKCBkYXksICQuZGF0ZXBpY2tlci5fZ2V0RGF5c0luTW9udGgoIHllYXIsIG1vbnRoICkgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICJ5IjogY2FzZSAiWSIgOgoJCQkJCQkJeWVhciArPSBwYXJzZUludCggbWF0Y2hlc1sgMSBdLCAxMCApOwoJCQkJCQkJZGF5ID0gTWF0aC5taW4oIGRheSwgJC5kYXRlcGlja2VyLl9nZXREYXlzSW5Nb250aCggeWVhciwgbW9udGggKSApOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJCW1hdGNoZXMgPSBwYXR0ZXJuLmV4ZWMoIG9mZnNldCApOwoJCQkJfQoJCQkJcmV0dXJuIG5ldyBEYXRlKCB5ZWFyLCBtb250aCwgZGF5ICk7CgkJCX0sCgkJCW5ld0RhdGUgPSAoIGRhdGUgPT0gbnVsbCB8fCBkYXRlID09PSAiIiA/IGRlZmF1bHREYXRlIDogKCB0eXBlb2YgZGF0ZSA9PT0gInN0cmluZyIgPyBvZmZzZXRTdHJpbmcoIGRhdGUgKSA6CgkJCQkoIHR5cGVvZiBkYXRlID09PSAibnVtYmVyIiA/ICggaXNOYU4oIGRhdGUgKSA/IGRlZmF1bHREYXRlIDogb2Zmc2V0TnVtZXJpYyggZGF0ZSApICkgOiBuZXcgRGF0ZSggZGF0ZS5nZXRUaW1lKCkgKSApICkgKTsKCgkJbmV3RGF0ZSA9ICggbmV3RGF0ZSAmJiBuZXdEYXRlLnRvU3RyaW5nKCkgPT09ICJJbnZhbGlkIERhdGUiID8gZGVmYXVsdERhdGUgOiBuZXdEYXRlICk7CgkJaWYgKCBuZXdEYXRlICkgewoJCQluZXdEYXRlLnNldEhvdXJzKCAwICk7CgkJCW5ld0RhdGUuc2V0TWludXRlcyggMCApOwoJCQluZXdEYXRlLnNldFNlY29uZHMoIDAgKTsKCQkJbmV3RGF0ZS5zZXRNaWxsaXNlY29uZHMoIDAgKTsKCQl9CgkJcmV0dXJuIHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXdEYXRlICk7Cgl9LAoKCS8qIEhhbmRsZSBzd2l0Y2ggdG8vZnJvbSBkYXlsaWdodCBzYXZpbmcuCgkgKiBIb3VycyBtYXkgYmUgbm9uLXplcm8gb24gZGF5bGlnaHQgc2F2aW5nIGN1dC1vdmVyOgoJICogPiAxMiB3aGVuIG1pZG5pZ2h0IGNoYW5nZW92ZXIsIGJ1dCB0aGVuIGNhbm5vdCBnZW5lcmF0ZQoJICogbWlkbmlnaHQgZGF0ZXRpbWUsIHNvIGp1bXAgdG8gMUFNLCBvdGhlcndpc2UgcmVzZXQuCgkgKiBAcGFyYW0gIGRhdGUgIChEYXRlKSB0aGUgZGF0ZSB0byBjaGVjawoJICogQHJldHVybiAgKERhdGUpIHRoZSBjb3JyZWN0ZWQgZGF0ZQoJICovCglfZGF5bGlnaHRTYXZpbmdBZGp1c3Q6IGZ1bmN0aW9uKCBkYXRlICkgewoJCWlmICggIWRhdGUgKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCQlkYXRlLnNldEhvdXJzKCBkYXRlLmdldEhvdXJzKCkgPiAxMiA/IGRhdGUuZ2V0SG91cnMoKSArIDIgOiAwICk7CgkJcmV0dXJuIGRhdGU7Cgl9LAoKCS8qIFNldCB0aGUgZGF0ZShzKSBkaXJlY3RseS4gKi8KCV9zZXREYXRlOiBmdW5jdGlvbiggaW5zdCwgZGF0ZSwgbm9DaGFuZ2UgKSB7CgkJdmFyIGNsZWFyID0gIWRhdGUsCgkJCW9yaWdNb250aCA9IGluc3Quc2VsZWN0ZWRNb250aCwKCQkJb3JpZ1llYXIgPSBpbnN0LnNlbGVjdGVkWWVhciwKCQkJbmV3RGF0ZSA9IHRoaXMuX3Jlc3RyaWN0TWluTWF4KCBpbnN0LCB0aGlzLl9kZXRlcm1pbmVEYXRlKCBpbnN0LCBkYXRlLCBuZXcgRGF0ZSgpICkgKTsKCgkJaW5zdC5zZWxlY3RlZERheSA9IGluc3QuY3VycmVudERheSA9IG5ld0RhdGUuZ2V0RGF0ZSgpOwoJCWluc3QuZHJhd01vbnRoID0gaW5zdC5zZWxlY3RlZE1vbnRoID0gaW5zdC5jdXJyZW50TW9udGggPSBuZXdEYXRlLmdldE1vbnRoKCk7CgkJaW5zdC5kcmF3WWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyID0gaW5zdC5jdXJyZW50WWVhciA9IG5ld0RhdGUuZ2V0RnVsbFllYXIoKTsKCQlpZiAoICggb3JpZ01vbnRoICE9PSBpbnN0LnNlbGVjdGVkTW9udGggfHwgb3JpZ1llYXIgIT09IGluc3Quc2VsZWN0ZWRZZWFyICkgJiYgIW5vQ2hhbmdlICkgewoJCQl0aGlzLl9ub3RpZnlDaGFuZ2UoIGluc3QgKTsKCQl9CgkJdGhpcy5fYWRqdXN0SW5zdERhdGUoIGluc3QgKTsKCQlpZiAoIGluc3QuaW5wdXQgKSB7CgkJCWluc3QuaW5wdXQudmFsKCBjbGVhciA/ICIiIDogdGhpcy5fZm9ybWF0RGF0ZSggaW5zdCApICk7CgkJfQoJfSwKCgkvKiBSZXRyaWV2ZSB0aGUgZGF0ZShzKSBkaXJlY3RseS4gKi8KCV9nZXREYXRlOiBmdW5jdGlvbiggaW5zdCApIHsKCQl2YXIgc3RhcnREYXRlID0gKCAhaW5zdC5jdXJyZW50WWVhciB8fCAoIGluc3QuaW5wdXQgJiYgaW5zdC5pbnB1dC52YWwoKSA9PT0gIiIgKSA/IG51bGwgOgoJCQl0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggbmV3IERhdGUoCgkJCWluc3QuY3VycmVudFllYXIsIGluc3QuY3VycmVudE1vbnRoLCBpbnN0LmN1cnJlbnREYXkgKSApICk7CgkJCXJldHVybiBzdGFydERhdGU7Cgl9LAoKCS8qIEF0dGFjaCB0aGUgb254eHggaGFuZGxlcnMuICBUaGVzZSBhcmUgZGVjbGFyZWQgc3RhdGljYWxseSBzbwoJICogdGhleSB3b3JrIHdpdGggc3RhdGljIGNvZGUgdHJhbnNmb3JtZXJzIGxpa2UgQ2FqYS4KCSAqLwoJX2F0dGFjaEhhbmRsZXJzOiBmdW5jdGlvbiggaW5zdCApIHsKCQl2YXIgc3RlcE1vbnRocyA9IHRoaXMuX2dldCggaW5zdCwgInN0ZXBNb250aHMiICksCgkJCWlkID0gIiMiICsgaW5zdC5pZC5yZXBsYWNlKCAvXFxcXC9nLCAiXFwiICk7CgkJaW5zdC5kcERpdi5maW5kKCAiW2RhdGEtaGFuZGxlcl0iICkubWFwKCBmdW5jdGlvbigpIHsKCQkJdmFyIGhhbmRsZXIgPSB7CgkJCQlwcmV2OiBmdW5jdGlvbigpIHsKCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGlkLCAtc3RlcE1vbnRocywgIk0iICk7CgkJCQl9LAoJCQkJbmV4dDogZnVuY3Rpb24oKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKCBpZCwgK3N0ZXBNb250aHMsICJNIiApOwoJCQkJfSwKCQkJCWhpZGU6IGZ1bmN0aW9uKCkgewoJCQkJCSQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoKTsKCQkJCX0sCgkJCQl0b2RheTogZnVuY3Rpb24oKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9nb3RvVG9kYXkoIGlkICk7CgkJCQl9LAoJCQkJc2VsZWN0RGF5OiBmdW5jdGlvbigpIHsKCQkJCQkkLmRhdGVwaWNrZXIuX3NlbGVjdERheSggaWQsICt0aGlzLmdldEF0dHJpYnV0ZSggImRhdGEtbW9udGgiICksICt0aGlzLmdldEF0dHJpYnV0ZSggImRhdGEteWVhciIgKSwgdGhpcyApOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0sCgkJCQlzZWxlY3RNb250aDogZnVuY3Rpb24oKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9zZWxlY3RNb250aFllYXIoIGlkLCB0aGlzLCAiTSIgKTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9LAoJCQkJc2VsZWN0WWVhcjogZnVuY3Rpb24oKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9zZWxlY3RNb250aFllYXIoIGlkLCB0aGlzLCAiWSIgKTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX07CgkJCSQoIHRoaXMgKS5vbiggdGhpcy5nZXRBdHRyaWJ1dGUoICJkYXRhLWV2ZW50IiApLCBoYW5kbGVyWyB0aGlzLmdldEF0dHJpYnV0ZSggImRhdGEtaGFuZGxlciIgKSBdICk7CgkJfSApOwoJfSwKCgkvKiBHZW5lcmF0ZSB0aGUgSFRNTCBmb3IgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIGRhdGUgcGlja2VyLiAqLwoJX2dlbmVyYXRlSFRNTDogZnVuY3Rpb24oIGluc3QgKSB7CgkJdmFyIG1heERyYXcsIHByZXZUZXh0LCBwcmV2LCBuZXh0VGV4dCwgbmV4dCwgY3VycmVudFRleHQsIGdvdG9EYXRlLAoJCQljb250cm9scywgYnV0dG9uUGFuZWwsIGZpcnN0RGF5LCBzaG93V2VlaywgZGF5TmFtZXMsIGRheU5hbWVzTWluLAoJCQltb250aE5hbWVzLCBtb250aE5hbWVzU2hvcnQsIGJlZm9yZVNob3dEYXksIHNob3dPdGhlck1vbnRocywKCQkJc2VsZWN0T3RoZXJNb250aHMsIGRlZmF1bHREYXRlLCBodG1sLCBkb3csIHJvdywgZ3JvdXAsIGNvbCwgc2VsZWN0ZWREYXRlLAoJCQljb3JuZXJDbGFzcywgY2FsZW5kZXIsIHRoZWFkLCBkYXksIGRheXNJbk1vbnRoLCBsZWFkRGF5cywgY3VyUm93cywgbnVtUm93cywKCQkJcHJpbnREYXRlLCBkUm93LCB0Ym9keSwgZGF5U2V0dGluZ3MsIG90aGVyTW9udGgsIHVuc2VsZWN0YWJsZSwKCQkJdGVtcERhdGUgPSBuZXcgRGF0ZSgpLAoJCQl0b2RheSA9IHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KAoJCQkJbmV3IERhdGUoIHRlbXBEYXRlLmdldEZ1bGxZZWFyKCksIHRlbXBEYXRlLmdldE1vbnRoKCksIHRlbXBEYXRlLmdldERhdGUoKSApICksIC8vIGNsZWFyIHRpbWUKCQkJaXNSVEwgPSB0aGlzLl9nZXQoIGluc3QsICJpc1JUTCIgKSwKCQkJc2hvd0J1dHRvblBhbmVsID0gdGhpcy5fZ2V0KCBpbnN0LCAic2hvd0J1dHRvblBhbmVsIiApLAoJCQloaWRlSWZOb1ByZXZOZXh0ID0gdGhpcy5fZ2V0KCBpbnN0LCAiaGlkZUlmTm9QcmV2TmV4dCIgKSwKCQkJbmF2aWdhdGlvbkFzRGF0ZUZvcm1hdCA9IHRoaXMuX2dldCggaW5zdCwgIm5hdmlnYXRpb25Bc0RhdGVGb3JtYXQiICksCgkJCW51bU1vbnRocyA9IHRoaXMuX2dldE51bWJlck9mTW9udGhzKCBpbnN0ICksCgkJCXNob3dDdXJyZW50QXRQb3MgPSB0aGlzLl9nZXQoIGluc3QsICJzaG93Q3VycmVudEF0UG9zIiApLAoJCQlzdGVwTW9udGhzID0gdGhpcy5fZ2V0KCBpbnN0LCAic3RlcE1vbnRocyIgKSwKCQkJaXNNdWx0aU1vbnRoID0gKCBudW1Nb250aHNbIDAgXSAhPT0gMSB8fCBudW1Nb250aHNbIDEgXSAhPT0gMSApLAoJCQljdXJyZW50RGF0ZSA9IHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCAoICFpbnN0LmN1cnJlbnREYXkgPyBuZXcgRGF0ZSggOTk5OSwgOSwgOSApIDoKCQkJCW5ldyBEYXRlKCBpbnN0LmN1cnJlbnRZZWFyLCBpbnN0LmN1cnJlbnRNb250aCwgaW5zdC5jdXJyZW50RGF5ICkgKSApLAoJCQltaW5EYXRlID0gdGhpcy5fZ2V0TWluTWF4RGF0ZSggaW5zdCwgIm1pbiIgKSwKCQkJbWF4RGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoIGluc3QsICJtYXgiICksCgkJCWRyYXdNb250aCA9IGluc3QuZHJhd01vbnRoIC0gc2hvd0N1cnJlbnRBdFBvcywKCQkJZHJhd1llYXIgPSBpbnN0LmRyYXdZZWFyOwoKCQlpZiAoIGRyYXdNb250aCA8IDAgKSB7CgkJCWRyYXdNb250aCArPSAxMjsKCQkJZHJhd1llYXItLTsKCQl9CgkJaWYgKCBtYXhEYXRlICkgewoJCQltYXhEcmF3ID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCBtYXhEYXRlLmdldEZ1bGxZZWFyKCksCgkJCQltYXhEYXRlLmdldE1vbnRoKCkgLSAoIG51bU1vbnRoc1sgMCBdICogbnVtTW9udGhzWyAxIF0gKSArIDEsIG1heERhdGUuZ2V0RGF0ZSgpICkgKTsKCQkJbWF4RHJhdyA9ICggbWluRGF0ZSAmJiBtYXhEcmF3IDwgbWluRGF0ZSA/IG1pbkRhdGUgOiBtYXhEcmF3ICk7CgkJCXdoaWxlICggdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCBkcmF3WWVhciwgZHJhd01vbnRoLCAxICkgKSA+IG1heERyYXcgKSB7CgkJCQlkcmF3TW9udGgtLTsKCQkJCWlmICggZHJhd01vbnRoIDwgMCApIHsKCQkJCQlkcmF3TW9udGggPSAxMTsKCQkJCQlkcmF3WWVhci0tOwoJCQkJfQoJCQl9CgkJfQoJCWluc3QuZHJhd01vbnRoID0gZHJhd01vbnRoOwoJCWluc3QuZHJhd1llYXIgPSBkcmF3WWVhcjsKCgkJcHJldlRleHQgPSB0aGlzLl9nZXQoIGluc3QsICJwcmV2VGV4dCIgKTsKCQlwcmV2VGV4dCA9ICggIW5hdmlnYXRpb25Bc0RhdGVGb3JtYXQgPyBwcmV2VGV4dCA6IHRoaXMuZm9ybWF0RGF0ZSggcHJldlRleHQsCgkJCXRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggZHJhd1llYXIsIGRyYXdNb250aCAtIHN0ZXBNb250aHMsIDEgKSApLAoJCQl0aGlzLl9nZXRGb3JtYXRDb25maWcoIGluc3QgKSApICk7CgoJCXByZXYgPSAoIHRoaXMuX2NhbkFkanVzdE1vbnRoKCBpbnN0LCAtMSwgZHJhd1llYXIsIGRyYXdNb250aCApID8KCQkJIjxhIGNsYXNzPSd1aS1kYXRlcGlja2VyLXByZXYgdWktY29ybmVyLWFsbCcgZGF0YS1oYW5kbGVyPSdwcmV2JyBkYXRhLWV2ZW50PSdjbGljayciICsKCQkJIiB0aXRsZT0nIiArIHByZXZUZXh0ICsgIic+PHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1jaXJjbGUtdHJpYW5nbGUtIiArICggaXNSVEwgPyAiZSIgOiAidyIgKSArICInPiIgKyBwcmV2VGV4dCArICI8L3NwYW4+PC9hPiIgOgoJCQkoIGhpZGVJZk5vUHJldk5leHQgPyAiIiA6ICI8YSBjbGFzcz0ndWktZGF0ZXBpY2tlci1wcmV2IHVpLWNvcm5lci1hbGwgdWktc3RhdGUtZGlzYWJsZWQnIHRpdGxlPSciICsgcHJldlRleHQgKyAiJz48c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWNpcmNsZS10cmlhbmdsZS0iICsgKCBpc1JUTCA/ICJlIiA6ICJ3IiApICsgIic+IiArIHByZXZUZXh0ICsgIjwvc3Bhbj48L2E+IiApICk7CgoJCW5leHRUZXh0ID0gdGhpcy5fZ2V0KCBpbnN0LCAibmV4dFRleHQiICk7CgkJbmV4dFRleHQgPSAoICFuYXZpZ2F0aW9uQXNEYXRlRm9ybWF0ID8gbmV4dFRleHQgOiB0aGlzLmZvcm1hdERhdGUoIG5leHRUZXh0LAoJCQl0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggbmV3IERhdGUoIGRyYXdZZWFyLCBkcmF3TW9udGggKyBzdGVwTW9udGhzLCAxICkgKSwKCQkJdGhpcy5fZ2V0Rm9ybWF0Q29uZmlnKCBpbnN0ICkgKSApOwoKCQluZXh0ID0gKCB0aGlzLl9jYW5BZGp1c3RNb250aCggaW5zdCwgKzEsIGRyYXdZZWFyLCBkcmF3TW9udGggKSA/CgkJCSI8YSBjbGFzcz0ndWktZGF0ZXBpY2tlci1uZXh0IHVpLWNvcm5lci1hbGwnIGRhdGEtaGFuZGxlcj0nbmV4dCcgZGF0YS1ldmVudD0nY2xpY2snIiArCgkJCSIgdGl0bGU9JyIgKyBuZXh0VGV4dCArICInPjxzcGFuIGNsYXNzPSd1aS1pY29uIHVpLWljb24tY2lyY2xlLXRyaWFuZ2xlLSIgKyAoIGlzUlRMID8gInciIDogImUiICkgKyAiJz4iICsgbmV4dFRleHQgKyAiPC9zcGFuPjwvYT4iIDoKCQkJKCBoaWRlSWZOb1ByZXZOZXh0ID8gIiIgOiAiPGEgY2xhc3M9J3VpLWRhdGVwaWNrZXItbmV4dCB1aS1jb3JuZXItYWxsIHVpLXN0YXRlLWRpc2FibGVkJyB0aXRsZT0nIiArIG5leHRUZXh0ICsgIic+PHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1jaXJjbGUtdHJpYW5nbGUtIiArICggaXNSVEwgPyAidyIgOiAiZSIgKSArICInPiIgKyBuZXh0VGV4dCArICI8L3NwYW4+PC9hPiIgKSApOwoKCQljdXJyZW50VGV4dCA9IHRoaXMuX2dldCggaW5zdCwgImN1cnJlbnRUZXh0IiApOwoJCWdvdG9EYXRlID0gKCB0aGlzLl9nZXQoIGluc3QsICJnb3RvQ3VycmVudCIgKSAmJiBpbnN0LmN1cnJlbnREYXkgPyBjdXJyZW50RGF0ZSA6IHRvZGF5ICk7CgkJY3VycmVudFRleHQgPSAoICFuYXZpZ2F0aW9uQXNEYXRlRm9ybWF0ID8gY3VycmVudFRleHQgOgoJCQl0aGlzLmZvcm1hdERhdGUoIGN1cnJlbnRUZXh0LCBnb3RvRGF0ZSwgdGhpcy5fZ2V0Rm9ybWF0Q29uZmlnKCBpbnN0ICkgKSApOwoKCQljb250cm9scyA9ICggIWluc3QuaW5saW5lID8gIjxidXR0b24gdHlwZT0nYnV0dG9uJyBjbGFzcz0ndWktZGF0ZXBpY2tlci1jbG9zZSB1aS1zdGF0ZS1kZWZhdWx0IHVpLXByaW9yaXR5LXByaW1hcnkgdWktY29ybmVyLWFsbCcgZGF0YS1oYW5kbGVyPSdoaWRlJyBkYXRhLWV2ZW50PSdjbGljayc+IiArCgkJCXRoaXMuX2dldCggaW5zdCwgImNsb3NlVGV4dCIgKSArICI8L2J1dHRvbj4iIDogIiIgKTsKCgkJYnV0dG9uUGFuZWwgPSAoIHNob3dCdXR0b25QYW5lbCApID8gIjxkaXYgY2xhc3M9J3VpLWRhdGVwaWNrZXItYnV0dG9ucGFuZSB1aS13aWRnZXQtY29udGVudCc+IiArICggaXNSVEwgPyBjb250cm9scyA6ICIiICkgKwoJCQkoIHRoaXMuX2lzSW5SYW5nZSggaW5zdCwgZ290b0RhdGUgKSA/ICI8YnV0dG9uIHR5cGU9J2J1dHRvbicgY2xhc3M9J3VpLWRhdGVwaWNrZXItY3VycmVudCB1aS1zdGF0ZS1kZWZhdWx0IHVpLXByaW9yaXR5LXNlY29uZGFyeSB1aS1jb3JuZXItYWxsJyBkYXRhLWhhbmRsZXI9J3RvZGF5JyBkYXRhLWV2ZW50PSdjbGljayciICsKCQkJIj4iICsgY3VycmVudFRleHQgKyAiPC9idXR0b24+IiA6ICIiICkgKyAoIGlzUlRMID8gIiIgOiBjb250cm9scyApICsgIjwvZGl2PiIgOiAiIjsKCgkJZmlyc3REYXkgPSBwYXJzZUludCggdGhpcy5fZ2V0KCBpbnN0LCAiZmlyc3REYXkiICksIDEwICk7CgkJZmlyc3REYXkgPSAoIGlzTmFOKCBmaXJzdERheSApID8gMCA6IGZpcnN0RGF5ICk7CgoJCXNob3dXZWVrID0gdGhpcy5fZ2V0KCBpbnN0LCAic2hvd1dlZWsiICk7CgkJZGF5TmFtZXMgPSB0aGlzLl9nZXQoIGluc3QsICJkYXlOYW1lcyIgKTsKCQlkYXlOYW1lc01pbiA9IHRoaXMuX2dldCggaW5zdCwgImRheU5hbWVzTWluIiApOwoJCW1vbnRoTmFtZXMgPSB0aGlzLl9nZXQoIGluc3QsICJtb250aE5hbWVzIiApOwoJCW1vbnRoTmFtZXNTaG9ydCA9IHRoaXMuX2dldCggaW5zdCwgIm1vbnRoTmFtZXNTaG9ydCIgKTsKCQliZWZvcmVTaG93RGF5ID0gdGhpcy5fZ2V0KCBpbnN0LCAiYmVmb3JlU2hvd0RheSIgKTsKCQlzaG93T3RoZXJNb250aHMgPSB0aGlzLl9nZXQoIGluc3QsICJzaG93T3RoZXJNb250aHMiICk7CgkJc2VsZWN0T3RoZXJNb250aHMgPSB0aGlzLl9nZXQoIGluc3QsICJzZWxlY3RPdGhlck1vbnRocyIgKTsKCQlkZWZhdWx0RGF0ZSA9IHRoaXMuX2dldERlZmF1bHREYXRlKCBpbnN0ICk7CgkJaHRtbCA9ICIiOwoKCQlmb3IgKCByb3cgPSAwOyByb3cgPCBudW1Nb250aHNbIDAgXTsgcm93KysgKSB7CgkJCWdyb3VwID0gIiI7CgkJCXRoaXMubWF4Um93cyA9IDQ7CgkJCWZvciAoIGNvbCA9IDA7IGNvbCA8IG51bU1vbnRoc1sgMSBdOyBjb2wrKyApIHsKCQkJCXNlbGVjdGVkRGF0ZSA9IHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggZHJhd1llYXIsIGRyYXdNb250aCwgaW5zdC5zZWxlY3RlZERheSApICk7CgkJCQljb3JuZXJDbGFzcyA9ICIgdWktY29ybmVyLWFsbCI7CgkJCQljYWxlbmRlciA9ICIiOwoJCQkJaWYgKCBpc011bHRpTW9udGggKSB7CgkJCQkJY2FsZW5kZXIgKz0gIjxkaXYgY2xhc3M9J3VpLWRhdGVwaWNrZXItZ3JvdXAiOwoJCQkJCWlmICggbnVtTW9udGhzWyAxIF0gPiAxICkgewoJCQkJCQlzd2l0Y2ggKCBjb2wgKSB7CgkJCQkJCQljYXNlIDA6IGNhbGVuZGVyICs9ICIgdWktZGF0ZXBpY2tlci1ncm91cC1maXJzdCI7CgkJCQkJCQkJY29ybmVyQ2xhc3MgPSAiIHVpLWNvcm5lci0iICsgKCBpc1JUTCA/ICJyaWdodCIgOiAibGVmdCIgKTsgYnJlYWs7CgkJCQkJCQljYXNlIG51bU1vbnRoc1sgMSBdIC0gMTogY2FsZW5kZXIgKz0gIiB1aS1kYXRlcGlja2VyLWdyb3VwLWxhc3QiOwoJCQkJCQkJCWNvcm5lckNsYXNzID0gIiB1aS1jb3JuZXItIiArICggaXNSVEwgPyAibGVmdCIgOiAicmlnaHQiICk7IGJyZWFrOwoJCQkJCQkJZGVmYXVsdDogY2FsZW5kZXIgKz0gIiB1aS1kYXRlcGlja2VyLWdyb3VwLW1pZGRsZSI7IGNvcm5lckNsYXNzID0gIiI7IGJyZWFrOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWNhbGVuZGVyICs9ICInPiI7CgkJCQl9CgkJCQljYWxlbmRlciArPSAiPGRpdiBjbGFzcz0ndWktZGF0ZXBpY2tlci1oZWFkZXIgdWktd2lkZ2V0LWhlYWRlciB1aS1oZWxwZXItY2xlYXJmaXgiICsgY29ybmVyQ2xhc3MgKyAiJz4iICsKCQkJCQkoIC9hbGx8bGVmdC8udGVzdCggY29ybmVyQ2xhc3MgKSAmJiByb3cgPT09IDAgPyAoIGlzUlRMID8gbmV4dCA6IHByZXYgKSA6ICIiICkgKwoJCQkJCSggL2FsbHxyaWdodC8udGVzdCggY29ybmVyQ2xhc3MgKSAmJiByb3cgPT09IDAgPyAoIGlzUlRMID8gcHJldiA6IG5leHQgKSA6ICIiICkgKwoJCQkJCXRoaXMuX2dlbmVyYXRlTW9udGhZZWFySGVhZGVyKCBpbnN0LCBkcmF3TW9udGgsIGRyYXdZZWFyLCBtaW5EYXRlLCBtYXhEYXRlLAoJCQkJCXJvdyA+IDAgfHwgY29sID4gMCwgbW9udGhOYW1lcywgbW9udGhOYW1lc1Nob3J0ICkgKyAvLyBkcmF3IG1vbnRoIGhlYWRlcnMKCQkJCQkiPC9kaXY+PHRhYmxlIGNsYXNzPSd1aS1kYXRlcGlja2VyLWNhbGVuZGFyJz48dGhlYWQ+IiArCgkJCQkJIjx0cj4iOwoJCQkJdGhlYWQgPSAoIHNob3dXZWVrID8gIjx0aCBjbGFzcz0ndWktZGF0ZXBpY2tlci13ZWVrLWNvbCc+IiArIHRoaXMuX2dldCggaW5zdCwgIndlZWtIZWFkZXIiICkgKyAiPC90aD4iIDogIiIgKTsKCQkJCWZvciAoIGRvdyA9IDA7IGRvdyA8IDc7IGRvdysrICkgeyAvLyBkYXlzIG9mIHRoZSB3ZWVrCgkJCQkJZGF5ID0gKCBkb3cgKyBmaXJzdERheSApICUgNzsKCQkJCQl0aGVhZCArPSAiPHRoIHNjb3BlPSdjb2wnIiArICggKCBkb3cgKyBmaXJzdERheSArIDYgKSAlIDcgPj0gNSA/ICIgY2xhc3M9J3VpLWRhdGVwaWNrZXItd2Vlay1lbmQnIiA6ICIiICkgKyAiPiIgKwoJCQkJCQkiPHNwYW4gdGl0bGU9JyIgKyBkYXlOYW1lc1sgZGF5IF0gKyAiJz4iICsgZGF5TmFtZXNNaW5bIGRheSBdICsgIjwvc3Bhbj48L3RoPiI7CgkJCQl9CgkJCQljYWxlbmRlciArPSB0aGVhZCArICI8L3RyPjwvdGhlYWQ+PHRib2R5PiI7CgkJCQlkYXlzSW5Nb250aCA9IHRoaXMuX2dldERheXNJbk1vbnRoKCBkcmF3WWVhciwgZHJhd01vbnRoICk7CgkJCQlpZiAoIGRyYXdZZWFyID09PSBpbnN0LnNlbGVjdGVkWWVhciAmJiBkcmF3TW9udGggPT09IGluc3Quc2VsZWN0ZWRNb250aCApIHsKCQkJCQlpbnN0LnNlbGVjdGVkRGF5ID0gTWF0aC5taW4oIGluc3Quc2VsZWN0ZWREYXksIGRheXNJbk1vbnRoICk7CgkJCQl9CgkJCQlsZWFkRGF5cyA9ICggdGhpcy5fZ2V0Rmlyc3REYXlPZk1vbnRoKCBkcmF3WWVhciwgZHJhd01vbnRoICkgLSBmaXJzdERheSArIDcgKSAlIDc7CgkJCQljdXJSb3dzID0gTWF0aC5jZWlsKCAoIGxlYWREYXlzICsgZGF5c0luTW9udGggKSAvIDcgKTsgLy8gY2FsY3VsYXRlIHRoZSBudW1iZXIgb2Ygcm93cyB0byBnZW5lcmF0ZQoJCQkJbnVtUm93cyA9ICggaXNNdWx0aU1vbnRoID8gdGhpcy5tYXhSb3dzID4gY3VyUm93cyA/IHRoaXMubWF4Um93cyA6IGN1clJvd3MgOiBjdXJSb3dzICk7IC8vSWYgbXVsdGlwbGUgbW9udGhzLCB1c2UgdGhlIGhpZ2hlciBudW1iZXIgb2Ygcm93cyAoc2VlICM3MDQzKQoJCQkJdGhpcy5tYXhSb3dzID0gbnVtUm93czsKCQkJCXByaW50RGF0ZSA9IHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggZHJhd1llYXIsIGRyYXdNb250aCwgMSAtIGxlYWREYXlzICkgKTsKCQkJCWZvciAoIGRSb3cgPSAwOyBkUm93IDwgbnVtUm93czsgZFJvdysrICkgeyAvLyBjcmVhdGUgZGF0ZSBwaWNrZXIgcm93cwoJCQkJCWNhbGVuZGVyICs9ICI8dHI+IjsKCQkJCQl0Ym9keSA9ICggIXNob3dXZWVrID8gIiIgOiAiPHRkIGNsYXNzPSd1aS1kYXRlcGlja2VyLXdlZWstY29sJz4iICsKCQkJCQkJdGhpcy5fZ2V0KCBpbnN0LCAiY2FsY3VsYXRlV2VlayIgKSggcHJpbnREYXRlICkgKyAiPC90ZD4iICk7CgkJCQkJZm9yICggZG93ID0gMDsgZG93IDwgNzsgZG93KysgKSB7IC8vIGNyZWF0ZSBkYXRlIHBpY2tlciBkYXlzCgkJCQkJCWRheVNldHRpbmdzID0gKCBiZWZvcmVTaG93RGF5ID8KCQkJCQkJCWJlZm9yZVNob3dEYXkuYXBwbHkoICggaW5zdC5pbnB1dCA/IGluc3QuaW5wdXRbIDAgXSA6IG51bGwgKSwgWyBwcmludERhdGUgXSApIDogWyB0cnVlLCAiIiBdICk7CgkJCQkJCW90aGVyTW9udGggPSAoIHByaW50RGF0ZS5nZXRNb250aCgpICE9PSBkcmF3TW9udGggKTsKCQkJCQkJdW5zZWxlY3RhYmxlID0gKCBvdGhlck1vbnRoICYmICFzZWxlY3RPdGhlck1vbnRocyApIHx8ICFkYXlTZXR0aW5nc1sgMCBdIHx8CgkJCQkJCQkoIG1pbkRhdGUgJiYgcHJpbnREYXRlIDwgbWluRGF0ZSApIHx8ICggbWF4RGF0ZSAmJiBwcmludERhdGUgPiBtYXhEYXRlICk7CgkJCQkJCXRib2R5ICs9ICI8dGQgY2xhc3M9JyIgKwoJCQkJCQkJKCAoIGRvdyArIGZpcnN0RGF5ICsgNiApICUgNyA+PSA1ID8gIiB1aS1kYXRlcGlja2VyLXdlZWstZW5kIiA6ICIiICkgKyAvLyBoaWdobGlnaHQgd2Vla2VuZHMKCQkJCQkJCSggb3RoZXJNb250aCA/ICIgdWktZGF0ZXBpY2tlci1vdGhlci1tb250aCIgOiAiIiApICsgLy8gaGlnaGxpZ2h0IGRheXMgZnJvbSBvdGhlciBtb250aHMKCQkJCQkJCSggKCBwcmludERhdGUuZ2V0VGltZSgpID09PSBzZWxlY3RlZERhdGUuZ2V0VGltZSgpICYmIGRyYXdNb250aCA9PT0gaW5zdC5zZWxlY3RlZE1vbnRoICYmIGluc3QuX2tleUV2ZW50ICkgfHwgLy8gdXNlciBwcmVzc2VkIGtleQoJCQkJCQkJKCBkZWZhdWx0RGF0ZS5nZXRUaW1lKCkgPT09IHByaW50RGF0ZS5nZXRUaW1lKCkgJiYgZGVmYXVsdERhdGUuZ2V0VGltZSgpID09PSBzZWxlY3RlZERhdGUuZ2V0VGltZSgpICkgPwoKCQkJCQkJCS8vIG9yIGRlZmF1bHREYXRlIGlzIGN1cnJlbnQgcHJpbnRlZERhdGUgYW5kIGRlZmF1bHREYXRlIGlzIHNlbGVjdGVkRGF0ZQoJCQkJCQkJIiAiICsgdGhpcy5fZGF5T3ZlckNsYXNzIDogIiIgKSArIC8vIGhpZ2hsaWdodCBzZWxlY3RlZCBkYXkKCQkJCQkJCSggdW5zZWxlY3RhYmxlID8gIiAiICsgdGhpcy5fdW5zZWxlY3RhYmxlQ2xhc3MgKyAiIHVpLXN0YXRlLWRpc2FibGVkIiA6ICIiICkgKyAgLy8gaGlnaGxpZ2h0IHVuc2VsZWN0YWJsZSBkYXlzCgkJCQkJCQkoIG90aGVyTW9udGggJiYgIXNob3dPdGhlck1vbnRocyA/ICIiIDogIiAiICsgZGF5U2V0dGluZ3NbIDEgXSArIC8vIGhpZ2hsaWdodCBjdXN0b20gZGF0ZXMKCQkJCQkJCSggcHJpbnREYXRlLmdldFRpbWUoKSA9PT0gY3VycmVudERhdGUuZ2V0VGltZSgpID8gIiAiICsgdGhpcy5fY3VycmVudENsYXNzIDogIiIgKSArIC8vIGhpZ2hsaWdodCBzZWxlY3RlZCBkYXkKCQkJCQkJCSggcHJpbnREYXRlLmdldFRpbWUoKSA9PT0gdG9kYXkuZ2V0VGltZSgpID8gIiB1aS1kYXRlcGlja2VyLXRvZGF5IiA6ICIiICkgKSArICInIiArIC8vIGhpZ2hsaWdodCB0b2RheSAoaWYgZGlmZmVyZW50KQoJCQkJCQkJKCAoICFvdGhlck1vbnRoIHx8IHNob3dPdGhlck1vbnRocyApICYmIGRheVNldHRpbmdzWyAyIF0gPyAiIHRpdGxlPSciICsgZGF5U2V0dGluZ3NbIDIgXS5yZXBsYWNlKCAvJy9nLCAiJiMzOTsiICkgKyAiJyIgOiAiIiApICsgLy8gY2VsbCB0aXRsZQoJCQkJCQkJKCB1bnNlbGVjdGFibGUgPyAiIiA6ICIgZGF0YS1oYW5kbGVyPSdzZWxlY3REYXknIGRhdGEtZXZlbnQ9J2NsaWNrJyBkYXRhLW1vbnRoPSciICsgcHJpbnREYXRlLmdldE1vbnRoKCkgKyAiJyBkYXRhLXllYXI9JyIgKyBwcmludERhdGUuZ2V0RnVsbFllYXIoKSArICInIiApICsgIj4iICsgLy8gYWN0aW9ucwoJCQkJCQkJKCBvdGhlck1vbnRoICYmICFzaG93T3RoZXJNb250aHMgPyAiJiN4YTA7IiA6IC8vIGRpc3BsYXkgZm9yIG90aGVyIG1vbnRocwoJCQkJCQkJKCB1bnNlbGVjdGFibGUgPyAiPHNwYW4gY2xhc3M9J3VpLXN0YXRlLWRlZmF1bHQnPiIgKyBwcmludERhdGUuZ2V0RGF0ZSgpICsgIjwvc3Bhbj4iIDogIjxhIGNsYXNzPSd1aS1zdGF0ZS1kZWZhdWx0IiArCgkJCQkJCQkoIHByaW50RGF0ZS5nZXRUaW1lKCkgPT09IHRvZGF5LmdldFRpbWUoKSA/ICIgdWktc3RhdGUtaGlnaGxpZ2h0IiA6ICIiICkgKwoJCQkJCQkJKCBwcmludERhdGUuZ2V0VGltZSgpID09PSBjdXJyZW50RGF0ZS5nZXRUaW1lKCkgPyAiIHVpLXN0YXRlLWFjdGl2ZSIgOiAiIiApICsgLy8gaGlnaGxpZ2h0IHNlbGVjdGVkIGRheQoJCQkJCQkJKCBvdGhlck1vbnRoID8gIiB1aS1wcmlvcml0eS1zZWNvbmRhcnkiIDogIiIgKSArIC8vIGRpc3Rpbmd1aXNoIGRhdGVzIGZyb20gb3RoZXIgbW9udGhzCgkJCQkJCQkiJyBocmVmPScjJz4iICsgcHJpbnREYXRlLmdldERhdGUoKSArICI8L2E+IiApICkgKyAiPC90ZD4iOyAvLyBkaXNwbGF5IHNlbGVjdGFibGUgZGF0ZQoJCQkJCQlwcmludERhdGUuc2V0RGF0ZSggcHJpbnREYXRlLmdldERhdGUoKSArIDEgKTsKCQkJCQkJcHJpbnREYXRlID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIHByaW50RGF0ZSApOwoJCQkJCX0KCQkJCQljYWxlbmRlciArPSB0Ym9keSArICI8L3RyPiI7CgkJCQl9CgkJCQlkcmF3TW9udGgrKzsKCQkJCWlmICggZHJhd01vbnRoID4gMTEgKSB7CgkJCQkJZHJhd01vbnRoID0gMDsKCQkJCQlkcmF3WWVhcisrOwoJCQkJfQoJCQkJY2FsZW5kZXIgKz0gIjwvdGJvZHk+PC90YWJsZT4iICsgKCBpc011bHRpTW9udGggPyAiPC9kaXY+IiArCgkJCQkJCQkoICggbnVtTW9udGhzWyAwIF0gPiAwICYmIGNvbCA9PT0gbnVtTW9udGhzWyAxIF0gLSAxICkgPyAiPGRpdiBjbGFzcz0ndWktZGF0ZXBpY2tlci1yb3ctYnJlYWsnPjwvZGl2PiIgOiAiIiApIDogIiIgKTsKCQkJCWdyb3VwICs9IGNhbGVuZGVyOwoJCQl9CgkJCWh0bWwgKz0gZ3JvdXA7CgkJfQoJCWh0bWwgKz0gYnV0dG9uUGFuZWw7CgkJaW5zdC5fa2V5RXZlbnQgPSBmYWxzZTsKCQlyZXR1cm4gaHRtbDsKCX0sCgoJLyogR2VuZXJhdGUgdGhlIG1vbnRoIGFuZCB5ZWFyIGhlYWRlci4gKi8KCV9nZW5lcmF0ZU1vbnRoWWVhckhlYWRlcjogZnVuY3Rpb24oIGluc3QsIGRyYXdNb250aCwgZHJhd1llYXIsIG1pbkRhdGUsIG1heERhdGUsCgkJCXNlY29uZGFyeSwgbW9udGhOYW1lcywgbW9udGhOYW1lc1Nob3J0ICkgewoKCQl2YXIgaW5NaW5ZZWFyLCBpbk1heFllYXIsIG1vbnRoLCB5ZWFycywgdGhpc1llYXIsIGRldGVybWluZVllYXIsIHllYXIsIGVuZFllYXIsCgkJCWNoYW5nZU1vbnRoID0gdGhpcy5fZ2V0KCBpbnN0LCAiY2hhbmdlTW9udGgiICksCgkJCWNoYW5nZVllYXIgPSB0aGlzLl9nZXQoIGluc3QsICJjaGFuZ2VZZWFyIiApLAoJCQlzaG93TW9udGhBZnRlclllYXIgPSB0aGlzLl9nZXQoIGluc3QsICJzaG93TW9udGhBZnRlclllYXIiICksCgkJCWh0bWwgPSAiPGRpdiBjbGFzcz0ndWktZGF0ZXBpY2tlci10aXRsZSc+IiwKCQkJbW9udGhIdG1sID0gIiI7CgoJCS8vIE1vbnRoIHNlbGVjdGlvbgoJCWlmICggc2Vjb25kYXJ5IHx8ICFjaGFuZ2VNb250aCApIHsKCQkJbW9udGhIdG1sICs9ICI8c3BhbiBjbGFzcz0ndWktZGF0ZXBpY2tlci1tb250aCc+IiArIG1vbnRoTmFtZXNbIGRyYXdNb250aCBdICsgIjwvc3Bhbj4iOwoJCX0gZWxzZSB7CgkJCWluTWluWWVhciA9ICggbWluRGF0ZSAmJiBtaW5EYXRlLmdldEZ1bGxZZWFyKCkgPT09IGRyYXdZZWFyICk7CgkJCWluTWF4WWVhciA9ICggbWF4RGF0ZSAmJiBtYXhEYXRlLmdldEZ1bGxZZWFyKCkgPT09IGRyYXdZZWFyICk7CgkJCW1vbnRoSHRtbCArPSAiPHNlbGVjdCBjbGFzcz0ndWktZGF0ZXBpY2tlci1tb250aCcgZGF0YS1oYW5kbGVyPSdzZWxlY3RNb250aCcgZGF0YS1ldmVudD0nY2hhbmdlJz4iOwoJCQlmb3IgKCBtb250aCA9IDA7IG1vbnRoIDwgMTI7IG1vbnRoKysgKSB7CgkJCQlpZiAoICggIWluTWluWWVhciB8fCBtb250aCA+PSBtaW5EYXRlLmdldE1vbnRoKCkgKSAmJiAoICFpbk1heFllYXIgfHwgbW9udGggPD0gbWF4RGF0ZS5nZXRNb250aCgpICkgKSB7CgkJCQkJbW9udGhIdG1sICs9ICI8b3B0aW9uIHZhbHVlPSciICsgbW9udGggKyAiJyIgKwoJCQkJCQkoIG1vbnRoID09PSBkcmF3TW9udGggPyAiIHNlbGVjdGVkPSdzZWxlY3RlZCciIDogIiIgKSArCgkJCQkJCSI+IiArIG1vbnRoTmFtZXNTaG9ydFsgbW9udGggXSArICI8L29wdGlvbj4iOwoJCQkJfQoJCQl9CgkJCW1vbnRoSHRtbCArPSAiPC9zZWxlY3Q+IjsKCQl9CgoJCWlmICggIXNob3dNb250aEFmdGVyWWVhciApIHsKCQkJaHRtbCArPSBtb250aEh0bWwgKyAoIHNlY29uZGFyeSB8fCAhKCBjaGFuZ2VNb250aCAmJiBjaGFuZ2VZZWFyICkgPyAiJiN4YTA7IiA6ICIiICk7CgkJfQoKCQkvLyBZZWFyIHNlbGVjdGlvbgoJCWlmICggIWluc3QueWVhcnNodG1sICkgewoJCQlpbnN0LnllYXJzaHRtbCA9ICIiOwoJCQlpZiAoIHNlY29uZGFyeSB8fCAhY2hhbmdlWWVhciApIHsKCQkJCWh0bWwgKz0gIjxzcGFuIGNsYXNzPSd1aS1kYXRlcGlja2VyLXllYXInPiIgKyBkcmF3WWVhciArICI8L3NwYW4+IjsKCQkJfSBlbHNlIHsKCgkJCQkvLyBkZXRlcm1pbmUgcmFuZ2Ugb2YgeWVhcnMgdG8gZGlzcGxheQoJCQkJeWVhcnMgPSB0aGlzLl9nZXQoIGluc3QsICJ5ZWFyUmFuZ2UiICkuc3BsaXQoICI6IiApOwoJCQkJdGhpc1llYXIgPSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCk7CgkJCQlkZXRlcm1pbmVZZWFyID0gZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCXZhciB5ZWFyID0gKCB2YWx1ZS5tYXRjaCggL2NbK1wtXS4qLyApID8gZHJhd1llYXIgKyBwYXJzZUludCggdmFsdWUuc3Vic3RyaW5nKCAxICksIDEwICkgOgoJCQkJCQkoIHZhbHVlLm1hdGNoKCAvWytcLV0uKi8gKSA/IHRoaXNZZWFyICsgcGFyc2VJbnQoIHZhbHVlLCAxMCApIDoKCQkJCQkJcGFyc2VJbnQoIHZhbHVlLCAxMCApICkgKTsKCQkJCQlyZXR1cm4gKCBpc05hTiggeWVhciApID8gdGhpc1llYXIgOiB5ZWFyICk7CgkJCQl9OwoJCQkJeWVhciA9IGRldGVybWluZVllYXIoIHllYXJzWyAwIF0gKTsKCQkJCWVuZFllYXIgPSBNYXRoLm1heCggeWVhciwgZGV0ZXJtaW5lWWVhciggeWVhcnNbIDEgXSB8fCAiIiApICk7CgkJCQl5ZWFyID0gKCBtaW5EYXRlID8gTWF0aC5tYXgoIHllYXIsIG1pbkRhdGUuZ2V0RnVsbFllYXIoKSApIDogeWVhciApOwoJCQkJZW5kWWVhciA9ICggbWF4RGF0ZSA/IE1hdGgubWluKCBlbmRZZWFyLCBtYXhEYXRlLmdldEZ1bGxZZWFyKCkgKSA6IGVuZFllYXIgKTsKCQkJCWluc3QueWVhcnNodG1sICs9ICI8c2VsZWN0IGNsYXNzPSd1aS1kYXRlcGlja2VyLXllYXInIGRhdGEtaGFuZGxlcj0nc2VsZWN0WWVhcicgZGF0YS1ldmVudD0nY2hhbmdlJz4iOwoJCQkJZm9yICggOyB5ZWFyIDw9IGVuZFllYXI7IHllYXIrKyApIHsKCQkJCQlpbnN0LnllYXJzaHRtbCArPSAiPG9wdGlvbiB2YWx1ZT0nIiArIHllYXIgKyAiJyIgKwoJCQkJCQkoIHllYXIgPT09IGRyYXdZZWFyID8gIiBzZWxlY3RlZD0nc2VsZWN0ZWQnIiA6ICIiICkgKwoJCQkJCQkiPiIgKyB5ZWFyICsgIjwvb3B0aW9uPiI7CgkJCQl9CgkJCQlpbnN0LnllYXJzaHRtbCArPSAiPC9zZWxlY3Q+IjsKCgkJCQlodG1sICs9IGluc3QueWVhcnNodG1sOwoJCQkJaW5zdC55ZWFyc2h0bWwgPSBudWxsOwoJCQl9CgkJfQoKCQlodG1sICs9IHRoaXMuX2dldCggaW5zdCwgInllYXJTdWZmaXgiICk7CgkJaWYgKCBzaG93TW9udGhBZnRlclllYXIgKSB7CgkJCWh0bWwgKz0gKCBzZWNvbmRhcnkgfHwgISggY2hhbmdlTW9udGggJiYgY2hhbmdlWWVhciApID8gIiYjeGEwOyIgOiAiIiApICsgbW9udGhIdG1sOwoJCX0KCQlodG1sICs9ICI8L2Rpdj4iOyAvLyBDbG9zZSBkYXRlcGlja2VyX2hlYWRlcgoJCXJldHVybiBodG1sOwoJfSwKCgkvKiBBZGp1c3Qgb25lIG9mIHRoZSBkYXRlIHN1Yi1maWVsZHMuICovCglfYWRqdXN0SW5zdERhdGU6IGZ1bmN0aW9uKCBpbnN0LCBvZmZzZXQsIHBlcmlvZCApIHsKCQl2YXIgeWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyICsgKCBwZXJpb2QgPT09ICJZIiA/IG9mZnNldCA6IDAgKSwKCQkJbW9udGggPSBpbnN0LnNlbGVjdGVkTW9udGggKyAoIHBlcmlvZCA9PT0gIk0iID8gb2Zmc2V0IDogMCApLAoJCQlkYXkgPSBNYXRoLm1pbiggaW5zdC5zZWxlY3RlZERheSwgdGhpcy5fZ2V0RGF5c0luTW9udGgoIHllYXIsIG1vbnRoICkgKSArICggcGVyaW9kID09PSAiRCIgPyBvZmZzZXQgOiAwICksCgkJCWRhdGUgPSB0aGlzLl9yZXN0cmljdE1pbk1heCggaW5zdCwgdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCB5ZWFyLCBtb250aCwgZGF5ICkgKSApOwoKCQlpbnN0LnNlbGVjdGVkRGF5ID0gZGF0ZS5nZXREYXRlKCk7CgkJaW5zdC5kcmF3TW9udGggPSBpbnN0LnNlbGVjdGVkTW9udGggPSBkYXRlLmdldE1vbnRoKCk7CgkJaW5zdC5kcmF3WWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpOwoJCWlmICggcGVyaW9kID09PSAiTSIgfHwgcGVyaW9kID09PSAiWSIgKSB7CgkJCXRoaXMuX25vdGlmeUNoYW5nZSggaW5zdCApOwoJCX0KCX0sCgoJLyogRW5zdXJlIGEgZGF0ZSBpcyB3aXRoaW4gYW55IG1pbi9tYXggYm91bmRzLiAqLwoJX3Jlc3RyaWN0TWluTWF4OiBmdW5jdGlvbiggaW5zdCwgZGF0ZSApIHsKCQl2YXIgbWluRGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoIGluc3QsICJtaW4iICksCgkJCW1heERhdGUgPSB0aGlzLl9nZXRNaW5NYXhEYXRlKCBpbnN0LCAibWF4IiApLAoJCQluZXdEYXRlID0gKCBtaW5EYXRlICYmIGRhdGUgPCBtaW5EYXRlID8gbWluRGF0ZSA6IGRhdGUgKTsKCQlyZXR1cm4gKCBtYXhEYXRlICYmIG5ld0RhdGUgPiBtYXhEYXRlID8gbWF4RGF0ZSA6IG5ld0RhdGUgKTsKCX0sCgoJLyogTm90aWZ5IGNoYW5nZSBvZiBtb250aC95ZWFyLiAqLwoJX25vdGlmeUNoYW5nZTogZnVuY3Rpb24oIGluc3QgKSB7CgkJdmFyIG9uQ2hhbmdlID0gdGhpcy5fZ2V0KCBpbnN0LCAib25DaGFuZ2VNb250aFllYXIiICk7CgkJaWYgKCBvbkNoYW5nZSApIHsKCQkJb25DaGFuZ2UuYXBwbHkoICggaW5zdC5pbnB1dCA/IGluc3QuaW5wdXRbIDAgXSA6IG51bGwgKSwKCQkJCVsgaW5zdC5zZWxlY3RlZFllYXIsIGluc3Quc2VsZWN0ZWRNb250aCArIDEsIGluc3QgXSApOwoJCX0KCX0sCgoJLyogRGV0ZXJtaW5lIHRoZSBudW1iZXIgb2YgbW9udGhzIHRvIHNob3cuICovCglfZ2V0TnVtYmVyT2ZNb250aHM6IGZ1bmN0aW9uKCBpbnN0ICkgewoJCXZhciBudW1Nb250aHMgPSB0aGlzLl9nZXQoIGluc3QsICJudW1iZXJPZk1vbnRocyIgKTsKCQlyZXR1cm4gKCBudW1Nb250aHMgPT0gbnVsbCA/IFsgMSwgMSBdIDogKCB0eXBlb2YgbnVtTW9udGhzID09PSAibnVtYmVyIiA/IFsgMSwgbnVtTW9udGhzIF0gOiBudW1Nb250aHMgKSApOwoJfSwKCgkvKiBEZXRlcm1pbmUgdGhlIGN1cnJlbnQgbWF4aW11bSBkYXRlIC0gZW5zdXJlIG5vIHRpbWUgY29tcG9uZW50cyBhcmUgc2V0LiAqLwoJX2dldE1pbk1heERhdGU6IGZ1bmN0aW9uKCBpbnN0LCBtaW5NYXggKSB7CgkJcmV0dXJuIHRoaXMuX2RldGVybWluZURhdGUoIGluc3QsIHRoaXMuX2dldCggaW5zdCwgbWluTWF4ICsgIkRhdGUiICksIG51bGwgKTsKCX0sCgoJLyogRmluZCB0aGUgbnVtYmVyIG9mIGRheXMgaW4gYSBnaXZlbiBtb250aC4gKi8KCV9nZXREYXlzSW5Nb250aDogZnVuY3Rpb24oIHllYXIsIG1vbnRoICkgewoJCXJldHVybiAzMiAtIHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggeWVhciwgbW9udGgsIDMyICkgKS5nZXREYXRlKCk7Cgl9LAoKCS8qIEZpbmQgdGhlIGRheSBvZiB0aGUgd2VlayBvZiB0aGUgZmlyc3Qgb2YgYSBtb250aC4gKi8KCV9nZXRGaXJzdERheU9mTW9udGg6IGZ1bmN0aW9uKCB5ZWFyLCBtb250aCApIHsKCQlyZXR1cm4gbmV3IERhdGUoIHllYXIsIG1vbnRoLCAxICkuZ2V0RGF5KCk7Cgl9LAoKCS8qIERldGVybWluZXMgaWYgd2Ugc2hvdWxkIGFsbG93IGEgIm5leHQvcHJldiIgbW9udGggZGlzcGxheSBjaGFuZ2UuICovCglfY2FuQWRqdXN0TW9udGg6IGZ1bmN0aW9uKCBpbnN0LCBvZmZzZXQsIGN1clllYXIsIGN1ck1vbnRoICkgewoJCXZhciBudW1Nb250aHMgPSB0aGlzLl9nZXROdW1iZXJPZk1vbnRocyggaW5zdCApLAoJCQlkYXRlID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCBjdXJZZWFyLAoJCQljdXJNb250aCArICggb2Zmc2V0IDwgMCA/IG9mZnNldCA6IG51bU1vbnRoc1sgMCBdICogbnVtTW9udGhzWyAxIF0gKSwgMSApICk7CgoJCWlmICggb2Zmc2V0IDwgMCApIHsKCQkJZGF0ZS5zZXREYXRlKCB0aGlzLl9nZXREYXlzSW5Nb250aCggZGF0ZS5nZXRGdWxsWWVhcigpLCBkYXRlLmdldE1vbnRoKCkgKSApOwoJCX0KCQlyZXR1cm4gdGhpcy5faXNJblJhbmdlKCBpbnN0LCBkYXRlICk7Cgl9LAoKCS8qIElzIHRoZSBnaXZlbiBkYXRlIGluIHRoZSBhY2NlcHRlZCByYW5nZT8gKi8KCV9pc0luUmFuZ2U6IGZ1bmN0aW9uKCBpbnN0LCBkYXRlICkgewoJCXZhciB5ZWFyU3BsaXQsIGN1cnJlbnRZZWFyLAoJCQltaW5EYXRlID0gdGhpcy5fZ2V0TWluTWF4RGF0ZSggaW5zdCwgIm1pbiIgKSwKCQkJbWF4RGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoIGluc3QsICJtYXgiICksCgkJCW1pblllYXIgPSBudWxsLAoJCQltYXhZZWFyID0gbnVsbCwKCQkJeWVhcnMgPSB0aGlzLl9nZXQoIGluc3QsICJ5ZWFyUmFuZ2UiICk7CgkJCWlmICggeWVhcnMgKSB7CgkJCQl5ZWFyU3BsaXQgPSB5ZWFycy5zcGxpdCggIjoiICk7CgkJCQljdXJyZW50WWVhciA9IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKTsKCQkJCW1pblllYXIgPSBwYXJzZUludCggeWVhclNwbGl0WyAwIF0sIDEwICk7CgkJCQltYXhZZWFyID0gcGFyc2VJbnQoIHllYXJTcGxpdFsgMSBdLCAxMCApOwoJCQkJaWYgKCB5ZWFyU3BsaXRbIDAgXS5tYXRjaCggL1srXC1dLiovICkgKSB7CgkJCQkJbWluWWVhciArPSBjdXJyZW50WWVhcjsKCQkJCX0KCQkJCWlmICggeWVhclNwbGl0WyAxIF0ubWF0Y2goIC9bK1wtXS4qLyApICkgewoJCQkJCW1heFllYXIgKz0gY3VycmVudFllYXI7CgkJCQl9CgkJCX0KCgkJcmV0dXJuICggKCAhbWluRGF0ZSB8fCBkYXRlLmdldFRpbWUoKSA+PSBtaW5EYXRlLmdldFRpbWUoKSApICYmCgkJCSggIW1heERhdGUgfHwgZGF0ZS5nZXRUaW1lKCkgPD0gbWF4RGF0ZS5nZXRUaW1lKCkgKSAmJgoJCQkoICFtaW5ZZWFyIHx8IGRhdGUuZ2V0RnVsbFllYXIoKSA+PSBtaW5ZZWFyICkgJiYKCQkJKCAhbWF4WWVhciB8fCBkYXRlLmdldEZ1bGxZZWFyKCkgPD0gbWF4WWVhciApICk7Cgl9LAoKCS8qIFByb3ZpZGUgdGhlIGNvbmZpZ3VyYXRpb24gc2V0dGluZ3MgZm9yIGZvcm1hdHRpbmcvcGFyc2luZy4gKi8KCV9nZXRGb3JtYXRDb25maWc6IGZ1bmN0aW9uKCBpbnN0ICkgewoJCXZhciBzaG9ydFllYXJDdXRvZmYgPSB0aGlzLl9nZXQoIGluc3QsICJzaG9ydFllYXJDdXRvZmYiICk7CgkJc2hvcnRZZWFyQ3V0b2ZmID0gKCB0eXBlb2Ygc2hvcnRZZWFyQ3V0b2ZmICE9PSAic3RyaW5nIiA/IHNob3J0WWVhckN1dG9mZiA6CgkJCW5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSAlIDEwMCArIHBhcnNlSW50KCBzaG9ydFllYXJDdXRvZmYsIDEwICkgKTsKCQlyZXR1cm4geyBzaG9ydFllYXJDdXRvZmY6IHNob3J0WWVhckN1dG9mZiwKCQkJZGF5TmFtZXNTaG9ydDogdGhpcy5fZ2V0KCBpbnN0LCAiZGF5TmFtZXNTaG9ydCIgKSwgZGF5TmFtZXM6IHRoaXMuX2dldCggaW5zdCwgImRheU5hbWVzIiApLAoJCQltb250aE5hbWVzU2hvcnQ6IHRoaXMuX2dldCggaW5zdCwgIm1vbnRoTmFtZXNTaG9ydCIgKSwgbW9udGhOYW1lczogdGhpcy5fZ2V0KCBpbnN0LCAibW9udGhOYW1lcyIgKSB9OwoJfSwKCgkvKiBGb3JtYXQgdGhlIGdpdmVuIGRhdGUgZm9yIGRpc3BsYXkuICovCglfZm9ybWF0RGF0ZTogZnVuY3Rpb24oIGluc3QsIGRheSwgbW9udGgsIHllYXIgKSB7CgkJaWYgKCAhZGF5ICkgewoJCQlpbnN0LmN1cnJlbnREYXkgPSBpbnN0LnNlbGVjdGVkRGF5OwoJCQlpbnN0LmN1cnJlbnRNb250aCA9IGluc3Quc2VsZWN0ZWRNb250aDsKCQkJaW5zdC5jdXJyZW50WWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyOwoJCX0KCQl2YXIgZGF0ZSA9ICggZGF5ID8gKCB0eXBlb2YgZGF5ID09PSAib2JqZWN0IiA/IGRheSA6CgkJCXRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggeWVhciwgbW9udGgsIGRheSApICkgKSA6CgkJCXRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggaW5zdC5jdXJyZW50WWVhciwgaW5zdC5jdXJyZW50TW9udGgsIGluc3QuY3VycmVudERheSApICkgKTsKCQlyZXR1cm4gdGhpcy5mb3JtYXREYXRlKCB0aGlzLl9nZXQoIGluc3QsICJkYXRlRm9ybWF0IiApLCBkYXRlLCB0aGlzLl9nZXRGb3JtYXRDb25maWcoIGluc3QgKSApOwoJfQp9ICk7CgovKgogKiBCaW5kIGhvdmVyIGV2ZW50cyBmb3IgZGF0ZXBpY2tlciBlbGVtZW50cy4KICogRG9uZSB2aWEgZGVsZWdhdGUgc28gdGhlIGJpbmRpbmcgb25seSBvY2N1cnMgb25jZSBpbiB0aGUgbGlmZXRpbWUgb2YgdGhlIHBhcmVudCBkaXYuCiAqIEdsb2JhbCBkYXRlcGlja2VyX2luc3RBY3RpdmUsIHNldCBieSBfdXBkYXRlRGF0ZXBpY2tlciBhbGxvd3MgdGhlIGhhbmRsZXJzIHRvIGZpbmQgdGhlaXIgd2F5IGJhY2sgdG8gdGhlIGFjdGl2ZSBwaWNrZXIuCiAqLwpmdW5jdGlvbiBkYXRlcGlja2VyX2JpbmRIb3ZlciggZHBEaXYgKSB7Cgl2YXIgc2VsZWN0b3IgPSAiYnV0dG9uLCAudWktZGF0ZXBpY2tlci1wcmV2LCAudWktZGF0ZXBpY2tlci1uZXh0LCAudWktZGF0ZXBpY2tlci1jYWxlbmRhciB0ZCBhIjsKCXJldHVybiBkcERpdi5vbiggIm1vdXNlb3V0Iiwgc2VsZWN0b3IsIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJaWYgKCB0aGlzLmNsYXNzTmFtZS5pbmRleE9mKCAidWktZGF0ZXBpY2tlci1wcmV2IiApICE9PSAtMSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmVDbGFzcyggInVpLWRhdGVwaWNrZXItcHJldi1ob3ZlciIgKTsKCQkJfQoJCQlpZiAoIHRoaXMuY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1kYXRlcGlja2VyLW5leHQiICkgIT09IC0xICkgewoJCQkJJCggdGhpcyApLnJlbW92ZUNsYXNzKCAidWktZGF0ZXBpY2tlci1uZXh0LWhvdmVyIiApOwoJCQl9CgkJfSApCgkJLm9uKCAibW91c2VvdmVyIiwgc2VsZWN0b3IsIGRhdGVwaWNrZXJfaGFuZGxlTW91c2VvdmVyICk7Cn0KCmZ1bmN0aW9uIGRhdGVwaWNrZXJfaGFuZGxlTW91c2VvdmVyKCkgewoJaWYgKCAhJC5kYXRlcGlja2VyLl9pc0Rpc2FibGVkRGF0ZXBpY2tlciggZGF0ZXBpY2tlcl9pbnN0QWN0aXZlLmlubGluZSA/IGRhdGVwaWNrZXJfaW5zdEFjdGl2ZS5kcERpdi5wYXJlbnQoKVsgMCBdIDogZGF0ZXBpY2tlcl9pbnN0QWN0aXZlLmlucHV0WyAwIF0gKSApIHsKCQkkKCB0aGlzICkucGFyZW50cyggIi51aS1kYXRlcGlja2VyLWNhbGVuZGFyIiApLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJJCggdGhpcyApLmFkZENsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJaWYgKCB0aGlzLmNsYXNzTmFtZS5pbmRleE9mKCAidWktZGF0ZXBpY2tlci1wcmV2IiApICE9PSAtMSApIHsKCQkJJCggdGhpcyApLmFkZENsYXNzKCAidWktZGF0ZXBpY2tlci1wcmV2LWhvdmVyIiApOwoJCX0KCQlpZiAoIHRoaXMuY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1kYXRlcGlja2VyLW5leHQiICkgIT09IC0xICkgewoJCQkkKCB0aGlzICkuYWRkQ2xhc3MoICJ1aS1kYXRlcGlja2VyLW5leHQtaG92ZXIiICk7CgkJfQoJfQp9CgovKiBqUXVlcnkgZXh0ZW5kIG5vdyBpZ25vcmVzIG51bGxzISAqLwpmdW5jdGlvbiBkYXRlcGlja2VyX2V4dGVuZFJlbW92ZSggdGFyZ2V0LCBwcm9wcyApIHsKCSQuZXh0ZW5kKCB0YXJnZXQsIHByb3BzICk7Cglmb3IgKCB2YXIgbmFtZSBpbiBwcm9wcyApIHsKCQlpZiAoIHByb3BzWyBuYW1lIF0gPT0gbnVsbCApIHsKCQkJdGFyZ2V0WyBuYW1lIF0gPSBwcm9wc1sgbmFtZSBdOwoJCX0KCX0KCXJldHVybiB0YXJnZXQ7Cn0KCi8qIEludm9rZSB0aGUgZGF0ZXBpY2tlciBmdW5jdGlvbmFsaXR5LgogICBAcGFyYW0gIG9wdGlvbnMgIHN0cmluZyAtIGEgY29tbWFuZCwgb3B0aW9uYWxseSBmb2xsb3dlZCBieSBhZGRpdGlvbmFsIHBhcmFtZXRlcnMgb3IKCQkJCQlPYmplY3QgLSBzZXR0aW5ncyBmb3IgYXR0YWNoaW5nIG5ldyBkYXRlcGlja2VyIGZ1bmN0aW9uYWxpdHkKICAgQHJldHVybiAgalF1ZXJ5IG9iamVjdCAqLwokLmZuLmRhdGVwaWNrZXIgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCgkvKiBWZXJpZnkgYW4gZW1wdHkgY29sbGVjdGlvbiB3YXNuJ3QgcGFzc2VkIC0gRml4ZXMgIzY5NzYgKi8KCWlmICggIXRoaXMubGVuZ3RoICkgewoJCXJldHVybiB0aGlzOwoJfQoKCS8qIEluaXRpYWxpc2UgdGhlIGRhdGUgcGlja2VyLiAqLwoJaWYgKCAhJC5kYXRlcGlja2VyLmluaXRpYWxpemVkICkgewoJCSQoIGRvY3VtZW50ICkub24oICJtb3VzZWRvd24iLCAkLmRhdGVwaWNrZXIuX2NoZWNrRXh0ZXJuYWxDbGljayApOwoJCSQuZGF0ZXBpY2tlci5pbml0aWFsaXplZCA9IHRydWU7Cgl9CgoJLyogQXBwZW5kIGRhdGVwaWNrZXIgbWFpbiBjb250YWluZXIgdG8gYm9keSBpZiBub3QgZXhpc3QuICovCglpZiAoICQoICIjIiArICQuZGF0ZXBpY2tlci5fbWFpbkRpdklkICkubGVuZ3RoID09PSAwICkgewoJCSQoICJib2R5IiApLmFwcGVuZCggJC5kYXRlcGlja2VyLmRwRGl2ICk7Cgl9CgoJdmFyIG90aGVyQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKTsKCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICYmICggb3B0aW9ucyA9PT0gImlzRGlzYWJsZWQiIHx8IG9wdGlvbnMgPT09ICJnZXREYXRlIiB8fCBvcHRpb25zID09PSAid2lkZ2V0IiApICkgewoJCXJldHVybiAkLmRhdGVwaWNrZXJbICJfIiArIG9wdGlvbnMgKyAiRGF0ZXBpY2tlciIgXS4KCQkJYXBwbHkoICQuZGF0ZXBpY2tlciwgWyB0aGlzWyAwIF0gXS5jb25jYXQoIG90aGVyQXJncyApICk7Cgl9CglpZiAoIG9wdGlvbnMgPT09ICJvcHRpb24iICYmIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgdHlwZW9mIGFyZ3VtZW50c1sgMSBdID09PSAic3RyaW5nIiApIHsKCQlyZXR1cm4gJC5kYXRlcGlja2VyWyAiXyIgKyBvcHRpb25zICsgIkRhdGVwaWNrZXIiIF0uCgkJCWFwcGx5KCAkLmRhdGVwaWNrZXIsIFsgdGhpc1sgMCBdIF0uY29uY2F0KCBvdGhlckFyZ3MgKSApOwoJfQoJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciID8KCQkJJC5kYXRlcGlja2VyWyAiXyIgKyBvcHRpb25zICsgIkRhdGVwaWNrZXIiIF0uCgkJCQlhcHBseSggJC5kYXRlcGlja2VyLCBbIHRoaXMgXS5jb25jYXQoIG90aGVyQXJncyApICkgOgoJCQkkLmRhdGVwaWNrZXIuX2F0dGFjaERhdGVwaWNrZXIoIHRoaXMsIG9wdGlvbnMgKTsKCX0gKTsKfTsKCiQuZGF0ZXBpY2tlciA9IG5ldyBEYXRlcGlja2VyKCk7IC8vIHNpbmdsZXRvbiBpbnN0YW5jZQokLmRhdGVwaWNrZXIuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKJC5kYXRlcGlja2VyLnV1aWQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKJC5kYXRlcGlja2VyLnZlcnNpb24gPSAiMS4xMi4xIjsKCnZhciB3aWRnZXRzRGF0ZXBpY2tlciA9ICQuZGF0ZXBpY2tlcjsKCgovKiEKICogalF1ZXJ5IFVJIERpYWxvZyAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IERpYWxvZwovLz4+Z3JvdXA6IFdpZGdldHMKLy8+PmRlc2NyaXB0aW9uOiBEaXNwbGF5cyBjdXN0b21pemFibGUgZGlhbG9nIHdpbmRvd3MuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9kaWFsb2cvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9kaWFsb2cvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvZGlhbG9nLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKJC53aWRnZXQoICJ1aS5kaWFsb2ciLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCW9wdGlvbnM6IHsKCQlhcHBlbmRUbzogImJvZHkiLAoJCWF1dG9PcGVuOiB0cnVlLAoJCWJ1dHRvbnM6IFtdLAoJCWNsYXNzZXM6IHsKCQkJInVpLWRpYWxvZyI6ICJ1aS1jb3JuZXItYWxsIiwKCQkJInVpLWRpYWxvZy10aXRsZWJhciI6ICJ1aS1jb3JuZXItYWxsIgoJCX0sCgkJY2xvc2VPbkVzY2FwZTogdHJ1ZSwKCQljbG9zZVRleHQ6ICJDbG9zZSIsCgkJZHJhZ2dhYmxlOiB0cnVlLAoJCWhpZGU6IG51bGwsCgkJaGVpZ2h0OiAiYXV0byIsCgkJbWF4SGVpZ2h0OiBudWxsLAoJCW1heFdpZHRoOiBudWxsLAoJCW1pbkhlaWdodDogMTUwLAoJCW1pbldpZHRoOiAxNTAsCgkJbW9kYWw6IGZhbHNlLAoJCXBvc2l0aW9uOiB7CgkJCW15OiAiY2VudGVyIiwKCQkJYXQ6ICJjZW50ZXIiLAoJCQlvZjogd2luZG93LAoJCQljb2xsaXNpb246ICJmaXQiLAoKCQkJLy8gRW5zdXJlIHRoZSB0aXRsZWJhciBpcyBhbHdheXMgdmlzaWJsZQoJCQl1c2luZzogZnVuY3Rpb24oIHBvcyApIHsKCQkJCXZhciB0b3BPZmZzZXQgPSAkKCB0aGlzICkuY3NzKCBwb3MgKS5vZmZzZXQoKS50b3A7CgkJCQlpZiAoIHRvcE9mZnNldCA8IDAgKSB7CgkJCQkJJCggdGhpcyApLmNzcyggInRvcCIsIHBvcy50b3AgLSB0b3BPZmZzZXQgKTsKCQkJCX0KCQkJfQoJCX0sCgkJcmVzaXphYmxlOiB0cnVlLAoJCXNob3c6IG51bGwsCgkJdGl0bGU6IG51bGwsCgkJd2lkdGg6IDMwMCwKCgkJLy8gQ2FsbGJhY2tzCgkJYmVmb3JlQ2xvc2U6IG51bGwsCgkJY2xvc2U6IG51bGwsCgkJZHJhZzogbnVsbCwKCQlkcmFnU3RhcnQ6IG51bGwsCgkJZHJhZ1N0b3A6IG51bGwsCgkJZm9jdXM6IG51bGwsCgkJb3BlbjogbnVsbCwKCQlyZXNpemU6IG51bGwsCgkJcmVzaXplU3RhcnQ6IG51bGwsCgkJcmVzaXplU3RvcDogbnVsbAoJfSwKCglzaXplUmVsYXRlZE9wdGlvbnM6IHsKCQlidXR0b25zOiB0cnVlLAoJCWhlaWdodDogdHJ1ZSwKCQltYXhIZWlnaHQ6IHRydWUsCgkJbWF4V2lkdGg6IHRydWUsCgkJbWluSGVpZ2h0OiB0cnVlLAoJCW1pbldpZHRoOiB0cnVlLAoJCXdpZHRoOiB0cnVlCgl9LAoKCXJlc2l6YWJsZVJlbGF0ZWRPcHRpb25zOiB7CgkJbWF4SGVpZ2h0OiB0cnVlLAoJCW1heFdpZHRoOiB0cnVlLAoJCW1pbkhlaWdodDogdHJ1ZSwKCQltaW5XaWR0aDogdHJ1ZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLm9yaWdpbmFsQ3NzID0gewoJCQlkaXNwbGF5OiB0aGlzLmVsZW1lbnRbIDAgXS5zdHlsZS5kaXNwbGF5LAoJCQl3aWR0aDogdGhpcy5lbGVtZW50WyAwIF0uc3R5bGUud2lkdGgsCgkJCW1pbkhlaWdodDogdGhpcy5lbGVtZW50WyAwIF0uc3R5bGUubWluSGVpZ2h0LAoJCQltYXhIZWlnaHQ6IHRoaXMuZWxlbWVudFsgMCBdLnN0eWxlLm1heEhlaWdodCwKCQkJaGVpZ2h0OiB0aGlzLmVsZW1lbnRbIDAgXS5zdHlsZS5oZWlnaHQKCQl9OwoJCXRoaXMub3JpZ2luYWxQb3NpdGlvbiA9IHsKCQkJcGFyZW50OiB0aGlzLmVsZW1lbnQucGFyZW50KCksCgkJCWluZGV4OiB0aGlzLmVsZW1lbnQucGFyZW50KCkuY2hpbGRyZW4oKS5pbmRleCggdGhpcy5lbGVtZW50ICkKCQl9OwoJCXRoaXMub3JpZ2luYWxUaXRsZSA9IHRoaXMuZWxlbWVudC5hdHRyKCAidGl0bGUiICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMudGl0bGUgPT0gbnVsbCAmJiB0aGlzLm9yaWdpbmFsVGl0bGUgIT0gbnVsbCApIHsKCQkJdGhpcy5vcHRpb25zLnRpdGxlID0gdGhpcy5vcmlnaW5hbFRpdGxlOwoJCX0KCgkJLy8gRGlhbG9ncyBjYW4ndCBiZSBkaXNhYmxlZAoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSBmYWxzZTsKCQl9CgoJCXRoaXMuX2NyZWF0ZVdyYXBwZXIoKTsKCgkJdGhpcy5lbGVtZW50CgkJCS5zaG93KCkKCQkJLnJlbW92ZUF0dHIoICJ0aXRsZSIgKQoJCQkuYXBwZW5kVG8oIHRoaXMudWlEaWFsb2cgKTsKCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1kaWFsb2ctY29udGVudCIsICJ1aS13aWRnZXQtY29udGVudCIgKTsKCgkJdGhpcy5fY3JlYXRlVGl0bGViYXIoKTsKCQl0aGlzLl9jcmVhdGVCdXR0b25QYW5lKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmRyYWdnYWJsZSAmJiAkLmZuLmRyYWdnYWJsZSApIHsKCQkJdGhpcy5fbWFrZURyYWdnYWJsZSgpOwoJCX0KCQlpZiAoIHRoaXMub3B0aW9ucy5yZXNpemFibGUgJiYgJC5mbi5yZXNpemFibGUgKSB7CgkJCXRoaXMuX21ha2VSZXNpemFibGUoKTsKCQl9CgoJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOwoKCQl0aGlzLl90cmFja0ZvY3VzKCk7Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvT3BlbiApIHsKCQkJdGhpcy5vcGVuKCk7CgkJfQoJfSwKCglfYXBwZW5kVG86IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50ID0gdGhpcy5vcHRpb25zLmFwcGVuZFRvOwoJCWlmICggZWxlbWVudCAmJiAoIGVsZW1lbnQuanF1ZXJ5IHx8IGVsZW1lbnQubm9kZVR5cGUgKSApIHsKCQkJcmV0dXJuICQoIGVsZW1lbnQgKTsKCQl9CgkJcmV0dXJuIHRoaXMuZG9jdW1lbnQuZmluZCggZWxlbWVudCB8fCAiYm9keSIgKS5lcSggMCApOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIG5leHQsCgkJCW9yaWdpbmFsUG9zaXRpb24gPSB0aGlzLm9yaWdpbmFsUG9zaXRpb247CgoJCXRoaXMuX3VudHJhY2tJbnN0YW5jZSgpOwoJCXRoaXMuX2Rlc3Ryb3lPdmVybGF5KCk7CgoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlVW5pcXVlSWQoKQoJCQkuY3NzKCB0aGlzLm9yaWdpbmFsQ3NzICkKCgkJCS8vIFdpdGhvdXQgZGV0YWNoaW5nIGZpcnN0LCB0aGUgZm9sbG93aW5nIGJlY29tZXMgcmVhbGx5IHNsb3cKCQkJLmRldGFjaCgpOwoKCQl0aGlzLnVpRGlhbG9nLnJlbW92ZSgpOwoKCQlpZiAoIHRoaXMub3JpZ2luYWxUaXRsZSApIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIsIHRoaXMub3JpZ2luYWxUaXRsZSApOwoJCX0KCgkJbmV4dCA9IG9yaWdpbmFsUG9zaXRpb24ucGFyZW50LmNoaWxkcmVuKCkuZXEoIG9yaWdpbmFsUG9zaXRpb24uaW5kZXggKTsKCgkJLy8gRG9uJ3QgdHJ5IHRvIHBsYWNlIHRoZSBkaWFsb2cgbmV4dCB0byBpdHNlbGYgKCM4NjEzKQoJCWlmICggbmV4dC5sZW5ndGggJiYgbmV4dFsgMCBdICE9PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJbmV4dC5iZWZvcmUoIHRoaXMuZWxlbWVudCApOwoJCX0gZWxzZSB7CgkJCW9yaWdpbmFsUG9zaXRpb24ucGFyZW50LmFwcGVuZCggdGhpcy5lbGVtZW50ICk7CgkJfQoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnVpRGlhbG9nOwoJfSwKCglkaXNhYmxlOiAkLm5vb3AsCgllbmFibGU6ICQubm9vcCwKCgljbG9zZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJaWYgKCAhdGhpcy5faXNPcGVuIHx8IHRoaXMuX3RyaWdnZXIoICJiZWZvcmVDbG9zZSIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCQl0aGlzLl9mb2N1c2VkRWxlbWVudCA9IG51bGw7CgkJdGhpcy5fZGVzdHJveU92ZXJsYXkoKTsKCQl0aGlzLl91bnRyYWNrSW5zdGFuY2UoKTsKCgkJaWYgKCAhdGhpcy5vcGVuZXIuZmlsdGVyKCAiOmZvY3VzYWJsZSIgKS50cmlnZ2VyKCAiZm9jdXMiICkubGVuZ3RoICkgewoKCQkJLy8gSGlkaW5nIGEgZm9jdXNlZCBlbGVtZW50IGRvZXNuJ3QgdHJpZ2dlciBibHVyIGluIFdlYktpdAoJCQkvLyBzbyBpbiBjYXNlIHdlIGhhdmUgbm90aGluZyB0byBmb2N1cyBvbiwgZXhwbGljaXRseSBibHVyIHRoZSBhY3RpdmUgZWxlbWVudAoJCQkvLyBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDcxODIKCQkJJC51aS5zYWZlQmx1ciggJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICkgKTsKCQl9CgoJCXRoaXMuX2hpZGUoIHRoaXMudWlEaWFsb2csIHRoaXMub3B0aW9ucy5oaWRlLCBmdW5jdGlvbigpIHsKCQkJdGhhdC5fdHJpZ2dlciggImNsb3NlIiwgZXZlbnQgKTsKCQl9ICk7Cgl9LAoKCWlzT3BlbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX2lzT3BlbjsKCX0sCgoJbW92ZVRvVG9wOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9tb3ZlVG9Ub3AoKTsKCX0sCgoJX21vdmVUb1RvcDogZnVuY3Rpb24oIGV2ZW50LCBzaWxlbnQgKSB7CgkJdmFyIG1vdmVkID0gZmFsc2UsCgkJCXpJbmRpY2VzID0gdGhpcy51aURpYWxvZy5zaWJsaW5ncyggIi51aS1mcm9udDp2aXNpYmxlIiApLm1hcCggZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKyQoIHRoaXMgKS5jc3MoICJ6LWluZGV4IiApOwoJCQl9ICkuZ2V0KCksCgkJCXpJbmRleE1heCA9IE1hdGgubWF4LmFwcGx5KCBudWxsLCB6SW5kaWNlcyApOwoKCQlpZiAoIHpJbmRleE1heCA+PSArdGhpcy51aURpYWxvZy5jc3MoICJ6LWluZGV4IiApICkgewoJCQl0aGlzLnVpRGlhbG9nLmNzcyggInotaW5kZXgiLCB6SW5kZXhNYXggKyAxICk7CgkJCW1vdmVkID0gdHJ1ZTsKCQl9CgoJCWlmICggbW92ZWQgJiYgIXNpbGVudCApIHsKCQkJdGhpcy5fdHJpZ2dlciggImZvY3VzIiwgZXZlbnQgKTsKCQl9CgkJcmV0dXJuIG1vdmVkOwoJfSwKCglvcGVuOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCWlmICggdGhpcy5fbW92ZVRvVG9wKCkgKSB7CgkJCQl0aGlzLl9mb2N1c1RhYmJhYmxlKCk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5faXNPcGVuID0gdHJ1ZTsKCQl0aGlzLm9wZW5lciA9ICQoICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApICk7CgoJCXRoaXMuX3NpemUoKTsKCQl0aGlzLl9wb3NpdGlvbigpOwoJCXRoaXMuX2NyZWF0ZU92ZXJsYXkoKTsKCQl0aGlzLl9tb3ZlVG9Ub3AoIG51bGwsIHRydWUgKTsKCgkJLy8gRW5zdXJlIHRoZSBvdmVybGF5IGlzIG1vdmVkIHRvIHRoZSB0b3Agd2l0aCB0aGUgZGlhbG9nLCBidXQgb25seSB3aGVuCgkJLy8gb3BlbmluZy4gVGhlIG92ZXJsYXkgc2hvdWxkbid0IG1vdmUgYWZ0ZXIgdGhlIGRpYWxvZyBpcyBvcGVuIHNvIHRoYXQKCQkvLyBtb2RlbGVzcyBkaWFsb2dzIG9wZW5lZCBhZnRlciB0aGUgbW9kYWwgZGlhbG9nIHN0YWNrIHByb3Blcmx5LgoJCWlmICggdGhpcy5vdmVybGF5ICkgewoJCQl0aGlzLm92ZXJsYXkuY3NzKCAiei1pbmRleCIsIHRoaXMudWlEaWFsb2cuY3NzKCAiei1pbmRleCIgKSAtIDEgKTsKCQl9CgoJCXRoaXMuX3Nob3coIHRoaXMudWlEaWFsb2csIHRoaXMub3B0aW9ucy5zaG93LCBmdW5jdGlvbigpIHsKCQkJdGhhdC5fZm9jdXNUYWJiYWJsZSgpOwoJCQl0aGF0Ll90cmlnZ2VyKCAiZm9jdXMiICk7CgkJfSApOwoKCQkvLyBUcmFjayB0aGUgZGlhbG9nIGltbWVkaWF0ZWx5IHVwb24gb3BlbmVuaW5nIGluIGNhc2UgYSBmb2N1cyBldmVudAoJCS8vIHNvbWVob3cgb2NjdXJzIG91dHNpZGUgb2YgdGhlIGRpYWxvZyBiZWZvcmUgYW4gZWxlbWVudCBpbnNpZGUgdGhlCgkJLy8gZGlhbG9nIGlzIGZvY3VzZWQgKCMxMDE1MikKCQl0aGlzLl9tYWtlRm9jdXNUYXJnZXQoKTsKCgkJdGhpcy5fdHJpZ2dlciggIm9wZW4iICk7Cgl9LAoKCV9mb2N1c1RhYmJhYmxlOiBmdW5jdGlvbigpIHsKCgkJLy8gU2V0IGZvY3VzIHRvIHRoZSBmaXJzdCBtYXRjaDoKCQkvLyAxLiBBbiBlbGVtZW50IHRoYXQgd2FzIGZvY3VzZWQgcHJldmlvdXNseQoJCS8vIDIuIEZpcnN0IGVsZW1lbnQgaW5zaWRlIHRoZSBkaWFsb2cgbWF0Y2hpbmcgW2F1dG9mb2N1c10KCQkvLyAzLiBUYWJiYWJsZSBlbGVtZW50IGluc2lkZSB0aGUgY29udGVudCBlbGVtZW50CgkJLy8gNC4gVGFiYmFibGUgZWxlbWVudCBpbnNpZGUgdGhlIGJ1dHRvbnBhbmUKCQkvLyA1LiBUaGUgY2xvc2UgYnV0dG9uCgkJLy8gNi4gVGhlIGRpYWxvZyBpdHNlbGYKCQl2YXIgaGFzRm9jdXMgPSB0aGlzLl9mb2N1c2VkRWxlbWVudDsKCQlpZiAoICFoYXNGb2N1cyApIHsKCQkJaGFzRm9jdXMgPSB0aGlzLmVsZW1lbnQuZmluZCggIlthdXRvZm9jdXNdIiApOwoJCX0KCQlpZiAoICFoYXNGb2N1cy5sZW5ndGggKSB7CgkJCWhhc0ZvY3VzID0gdGhpcy5lbGVtZW50LmZpbmQoICI6dGFiYmFibGUiICk7CgkJfQoJCWlmICggIWhhc0ZvY3VzLmxlbmd0aCApIHsKCQkJaGFzRm9jdXMgPSB0aGlzLnVpRGlhbG9nQnV0dG9uUGFuZS5maW5kKCAiOnRhYmJhYmxlIiApOwoJCX0KCQlpZiAoICFoYXNGb2N1cy5sZW5ndGggKSB7CgkJCWhhc0ZvY3VzID0gdGhpcy51aURpYWxvZ1RpdGxlYmFyQ2xvc2UuZmlsdGVyKCAiOnRhYmJhYmxlIiApOwoJCX0KCQlpZiAoICFoYXNGb2N1cy5sZW5ndGggKSB7CgkJCWhhc0ZvY3VzID0gdGhpcy51aURpYWxvZzsKCQl9CgkJaGFzRm9jdXMuZXEoIDAgKS50cmlnZ2VyKCAiZm9jdXMiICk7Cgl9LAoKCV9rZWVwRm9jdXM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlmdW5jdGlvbiBjaGVja0ZvY3VzKCkgewoJCQl2YXIgYWN0aXZlRWxlbWVudCA9ICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApLAoJCQkJaXNBY3RpdmUgPSB0aGlzLnVpRGlhbG9nWyAwIF0gPT09IGFjdGl2ZUVsZW1lbnQgfHwKCQkJCQkkLmNvbnRhaW5zKCB0aGlzLnVpRGlhbG9nWyAwIF0sIGFjdGl2ZUVsZW1lbnQgKTsKCQkJaWYgKCAhaXNBY3RpdmUgKSB7CgkJCQl0aGlzLl9mb2N1c1RhYmJhYmxlKCk7CgkJCX0KCQl9CgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQljaGVja0ZvY3VzLmNhbGwoIHRoaXMgKTsKCgkJLy8gc3VwcG9ydDogSUUKCQkvLyBJRSA8PSA4IGRvZXNuJ3QgcHJldmVudCBtb3ZpbmcgZm9jdXMgZXZlbiB3aXRoIGV2ZW50LnByZXZlbnREZWZhdWx0KCkKCQkvLyBzbyB3ZSBjaGVjayBhZ2FpbiBsYXRlcgoJCXRoaXMuX2RlbGF5KCBjaGVja0ZvY3VzICk7Cgl9LAoKCV9jcmVhdGVXcmFwcGVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLnVpRGlhbG9nID0gJCggIjxkaXY+IiApCgkJCS5oaWRlKCkKCQkJLmF0dHIoIHsKCgkJCQkvLyBTZXR0aW5nIHRhYkluZGV4IG1ha2VzIHRoZSBkaXYgZm9jdXNhYmxlCgkJCQl0YWJJbmRleDogLTEsCgkJCQlyb2xlOiAiZGlhbG9nIgoJCQl9ICkKCQkJLmFwcGVuZFRvKCB0aGlzLl9hcHBlbmRUbygpICk7CgoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnVpRGlhbG9nLCAidWktZGlhbG9nIiwgInVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1mcm9udCIgKTsKCQl0aGlzLl9vbiggdGhpcy51aURpYWxvZywgewoJCQlrZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIHRoaXMub3B0aW9ucy5jbG9zZU9uRXNjYXBlICYmICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSAmJiBldmVudC5rZXlDb2RlICYmCgkJCQkJCWV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5FU0NBUEUgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl0aGlzLmNsb3NlKCBldmVudCApOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBQcmV2ZW50IHRhYmJpbmcgb3V0IG9mIGRpYWxvZ3MKCQkJCWlmICggZXZlbnQua2V5Q29kZSAhPT0gJC51aS5rZXlDb2RlLlRBQiB8fCBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQl2YXIgdGFiYmFibGVzID0gdGhpcy51aURpYWxvZy5maW5kKCAiOnRhYmJhYmxlIiApLAoJCQkJCWZpcnN0ID0gdGFiYmFibGVzLmZpbHRlciggIjpmaXJzdCIgKSwKCQkJCQlsYXN0ID0gdGFiYmFibGVzLmZpbHRlciggIjpsYXN0IiApOwoKCQkJCWlmICggKCBldmVudC50YXJnZXQgPT09IGxhc3RbIDAgXSB8fCBldmVudC50YXJnZXQgPT09IHRoaXMudWlEaWFsb2dbIDAgXSApICYmCgkJCQkJCSFldmVudC5zaGlmdEtleSApIHsKCQkJCQl0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQkJCWZpcnN0LnRyaWdnZXIoICJmb2N1cyIgKTsKCQkJCQl9ICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0gZWxzZSBpZiAoICggZXZlbnQudGFyZ2V0ID09PSBmaXJzdFsgMCBdIHx8CgkJCQkJCWV2ZW50LnRhcmdldCA9PT0gdGhpcy51aURpYWxvZ1sgMCBdICkgJiYgZXZlbnQuc2hpZnRLZXkgKSB7CgkJCQkJdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgewoJCQkJCQlsYXN0LnRyaWdnZXIoICJmb2N1cyIgKTsKCQkJCQl9ICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0KCQkJfSwKCQkJbW91c2Vkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIHRoaXMuX21vdmVUb1RvcCggZXZlbnQgKSApIHsKCQkJCQl0aGlzLl9mb2N1c1RhYmJhYmxlKCk7CgkJCQl9CgkJCX0KCQl9ICk7CgoJCS8vIFdlIGFzc3VtZSB0aGF0IGFueSBleGlzdGluZyBhcmlhLWRlc2NyaWJlZGJ5IGF0dHJpYnV0ZSBtZWFucwoJCS8vIHRoYXQgdGhlIGRpYWxvZyBjb250ZW50IGlzIG1hcmtlZCB1cCBwcm9wZXJseQoJCS8vIG90aGVyd2lzZSB3ZSBicnV0ZSBmb3JjZSB0aGUgY29udGVudCBhcyB0aGUgZGVzY3JpcHRpb24KCQlpZiAoICF0aGlzLmVsZW1lbnQuZmluZCggIlthcmlhLWRlc2NyaWJlZGJ5XSIgKS5sZW5ndGggKSB7CgkJCXRoaXMudWlEaWFsb2cuYXR0ciggewoJCQkJImFyaWEtZGVzY3JpYmVkYnkiOiB0aGlzLmVsZW1lbnQudW5pcXVlSWQoKS5hdHRyKCAiaWQiICkKCQkJfSApOwoJCX0KCX0sCgoJX2NyZWF0ZVRpdGxlYmFyOiBmdW5jdGlvbigpIHsKCQl2YXIgdWlEaWFsb2dUaXRsZTsKCgkJdGhpcy51aURpYWxvZ1RpdGxlYmFyID0gJCggIjxkaXY+IiApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnVpRGlhbG9nVGl0bGViYXIsCgkJCSJ1aS1kaWFsb2ctdGl0bGViYXIiLCAidWktd2lkZ2V0LWhlYWRlciB1aS1oZWxwZXItY2xlYXJmaXgiICk7CgkJdGhpcy5fb24oIHRoaXMudWlEaWFsb2dUaXRsZWJhciwgewoJCQltb3VzZWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkvLyBEb24ndCBwcmV2ZW50IGNsaWNrIG9uIGNsb3NlIGJ1dHRvbiAoIzg4MzgpCgkJCQkvLyBGb2N1c2luZyBhIGRpYWxvZyB0aGF0IGlzIHBhcnRpYWxseSBzY3JvbGxlZCBvdXQgb2YgdmlldwoJCQkJLy8gY2F1c2VzIHRoZSBicm93c2VyIHRvIHNjcm9sbCBpdCBpbnRvIHZpZXcsIHByZXZlbnRpbmcgdGhlIGNsaWNrIGV2ZW50CgkJCQlpZiAoICEkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWRpYWxvZy10aXRsZWJhci1jbG9zZSIgKSApIHsKCgkJCQkJLy8gRGlhbG9nIGlzbid0IGdldHRpbmcgZm9jdXMgd2hlbiBkcmFnZ2luZyAoIzgwNjMpCgkJCQkJdGhpcy51aURpYWxvZy50cmlnZ2VyKCAiZm9jdXMiICk7CgkJCQl9CgkJCX0KCQl9ICk7CgoJCS8vIFN1cHBvcnQ6IElFCgkJLy8gVXNlIHR5cGU9ImJ1dHRvbiIgdG8gcHJldmVudCBlbnRlciBrZXlwcmVzc2VzIGluIHRleHRib3hlcyBmcm9tIGNsb3NpbmcgdGhlCgkJLy8gZGlhbG9nIGluIElFICgjOTMxMikKCQl0aGlzLnVpRGlhbG9nVGl0bGViYXJDbG9zZSA9ICQoICI8YnV0dG9uIHR5cGU9J2J1dHRvbic+PC9idXR0b24+IiApCgkJCS5idXR0b24oIHsKCQkJCWxhYmVsOiAkKCAiPGE+IiApLnRleHQoIHRoaXMub3B0aW9ucy5jbG9zZVRleHQgKS5odG1sKCksCgkJCQlpY29uOiAidWktaWNvbi1jbG9zZXRoaWNrIiwKCQkJCXNob3dMYWJlbDogZmFsc2UKCQkJfSApCgkJCS5hcHBlbmRUbyggdGhpcy51aURpYWxvZ1RpdGxlYmFyICk7CgoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnVpRGlhbG9nVGl0bGViYXJDbG9zZSwgInVpLWRpYWxvZy10aXRsZWJhci1jbG9zZSIgKTsKCQl0aGlzLl9vbiggdGhpcy51aURpYWxvZ1RpdGxlYmFyQ2xvc2UsIHsKCQkJY2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl0aGlzLmNsb3NlKCBldmVudCApOwoJCQl9CgkJfSApOwoKCQl1aURpYWxvZ1RpdGxlID0gJCggIjxzcGFuPiIgKS51bmlxdWVJZCgpLnByZXBlbmRUbyggdGhpcy51aURpYWxvZ1RpdGxlYmFyICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHVpRGlhbG9nVGl0bGUsICJ1aS1kaWFsb2ctdGl0bGUiICk7CgkJdGhpcy5fdGl0bGUoIHVpRGlhbG9nVGl0bGUgKTsKCgkJdGhpcy51aURpYWxvZ1RpdGxlYmFyLnByZXBlbmRUbyggdGhpcy51aURpYWxvZyApOwoKCQl0aGlzLnVpRGlhbG9nLmF0dHIoIHsKCQkJImFyaWEtbGFiZWxsZWRieSI6IHVpRGlhbG9nVGl0bGUuYXR0ciggImlkIiApCgkJfSApOwoJfSwKCglfdGl0bGU6IGZ1bmN0aW9uKCB0aXRsZSApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy50aXRsZSApIHsKCQkJdGl0bGUudGV4dCggdGhpcy5vcHRpb25zLnRpdGxlICk7CgkJfSBlbHNlIHsKCQkJdGl0bGUuaHRtbCggIiYjMTYwOyIgKTsKCQl9Cgl9LAoKCV9jcmVhdGVCdXR0b25QYW5lOiBmdW5jdGlvbigpIHsKCQl0aGlzLnVpRGlhbG9nQnV0dG9uUGFuZSA9ICQoICI8ZGl2PiIgKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy51aURpYWxvZ0J1dHRvblBhbmUsICJ1aS1kaWFsb2ctYnV0dG9ucGFuZSIsCgkJCSJ1aS13aWRnZXQtY29udGVudCB1aS1oZWxwZXItY2xlYXJmaXgiICk7CgoJCXRoaXMudWlCdXR0b25TZXQgPSAkKCAiPGRpdj4iICkKCQkJLmFwcGVuZFRvKCB0aGlzLnVpRGlhbG9nQnV0dG9uUGFuZSApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnVpQnV0dG9uU2V0LCAidWktZGlhbG9nLWJ1dHRvbnNldCIgKTsKCgkJdGhpcy5fY3JlYXRlQnV0dG9ucygpOwoJfSwKCglfY3JlYXRlQnV0dG9uczogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlidXR0b25zID0gdGhpcy5vcHRpb25zLmJ1dHRvbnM7CgoJCS8vIElmIHdlIGFscmVhZHkgaGF2ZSBhIGJ1dHRvbiBwYW5lLCByZW1vdmUgaXQKCQl0aGlzLnVpRGlhbG9nQnV0dG9uUGFuZS5yZW1vdmUoKTsKCQl0aGlzLnVpQnV0dG9uU2V0LmVtcHR5KCk7CgoJCWlmICggJC5pc0VtcHR5T2JqZWN0KCBidXR0b25zICkgfHwgKCAkLmlzQXJyYXkoIGJ1dHRvbnMgKSAmJiAhYnV0dG9ucy5sZW5ndGggKSApIHsKCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMudWlEaWFsb2csICJ1aS1kaWFsb2ctYnV0dG9ucyIgKTsKCQkJcmV0dXJuOwoJCX0KCgkJJC5lYWNoKCBidXR0b25zLCBmdW5jdGlvbiggbmFtZSwgcHJvcHMgKSB7CgkJCXZhciBjbGljaywgYnV0dG9uT3B0aW9uczsKCQkJcHJvcHMgPSAkLmlzRnVuY3Rpb24oIHByb3BzICkgPwoJCQkJeyBjbGljazogcHJvcHMsIHRleHQ6IG5hbWUgfSA6CgkJCQlwcm9wczsKCgkJCS8vIERlZmF1bHQgdG8gYSBub24tc3VibWl0dGluZyBidXR0b24KCQkJcHJvcHMgPSAkLmV4dGVuZCggeyB0eXBlOiAiYnV0dG9uIiB9LCBwcm9wcyApOwoKCQkJLy8gQ2hhbmdlIHRoZSBjb250ZXh0IGZvciB0aGUgY2xpY2sgY2FsbGJhY2sgdG8gYmUgdGhlIG1haW4gZWxlbWVudAoJCQljbGljayA9IHByb3BzLmNsaWNrOwoJCQlidXR0b25PcHRpb25zID0gewoJCQkJaWNvbjogcHJvcHMuaWNvbiwKCQkJCWljb25Qb3NpdGlvbjogcHJvcHMuaWNvblBvc2l0aW9uLAoJCQkJc2hvd0xhYmVsOiBwcm9wcy5zaG93TGFiZWwsCgoJCQkJLy8gRGVwcmVjYXRlZCBvcHRpb25zCgkJCQlpY29uczogcHJvcHMuaWNvbnMsCgkJCQl0ZXh0OiBwcm9wcy50ZXh0CgkJCX07CgoJCQlkZWxldGUgcHJvcHMuY2xpY2s7CgkJCWRlbGV0ZSBwcm9wcy5pY29uOwoJCQlkZWxldGUgcHJvcHMuaWNvblBvc2l0aW9uOwoJCQlkZWxldGUgcHJvcHMuc2hvd0xhYmVsOwoKCQkJLy8gRGVwcmVjYXRlZCBvcHRpb25zCgkJCWRlbGV0ZSBwcm9wcy5pY29uczsKCQkJaWYgKCB0eXBlb2YgcHJvcHMudGV4dCA9PT0gImJvb2xlYW4iICkgewoJCQkJZGVsZXRlIHByb3BzLnRleHQ7CgkJCX0KCgkJCSQoICI8YnV0dG9uPjwvYnV0dG9uPiIsIHByb3BzICkKCQkJCS5idXR0b24oIGJ1dHRvbk9wdGlvbnMgKQoJCQkJLmFwcGVuZFRvKCB0aGF0LnVpQnV0dG9uU2V0ICkKCQkJCS5vbiggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQkJY2xpY2suYXBwbHkoIHRoYXQuZWxlbWVudFsgMCBdLCBhcmd1bWVudHMgKTsKCQkJCX0gKTsKCQl9ICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudWlEaWFsb2csICJ1aS1kaWFsb2ctYnV0dG9ucyIgKTsKCQl0aGlzLnVpRGlhbG9nQnV0dG9uUGFuZS5hcHBlbmRUbyggdGhpcy51aURpYWxvZyApOwoJfSwKCglfbWFrZURyYWdnYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQlmdW5jdGlvbiBmaWx0ZXJlZFVpKCB1aSApIHsKCQkJcmV0dXJuIHsKCQkJCXBvc2l0aW9uOiB1aS5wb3NpdGlvbiwKCQkJCW9mZnNldDogdWkub2Zmc2V0CgkJCX07CgkJfQoKCQl0aGlzLnVpRGlhbG9nLmRyYWdnYWJsZSggewoJCQljYW5jZWw6ICIudWktZGlhbG9nLWNvbnRlbnQsIC51aS1kaWFsb2ctdGl0bGViYXItY2xvc2UiLAoJCQloYW5kbGU6ICIudWktZGlhbG9nLXRpdGxlYmFyIiwKCQkJY29udGFpbm1lbnQ6ICJkb2N1bWVudCIsCgkJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCQkJdGhhdC5fYWRkQ2xhc3MoICQoIHRoaXMgKSwgInVpLWRpYWxvZy1kcmFnZ2luZyIgKTsKCQkJCXRoYXQuX2Jsb2NrRnJhbWVzKCk7CgkJCQl0aGF0Ll90cmlnZ2VyKCAiZHJhZ1N0YXJ0IiwgZXZlbnQsIGZpbHRlcmVkVWkoIHVpICkgKTsKCQkJfSwKCQkJZHJhZzogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsKCQkJCXRoYXQuX3RyaWdnZXIoICJkcmFnIiwgZXZlbnQsIGZpbHRlcmVkVWkoIHVpICkgKTsKCQkJfSwKCQkJc3RvcDogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsKCQkJCXZhciBsZWZ0ID0gdWkub2Zmc2V0LmxlZnQgLSB0aGF0LmRvY3VtZW50LnNjcm9sbExlZnQoKSwKCQkJCQl0b3AgPSB1aS5vZmZzZXQudG9wIC0gdGhhdC5kb2N1bWVudC5zY3JvbGxUb3AoKTsKCgkJCQlvcHRpb25zLnBvc2l0aW9uID0gewoJCQkJCW15OiAibGVmdCB0b3AiLAoJCQkJCWF0OiAibGVmdCIgKyAoIGxlZnQgPj0gMCA/ICIrIiA6ICIiICkgKyBsZWZ0ICsgIiAiICsKCQkJCQkJInRvcCIgKyAoIHRvcCA+PSAwID8gIisiIDogIiIgKSArIHRvcCwKCQkJCQlvZjogdGhhdC53aW5kb3cKCQkJCX07CgkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggJCggdGhpcyApLCAidWktZGlhbG9nLWRyYWdnaW5nIiApOwoJCQkJdGhhdC5fdW5ibG9ja0ZyYW1lcygpOwoJCQkJdGhhdC5fdHJpZ2dlciggImRyYWdTdG9wIiwgZXZlbnQsIGZpbHRlcmVkVWkoIHVpICkgKTsKCQkJfQoJCX0gKTsKCX0sCgoJX21ha2VSZXNpemFibGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJaGFuZGxlcyA9IG9wdGlvbnMucmVzaXphYmxlLAoKCQkJLy8gLnVpLXJlc2l6YWJsZSBoYXMgcG9zaXRpb246IHJlbGF0aXZlIGRlZmluZWQgaW4gdGhlIHN0eWxlc2hlZXQKCQkJLy8gYnV0IGRpYWxvZ3MgaGF2ZSB0byB1c2UgYWJzb2x1dGUgb3IgZml4ZWQgcG9zaXRpb25pbmcKCQkJcG9zaXRpb24gPSB0aGlzLnVpRGlhbG9nLmNzcyggInBvc2l0aW9uIiApLAoJCQlyZXNpemVIYW5kbGVzID0gdHlwZW9mIGhhbmRsZXMgPT09ICJzdHJpbmciID8KCQkJCWhhbmRsZXMgOgoJCQkJIm4sZSxzLHcsc2Usc3csbmUsbnciOwoKCQlmdW5jdGlvbiBmaWx0ZXJlZFVpKCB1aSApIHsKCQkJcmV0dXJuIHsKCQkJCW9yaWdpbmFsUG9zaXRpb246IHVpLm9yaWdpbmFsUG9zaXRpb24sCgkJCQlvcmlnaW5hbFNpemU6IHVpLm9yaWdpbmFsU2l6ZSwKCQkJCXBvc2l0aW9uOiB1aS5wb3NpdGlvbiwKCQkJCXNpemU6IHVpLnNpemUKCQkJfTsKCQl9CgoJCXRoaXMudWlEaWFsb2cucmVzaXphYmxlKCB7CgkJCWNhbmNlbDogIi51aS1kaWFsb2ctY29udGVudCIsCgkJCWNvbnRhaW5tZW50OiAiZG9jdW1lbnQiLAoJCQlhbHNvUmVzaXplOiB0aGlzLmVsZW1lbnQsCgkJCW1heFdpZHRoOiBvcHRpb25zLm1heFdpZHRoLAoJCQltYXhIZWlnaHQ6IG9wdGlvbnMubWF4SGVpZ2h0LAoJCQltaW5XaWR0aDogb3B0aW9ucy5taW5XaWR0aCwKCQkJbWluSGVpZ2h0OiB0aGlzLl9taW5IZWlnaHQoKSwKCQkJaGFuZGxlczogcmVzaXplSGFuZGxlcywKCQkJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCQl0aGF0Ll9hZGRDbGFzcyggJCggdGhpcyApLCAidWktZGlhbG9nLXJlc2l6aW5nIiApOwoJCQkJdGhhdC5fYmxvY2tGcmFtZXMoKTsKCQkJCXRoYXQuX3RyaWdnZXIoICJyZXNpemVTdGFydCIsIGV2ZW50LCBmaWx0ZXJlZFVpKCB1aSApICk7CgkJCX0sCgkJCXJlc2l6ZTogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsKCQkJCXRoYXQuX3RyaWdnZXIoICJyZXNpemUiLCBldmVudCwgZmlsdGVyZWRVaSggdWkgKSApOwoJCQl9LAoJCQlzdG9wOiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCQkJdmFyIG9mZnNldCA9IHRoYXQudWlEaWFsb2cub2Zmc2V0KCksCgkJCQkJbGVmdCA9IG9mZnNldC5sZWZ0IC0gdGhhdC5kb2N1bWVudC5zY3JvbGxMZWZ0KCksCgkJCQkJdG9wID0gb2Zmc2V0LnRvcCAtIHRoYXQuZG9jdW1lbnQuc2Nyb2xsVG9wKCk7CgoJCQkJb3B0aW9ucy5oZWlnaHQgPSB0aGF0LnVpRGlhbG9nLmhlaWdodCgpOwoJCQkJb3B0aW9ucy53aWR0aCA9IHRoYXQudWlEaWFsb2cud2lkdGgoKTsKCQkJCW9wdGlvbnMucG9zaXRpb24gPSB7CgkJCQkJbXk6ICJsZWZ0IHRvcCIsCgkJCQkJYXQ6ICJsZWZ0IiArICggbGVmdCA+PSAwID8gIisiIDogIiIgKSArIGxlZnQgKyAiICIgKwoJCQkJCQkidG9wIiArICggdG9wID49IDAgPyAiKyIgOiAiIiApICsgdG9wLAoJCQkJCW9mOiB0aGF0LndpbmRvdwoJCQkJfTsKCQkJCXRoYXQuX3JlbW92ZUNsYXNzKCAkKCB0aGlzICksICJ1aS1kaWFsb2ctcmVzaXppbmciICk7CgkJCQl0aGF0Ll91bmJsb2NrRnJhbWVzKCk7CgkJCQl0aGF0Ll90cmlnZ2VyKCAicmVzaXplU3RvcCIsIGV2ZW50LCBmaWx0ZXJlZFVpKCB1aSApICk7CgkJCX0KCQl9ICkKCQkJLmNzcyggInBvc2l0aW9uIiwgcG9zaXRpb24gKTsKCX0sCgoJX3RyYWNrRm9jdXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCB0aGlzLndpZGdldCgpLCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXRoaXMuX21ha2VGb2N1c1RhcmdldCgpOwoJCQkJdGhpcy5fZm9jdXNlZEVsZW1lbnQgPSAkKCBldmVudC50YXJnZXQgKTsKCQkJfQoJCX0gKTsKCX0sCgoJX21ha2VGb2N1c1RhcmdldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdW50cmFja0luc3RhbmNlKCk7CgkJdGhpcy5fdHJhY2tpbmdJbnN0YW5jZXMoKS51bnNoaWZ0KCB0aGlzICk7Cgl9LAoKCV91bnRyYWNrSW5zdGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnN0YW5jZXMgPSB0aGlzLl90cmFja2luZ0luc3RhbmNlcygpLAoJCQlleGlzdHMgPSAkLmluQXJyYXkoIHRoaXMsIGluc3RhbmNlcyApOwoJCWlmICggZXhpc3RzICE9PSAtMSApIHsKCQkJaW5zdGFuY2VzLnNwbGljZSggZXhpc3RzLCAxICk7CgkJfQoJfSwKCglfdHJhY2tpbmdJbnN0YW5jZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnN0YW5jZXMgPSB0aGlzLmRvY3VtZW50LmRhdGEoICJ1aS1kaWFsb2ctaW5zdGFuY2VzIiApOwoJCWlmICggIWluc3RhbmNlcyApIHsKCQkJaW5zdGFuY2VzID0gW107CgkJCXRoaXMuZG9jdW1lbnQuZGF0YSggInVpLWRpYWxvZy1pbnN0YW5jZXMiLCBpbnN0YW5jZXMgKTsKCQl9CgkJcmV0dXJuIGluc3RhbmNlczsKCX0sCgoJX21pbkhlaWdodDogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCXJldHVybiBvcHRpb25zLmhlaWdodCA9PT0gImF1dG8iID8KCQkJb3B0aW9ucy5taW5IZWlnaHQgOgoJCQlNYXRoLm1pbiggb3B0aW9ucy5taW5IZWlnaHQsIG9wdGlvbnMuaGVpZ2h0ICk7Cgl9LAoKCV9wb3NpdGlvbjogZnVuY3Rpb24oKSB7CgoJCS8vIE5lZWQgdG8gc2hvdyB0aGUgZGlhbG9nIHRvIGdldCB0aGUgYWN0dWFsIG9mZnNldCBpbiB0aGUgcG9zaXRpb24gcGx1Z2luCgkJdmFyIGlzVmlzaWJsZSA9IHRoaXMudWlEaWFsb2cuaXMoICI6dmlzaWJsZSIgKTsKCQlpZiAoICFpc1Zpc2libGUgKSB7CgkJCXRoaXMudWlEaWFsb2cuc2hvdygpOwoJCX0KCQl0aGlzLnVpRGlhbG9nLnBvc2l0aW9uKCB0aGlzLm9wdGlvbnMucG9zaXRpb24gKTsKCQlpZiAoICFpc1Zpc2libGUgKSB7CgkJCXRoaXMudWlEaWFsb2cuaGlkZSgpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJcmVzaXplID0gZmFsc2UsCgkJCXJlc2l6YWJsZU9wdGlvbnMgPSB7fTsKCgkJJC5lYWNoKCBvcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJdGhhdC5fc2V0T3B0aW9uKCBrZXksIHZhbHVlICk7CgoJCQlpZiAoIGtleSBpbiB0aGF0LnNpemVSZWxhdGVkT3B0aW9ucyApIHsKCQkJCXJlc2l6ZSA9IHRydWU7CgkJCX0KCQkJaWYgKCBrZXkgaW4gdGhhdC5yZXNpemFibGVSZWxhdGVkT3B0aW9ucyApIHsKCQkJCXJlc2l6YWJsZU9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCX0KCQl9ICk7CgoJCWlmICggcmVzaXplICkgewoJCQl0aGlzLl9zaXplKCk7CgkJCXRoaXMuX3Bvc2l0aW9uKCk7CgkJfQoJCWlmICggdGhpcy51aURpYWxvZy5pcyggIjpkYXRhKHVpLXJlc2l6YWJsZSkiICkgKSB7CgkJCXRoaXMudWlEaWFsb2cucmVzaXphYmxlKCAib3B0aW9uIiwgcmVzaXphYmxlT3B0aW9ucyApOwoJCX0KCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIGlzRHJhZ2dhYmxlLCBpc1Jlc2l6YWJsZSwKCQkJdWlEaWFsb2cgPSB0aGlzLnVpRGlhbG9nOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCgkJaWYgKCBrZXkgPT09ICJhcHBlbmRUbyIgKSB7CgkJCXRoaXMudWlEaWFsb2cuYXBwZW5kVG8oIHRoaXMuX2FwcGVuZFRvKCkgKTsKCQl9CgoJCWlmICgga2V5ID09PSAiYnV0dG9ucyIgKSB7CgkJCXRoaXMuX2NyZWF0ZUJ1dHRvbnMoKTsKCQl9CgoJCWlmICgga2V5ID09PSAiY2xvc2VUZXh0IiApIHsKCQkJdGhpcy51aURpYWxvZ1RpdGxlYmFyQ2xvc2UuYnV0dG9uKCB7CgoJCQkJLy8gRW5zdXJlIHRoYXQgd2UgYWx3YXlzIHBhc3MgYSBzdHJpbmcKCQkJCWxhYmVsOiAkKCAiPGE+IiApLnRleHQoICIiICsgdGhpcy5vcHRpb25zLmNsb3NlVGV4dCApLmh0bWwoKQoJCQl9ICk7CgkJfQoKCQlpZiAoIGtleSA9PT0gImRyYWdnYWJsZSIgKSB7CgkJCWlzRHJhZ2dhYmxlID0gdWlEaWFsb2cuaXMoICI6ZGF0YSh1aS1kcmFnZ2FibGUpIiApOwoJCQlpZiAoIGlzRHJhZ2dhYmxlICYmICF2YWx1ZSApIHsKCQkJCXVpRGlhbG9nLmRyYWdnYWJsZSggImRlc3Ryb3kiICk7CgkJCX0KCgkJCWlmICggIWlzRHJhZ2dhYmxlICYmIHZhbHVlICkgewoJCQkJdGhpcy5fbWFrZURyYWdnYWJsZSgpOwoJCQl9CgkJfQoKCQlpZiAoIGtleSA9PT0gInBvc2l0aW9uIiApIHsKCQkJdGhpcy5fcG9zaXRpb24oKTsKCQl9CgoJCWlmICgga2V5ID09PSAicmVzaXphYmxlIiApIHsKCgkJCS8vIGN1cnJlbnRseSByZXNpemFibGUsIGJlY29taW5nIG5vbi1yZXNpemFibGUKCQkJaXNSZXNpemFibGUgPSB1aURpYWxvZy5pcyggIjpkYXRhKHVpLXJlc2l6YWJsZSkiICk7CgkJCWlmICggaXNSZXNpemFibGUgJiYgIXZhbHVlICkgewoJCQkJdWlEaWFsb2cucmVzaXphYmxlKCAiZGVzdHJveSIgKTsKCQkJfQoKCQkJLy8gQ3VycmVudGx5IHJlc2l6YWJsZSwgY2hhbmdpbmcgaGFuZGxlcwoJCQlpZiAoIGlzUmVzaXphYmxlICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgKSB7CgkJCQl1aURpYWxvZy5yZXNpemFibGUoICJvcHRpb24iLCAiaGFuZGxlcyIsIHZhbHVlICk7CgkJCX0KCgkJCS8vIEN1cnJlbnRseSBub24tcmVzaXphYmxlLCBiZWNvbWluZyByZXNpemFibGUKCQkJaWYgKCAhaXNSZXNpemFibGUgJiYgdmFsdWUgIT09IGZhbHNlICkgewoJCQkJdGhpcy5fbWFrZVJlc2l6YWJsZSgpOwoJCQl9CgkJfQoKCQlpZiAoIGtleSA9PT0gInRpdGxlIiApIHsKCQkJdGhpcy5fdGl0bGUoIHRoaXMudWlEaWFsb2dUaXRsZWJhci5maW5kKCAiLnVpLWRpYWxvZy10aXRsZSIgKSApOwoJCX0KCX0sCgoJX3NpemU6IGZ1bmN0aW9uKCkgewoKCQkvLyBJZiB0aGUgdXNlciBoYXMgcmVzaXplZCB0aGUgZGlhbG9nLCB0aGUgLnVpLWRpYWxvZyBhbmQgLnVpLWRpYWxvZy1jb250ZW50CgkJLy8gZGl2cyB3aWxsIGJvdGggaGF2ZSB3aWR0aCBhbmQgaGVpZ2h0IHNldCwgc28gd2UgbmVlZCB0byByZXNldCB0aGVtCgkJdmFyIG5vbkNvbnRlbnRIZWlnaHQsIG1pbkNvbnRlbnRIZWlnaHQsIG1heENvbnRlbnRIZWlnaHQsCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFJlc2V0IGNvbnRlbnQgc2l6aW5nCgkJdGhpcy5lbGVtZW50LnNob3coKS5jc3MoIHsKCQkJd2lkdGg6ICJhdXRvIiwKCQkJbWluSGVpZ2h0OiAwLAoJCQltYXhIZWlnaHQ6ICJub25lIiwKCQkJaGVpZ2h0OiAwCgkJfSApOwoKCQlpZiAoIG9wdGlvbnMubWluV2lkdGggPiBvcHRpb25zLndpZHRoICkgewoJCQlvcHRpb25zLndpZHRoID0gb3B0aW9ucy5taW5XaWR0aDsKCQl9CgoJCS8vIFJlc2V0IHdyYXBwZXIgc2l6aW5nCgkJLy8gZGV0ZXJtaW5lIHRoZSBoZWlnaHQgb2YgYWxsIHRoZSBub24tY29udGVudCBlbGVtZW50cwoJCW5vbkNvbnRlbnRIZWlnaHQgPSB0aGlzLnVpRGlhbG9nLmNzcyggewoJCQloZWlnaHQ6ICJhdXRvIiwKCQkJd2lkdGg6IG9wdGlvbnMud2lkdGgKCQl9ICkKCQkJLm91dGVySGVpZ2h0KCk7CgkJbWluQ29udGVudEhlaWdodCA9IE1hdGgubWF4KCAwLCBvcHRpb25zLm1pbkhlaWdodCAtIG5vbkNvbnRlbnRIZWlnaHQgKTsKCQltYXhDb250ZW50SGVpZ2h0ID0gdHlwZW9mIG9wdGlvbnMubWF4SGVpZ2h0ID09PSAibnVtYmVyIiA/CgkJCU1hdGgubWF4KCAwLCBvcHRpb25zLm1heEhlaWdodCAtIG5vbkNvbnRlbnRIZWlnaHQgKSA6CgkJCSJub25lIjsKCgkJaWYgKCBvcHRpb25zLmhlaWdodCA9PT0gImF1dG8iICkgewoJCQl0aGlzLmVsZW1lbnQuY3NzKCB7CgkJCQltaW5IZWlnaHQ6IG1pbkNvbnRlbnRIZWlnaHQsCgkJCQltYXhIZWlnaHQ6IG1heENvbnRlbnRIZWlnaHQsCgkJCQloZWlnaHQ6ICJhdXRvIgoJCQl9ICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LmhlaWdodCggTWF0aC5tYXgoIDAsIG9wdGlvbnMuaGVpZ2h0IC0gbm9uQ29udGVudEhlaWdodCApICk7CgkJfQoKCQlpZiAoIHRoaXMudWlEaWFsb2cuaXMoICI6ZGF0YSh1aS1yZXNpemFibGUpIiApICkgewoJCQl0aGlzLnVpRGlhbG9nLnJlc2l6YWJsZSggIm9wdGlvbiIsICJtaW5IZWlnaHQiLCB0aGlzLl9taW5IZWlnaHQoKSApOwoJCX0KCX0sCgoJX2Jsb2NrRnJhbWVzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmlmcmFtZUJsb2NrcyA9IHRoaXMuZG9jdW1lbnQuZmluZCggImlmcmFtZSIgKS5tYXAoIGZ1bmN0aW9uKCkgewoJCQl2YXIgaWZyYW1lID0gJCggdGhpcyApOwoKCQkJcmV0dXJuICQoICI8ZGl2PiIgKQoJCQkJLmNzcyggewoJCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLAoJCQkJCXdpZHRoOiBpZnJhbWUub3V0ZXJXaWR0aCgpLAoJCQkJCWhlaWdodDogaWZyYW1lLm91dGVySGVpZ2h0KCkKCQkJCX0gKQoJCQkJLmFwcGVuZFRvKCBpZnJhbWUucGFyZW50KCkgKQoJCQkJLm9mZnNldCggaWZyYW1lLm9mZnNldCgpIClbIDAgXTsKCQl9ICk7Cgl9LAoKCV91bmJsb2NrRnJhbWVzOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuaWZyYW1lQmxvY2tzICkgewoJCQl0aGlzLmlmcmFtZUJsb2Nrcy5yZW1vdmUoKTsKCQkJZGVsZXRlIHRoaXMuaWZyYW1lQmxvY2tzOwoJCX0KCX0sCgoJX2FsbG93SW50ZXJhY3Rpb246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktZGlhbG9nIiApLmxlbmd0aCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQkvLyBUT0RPOiBSZW1vdmUgaGFjayB3aGVuIGRhdGVwaWNrZXIgaW1wbGVtZW50cwoJCS8vIHRoZSAudWktZnJvbnQgbG9naWMgKCM4OTg5KQoJCXJldHVybiAhISQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktZGF0ZXBpY2tlciIgKS5sZW5ndGg7Cgl9LAoKCV9jcmVhdGVPdmVybGF5OiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzLm9wdGlvbnMubW9kYWwgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIHVzZSBhIGRlbGF5IGluIGNhc2UgdGhlIG92ZXJsYXkgaXMgY3JlYXRlZCBmcm9tIGFuCgkJLy8gZXZlbnQgdGhhdCB3ZSdyZSBnb2luZyB0byBiZSBjYW5jZWxsaW5nICgjMjgwNCkKCQl2YXIgaXNPcGVuaW5nID0gdHJ1ZTsKCQl0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCWlzT3BlbmluZyA9IGZhbHNlOwoJCX0gKTsKCgkJaWYgKCAhdGhpcy5kb2N1bWVudC5kYXRhKCAidWktZGlhbG9nLW92ZXJsYXlzIiApICkgewoKCQkJLy8gUHJldmVudCB1c2Ugb2YgYW5jaG9ycyBhbmQgaW5wdXRzCgkJCS8vIFVzaW5nIF9vbigpIGZvciBhbiBldmVudCBoYW5kbGVyIHNoYXJlZCBhY3Jvc3MgbWFueSBpbnN0YW5jZXMgaXMKCQkJLy8gc2FmZSBiZWNhdXNlIHRoZSBkaWFsb2dzIHN0YWNrIGFuZCBtdXN0IGJlIGNsb3NlZCBpbiByZXZlcnNlIG9yZGVyCgkJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCQlmb2N1c2luOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBpc09wZW5pbmcgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCWlmICggIXRoaXMuX2FsbG93SW50ZXJhY3Rpb24oIGV2ZW50ICkgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCXRoaXMuX3RyYWNraW5nSW5zdGFuY2VzKClbIDAgXS5fZm9jdXNUYWJiYWJsZSgpOwoJCQkJCX0KCQkJCX0KCQkJfSApOwoJCX0KCgkJdGhpcy5vdmVybGF5ID0gJCggIjxkaXY+IiApCgkJCS5hcHBlbmRUbyggdGhpcy5fYXBwZW5kVG8oKSApOwoKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5vdmVybGF5LCBudWxsLCAidWktd2lkZ2V0LW92ZXJsYXkgdWktZnJvbnQiICk7CgkJdGhpcy5fb24oIHRoaXMub3ZlcmxheSwgewoJCQltb3VzZWRvd246ICJfa2VlcEZvY3VzIgoJCX0gKTsKCQl0aGlzLmRvY3VtZW50LmRhdGEoICJ1aS1kaWFsb2ctb3ZlcmxheXMiLAoJCQkoIHRoaXMuZG9jdW1lbnQuZGF0YSggInVpLWRpYWxvZy1vdmVybGF5cyIgKSB8fCAwICkgKyAxICk7Cgl9LAoKCV9kZXN0cm95T3ZlcmxheTogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpcy5vcHRpb25zLm1vZGFsICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRoaXMub3ZlcmxheSApIHsKCQkJdmFyIG92ZXJsYXlzID0gdGhpcy5kb2N1bWVudC5kYXRhKCAidWktZGlhbG9nLW92ZXJsYXlzIiApIC0gMTsKCgkJCWlmICggIW92ZXJsYXlzICkgewoJCQkJdGhpcy5fb2ZmKCB0aGlzLmRvY3VtZW50LCAiZm9jdXNpbiIgKTsKCQkJCXRoaXMuZG9jdW1lbnQucmVtb3ZlRGF0YSggInVpLWRpYWxvZy1vdmVybGF5cyIgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZG9jdW1lbnQuZGF0YSggInVpLWRpYWxvZy1vdmVybGF5cyIsIG92ZXJsYXlzICk7CgkJCX0KCgkJCXRoaXMub3ZlcmxheS5yZW1vdmUoKTsKCQkJdGhpcy5vdmVybGF5ID0gbnVsbDsKCQl9Cgl9Cn0gKTsKCi8vIERFUFJFQ0FURUQKLy8gVE9ETzogc3dpdGNoIHJldHVybiBiYWNrIHRvIHdpZGdldCBkZWNsYXJhdGlvbiBhdCB0b3Agb2YgZmlsZSB3aGVuIHRoaXMgaXMgcmVtb3ZlZAppZiAoICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSApIHsKCgkvLyBCYWNrY29tcGF0IGZvciBkaWFsb2dDbGFzcyBvcHRpb24KCSQud2lkZ2V0KCAidWkuZGlhbG9nIiwgJC51aS5kaWFsb2csIHsKCQlvcHRpb25zOiB7CgkJCWRpYWxvZ0NsYXNzOiAiIgoJCX0sCgkJX2NyZWF0ZVdyYXBwZXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLnVpRGlhbG9nLmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuZGlhbG9nQ2xhc3MgKTsKCQl9LAoJCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQlpZiAoIGtleSA9PT0gImRpYWxvZ0NsYXNzIiApIHsKCQkJCXRoaXMudWlEaWFsb2cKCQkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy5kaWFsb2dDbGFzcyApCgkJCQkJLmFkZENsYXNzKCB2YWx1ZSApOwoJCQl9CgkJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOwoJCX0KCX0gKTsKfQoKdmFyIHdpZGdldHNEaWFsb2cgPSAkLnVpLmRpYWxvZzsKCgovKiEKICogalF1ZXJ5IFVJIFByb2dyZXNzYmFyIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogUHJvZ3Jlc3NiYXIKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vIGpzY3M6ZGlzYWJsZSBtYXhpbXVtTGluZUxlbmd0aAovLz4+ZGVzY3JpcHRpb246IERpc3BsYXlzIGEgc3RhdHVzIGluZGljYXRvciBmb3IgbG9hZGluZyBzdGF0ZSwgc3RhbmRhcmQgcGVyY2VudGFnZSwgYW5kIG90aGVyIHByb2dyZXNzIGluZGljYXRvcnMuCi8vIGpzY3M6ZW5hYmxlIG1heGltdW1MaW5lTGVuZ3RoCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9wcm9ncmVzc2Jhci8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL3Byb2dyZXNzYmFyLwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MKLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3Byb2dyZXNzYmFyLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKdmFyIHdpZGdldHNQcm9ncmVzc2JhciA9ICQud2lkZ2V0KCAidWkucHJvZ3Jlc3NiYXIiLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCSJ1aS1wcm9ncmVzc2JhciI6ICJ1aS1jb3JuZXItYWxsIiwKCQkJInVpLXByb2dyZXNzYmFyLXZhbHVlIjogInVpLWNvcm5lci1sZWZ0IiwKCQkJInVpLXByb2dyZXNzYmFyLWNvbXBsZXRlIjogInVpLWNvcm5lci1yaWdodCIKCQl9LAoJCW1heDogMTAwLAoJCXZhbHVlOiAwLAoKCQljaGFuZ2U6IG51bGwsCgkJY29tcGxldGU6IG51bGwKCX0sCgoJbWluOiAwLAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBDb25zdHJhaW4gaW5pdGlhbCB2YWx1ZQoJCXRoaXMub2xkVmFsdWUgPSB0aGlzLm9wdGlvbnMudmFsdWUgPSB0aGlzLl9jb25zdHJhaW5lZFZhbHVlKCk7CgoJCXRoaXMuZWxlbWVudC5hdHRyKCB7CgoJCQkvLyBPbmx5IHNldCBzdGF0aWMgdmFsdWVzOyBhcmlhLXZhbHVlbm93IGFuZCBhcmlhLXZhbHVlbWF4IGFyZQoJCQkvLyBzZXQgaW5zaWRlIF9yZWZyZXNoVmFsdWUoKQoJCQlyb2xlOiAicHJvZ3Jlc3NiYXIiLAoJCQkiYXJpYS12YWx1ZW1pbiI6IHRoaXMubWluCgkJfSApOwoJCXRoaXMuX2FkZENsYXNzKCAidWktcHJvZ3Jlc3NiYXIiLCAidWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IiApOwoKCQl0aGlzLnZhbHVlRGl2ID0gJCggIjxkaXY+IiApLmFwcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy52YWx1ZURpdiwgInVpLXByb2dyZXNzYmFyLXZhbHVlIiwgInVpLXdpZGdldC1oZWFkZXIiICk7CgkJdGhpcy5fcmVmcmVzaFZhbHVlKCk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQXR0ciggInJvbGUgYXJpYS12YWx1ZW1pbiBhcmlhLXZhbHVlbWF4IGFyaWEtdmFsdWVub3ciICk7CgoJCXRoaXMudmFsdWVEaXYucmVtb3ZlKCk7Cgl9LAoKCXZhbHVlOiBmdW5jdGlvbiggbmV3VmFsdWUgKSB7CgkJaWYgKCBuZXdWYWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdGhpcy5vcHRpb25zLnZhbHVlOwoJCX0KCgkJdGhpcy5vcHRpb25zLnZhbHVlID0gdGhpcy5fY29uc3RyYWluZWRWYWx1ZSggbmV3VmFsdWUgKTsKCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsKCX0sCgoJX2NvbnN0cmFpbmVkVmFsdWU6IGZ1bmN0aW9uKCBuZXdWYWx1ZSApIHsKCQlpZiAoIG5ld1ZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCW5ld1ZhbHVlID0gdGhpcy5vcHRpb25zLnZhbHVlOwoJCX0KCgkJdGhpcy5pbmRldGVybWluYXRlID0gbmV3VmFsdWUgPT09IGZhbHNlOwoKCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCWlmICggdHlwZW9mIG5ld1ZhbHVlICE9PSAibnVtYmVyIiApIHsKCQkJbmV3VmFsdWUgPSAwOwoJCX0KCgkJcmV0dXJuIHRoaXMuaW5kZXRlcm1pbmF0ZSA/IGZhbHNlIDoKCQkJTWF0aC5taW4oIHRoaXMub3B0aW9ucy5tYXgsIE1hdGgubWF4KCB0aGlzLm1pbiwgbmV3VmFsdWUgKSApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJCS8vIEVuc3VyZSAidmFsdWUiIG9wdGlvbiBpcyBzZXQgYWZ0ZXIgb3RoZXIgdmFsdWVzIChsaWtlIG1heCkKCQl2YXIgdmFsdWUgPSBvcHRpb25zLnZhbHVlOwoJCWRlbGV0ZSBvcHRpb25zLnZhbHVlOwoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQl0aGlzLm9wdGlvbnMudmFsdWUgPSB0aGlzLl9jb25zdHJhaW5lZFZhbHVlKCB2YWx1ZSApOwoJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gIm1heCIgKSB7CgoJCQkvLyBEb24ndCBhbGxvdyBhIG1heCBsZXNzIHRoYW4gbWluCgkJCXZhbHVlID0gTWF0aC5tYXgoIHRoaXMubWluLCB2YWx1ZSApOwoJCX0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJfSwKCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlciggdmFsdWUgKTsKCgkJdGhpcy5lbGVtZW50LmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLl90b2dnbGVDbGFzcyggbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiwgISF2YWx1ZSApOwoJfSwKCglfcGVyY2VudGFnZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuaW5kZXRlcm1pbmF0ZSA/CgkJCTEwMCA6CgkJCTEwMCAqICggdGhpcy5vcHRpb25zLnZhbHVlIC0gdGhpcy5taW4gKSAvICggdGhpcy5vcHRpb25zLm1heCAtIHRoaXMubWluICk7Cgl9LAoKCV9yZWZyZXNoVmFsdWU6IGZ1bmN0aW9uKCkgewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy52YWx1ZSwKCQkJcGVyY2VudGFnZSA9IHRoaXMuX3BlcmNlbnRhZ2UoKTsKCgkJdGhpcy52YWx1ZURpdgoJCQkudG9nZ2xlKCB0aGlzLmluZGV0ZXJtaW5hdGUgfHwgdmFsdWUgPiB0aGlzLm1pbiApCgkJCS53aWR0aCggcGVyY2VudGFnZS50b0ZpeGVkKCAwICkgKyAiJSIgKTsKCgkJdGhpcwoJCQkuX3RvZ2dsZUNsYXNzKCB0aGlzLnZhbHVlRGl2LCAidWktcHJvZ3Jlc3NiYXItY29tcGxldGUiLCBudWxsLAoJCQkJdmFsdWUgPT09IHRoaXMub3B0aW9ucy5tYXggKQoJCQkuX3RvZ2dsZUNsYXNzKCAidWktcHJvZ3Jlc3NiYXItaW5kZXRlcm1pbmF0ZSIsIG51bGwsIHRoaXMuaW5kZXRlcm1pbmF0ZSApOwoKCQlpZiAoIHRoaXMuaW5kZXRlcm1pbmF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJhcmlhLXZhbHVlbm93IiApOwoJCQlpZiAoICF0aGlzLm92ZXJsYXlEaXYgKSB7CgkJCQl0aGlzLm92ZXJsYXlEaXYgPSAkKCAiPGRpdj4iICkuYXBwZW5kVG8oIHRoaXMudmFsdWVEaXYgKTsKCQkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLm92ZXJsYXlEaXYsICJ1aS1wcm9ncmVzc2Jhci1vdmVybGF5IiApOwoJCQl9CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoIHsKCQkJCSJhcmlhLXZhbHVlbWF4IjogdGhpcy5vcHRpb25zLm1heCwKCQkJCSJhcmlhLXZhbHVlbm93IjogdmFsdWUKCQkJfSApOwoJCQlpZiAoIHRoaXMub3ZlcmxheURpdiApIHsKCQkJCXRoaXMub3ZlcmxheURpdi5yZW1vdmUoKTsKCQkJCXRoaXMub3ZlcmxheURpdiA9IG51bGw7CgkJCX0KCQl9CgoJCWlmICggdGhpcy5vbGRWYWx1ZSAhPT0gdmFsdWUgKSB7CgkJCXRoaXMub2xkVmFsdWUgPSB2YWx1ZTsKCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIgKTsKCQl9CgkJaWYgKCB2YWx1ZSA9PT0gdGhpcy5vcHRpb25zLm1heCApIHsKCQkJdGhpcy5fdHJpZ2dlciggImNvbXBsZXRlIiApOwoJCX0KCX0KfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgU2VsZWN0bWVudSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFNlbGVjdG1lbnUKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vIGpzY3M6ZGlzYWJsZSBtYXhpbXVtTGluZUxlbmd0aAovLz4+ZGVzY3JpcHRpb246IER1cGxpY2F0ZXMgYW5kIGV4dGVuZHMgdGhlIGZ1bmN0aW9uYWxpdHkgb2YgYSBuYXRpdmUgSFRNTCBzZWxlY3QgZWxlbWVudCwgYWxsb3dpbmcgaXQgdG8gYmUgY3VzdG9taXphYmxlIGluIGJlaGF2aW9yIGFuZCBhcHBlYXJhbmNlIGZhciBiZXlvbmQgdGhlIGxpbWl0YXRpb25zIG9mIGEgbmF0aXZlIHNlbGVjdC4KLy8ganNjczplbmFibGUgbWF4aW11bUxpbmVMZW5ndGgKLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3NlbGVjdG1lbnUvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9zZWxlY3RtZW51LwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MKLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3NlbGVjdG1lbnUuY3NzLCAuLi8uLi90aGVtZXMvYmFzZS9idXR0b24uY3NzCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcwoKCgp2YXIgd2lkZ2V0c1NlbGVjdG1lbnUgPSAkLndpZGdldCggInVpLnNlbGVjdG1lbnUiLCBbICQudWkuZm9ybVJlc2V0TWl4aW4sIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8c2VsZWN0PiIsCglvcHRpb25zOiB7CgkJYXBwZW5kVG86IG51bGwsCgkJY2xhc3NlczogewoJCQkidWktc2VsZWN0bWVudS1idXR0b24tb3BlbiI6ICJ1aS1jb3JuZXItdG9wIiwKCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLWNsb3NlZCI6ICJ1aS1jb3JuZXItYWxsIgoJCX0sCgkJZGlzYWJsZWQ6IG51bGwsCgkJaWNvbnM6IHsKCQkJYnV0dG9uOiAidWktaWNvbi10cmlhbmdsZS0xLXMiCgkJfSwKCQlwb3NpdGlvbjogewoJCQlteTogImxlZnQgdG9wIiwKCQkJYXQ6ICJsZWZ0IGJvdHRvbSIsCgkJCWNvbGxpc2lvbjogIm5vbmUiCgkJfSwKCQl3aWR0aDogZmFsc2UsCgoJCS8vIENhbGxiYWNrcwoJCWNoYW5nZTogbnVsbCwKCQljbG9zZTogbnVsbCwKCQlmb2N1czogbnVsbCwKCQlvcGVuOiBudWxsLAoJCXNlbGVjdDogbnVsbAoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0bWVudUlkID0gdGhpcy5lbGVtZW50LnVuaXF1ZUlkKCkuYXR0ciggImlkIiApOwoJCXRoaXMuaWRzID0gewoJCQllbGVtZW50OiBzZWxlY3RtZW51SWQsCgkJCWJ1dHRvbjogc2VsZWN0bWVudUlkICsgIi1idXR0b24iLAoJCQltZW51OiBzZWxlY3RtZW51SWQgKyAiLW1lbnUiCgkJfTsKCgkJdGhpcy5fZHJhd0J1dHRvbigpOwoJCXRoaXMuX2RyYXdNZW51KCk7CgkJdGhpcy5fYmluZEZvcm1SZXNldEhhbmRsZXIoKTsKCgkJdGhpcy5fcmVuZGVyZWQgPSBmYWxzZTsKCQl0aGlzLm1lbnVJdGVtcyA9ICQoKTsKCX0sCgoJX2RyYXdCdXR0b246IGZ1bmN0aW9uKCkgewoJCXZhciBpY29uLAoJCQl0aGF0ID0gdGhpcywKCQkJaXRlbSA9IHRoaXMuX3BhcnNlT3B0aW9uKAoJCQkJdGhpcy5lbGVtZW50LmZpbmQoICJvcHRpb246c2VsZWN0ZWQiICksCgkJCQl0aGlzLmVsZW1lbnRbIDAgXS5zZWxlY3RlZEluZGV4CgkJCSk7CgoJCS8vIEFzc29jaWF0ZSBleGlzdGluZyBsYWJlbCB3aXRoIHRoZSBuZXcgYnV0dG9uCgkJdGhpcy5sYWJlbHMgPSB0aGlzLmVsZW1lbnQubGFiZWxzKCkuYXR0ciggImZvciIsIHRoaXMuaWRzLmJ1dHRvbiApOwoJCXRoaXMuX29uKCB0aGlzLmxhYmVscywgewoJCQljbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdGhpcy5idXR0b24uZm9jdXMoKTsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9ICk7CgoJCS8vIEhpZGUgb3JpZ2luYWwgc2VsZWN0IGVsZW1lbnQKCQl0aGlzLmVsZW1lbnQuaGlkZSgpOwoKCQkvLyBDcmVhdGUgYnV0dG9uCgkJdGhpcy5idXR0b24gPSAkKCAiPHNwYW4+IiwgewoJCQl0YWJpbmRleDogdGhpcy5vcHRpb25zLmRpc2FibGVkID8gLTEgOiAwLAoJCQlpZDogdGhpcy5pZHMuYnV0dG9uLAoJCQlyb2xlOiAiY29tYm9ib3giLAoJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIsCgkJCSJhcmlhLWF1dG9jb21wbGV0ZSI6ICJsaXN0IiwKCQkJImFyaWEtb3ducyI6IHRoaXMuaWRzLm1lbnUsCgkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoJCQl0aXRsZTogdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIgKQoJCX0gKQoJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuZWxlbWVudCApOwoKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5idXR0b24sICJ1aS1zZWxlY3RtZW51LWJ1dHRvbiB1aS1zZWxlY3RtZW51LWJ1dHRvbi1jbG9zZWQiLAoJCQkidWktYnV0dG9uIHVpLXdpZGdldCIgKTsKCgkJaWNvbiA9ICQoICI8c3Bhbj4iICkuYXBwZW5kVG8oIHRoaXMuYnV0dG9uICk7CgkJdGhpcy5fYWRkQ2xhc3MoIGljb24sICJ1aS1zZWxlY3RtZW51LWljb24iLCAidWktaWNvbiAiICsgdGhpcy5vcHRpb25zLmljb25zLmJ1dHRvbiApOwoJCXRoaXMuYnV0dG9uSXRlbSA9IHRoaXMuX3JlbmRlckJ1dHRvbkl0ZW0oIGl0ZW0gKQoJCQkuYXBwZW5kVG8oIHRoaXMuYnV0dG9uICk7CgoJCWlmICggdGhpcy5vcHRpb25zLndpZHRoICE9PSBmYWxzZSApIHsKCQkJdGhpcy5fcmVzaXplQnV0dG9uKCk7CgkJfQoKCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHRoaXMuX2J1dHRvbkV2ZW50cyApOwoJCXRoaXMuYnV0dG9uLm9uZSggImZvY3VzaW4iLCBmdW5jdGlvbigpIHsKCgkJCS8vIERlbGF5IHJlbmRlcmluZyB0aGUgbWVudSBpdGVtcyB1bnRpbCB0aGUgYnV0dG9uIHJlY2VpdmVzIGZvY3VzLgoJCQkvLyBUaGUgbWVudSBtYXkgaGF2ZSBhbHJlYWR5IGJlZW4gcmVuZGVyZWQgdmlhIGEgcHJvZ3JhbW1hdGljIG9wZW4uCgkJCWlmICggIXRoYXQuX3JlbmRlcmVkICkgewoJCQkJdGhhdC5fcmVmcmVzaE1lbnUoKTsKCQkJfQoJCX0gKTsKCX0sCgoJX2RyYXdNZW51OiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCS8vIENyZWF0ZSBtZW51CgkJdGhpcy5tZW51ID0gJCggIjx1bD4iLCB7CgkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIiwKCQkJImFyaWEtbGFiZWxsZWRieSI6IHRoaXMuaWRzLmJ1dHRvbiwKCQkJaWQ6IHRoaXMuaWRzLm1lbnUKCQl9ICk7CgoJCS8vIFdyYXAgbWVudQoJCXRoaXMubWVudVdyYXAgPSAkKCAiPGRpdj4iICkuYXBwZW5kKCB0aGlzLm1lbnUgKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5tZW51V3JhcCwgInVpLXNlbGVjdG1lbnUtbWVudSIsICJ1aS1mcm9udCIgKTsKCQl0aGlzLm1lbnVXcmFwLmFwcGVuZFRvKCB0aGlzLl9hcHBlbmRUbygpICk7CgoJCS8vIEluaXRpYWxpemUgbWVudSB3aWRnZXQKCQl0aGlzLm1lbnVJbnN0YW5jZSA9IHRoaXMubWVudQoJCQkubWVudSggewoJCQkJY2xhc3NlczogewoJCQkJCSJ1aS1tZW51IjogInVpLWNvcm5lci1ib3R0b20iCgkJCQl9LAoJCQkJcm9sZTogImxpc3Rib3giLAoJCQkJc2VsZWN0OiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJCS8vIFN1cHBvcnQ6IElFOAoJCQkJCS8vIElmIHRoZSBpdGVtIHdhcyBzZWxlY3RlZCB2aWEgYSBjbGljaywgdGhlIHRleHQgc2VsZWN0aW9uCgkJCQkJLy8gd2lsbCBiZSBkZXN0cm95ZWQgaW4gSUUKCQkJCQl0aGF0Ll9zZXRTZWxlY3Rpb24oKTsKCgkJCQkJdGhhdC5fc2VsZWN0KCB1aS5pdGVtLmRhdGEoICJ1aS1zZWxlY3RtZW51LWl0ZW0iICksIGV2ZW50ICk7CgkJCQl9LAoJCQkJZm9jdXM6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCQkJdmFyIGl0ZW0gPSB1aS5pdGVtLmRhdGEoICJ1aS1zZWxlY3RtZW51LWl0ZW0iICk7CgoJCQkJCS8vIFByZXZlbnQgaW5pdGFsIGZvY3VzIGZyb20gZmlyaW5nIGFuZCBjaGVjayBpZiBpdHMgYSBuZXdseSBmb2N1c2VkIGl0ZW0KCQkJCQlpZiAoIHRoYXQuZm9jdXNJbmRleCAhPSBudWxsICYmIGl0ZW0uaW5kZXggIT09IHRoYXQuZm9jdXNJbmRleCApIHsKCQkJCQkJdGhhdC5fdHJpZ2dlciggImZvY3VzIiwgZXZlbnQsIHsgaXRlbTogaXRlbSB9ICk7CgkJCQkJCWlmICggIXRoYXQuaXNPcGVuICkgewoJCQkJCQkJdGhhdC5fc2VsZWN0KCBpdGVtLCBldmVudCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXRoYXQuZm9jdXNJbmRleCA9IGl0ZW0uaW5kZXg7CgoJCQkJCXRoYXQuYnV0dG9uLmF0dHIoICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiLAoJCQkJCQl0aGF0Lm1lbnVJdGVtcy5lcSggaXRlbS5pbmRleCApLmF0dHIoICJpZCIgKSApOwoJCQkJfQoJCQl9ICkKCQkJLm1lbnUoICJpbnN0YW5jZSIgKTsKCgkJLy8gRG9uJ3QgY2xvc2UgdGhlIG1lbnUgb24gbW91c2VsZWF2ZQoJCXRoaXMubWVudUluc3RhbmNlLl9vZmYoIHRoaXMubWVudSwgIm1vdXNlbGVhdmUiICk7CgoJCS8vIENhbmNlbCB0aGUgbWVudSdzIGNvbGxhcHNlQWxsIG9uIGRvY3VtZW50IGNsaWNrCgkJdGhpcy5tZW51SW5zdGFuY2UuX2Nsb3NlT25Eb2N1bWVudENsaWNrID0gZnVuY3Rpb24oKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQkvLyBTZWxlY3RzIG9mdGVuIGNvbnRhaW4gZW1wdHkgaXRlbXMsIGJ1dCBuZXZlciBjb250YWluIGRpdmlkZXJzCgkJdGhpcy5tZW51SW5zdGFuY2UuX2lzRGl2aWRlciA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaE1lbnUoKTsKCQl0aGlzLmJ1dHRvbkl0ZW0ucmVwbGFjZVdpdGgoCgkJCXRoaXMuYnV0dG9uSXRlbSA9IHRoaXMuX3JlbmRlckJ1dHRvbkl0ZW0oCgoJCQkJLy8gRmFsbCBiYWNrIHRvIGFuIGVtcHR5IG9iamVjdCBpbiBjYXNlIHRoZXJlIGFyZSBubyBvcHRpb25zCgkJCQl0aGlzLl9nZXRTZWxlY3RlZEl0ZW0oKS5kYXRhKCAidWktc2VsZWN0bWVudS1pdGVtIiApIHx8IHt9CgkJCSkKCQkpOwoJCWlmICggdGhpcy5vcHRpb25zLndpZHRoID09PSBudWxsICkgewoJCQl0aGlzLl9yZXNpemVCdXR0b24oKTsKCQl9Cgl9LAoKCV9yZWZyZXNoTWVudTogZnVuY3Rpb24oKSB7CgkJdmFyIGl0ZW0sCgkJCW9wdGlvbnMgPSB0aGlzLmVsZW1lbnQuZmluZCggIm9wdGlvbiIgKTsKCgkJdGhpcy5tZW51LmVtcHR5KCk7CgoJCXRoaXMuX3BhcnNlT3B0aW9ucyggb3B0aW9ucyApOwoJCXRoaXMuX3JlbmRlck1lbnUoIHRoaXMubWVudSwgdGhpcy5pdGVtcyApOwoKCQl0aGlzLm1lbnVJbnN0YW5jZS5yZWZyZXNoKCk7CgkJdGhpcy5tZW51SXRlbXMgPSB0aGlzLm1lbnUuZmluZCggImxpIiApCgkJCS5ub3QoICIudWktc2VsZWN0bWVudS1vcHRncm91cCIgKQoJCQkJLmZpbmQoICIudWktbWVudS1pdGVtLXdyYXBwZXIiICk7CgoJCXRoaXMuX3JlbmRlcmVkID0gdHJ1ZTsKCgkJaWYgKCAhb3B0aW9ucy5sZW5ndGggKSB7CgkJCXJldHVybjsKCQl9CgoJCWl0ZW0gPSB0aGlzLl9nZXRTZWxlY3RlZEl0ZW0oKTsKCgkJLy8gVXBkYXRlIHRoZSBtZW51IHRvIGhhdmUgdGhlIGNvcnJlY3QgaXRlbSBmb2N1c2VkCgkJdGhpcy5tZW51SW5zdGFuY2UuZm9jdXMoIG51bGwsIGl0ZW0gKTsKCQl0aGlzLl9zZXRBcmlhKCBpdGVtLmRhdGEoICJ1aS1zZWxlY3RtZW51LWl0ZW0iICkgKTsKCgkJLy8gU2V0IGRpc2FibGVkIHN0YXRlCgkJdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiApICk7Cgl9LAoKCW9wZW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdGltZSB0aGUgbWVudSBpcyBiZWluZyBvcGVuZWQsIHJlbmRlciB0aGUgaXRlbXMKCQlpZiAoICF0aGlzLl9yZW5kZXJlZCApIHsKCQkJdGhpcy5fcmVmcmVzaE1lbnUoKTsKCQl9IGVsc2UgewoKCQkJLy8gTWVudSBjbGVhcnMgZm9jdXMgb24gY2xvc2UsIHJlc2V0IGZvY3VzIHRvIHNlbGVjdGVkIGl0ZW0KCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMubWVudS5maW5kKCAiLnVpLXN0YXRlLWFjdGl2ZSIgKSwgbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJdGhpcy5tZW51SW5zdGFuY2UuZm9jdXMoIG51bGwsIHRoaXMuX2dldFNlbGVjdGVkSXRlbSgpICk7CgkJfQoKCQkvLyBJZiB0aGVyZSBhcmUgbm8gb3B0aW9ucywgZG9uJ3Qgb3BlbiB0aGUgbWVudQoJCWlmICggIXRoaXMubWVudUl0ZW1zLmxlbmd0aCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5pc09wZW4gPSB0cnVlOwoJCXRoaXMuX3RvZ2dsZUF0dHIoKTsKCQl0aGlzLl9yZXNpemVNZW51KCk7CgkJdGhpcy5fcG9zaXRpb24oKTsKCgkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHRoaXMuX2RvY3VtZW50Q2xpY2sgKTsKCgkJdGhpcy5fdHJpZ2dlciggIm9wZW4iLCBldmVudCApOwoJfSwKCglfcG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCXRoaXMubWVudVdyYXAucG9zaXRpb24oICQuZXh0ZW5kKCB7IG9mOiB0aGlzLmJ1dHRvbiB9LCB0aGlzLm9wdGlvbnMucG9zaXRpb24gKSApOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggIXRoaXMuaXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLmlzT3BlbiA9IGZhbHNlOwoJCXRoaXMuX3RvZ2dsZUF0dHIoKTsKCgkJdGhpcy5yYW5nZSA9IG51bGw7CgkJdGhpcy5fb2ZmKCB0aGlzLmRvY3VtZW50ICk7CgoJCXRoaXMuX3RyaWdnZXIoICJjbG9zZSIsIGV2ZW50ICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuYnV0dG9uOwoJfSwKCgltZW51V2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5tZW51OwoJfSwKCglfcmVuZGVyQnV0dG9uSXRlbTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJdmFyIGJ1dHRvbkl0ZW0gPSAkKCAiPHNwYW4+IiApOwoKCQl0aGlzLl9zZXRUZXh0KCBidXR0b25JdGVtLCBpdGVtLmxhYmVsICk7CgkJdGhpcy5fYWRkQ2xhc3MoIGJ1dHRvbkl0ZW0sICJ1aS1zZWxlY3RtZW51LXRleHQiICk7CgoJCXJldHVybiBidXR0b25JdGVtOwoJfSwKCglfcmVuZGVyTWVudTogZnVuY3Rpb24oIHVsLCBpdGVtcyApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCWN1cnJlbnRPcHRncm91cCA9ICIiOwoKCQkkLmVhY2goIGl0ZW1zLCBmdW5jdGlvbiggaW5kZXgsIGl0ZW0gKSB7CgkJCXZhciBsaTsKCgkJCWlmICggaXRlbS5vcHRncm91cCAhPT0gY3VycmVudE9wdGdyb3VwICkgewoJCQkJbGkgPSAkKCAiPGxpPiIsIHsKCQkJCQl0ZXh0OiBpdGVtLm9wdGdyb3VwCgkJCQl9ICk7CgkJCQl0aGF0Ll9hZGRDbGFzcyggbGksICJ1aS1zZWxlY3RtZW51LW9wdGdyb3VwIiwgInVpLW1lbnUtZGl2aWRlciIgKwoJCQkJCSggaXRlbS5lbGVtZW50LnBhcmVudCggIm9wdGdyb3VwIiApLnByb3AoICJkaXNhYmxlZCIgKSA/CgkJCQkJCSIgdWktc3RhdGUtZGlzYWJsZWQiIDoKCQkJCQkJIiIgKSApOwoKCQkJCWxpLmFwcGVuZFRvKCB1bCApOwoKCQkJCWN1cnJlbnRPcHRncm91cCA9IGl0ZW0ub3B0Z3JvdXA7CgkJCX0KCgkJCXRoYXQuX3JlbmRlckl0ZW1EYXRhKCB1bCwgaXRlbSApOwoJCX0gKTsKCX0sCgoJX3JlbmRlckl0ZW1EYXRhOiBmdW5jdGlvbiggdWwsIGl0ZW0gKSB7CgkJcmV0dXJuIHRoaXMuX3JlbmRlckl0ZW0oIHVsLCBpdGVtICkuZGF0YSggInVpLXNlbGVjdG1lbnUtaXRlbSIsIGl0ZW0gKTsKCX0sCgoJX3JlbmRlckl0ZW06IGZ1bmN0aW9uKCB1bCwgaXRlbSApIHsKCQl2YXIgbGkgPSAkKCAiPGxpPiIgKSwKCQkJd3JhcHBlciA9ICQoICI8ZGl2PiIsIHsKCQkJCXRpdGxlOiBpdGVtLmVsZW1lbnQuYXR0ciggInRpdGxlIiApCgkJCX0gKTsKCgkJaWYgKCBpdGVtLmRpc2FibGVkICkgewoJCQl0aGlzLl9hZGRDbGFzcyggbGksIG51bGwsICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCQl9CgkJdGhpcy5fc2V0VGV4dCggd3JhcHBlciwgaXRlbS5sYWJlbCApOwoKCQlyZXR1cm4gbGkuYXBwZW5kKCB3cmFwcGVyICkuYXBwZW5kVG8oIHVsICk7Cgl9LAoKCV9zZXRUZXh0OiBmdW5jdGlvbiggZWxlbWVudCwgdmFsdWUgKSB7CgkJaWYgKCB2YWx1ZSApIHsKCQkJZWxlbWVudC50ZXh0KCB2YWx1ZSApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQuaHRtbCggIiYjMTYwOyIgKTsKCQl9Cgl9LAoKCV9tb3ZlOiBmdW5jdGlvbiggZGlyZWN0aW9uLCBldmVudCApIHsKCQl2YXIgaXRlbSwgbmV4dCwKCQkJZmlsdGVyID0gIi51aS1tZW51LWl0ZW0iOwoKCQlpZiAoIHRoaXMuaXNPcGVuICkgewoJCQlpdGVtID0gdGhpcy5tZW51SXRlbXMuZXEoIHRoaXMuZm9jdXNJbmRleCApLnBhcmVudCggImxpIiApOwoJCX0gZWxzZSB7CgkJCWl0ZW0gPSB0aGlzLm1lbnVJdGVtcy5lcSggdGhpcy5lbGVtZW50WyAwIF0uc2VsZWN0ZWRJbmRleCApLnBhcmVudCggImxpIiApOwoJCQlmaWx0ZXIgKz0gIjpub3QoLnVpLXN0YXRlLWRpc2FibGVkKSI7CgkJfQoKCQlpZiAoIGRpcmVjdGlvbiA9PT0gImZpcnN0IiB8fCBkaXJlY3Rpb24gPT09ICJsYXN0IiApIHsKCQkJbmV4dCA9IGl0ZW1bIGRpcmVjdGlvbiA9PT0gImZpcnN0IiA/ICJwcmV2QWxsIiA6ICJuZXh0QWxsIiBdKCBmaWx0ZXIgKS5lcSggLTEgKTsKCQl9IGVsc2UgewoJCQluZXh0ID0gaXRlbVsgZGlyZWN0aW9uICsgIkFsbCIgXSggZmlsdGVyICkuZXEoIDAgKTsKCQl9CgoJCWlmICggbmV4dC5sZW5ndGggKSB7CgkJCXRoaXMubWVudUluc3RhbmNlLmZvY3VzKCBldmVudCwgbmV4dCApOwoJCX0KCX0sCgoJX2dldFNlbGVjdGVkSXRlbTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWVudUl0ZW1zLmVxKCB0aGlzLmVsZW1lbnRbIDAgXS5zZWxlY3RlZEluZGV4ICkucGFyZW50KCAibGkiICk7Cgl9LAoKCV90b2dnbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzWyB0aGlzLmlzT3BlbiA/ICJjbG9zZSIgOiAib3BlbiIgXSggZXZlbnQgKTsKCX0sCgoJX3NldFNlbGVjdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGlvbjsKCgkJaWYgKCAhdGhpcy5yYW5nZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB3aW5kb3cuZ2V0U2VsZWN0aW9uICkgewoJCQlzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7CgkJCXNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTsKCQkJc2VsZWN0aW9uLmFkZFJhbmdlKCB0aGlzLnJhbmdlICk7CgoJCS8vIFN1cHBvcnQ6IElFOAoJCX0gZWxzZSB7CgkJCXRoaXMucmFuZ2Uuc2VsZWN0KCk7CgkJfQoKCQkvLyBTdXBwb3J0OiBJRQoJCS8vIFNldHRpbmcgdGhlIHRleHQgc2VsZWN0aW9uIGtpbGxzIHRoZSBidXR0b24gZm9jdXMgaW4gSUUsIGJ1dAoJCS8vIHJlc3RvcmluZyB0aGUgZm9jdXMgZG9lc24ndCBraWxsIHRoZSBzZWxlY3Rpb24uCgkJdGhpcy5idXR0b24uZm9jdXMoKTsKCX0sCgoJX2RvY3VtZW50Q2xpY2s6IHsKCQltb3VzZWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAhdGhpcy5pc09wZW4gKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggISQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktc2VsZWN0bWVudS1tZW51LCAjIiArCgkJCQkJJC51aS5lc2NhcGVTZWxlY3RvciggdGhpcy5pZHMuYnV0dG9uICkgKS5sZW5ndGggKSB7CgkJCQl0aGlzLmNsb3NlKCBldmVudCApOwoJCQl9CgkJfQoJfSwKCglfYnV0dG9uRXZlbnRzOiB7CgoJCS8vIFByZXZlbnQgdGV4dCBzZWxlY3Rpb24gZnJvbSBiZWluZyByZXNldCB3aGVuIGludGVyYWN0aW5nIHdpdGggdGhlIHNlbGVjdG1lbnUgKCMxMDE0NCkKCQltb3VzZWRvd246IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZWN0aW9uOwoKCQkJaWYgKCB3aW5kb3cuZ2V0U2VsZWN0aW9uICkgewoJCQkJc2VsZWN0aW9uID0gd2luZG93LmdldFNlbGVjdGlvbigpOwoJCQkJaWYgKCBzZWxlY3Rpb24ucmFuZ2VDb3VudCApIHsKCQkJCQl0aGlzLnJhbmdlID0gc2VsZWN0aW9uLmdldFJhbmdlQXQoIDAgKTsKCQkJCX0KCgkJCS8vIFN1cHBvcnQ6IElFOAoJCQl9IGVsc2UgewoJCQkJdGhpcy5yYW5nZSA9IGRvY3VtZW50LnNlbGVjdGlvbi5jcmVhdGVSYW5nZSgpOwoJCQl9CgkJfSwKCgkJY2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5fc2V0U2VsZWN0aW9uKCk7CgkJCXRoaXMuX3RvZ2dsZSggZXZlbnQgKTsKCQl9LAoKCQlrZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBwcmV2ZW50RGVmYXVsdCA9IHRydWU7CgkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlRBQjoKCQkJY2FzZSAkLnVpLmtleUNvZGUuRVNDQVBFOgoJCQkJdGhpcy5jbG9zZSggZXZlbnQgKTsKCQkJCXByZXZlbnREZWZhdWx0ID0gZmFsc2U7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuRU5URVI6CgkJCQlpZiAoIHRoaXMuaXNPcGVuICkgewoJCQkJCXRoaXMuX3NlbGVjdEZvY3VzZWRJdGVtKCBldmVudCApOwoJCQkJfQoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlVQOgoJCQkJaWYgKCBldmVudC5hbHRLZXkgKSB7CgkJCQkJdGhpcy5fdG9nZ2xlKCBldmVudCApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl9tb3ZlKCAicHJldiIsIGV2ZW50ICk7CgkJCQl9CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoKCQkJCWlmICggZXZlbnQuYWx0S2V5ICkgewoJCQkJCXRoaXMuX3RvZ2dsZSggZXZlbnQgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5fbW92ZSggIm5leHQiLCBldmVudCApOwoJCQkJfQoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlNQQUNFOgoJCQkJaWYgKCB0aGlzLmlzT3BlbiApIHsKCQkJCQl0aGlzLl9zZWxlY3RGb2N1c2VkSXRlbSggZXZlbnQgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5fdG9nZ2xlKCBldmVudCApOwoJCQkJfQoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLkxFRlQ6CgkJCQl0aGlzLl9tb3ZlKCAicHJldiIsIGV2ZW50ICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuUklHSFQ6CgkJCQl0aGlzLl9tb3ZlKCAibmV4dCIsIGV2ZW50ICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToKCQkJY2FzZSAkLnVpLmtleUNvZGUuUEFHRV9VUDoKCQkJCXRoaXMuX21vdmUoICJmaXJzdCIsIGV2ZW50ICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuRU5EOgoJCQljYXNlICQudWkua2V5Q29kZS5QQUdFX0RPV046CgkJCQl0aGlzLl9tb3ZlKCAibGFzdCIsIGV2ZW50ICk7CgkJCQlicmVhazsKCQkJZGVmYXVsdDoKCQkJCXRoaXMubWVudS50cmlnZ2VyKCBldmVudCApOwoJCQkJcHJldmVudERlZmF1bHQgPSBmYWxzZTsKCQkJfQoKCQkJaWYgKCBwcmV2ZW50RGVmYXVsdCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9Cgl9LAoKCV9zZWxlY3RGb2N1c2VkSXRlbTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpdGVtID0gdGhpcy5tZW51SXRlbXMuZXEoIHRoaXMuZm9jdXNJbmRleCApLnBhcmVudCggImxpIiApOwoJCWlmICggIWl0ZW0uaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5fc2VsZWN0KCBpdGVtLmRhdGEoICJ1aS1zZWxlY3RtZW51LWl0ZW0iICksIGV2ZW50ICk7CgkJfQoJfSwKCglfc2VsZWN0OiBmdW5jdGlvbiggaXRlbSwgZXZlbnQgKSB7CgkJdmFyIG9sZEluZGV4ID0gdGhpcy5lbGVtZW50WyAwIF0uc2VsZWN0ZWRJbmRleDsKCgkJLy8gQ2hhbmdlIG5hdGl2ZSBzZWxlY3QgZWxlbWVudAoJCXRoaXMuZWxlbWVudFsgMCBdLnNlbGVjdGVkSW5kZXggPSBpdGVtLmluZGV4OwoJCXRoaXMuYnV0dG9uSXRlbS5yZXBsYWNlV2l0aCggdGhpcy5idXR0b25JdGVtID0gdGhpcy5fcmVuZGVyQnV0dG9uSXRlbSggaXRlbSApICk7CgkJdGhpcy5fc2V0QXJpYSggaXRlbSApOwoJCXRoaXMuX3RyaWdnZXIoICJzZWxlY3QiLCBldmVudCwgeyBpdGVtOiBpdGVtIH0gKTsKCgkJaWYgKCBpdGVtLmluZGV4ICE9PSBvbGRJbmRleCApIHsKCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIsIGV2ZW50LCB7IGl0ZW06IGl0ZW0gfSApOwoJCX0KCgkJdGhpcy5jbG9zZSggZXZlbnQgKTsKCX0sCgoJX3NldEFyaWE6IGZ1bmN0aW9uKCBpdGVtICkgewoJCXZhciBpZCA9IHRoaXMubWVudUl0ZW1zLmVxKCBpdGVtLmluZGV4ICkuYXR0ciggImlkIiApOwoKCQl0aGlzLmJ1dHRvbi5hdHRyKCB7CgkJCSJhcmlhLWxhYmVsbGVkYnkiOiBpZCwKCQkJImFyaWEtYWN0aXZlZGVzY2VuZGFudCI6IGlkCgkJfSApOwoJCXRoaXMubWVudS5hdHRyKCAiYXJpYS1hY3RpdmVkZXNjZW5kYW50IiwgaWQgKTsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJpY29ucyIgKSB7CgkJCXZhciBpY29uID0gdGhpcy5idXR0b24uZmluZCggInNwYW4udWktaWNvbiIgKTsKCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGljb24sIG51bGwsIHRoaXMub3B0aW9ucy5pY29ucy5idXR0b24gKQoJCQkJLl9hZGRDbGFzcyggaWNvbiwgbnVsbCwgdmFsdWUuYnV0dG9uICk7CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gImFwcGVuZFRvIiApIHsKCQkJdGhpcy5tZW51V3JhcC5hcHBlbmRUbyggdGhpcy5fYXBwZW5kVG8oKSApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJ3aWR0aCIgKSB7CgkJCXRoaXMuX3Jlc2l6ZUJ1dHRvbigpOwoJCX0KCX0sCgoJX3NldE9wdGlvbkRpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5fc3VwZXIoIHZhbHVlICk7CgoJCXRoaXMubWVudUluc3RhbmNlLm9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5fdG9nZ2xlQ2xhc3MoIHRoaXMuYnV0dG9uLCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiLCB2YWx1ZSApOwoKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdmFsdWUgKTsKCQlpZiAoIHZhbHVlICkgewoJCQl0aGlzLmJ1dHRvbi5hdHRyKCAidGFiaW5kZXgiLCAtMSApOwoJCQl0aGlzLmNsb3NlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5idXR0b24uYXR0ciggInRhYmluZGV4IiwgMCApOwoJCX0KCX0sCgoJX2FwcGVuZFRvOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbWVudCA9IHRoaXMub3B0aW9ucy5hcHBlbmRUbzsKCgkJaWYgKCBlbGVtZW50ICkgewoJCQllbGVtZW50ID0gZWxlbWVudC5qcXVlcnkgfHwgZWxlbWVudC5ub2RlVHlwZSA/CgkJCQkkKCBlbGVtZW50ICkgOgoJCQkJdGhpcy5kb2N1bWVudC5maW5kKCBlbGVtZW50ICkuZXEoIDAgKTsKCQl9CgoJCWlmICggIWVsZW1lbnQgfHwgIWVsZW1lbnRbIDAgXSApIHsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLWZyb250LCBkaWFsb2ciICk7CgkJfQoKCQlpZiAoICFlbGVtZW50Lmxlbmd0aCApIHsKCQkJZWxlbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5ib2R5OwoJCX0KCgkJcmV0dXJuIGVsZW1lbnQ7Cgl9LAoKCV90b2dnbGVBdHRyOiBmdW5jdGlvbigpIHsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1leHBhbmRlZCIsIHRoaXMuaXNPcGVuICk7CgoJCS8vIFdlIGNhbid0IHVzZSB0d28gX3RvZ2dsZUNsYXNzKCkgY2FsbHMgaGVyZSwgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZQoJCS8vIHdlIGFsd2F5cyByZW1vdmUgY2xhc3NlcyBmaXJzdCBhbmQgYWRkIHRoZW0gc2Vjb25kLCBvdGhlcndpc2UgaWYgYm90aCBjbGFzc2VzIGhhdmUgdGhlCgkJLy8gc2FtZSB0aGVtZSBjbGFzcywgaXQgd2lsbCBiZSByZW1vdmVkIGFmdGVyIHdlIGFkZCBpdC4KCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5idXR0b24sICJ1aS1zZWxlY3RtZW51LWJ1dHRvbi0iICsKCQkJKCB0aGlzLmlzT3BlbiA/ICJjbG9zZWQiIDogIm9wZW4iICkgKQoJCQkuX2FkZENsYXNzKCB0aGlzLmJ1dHRvbiwgInVpLXNlbGVjdG1lbnUtYnV0dG9uLSIgKwoJCQkJKCB0aGlzLmlzT3BlbiA/ICJvcGVuIiA6ICJjbG9zZWQiICkgKQoJCQkuX3RvZ2dsZUNsYXNzKCB0aGlzLm1lbnVXcmFwLCAidWktc2VsZWN0bWVudS1vcGVuIiwgbnVsbCwgdGhpcy5pc09wZW4gKTsKCgkJdGhpcy5tZW51LmF0dHIoICJhcmlhLWhpZGRlbiIsICF0aGlzLmlzT3BlbiApOwoJfSwKCglfcmVzaXplQnV0dG9uOiBmdW5jdGlvbigpIHsKCQl2YXIgd2lkdGggPSB0aGlzLm9wdGlvbnMud2lkdGg7CgoJCS8vIEZvciBgd2lkdGg6IGZhbHNlYCwganVzdCByZW1vdmUgaW5saW5lIHN0eWxlIGFuZCBzdG9wCgkJaWYgKCB3aWR0aCA9PT0gZmFsc2UgKSB7CgkJCXRoaXMuYnV0dG9uLmNzcyggIndpZHRoIiwgIiIgKTsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gRm9yIGB3aWR0aDogbnVsbGAsIG1hdGNoIHRoZSB3aWR0aCBvZiB0aGUgb3JpZ2luYWwgZWxlbWVudAoJCWlmICggd2lkdGggPT09IG51bGwgKSB7CgkJCXdpZHRoID0gdGhpcy5lbGVtZW50LnNob3coKS5vdXRlcldpZHRoKCk7CgkJCXRoaXMuZWxlbWVudC5oaWRlKCk7CgkJfQoKCQl0aGlzLmJ1dHRvbi5vdXRlcldpZHRoKCB3aWR0aCApOwoJfSwKCglfcmVzaXplTWVudTogZnVuY3Rpb24oKSB7CgkJdGhpcy5tZW51Lm91dGVyV2lkdGgoIE1hdGgubWF4KAoJCQl0aGlzLmJ1dHRvbi5vdXRlcldpZHRoKCksCgoJCQkvLyBTdXBwb3J0OiBJRTEwCgkJCS8vIElFMTAgd3JhcHMgbG9uZyB0ZXh0IChwb3NzaWJseSBhIHJvdW5kaW5nIGJ1ZykKCQkJLy8gc28gd2UgYWRkIDFweCB0byBhdm9pZCB0aGUgd3JhcHBpbmcKCQkJdGhpcy5tZW51LndpZHRoKCAiIiApLm91dGVyV2lkdGgoKSArIDEKCQkpICk7Cgl9LAoKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMuX3N1cGVyKCk7CgoJCW9wdGlvbnMuZGlzYWJsZWQgPSB0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiApOwoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJX3BhcnNlT3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlkYXRhID0gW107CgkJb3B0aW9ucy5lYWNoKCBmdW5jdGlvbiggaW5kZXgsIGl0ZW0gKSB7CgkJCWRhdGEucHVzaCggdGhhdC5fcGFyc2VPcHRpb24oICQoIGl0ZW0gKSwgaW5kZXggKSApOwoJCX0gKTsKCQl0aGlzLml0ZW1zID0gZGF0YTsKCX0sCgoJX3BhcnNlT3B0aW9uOiBmdW5jdGlvbiggb3B0aW9uLCBpbmRleCApIHsKCQl2YXIgb3B0Z3JvdXAgPSBvcHRpb24ucGFyZW50KCAib3B0Z3JvdXAiICk7CgoJCXJldHVybiB7CgkJCWVsZW1lbnQ6IG9wdGlvbiwKCQkJaW5kZXg6IGluZGV4LAoJCQl2YWx1ZTogb3B0aW9uLnZhbCgpLAoJCQlsYWJlbDogb3B0aW9uLnRleHQoKSwKCQkJb3B0Z3JvdXA6IG9wdGdyb3VwLmF0dHIoICJsYWJlbCIgKSB8fCAiIiwKCQkJZGlzYWJsZWQ6IG9wdGdyb3VwLnByb3AoICJkaXNhYmxlZCIgKSB8fCBvcHRpb24ucHJvcCggImRpc2FibGVkIiApCgkJfTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VuYmluZEZvcm1SZXNldEhhbmRsZXIoKTsKCQl0aGlzLm1lbnVXcmFwLnJlbW92ZSgpOwoJCXRoaXMuYnV0dG9uLnJlbW92ZSgpOwoJCXRoaXMuZWxlbWVudC5zaG93KCk7CgkJdGhpcy5lbGVtZW50LnJlbW92ZVVuaXF1ZUlkKCk7CgkJdGhpcy5sYWJlbHMuYXR0ciggImZvciIsIHRoaXMuaWRzLmVsZW1lbnQgKTsKCX0KfSBdICk7CgoKLyohCiAqIGpRdWVyeSBVSSBTbGlkZXIgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBTbGlkZXIKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vPj5kZXNjcmlwdGlvbjogRGlzcGxheXMgYSBmbGV4aWJsZSBzbGlkZXIgd2l0aCByYW5nZXMgYW5kIGFjY2Vzc2liaWxpdHkgdmlhIGtleWJvYXJkLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2xpZGVyLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vc2xpZGVyLwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MKLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3NsaWRlci5jc3MKLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzCgoKCnZhciB3aWRnZXRzU2xpZGVyID0gJC53aWRnZXQoICJ1aS5zbGlkZXIiLCAkLnVpLm1vdXNlLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCXdpZGdldEV2ZW50UHJlZml4OiAic2xpZGUiLAoKCW9wdGlvbnM6IHsKCQlhbmltYXRlOiBmYWxzZSwKCQljbGFzc2VzOiB7CgkJCSJ1aS1zbGlkZXIiOiAidWktY29ybmVyLWFsbCIsCgkJCSJ1aS1zbGlkZXItaGFuZGxlIjogInVpLWNvcm5lci1hbGwiLAoKCQkJLy8gTm90ZTogdWktd2lkZ2V0LWhlYWRlciBpc24ndCB0aGUgbW9zdCBmaXR0aW5nbHkgc2VtYW50aWMgZnJhbWV3b3JrIGNsYXNzIGZvciB0aGlzCgkJCS8vIGVsZW1lbnQsIGJ1dCB3b3JrZWQgYmVzdCB2aXN1YWxseSB3aXRoIGEgdmFyaWV0eSBvZiB0aGVtZXMKCQkJInVpLXNsaWRlci1yYW5nZSI6ICJ1aS1jb3JuZXItYWxsIHVpLXdpZGdldC1oZWFkZXIiCgkJfSwKCQlkaXN0YW5jZTogMCwKCQltYXg6IDEwMCwKCQltaW46IDAsCgkJb3JpZW50YXRpb246ICJob3Jpem9udGFsIiwKCQlyYW5nZTogZmFsc2UsCgkJc3RlcDogMSwKCQl2YWx1ZTogMCwKCQl2YWx1ZXM6IG51bGwsCgoJCS8vIENhbGxiYWNrcwoJCWNoYW5nZTogbnVsbCwKCQlzbGlkZTogbnVsbCwKCQlzdGFydDogbnVsbCwKCQlzdG9wOiBudWxsCgl9LAoKCS8vIE51bWJlciBvZiBwYWdlcyBpbiBhIHNsaWRlcgoJLy8gKGhvdyBtYW55IHRpbWVzIGNhbiB5b3UgcGFnZSB1cC9kb3duIHRvIGdvIHRocm91Z2ggdGhlIHdob2xlIHJhbmdlKQoJbnVtUGFnZXM6IDUsCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fa2V5U2xpZGluZyA9IGZhbHNlOwoJCXRoaXMuX21vdXNlU2xpZGluZyA9IGZhbHNlOwoJCXRoaXMuX2FuaW1hdGVPZmYgPSB0cnVlOwoJCXRoaXMuX2hhbmRsZUluZGV4ID0gbnVsbDsKCQl0aGlzLl9kZXRlY3RPcmllbnRhdGlvbigpOwoJCXRoaXMuX21vdXNlSW5pdCgpOwoJCXRoaXMuX2NhbGN1bGF0ZU5ld01heCgpOwoKCQl0aGlzLl9hZGRDbGFzcyggInVpLXNsaWRlciB1aS1zbGlkZXItIiArIHRoaXMub3JpZW50YXRpb24sCgkJCSJ1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQiICk7CgoJCXRoaXMuX3JlZnJlc2goKTsKCgkJdGhpcy5fYW5pbWF0ZU9mZiA9IGZhbHNlOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fY3JlYXRlUmFuZ2UoKTsKCQl0aGlzLl9jcmVhdGVIYW5kbGVzKCk7CgkJdGhpcy5fc2V0dXBFdmVudHMoKTsKCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsKCX0sCgoJX2NyZWF0ZUhhbmRsZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBpLCBoYW5kbGVDb3VudCwKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJZXhpc3RpbmdIYW5kbGVzID0gdGhpcy5lbGVtZW50LmZpbmQoICIudWktc2xpZGVyLWhhbmRsZSIgKSwKCQkJaGFuZGxlID0gIjxzcGFuIHRhYmluZGV4PScwJz48L3NwYW4+IiwKCQkJaGFuZGxlcyA9IFtdOwoKCQloYW5kbGVDb3VudCA9ICggb3B0aW9ucy52YWx1ZXMgJiYgb3B0aW9ucy52YWx1ZXMubGVuZ3RoICkgfHwgMTsKCgkJaWYgKCBleGlzdGluZ0hhbmRsZXMubGVuZ3RoID4gaGFuZGxlQ291bnQgKSB7CgkJCWV4aXN0aW5nSGFuZGxlcy5zbGljZSggaGFuZGxlQ291bnQgKS5yZW1vdmUoKTsKCQkJZXhpc3RpbmdIYW5kbGVzID0gZXhpc3RpbmdIYW5kbGVzLnNsaWNlKCAwLCBoYW5kbGVDb3VudCApOwoJCX0KCgkJZm9yICggaSA9IGV4aXN0aW5nSGFuZGxlcy5sZW5ndGg7IGkgPCBoYW5kbGVDb3VudDsgaSsrICkgewoJCQloYW5kbGVzLnB1c2goIGhhbmRsZSApOwoJCX0KCgkJdGhpcy5oYW5kbGVzID0gZXhpc3RpbmdIYW5kbGVzLmFkZCggJCggaGFuZGxlcy5qb2luKCAiIiApICkuYXBwZW5kVG8oIHRoaXMuZWxlbWVudCApICk7CgoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmhhbmRsZXMsICJ1aS1zbGlkZXItaGFuZGxlIiwgInVpLXN0YXRlLWRlZmF1bHQiICk7CgoJCXRoaXMuaGFuZGxlID0gdGhpcy5oYW5kbGVzLmVxKCAwICk7CgoJCXRoaXMuaGFuZGxlcy5lYWNoKCBmdW5jdGlvbiggaSApIHsKCQkJJCggdGhpcyApCgkJCQkuZGF0YSggInVpLXNsaWRlci1oYW5kbGUtaW5kZXgiLCBpICkKCQkJCS5hdHRyKCAidGFiSW5kZXgiLCAwICk7CgkJfSApOwoJfSwKCglfY3JlYXRlUmFuZ2U6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdGlvbnMucmFuZ2UgKSB7CgkJCWlmICggb3B0aW9ucy5yYW5nZSA9PT0gdHJ1ZSApIHsKCQkJCWlmICggIW9wdGlvbnMudmFsdWVzICkgewoJCQkJCW9wdGlvbnMudmFsdWVzID0gWyB0aGlzLl92YWx1ZU1pbigpLCB0aGlzLl92YWx1ZU1pbigpIF07CgkJCQl9IGVsc2UgaWYgKCBvcHRpb25zLnZhbHVlcy5sZW5ndGggJiYgb3B0aW9ucy52YWx1ZXMubGVuZ3RoICE9PSAyICkgewoJCQkJCW9wdGlvbnMudmFsdWVzID0gWyBvcHRpb25zLnZhbHVlc1sgMCBdLCBvcHRpb25zLnZhbHVlc1sgMCBdIF07CgkJCQl9IGVsc2UgaWYgKCAkLmlzQXJyYXkoIG9wdGlvbnMudmFsdWVzICkgKSB7CgkJCQkJb3B0aW9ucy52YWx1ZXMgPSBvcHRpb25zLnZhbHVlcy5zbGljZSggMCApOwoJCQkJfQoJCQl9CgoJCQlpZiAoICF0aGlzLnJhbmdlIHx8ICF0aGlzLnJhbmdlLmxlbmd0aCApIHsKCQkJCXRoaXMucmFuZ2UgPSAkKCAiPGRpdj4iICkKCQkJCQkuYXBwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoKCQkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnJhbmdlLCAidWktc2xpZGVyLXJhbmdlIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMucmFuZ2UsICJ1aS1zbGlkZXItcmFuZ2UtbWluIHVpLXNsaWRlci1yYW5nZS1tYXgiICk7CgoJCQkJLy8gSGFuZGxlIHJhbmdlIHN3aXRjaGluZyBmcm9tIHRydWUgdG8gbWluL21heAoJCQkJdGhpcy5yYW5nZS5jc3MoIHsKCQkJCQkibGVmdCI6ICIiLAoJCQkJCSJib3R0b20iOiAiIgoJCQkJfSApOwoJCQl9CgkJCWlmICggb3B0aW9ucy5yYW5nZSA9PT0gIm1pbiIgfHwgb3B0aW9ucy5yYW5nZSA9PT0gIm1heCIgKSB7CgkJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5yYW5nZSwgInVpLXNsaWRlci1yYW5nZS0iICsgb3B0aW9ucy5yYW5nZSApOwoJCQl9CgkJfSBlbHNlIHsKCQkJaWYgKCB0aGlzLnJhbmdlICkgewoJCQkJdGhpcy5yYW5nZS5yZW1vdmUoKTsKCQkJfQoJCQl0aGlzLnJhbmdlID0gbnVsbDsKCQl9Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb2ZmKCB0aGlzLmhhbmRsZXMgKTsKCQl0aGlzLl9vbiggdGhpcy5oYW5kbGVzLCB0aGlzLl9oYW5kbGVFdmVudHMgKTsKCQl0aGlzLl9ob3ZlcmFibGUoIHRoaXMuaGFuZGxlcyApOwoJCXRoaXMuX2ZvY3VzYWJsZSggdGhpcy5oYW5kbGVzICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLmhhbmRsZXMucmVtb3ZlKCk7CgkJaWYgKCB0aGlzLnJhbmdlICkgewoJCQl0aGlzLnJhbmdlLnJlbW92ZSgpOwoJCX0KCgkJdGhpcy5fbW91c2VEZXN0cm95KCk7Cgl9LAoKCV9tb3VzZUNhcHR1cmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgcG9zaXRpb24sIG5vcm1WYWx1ZSwgZGlzdGFuY2UsIGNsb3Nlc3RIYW5kbGUsIGluZGV4LCBhbGxvd2VkLCBvZmZzZXQsIG1vdXNlT3ZlckhhbmRsZSwKCQkJdGhhdCA9IHRoaXMsCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggby5kaXNhYmxlZCApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdGhpcy5lbGVtZW50U2l6ZSA9IHsKCQkJd2lkdGg6IHRoaXMuZWxlbWVudC5vdXRlcldpZHRoKCksCgkJCWhlaWdodDogdGhpcy5lbGVtZW50Lm91dGVySGVpZ2h0KCkKCQl9OwoJCXRoaXMuZWxlbWVudE9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCgkJcG9zaXRpb24gPSB7IHg6IGV2ZW50LnBhZ2VYLCB5OiBldmVudC5wYWdlWSB9OwoJCW5vcm1WYWx1ZSA9IHRoaXMuX25vcm1WYWx1ZUZyb21Nb3VzZSggcG9zaXRpb24gKTsKCQlkaXN0YW5jZSA9IHRoaXMuX3ZhbHVlTWF4KCkgLSB0aGlzLl92YWx1ZU1pbigpICsgMTsKCQl0aGlzLmhhbmRsZXMuZWFjaCggZnVuY3Rpb24oIGkgKSB7CgkJCXZhciB0aGlzRGlzdGFuY2UgPSBNYXRoLmFicyggbm9ybVZhbHVlIC0gdGhhdC52YWx1ZXMoIGkgKSApOwoJCQlpZiAoICggZGlzdGFuY2UgPiB0aGlzRGlzdGFuY2UgKSB8fAoJCQkJKCBkaXN0YW5jZSA9PT0gdGhpc0Rpc3RhbmNlICYmCgkJCQkJKCBpID09PSB0aGF0Ll9sYXN0Q2hhbmdlZFZhbHVlIHx8IHRoYXQudmFsdWVzKCBpICkgPT09IG8ubWluICkgKSApIHsKCQkJCWRpc3RhbmNlID0gdGhpc0Rpc3RhbmNlOwoJCQkJY2xvc2VzdEhhbmRsZSA9ICQoIHRoaXMgKTsKCQkJCWluZGV4ID0gaTsKCQkJfQoJCX0gKTsKCgkJYWxsb3dlZCA9IHRoaXMuX3N0YXJ0KCBldmVudCwgaW5kZXggKTsKCQlpZiAoIGFsbG93ZWQgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXRoaXMuX21vdXNlU2xpZGluZyA9IHRydWU7CgoJCXRoaXMuX2hhbmRsZUluZGV4ID0gaW5kZXg7CgoJCXRoaXMuX2FkZENsYXNzKCBjbG9zZXN0SGFuZGxlLCBudWxsLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCWNsb3Nlc3RIYW5kbGUudHJpZ2dlciggImZvY3VzIiApOwoKCQlvZmZzZXQgPSBjbG9zZXN0SGFuZGxlLm9mZnNldCgpOwoJCW1vdXNlT3ZlckhhbmRsZSA9ICEkKCBldmVudC50YXJnZXQgKS5wYXJlbnRzKCkuYWRkQmFjaygpLmlzKCAiLnVpLXNsaWRlci1oYW5kbGUiICk7CgkJdGhpcy5fY2xpY2tPZmZzZXQgPSBtb3VzZU92ZXJIYW5kbGUgPyB7IGxlZnQ6IDAsIHRvcDogMCB9IDogewoJCQlsZWZ0OiBldmVudC5wYWdlWCAtIG9mZnNldC5sZWZ0IC0gKCBjbG9zZXN0SGFuZGxlLndpZHRoKCkgLyAyICksCgkJCXRvcDogZXZlbnQucGFnZVkgLSBvZmZzZXQudG9wIC0KCQkJCSggY2xvc2VzdEhhbmRsZS5oZWlnaHQoKSAvIDIgKSAtCgkJCQkoIHBhcnNlSW50KCBjbG9zZXN0SGFuZGxlLmNzcyggImJvcmRlclRvcFdpZHRoIiApLCAxMCApIHx8IDAgKSAtCgkJCQkoIHBhcnNlSW50KCBjbG9zZXN0SGFuZGxlLmNzcyggImJvcmRlckJvdHRvbVdpZHRoIiApLCAxMCApIHx8IDAgKSArCgkJCQkoIHBhcnNlSW50KCBjbG9zZXN0SGFuZGxlLmNzcyggIm1hcmdpblRvcCIgKSwgMTAgKSB8fCAwICkKCQl9OwoKCQlpZiAoICF0aGlzLmhhbmRsZXMuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKSApIHsKCQkJdGhpcy5fc2xpZGUoIGV2ZW50LCBpbmRleCwgbm9ybVZhbHVlICk7CgkJfQoJCXRoaXMuX2FuaW1hdGVPZmYgPSB0cnVlOwoJCXJldHVybiB0cnVlOwoJfSwKCglfbW91c2VTdGFydDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9tb3VzZURyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgcG9zaXRpb24gPSB7IHg6IGV2ZW50LnBhZ2VYLCB5OiBldmVudC5wYWdlWSB9LAoJCQlub3JtVmFsdWUgPSB0aGlzLl9ub3JtVmFsdWVGcm9tTW91c2UoIHBvc2l0aW9uICk7CgoJCXRoaXMuX3NsaWRlKCBldmVudCwgdGhpcy5faGFuZGxlSW5kZXgsIG5vcm1WYWx1ZSApOwoKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9tb3VzZVN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5oYW5kbGVzLCBudWxsLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCXRoaXMuX21vdXNlU2xpZGluZyA9IGZhbHNlOwoKCQl0aGlzLl9zdG9wKCBldmVudCwgdGhpcy5faGFuZGxlSW5kZXggKTsKCQl0aGlzLl9jaGFuZ2UoIGV2ZW50LCB0aGlzLl9oYW5kbGVJbmRleCApOwoKCQl0aGlzLl9oYW5kbGVJbmRleCA9IG51bGw7CgkJdGhpcy5fY2xpY2tPZmZzZXQgPSBudWxsOwoJCXRoaXMuX2FuaW1hdGVPZmYgPSBmYWxzZTsKCgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfZGV0ZWN0T3JpZW50YXRpb246IGZ1bmN0aW9uKCkgewoJCXRoaXMub3JpZW50YXRpb24gPSAoIHRoaXMub3B0aW9ucy5vcmllbnRhdGlvbiA9PT0gInZlcnRpY2FsIiApID8gInZlcnRpY2FsIiA6ICJob3Jpem9udGFsIjsKCX0sCgoJX25vcm1WYWx1ZUZyb21Nb3VzZTogZnVuY3Rpb24oIHBvc2l0aW9uICkgewoJCXZhciBwaXhlbFRvdGFsLAoJCQlwaXhlbE1vdXNlLAoJCQlwZXJjZW50TW91c2UsCgkJCXZhbHVlVG90YWwsCgkJCXZhbHVlTW91c2U7CgoJCWlmICggdGhpcy5vcmllbnRhdGlvbiA9PT0gImhvcml6b250YWwiICkgewoJCQlwaXhlbFRvdGFsID0gdGhpcy5lbGVtZW50U2l6ZS53aWR0aDsKCQkJcGl4ZWxNb3VzZSA9IHBvc2l0aW9uLnggLSB0aGlzLmVsZW1lbnRPZmZzZXQubGVmdCAtCgkJCQkoIHRoaXMuX2NsaWNrT2Zmc2V0ID8gdGhpcy5fY2xpY2tPZmZzZXQubGVmdCA6IDAgKTsKCQl9IGVsc2UgewoJCQlwaXhlbFRvdGFsID0gdGhpcy5lbGVtZW50U2l6ZS5oZWlnaHQ7CgkJCXBpeGVsTW91c2UgPSBwb3NpdGlvbi55IC0gdGhpcy5lbGVtZW50T2Zmc2V0LnRvcCAtCgkJCQkoIHRoaXMuX2NsaWNrT2Zmc2V0ID8gdGhpcy5fY2xpY2tPZmZzZXQudG9wIDogMCApOwoJCX0KCgkJcGVyY2VudE1vdXNlID0gKCBwaXhlbE1vdXNlIC8gcGl4ZWxUb3RhbCApOwoJCWlmICggcGVyY2VudE1vdXNlID4gMSApIHsKCQkJcGVyY2VudE1vdXNlID0gMTsKCQl9CgkJaWYgKCBwZXJjZW50TW91c2UgPCAwICkgewoJCQlwZXJjZW50TW91c2UgPSAwOwoJCX0KCQlpZiAoIHRoaXMub3JpZW50YXRpb24gPT09ICJ2ZXJ0aWNhbCIgKSB7CgkJCXBlcmNlbnRNb3VzZSA9IDEgLSBwZXJjZW50TW91c2U7CgkJfQoKCQl2YWx1ZVRvdGFsID0gdGhpcy5fdmFsdWVNYXgoKSAtIHRoaXMuX3ZhbHVlTWluKCk7CgkJdmFsdWVNb3VzZSA9IHRoaXMuX3ZhbHVlTWluKCkgKyBwZXJjZW50TW91c2UgKiB2YWx1ZVRvdGFsOwoKCQlyZXR1cm4gdGhpcy5fdHJpbUFsaWduVmFsdWUoIHZhbHVlTW91c2UgKTsKCX0sCgoJX3VpSGFzaDogZnVuY3Rpb24oIGluZGV4LCB2YWx1ZSwgdmFsdWVzICkgewoJCXZhciB1aUhhc2ggPSB7CgkJCWhhbmRsZTogdGhpcy5oYW5kbGVzWyBpbmRleCBdLAoJCQloYW5kbGVJbmRleDogaW5kZXgsCgkJCXZhbHVlOiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8gdmFsdWUgOiB0aGlzLnZhbHVlKCkKCQl9OwoKCQlpZiAoIHRoaXMuX2hhc011bHRpcGxlVmFsdWVzKCkgKSB7CgkJCXVpSGFzaC52YWx1ZSA9IHZhbHVlICE9PSB1bmRlZmluZWQgPyB2YWx1ZSA6IHRoaXMudmFsdWVzKCBpbmRleCApOwoJCQl1aUhhc2gudmFsdWVzID0gdmFsdWVzIHx8IHRoaXMudmFsdWVzKCk7CgkJfQoKCQlyZXR1cm4gdWlIYXNoOwoJfSwKCglfaGFzTXVsdGlwbGVWYWx1ZXM6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMudmFsdWVzICYmIHRoaXMub3B0aW9ucy52YWx1ZXMubGVuZ3RoOwoJfSwKCglfc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgaW5kZXggKSB7CgkJcmV0dXJuIHRoaXMuX3RyaWdnZXIoICJzdGFydCIsIGV2ZW50LCB0aGlzLl91aUhhc2goIGluZGV4ICkgKTsKCX0sCgoJX3NsaWRlOiBmdW5jdGlvbiggZXZlbnQsIGluZGV4LCBuZXdWYWwgKSB7CgkJdmFyIGFsbG93ZWQsIG90aGVyVmFsLAoJCQljdXJyZW50VmFsdWUgPSB0aGlzLnZhbHVlKCksCgkJCW5ld1ZhbHVlcyA9IHRoaXMudmFsdWVzKCk7CgoJCWlmICggdGhpcy5faGFzTXVsdGlwbGVWYWx1ZXMoKSApIHsKCQkJb3RoZXJWYWwgPSB0aGlzLnZhbHVlcyggaW5kZXggPyAwIDogMSApOwoJCQljdXJyZW50VmFsdWUgPSB0aGlzLnZhbHVlcyggaW5kZXggKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLnZhbHVlcy5sZW5ndGggPT09IDIgJiYgdGhpcy5vcHRpb25zLnJhbmdlID09PSB0cnVlICkgewoJCQkJbmV3VmFsID0gIGluZGV4ID09PSAwID8gTWF0aC5taW4oIG90aGVyVmFsLCBuZXdWYWwgKSA6IE1hdGgubWF4KCBvdGhlclZhbCwgbmV3VmFsICk7CgkJCX0KCgkJCW5ld1ZhbHVlc1sgaW5kZXggXSA9IG5ld1ZhbDsKCQl9CgoJCWlmICggbmV3VmFsID09PSBjdXJyZW50VmFsdWUgKSB7CgkJCXJldHVybjsKCQl9CgoJCWFsbG93ZWQgPSB0aGlzLl90cmlnZ2VyKCAic2xpZGUiLCBldmVudCwgdGhpcy5fdWlIYXNoKCBpbmRleCwgbmV3VmFsLCBuZXdWYWx1ZXMgKSApOwoKCQkvLyBBIHNsaWRlIGNhbiBiZSBjYW5jZWxlZCBieSByZXR1cm5pbmcgZmFsc2UgZnJvbSB0aGUgc2xpZGUgY2FsbGJhY2sKCQlpZiAoIGFsbG93ZWQgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRoaXMuX2hhc011bHRpcGxlVmFsdWVzKCkgKSB7CgkJCXRoaXMudmFsdWVzKCBpbmRleCwgbmV3VmFsICk7CgkJfSBlbHNlIHsKCQkJdGhpcy52YWx1ZSggbmV3VmFsICk7CgkJfQoJfSwKCglfc3RvcDogZnVuY3Rpb24oIGV2ZW50LCBpbmRleCApIHsKCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIsIGV2ZW50LCB0aGlzLl91aUhhc2goIGluZGV4ICkgKTsKCX0sCgoJX2NoYW5nZTogZnVuY3Rpb24oIGV2ZW50LCBpbmRleCApIHsKCQlpZiAoICF0aGlzLl9rZXlTbGlkaW5nICYmICF0aGlzLl9tb3VzZVNsaWRpbmcgKSB7CgoJCQkvL3N0b3JlIHRoZSBsYXN0IGNoYW5nZWQgdmFsdWUgaW5kZXggZm9yIHJlZmVyZW5jZSB3aGVuIGhhbmRsZXMgb3ZlcmxhcAoJCQl0aGlzLl9sYXN0Q2hhbmdlZFZhbHVlID0gaW5kZXg7CgkJCXRoaXMuX3RyaWdnZXIoICJjaGFuZ2UiLCBldmVudCwgdGhpcy5fdWlIYXNoKCBpbmRleCApICk7CgkJfQoJfSwKCgl2YWx1ZTogZnVuY3Rpb24oIG5ld1ZhbHVlICkgewoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5vcHRpb25zLnZhbHVlID0gdGhpcy5fdHJpbUFsaWduVmFsdWUoIG5ld1ZhbHVlICk7CgkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJCQl0aGlzLl9jaGFuZ2UoIG51bGwsIDAgKTsKCQkJcmV0dXJuOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3ZhbHVlKCk7Cgl9LAoKCXZhbHVlczogZnVuY3Rpb24oIGluZGV4LCBuZXdWYWx1ZSApIHsKCQl2YXIgdmFscywKCQkJbmV3VmFsdWVzLAoJCQlpOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPiAxICkgewoJCQl0aGlzLm9wdGlvbnMudmFsdWVzWyBpbmRleCBdID0gdGhpcy5fdHJpbUFsaWduVmFsdWUoIG5ld1ZhbHVlICk7CgkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJCQl0aGlzLl9jaGFuZ2UoIG51bGwsIGluZGV4ICk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJaWYgKCAkLmlzQXJyYXkoIGFyZ3VtZW50c1sgMCBdICkgKSB7CgkJCQl2YWxzID0gdGhpcy5vcHRpb25zLnZhbHVlczsKCQkJCW5ld1ZhbHVlcyA9IGFyZ3VtZW50c1sgMCBdOwoJCQkJZm9yICggaSA9IDA7IGkgPCB2YWxzLmxlbmd0aDsgaSArPSAxICkgewoJCQkJCXZhbHNbIGkgXSA9IHRoaXMuX3RyaW1BbGlnblZhbHVlKCBuZXdWYWx1ZXNbIGkgXSApOwoJCQkJCXRoaXMuX2NoYW5nZSggbnVsbCwgaSApOwoJCQkJfQoJCQkJdGhpcy5fcmVmcmVzaFZhbHVlKCk7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHRoaXMuX2hhc011bHRpcGxlVmFsdWVzKCkgKSB7CgkJCQkJcmV0dXJuIHRoaXMuX3ZhbHVlcyggaW5kZXggKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIHRoaXMudmFsdWUoKTsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLl92YWx1ZXMoKTsKCQl9Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBpLAoJCQl2YWxzTGVuZ3RoID0gMDsKCgkJaWYgKCBrZXkgPT09ICJyYW5nZSIgJiYgdGhpcy5vcHRpb25zLnJhbmdlID09PSB0cnVlICkgewoJCQlpZiAoIHZhbHVlID09PSAibWluIiApIHsKCQkJCXRoaXMub3B0aW9ucy52YWx1ZSA9IHRoaXMuX3ZhbHVlcyggMCApOwoJCQkJdGhpcy5vcHRpb25zLnZhbHVlcyA9IG51bGw7CgkJCX0gZWxzZSBpZiAoIHZhbHVlID09PSAibWF4IiApIHsKCQkJCXRoaXMub3B0aW9ucy52YWx1ZSA9IHRoaXMuX3ZhbHVlcyggdGhpcy5vcHRpb25zLnZhbHVlcy5sZW5ndGggLSAxICk7CgkJCQl0aGlzLm9wdGlvbnMudmFsdWVzID0gbnVsbDsKCQkJfQoJCX0KCgkJaWYgKCAkLmlzQXJyYXkoIHRoaXMub3B0aW9ucy52YWx1ZXMgKSApIHsKCQkJdmFsc0xlbmd0aCA9IHRoaXMub3B0aW9ucy52YWx1ZXMubGVuZ3RoOwoJCX0KCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCgkJc3dpdGNoICgga2V5ICkgewoJCQljYXNlICJvcmllbnRhdGlvbiI6CgkJCQl0aGlzLl9kZXRlY3RPcmllbnRhdGlvbigpOwoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoICJ1aS1zbGlkZXItaG9yaXpvbnRhbCB1aS1zbGlkZXItdmVydGljYWwiICkKCQkJCQkuX2FkZENsYXNzKCAidWktc2xpZGVyLSIgKyB0aGlzLm9yaWVudGF0aW9uICk7CgkJCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsKCQkJCWlmICggdGhpcy5vcHRpb25zLnJhbmdlICkgewoJCQkJCXRoaXMuX3JlZnJlc2hSYW5nZSggdmFsdWUgKTsKCQkJCX0KCgkJCQkvLyBSZXNldCBwb3NpdGlvbmluZyBmcm9tIHByZXZpb3VzIG9yaWVudGF0aW9uCgkJCQl0aGlzLmhhbmRsZXMuY3NzKCB2YWx1ZSA9PT0gImhvcml6b250YWwiID8gImJvdHRvbSIgOiAibGVmdCIsICIiICk7CgkJCQlicmVhazsKCQkJY2FzZSAidmFsdWUiOgoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IHRydWU7CgkJCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsKCQkJCXRoaXMuX2NoYW5nZSggbnVsbCwgMCApOwoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IGZhbHNlOwoJCQkJYnJlYWs7CgkJCWNhc2UgInZhbHVlcyI6CgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gdHJ1ZTsKCQkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoKCQkJCS8vIFN0YXJ0IGZyb20gdGhlIGxhc3QgaGFuZGxlIHRvIHByZXZlbnQgdW5yZWFjaGFibGUgaGFuZGxlcyAoIzkwNDYpCgkJCQlmb3IgKCBpID0gdmFsc0xlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQkJCXRoaXMuX2NoYW5nZSggbnVsbCwgaSApOwoJCQkJfQoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IGZhbHNlOwoJCQkJYnJlYWs7CgkJCWNhc2UgInN0ZXAiOgoJCQljYXNlICJtaW4iOgoJCQljYXNlICJtYXgiOgoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IHRydWU7CgkJCQl0aGlzLl9jYWxjdWxhdGVOZXdNYXgoKTsKCQkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IGZhbHNlOwoJCQkJYnJlYWs7CgkJCWNhc2UgInJhbmdlIjoKCQkJCXRoaXMuX2FuaW1hdGVPZmYgPSB0cnVlOwoJCQkJdGhpcy5fcmVmcmVzaCgpOwoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IGZhbHNlOwoJCQkJYnJlYWs7CgkJfQoJfSwKCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlciggdmFsdWUgKTsKCgkJdGhpcy5fdG9nZ2xlQ2xhc3MoIG51bGwsICJ1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKTsKCX0sCgoJLy9pbnRlcm5hbCB2YWx1ZSBnZXR0ZXIKCS8vIF92YWx1ZSgpIHJldHVybnMgdmFsdWUgdHJpbW1lZCBieSBtaW4gYW5kIG1heCwgYWxpZ25lZCBieSBzdGVwCglfdmFsdWU6IGZ1bmN0aW9uKCkgewoJCXZhciB2YWwgPSB0aGlzLm9wdGlvbnMudmFsdWU7CgkJdmFsID0gdGhpcy5fdHJpbUFsaWduVmFsdWUoIHZhbCApOwoKCQlyZXR1cm4gdmFsOwoJfSwKCgkvL2ludGVybmFsIHZhbHVlcyBnZXR0ZXIKCS8vIF92YWx1ZXMoKSByZXR1cm5zIGFycmF5IG9mIHZhbHVlcyB0cmltbWVkIGJ5IG1pbiBhbmQgbWF4LCBhbGlnbmVkIGJ5IHN0ZXAKCS8vIF92YWx1ZXMoIGluZGV4ICkgcmV0dXJucyBzaW5nbGUgdmFsdWUgdHJpbW1lZCBieSBtaW4gYW5kIG1heCwgYWxpZ25lZCBieSBzdGVwCglfdmFsdWVzOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIHZhbCwKCQkJdmFscywKCQkJaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl2YWwgPSB0aGlzLm9wdGlvbnMudmFsdWVzWyBpbmRleCBdOwoJCQl2YWwgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggdmFsICk7CgoJCQlyZXR1cm4gdmFsOwoJCX0gZWxzZSBpZiAoIHRoaXMuX2hhc011bHRpcGxlVmFsdWVzKCkgKSB7CgoJCQkvLyAuc2xpY2UoKSBjcmVhdGVzIGEgY29weSBvZiB0aGUgYXJyYXkKCQkJLy8gdGhpcyBjb3B5IGdldHMgdHJpbW1lZCBieSBtaW4gYW5kIG1heCBhbmQgdGhlbiByZXR1cm5lZAoJCQl2YWxzID0gdGhpcy5vcHRpb25zLnZhbHVlcy5zbGljZSgpOwoJCQlmb3IgKCBpID0gMDsgaSA8IHZhbHMubGVuZ3RoOyBpICs9IDEgKSB7CgkJCQl2YWxzWyBpIF0gPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggdmFsc1sgaSBdICk7CgkJCX0KCgkJCXJldHVybiB2YWxzOwoJCX0gZWxzZSB7CgkJCXJldHVybiBbXTsKCQl9Cgl9LAoKCS8vIFJldHVybnMgdGhlIHN0ZXAtYWxpZ25lZCB2YWx1ZSB0aGF0IHZhbCBpcyBjbG9zZXN0IHRvLCBiZXR3ZWVuIChpbmNsdXNpdmUpIG1pbiBhbmQgbWF4CglfdHJpbUFsaWduVmFsdWU6IGZ1bmN0aW9uKCB2YWwgKSB7CgkJaWYgKCB2YWwgPD0gdGhpcy5fdmFsdWVNaW4oKSApIHsKCQkJcmV0dXJuIHRoaXMuX3ZhbHVlTWluKCk7CgkJfQoJCWlmICggdmFsID49IHRoaXMuX3ZhbHVlTWF4KCkgKSB7CgkJCXJldHVybiB0aGlzLl92YWx1ZU1heCgpOwoJCX0KCQl2YXIgc3RlcCA9ICggdGhpcy5vcHRpb25zLnN0ZXAgPiAwICkgPyB0aGlzLm9wdGlvbnMuc3RlcCA6IDEsCgkJCXZhbE1vZFN0ZXAgPSAoIHZhbCAtIHRoaXMuX3ZhbHVlTWluKCkgKSAlIHN0ZXAsCgkJCWFsaWduVmFsdWUgPSB2YWwgLSB2YWxNb2RTdGVwOwoKCQlpZiAoIE1hdGguYWJzKCB2YWxNb2RTdGVwICkgKiAyID49IHN0ZXAgKSB7CgkJCWFsaWduVmFsdWUgKz0gKCB2YWxNb2RTdGVwID4gMCApID8gc3RlcCA6ICggLXN0ZXAgKTsKCQl9CgoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlICM0MTI0KQoJCXJldHVybiBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoIDUgKSApOwoJfSwKCglfY2FsY3VsYXRlTmV3TWF4OiBmdW5jdGlvbigpIHsKCQl2YXIgbWF4ID0gdGhpcy5vcHRpb25zLm1heCwKCQkJbWluID0gdGhpcy5fdmFsdWVNaW4oKSwKCQkJc3RlcCA9IHRoaXMub3B0aW9ucy5zdGVwLAoJCQlhYm92ZU1pbiA9IE1hdGgucm91bmQoICggbWF4IC0gbWluICkgLyBzdGVwICkgKiBzdGVwOwoJCW1heCA9IGFib3ZlTWluICsgbWluOwoJCWlmICggbWF4ID4gdGhpcy5vcHRpb25zLm1heCApIHsKCgkJCS8vSWYgbWF4IGlzIG5vdCBkaXZpc2libGUgYnkgc3RlcCwgcm91bmRpbmcgb2ZmIG1heSBpbmNyZWFzZSBpdHMgdmFsdWUKCQkJbWF4IC09IHN0ZXA7CgkJfQoJCXRoaXMubWF4ID0gcGFyc2VGbG9hdCggbWF4LnRvRml4ZWQoIHRoaXMuX3ByZWNpc2lvbigpICkgKTsKCX0sCgoJX3ByZWNpc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIHByZWNpc2lvbiA9IHRoaXMuX3ByZWNpc2lvbk9mKCB0aGlzLm9wdGlvbnMuc3RlcCApOwoJCWlmICggdGhpcy5vcHRpb25zLm1pbiAhPT0gbnVsbCApIHsKCQkJcHJlY2lzaW9uID0gTWF0aC5tYXgoIHByZWNpc2lvbiwgdGhpcy5fcHJlY2lzaW9uT2YoIHRoaXMub3B0aW9ucy5taW4gKSApOwoJCX0KCQlyZXR1cm4gcHJlY2lzaW9uOwoJfSwKCglfcHJlY2lzaW9uT2Y6IGZ1bmN0aW9uKCBudW0gKSB7CgkJdmFyIHN0ciA9IG51bS50b1N0cmluZygpLAoJCQlkZWNpbWFsID0gc3RyLmluZGV4T2YoICIuIiApOwoJCXJldHVybiBkZWNpbWFsID09PSAtMSA/IDAgOiBzdHIubGVuZ3RoIC0gZGVjaW1hbCAtIDE7Cgl9LAoKCV92YWx1ZU1pbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMub3B0aW9ucy5taW47Cgl9LAoKCV92YWx1ZU1heDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWF4OwoJfSwKCglfcmVmcmVzaFJhbmdlOiBmdW5jdGlvbiggb3JpZW50YXRpb24gKSB7CgkJaWYgKCBvcmllbnRhdGlvbiA9PT0gInZlcnRpY2FsIiApIHsKCQkJdGhpcy5yYW5nZS5jc3MoIHsgIndpZHRoIjogIiIsICJsZWZ0IjogIiIgfSApOwoJCX0KCQlpZiAoIG9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgKSB7CgkJCXRoaXMucmFuZ2UuY3NzKCB7ICJoZWlnaHQiOiAiIiwgImJvdHRvbSI6ICIiIH0gKTsKCQl9Cgl9LAoKCV9yZWZyZXNoVmFsdWU6IGZ1bmN0aW9uKCkgewoJCXZhciBsYXN0VmFsUGVyY2VudCwgdmFsUGVyY2VudCwgdmFsdWUsIHZhbHVlTWluLCB2YWx1ZU1heCwKCQkJb1JhbmdlID0gdGhpcy5vcHRpb25zLnJhbmdlLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQl0aGF0ID0gdGhpcywKCQkJYW5pbWF0ZSA9ICggIXRoaXMuX2FuaW1hdGVPZmYgKSA/IG8uYW5pbWF0ZSA6IGZhbHNlLAoJCQlfc2V0ID0ge307CgoJCWlmICggdGhpcy5faGFzTXVsdGlwbGVWYWx1ZXMoKSApIHsKCQkJdGhpcy5oYW5kbGVzLmVhY2goIGZ1bmN0aW9uKCBpICkgewoJCQkJdmFsUGVyY2VudCA9ICggdGhhdC52YWx1ZXMoIGkgKSAtIHRoYXQuX3ZhbHVlTWluKCkgKSAvICggdGhhdC5fdmFsdWVNYXgoKSAtCgkJCQkJdGhhdC5fdmFsdWVNaW4oKSApICogMTAwOwoJCQkJX3NldFsgdGhhdC5vcmllbnRhdGlvbiA9PT0gImhvcml6b250YWwiID8gImxlZnQiIDogImJvdHRvbSIgXSA9IHZhbFBlcmNlbnQgKyAiJSI7CgkJCQkkKCB0aGlzICkuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggX3NldCwgby5hbmltYXRlICk7CgkJCQlpZiAoIHRoYXQub3B0aW9ucy5yYW5nZSA9PT0gdHJ1ZSApIHsKCQkJCQlpZiAoIHRoYXQub3JpZW50YXRpb24gPT09ICJob3Jpem9udGFsIiApIHsKCQkJCQkJaWYgKCBpID09PSAwICkgewoJCQkJCQkJdGhhdC5yYW5nZS5zdG9wKCAxLCAxIClbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCB7CgkJCQkJCQkJbGVmdDogdmFsUGVyY2VudCArICIlIgoJCQkJCQkJfSwgby5hbmltYXRlICk7CgkJCQkJCX0KCQkJCQkJaWYgKCBpID09PSAxICkgewoJCQkJCQkJdGhhdC5yYW5nZVsgYW5pbWF0ZSA/ICJhbmltYXRlIiA6ICJjc3MiIF0oIHsKCQkJCQkJCQl3aWR0aDogKCB2YWxQZXJjZW50IC0gbGFzdFZhbFBlcmNlbnQgKSArICIlIgoJCQkJCQkJfSwgewoJCQkJCQkJCXF1ZXVlOiBmYWxzZSwKCQkJCQkJCQlkdXJhdGlvbjogby5hbmltYXRlCgkJCQkJCQl9ICk7CgkJCQkJCX0KCQkJCQl9IGVsc2UgewoJCQkJCQlpZiAoIGkgPT09IDAgKSB7CgkJCQkJCQl0aGF0LnJhbmdlLnN0b3AoIDEsIDEgKVsgYW5pbWF0ZSA/ICJhbmltYXRlIiA6ICJjc3MiIF0oIHsKCQkJCQkJCQlib3R0b206ICggdmFsUGVyY2VudCApICsgIiUiCgkJCQkJCQl9LCBvLmFuaW1hdGUgKTsKCQkJCQkJfQoJCQkJCQlpZiAoIGkgPT09IDEgKSB7CgkJCQkJCQl0aGF0LnJhbmdlWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggewoJCQkJCQkJCWhlaWdodDogKCB2YWxQZXJjZW50IC0gbGFzdFZhbFBlcmNlbnQgKSArICIlIgoJCQkJCQkJfSwgewoJCQkJCQkJCXF1ZXVlOiBmYWxzZSwKCQkJCQkJCQlkdXJhdGlvbjogby5hbmltYXRlCgkJCQkJCQl9ICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQlsYXN0VmFsUGVyY2VudCA9IHZhbFBlcmNlbnQ7CgkJCX0gKTsKCQl9IGVsc2UgewoJCQl2YWx1ZSA9IHRoaXMudmFsdWUoKTsKCQkJdmFsdWVNaW4gPSB0aGlzLl92YWx1ZU1pbigpOwoJCQl2YWx1ZU1heCA9IHRoaXMuX3ZhbHVlTWF4KCk7CgkJCXZhbFBlcmNlbnQgPSAoIHZhbHVlTWF4ICE9PSB2YWx1ZU1pbiApID8KCQkJCQkoIHZhbHVlIC0gdmFsdWVNaW4gKSAvICggdmFsdWVNYXggLSB2YWx1ZU1pbiApICogMTAwIDoKCQkJCQkwOwoJCQlfc2V0WyB0aGlzLm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgPyAibGVmdCIgOiAiYm90dG9tIiBdID0gdmFsUGVyY2VudCArICIlIjsKCQkJdGhpcy5oYW5kbGUuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggX3NldCwgby5hbmltYXRlICk7CgoJCQlpZiAoIG9SYW5nZSA9PT0gIm1pbiIgJiYgdGhpcy5vcmllbnRhdGlvbiA9PT0gImhvcml6b250YWwiICkgewoJCQkJdGhpcy5yYW5nZS5zdG9wKCAxLCAxIClbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCB7CgkJCQkJd2lkdGg6IHZhbFBlcmNlbnQgKyAiJSIKCQkJCX0sIG8uYW5pbWF0ZSApOwoJCQl9CgkJCWlmICggb1JhbmdlID09PSAibWF4IiAmJiB0aGlzLm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgKSB7CgkJCQl0aGlzLnJhbmdlLnN0b3AoIDEsIDEgKVsgYW5pbWF0ZSA/ICJhbmltYXRlIiA6ICJjc3MiIF0oIHsKCQkJCQl3aWR0aDogKCAxMDAgLSB2YWxQZXJjZW50ICkgKyAiJSIKCQkJCX0sIG8uYW5pbWF0ZSApOwoJCQl9CgkJCWlmICggb1JhbmdlID09PSAibWluIiAmJiB0aGlzLm9yaWVudGF0aW9uID09PSAidmVydGljYWwiICkgewoJCQkJdGhpcy5yYW5nZS5zdG9wKCAxLCAxIClbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCB7CgkJCQkJaGVpZ2h0OiB2YWxQZXJjZW50ICsgIiUiCgkJCQl9LCBvLmFuaW1hdGUgKTsKCQkJfQoJCQlpZiAoIG9SYW5nZSA9PT0gIm1heCIgJiYgdGhpcy5vcmllbnRhdGlvbiA9PT0gInZlcnRpY2FsIiApIHsKCQkJCXRoaXMucmFuZ2Uuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggewoJCQkJCWhlaWdodDogKCAxMDAgLSB2YWxQZXJjZW50ICkgKyAiJSIKCQkJCX0sIG8uYW5pbWF0ZSApOwoJCQl9CgkJfQoJfSwKCglfaGFuZGxlRXZlbnRzOiB7CgkJa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgYWxsb3dlZCwgY3VyVmFsLCBuZXdWYWwsIHN0ZXAsCgkJCQlpbmRleCA9ICQoIGV2ZW50LnRhcmdldCApLmRhdGEoICJ1aS1zbGlkZXItaGFuZGxlLWluZGV4IiApOwoKCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCWNhc2UgJC51aS5rZXlDb2RlLkhPTUU6CgkJCQljYXNlICQudWkua2V5Q29kZS5FTkQ6CgkJCQljYXNlICQudWkua2V5Q29kZS5QQUdFX1VQOgoJCQkJY2FzZSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJY2FzZSAkLnVpLmtleUNvZGUuVVA6CgkJCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoKCQkJCWNhc2UgJC51aS5rZXlDb2RlLkRPV046CgkJCQljYXNlICQudWkua2V5Q29kZS5MRUZUOgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJaWYgKCAhdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJCQkJdGhpcy5fa2V5U2xpZGluZyA9IHRydWU7CgkJCQkJCXRoaXMuX2FkZENsYXNzKCAkKCBldmVudC50YXJnZXQgKSwgbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCQkJYWxsb3dlZCA9IHRoaXMuX3N0YXJ0KCBldmVudCwgaW5kZXggKTsKCQkJCQkJaWYgKCBhbGxvd2VkID09PSBmYWxzZSApIHsKCQkJCQkJCXJldHVybjsKCQkJCQkJfQoJCQkJCX0KCQkJCQlicmVhazsKCQkJfQoKCQkJc3RlcCA9IHRoaXMub3B0aW9ucy5zdGVwOwoJCQlpZiAoIHRoaXMuX2hhc011bHRpcGxlVmFsdWVzKCkgKSB7CgkJCQljdXJWYWwgPSBuZXdWYWwgPSB0aGlzLnZhbHVlcyggaW5kZXggKTsKCQkJfSBlbHNlIHsKCQkJCWN1clZhbCA9IG5ld1ZhbCA9IHRoaXMudmFsdWUoKTsKCQkJfQoKCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCWNhc2UgJC51aS5rZXlDb2RlLkhPTUU6CgkJCQkJbmV3VmFsID0gdGhpcy5fdmFsdWVNaW4oKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoKCQkJCQluZXdWYWwgPSB0aGlzLl92YWx1ZU1heCgpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAkLnVpLmtleUNvZGUuUEFHRV9VUDoKCQkJCQluZXdWYWwgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSgKCQkJCQkJY3VyVmFsICsgKCAoIHRoaXMuX3ZhbHVlTWF4KCkgLSB0aGlzLl92YWx1ZU1pbigpICkgLyB0aGlzLm51bVBhZ2VzICkKCQkJCQkpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJCW5ld1ZhbCA9IHRoaXMuX3RyaW1BbGlnblZhbHVlKAoJCQkJCQljdXJWYWwgLSAoICggdGhpcy5fdmFsdWVNYXgoKSAtIHRoaXMuX3ZhbHVlTWluKCkgKSAvIHRoaXMubnVtUGFnZXMgKSApOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAkLnVpLmtleUNvZGUuVVA6CgkJCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoKCQkJCQlpZiAoIGN1clZhbCA9PT0gdGhpcy5fdmFsdWVNYXgoKSApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCQluZXdWYWwgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggY3VyVmFsICsgc3RlcCApOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoKCQkJCWNhc2UgJC51aS5rZXlDb2RlLkxFRlQ6CgkJCQkJaWYgKCBjdXJWYWwgPT09IHRoaXMuX3ZhbHVlTWluKCkgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQkJbmV3VmFsID0gdGhpcy5fdHJpbUFsaWduVmFsdWUoIGN1clZhbCAtIHN0ZXAgKTsKCQkJCQlicmVhazsKCQkJfQoKCQkJdGhpcy5fc2xpZGUoIGV2ZW50LCBpbmRleCwgbmV3VmFsICk7CgkJfSwKCQlrZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgaW5kZXggPSAkKCBldmVudC50YXJnZXQgKS5kYXRhKCAidWktc2xpZGVyLWhhbmRsZS1pbmRleCIgKTsKCgkJCWlmICggdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJCXRoaXMuX3N0b3AoIGV2ZW50LCBpbmRleCApOwoJCQkJdGhpcy5fY2hhbmdlKCBldmVudCwgaW5kZXggKTsKCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCAkKCBldmVudC50YXJnZXQgKSwgbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJfQoJCX0KCX0KfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgU3Bpbm5lciAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFNwaW5uZXIKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vPj5kZXNjcmlwdGlvbjogRGlzcGxheXMgYnV0dG9ucyB0byBlYXNpbHkgaW5wdXQgbnVtYmVycyB2aWEgdGhlIGtleWJvYXJkIG9yIG1vdXNlLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc3Bpbm5lci8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL3NwaW5uZXIvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2Uvc3Bpbm5lci5jc3MKLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzCgoKCmZ1bmN0aW9uIHNwaW5uZXJNb2RpZmVyKCBmbiApIHsKCXJldHVybiBmdW5jdGlvbigpIHsKCQl2YXIgcHJldmlvdXMgPSB0aGlzLmVsZW1lbnQudmFsKCk7CgkJZm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3JlZnJlc2goKTsKCQlpZiAoIHByZXZpb3VzICE9PSB0aGlzLmVsZW1lbnQudmFsKCkgKSB7CgkJCXRoaXMuX3RyaWdnZXIoICJjaGFuZ2UiICk7CgkJfQoJfTsKfQoKJC53aWRnZXQoICJ1aS5zcGlubmVyIiwgewoJdmVyc2lvbjogIjEuMTIuMSIsCglkZWZhdWx0RWxlbWVudDogIjxpbnB1dD4iLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzcGluIiwKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCSJ1aS1zcGlubmVyIjogInVpLWNvcm5lci1hbGwiLAoJCQkidWktc3Bpbm5lci1kb3duIjogInVpLWNvcm5lci1iciIsCgkJCSJ1aS1zcGlubmVyLXVwIjogInVpLWNvcm5lci10ciIKCQl9LAoJCWN1bHR1cmU6IG51bGwsCgkJaWNvbnM6IHsKCQkJZG93bjogInVpLWljb24tdHJpYW5nbGUtMS1zIiwKCQkJdXA6ICJ1aS1pY29uLXRyaWFuZ2xlLTEtbiIKCQl9LAoJCWluY3JlbWVudGFsOiB0cnVlLAoJCW1heDogbnVsbCwKCQltaW46IG51bGwsCgkJbnVtYmVyRm9ybWF0OiBudWxsLAoJCXBhZ2U6IDEwLAoJCXN0ZXA6IDEsCgoJCWNoYW5nZTogbnVsbCwKCQlzcGluOiBudWxsLAoJCXN0YXJ0OiBudWxsLAoJCXN0b3A6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCS8vIGhhbmRsZSBzdHJpbmcgdmFsdWVzIHRoYXQgbmVlZCB0byBiZSBwYXJzZWQKCQl0aGlzLl9zZXRPcHRpb24oICJtYXgiLCB0aGlzLm9wdGlvbnMubWF4ICk7CgkJdGhpcy5fc2V0T3B0aW9uKCAibWluIiwgdGhpcy5vcHRpb25zLm1pbiApOwoJCXRoaXMuX3NldE9wdGlvbiggInN0ZXAiLCB0aGlzLm9wdGlvbnMuc3RlcCApOwoKCQkvLyBPbmx5IGZvcm1hdCBpZiB0aGVyZSBpcyBhIHZhbHVlLCBwcmV2ZW50cyB0aGUgZmllbGQgZnJvbSBiZWluZyBtYXJrZWQKCQkvLyBhcyBpbnZhbGlkIGluIEZpcmVmb3gsIHNlZSAjOTU3My4KCQlpZiAoIHRoaXMudmFsdWUoKSAhPT0gIiIgKSB7CgoJCQkvLyBGb3JtYXQgdGhlIHZhbHVlLCBidXQgZG9uJ3QgY29uc3RyYWluLgoJCQl0aGlzLl92YWx1ZSggdGhpcy5lbGVtZW50LnZhbCgpLCB0cnVlICk7CgkJfQoKCQl0aGlzLl9kcmF3KCk7CgkJdGhpcy5fb24oIHRoaXMuX2V2ZW50cyApOwoJCXRoaXMuX3JlZnJlc2goKTsKCgkJLy8gVHVybmluZyBvZmYgYXV0b2NvbXBsZXRlIHByZXZlbnRzIHRoZSBicm93c2VyIGZyb20gcmVtZW1iZXJpbmcgdGhlCgkJLy8gdmFsdWUgd2hlbiBuYXZpZ2F0aW5nIHRocm91Z2ggaGlzdG9yeSwgc28gd2UgcmUtZW5hYmxlIGF1dG9jb21wbGV0ZQoJCS8vIGlmIHRoZSBwYWdlIGlzIHVubG9hZGVkIGJlZm9yZSB0aGUgd2lkZ2V0IGlzIGRlc3Ryb3llZC4gIzc3OTAKCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsKCQkJYmVmb3JldW5sb2FkOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVBdHRyKCAiYXV0b2NvbXBsZXRlIiApOwoJCQl9CgkJfSApOwoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLl9zdXBlcigpOwoJCXZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50OwoKCQkkLmVhY2goIFsgIm1pbiIsICJtYXgiLCAic3RlcCIgXSwgZnVuY3Rpb24oIGksIG9wdGlvbiApIHsKCQkJdmFyIHZhbHVlID0gZWxlbWVudC5hdHRyKCBvcHRpb24gKTsKCQkJaWYgKCB2YWx1ZSAhPSBudWxsICYmIHZhbHVlLmxlbmd0aCApIHsKCQkJCW9wdGlvbnNbIG9wdGlvbiBdID0gdmFsdWU7CgkJCX0KCQl9ICk7CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfZXZlbnRzOiB7CgkJa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoIHRoaXMuX3N0YXJ0KCBldmVudCApICYmIHRoaXMuX2tleWRvd24oIGV2ZW50ICkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfSwKCQlrZXl1cDogIl9zdG9wIiwKCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCXRoaXMucHJldmlvdXMgPSB0aGlzLmVsZW1lbnQudmFsKCk7CgkJfSwKCQlibHVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggdGhpcy5jYW5jZWxCbHVyICkgewoJCQkJZGVsZXRlIHRoaXMuY2FuY2VsQmx1cjsKCQkJCXJldHVybjsKCQkJfQoKCQkJdGhpcy5fc3RvcCgpOwoJCQl0aGlzLl9yZWZyZXNoKCk7CgkJCWlmICggdGhpcy5wcmV2aW91cyAhPT0gdGhpcy5lbGVtZW50LnZhbCgpICkgewoJCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIsIGV2ZW50ICk7CgkJCX0KCQl9LAoJCW1vdXNld2hlZWw6IGZ1bmN0aW9uKCBldmVudCwgZGVsdGEgKSB7CgkJCWlmICggIWRlbHRhICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggIXRoaXMuc3Bpbm5pbmcgJiYgIXRoaXMuX3N0YXJ0KCBldmVudCApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl0aGlzLl9zcGluKCAoIGRlbHRhID4gMCA/IDEgOiAtMSApICogdGhpcy5vcHRpb25zLnN0ZXAsIGV2ZW50ICk7CgkJCWNsZWFyVGltZW91dCggdGhpcy5tb3VzZXdoZWVsVGltZXIgKTsKCQkJdGhpcy5tb3VzZXdoZWVsVGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMuc3Bpbm5pbmcgKSB7CgkJCQkJdGhpcy5fc3RvcCggZXZlbnQgKTsKCQkJCX0KCQkJfSwgMTAwICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSwKCQkibW91c2Vkb3duIC51aS1zcGlubmVyLWJ1dHRvbiI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHByZXZpb3VzOwoKCQkJLy8gV2UgbmV2ZXIgd2FudCB0aGUgYnV0dG9ucyB0byBoYXZlIGZvY3VzOyB3aGVuZXZlciB0aGUgdXNlciBpcwoJCQkvLyBpbnRlcmFjdGluZyB3aXRoIHRoZSBzcGlubmVyLCB0aGUgZm9jdXMgc2hvdWxkIGJlIG9uIHRoZSBpbnB1dC4KCQkJLy8gSWYgdGhlIGlucHV0IGlzIGZvY3VzZWQgdGhlbiB0aGlzLnByZXZpb3VzIGlzIHByb3Blcmx5IHNldCBmcm9tCgkJCS8vIHdoZW4gdGhlIGlucHV0IGZpcnN0IHJlY2VpdmVkIGZvY3VzLiBJZiB0aGUgaW5wdXQgaXMgbm90IGZvY3VzZWQKCQkJLy8gdGhlbiB3ZSBuZWVkIHRvIHNldCB0aGlzLnByZXZpb3VzIGJhc2VkIG9uIHRoZSB2YWx1ZSBiZWZvcmUgc3Bpbm5pbmcuCgkJCXByZXZpb3VzID0gdGhpcy5lbGVtZW50WyAwIF0gPT09ICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApID8KCQkJCXRoaXMucHJldmlvdXMgOiB0aGlzLmVsZW1lbnQudmFsKCk7CgkJCWZ1bmN0aW9uIGNoZWNrRm9jdXMoKSB7CgkJCQl2YXIgaXNBY3RpdmUgPSB0aGlzLmVsZW1lbnRbIDAgXSA9PT0gJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICk7CgkJCQlpZiAoICFpc0FjdGl2ZSApIHsKCQkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImZvY3VzIiApOwoJCQkJCXRoaXMucHJldmlvdXMgPSBwcmV2aW91czsKCgkJCQkJLy8gc3VwcG9ydDogSUUKCQkJCQkvLyBJRSBzZXRzIGZvY3VzIGFzeW5jaHJvbm91c2x5LCBzbyB3ZSBuZWVkIHRvIGNoZWNrIGlmIGZvY3VzCgkJCQkJLy8gbW92ZWQgb2ZmIG9mIHRoZSBpbnB1dCBiZWNhdXNlIHRoZSB1c2VyIGNsaWNrZWQgb24gdGhlIGJ1dHRvbi4KCQkJCQl0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQkJCXRoaXMucHJldmlvdXMgPSBwcmV2aW91czsKCQkJCQl9ICk7CgkJCQl9CgkJCX0KCgkJCS8vIEVuc3VyZSBmb2N1cyBpcyBvbiAob3Igc3RheXMgb24pIHRoZSB0ZXh0IGZpZWxkCgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCWNoZWNrRm9jdXMuY2FsbCggdGhpcyApOwoKCQkJLy8gU3VwcG9ydDogSUUKCQkJLy8gSUUgZG9lc24ndCBwcmV2ZW50IG1vdmluZyBmb2N1cyBldmVuIHdpdGggZXZlbnQucHJldmVudERlZmF1bHQoKQoJCQkvLyBzbyB3ZSBzZXQgYSBmbGFnIHRvIGtub3cgd2hlbiB3ZSBzaG91bGQgaWdub3JlIHRoZSBibHVyIGV2ZW50CgkJCS8vIGFuZCBjaGVjayAoYWdhaW4pIGlmIGZvY3VzIG1vdmVkIG9mZiBvZiB0aGUgaW5wdXQuCgkJCXRoaXMuY2FuY2VsQmx1ciA9IHRydWU7CgkJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCWRlbGV0ZSB0aGlzLmNhbmNlbEJsdXI7CgkJCQljaGVja0ZvY3VzLmNhbGwoIHRoaXMgKTsKCQkJfSApOwoKCQkJaWYgKCB0aGlzLl9zdGFydCggZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXRoaXMuX3JlcGVhdCggbnVsbCwgJCggZXZlbnQuY3VycmVudFRhcmdldCApCgkJCQkuaGFzQ2xhc3MoICJ1aS1zcGlubmVyLXVwIiApID8gMSA6IC0xLCBldmVudCApOwoJCX0sCgkJIm1vdXNldXAgLnVpLXNwaW5uZXItYnV0dG9uIjogIl9zdG9wIiwKCQkibW91c2VlbnRlciAudWktc3Bpbm5lci1idXR0b24iOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkvLyBidXR0b24gd2lsbCBhZGQgdWktc3RhdGUtYWN0aXZlIGlmIG1vdXNlIHdhcyBkb3duIHdoaWxlIG1vdXNlbGVhdmUgYW5kIGtlcHQgZG93bgoJCQlpZiAoICEkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGhpcy5fc3RhcnQoIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCXRoaXMuX3JlcGVhdCggbnVsbCwgJCggZXZlbnQuY3VycmVudFRhcmdldCApCgkJCQkuaGFzQ2xhc3MoICJ1aS1zcGlubmVyLXVwIiApID8gMSA6IC0xLCBldmVudCApOwoJCX0sCgoJCS8vIFRPRE86IGRvIHdlIHJlYWxseSB3YW50IHRvIGNvbnNpZGVyIHRoaXMgYSBzdG9wPwoJCS8vIHNob3VsZG4ndCB3ZSBqdXN0IHN0b3AgdGhlIHJlcGVhdGVyIGFuZCB3YWl0IHVudGlsIG1vdXNldXAgYmVmb3JlCgkJLy8gd2UgdHJpZ2dlciB0aGUgc3RvcCBldmVudD8KCQkibW91c2VsZWF2ZSAudWktc3Bpbm5lci1idXR0b24iOiAiX3N0b3AiCgl9LAoKCS8vIFN1cHBvcnQgbW9iaWxlIGVuaGFuY2VkIG9wdGlvbiBhbmQgbWFrZSBiYWNrY29tcGF0IG1vcmUgc2FuZQoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMudWlTcGlubmVyID0gdGhpcy5lbGVtZW50CgkJCS5hdHRyKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKQoJCQkud3JhcCggIjxzcGFuPiIgKQoJCQkucGFyZW50KCkKCgkJCQkvLyBBZGQgYnV0dG9ucwoJCQkJLmFwcGVuZCgKCQkJCQkiPGE+PC9hPjxhPjwvYT4iCgkJCQkpOwoJfSwKCglfZHJhdzogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZW5oYW5jZSgpOwoKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy51aVNwaW5uZXIsICJ1aS1zcGlubmVyIiwgInVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCIgKTsKCQl0aGlzLl9hZGRDbGFzcyggInVpLXNwaW5uZXItaW5wdXQiICk7CgoJCXRoaXMuZWxlbWVudC5hdHRyKCAicm9sZSIsICJzcGluYnV0dG9uIiApOwoKCQkvLyBCdXR0b24gYmluZGluZ3MKCQl0aGlzLmJ1dHRvbnMgPSB0aGlzLnVpU3Bpbm5lci5jaGlsZHJlbiggImEiICkKCQkJLmF0dHIoICJ0YWJJbmRleCIsIC0xICkKCQkJLmF0dHIoICJhcmlhLWhpZGRlbiIsIHRydWUgKQoJCQkuYnV0dG9uKCB7CgkJCQljbGFzc2VzOiB7CgkJCQkJInVpLWJ1dHRvbiI6ICIiCgkJCQl9CgkJCX0gKTsKCgkJLy8gVE9ETzogUmlnaHQgbm93IGJ1dHRvbiBkb2VzIG5vdCBzdXBwb3J0IGNsYXNzZXMgdGhpcyBpcyBhbHJlYWR5IHVwZGF0ZWQgaW4gYnV0dG9uIFBSCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuYnV0dG9ucywgInVpLWNvcm5lci1hbGwiICk7CgoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmJ1dHRvbnMuZmlyc3QoKSwgInVpLXNwaW5uZXItYnV0dG9uIHVpLXNwaW5uZXItdXAiICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuYnV0dG9ucy5sYXN0KCksICJ1aS1zcGlubmVyLWJ1dHRvbiB1aS1zcGlubmVyLWRvd24iICk7CgkJdGhpcy5idXR0b25zLmZpcnN0KCkuYnV0dG9uKCB7CgkJCSJpY29uIjogdGhpcy5vcHRpb25zLmljb25zLnVwLAoJCQkic2hvd0xhYmVsIjogZmFsc2UKCQl9ICk7CgkJdGhpcy5idXR0b25zLmxhc3QoKS5idXR0b24oIHsKCQkJImljb24iOiB0aGlzLm9wdGlvbnMuaWNvbnMuZG93biwKCQkJInNob3dMYWJlbCI6IGZhbHNlCgkJfSApOwoKCQkvLyBJRSA2IGRvZXNuJ3QgdW5kZXJzdGFuZCBoZWlnaHQ6IDUwJSBmb3IgdGhlIGJ1dHRvbnMKCQkvLyB1bmxlc3MgdGhlIHdyYXBwZXIgaGFzIGFuIGV4cGxpY2l0IGhlaWdodAoJCWlmICggdGhpcy5idXR0b25zLmhlaWdodCgpID4gTWF0aC5jZWlsKCB0aGlzLnVpU3Bpbm5lci5oZWlnaHQoKSAqIDAuNSApICYmCgkJCQl0aGlzLnVpU3Bpbm5lci5oZWlnaHQoKSA+IDAgKSB7CgkJCXRoaXMudWlTcGlubmVyLmhlaWdodCggdGhpcy51aVNwaW5uZXIuaGVpZ2h0KCkgKTsKCQl9Cgl9LAoKCV9rZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWtleUNvZGUgPSAkLnVpLmtleUNvZGU7CgoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJY2FzZSBrZXlDb2RlLlVQOgoJCQl0aGlzLl9yZXBlYXQoIG51bGwsIDEsIGV2ZW50ICk7CgkJCXJldHVybiB0cnVlOwoJCWNhc2Uga2V5Q29kZS5ET1dOOgoJCQl0aGlzLl9yZXBlYXQoIG51bGwsIC0xLCBldmVudCApOwoJCQlyZXR1cm4gdHJ1ZTsKCQljYXNlIGtleUNvZGUuUEFHRV9VUDoKCQkJdGhpcy5fcmVwZWF0KCBudWxsLCBvcHRpb25zLnBhZ2UsIGV2ZW50ICk7CgkJCXJldHVybiB0cnVlOwoJCWNhc2Uga2V5Q29kZS5QQUdFX0RPV046CgkJCXRoaXMuX3JlcGVhdCggbnVsbCwgLW9wdGlvbnMucGFnZSwgZXZlbnQgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9zdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggIXRoaXMuc3Bpbm5pbmcgJiYgdGhpcy5fdHJpZ2dlciggInN0YXJ0IiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmICggIXRoaXMuY291bnRlciApIHsKCQkJdGhpcy5jb3VudGVyID0gMTsKCQl9CgkJdGhpcy5zcGlubmluZyA9IHRydWU7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9yZXBlYXQ6IGZ1bmN0aW9uKCBpLCBzdGVwcywgZXZlbnQgKSB7CgkJaSA9IGkgfHwgNTAwOwoKCQljbGVhclRpbWVvdXQoIHRoaXMudGltZXIgKTsKCQl0aGlzLnRpbWVyID0gdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9yZXBlYXQoIDQwLCBzdGVwcywgZXZlbnQgKTsKCQl9LCBpICk7CgoJCXRoaXMuX3NwaW4oIHN0ZXBzICogdGhpcy5vcHRpb25zLnN0ZXAsIGV2ZW50ICk7Cgl9LAoKCV9zcGluOiBmdW5jdGlvbiggc3RlcCwgZXZlbnQgKSB7CgkJdmFyIHZhbHVlID0gdGhpcy52YWx1ZSgpIHx8IDA7CgoJCWlmICggIXRoaXMuY291bnRlciApIHsKCQkJdGhpcy5jb3VudGVyID0gMTsKCQl9CgoJCXZhbHVlID0gdGhpcy5fYWRqdXN0VmFsdWUoIHZhbHVlICsgc3RlcCAqIHRoaXMuX2luY3JlbWVudCggdGhpcy5jb3VudGVyICkgKTsKCgkJaWYgKCAhdGhpcy5zcGlubmluZyB8fCB0aGlzLl90cmlnZ2VyKCAic3BpbiIsIGV2ZW50LCB7IHZhbHVlOiB2YWx1ZSB9ICkgIT09IGZhbHNlICkgewoJCQl0aGlzLl92YWx1ZSggdmFsdWUgKTsKCQkJdGhpcy5jb3VudGVyKys7CgkJfQoJfSwKCglfaW5jcmVtZW50OiBmdW5jdGlvbiggaSApIHsKCQl2YXIgaW5jcmVtZW50YWwgPSB0aGlzLm9wdGlvbnMuaW5jcmVtZW50YWw7CgoJCWlmICggaW5jcmVtZW50YWwgKSB7CgkJCXJldHVybiAkLmlzRnVuY3Rpb24oIGluY3JlbWVudGFsICkgPwoJCQkJaW5jcmVtZW50YWwoIGkgKSA6CgkJCQlNYXRoLmZsb29yKCBpICogaSAqIGkgLyA1MDAwMCAtIGkgKiBpIC8gNTAwICsgMTcgKiBpIC8gMjAwICsgMSApOwoJCX0KCgkJcmV0dXJuIDE7Cgl9LAoKCV9wcmVjaXNpb246IGZ1bmN0aW9uKCkgewoJCXZhciBwcmVjaXNpb24gPSB0aGlzLl9wcmVjaXNpb25PZiggdGhpcy5vcHRpb25zLnN0ZXAgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5taW4gIT09IG51bGwgKSB7CgkJCXByZWNpc2lvbiA9IE1hdGgubWF4KCBwcmVjaXNpb24sIHRoaXMuX3ByZWNpc2lvbk9mKCB0aGlzLm9wdGlvbnMubWluICkgKTsKCQl9CgkJcmV0dXJuIHByZWNpc2lvbjsKCX0sCgoJX3ByZWNpc2lvbk9mOiBmdW5jdGlvbiggbnVtICkgewoJCXZhciBzdHIgPSBudW0udG9TdHJpbmcoKSwKCQkJZGVjaW1hbCA9IHN0ci5pbmRleE9mKCAiLiIgKTsKCQlyZXR1cm4gZGVjaW1hbCA9PT0gLTEgPyAwIDogc3RyLmxlbmd0aCAtIGRlY2ltYWwgLSAxOwoJfSwKCglfYWRqdXN0VmFsdWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgYmFzZSwgYWJvdmVNaW4sCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIE1ha2Ugc3VyZSB3ZSdyZSBhdCBhIHZhbGlkIHN0ZXAKCQkvLyAtIGZpbmQgb3V0IHdoZXJlIHdlIGFyZSByZWxhdGl2ZSB0byB0aGUgYmFzZSAobWluIG9yIDApCgkJYmFzZSA9IG9wdGlvbnMubWluICE9PSBudWxsID8gb3B0aW9ucy5taW4gOiAwOwoJCWFib3ZlTWluID0gdmFsdWUgLSBiYXNlOwoKCQkvLyAtIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQlhYm92ZU1pbiA9IE1hdGgucm91bmQoIGFib3ZlTWluIC8gb3B0aW9ucy5zdGVwICkgKiBvcHRpb25zLnN0ZXA7CgoJCS8vIC0gcm91bmRpbmcgaXMgYmFzZWQgb24gMCwgc28gYWRqdXN0IGJhY2sgdG8gb3VyIGJhc2UKCQl2YWx1ZSA9IGJhc2UgKyBhYm92ZU1pbjsKCgkJLy8gRml4IHByZWNpc2lvbiBmcm9tIGJhZCBKUyBmbG9hdGluZyBwb2ludCBtYXRoCgkJdmFsdWUgPSBwYXJzZUZsb2F0KCB2YWx1ZS50b0ZpeGVkKCB0aGlzLl9wcmVjaXNpb24oKSApICk7CgoJCS8vIENsYW1wIHRoZSB2YWx1ZQoJCWlmICggb3B0aW9ucy5tYXggIT09IG51bGwgJiYgdmFsdWUgPiBvcHRpb25zLm1heCApIHsKCQkJcmV0dXJuIG9wdGlvbnMubWF4OwoJCX0KCQlpZiAoIG9wdGlvbnMubWluICE9PSBudWxsICYmIHZhbHVlIDwgb3B0aW9ucy5taW4gKSB7CgkJCXJldHVybiBvcHRpb25zLm1pbjsKCQl9CgoJCXJldHVybiB2YWx1ZTsKCX0sCgoJX3N0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoICF0aGlzLnNwaW5uaW5nICkgewoJCQlyZXR1cm47CgkJfQoKCQljbGVhclRpbWVvdXQoIHRoaXMudGltZXIgKTsKCQljbGVhclRpbWVvdXQoIHRoaXMubW91c2V3aGVlbFRpbWVyICk7CgkJdGhpcy5jb3VudGVyID0gMDsKCQl0aGlzLnNwaW5uaW5nID0gZmFsc2U7CgkJdGhpcy5fdHJpZ2dlciggInN0b3AiLCBldmVudCApOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgcHJldlZhbHVlLCBmaXJzdCwgbGFzdDsKCgkJaWYgKCBrZXkgPT09ICJjdWx0dXJlIiB8fCBrZXkgPT09ICJudW1iZXJGb3JtYXQiICkgewoJCQlwcmV2VmFsdWUgPSB0aGlzLl9wYXJzZSggdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJdGhpcy5lbGVtZW50LnZhbCggdGhpcy5fZm9ybWF0KCBwcmV2VmFsdWUgKSApOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGtleSA9PT0gIm1heCIgfHwga2V5ID09PSAibWluIiB8fCBrZXkgPT09ICJzdGVwIiApIHsKCQkJaWYgKCB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICkgewoJCQkJdmFsdWUgPSB0aGlzLl9wYXJzZSggdmFsdWUgKTsKCQkJfQoJCX0KCQlpZiAoIGtleSA9PT0gImljb25zIiApIHsKCQkJZmlyc3QgPSB0aGlzLmJ1dHRvbnMuZmlyc3QoKS5maW5kKCAiLnVpLWljb24iICk7CgkJCXRoaXMuX3JlbW92ZUNsYXNzKCBmaXJzdCwgbnVsbCwgdGhpcy5vcHRpb25zLmljb25zLnVwICk7CgkJCXRoaXMuX2FkZENsYXNzKCBmaXJzdCwgbnVsbCwgdmFsdWUudXAgKTsKCQkJbGFzdCA9IHRoaXMuYnV0dG9ucy5sYXN0KCkuZmluZCggIi51aS1pY29uIiApOwoJCQl0aGlzLl9yZW1vdmVDbGFzcyggbGFzdCwgbnVsbCwgdGhpcy5vcHRpb25zLmljb25zLmRvd24gKTsKCQkJdGhpcy5fYWRkQ2xhc3MoIGxhc3QsIG51bGwsIHZhbHVlLmRvd24gKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7Cgl9LAoKCV9zZXRPcHRpb25EaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuX3N1cGVyKCB2YWx1ZSApOwoKCQl0aGlzLl90b2dnbGVDbGFzcyggdGhpcy51aVNwaW5uZXIsIG51bGwsICJ1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKTsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgISF2YWx1ZSApOwoJCXRoaXMuYnV0dG9ucy5idXR0b24oIHZhbHVlID8gImRpc2FibGUiIDogImVuYWJsZSIgKTsKCX0sCgoJX3NldE9wdGlvbnM6IHNwaW5uZXJNb2RpZmVyKCBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSApLAoKCV9wYXJzZTogZnVuY3Rpb24oIHZhbCApIHsKCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJzdHJpbmciICYmIHZhbCAhPT0gIiIgKSB7CgkJCXZhbCA9IHdpbmRvdy5HbG9iYWxpemUgJiYgdGhpcy5vcHRpb25zLm51bWJlckZvcm1hdCA/CgkJCQlHbG9iYWxpemUucGFyc2VGbG9hdCggdmFsLCAxMCwgdGhpcy5vcHRpb25zLmN1bHR1cmUgKSA6ICt2YWw7CgkJfQoJCXJldHVybiB2YWwgPT09ICIiIHx8IGlzTmFOKCB2YWwgKSA/IG51bGwgOiB2YWw7Cgl9LAoKCV9mb3JtYXQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlpZiAoIHZhbHVlID09PSAiIiApIHsKCQkJcmV0dXJuICIiOwoJCX0KCQlyZXR1cm4gd2luZG93Lkdsb2JhbGl6ZSAmJiB0aGlzLm9wdGlvbnMubnVtYmVyRm9ybWF0ID8KCQkJR2xvYmFsaXplLmZvcm1hdCggdmFsdWUsIHRoaXMub3B0aW9ucy5udW1iZXJGb3JtYXQsIHRoaXMub3B0aW9ucy5jdWx0dXJlICkgOgoJCQl2YWx1ZTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCB7CgkJCSJhcmlhLXZhbHVlbWluIjogdGhpcy5vcHRpb25zLm1pbiwKCQkJImFyaWEtdmFsdWVtYXgiOiB0aGlzLm9wdGlvbnMubWF4LAoKCQkJLy8gVE9ETzogd2hhdCBzaG91bGQgd2UgZG8gd2l0aCB2YWx1ZXMgdGhhdCBjYW4ndCBiZSBwYXJzZWQ/CgkJCSJhcmlhLXZhbHVlbm93IjogdGhpcy5fcGFyc2UoIHRoaXMuZWxlbWVudC52YWwoKSApCgkJfSApOwoJfSwKCglpc1ZhbGlkOiBmdW5jdGlvbigpIHsKCQl2YXIgdmFsdWUgPSB0aGlzLnZhbHVlKCk7CgoJCS8vIE51bGwgaXMgaW52YWxpZAoJCWlmICggdmFsdWUgPT09IG51bGwgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vIElmIHZhbHVlIGdldHMgYWRqdXN0ZWQsIGl0J3MgaW52YWxpZAoJCXJldHVybiB2YWx1ZSA9PT0gdGhpcy5fYWRqdXN0VmFsdWUoIHZhbHVlICk7Cgl9LAoKCS8vIFVwZGF0ZSB0aGUgdmFsdWUgd2l0aG91dCB0cmlnZ2VyaW5nIGNoYW5nZQoJX3ZhbHVlOiBmdW5jdGlvbiggdmFsdWUsIGFsbG93QW55ICkgewoJCXZhciBwYXJzZWQ7CgkJaWYgKCB2YWx1ZSAhPT0gIiIgKSB7CgkJCXBhcnNlZCA9IHRoaXMuX3BhcnNlKCB2YWx1ZSApOwoJCQlpZiAoIHBhcnNlZCAhPT0gbnVsbCApIHsKCQkJCWlmICggIWFsbG93QW55ICkgewoJCQkJCXBhcnNlZCA9IHRoaXMuX2FkanVzdFZhbHVlKCBwYXJzZWQgKTsKCQkJCX0KCQkJCXZhbHVlID0gdGhpcy5fZm9ybWF0KCBwYXJzZWQgKTsKCQkJfQoJCX0KCQl0aGlzLmVsZW1lbnQudmFsKCB2YWx1ZSApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudAoJCQkucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKQoJCQkucmVtb3ZlQXR0ciggImF1dG9jb21wbGV0ZSByb2xlIGFyaWEtdmFsdWVtaW4gYXJpYS12YWx1ZW1heCBhcmlhLXZhbHVlbm93IiApOwoKCQl0aGlzLnVpU3Bpbm5lci5yZXBsYWNlV2l0aCggdGhpcy5lbGVtZW50ICk7Cgl9LAoKCXN0ZXBVcDogc3Bpbm5lck1vZGlmZXIoIGZ1bmN0aW9uKCBzdGVwcyApIHsKCQl0aGlzLl9zdGVwVXAoIHN0ZXBzICk7Cgl9ICksCglfc3RlcFVwOiBmdW5jdGlvbiggc3RlcHMgKSB7CgkJaWYgKCB0aGlzLl9zdGFydCgpICkgewoJCQl0aGlzLl9zcGluKCAoIHN0ZXBzIHx8IDEgKSAqIHRoaXMub3B0aW9ucy5zdGVwICk7CgkJCXRoaXMuX3N0b3AoKTsKCQl9Cgl9LAoKCXN0ZXBEb3duOiBzcGlubmVyTW9kaWZlciggZnVuY3Rpb24oIHN0ZXBzICkgewoJCXRoaXMuX3N0ZXBEb3duKCBzdGVwcyApOwoJfSApLAoJX3N0ZXBEb3duOiBmdW5jdGlvbiggc3RlcHMgKSB7CgkJaWYgKCB0aGlzLl9zdGFydCgpICkgewoJCQl0aGlzLl9zcGluKCAoIHN0ZXBzIHx8IDEgKSAqIC10aGlzLm9wdGlvbnMuc3RlcCApOwoJCQl0aGlzLl9zdG9wKCk7CgkJfQoJfSwKCglwYWdlVXA6IHNwaW5uZXJNb2RpZmVyKCBmdW5jdGlvbiggcGFnZXMgKSB7CgkJdGhpcy5fc3RlcFVwKCAoIHBhZ2VzIHx8IDEgKSAqIHRoaXMub3B0aW9ucy5wYWdlICk7Cgl9ICksCgoJcGFnZURvd246IHNwaW5uZXJNb2RpZmVyKCBmdW5jdGlvbiggcGFnZXMgKSB7CgkJdGhpcy5fc3RlcERvd24oICggcGFnZXMgfHwgMSApICogdGhpcy5vcHRpb25zLnBhZ2UgKTsKCX0gKSwKCgl2YWx1ZTogZnVuY3Rpb24oIG5ld1ZhbCApIHsKCQlpZiAoICFhcmd1bWVudHMubGVuZ3RoICkgewoJCQlyZXR1cm4gdGhpcy5fcGFyc2UoIHRoaXMuZWxlbWVudC52YWwoKSApOwoJCX0KCQlzcGlubmVyTW9kaWZlciggdGhpcy5fdmFsdWUgKS5jYWxsKCB0aGlzLCBuZXdWYWwgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy51aVNwaW5uZXI7Cgl9Cn0gKTsKCi8vIERFUFJFQ0FURUQKLy8gVE9ETzogc3dpdGNoIHJldHVybiBiYWNrIHRvIHdpZGdldCBkZWNsYXJhdGlvbiBhdCB0b3Agb2YgZmlsZSB3aGVuIHRoaXMgaXMgcmVtb3ZlZAppZiAoICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSApIHsKCgkvLyBCYWNrY29tcGF0IGZvciBzcGlubmVyIGh0bWwgZXh0ZW5zaW9uIHBvaW50cwoJJC53aWRnZXQoICJ1aS5zcGlubmVyIiwgJC51aS5zcGlubmVyLCB7CgkJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnVpU3Bpbm5lciA9IHRoaXMuZWxlbWVudAoJCQkJLmF0dHIoICJhdXRvY29tcGxldGUiLCAib2ZmIiApCgkJCQkud3JhcCggdGhpcy5fdWlTcGlubmVySHRtbCgpICkKCQkJCS5wYXJlbnQoKQoKCQkJCQkvLyBBZGQgYnV0dG9ucwoJCQkJCS5hcHBlbmQoIHRoaXMuX2J1dHRvbkh0bWwoKSApOwoJCX0sCgkJX3VpU3Bpbm5lckh0bWw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gIjxzcGFuPiI7CgkJfSwKCgkJX2J1dHRvbkh0bWw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gIjxhPjwvYT48YT48L2E+IjsKCQl9Cgl9ICk7Cn0KCnZhciB3aWRnZXRzU3Bpbm5lciA9ICQudWkuc3Bpbm5lcjsKCgovKiEKICogalF1ZXJ5IFVJIFRhYnMgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBUYWJzCi8vPj5ncm91cDogV2lkZ2V0cwovLz4+ZGVzY3JpcHRpb246IFRyYW5zZm9ybXMgYSBzZXQgb2YgY29udGFpbmVyIGVsZW1lbnRzIGludG8gYSB0YWIgc3RydWN0dXJlLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vdGFicy8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL3RhYnMvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGFicy5jc3MKLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzCgoKCiQud2lkZ2V0KCAidWkudGFicyIsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJZGVsYXk6IDMwMCwKCW9wdGlvbnM6IHsKCQlhY3RpdmU6IG51bGwsCgkJY2xhc3NlczogewoJCQkidWktdGFicyI6ICJ1aS1jb3JuZXItYWxsIiwKCQkJInVpLXRhYnMtbmF2IjogInVpLWNvcm5lci1hbGwiLAoJCQkidWktdGFicy1wYW5lbCI6ICJ1aS1jb3JuZXItYm90dG9tIiwKCQkJInVpLXRhYnMtdGFiIjogInVpLWNvcm5lci10b3AiCgkJfSwKCQljb2xsYXBzaWJsZTogZmFsc2UsCgkJZXZlbnQ6ICJjbGljayIsCgkJaGVpZ2h0U3R5bGU6ICJjb250ZW50IiwKCQloaWRlOiBudWxsLAoJCXNob3c6IG51bGwsCgoJCS8vIENhbGxiYWNrcwoJCWFjdGl2YXRlOiBudWxsLAoJCWJlZm9yZUFjdGl2YXRlOiBudWxsLAoJCWJlZm9yZUxvYWQ6IG51bGwsCgkJbG9hZDogbnVsbAoJfSwKCglfaXNMb2NhbDogKCBmdW5jdGlvbigpIHsKCQl2YXIgcmhhc2ggPSAvIy4qJC87CgoJCXJldHVybiBmdW5jdGlvbiggYW5jaG9yICkgewoJCQl2YXIgYW5jaG9yVXJsLCBsb2NhdGlvblVybDsKCgkJCWFuY2hvclVybCA9IGFuY2hvci5ocmVmLnJlcGxhY2UoIHJoYXNoLCAiIiApOwoJCQlsb2NhdGlvblVybCA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSggcmhhc2gsICIiICk7CgoJCQkvLyBEZWNvZGluZyBtYXkgdGhyb3cgYW4gZXJyb3IgaWYgdGhlIFVSTCBpc24ndCBVVEYtOCAoIzk1MTgpCgkJCXRyeSB7CgkJCQlhbmNob3JVcmwgPSBkZWNvZGVVUklDb21wb25lbnQoIGFuY2hvclVybCApOwoJCQl9IGNhdGNoICggZXJyb3IgKSB7fQoJCQl0cnkgewoJCQkJbG9jYXRpb25VcmwgPSBkZWNvZGVVUklDb21wb25lbnQoIGxvY2F0aW9uVXJsICk7CgkJCX0gY2F0Y2ggKCBlcnJvciApIHt9CgoJCQlyZXR1cm4gYW5jaG9yLmhhc2gubGVuZ3RoID4gMSAmJiBhbmNob3JVcmwgPT09IGxvY2F0aW9uVXJsOwoJCX07Cgl9ICkoKSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoKCQl0aGlzLl9hZGRDbGFzcyggInVpLXRhYnMiLCAidWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IiApOwoJCXRoaXMuX3RvZ2dsZUNsYXNzKCAidWktdGFicy1jb2xsYXBzaWJsZSIsIG51bGwsIG9wdGlvbnMuY29sbGFwc2libGUgKTsKCgkJdGhpcy5fcHJvY2Vzc1RhYnMoKTsKCQlvcHRpb25zLmFjdGl2ZSA9IHRoaXMuX2luaXRpYWxBY3RpdmUoKTsKCgkJLy8gVGFrZSBkaXNhYmxpbmcgdGFicyB2aWEgY2xhc3MgYXR0cmlidXRlIGZyb20gSFRNTAoJCS8vIGludG8gYWNjb3VudCBhbmQgdXBkYXRlIG9wdGlvbiBwcm9wZXJseS4KCQlpZiAoICQuaXNBcnJheSggb3B0aW9ucy5kaXNhYmxlZCApICkgewoJCQlvcHRpb25zLmRpc2FibGVkID0gJC51bmlxdWUoIG9wdGlvbnMuZGlzYWJsZWQuY29uY2F0KAoJCQkJJC5tYXAoIHRoaXMudGFicy5maWx0ZXIoICIudWktc3RhdGUtZGlzYWJsZWQiICksIGZ1bmN0aW9uKCBsaSApIHsKCQkJCQlyZXR1cm4gdGhhdC50YWJzLmluZGV4KCBsaSApOwoJCQkJfSApCgkJCSkgKS5zb3J0KCk7CgkJfQoKCQkvLyBDaGVjayBmb3IgbGVuZ3RoIGF2b2lkcyBlcnJvciB3aGVuIGluaXRpYWxpemluZyBlbXB0eSBsaXN0CgkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlICE9PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQl0aGlzLmFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIG9wdGlvbnMuYWN0aXZlICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIG9wdGlvbnMuYWN0aXZlICk7CgkJfQoJfSwKCglfaW5pdGlhbEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFjdGl2ZSA9IHRoaXMub3B0aW9ucy5hY3RpdmUsCgkJCWNvbGxhcHNpYmxlID0gdGhpcy5vcHRpb25zLmNvbGxhcHNpYmxlLAoJCQlsb2NhdGlvbkhhc2ggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZyggMSApOwoKCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCgkJCS8vIGNoZWNrIHRoZSBmcmFnbWVudCBpZGVudGlmaWVyIGluIHRoZSBVUkwKCQkJaWYgKCBsb2NhdGlvbkhhc2ggKSB7CgkJCQl0aGlzLnRhYnMuZWFjaCggZnVuY3Rpb24oIGksIHRhYiApIHsKCQkJCQlpZiAoICQoIHRhYiApLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApID09PSBsb2NhdGlvbkhhc2ggKSB7CgkJCQkJCWFjdGl2ZSA9IGk7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9ICk7CgkJCX0KCgkJCS8vIENoZWNrIGZvciBhIHRhYiBtYXJrZWQgYWN0aXZlIHZpYSBhIGNsYXNzCgkJCWlmICggYWN0aXZlID09PSBudWxsICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXRhYnMtYWN0aXZlIiApICk7CgkJCX0KCgkJCS8vIE5vIGFjdGl2ZSB0YWIsIHNldCB0byBmYWxzZQoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCB8fCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmxlbmd0aCA/IDAgOiBmYWxzZTsKCQkJfQoJCX0KCgkJLy8gSGFuZGxlIG51bWJlcnM6IG5lZ2F0aXZlLCBvdXQgb2YgcmFuZ2UKCQlpZiAoIGFjdGl2ZSAhPT0gZmFsc2UgKSB7CgkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmVxKCBhY3RpdmUgKSApOwoJCQlpZiAoIGFjdGl2ZSA9PT0gLTEgKSB7CgkJCQlhY3RpdmUgPSBjb2xsYXBzaWJsZSA/IGZhbHNlIDogMDsKCQkJfQoJCX0KCgkJLy8gRG9uJ3QgYWxsb3cgY29sbGFwc2libGU6IGZhbHNlIGFuZCBhY3RpdmU6IGZhbHNlCgkJaWYgKCAhY29sbGFwc2libGUgJiYgYWN0aXZlID09PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlhY3RpdmUgPSAwOwoJCX0KCgkJcmV0dXJuIGFjdGl2ZTsKCX0sCgoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJdGFiOiB0aGlzLmFjdGl2ZSwKCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKQoJCX07Cgl9LAoKCV90YWJLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGZvY3VzZWRUYWIgPSAkKCAkLnVpLnNhZmVBY3RpdmVFbGVtZW50KCB0aGlzLmRvY3VtZW50WyAwIF0gKSApLmNsb3Nlc3QoICJsaSIgKSwKCQkJc2VsZWN0ZWRJbmRleCA9IHRoaXMudGFicy5pbmRleCggZm9jdXNlZFRhYiApLAoJCQlnb2luZ0ZvcndhcmQgPSB0cnVlOwoKCQlpZiAoIHRoaXMuX2hhbmRsZVBhZ2VOYXYoIGV2ZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJY2FzZSAkLnVpLmtleUNvZGUuUklHSFQ6CgkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoKCQkJc2VsZWN0ZWRJbmRleCsrOwoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5VUDoKCQljYXNlICQudWkua2V5Q29kZS5MRUZUOgoJCQlnb2luZ0ZvcndhcmQgPSBmYWxzZTsKCQkJc2VsZWN0ZWRJbmRleC0tOwoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5FTkQ6CgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLmFuY2hvcnMubGVuZ3RoIC0gMTsKCQkJYnJlYWs7CgkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToKCQkJc2VsZWN0ZWRJbmRleCA9IDA7CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLlNQQUNFOgoKCQkJLy8gQWN0aXZhdGUgb25seSwgbm8gY29sbGFwc2luZwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCApOwoJCQlyZXR1cm47CgkJY2FzZSAkLnVpLmtleUNvZGUuRU5URVI6CgoJCQkvLyBUb2dnbGUgKGNhbmNlbCBkZWxheWVkIGFjdGl2YXRpb24sIGFsbG93IGNvbGxhcHNpbmcpCgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgoJCQkvLyBEZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGNvbGxhcHNlIG9yIGFjdGl2YXRlCgkJCXRoaXMuX2FjdGl2YXRlKCBzZWxlY3RlZEluZGV4ID09PSB0aGlzLm9wdGlvbnMuYWN0aXZlID8gZmFsc2UgOiBzZWxlY3RlZEluZGV4ICk7CgkJCXJldHVybjsKCQlkZWZhdWx0OgoJCQlyZXR1cm47CgkJfQoKCQkvLyBGb2N1cyB0aGUgYXBwcm9wcmlhdGUgdGFiLCBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuX2ZvY3VzTmV4dFRhYiggc2VsZWN0ZWRJbmRleCwgZ29pbmdGb3J3YXJkICk7CgoJCS8vIE5hdmlnYXRpbmcgd2l0aCBjb250cm9sL2NvbW1hbmQga2V5IHdpbGwgcHJldmVudCBhdXRvbWF0aWMgYWN0aXZhdGlvbgoJCWlmICggIWV2ZW50LmN0cmxLZXkgJiYgIWV2ZW50Lm1ldGFLZXkgKSB7CgoJCQkvLyBVcGRhdGUgYXJpYS1zZWxlY3RlZCBpbW1lZGlhdGVseSBzbyB0aGF0IEFUIHRoaW5rIHRoZSB0YWIgaXMgYWxyZWFkeSBzZWxlY3RlZC4KCQkJLy8gT3RoZXJ3aXNlIEFUIG1heSBjb25mdXNlIHRoZSB1c2VyIGJ5IHN0YXRpbmcgdGhhdCB0aGV5IG5lZWQgdG8gYWN0aXZhdGUgdGhlIHRhYiwKCQkJLy8gYnV0IHRoZSB0YWIgd2lsbCBhbHJlYWR5IGJlIGFjdGl2YXRlZCBieSB0aGUgdGltZSB0aGUgYW5ub3VuY2VtZW50IGZpbmlzaGVzLgoJCQlmb2N1c2VkVGFiLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgImZhbHNlIiApOwoJCQl0aGlzLnRhYnMuZXEoIHNlbGVjdGVkSW5kZXggKS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsICJ0cnVlIiApOwoKCQkJdGhpcy5hY3RpdmF0aW5nID0gdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5vcHRpb24oICJhY3RpdmUiLCBzZWxlY3RlZEluZGV4ICk7CgkJCX0sIHRoaXMuZGVsYXkgKTsKCQl9Cgl9LAoKCV9wYW5lbEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMuX2hhbmRsZVBhZ2VOYXYoIGV2ZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEN0cmwrdXAgbW92ZXMgZm9jdXMgdG8gdGhlIGN1cnJlbnQgdGFiCgkJaWYgKCBldmVudC5jdHJsS2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5VUCApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJdGhpcy5hY3RpdmUudHJpZ2dlciggImZvY3VzIiApOwoJCX0KCX0sCgoJLy8gQWx0K3BhZ2UgdXAvZG93biBtb3ZlcyBmb2N1cyB0byB0aGUgcHJldmlvdXMvbmV4dCB0YWIgKGFuZCBhY3RpdmF0ZXMpCglfaGFuZGxlUGFnZU5hdjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggZXZlbnQuYWx0S2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5QQUdFX1VQICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZm9jdXNOZXh0VGFiKCB0aGlzLm9wdGlvbnMuYWN0aXZlIC0gMSwgZmFsc2UgKSApOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJaWYgKCBldmVudC5hbHRLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlBBR0VfRE9XTiApIHsKCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZvY3VzTmV4dFRhYiggdGhpcy5vcHRpb25zLmFjdGl2ZSArIDEsIHRydWUgKSApOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9LAoKCV9maW5kTmV4dFRhYjogZnVuY3Rpb24oIGluZGV4LCBnb2luZ0ZvcndhcmQgKSB7CgkJdmFyIGxhc3RUYWJJbmRleCA9IHRoaXMudGFicy5sZW5ndGggLSAxOwoKCQlmdW5jdGlvbiBjb25zdHJhaW4oKSB7CgkJCWlmICggaW5kZXggPiBsYXN0VGFiSW5kZXggKSB7CgkJCQlpbmRleCA9IDA7CgkJCX0KCQkJaWYgKCBpbmRleCA8IDAgKSB7CgkJCQlpbmRleCA9IGxhc3RUYWJJbmRleDsKCQkJfQoJCQlyZXR1cm4gaW5kZXg7CgkJfQoKCQl3aGlsZSAoICQuaW5BcnJheSggY29uc3RyYWluKCksIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApICE9PSAtMSApIHsKCQkJaW5kZXggPSBnb2luZ0ZvcndhcmQgPyBpbmRleCArIDEgOiBpbmRleCAtIDE7CgkJfQoKCQlyZXR1cm4gaW5kZXg7Cgl9LAoKCV9mb2N1c05leHRUYWI6IGZ1bmN0aW9uKCBpbmRleCwgZ29pbmdGb3J3YXJkICkgewoJCWluZGV4ID0gdGhpcy5fZmluZE5leHRUYWIoIGluZGV4LCBnb2luZ0ZvcndhcmQgKTsKCQl0aGlzLnRhYnMuZXEoIGluZGV4ICkudHJpZ2dlciggImZvY3VzIiApOwoJCXJldHVybiBpbmRleDsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJhY3RpdmUiICkgewoKCQkJLy8gX2FjdGl2YXRlKCkgd2lsbCBoYW5kbGUgaW52YWxpZCB2YWx1ZXMgYW5kIHVwZGF0ZSB0aGlzLm9wdGlvbnMKCQkJdGhpcy5fYWN0aXZhdGUoIHZhbHVlICk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7CgoJCWlmICgga2V5ID09PSAiY29sbGFwc2libGUiICkgewoJCQl0aGlzLl90b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCBudWxsLCB2YWx1ZSApOwoKCQkJLy8gU2V0dGluZyBjb2xsYXBzaWJsZTogZmFsc2Ugd2hpbGUgY29sbGFwc2VkOyBvcGVuIGZpcnN0IHBhbmVsCgkJCWlmICggIXZhbHVlICYmIHRoaXMub3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgewoJCQkJdGhpcy5fYWN0aXZhdGUoIDAgKTsKCQkJfQoJCX0KCgkJaWYgKCBrZXkgPT09ICJldmVudCIgKSB7CgkJCXRoaXMuX3NldHVwRXZlbnRzKCB2YWx1ZSApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJoZWlnaHRTdHlsZSIgKSB7CgkJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHZhbHVlICk7CgkJfQoJfSwKCglfc2FuaXRpemVTZWxlY3RvcjogZnVuY3Rpb24oIGhhc2ggKSB7CgkJcmV0dXJuIGhhc2ggPyBoYXNoLnJlcGxhY2UoIC9bISIkJSYnKCkqKywuXC86Ozw9Pj9AXFtcXVxeYHt8fX5dL2csICJcXCQmIiApIDogIiI7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlsaXMgPSB0aGlzLnRhYmxpc3QuY2hpbGRyZW4oICI6aGFzKGFbaHJlZl0pIiApOwoKCQkvLyBHZXQgZGlzYWJsZWQgdGFicyBmcm9tIGNsYXNzIGF0dHJpYnV0ZSBmcm9tIEhUTUwKCQkvLyB0aGlzIHdpbGwgZ2V0IGNvbnZlcnRlZCB0byBhIGJvb2xlYW4gaWYgbmVlZGVkIGluIF9yZWZyZXNoKCkKCQlvcHRpb25zLmRpc2FibGVkID0gJC5tYXAoIGxpcy5maWx0ZXIoICIudWktc3RhdGUtZGlzYWJsZWQiICksIGZ1bmN0aW9uKCB0YWIgKSB7CgkJCXJldHVybiBsaXMuaW5kZXgoIHRhYiApOwoJCX0gKTsKCgkJdGhpcy5fcHJvY2Vzc1RhYnMoKTsKCgkJLy8gV2FzIGNvbGxhcHNlZCBvciBubyB0YWJzCgkJaWYgKCBvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgfHwgIXRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCXRoaXMuYWN0aXZlID0gJCgpOwoKCQkvLyB3YXMgYWN0aXZlLCBidXQgYWN0aXZlIHRhYiBpcyBnb25lCgkJfSBlbHNlIGlmICggdGhpcy5hY3RpdmUubGVuZ3RoICYmICEkLmNvbnRhaW5zKCB0aGlzLnRhYmxpc3RbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgewoKCQkJLy8gYWxsIHJlbWFpbmluZyB0YWJzIGFyZSBkaXNhYmxlZAoJCQlpZiAoIHRoaXMudGFicy5sZW5ndGggPT09IG9wdGlvbnMuZGlzYWJsZWQubGVuZ3RoICkgewoJCQkJb3B0aW9ucy5hY3RpdmUgPSBmYWxzZTsKCQkJCXRoaXMuYWN0aXZlID0gJCgpOwoKCQkJLy8gYWN0aXZhdGUgcHJldmlvdXMgdGFiCgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZmluZE5leHRUYWIoIE1hdGgubWF4KCAwLCBvcHRpb25zLmFjdGl2ZSAtIDEgKSwgZmFsc2UgKSApOwoJCQl9CgoJCS8vIHdhcyBhY3RpdmUsIGFjdGl2ZSB0YWIgc3RpbGwgZXhpc3RzCgkJfSBlbHNlIHsKCgkJCS8vIG1ha2Ugc3VyZSBhY3RpdmUgaW5kZXggaXMgY29ycmVjdAoJCQlvcHRpb25zLmFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy5hY3RpdmUgKTsKCQl9CgoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldE9wdGlvbkRpc2FibGVkKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKTsKCQl0aGlzLl9zZXR1cEV2ZW50cyggdGhpcy5vcHRpb25zLmV2ZW50ICk7CgkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICk7CgoJCXRoaXMudGFicy5ub3QoIHRoaXMuYWN0aXZlICkuYXR0ciggewoJCQkiYXJpYS1zZWxlY3RlZCI6ICJmYWxzZSIsCgkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJdGFiSW5kZXg6IC0xCgkJfSApOwoJCXRoaXMucGFuZWxzLm5vdCggdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkgKQoJCQkuaGlkZSgpCgkJCS5hdHRyKCB7CgkJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIKCQkJfSApOwoKCQkvLyBNYWtlIHN1cmUgb25lIHRhYiBpcyBpbiB0aGUgdGFiIG9yZGVyCgkJaWYgKCAhdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZXEoIDAgKS5hdHRyKCAidGFiSW5kZXgiLCAwICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUKCQkJCS5hdHRyKCB7CgkJCQkJImFyaWEtc2VsZWN0ZWQiOiAidHJ1ZSIsCgkJCQkJImFyaWEtZXhwYW5kZWQiOiAidHJ1ZSIsCgkJCQkJdGFiSW5kZXg6IDAKCQkJCX0gKTsKCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuYWN0aXZlLCAidWktdGFicy1hY3RpdmUiLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQl0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKQoJCQkJLnNob3coKQoJCQkJLmF0dHIoIHsKCQkJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJCQl9ICk7CgkJfQoJfSwKCglfcHJvY2Vzc1RhYnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJcHJldlRhYnMgPSB0aGlzLnRhYnMsCgkJCXByZXZBbmNob3JzID0gdGhpcy5hbmNob3JzLAoJCQlwcmV2UGFuZWxzID0gdGhpcy5wYW5lbHM7CgoJCXRoaXMudGFibGlzdCA9IHRoaXMuX2dldExpc3QoKS5hdHRyKCAicm9sZSIsICJ0YWJsaXN0IiApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnRhYmxpc3QsICJ1aS10YWJzLW5hdiIsCgkJCSJ1aS1oZWxwZXItcmVzZXQgdWktaGVscGVyLWNsZWFyZml4IHVpLXdpZGdldC1oZWFkZXIiICk7CgoJCS8vIFByZXZlbnQgdXNlcnMgZnJvbSBmb2N1c2luZyBkaXNhYmxlZCB0YWJzIHZpYSBjbGljawoJCXRoaXMudGFibGlzdAoJCQkub24oICJtb3VzZWRvd24iICsgdGhpcy5ldmVudE5hbWVzcGFjZSwgIj4gbGkiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9ICkKCgkJCS8vIFN1cHBvcnQ6IElFIDw5CgkJCS8vIFByZXZlbnRpbmcgdGhlIGRlZmF1bHQgYWN0aW9uIGluIG1vdXNlZG93biBkb2Vzbid0IHByZXZlbnQgSUUKCQkJLy8gZnJvbSBmb2N1c2luZyB0aGUgZWxlbWVudCwgc28gaWYgdGhlIGFuY2hvciBnZXRzIGZvY3VzZWQsIGJsdXIuCgkJCS8vIFdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgZm9jdXNpbmcgdGhlIHByZXZpb3VzbHkgZm9jdXNlZAoJCQkvLyBlbGVtZW50IHNpbmNlIGNsaWNraW5nIG9uIGEgbm9uLWZvY3VzYWJsZSBlbGVtZW50IHNob3VsZCBmb2N1cwoJCQkvLyB0aGUgYm9keSBhbnl3YXkuCgkJCS5vbiggImZvY3VzIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsICIudWktdGFicy1hbmNob3IiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQl0aGlzLmJsdXIoKTsKCQkJCX0KCQkJfSApOwoKCQl0aGlzLnRhYnMgPSB0aGlzLnRhYmxpc3QuZmluZCggIj4gbGk6aGFzKGFbaHJlZl0pIiApCgkJCS5hdHRyKCB7CgkJCQlyb2xlOiAidGFiIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9ICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudGFicywgInVpLXRhYnMtdGFiIiwgInVpLXN0YXRlLWRlZmF1bHQiICk7CgoJCXRoaXMuYW5jaG9ycyA9IHRoaXMudGFicy5tYXAoIGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJCggImEiLCB0aGlzIClbIDAgXTsKCQl9ICkKCQkJLmF0dHIoIHsKCQkJCXJvbGU6ICJwcmVzZW50YXRpb24iLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0gKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5hbmNob3JzLCAidWktdGFicy1hbmNob3IiICk7CgoJCXRoaXMucGFuZWxzID0gJCgpOwoKCQl0aGlzLmFuY2hvcnMuZWFjaCggZnVuY3Rpb24oIGksIGFuY2hvciApIHsKCQkJdmFyIHNlbGVjdG9yLCBwYW5lbCwgcGFuZWxJZCwKCQkJCWFuY2hvcklkID0gJCggYW5jaG9yICkudW5pcXVlSWQoKS5hdHRyKCAiaWQiICksCgkJCQl0YWIgPSAkKCBhbmNob3IgKS5jbG9zZXN0KCAibGkiICksCgkJCQlvcmlnaW5hbEFyaWFDb250cm9scyA9IHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCgkJCS8vIElubGluZSB0YWIKCQkJaWYgKCB0aGF0Ll9pc0xvY2FsKCBhbmNob3IgKSApIHsKCQkJCXNlbGVjdG9yID0gYW5jaG9yLmhhc2g7CgkJCQlwYW5lbElkID0gc2VsZWN0b3Iuc3Vic3RyaW5nKCAxICk7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCB0aGF0Ll9zYW5pdGl6ZVNlbGVjdG9yKCBzZWxlY3RvciApICk7CgoJCQkvLyByZW1vdGUgdGFiCgkJCX0gZWxzZSB7CgoJCQkJLy8gSWYgdGhlIHRhYiBkb2Vzbid0IGFscmVhZHkgaGF2ZSBhcmlhLWNvbnRyb2xzLAoJCQkJLy8gZ2VuZXJhdGUgYW4gaWQgYnkgdXNpbmcgYSB0aHJvdy1hd2F5IGVsZW1lbnQKCQkJCXBhbmVsSWQgPSB0YWIuYXR0ciggImFyaWEtY29udHJvbHMiICkgfHwgJCgge30gKS51bmlxdWVJZCgpWyAwIF0uaWQ7CgkJCQlzZWxlY3RvciA9ICIjIiArIHBhbmVsSWQ7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCBzZWxlY3RvciApOwoJCQkJaWYgKCAhcGFuZWwubGVuZ3RoICkgewoJCQkJCXBhbmVsID0gdGhhdC5fY3JlYXRlUGFuZWwoIHBhbmVsSWQgKTsKCQkJCQlwYW5lbC5pbnNlcnRBZnRlciggdGhhdC5wYW5lbHNbIGkgLSAxIF0gfHwgdGhhdC50YWJsaXN0ICk7CgkJCQl9CgkJCQlwYW5lbC5hdHRyKCAiYXJpYS1saXZlIiwgInBvbGl0ZSIgKTsKCQkJfQoKCQkJaWYgKCBwYW5lbC5sZW5ndGggKSB7CgkJCQl0aGF0LnBhbmVscyA9IHRoYXQucGFuZWxzLmFkZCggcGFuZWwgKTsKCQkJfQoJCQlpZiAoIG9yaWdpbmFsQXJpYUNvbnRyb2xzICkgewoJCQkJdGFiLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiLCBvcmlnaW5hbEFyaWFDb250cm9scyApOwoJCQl9CgkJCXRhYi5hdHRyKCB7CgkJCQkiYXJpYS1jb250cm9scyI6IHBhbmVsSWQsCgkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogYW5jaG9ySWQKCQkJfSApOwoJCQlwYW5lbC5hdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiwgYW5jaG9ySWQgKTsKCQl9ICk7CgoJCXRoaXMucGFuZWxzLmF0dHIoICJyb2xlIiwgInRhYnBhbmVsIiApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnBhbmVscywgInVpLXRhYnMtcGFuZWwiLCAidWktd2lkZ2V0LWNvbnRlbnQiICk7CgoJCS8vIEF2b2lkIG1lbW9yeSBsZWFrcyAoIzEwMDU2KQoJCWlmICggcHJldlRhYnMgKSB7CgkJCXRoaXMuX29mZiggcHJldlRhYnMubm90KCB0aGlzLnRhYnMgKSApOwoJCQl0aGlzLl9vZmYoIHByZXZBbmNob3JzLm5vdCggdGhpcy5hbmNob3JzICkgKTsKCQkJdGhpcy5fb2ZmKCBwcmV2UGFuZWxzLm5vdCggdGhpcy5wYW5lbHMgKSApOwoJCX0KCX0sCgoJLy8gQWxsb3cgb3ZlcnJpZGluZyBob3cgdG8gZmluZCB0aGUgbGlzdCBmb3IgcmFyZSB1c2FnZSBzY2VuYXJpb3MgKCM3NzE1KQoJX2dldExpc3Q6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnRhYmxpc3QgfHwgdGhpcy5lbGVtZW50LmZpbmQoICJvbCwgdWwiICkuZXEoIDAgKTsKCX0sCgoJX2NyZWF0ZVBhbmVsOiBmdW5jdGlvbiggaWQgKSB7CgkJcmV0dXJuICQoICI8ZGl2PiIgKQoJCQkuYXR0ciggImlkIiwgaWQgKQoJCQkuZGF0YSggInVpLXRhYnMtZGVzdHJveSIsIHRydWUgKTsKCX0sCgoJX3NldE9wdGlvbkRpc2FibGVkOiBmdW5jdGlvbiggZGlzYWJsZWQgKSB7CgkJdmFyIGN1cnJlbnRJdGVtLCBsaSwgaTsKCgkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCWlmICggIWRpc2FibGVkLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIGRpc2FibGVkLmxlbmd0aCA9PT0gdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCgkJLy8gRGlzYWJsZSB0YWJzCgkJZm9yICggaSA9IDA7ICggbGkgPSB0aGlzLnRhYnNbIGkgXSApOyBpKysgKSB7CgkJCWN1cnJlbnRJdGVtID0gJCggbGkgKTsKCQkJaWYgKCBkaXNhYmxlZCA9PT0gdHJ1ZSB8fCAkLmluQXJyYXkoIGksIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJY3VycmVudEl0ZW0uYXR0ciggImFyaWEtZGlzYWJsZWQiLCAidHJ1ZSIgKTsKCQkJCXRoaXMuX2FkZENsYXNzKCBjdXJyZW50SXRlbSwgbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCQl9IGVsc2UgewoJCQkJY3VycmVudEl0ZW0ucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICk7CgkJCQl0aGlzLl9yZW1vdmVDbGFzcyggY3VycmVudEl0ZW0sIG51bGwsICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCQkJfQoJCX0KCgkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gZGlzYWJsZWQ7CgoJCXRoaXMuX3RvZ2dsZUNsYXNzKCB0aGlzLndpZGdldCgpLCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCIsIG51bGwsCgkJCWRpc2FibGVkID09PSB0cnVlICk7Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBldmVudHMgPSB7fTsKCQlpZiAoIGV2ZW50ICkgewoJCQkkLmVhY2goIGV2ZW50LnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGluZGV4LCBldmVudE5hbWUgKSB7CgkJCQlldmVudHNbIGV2ZW50TmFtZSBdID0gIl9ldmVudEhhbmRsZXIiOwoJCQl9ICk7CgkJfQoKCQl0aGlzLl9vZmYoIHRoaXMuYW5jaG9ycy5hZGQoIHRoaXMudGFicyApLmFkZCggdGhpcy5wYW5lbHMgKSApOwoKCQkvLyBBbHdheXMgcHJldmVudCB0aGUgZGVmYXVsdCBhY3Rpb24sIGV2ZW4gd2hlbiBkaXNhYmxlZAoJCXRoaXMuX29uKCB0cnVlLCB0aGlzLmFuY2hvcnMsIHsKCQkJY2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9ICk7CgkJdGhpcy5fb24oIHRoaXMuYW5jaG9ycywgZXZlbnRzICk7CgkJdGhpcy5fb24oIHRoaXMudGFicywgeyBrZXlkb3duOiAiX3RhYktleWRvd24iIH0gKTsKCQl0aGlzLl9vbiggdGhpcy5wYW5lbHMsIHsga2V5ZG93bjogIl9wYW5lbEtleWRvd24iIH0gKTsKCgkJdGhpcy5fZm9jdXNhYmxlKCB0aGlzLnRhYnMgKTsKCQl0aGlzLl9ob3ZlcmFibGUoIHRoaXMudGFicyApOwoJfSwKCglfc2V0dXBIZWlnaHRTdHlsZTogZnVuY3Rpb24oIGhlaWdodFN0eWxlICkgewoJCXZhciBtYXhIZWlnaHQsCgkJCXBhcmVudCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCgkJaWYgKCBoZWlnaHRTdHlsZSA9PT0gImZpbGwiICkgewoJCQltYXhIZWlnaHQgPSBwYXJlbnQuaGVpZ2h0KCk7CgkJCW1heEhlaWdodCAtPSB0aGlzLmVsZW1lbnQub3V0ZXJIZWlnaHQoKSAtIHRoaXMuZWxlbWVudC5oZWlnaHQoKTsKCgkJCXRoaXMuZWxlbWVudC5zaWJsaW5ncyggIjp2aXNpYmxlIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSAkKCB0aGlzICksCgkJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoKCQkJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJbWF4SGVpZ2h0IC09IGVsZW0ub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSApOwoKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCkubm90KCB0aGlzLnBhbmVscyApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJbWF4SGVpZ2h0IC09ICQoIHRoaXMgKS5vdXRlckhlaWdodCggdHJ1ZSApOwoJCQl9ICk7CgoJCQl0aGlzLnBhbmVscy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5oZWlnaHQoIE1hdGgubWF4KCAwLCBtYXhIZWlnaHQgLQoJCQkJCSQoIHRoaXMgKS5pbm5lckhlaWdodCgpICsgJCggdGhpcyApLmhlaWdodCgpICkgKTsKCQkJfSApCgkJCQkuY3NzKCAib3ZlcmZsb3ciLCAiYXV0byIgKTsKCQl9IGVsc2UgaWYgKCBoZWlnaHRTdHlsZSA9PT0gImF1dG8iICkgewoJCQltYXhIZWlnaHQgPSAwOwoJCQl0aGlzLnBhbmVscy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCA9IE1hdGgubWF4KCBtYXhIZWlnaHQsICQoIHRoaXMgKS5oZWlnaHQoICIiICkuaGVpZ2h0KCkgKTsKCQkJfSApLmhlaWdodCggbWF4SGVpZ2h0ICk7CgkJfQoJfSwKCglfZXZlbnRIYW5kbGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWFjdGl2ZSA9IHRoaXMuYWN0aXZlLAoJCQlhbmNob3IgPSAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksCgkJCXRhYiA9IGFuY2hvci5jbG9zZXN0KCAibGkiICksCgkJCWNsaWNrZWRJc0FjdGl2ZSA9IHRhYlsgMCBdID09PSBhY3RpdmVbIDAgXSwKCQkJY29sbGFwc2luZyA9IGNsaWNrZWRJc0FjdGl2ZSAmJiBvcHRpb25zLmNvbGxhcHNpYmxlLAoJCQl0b1Nob3cgPSBjb2xsYXBzaW5nID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRhYiApLAoJCQl0b0hpZGUgPSAhYWN0aXZlLmxlbmd0aCA/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCBhY3RpdmUgKSwKCQkJZXZlbnREYXRhID0gewoJCQkJb2xkVGFiOiBhY3RpdmUsCgkJCQlvbGRQYW5lbDogdG9IaWRlLAoJCQkJbmV3VGFiOiBjb2xsYXBzaW5nID8gJCgpIDogdGFiLAoJCQkJbmV3UGFuZWw6IHRvU2hvdwoJCQl9OwoKCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQlpZiAoIHRhYi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApIHx8CgoJCQkJLy8gdGFiIGlzIGFscmVhZHkgbG9hZGluZwoJCQkJdGFiLmhhc0NsYXNzKCAidWktdGFicy1sb2FkaW5nIiApIHx8CgoJCQkJLy8gY2FuJ3Qgc3dpdGNoIGR1cm5pbmcgYW4gYW5pbWF0aW9uCgkJCQl0aGlzLnJ1bm5pbmcgfHwKCgkJCQkvLyBjbGljayBvbiBhY3RpdmUgaGVhZGVyLCBidXQgbm90IGNvbGxhcHNpYmxlCgkJCQkoIGNsaWNrZWRJc0FjdGl2ZSAmJiAhb3B0aW9ucy5jb2xsYXBzaWJsZSApIHx8CgoJCQkJLy8gYWxsb3cgY2FuY2VsaW5nIGFjdGl2YXRpb24KCQkJCSggdGhpcy5fdHJpZ2dlciggImJlZm9yZUFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApID09PSBmYWxzZSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlvcHRpb25zLmFjdGl2ZSA9IGNvbGxhcHNpbmcgPyBmYWxzZSA6IHRoaXMudGFicy5pbmRleCggdGFiICk7CgoJCXRoaXMuYWN0aXZlID0gY2xpY2tlZElzQWN0aXZlID8gJCgpIDogdGFiOwoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQlpZiAoICF0b0hpZGUubGVuZ3RoICYmICF0b1Nob3cubGVuZ3RoICkgewoJCQkkLmVycm9yKCAialF1ZXJ5IFVJIFRhYnM6IE1pc21hdGNoaW5nIGZyYWdtZW50IGlkZW50aWZpZXIuIiApOwoJCX0KCgkJaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIHRoaXMudGFicy5pbmRleCggdGFiICksIGV2ZW50ICk7CgkJfQoJCXRoaXMuX3RvZ2dsZSggZXZlbnQsIGV2ZW50RGF0YSApOwoJfSwKCgkvLyBIYW5kbGVzIHNob3cvaGlkZSBmb3Igc2VsZWN0aW5nIHRhYnMKCV90b2dnbGU6IGZ1bmN0aW9uKCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJdG9TaG93ID0gZXZlbnREYXRhLm5ld1BhbmVsLAoJCQl0b0hpZGUgPSBldmVudERhdGEub2xkUGFuZWw7CgoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCWZ1bmN0aW9uIGNvbXBsZXRlKCkgewoJCQl0aGF0LnJ1bm5pbmcgPSBmYWxzZTsKCQkJdGhhdC5fdHJpZ2dlciggImFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCX0KCgkJZnVuY3Rpb24gc2hvdygpIHsKCQkJdGhhdC5fYWRkQ2xhc3MoIGV2ZW50RGF0YS5uZXdUYWIuY2xvc2VzdCggImxpIiApLCAidWktdGFicy1hY3RpdmUiLCAidWktc3RhdGUtYWN0aXZlIiApOwoKCQkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRoYXQub3B0aW9ucy5zaG93ICkgewoJCQkJdGhhdC5fc2hvdyggdG9TaG93LCB0aGF0Lm9wdGlvbnMuc2hvdywgY29tcGxldGUgKTsKCQkJfSBlbHNlIHsKCQkJCXRvU2hvdy5zaG93KCk7CgkJCQljb21wbGV0ZSgpOwoJCQl9CgkJfQoKCQkvLyBTdGFydCBvdXQgYnkgaGlkaW5nLCB0aGVuIHNob3dpbmcsIHRoZW4gY29tcGxldGluZwoJCWlmICggdG9IaWRlLmxlbmd0aCAmJiB0aGlzLm9wdGlvbnMuaGlkZSApIHsKCQkJdGhpcy5faGlkZSggdG9IaWRlLCB0aGlzLm9wdGlvbnMuaGlkZSwgZnVuY3Rpb24oKSB7CgkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggZXZlbnREYXRhLm9sZFRhYi5jbG9zZXN0KCAibGkiICksCgkJCQkJInVpLXRhYnMtYWN0aXZlIiwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCXNob3coKTsKCQkJfSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX3JlbW92ZUNsYXNzKCBldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKSwKCQkJCSJ1aS10YWJzLWFjdGl2ZSIsICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCXRvSGlkZS5oaWRlKCk7CgkJCXNob3coKTsKCQl9CgoJCXRvSGlkZS5hdHRyKCAiYXJpYS1oaWRkZW4iLCAidHJ1ZSIgKTsKCQlldmVudERhdGEub2xkVGFiLmF0dHIoIHsKCQkJImFyaWEtc2VsZWN0ZWQiOiAiZmFsc2UiLAoJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIKCQl9ICk7CgoJCS8vIElmIHdlJ3JlIHN3aXRjaGluZyB0YWJzLCByZW1vdmUgdGhlIG9sZCB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIG9wZW5pbmcgZnJvbSBjb2xsYXBzZWQgc3RhdGUsIHJlbW92ZSB0aGUgcHJldmlvdXMgdGFiIGZyb20gdGhlIHRhYiBvcmRlci4KCQkvLyBJZiB3ZSdyZSBjb2xsYXBzaW5nLCB0aGVuIGtlZXAgdGhlIGNvbGxhcHNpbmcgdGFiIGluIHRoZSB0YWIgb3JkZXIuCgkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRvSGlkZS5sZW5ndGggKSB7CgkJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggInRhYkluZGV4IiwgLTEgKTsKCQl9IGVsc2UgaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCB0aGlzICkuYXR0ciggInRhYkluZGV4IiApID09PSAwOwoJCQl9ICkKCQkJCS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0KCgkJdG9TaG93LmF0dHIoICJhcmlhLWhpZGRlbiIsICJmYWxzZSIgKTsKCQlldmVudERhdGEubmV3VGFiLmF0dHIoIHsKCQkJImFyaWEtc2VsZWN0ZWQiOiAidHJ1ZSIsCgkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLAoJCQl0YWJJbmRleDogMAoJCX0gKTsKCX0sCgoJX2FjdGl2YXRlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGFuY2hvciwKCQkJYWN0aXZlID0gdGhpcy5fZmluZEFjdGl2ZSggaW5kZXggKTsKCgkJLy8gVHJ5aW5nIHRvIGFjdGl2YXRlIHRoZSBhbHJlYWR5IGFjdGl2ZSBwYW5lbAoJCWlmICggYWN0aXZlWyAwIF0gPT09IHRoaXMuYWN0aXZlWyAwIF0gKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFRyeWluZyB0byBjb2xsYXBzZSwgc2ltdWxhdGUgYSBjbGljayBvbiB0aGUgY3VycmVudCBhY3RpdmUgaGVhZGVyCgkJaWYgKCAhYWN0aXZlLmxlbmd0aCApIHsKCQkJYWN0aXZlID0gdGhpcy5hY3RpdmU7CgkJfQoKCQlhbmNob3IgPSBhY3RpdmUuZmluZCggIi51aS10YWJzLWFuY2hvciIgKVsgMCBdOwoJCXRoaXMuX2V2ZW50SGFuZGxlciggewoJCQl0YXJnZXQ6IGFuY2hvciwKCQkJY3VycmVudFRhcmdldDogYW5jaG9yLAoJCQlwcmV2ZW50RGVmYXVsdDogJC5ub29wCgkJfSApOwoJfSwKCglfZmluZEFjdGl2ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXJldHVybiBpbmRleCA9PT0gZmFsc2UgPyAkKCkgOiB0aGlzLnRhYnMuZXEoIGluZGV4ICk7Cgl9LAoKCV9nZXRJbmRleDogZnVuY3Rpb24oIGluZGV4ICkgewoKCQkvLyBtZXRhLWZ1bmN0aW9uIHRvIGdpdmUgdXNlcnMgb3B0aW9uIHRvIHByb3ZpZGUgYSBocmVmIHN0cmluZyBpbnN0ZWFkIG9mIGEgbnVtZXJpY2FsIGluZGV4LgoJCWlmICggdHlwZW9mIGluZGV4ID09PSAic3RyaW5nIiApIHsKCQkJaW5kZXggPSB0aGlzLmFuY2hvcnMuaW5kZXgoIHRoaXMuYW5jaG9ycy5maWx0ZXIoICJbaHJlZiQ9JyIgKwoJCQkJJC51aS5lc2NhcGVTZWxlY3RvciggaW5kZXggKSArICInXSIgKSApOwoJCX0KCgkJcmV0dXJuIGluZGV4OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLnhociApIHsKCQkJdGhpcy54aHIuYWJvcnQoKTsKCQl9CgoJCXRoaXMudGFibGlzdAoJCQkucmVtb3ZlQXR0ciggInJvbGUiICkKCQkJLm9mZiggdGhpcy5ldmVudE5hbWVzcGFjZSApOwoKCQl0aGlzLmFuY2hvcnMKCQkJLnJlbW92ZUF0dHIoICJyb2xlIHRhYkluZGV4IiApCgkJCS5yZW1vdmVVbmlxdWVJZCgpOwoKCQl0aGlzLnRhYnMuYWRkKCB0aGlzLnBhbmVscyApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlpZiAoICQuZGF0YSggdGhpcywgInVpLXRhYnMtZGVzdHJveSIgKSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmUoKTsKCQkJfSBlbHNlIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmVBdHRyKCAicm9sZSB0YWJJbmRleCAiICsKCQkJCQkiYXJpYS1saXZlIGFyaWEtYnVzeSBhcmlhLXNlbGVjdGVkIGFyaWEtbGFiZWxsZWRieSBhcmlhLWhpZGRlbiBhcmlhLWV4cGFuZGVkIiApOwoJCQl9CgkJfSApOwoKCQl0aGlzLnRhYnMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBsaSA9ICQoIHRoaXMgKSwKCQkJCXByZXYgPSBsaS5kYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQlpZiAoIHByZXYgKSB7CgkJCQlsaQoJCQkJCS5hdHRyKCAiYXJpYS1jb250cm9scyIsIHByZXYgKQoJCQkJCS5yZW1vdmVEYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQl9IGVsc2UgewoJCQkJbGkucmVtb3ZlQXR0ciggImFyaWEtY29udHJvbHMiICk7CgkJCX0KCQl9ICk7CgoJCXRoaXMucGFuZWxzLnNob3coKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuaGVpZ2h0U3R5bGUgIT09ICJjb250ZW50IiApIHsKCQkJdGhpcy5wYW5lbHMuY3NzKCAiaGVpZ2h0IiwgIiIgKTsKCQl9Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBkaXNhYmxlZCA9IHRoaXMub3B0aW9ucy5kaXNhYmxlZDsKCQlpZiAoIGRpc2FibGVkID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBpbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQlkaXNhYmxlZCA9IGZhbHNlOwoJCX0gZWxzZSB7CgkJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJCWlmICggJC5pc0FycmF5KCBkaXNhYmxlZCApICkgewoJCQkJZGlzYWJsZWQgPSAkLm1hcCggZGlzYWJsZWQsIGZ1bmN0aW9uKCBudW0gKSB7CgkJCQkJcmV0dXJuIG51bSAhPT0gaW5kZXggPyBudW0gOiBudWxsOwoJCQkJfSApOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSAkLm1hcCggdGhpcy50YWJzLCBmdW5jdGlvbiggbGksIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9ICk7CgkJCX0KCQl9CgkJdGhpcy5fc2V0T3B0aW9uRGlzYWJsZWQoIGRpc2FibGVkICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgZGlzYWJsZWQgPSB0aGlzLm9wdGlvbnMuZGlzYWJsZWQ7CgkJaWYgKCBkaXNhYmxlZCA9PT0gdHJ1ZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBpbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQlkaXNhYmxlZCA9IHRydWU7CgkJfSBlbHNlIHsKCQkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsKCQkJaWYgKCAkLmluQXJyYXkoIGluZGV4LCBkaXNhYmxlZCApICE9PSAtMSApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJCWRpc2FibGVkID0gJC5tZXJnZSggWyBpbmRleCBdLCBkaXNhYmxlZCApLnNvcnQoKTsKCQkJfSBlbHNlIHsKCQkJCWRpc2FibGVkID0gWyBpbmRleCBdOwoJCQl9CgkJfQoJCXRoaXMuX3NldE9wdGlvbkRpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglsb2FkOiBmdW5jdGlvbiggaW5kZXgsIGV2ZW50ICkgewoJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQl0YWIgPSB0aGlzLnRhYnMuZXEoIGluZGV4ICksCgkJCWFuY2hvciA9IHRhYi5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApLAoJCQlwYW5lbCA9IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJZXZlbnREYXRhID0gewoJCQkJdGFiOiB0YWIsCgkJCQlwYW5lbDogcGFuZWwKCQkJfSwKCQkJY29tcGxldGUgPSBmdW5jdGlvbigganFYSFIsIHN0YXR1cyApIHsKCQkJCWlmICggc3RhdHVzID09PSAiYWJvcnQiICkgewoJCQkJCXRoYXQucGFuZWxzLnN0b3AoIGZhbHNlLCB0cnVlICk7CgkJCQl9CgoJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoIHRhYiwgInVpLXRhYnMtbG9hZGluZyIgKTsKCQkJCXBhbmVsLnJlbW92ZUF0dHIoICJhcmlhLWJ1c3kiICk7CgoJCQkJaWYgKCBqcVhIUiA9PT0gdGhhdC54aHIgKSB7CgkJCQkJZGVsZXRlIHRoYXQueGhyOwoJCQkJfQoJCQl9OwoKCQkvLyBOb3QgcmVtb3RlCgkJaWYgKCB0aGlzLl9pc0xvY2FsKCBhbmNob3JbIDAgXSApICkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLnhociA9ICQuYWpheCggdGhpcy5fYWpheFNldHRpbmdzKCBhbmNob3IsIGV2ZW50LCBldmVudERhdGEgKSApOwoKCQkvLyBTdXBwb3J0OiBqUXVlcnkgPDEuOAoJCS8vIGpRdWVyeSA8MS44IHJldHVybnMgZmFsc2UgaWYgdGhlIHJlcXVlc3QgaXMgY2FuY2VsZWQgaW4gYmVmb3JlU2VuZCwKCQkvLyBidXQgYXMgb2YgMS44LCAkLmFqYXgoKSBhbHdheXMgcmV0dXJucyBhIGpxWEhSIG9iamVjdC4KCQlpZiAoIHRoaXMueGhyICYmIHRoaXMueGhyLnN0YXR1c1RleHQgIT09ICJjYW5jZWxlZCIgKSB7CgkJCXRoaXMuX2FkZENsYXNzKCB0YWIsICJ1aS10YWJzLWxvYWRpbmciICk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWJ1c3kiLCAidHJ1ZSIgKTsKCgkJCXRoaXMueGhyCgkJCQkuZG9uZSggZnVuY3Rpb24oIHJlc3BvbnNlLCBzdGF0dXMsIGpxWEhSICkgewoKCQkJCQkvLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAoJCQkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzExNzc4CgkJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCXBhbmVsLmh0bWwoIHJlc3BvbnNlICk7CgkJCQkJCXRoYXQuX3RyaWdnZXIoICJsb2FkIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoKCQkJCQkJY29tcGxldGUoIGpxWEhSLCBzdGF0dXMgKTsKCQkJCQl9LCAxICk7CgkJCQl9ICkKCQkJCS5mYWlsKCBmdW5jdGlvbigganFYSFIsIHN0YXR1cyApIHsKCgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQljb21wbGV0ZSgganFYSFIsIHN0YXR1cyApOwoJCQkJCX0sIDEgKTsKCQkJCX0gKTsKCQl9Cgl9LAoKCV9hamF4U2V0dGluZ3M6IGZ1bmN0aW9uKCBhbmNob3IsIGV2ZW50LCBldmVudERhdGEgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoJCXJldHVybiB7CgoJCQkvLyBTdXBwb3J0OiBJRSA8MTEgb25seQoJCQkvLyBTdHJpcCBhbnkgaGFzaCB0aGF0IGV4aXN0cyB0byBwcmV2ZW50IGVycm9ycyB3aXRoIHRoZSBBamF4IHJlcXVlc3QKCQkJdXJsOiBhbmNob3IuYXR0ciggImhyZWYiICkucmVwbGFjZSggLyMuKiQvLCAiIiApLAoJCQliZWZvcmVTZW5kOiBmdW5jdGlvbigganFYSFIsIHNldHRpbmdzICkgewoJCQkJcmV0dXJuIHRoYXQuX3RyaWdnZXIoICJiZWZvcmVMb2FkIiwgZXZlbnQsCgkJCQkJJC5leHRlbmQoIHsganFYSFI6IGpxWEhSLCBhamF4U2V0dGluZ3M6IHNldHRpbmdzIH0sIGV2ZW50RGF0YSApICk7CgkJCX0KCQl9OwoJfSwKCglfZ2V0UGFuZWxGb3JUYWI6IGZ1bmN0aW9uKCB0YWIgKSB7CgkJdmFyIGlkID0gJCggdGFiICkuYXR0ciggImFyaWEtY29udHJvbHMiICk7CgkJcmV0dXJuIHRoaXMuZWxlbWVudC5maW5kKCB0aGlzLl9zYW5pdGl6ZVNlbGVjdG9yKCAiIyIgKyBpZCApICk7Cgl9Cn0gKTsKCi8vIERFUFJFQ0FURUQKLy8gVE9ETzogU3dpdGNoIHJldHVybiBiYWNrIHRvIHdpZGdldCBkZWNsYXJhdGlvbiBhdCB0b3Agb2YgZmlsZSB3aGVuIHRoaXMgaXMgcmVtb3ZlZAppZiAoICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSApIHsKCgkvLyBCYWNrY29tcGF0IGZvciB1aS10YWIgY2xhc3MgKG5vdyB1aS10YWJzLXRhYikKCSQud2lkZ2V0KCAidWkudGFicyIsICQudWkudGFicywgewoJCV9wcm9jZXNzVGFiczogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOwoJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy50YWJzLCAidWktdGFiIiApOwoJCX0KCX0gKTsKfQoKdmFyIHdpZGdldHNUYWJzID0gJC51aS50YWJzOwoKCi8qIQogKiBqUXVlcnkgVUkgVG9vbHRpcCAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFRvb2x0aXAKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vPj5kZXNjcmlwdGlvbjogU2hvd3MgYWRkaXRpb25hbCBpbmZvcm1hdGlvbiBmb3IgYW55IGVsZW1lbnQgb24gaG92ZXIgb3IgZm9jdXMuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS90b29sdGlwLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vdG9vbHRpcC8KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS90b29sdGlwLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKJC53aWRnZXQoICJ1aS50b29sdGlwIiwgewoJdmVyc2lvbjogIjEuMTIuMSIsCglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQkidWktdG9vbHRpcCI6ICJ1aS1jb3JuZXItYWxsIHVpLXdpZGdldC1zaGFkb3ciCgkJfSwKCQljb250ZW50OiBmdW5jdGlvbigpIHsKCgkJCS8vIHN1cHBvcnQ6IElFPDksIE9wZXJhIGluIGpRdWVyeSA8MS43CgkJCS8vIC50ZXh0KCkgY2FuJ3QgYWNjZXB0IHVuZGVmaW5lZCwgc28gY29lcmNlIHRvIGEgc3RyaW5nCgkJCXZhciB0aXRsZSA9ICQoIHRoaXMgKS5hdHRyKCAidGl0bGUiICkgfHwgIiI7CgoJCQkvLyBFc2NhcGUgdGl0bGUsIHNpbmNlIHdlJ3JlIGdvaW5nIGZyb20gYW4gYXR0cmlidXRlIHRvIHJhdyBIVE1MCgkJCXJldHVybiAkKCAiPGE+IiApLnRleHQoIHRpdGxlICkuaHRtbCgpOwoJCX0sCgkJaGlkZTogdHJ1ZSwKCgkJLy8gRGlzYWJsZWQgZWxlbWVudHMgaGF2ZSBpbmNvbnNpc3RlbnQgYmVoYXZpb3IgYWNyb3NzIGJyb3dzZXJzICgjODY2MSkKCQlpdGVtczogIlt0aXRsZV06bm90KFtkaXNhYmxlZF0pIiwKCQlwb3NpdGlvbjogewoJCQlteTogImxlZnQgdG9wKzE1IiwKCQkJYXQ6ICJsZWZ0IGJvdHRvbSIsCgkJCWNvbGxpc2lvbjogImZsaXBmaXQgZmxpcCIKCQl9LAoJCXNob3c6IHRydWUsCgkJdHJhY2s6IGZhbHNlLAoKCQkvLyBDYWxsYmFja3MKCQljbG9zZTogbnVsbCwKCQlvcGVuOiBudWxsCgl9LAoKCV9hZGREZXNjcmliZWRCeTogZnVuY3Rpb24oIGVsZW0sIGlkICkgewoJCXZhciBkZXNjcmliZWRieSA9ICggZWxlbS5hdHRyKCAiYXJpYS1kZXNjcmliZWRieSIgKSB8fCAiIiApLnNwbGl0KCAvXHMrLyApOwoJCWRlc2NyaWJlZGJ5LnB1c2goIGlkICk7CgkJZWxlbQoJCQkuZGF0YSggInVpLXRvb2x0aXAtaWQiLCBpZCApCgkJCS5hdHRyKCAiYXJpYS1kZXNjcmliZWRieSIsICQudHJpbSggZGVzY3JpYmVkYnkuam9pbiggIiAiICkgKSApOwoJfSwKCglfcmVtb3ZlRGVzY3JpYmVkQnk6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBpZCA9IGVsZW0uZGF0YSggInVpLXRvb2x0aXAtaWQiICksCgkJCWRlc2NyaWJlZGJ5ID0gKCBlbGVtLmF0dHIoICJhcmlhLWRlc2NyaWJlZGJ5IiApIHx8ICIiICkuc3BsaXQoIC9ccysvICksCgkJCWluZGV4ID0gJC5pbkFycmF5KCBpZCwgZGVzY3JpYmVkYnkgKTsKCgkJaWYgKCBpbmRleCAhPT0gLTEgKSB7CgkJCWRlc2NyaWJlZGJ5LnNwbGljZSggaW5kZXgsIDEgKTsKCQl9CgoJCWVsZW0ucmVtb3ZlRGF0YSggInVpLXRvb2x0aXAtaWQiICk7CgkJZGVzY3JpYmVkYnkgPSAkLnRyaW0oIGRlc2NyaWJlZGJ5LmpvaW4oICIgIiApICk7CgkJaWYgKCBkZXNjcmliZWRieSApIHsKCQkJZWxlbS5hdHRyKCAiYXJpYS1kZXNjcmliZWRieSIsIGRlc2NyaWJlZGJ5ICk7CgkJfSBlbHNlIHsKCQkJZWxlbS5yZW1vdmVBdHRyKCAiYXJpYS1kZXNjcmliZWRieSIgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCB7CgkJCW1vdXNlb3ZlcjogIm9wZW4iLAoJCQlmb2N1c2luOiAib3BlbiIKCQl9ICk7CgoJCS8vIElEcyBvZiBnZW5lcmF0ZWQgdG9vbHRpcHMsIG5lZWRlZCBmb3IgZGVzdHJveQoJCXRoaXMudG9vbHRpcHMgPSB7fTsKCgkJLy8gSURzIG9mIHBhcmVudCB0b29sdGlwcyB3aGVyZSB3ZSByZW1vdmVkIHRoZSB0aXRsZSBhdHRyaWJ1dGUKCQl0aGlzLnBhcmVudHMgPSB7fTsKCgkJLy8gQXBwZW5kIHRoZSBhcmlhLWxpdmUgcmVnaW9uIHNvIHRvb2x0aXBzIGFubm91bmNlIGNvcnJlY3RseQoJCXRoaXMubGl2ZVJlZ2lvbiA9ICQoICI8ZGl2PiIgKQoJCQkuYXR0ciggewoJCQkJcm9sZTogImxvZyIsCgkJCQkiYXJpYS1saXZlIjogImFzc2VydGl2ZSIsCgkJCQkiYXJpYS1yZWxldmFudCI6ICJhZGRpdGlvbnMiCgkJCX0gKQoJCQkuYXBwZW5kVG8oIHRoaXMuZG9jdW1lbnRbIDAgXS5ib2R5ICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMubGl2ZVJlZ2lvbiwgbnVsbCwgInVpLWhlbHBlci1oaWRkZW4tYWNjZXNzaWJsZSIgKTsKCgkJdGhpcy5kaXNhYmxlZFRpdGxlcyA9ICQoIFtdICk7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCgkJaWYgKCBrZXkgPT09ICJjb250ZW50IiApIHsKCQkJJC5lYWNoKCB0aGlzLnRvb2x0aXBzLCBmdW5jdGlvbiggaWQsIHRvb2x0aXBEYXRhICkgewoJCQkJdGhhdC5fdXBkYXRlQ29udGVudCggdG9vbHRpcERhdGEuZWxlbWVudCApOwoJCQl9ICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzWyB2YWx1ZSA/ICJfZGlzYWJsZSIgOiAiX2VuYWJsZSIgXSgpOwoJfSwKCglfZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQkvLyBDbG9zZSBvcGVuIHRvb2x0aXBzCgkJJC5lYWNoKCB0aGlzLnRvb2x0aXBzLCBmdW5jdGlvbiggaWQsIHRvb2x0aXBEYXRhICkgewoJCQl2YXIgZXZlbnQgPSAkLkV2ZW50KCAiYmx1ciIgKTsKCQkJZXZlbnQudGFyZ2V0ID0gZXZlbnQuY3VycmVudFRhcmdldCA9IHRvb2x0aXBEYXRhLmVsZW1lbnRbIDAgXTsKCQkJdGhhdC5jbG9zZSggZXZlbnQsIHRydWUgKTsKCQl9ICk7CgoJCS8vIFJlbW92ZSB0aXRsZSBhdHRyaWJ1dGVzIHRvIHByZXZlbnQgbmF0aXZlIHRvb2x0aXBzCgkJdGhpcy5kaXNhYmxlZFRpdGxlcyA9IHRoaXMuZGlzYWJsZWRUaXRsZXMuYWRkKAoJCQl0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zICkuYWRkQmFjaygpCgkJCQkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgZWxlbWVudCA9ICQoIHRoaXMgKTsKCQkJCQlpZiAoIGVsZW1lbnQuaXMoICJbdGl0bGVdIiApICkgewoJCQkJCQlyZXR1cm4gZWxlbWVudAoJCQkJCQkJLmRhdGEoICJ1aS10b29sdGlwLXRpdGxlIiwgZWxlbWVudC5hdHRyKCAidGl0bGUiICkgKQoJCQkJCQkJLnJlbW92ZUF0dHIoICJ0aXRsZSIgKTsKCQkJCQl9CgkJCQl9ICkKCQkpOwoJfSwKCglfZW5hYmxlOiBmdW5jdGlvbigpIHsKCgkJLy8gcmVzdG9yZSB0aXRsZSBhdHRyaWJ1dGVzCgkJdGhpcy5kaXNhYmxlZFRpdGxlcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICk7CgkJCWlmICggZWxlbWVudC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApIHsKCQkJCWVsZW1lbnQuYXR0ciggInRpdGxlIiwgZWxlbWVudC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApOwoJCQl9CgkJfSApOwoJCXRoaXMuZGlzYWJsZWRUaXRsZXMgPSAkKCBbXSApOwoJfSwKCglvcGVuOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQl0YXJnZXQgPSAkKCBldmVudCA/IGV2ZW50LnRhcmdldCA6IHRoaXMuZWxlbWVudCApCgoJCQkJLy8gd2UgbmVlZCBjbG9zZXN0IGhlcmUgZHVlIHRvIG1vdXNlb3ZlciBidWJibGluZywKCQkJCS8vIGJ1dCBhbHdheXMgcG9pbnRpbmcgYXQgdGhlIHNhbWUgZXZlbnQgdGFyZ2V0CgkJCQkuY2xvc2VzdCggdGhpcy5vcHRpb25zLml0ZW1zICk7CgoJCS8vIE5vIGVsZW1lbnQgdG8gc2hvdyBhIHRvb2x0aXAgZm9yIG9yIHRoZSB0b29sdGlwIGlzIGFscmVhZHkgb3BlbgoJCWlmICggIXRhcmdldC5sZW5ndGggfHwgdGFyZ2V0LmRhdGEoICJ1aS10b29sdGlwLWlkIiApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRhcmdldC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCXRhcmdldC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIsIHRhcmdldC5hdHRyKCAidGl0bGUiICkgKTsKCQl9CgoJCXRhcmdldC5kYXRhKCAidWktdG9vbHRpcC1vcGVuIiwgdHJ1ZSApOwoKCQkvLyBLaWxsIHBhcmVudCB0b29sdGlwcywgY3VzdG9tIG9yIG5hdGl2ZSwgZm9yIGhvdmVyCgkJaWYgKCBldmVudCAmJiBldmVudC50eXBlID09PSAibW91c2VvdmVyIiApIHsKCQkJdGFyZ2V0LnBhcmVudHMoKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBwYXJlbnQgPSAkKCB0aGlzICksCgkJCQkJYmx1ckV2ZW50OwoJCQkJaWYgKCBwYXJlbnQuZGF0YSggInVpLXRvb2x0aXAtb3BlbiIgKSApIHsKCQkJCQlibHVyRXZlbnQgPSAkLkV2ZW50KCAiYmx1ciIgKTsKCQkJCQlibHVyRXZlbnQudGFyZ2V0ID0gYmx1ckV2ZW50LmN1cnJlbnRUYXJnZXQgPSB0aGlzOwoJCQkJCXRoYXQuY2xvc2UoIGJsdXJFdmVudCwgdHJ1ZSApOwoJCQkJfQoJCQkJaWYgKCBwYXJlbnQuYXR0ciggInRpdGxlIiApICkgewoJCQkJCXBhcmVudC51bmlxdWVJZCgpOwoJCQkJCXRoYXQucGFyZW50c1sgdGhpcy5pZCBdID0gewoJCQkJCQllbGVtZW50OiB0aGlzLAoJCQkJCQl0aXRsZTogcGFyZW50LmF0dHIoICJ0aXRsZSIgKQoJCQkJCX07CgkJCQkJcGFyZW50LmF0dHIoICJ0aXRsZSIsICIiICk7CgkJCQl9CgkJCX0gKTsKCQl9CgoJCXRoaXMuX3JlZ2lzdGVyQ2xvc2VIYW5kbGVycyggZXZlbnQsIHRhcmdldCApOwoJCXRoaXMuX3VwZGF0ZUNvbnRlbnQoIHRhcmdldCwgZXZlbnQgKTsKCX0sCgoJX3VwZGF0ZUNvbnRlbnQ6IGZ1bmN0aW9uKCB0YXJnZXQsIGV2ZW50ICkgewoJCXZhciBjb250ZW50LAoJCQljb250ZW50T3B0aW9uID0gdGhpcy5vcHRpb25zLmNvbnRlbnQsCgkJCXRoYXQgPSB0aGlzLAoJCQlldmVudFR5cGUgPSBldmVudCA/IGV2ZW50LnR5cGUgOiBudWxsOwoKCQlpZiAoIHR5cGVvZiBjb250ZW50T3B0aW9uID09PSAic3RyaW5nIiB8fCBjb250ZW50T3B0aW9uLm5vZGVUeXBlIHx8CgkJCQljb250ZW50T3B0aW9uLmpxdWVyeSApIHsKCQkJcmV0dXJuIHRoaXMuX29wZW4oIGV2ZW50LCB0YXJnZXQsIGNvbnRlbnRPcHRpb24gKTsKCQl9CgoJCWNvbnRlbnQgPSBjb250ZW50T3B0aW9uLmNhbGwoIHRhcmdldFsgMCBdLCBmdW5jdGlvbiggcmVzcG9uc2UgKSB7CgoJCQkvLyBJRSBtYXkgaW5zdGFudGx5IHNlcnZlIGEgY2FjaGVkIHJlc3BvbnNlIGZvciBhamF4IHJlcXVlc3RzCgkJCS8vIGRlbGF5IHRoaXMgY2FsbCB0byBfb3BlbiBzbyB0aGUgb3RoZXIgY2FsbCB0byBfb3BlbiBydW5zIGZpcnN0CgkJCXRoYXQuX2RlbGF5KCBmdW5jdGlvbigpIHsKCgkJCQkvLyBJZ25vcmUgYXN5bmMgcmVzcG9uc2UgaWYgdG9vbHRpcCB3YXMgY2xvc2VkIGFscmVhZHkKCQkJCWlmICggIXRhcmdldC5kYXRhKCAidWktdG9vbHRpcC1vcGVuIiApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBKUXVlcnkgY3JlYXRlcyBhIHNwZWNpYWwgZXZlbnQgZm9yIGZvY3VzaW4gd2hlbiBpdCBkb2Vzbid0CgkJCQkvLyBleGlzdCBuYXRpdmVseS4gVG8gaW1wcm92ZSBwZXJmb3JtYW5jZSwgdGhlIG5hdGl2ZSBldmVudAoJCQkJLy8gb2JqZWN0IGlzIHJldXNlZCBhbmQgdGhlIHR5cGUgaXMgY2hhbmdlZC4gVGhlcmVmb3JlLCB3ZSBjYW4ndAoJCQkJLy8gcmVseSBvbiB0aGUgdHlwZSBiZWluZyBjb3JyZWN0IGFmdGVyIHRoZSBldmVudCBmaW5pc2hlZAoJCQkJLy8gYnViYmxpbmcsIHNvIHdlIHNldCBpdCBiYWNrIHRvIHRoZSBwcmV2aW91cyB2YWx1ZS4gKCM4NzQwKQoJCQkJaWYgKCBldmVudCApIHsKCQkJCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCQkJfQoJCQkJdGhpcy5fb3BlbiggZXZlbnQsIHRhcmdldCwgcmVzcG9uc2UgKTsKCQkJfSApOwoJCX0gKTsKCQlpZiAoIGNvbnRlbnQgKSB7CgkJCXRoaXMuX29wZW4oIGV2ZW50LCB0YXJnZXQsIGNvbnRlbnQgKTsKCQl9Cgl9LAoKCV9vcGVuOiBmdW5jdGlvbiggZXZlbnQsIHRhcmdldCwgY29udGVudCApIHsKCQl2YXIgdG9vbHRpcERhdGEsIHRvb2x0aXAsIGRlbGF5ZWRTaG93LCBhMTF5Q29udGVudCwKCQkJcG9zaXRpb25PcHRpb24gPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucy5wb3NpdGlvbiApOwoKCQlpZiAoICFjb250ZW50ICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBDb250ZW50IGNhbiBiZSB1cGRhdGVkIG11bHRpcGxlIHRpbWVzLiBJZiB0aGUgdG9vbHRpcCBhbHJlYWR5CgkJLy8gZXhpc3RzLCB0aGVuIGp1c3QgdXBkYXRlIHRoZSBjb250ZW50IGFuZCBiYWlsLgoJCXRvb2x0aXBEYXRhID0gdGhpcy5fZmluZCggdGFyZ2V0ICk7CgkJaWYgKCB0b29sdGlwRGF0YSApIHsKCQkJdG9vbHRpcERhdGEudG9vbHRpcC5maW5kKCAiLnVpLXRvb2x0aXAtY29udGVudCIgKS5odG1sKCBjb250ZW50ICk7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHdlIGhhdmUgYSB0aXRsZSwgY2xlYXIgaXQgdG8gcHJldmVudCB0aGUgbmF0aXZlIHRvb2x0aXAKCQkvLyB3ZSBoYXZlIHRvIGNoZWNrIGZpcnN0IHRvIGF2b2lkIGRlZmluaW5nIGEgdGl0bGUgaWYgbm9uZSBleGlzdHMKCQkvLyAod2UgZG9uJ3Qgd2FudCB0byBjYXVzZSBhbiBlbGVtZW50IHRvIHN0YXJ0IG1hdGNoaW5nIFt0aXRsZV0pCgkJLy8KCQkvLyBXZSB1c2UgcmVtb3ZlQXR0ciBvbmx5IGZvciBrZXkgZXZlbnRzLCB0byBhbGxvdyBJRSB0byBleHBvcnQgdGhlIGNvcnJlY3QKCQkvLyBhY2Nlc3NpYmxlIGF0dHJpYnV0ZXMuIEZvciBtb3VzZSBldmVudHMsIHNldCB0byBlbXB0eSBzdHJpbmcgdG8gYXZvaWQKCQkvLyBuYXRpdmUgdG9vbHRpcCBzaG93aW5nIHVwIChoYXBwZW5zIG9ubHkgd2hlbiByZW1vdmluZyBpbnNpZGUgbW91c2VvdmVyKS4KCQlpZiAoIHRhcmdldC5pcyggIlt0aXRsZV0iICkgKSB7CgkJCWlmICggZXZlbnQgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlb3ZlciIgKSB7CgkJCQl0YXJnZXQuYXR0ciggInRpdGxlIiwgIiIgKTsKCQkJfSBlbHNlIHsKCQkJCXRhcmdldC5yZW1vdmVBdHRyKCAidGl0bGUiICk7CgkJCX0KCQl9CgoJCXRvb2x0aXBEYXRhID0gdGhpcy5fdG9vbHRpcCggdGFyZ2V0ICk7CgkJdG9vbHRpcCA9IHRvb2x0aXBEYXRhLnRvb2x0aXA7CgkJdGhpcy5fYWRkRGVzY3JpYmVkQnkoIHRhcmdldCwgdG9vbHRpcC5hdHRyKCAiaWQiICkgKTsKCQl0b29sdGlwLmZpbmQoICIudWktdG9vbHRpcC1jb250ZW50IiApLmh0bWwoIGNvbnRlbnQgKTsKCgkJLy8gU3VwcG9ydDogVm9pY2VvdmVyIG9uIE9TIFgsIEpBV1Mgb24gSUUgPD0gOQoJCS8vIEpBV1MgYW5ub3VuY2VzIGRlbGV0aW9ucyBldmVuIHdoZW4gYXJpYS1yZWxldmFudD0iYWRkaXRpb25zIgoJCS8vIFZvaWNlb3ZlciB3aWxsIHNvbWV0aW1lcyByZS1yZWFkIHRoZSBlbnRpcmUgbG9nIHJlZ2lvbidzIGNvbnRlbnRzIGZyb20gdGhlIGJlZ2lubmluZwoJCXRoaXMubGl2ZVJlZ2lvbi5jaGlsZHJlbigpLmhpZGUoKTsKCQlhMTF5Q29udGVudCA9ICQoICI8ZGl2PiIgKS5odG1sKCB0b29sdGlwLmZpbmQoICIudWktdG9vbHRpcC1jb250ZW50IiApLmh0bWwoKSApOwoJCWExMXlDb250ZW50LnJlbW92ZUF0dHIoICJuYW1lIiApLmZpbmQoICJbbmFtZV0iICkucmVtb3ZlQXR0ciggIm5hbWUiICk7CgkJYTExeUNvbnRlbnQucmVtb3ZlQXR0ciggImlkIiApLmZpbmQoICJbaWRdIiApLnJlbW92ZUF0dHIoICJpZCIgKTsKCQlhMTF5Q29udGVudC5hcHBlbmRUbyggdGhpcy5saXZlUmVnaW9uICk7CgoJCWZ1bmN0aW9uIHBvc2l0aW9uKCBldmVudCApIHsKCQkJcG9zaXRpb25PcHRpb24ub2YgPSBldmVudDsKCQkJaWYgKCB0b29sdGlwLmlzKCAiOmhpZGRlbiIgKSApIHsKCQkJCXJldHVybjsKCQkJfQoJCQl0b29sdGlwLnBvc2l0aW9uKCBwb3NpdGlvbk9wdGlvbiApOwoJCX0KCQlpZiAoIHRoaXMub3B0aW9ucy50cmFjayAmJiBldmVudCAmJiAvXm1vdXNlLy50ZXN0KCBldmVudC50eXBlICkgKSB7CgkJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCQltb3VzZW1vdmU6IHBvc2l0aW9uCgkJCX0gKTsKCgkJCS8vIHRyaWdnZXIgb25jZSB0byBvdmVycmlkZSBlbGVtZW50LXJlbGF0aXZlIHBvc2l0aW9uaW5nCgkJCXBvc2l0aW9uKCBldmVudCApOwoJCX0gZWxzZSB7CgkJCXRvb2x0aXAucG9zaXRpb24oICQuZXh0ZW5kKCB7CgkJCQlvZjogdGFyZ2V0CgkJCX0sIHRoaXMub3B0aW9ucy5wb3NpdGlvbiApICk7CgkJfQoKCQl0b29sdGlwLmhpZGUoKTsKCgkJdGhpcy5fc2hvdyggdG9vbHRpcCwgdGhpcy5vcHRpb25zLnNob3cgKTsKCgkJLy8gSGFuZGxlIHRyYWNraW5nIHRvb2x0aXBzIHRoYXQgYXJlIHNob3duIHdpdGggYSBkZWxheSAoIzg2NDQpLiBBcyBzb29uCgkJLy8gYXMgdGhlIHRvb2x0aXAgaXMgdmlzaWJsZSwgcG9zaXRpb24gdGhlIHRvb2x0aXAgdXNpbmcgdGhlIG1vc3QgcmVjZW50CgkJLy8gZXZlbnQuCgkJLy8gQWRkcyB0aGUgY2hlY2sgdG8gYWRkIHRoZSB0aW1lcnMgb25seSB3aGVuIGJvdGggZGVsYXkgYW5kIHRyYWNrIG9wdGlvbnMgYXJlIHNldCAoIzE0NjgyKQoJCWlmICggdGhpcy5vcHRpb25zLnRyYWNrICYmIHRoaXMub3B0aW9ucy5zaG93ICYmIHRoaXMub3B0aW9ucy5zaG93LmRlbGF5ICkgewoJCQlkZWxheWVkU2hvdyA9IHRoaXMuZGVsYXllZFNob3cgPSBzZXRJbnRlcnZhbCggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRvb2x0aXAuaXMoICI6dmlzaWJsZSIgKSApIHsKCQkJCQlwb3NpdGlvbiggcG9zaXRpb25PcHRpb24ub2YgKTsKCQkJCQljbGVhckludGVydmFsKCBkZWxheWVkU2hvdyApOwoJCQkJfQoJCQl9LCAkLmZ4LmludGVydmFsICk7CgkJfQoKCQl0aGlzLl90cmlnZ2VyKCAib3BlbiIsIGV2ZW50LCB7IHRvb2x0aXA6IHRvb2x0aXAgfSApOwoJfSwKCglfcmVnaXN0ZXJDbG9zZUhhbmRsZXJzOiBmdW5jdGlvbiggZXZlbnQsIHRhcmdldCApIHsKCQl2YXIgZXZlbnRzID0gewoJCQlrZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuRVNDQVBFICkgewoJCQkJCXZhciBmYWtlRXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCQkJCWZha2VFdmVudC5jdXJyZW50VGFyZ2V0ID0gdGFyZ2V0WyAwIF07CgkJCQkJdGhpcy5jbG9zZSggZmFrZUV2ZW50LCB0cnVlICk7CgkJCQl9CgkJCX0KCQl9OwoKCQkvLyBPbmx5IGJpbmQgcmVtb3ZlIGhhbmRsZXIgZm9yIGRlbGVnYXRlZCB0YXJnZXRzLiBOb24tZGVsZWdhdGVkCgkJLy8gdG9vbHRpcHMgd2lsbCBoYW5kbGUgdGhpcyBpbiBkZXN0cm95LgoJCWlmICggdGFyZ2V0WyAwIF0gIT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQlldmVudHMucmVtb3ZlID0gZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9yZW1vdmVUb29sdGlwKCB0aGlzLl9maW5kKCB0YXJnZXQgKS50b29sdGlwICk7CgkJCX07CgkJfQoKCQlpZiAoICFldmVudCB8fCBldmVudC50eXBlID09PSAibW91c2VvdmVyIiApIHsKCQkJZXZlbnRzLm1vdXNlbGVhdmUgPSAiY2xvc2UiOwoJCX0KCQlpZiAoICFldmVudCB8fCBldmVudC50eXBlID09PSAiZm9jdXNpbiIgKSB7CgkJCWV2ZW50cy5mb2N1c291dCA9ICJjbG9zZSI7CgkJfQoJCXRoaXMuX29uKCB0cnVlLCB0YXJnZXQsIGV2ZW50cyApOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciB0b29sdGlwLAoJCQl0aGF0ID0gdGhpcywKCQkJdGFyZ2V0ID0gJCggZXZlbnQgPyBldmVudC5jdXJyZW50VGFyZ2V0IDogdGhpcy5lbGVtZW50ICksCgkJCXRvb2x0aXBEYXRhID0gdGhpcy5fZmluZCggdGFyZ2V0ICk7CgoJCS8vIFRoZSB0b29sdGlwIG1heSBhbHJlYWR5IGJlIGNsb3NlZAoJCWlmICggIXRvb2x0aXBEYXRhICkgewoKCQkJLy8gV2Ugc2V0IHVpLXRvb2x0aXAtb3BlbiBpbW1lZGlhdGVseSB1cG9uIG9wZW4gKGluIG9wZW4oKSksIGJ1dCBvbmx5IHNldCB0aGUKCQkJLy8gYWRkaXRpb25hbCBkYXRhIG9uY2UgdGhlcmUncyBhY3R1YWxseSBjb250ZW50IHRvIHNob3cgKGluIF9vcGVuKCkpLiBTbyBldmVuIGlmIHRoZQoJCQkvLyB0b29sdGlwIGRvZXNuJ3QgaGF2ZSBmdWxsIGRhdGEsIHdlIGFsd2F5cyByZW1vdmUgdWktdG9vbHRpcC1vcGVuIGluIGNhc2Ugd2UncmUgaW4KCQkJLy8gdGhlIHBlcmlvZCBiZXR3ZWVuIG9wZW4oKSBhbmQgX29wZW4oKS4KCQkJdGFyZ2V0LnJlbW92ZURhdGEoICJ1aS10b29sdGlwLW9wZW4iICk7CgkJCXJldHVybjsKCQl9CgoJCXRvb2x0aXAgPSB0b29sdGlwRGF0YS50b29sdGlwOwoKCQkvLyBEaXNhYmxpbmcgY2xvc2VzIHRoZSB0b29sdGlwLCBzbyB3ZSBuZWVkIHRvIHRyYWNrIHdoZW4gd2UncmUgY2xvc2luZwoJCS8vIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AgaW4gY2FzZSB0aGUgdG9vbHRpcCBiZWNvbWVzIGRpc2FibGVkIG9uIGNsb3NlCgkJaWYgKCB0b29sdGlwRGF0YS5jbG9zaW5nICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBDbGVhciB0aGUgaW50ZXJ2YWwgZm9yIGRlbGF5ZWQgdHJhY2tpbmcgdG9vbHRpcHMKCQljbGVhckludGVydmFsKCB0aGlzLmRlbGF5ZWRTaG93ICk7CgoJCS8vIE9ubHkgc2V0IHRpdGxlIGlmIHdlIGhhZCBvbmUgYmVmb3JlIChzZWUgY29tbWVudCBpbiBfb3BlbigpKQoJCS8vIElmIHRoZSB0aXRsZSBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQgc2luY2Ugb3BlbigpLCBkb24ndCByZXN0b3JlCgkJaWYgKCB0YXJnZXQuZGF0YSggInVpLXRvb2x0aXAtdGl0bGUiICkgJiYgIXRhcmdldC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCXRhcmdldC5hdHRyKCAidGl0bGUiLCB0YXJnZXQuZGF0YSggInVpLXRvb2x0aXAtdGl0bGUiICkgKTsKCQl9CgoJCXRoaXMuX3JlbW92ZURlc2NyaWJlZEJ5KCB0YXJnZXQgKTsKCgkJdG9vbHRpcERhdGEuaGlkaW5nID0gdHJ1ZTsKCQl0b29sdGlwLnN0b3AoIHRydWUgKTsKCQl0aGlzLl9oaWRlKCB0b29sdGlwLCB0aGlzLm9wdGlvbnMuaGlkZSwgZnVuY3Rpb24oKSB7CgkJCXRoYXQuX3JlbW92ZVRvb2x0aXAoICQoIHRoaXMgKSApOwoJCX0gKTsKCgkJdGFyZ2V0LnJlbW92ZURhdGEoICJ1aS10b29sdGlwLW9wZW4iICk7CgkJdGhpcy5fb2ZmKCB0YXJnZXQsICJtb3VzZWxlYXZlIGZvY3Vzb3V0IGtleXVwIiApOwoKCQkvLyBSZW1vdmUgJ3JlbW92ZScgYmluZGluZyBvbmx5IG9uIGRlbGVnYXRlZCB0YXJnZXRzCgkJaWYgKCB0YXJnZXRbIDAgXSAhPT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCXRoaXMuX29mZiggdGFyZ2V0LCAicmVtb3ZlIiApOwoJCX0KCQl0aGlzLl9vZmYoIHRoaXMuZG9jdW1lbnQsICJtb3VzZW1vdmUiICk7CgoJCWlmICggZXZlbnQgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlbGVhdmUiICkgewoJCQkkLmVhY2goIHRoaXMucGFyZW50cywgZnVuY3Rpb24oIGlkLCBwYXJlbnQgKSB7CgkJCQkkKCBwYXJlbnQuZWxlbWVudCApLmF0dHIoICJ0aXRsZSIsIHBhcmVudC50aXRsZSApOwoJCQkJZGVsZXRlIHRoYXQucGFyZW50c1sgaWQgXTsKCQkJfSApOwoJCX0KCgkJdG9vbHRpcERhdGEuY2xvc2luZyA9IHRydWU7CgkJdGhpcy5fdHJpZ2dlciggImNsb3NlIiwgZXZlbnQsIHsgdG9vbHRpcDogdG9vbHRpcCB9ICk7CgkJaWYgKCAhdG9vbHRpcERhdGEuaGlkaW5nICkgewoJCQl0b29sdGlwRGF0YS5jbG9zaW5nID0gZmFsc2U7CgkJfQoJfSwKCglfdG9vbHRpcDogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdmFyIHRvb2x0aXAgPSAkKCAiPGRpdj4iICkuYXR0ciggInJvbGUiLCAidG9vbHRpcCIgKSwKCQkJY29udGVudCA9ICQoICI8ZGl2PiIgKS5hcHBlbmRUbyggdG9vbHRpcCApLAoJCQlpZCA9IHRvb2x0aXAudW5pcXVlSWQoKS5hdHRyKCAiaWQiICk7CgoJCXRoaXMuX2FkZENsYXNzKCBjb250ZW50LCAidWktdG9vbHRpcC1jb250ZW50IiApOwoJCXRoaXMuX2FkZENsYXNzKCB0b29sdGlwLCAidWktdG9vbHRpcCIsICJ1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQiICk7CgoJCXRvb2x0aXAuYXBwZW5kVG8oIHRoaXMuX2FwcGVuZFRvKCBlbGVtZW50ICkgKTsKCgkJcmV0dXJuIHRoaXMudG9vbHRpcHNbIGlkIF0gPSB7CgkJCWVsZW1lbnQ6IGVsZW1lbnQsCgkJCXRvb2x0aXA6IHRvb2x0aXAKCQl9OwoJfSwKCglfZmluZDogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgaWQgPSB0YXJnZXQuZGF0YSggInVpLXRvb2x0aXAtaWQiICk7CgkJcmV0dXJuIGlkID8gdGhpcy50b29sdGlwc1sgaWQgXSA6IG51bGw7Cgl9LAoKCV9yZW1vdmVUb29sdGlwOiBmdW5jdGlvbiggdG9vbHRpcCApIHsKCQl0b29sdGlwLnJlbW92ZSgpOwoJCWRlbGV0ZSB0aGlzLnRvb2x0aXBzWyB0b29sdGlwLmF0dHIoICJpZCIgKSBdOwoJfSwKCglfYXBwZW5kVG86IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkJdmFyIGVsZW1lbnQgPSB0YXJnZXQuY2xvc2VzdCggIi51aS1mcm9udCwgZGlhbG9nIiApOwoKCQlpZiAoICFlbGVtZW50Lmxlbmd0aCApIHsKCQkJZWxlbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5ib2R5OwoJCX0KCgkJcmV0dXJuIGVsZW1lbnQ7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCS8vIENsb3NlIG9wZW4gdG9vbHRpcHMKCQkkLmVhY2goIHRoaXMudG9vbHRpcHMsIGZ1bmN0aW9uKCBpZCwgdG9vbHRpcERhdGEgKSB7CgoJCQkvLyBEZWxlZ2F0ZSB0byBjbG9zZSBtZXRob2QgdG8gaGFuZGxlIGNvbW1vbiBjbGVhbnVwCgkJCXZhciBldmVudCA9ICQuRXZlbnQoICJibHVyIiApLAoJCQkJZWxlbWVudCA9IHRvb2x0aXBEYXRhLmVsZW1lbnQ7CgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBlbGVtZW50WyAwIF07CgkJCXRoYXQuY2xvc2UoIGV2ZW50LCB0cnVlICk7CgoJCQkvLyBSZW1vdmUgaW1tZWRpYXRlbHk7IGRlc3Ryb3lpbmcgYW4gb3BlbiB0b29sdGlwIGRvZXNuJ3QgdXNlIHRoZQoJCQkvLyBoaWRlIGFuaW1hdGlvbgoJCQkkKCAiIyIgKyBpZCApLnJlbW92ZSgpOwoKCQkJLy8gUmVzdG9yZSB0aGUgdGl0bGUKCQkJaWYgKCBlbGVtZW50LmRhdGEoICJ1aS10b29sdGlwLXRpdGxlIiApICkgewoKCQkJCS8vIElmIHRoZSB0aXRsZSBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQgc2luY2Ugb3BlbigpLCBkb24ndCByZXN0b3JlCgkJCQlpZiAoICFlbGVtZW50LmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJCQllbGVtZW50LmF0dHIoICJ0aXRsZSIsIGVsZW1lbnQuZGF0YSggInVpLXRvb2x0aXAtdGl0bGUiICkgKTsKCQkJCX0KCQkJCWVsZW1lbnQucmVtb3ZlRGF0YSggInVpLXRvb2x0aXAtdGl0bGUiICk7CgkJCX0KCQl9ICk7CgkJdGhpcy5saXZlUmVnaW9uLnJlbW92ZSgpOwoJfQp9ICk7CgovLyBERVBSRUNBVEVECi8vIFRPRE86IFN3aXRjaCByZXR1cm4gYmFjayB0byB3aWRnZXQgZGVjbGFyYXRpb24gYXQgdG9wIG9mIGZpbGUgd2hlbiB0aGlzIGlzIHJlbW92ZWQKaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgKSB7CgoJLy8gQmFja2NvbXBhdCBmb3IgdG9vbHRpcENsYXNzIG9wdGlvbgoJJC53aWRnZXQoICJ1aS50b29sdGlwIiwgJC51aS50b29sdGlwLCB7CgkJb3B0aW9uczogewoJCQl0b29sdGlwQ2xhc3M6IG51bGwKCQl9LAoJCV90b29sdGlwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRvb2x0aXBEYXRhID0gdGhpcy5fc3VwZXJBcHBseSggYXJndW1lbnRzICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnRvb2x0aXBDbGFzcyApIHsKCQkJCXRvb2x0aXBEYXRhLnRvb2x0aXAuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy50b29sdGlwQ2xhc3MgKTsKCQkJfQoJCQlyZXR1cm4gdG9vbHRpcERhdGE7CgkJfQoJfSApOwp9Cgp2YXIgd2lkZ2V0c1Rvb2x0aXAgPSAkLnVpLnRvb2x0aXA7CgoKLyohCiAqIGpRdWVyeSBVSSBFZmZlY3RzIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogRWZmZWN0cyBDb3JlCi8vPj5ncm91cDogRWZmZWN0cwovLyBqc2NzOmRpc2FibGUgbWF4aW11bUxpbmVMZW5ndGgKLy8+PmRlc2NyaXB0aW9uOiBFeHRlbmRzIHRoZSBpbnRlcm5hbCBqUXVlcnkgZWZmZWN0cy4gSW5jbHVkZXMgbW9ycGhpbmcgYW5kIGVhc2luZy4gUmVxdWlyZWQgYnkgYWxsIG90aGVyIGVmZmVjdHMuCi8vIGpzY3M6ZW5hYmxlIG1heGltdW1MaW5lTGVuZ3RoCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9jYXRlZ29yeS9lZmZlY3RzLWNvcmUvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvCgoKCnZhciBkYXRhU3BhY2UgPSAidWktZWZmZWN0cy0iLAoJZGF0YVNwYWNlU3R5bGUgPSAidWktZWZmZWN0cy1zdHlsZSIsCglkYXRhU3BhY2VBbmltYXRlZCA9ICJ1aS1lZmZlY3RzLWFuaW1hdGVkIiwKCgkvLyBDcmVhdGUgYSBsb2NhbCBqUXVlcnkgYmVjYXVzZSBqUXVlcnkgQ29sb3IgcmVsaWVzIG9uIGl0IGFuZCB0aGUKCS8vIGdsb2JhbCBtYXkgbm90IGV4aXN0IHdpdGggQU1EIGFuZCBhIGN1c3RvbSBidWlsZCAoIzEwMTk5KQoJalF1ZXJ5ID0gJDsKCiQuZWZmZWN0cyA9IHsKCWVmZmVjdDoge30KfTsKCi8qIQogKiBqUXVlcnkgQ29sb3IgQW5pbWF0aW9ucyB2Mi4xLjIKICogaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktY29sb3IKICoKICogQ29weXJpZ2h0IDIwMTQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogRGF0ZTogV2VkIEphbiAxNiAwODo0NzowOSAyMDEzIC0wNjAwCiAqLwooIGZ1bmN0aW9uKCBqUXVlcnksIHVuZGVmaW5lZCApIHsKCgl2YXIgc3RlcEhvb2tzID0gImJhY2tncm91bmRDb2xvciBib3JkZXJCb3R0b21Db2xvciBib3JkZXJMZWZ0Q29sb3IgYm9yZGVyUmlnaHRDb2xvciAiICsKCQkiYm9yZGVyVG9wQ29sb3IgY29sb3IgY29sdW1uUnVsZUNvbG9yIG91dGxpbmVDb2xvciB0ZXh0RGVjb3JhdGlvbkNvbG9yIHRleHRFbXBoYXNpc0NvbG9yIiwKCgkvLyBQbHVzZXF1YWxzIHRlc3QgZm9yICs9IDEwMCAtPSAxMDAKCXJwbHVzZXF1YWxzID0gL14oW1wtK10pPVxzKihcZCtcLj9cZCopLywKCgkvLyBBIHNldCBvZiBSRSdzIHRoYXQgY2FuIG1hdGNoIHN0cmluZ3MgYW5kIGdlbmVyYXRlIGNvbG9yIHR1cGxlcy4KCXN0cmluZ1BhcnNlcnMgPSBbIHsKCQkJcmU6IC9yZ2JhP1woXHMqKFxkezEsM30pXHMqLFxzKihcZHsxLDN9KVxzKixccyooXGR7MSwzfSlccyooPzosXHMqKFxkPyg/OlwuXGQrKT8pXHMqKT9cKS8sCgkJCXBhcnNlOiBmdW5jdGlvbiggZXhlY1Jlc3VsdCApIHsKCQkJCXJldHVybiBbCgkJCQkJZXhlY1Jlc3VsdFsgMSBdLAoJCQkJCWV4ZWNSZXN1bHRbIDIgXSwKCQkJCQlleGVjUmVzdWx0WyAzIF0sCgkJCQkJZXhlY1Jlc3VsdFsgNCBdCgkJCQldOwoJCQl9CgkJfSwgewoJCQlyZTogL3JnYmE/XChccyooXGQrKD86XC5cZCspPylcJVxzKixccyooXGQrKD86XC5cZCspPylcJVxzKixccyooXGQrKD86XC5cZCspPylcJVxzKig/OixccyooXGQ/KD86XC5cZCspPylccyopP1wpLywKCQkJcGFyc2U6IGZ1bmN0aW9uKCBleGVjUmVzdWx0ICkgewoJCQkJcmV0dXJuIFsKCQkJCQlleGVjUmVzdWx0WyAxIF0gKiAyLjU1LAoJCQkJCWV4ZWNSZXN1bHRbIDIgXSAqIDIuNTUsCgkJCQkJZXhlY1Jlc3VsdFsgMyBdICogMi41NSwKCQkJCQlleGVjUmVzdWx0WyA0IF0KCQkJCV07CgkJCX0KCQl9LCB7CgoJCQkvLyBUaGlzIHJlZ2V4IGlnbm9yZXMgQS1GIGJlY2F1c2UgaXQncyBjb21wYXJlZCBhZ2FpbnN0IGFuIGFscmVhZHkgbG93ZXJjYXNlZCBzdHJpbmcKCQkJcmU6IC8jKFthLWYwLTldezJ9KShbYS1mMC05XXsyfSkoW2EtZjAtOV17Mn0pLywKCQkJcGFyc2U6IGZ1bmN0aW9uKCBleGVjUmVzdWx0ICkgewoJCQkJcmV0dXJuIFsKCQkJCQlwYXJzZUludCggZXhlY1Jlc3VsdFsgMSBdLCAxNiApLAoJCQkJCXBhcnNlSW50KCBleGVjUmVzdWx0WyAyIF0sIDE2ICksCgkJCQkJcGFyc2VJbnQoIGV4ZWNSZXN1bHRbIDMgXSwgMTYgKQoJCQkJXTsKCQkJfQoJCX0sIHsKCgkJCS8vIFRoaXMgcmVnZXggaWdub3JlcyBBLUYgYmVjYXVzZSBpdCdzIGNvbXBhcmVkIGFnYWluc3QgYW4gYWxyZWFkeSBsb3dlcmNhc2VkIHN0cmluZwoJCQlyZTogLyMoW2EtZjAtOV0pKFthLWYwLTldKShbYS1mMC05XSkvLAoJCQlwYXJzZTogZnVuY3Rpb24oIGV4ZWNSZXN1bHQgKSB7CgkJCQlyZXR1cm4gWwoJCQkJCXBhcnNlSW50KCBleGVjUmVzdWx0WyAxIF0gKyBleGVjUmVzdWx0WyAxIF0sIDE2ICksCgkJCQkJcGFyc2VJbnQoIGV4ZWNSZXN1bHRbIDIgXSArIGV4ZWNSZXN1bHRbIDIgXSwgMTYgKSwKCQkJCQlwYXJzZUludCggZXhlY1Jlc3VsdFsgMyBdICsgZXhlY1Jlc3VsdFsgMyBdLCAxNiApCgkJCQldOwoJCQl9CgkJfSwgewoJCQlyZTogL2hzbGE/XChccyooXGQrKD86XC5cZCspPylccyosXHMqKFxkKyg/OlwuXGQrKT8pXCVccyosXHMqKFxkKyg/OlwuXGQrKT8pXCVccyooPzosXHMqKFxkPyg/OlwuXGQrKT8pXHMqKT9cKS8sCgkJCXNwYWNlOiAiaHNsYSIsCgkJCXBhcnNlOiBmdW5jdGlvbiggZXhlY1Jlc3VsdCApIHsKCQkJCXJldHVybiBbCgkJCQkJZXhlY1Jlc3VsdFsgMSBdLAoJCQkJCWV4ZWNSZXN1bHRbIDIgXSAvIDEwMCwKCQkJCQlleGVjUmVzdWx0WyAzIF0gLyAxMDAsCgkJCQkJZXhlY1Jlc3VsdFsgNCBdCgkJCQldOwoJCQl9CgkJfSBdLAoKCS8vIEpRdWVyeS5Db2xvciggKQoJY29sb3IgPSBqUXVlcnkuQ29sb3IgPSBmdW5jdGlvbiggY29sb3IsIGdyZWVuLCBibHVlLCBhbHBoYSApIHsKCQlyZXR1cm4gbmV3IGpRdWVyeS5Db2xvci5mbi5wYXJzZSggY29sb3IsIGdyZWVuLCBibHVlLCBhbHBoYSApOwoJfSwKCXNwYWNlcyA9IHsKCQlyZ2JhOiB7CgkJCXByb3BzOiB7CgkJCQlyZWQ6IHsKCQkJCQlpZHg6IDAsCgkJCQkJdHlwZTogImJ5dGUiCgkJCQl9LAoJCQkJZ3JlZW46IHsKCQkJCQlpZHg6IDEsCgkJCQkJdHlwZTogImJ5dGUiCgkJCQl9LAoJCQkJYmx1ZTogewoJCQkJCWlkeDogMiwKCQkJCQl0eXBlOiAiYnl0ZSIKCQkJCX0KCQkJfQoJCX0sCgoJCWhzbGE6IHsKCQkJcHJvcHM6IHsKCQkJCWh1ZTogewoJCQkJCWlkeDogMCwKCQkJCQl0eXBlOiAiZGVncmVlcyIKCQkJCX0sCgkJCQlzYXR1cmF0aW9uOiB7CgkJCQkJaWR4OiAxLAoJCQkJCXR5cGU6ICJwZXJjZW50IgoJCQkJfSwKCQkJCWxpZ2h0bmVzczogewoJCQkJCWlkeDogMiwKCQkJCQl0eXBlOiAicGVyY2VudCIKCQkJCX0KCQkJfQoJCX0KCX0sCglwcm9wVHlwZXMgPSB7CgkJImJ5dGUiOiB7CgkJCWZsb29yOiB0cnVlLAoJCQltYXg6IDI1NQoJCX0sCgkJInBlcmNlbnQiOiB7CgkJCW1heDogMQoJCX0sCgkJImRlZ3JlZXMiOiB7CgkJCW1vZDogMzYwLAoJCQlmbG9vcjogdHJ1ZQoJCX0KCX0sCglzdXBwb3J0ID0gY29sb3Iuc3VwcG9ydCA9IHt9LAoKCS8vIEVsZW1lbnQgZm9yIHN1cHBvcnQgdGVzdHMKCXN1cHBvcnRFbGVtID0galF1ZXJ5KCAiPHA+IiApWyAwIF0sCgoJLy8gQ29sb3JzID0galF1ZXJ5LkNvbG9yLm5hbWVzCgljb2xvcnMsCgoJLy8gTG9jYWwgYWxpYXNlcyBvZiBmdW5jdGlvbnMgY2FsbGVkIG9mdGVuCgllYWNoID0galF1ZXJ5LmVhY2g7CgovLyBEZXRlcm1pbmUgcmdiYSBzdXBwb3J0IGltbWVkaWF0ZWx5CnN1cHBvcnRFbGVtLnN0eWxlLmNzc1RleHQgPSAiYmFja2dyb3VuZC1jb2xvcjpyZ2JhKDEsMSwxLC41KSI7CnN1cHBvcnQucmdiYSA9IHN1cHBvcnRFbGVtLnN0eWxlLmJhY2tncm91bmRDb2xvci5pbmRleE9mKCAicmdiYSIgKSA+IC0xOwoKLy8gRGVmaW5lIGNhY2hlIG5hbWUgYW5kIGFscGhhIHByb3BlcnRpZXMKLy8gZm9yIHJnYmEgYW5kIGhzbGEgc3BhY2VzCmVhY2goIHNwYWNlcywgZnVuY3Rpb24oIHNwYWNlTmFtZSwgc3BhY2UgKSB7CglzcGFjZS5jYWNoZSA9ICJfIiArIHNwYWNlTmFtZTsKCXNwYWNlLnByb3BzLmFscGhhID0gewoJCWlkeDogMywKCQl0eXBlOiAicGVyY2VudCIsCgkJZGVmOiAxCgl9Owp9ICk7CgpmdW5jdGlvbiBjbGFtcCggdmFsdWUsIHByb3AsIGFsbG93RW1wdHkgKSB7Cgl2YXIgdHlwZSA9IHByb3BUeXBlc1sgcHJvcC50eXBlIF0gfHwge307CgoJaWYgKCB2YWx1ZSA9PSBudWxsICkgewoJCXJldHVybiAoIGFsbG93RW1wdHkgfHwgIXByb3AuZGVmICkgPyBudWxsIDogcHJvcC5kZWY7Cgl9CgoJLy8gfn4gaXMgYW4gc2hvcnQgd2F5IG9mIGRvaW5nIGZsb29yIGZvciBwb3NpdGl2ZSBudW1iZXJzCgl2YWx1ZSA9IHR5cGUuZmxvb3IgPyB+fnZhbHVlIDogcGFyc2VGbG9hdCggdmFsdWUgKTsKCgkvLyBJRSB3aWxsIHBhc3MgaW4gZW1wdHkgc3RyaW5ncyBhcyB2YWx1ZSBmb3IgYWxwaGEsCgkvLyB3aGljaCB3aWxsIGhpdCB0aGlzIGNhc2UKCWlmICggaXNOYU4oIHZhbHVlICkgKSB7CgkJcmV0dXJuIHByb3AuZGVmOwoJfQoKCWlmICggdHlwZS5tb2QgKSB7CgoJCS8vIFdlIGFkZCBtb2QgYmVmb3JlIG1vZGRpbmcgdG8gbWFrZSBzdXJlIHRoYXQgbmVnYXRpdmVzIHZhbHVlcwoJCS8vIGdldCBjb252ZXJ0ZWQgcHJvcGVybHk6IC0xMCAtPiAzNTAKCQlyZXR1cm4gKCB2YWx1ZSArIHR5cGUubW9kICkgJSB0eXBlLm1vZDsKCX0KCgkvLyBGb3Igbm93IGFsbCBwcm9wZXJ0eSB0eXBlcyB3aXRob3V0IG1vZCBoYXZlIG1pbiBhbmQgbWF4CglyZXR1cm4gMCA+IHZhbHVlID8gMCA6IHR5cGUubWF4IDwgdmFsdWUgPyB0eXBlLm1heCA6IHZhbHVlOwp9CgpmdW5jdGlvbiBzdHJpbmdQYXJzZSggc3RyaW5nICkgewoJdmFyIGluc3QgPSBjb2xvcigpLAoJCXJnYmEgPSBpbnN0Ll9yZ2JhID0gW107CgoJc3RyaW5nID0gc3RyaW5nLnRvTG93ZXJDYXNlKCk7CgoJZWFjaCggc3RyaW5nUGFyc2VycywgZnVuY3Rpb24oIGksIHBhcnNlciApIHsKCQl2YXIgcGFyc2VkLAoJCQltYXRjaCA9IHBhcnNlci5yZS5leGVjKCBzdHJpbmcgKSwKCQkJdmFsdWVzID0gbWF0Y2ggJiYgcGFyc2VyLnBhcnNlKCBtYXRjaCApLAoJCQlzcGFjZU5hbWUgPSBwYXJzZXIuc3BhY2UgfHwgInJnYmEiOwoKCQlpZiAoIHZhbHVlcyApIHsKCQkJcGFyc2VkID0gaW5zdFsgc3BhY2VOYW1lIF0oIHZhbHVlcyApOwoKCQkJLy8gSWYgdGhpcyB3YXMgYW4gcmdiYSBwYXJzZSB0aGUgYXNzaWdubWVudCBtaWdodCBoYXBwZW4gdHdpY2UKCQkJLy8gb2ggd2VsbC4uLi4KCQkJaW5zdFsgc3BhY2VzWyBzcGFjZU5hbWUgXS5jYWNoZSBdID0gcGFyc2VkWyBzcGFjZXNbIHNwYWNlTmFtZSBdLmNhY2hlIF07CgkJCXJnYmEgPSBpbnN0Ll9yZ2JhID0gcGFyc2VkLl9yZ2JhOwoKCQkJLy8gRXhpdCBlYWNoKCBzdHJpbmdQYXJzZXJzICkgaGVyZSBiZWNhdXNlIHdlIG1hdGNoZWQKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0gKTsKCgkvLyBGb3VuZCBhIHN0cmluZ1BhcnNlciB0aGF0IGhhbmRsZWQgaXQKCWlmICggcmdiYS5sZW5ndGggKSB7CgoJCS8vIElmIHRoaXMgY2FtZSBmcm9tIGEgcGFyc2VkIHN0cmluZywgZm9yY2UgInRyYW5zcGFyZW50IiB3aGVuIGFscGhhIGlzIDAKCQkvLyBjaHJvbWUsIChhbmQgbWF5YmUgb3RoZXJzKSByZXR1cm4gInRyYW5zcGFyZW50IiBhcyByZ2JhKDAsMCwwLDApCgkJaWYgKCByZ2JhLmpvaW4oKSA9PT0gIjAsMCwwLDAiICkgewoJCQlqUXVlcnkuZXh0ZW5kKCByZ2JhLCBjb2xvcnMudHJhbnNwYXJlbnQgKTsKCQl9CgkJcmV0dXJuIGluc3Q7Cgl9CgoJLy8gTmFtZWQgY29sb3JzCglyZXR1cm4gY29sb3JzWyBzdHJpbmcgXTsKfQoKY29sb3IuZm4gPSBqUXVlcnkuZXh0ZW5kKCBjb2xvci5wcm90b3R5cGUsIHsKCXBhcnNlOiBmdW5jdGlvbiggcmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEgKSB7CgkJaWYgKCByZWQgPT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fcmdiYSA9IFsgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCBdOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKCByZWQuanF1ZXJ5IHx8IHJlZC5ub2RlVHlwZSApIHsKCQkJcmVkID0galF1ZXJ5KCByZWQgKS5jc3MoIGdyZWVuICk7CgkJCWdyZWVuID0gdW5kZWZpbmVkOwoJCX0KCgkJdmFyIGluc3QgPSB0aGlzLAoJCQl0eXBlID0galF1ZXJ5LnR5cGUoIHJlZCApLAoJCQlyZ2JhID0gdGhpcy5fcmdiYSA9IFtdOwoKCQkvLyBNb3JlIHRoYW4gMSBhcmd1bWVudCBzcGVjaWZpZWQgLSBhc3N1bWUgKCByZWQsIGdyZWVuLCBibHVlLCBhbHBoYSApCgkJaWYgKCBncmVlbiAhPT0gdW5kZWZpbmVkICkgewoJCQlyZWQgPSBbIHJlZCwgZ3JlZW4sIGJsdWUsIGFscGhhIF07CgkJCXR5cGUgPSAiYXJyYXkiOwoJCX0KCgkJaWYgKCB0eXBlID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIHRoaXMucGFyc2UoIHN0cmluZ1BhcnNlKCByZWQgKSB8fCBjb2xvcnMuX2RlZmF1bHQgKTsKCQl9CgoJCWlmICggdHlwZSA9PT0gImFycmF5IiApIHsKCQkJZWFjaCggc3BhY2VzLnJnYmEucHJvcHMsIGZ1bmN0aW9uKCBrZXksIHByb3AgKSB7CgkJCQlyZ2JhWyBwcm9wLmlkeCBdID0gY2xhbXAoIHJlZFsgcHJvcC5pZHggXSwgcHJvcCApOwoJCQl9ICk7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKCB0eXBlID09PSAib2JqZWN0IiApIHsKCQkJaWYgKCByZWQgaW5zdGFuY2VvZiBjb2xvciApIHsKCQkJCWVhY2goIHNwYWNlcywgZnVuY3Rpb24oIHNwYWNlTmFtZSwgc3BhY2UgKSB7CgkJCQkJaWYgKCByZWRbIHNwYWNlLmNhY2hlIF0gKSB7CgkJCQkJCWluc3RbIHNwYWNlLmNhY2hlIF0gPSByZWRbIHNwYWNlLmNhY2hlIF0uc2xpY2UoKTsKCQkJCQl9CgkJCQl9ICk7CgkJCX0gZWxzZSB7CgkJCQllYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBzcGFjZU5hbWUsIHNwYWNlICkgewoJCQkJCXZhciBjYWNoZSA9IHNwYWNlLmNhY2hlOwoJCQkJCWVhY2goIHNwYWNlLnByb3BzLCBmdW5jdGlvbigga2V5LCBwcm9wICkgewoKCQkJCQkJLy8gSWYgdGhlIGNhY2hlIGRvZXNuJ3QgZXhpc3QsIGFuZCB3ZSBrbm93IGhvdyB0byBjb252ZXJ0CgkJCQkJCWlmICggIWluc3RbIGNhY2hlIF0gJiYgc3BhY2UudG8gKSB7CgoJCQkJCQkJLy8gSWYgdGhlIHZhbHVlIHdhcyBudWxsLCB3ZSBkb24ndCBuZWVkIHRvIGNvcHkgaXQKCQkJCQkJCS8vIGlmIHRoZSBrZXkgd2FzIGFscGhhLCB3ZSBkb24ndCBuZWVkIHRvIGNvcHkgaXQgZWl0aGVyCgkJCQkJCQlpZiAoIGtleSA9PT0gImFscGhhIiB8fCByZWRbIGtleSBdID09IG51bGwgKSB7CgkJCQkJCQkJcmV0dXJuOwoJCQkJCQkJfQoJCQkJCQkJaW5zdFsgY2FjaGUgXSA9IHNwYWNlLnRvKCBpbnN0Ll9yZ2JhICk7CgkJCQkJCX0KCgkJCQkJCS8vIFRoaXMgaXMgdGhlIG9ubHkgY2FzZSB3aGVyZSB3ZSBhbGxvdyBudWxscyBmb3IgQUxMIHByb3BlcnRpZXMuCgkJCQkJCS8vIGNhbGwgY2xhbXAgd2l0aCBhbHdheXNBbGxvd0VtcHR5CgkJCQkJCWluc3RbIGNhY2hlIF1bIHByb3AuaWR4IF0gPSBjbGFtcCggcmVkWyBrZXkgXSwgcHJvcCwgdHJ1ZSApOwoJCQkJCX0gKTsKCgkJCQkJLy8gRXZlcnl0aGluZyBkZWZpbmVkIGJ1dCBhbHBoYT8KCQkJCQlpZiAoIGluc3RbIGNhY2hlIF0gJiYKCQkJCQkJCWpRdWVyeS5pbkFycmF5KCBudWxsLCBpbnN0WyBjYWNoZSBdLnNsaWNlKCAwLCAzICkgKSA8IDAgKSB7CgoJCQkJCQkvLyBVc2UgdGhlIGRlZmF1bHQgb2YgMQoJCQkJCQlpbnN0WyBjYWNoZSBdWyAzIF0gPSAxOwoJCQkJCQlpZiAoIHNwYWNlLmZyb20gKSB7CgkJCQkJCQlpbnN0Ll9yZ2JhID0gc3BhY2UuZnJvbSggaW5zdFsgY2FjaGUgXSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCX0sCglpczogZnVuY3Rpb24oIGNvbXBhcmUgKSB7CgkJdmFyIGlzID0gY29sb3IoIGNvbXBhcmUgKSwKCQkJc2FtZSA9IHRydWUsCgkJCWluc3QgPSB0aGlzOwoKCQllYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBfLCBzcGFjZSApIHsKCQkJdmFyIGxvY2FsQ2FjaGUsCgkJCQlpc0NhY2hlID0gaXNbIHNwYWNlLmNhY2hlIF07CgkJCWlmICggaXNDYWNoZSApIHsKCQkJCWxvY2FsQ2FjaGUgPSBpbnN0WyBzcGFjZS5jYWNoZSBdIHx8IHNwYWNlLnRvICYmIHNwYWNlLnRvKCBpbnN0Ll9yZ2JhICkgfHwgW107CgkJCQllYWNoKCBzcGFjZS5wcm9wcywgZnVuY3Rpb24oIF8sIHByb3AgKSB7CgkJCQkJaWYgKCBpc0NhY2hlWyBwcm9wLmlkeCBdICE9IG51bGwgKSB7CgkJCQkJCXNhbWUgPSAoIGlzQ2FjaGVbIHByb3AuaWR4IF0gPT09IGxvY2FsQ2FjaGVbIHByb3AuaWR4IF0gKTsKCQkJCQkJcmV0dXJuIHNhbWU7CgkJCQkJfQoJCQkJfSApOwoJCQl9CgkJCXJldHVybiBzYW1lOwoJCX0gKTsKCQlyZXR1cm4gc2FtZTsKCX0sCglfc3BhY2U6IGZ1bmN0aW9uKCkgewoJCXZhciB1c2VkID0gW10sCgkJCWluc3QgPSB0aGlzOwoJCWVhY2goIHNwYWNlcywgZnVuY3Rpb24oIHNwYWNlTmFtZSwgc3BhY2UgKSB7CgkJCWlmICggaW5zdFsgc3BhY2UuY2FjaGUgXSApIHsKCQkJCXVzZWQucHVzaCggc3BhY2VOYW1lICk7CgkJCX0KCQl9ICk7CgkJcmV0dXJuIHVzZWQucG9wKCk7Cgl9LAoJdHJhbnNpdGlvbjogZnVuY3Rpb24oIG90aGVyLCBkaXN0YW5jZSApIHsKCQl2YXIgZW5kID0gY29sb3IoIG90aGVyICksCgkJCXNwYWNlTmFtZSA9IGVuZC5fc3BhY2UoKSwKCQkJc3BhY2UgPSBzcGFjZXNbIHNwYWNlTmFtZSBdLAoJCQlzdGFydENvbG9yID0gdGhpcy5hbHBoYSgpID09PSAwID8gY29sb3IoICJ0cmFuc3BhcmVudCIgKSA6IHRoaXMsCgkJCXN0YXJ0ID0gc3RhcnRDb2xvclsgc3BhY2UuY2FjaGUgXSB8fCBzcGFjZS50byggc3RhcnRDb2xvci5fcmdiYSApLAoJCQlyZXN1bHQgPSBzdGFydC5zbGljZSgpOwoKCQllbmQgPSBlbmRbIHNwYWNlLmNhY2hlIF07CgkJZWFjaCggc3BhY2UucHJvcHMsIGZ1bmN0aW9uKCBrZXksIHByb3AgKSB7CgkJCXZhciBpbmRleCA9IHByb3AuaWR4LAoJCQkJc3RhcnRWYWx1ZSA9IHN0YXJ0WyBpbmRleCBdLAoJCQkJZW5kVmFsdWUgPSBlbmRbIGluZGV4IF0sCgkJCQl0eXBlID0gcHJvcFR5cGVzWyBwcm9wLnR5cGUgXSB8fCB7fTsKCgkJCS8vIElmIG51bGwsIGRvbid0IG92ZXJyaWRlIHN0YXJ0IHZhbHVlCgkJCWlmICggZW5kVmFsdWUgPT09IG51bGwgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIG51bGwgLSB1c2UgZW5kCgkJCWlmICggc3RhcnRWYWx1ZSA9PT0gbnVsbCApIHsKCQkJCXJlc3VsdFsgaW5kZXggXSA9IGVuZFZhbHVlOwoJCQl9IGVsc2UgewoJCQkJaWYgKCB0eXBlLm1vZCApIHsKCQkJCQlpZiAoIGVuZFZhbHVlIC0gc3RhcnRWYWx1ZSA+IHR5cGUubW9kIC8gMiApIHsKCQkJCQkJc3RhcnRWYWx1ZSArPSB0eXBlLm1vZDsKCQkJCQl9IGVsc2UgaWYgKCBzdGFydFZhbHVlIC0gZW5kVmFsdWUgPiB0eXBlLm1vZCAvIDIgKSB7CgkJCQkJCXN0YXJ0VmFsdWUgLT0gdHlwZS5tb2Q7CgkJCQkJfQoJCQkJfQoJCQkJcmVzdWx0WyBpbmRleCBdID0gY2xhbXAoICggZW5kVmFsdWUgLSBzdGFydFZhbHVlICkgKiBkaXN0YW5jZSArIHN0YXJ0VmFsdWUsIHByb3AgKTsKCQkJfQoJCX0gKTsKCQlyZXR1cm4gdGhpc1sgc3BhY2VOYW1lIF0oIHJlc3VsdCApOwoJfSwKCWJsZW5kOiBmdW5jdGlvbiggb3BhcXVlICkgewoKCQkvLyBJZiB3ZSBhcmUgYWxyZWFkeSBvcGFxdWUgLSByZXR1cm4gb3Vyc2VsZgoJCWlmICggdGhpcy5fcmdiYVsgMyBdID09PSAxICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXZhciByZ2IgPSB0aGlzLl9yZ2JhLnNsaWNlKCksCgkJCWEgPSByZ2IucG9wKCksCgkJCWJsZW5kID0gY29sb3IoIG9wYXF1ZSApLl9yZ2JhOwoKCQlyZXR1cm4gY29sb3IoIGpRdWVyeS5tYXAoIHJnYiwgZnVuY3Rpb24oIHYsIGkgKSB7CgkJCXJldHVybiAoIDEgLSBhICkgKiBibGVuZFsgaSBdICsgYSAqIHY7CgkJfSApICk7Cgl9LAoJdG9SZ2JhU3RyaW5nOiBmdW5jdGlvbigpIHsKCQl2YXIgcHJlZml4ID0gInJnYmEoIiwKCQkJcmdiYSA9IGpRdWVyeS5tYXAoIHRoaXMuX3JnYmEsIGZ1bmN0aW9uKCB2LCBpICkgewoJCQkJcmV0dXJuIHYgPT0gbnVsbCA/ICggaSA+IDIgPyAxIDogMCApIDogdjsKCQkJfSApOwoKCQlpZiAoIHJnYmFbIDMgXSA9PT0gMSApIHsKCQkJcmdiYS5wb3AoKTsKCQkJcHJlZml4ID0gInJnYigiOwoJCX0KCgkJcmV0dXJuIHByZWZpeCArIHJnYmEuam9pbigpICsgIikiOwoJfSwKCXRvSHNsYVN0cmluZzogZnVuY3Rpb24oKSB7CgkJdmFyIHByZWZpeCA9ICJoc2xhKCIsCgkJCWhzbGEgPSBqUXVlcnkubWFwKCB0aGlzLmhzbGEoKSwgZnVuY3Rpb24oIHYsIGkgKSB7CgkJCQlpZiAoIHYgPT0gbnVsbCApIHsKCQkJCQl2ID0gaSA+IDIgPyAxIDogMDsKCQkJCX0KCgkJCQkvLyBDYXRjaCAxIGFuZCAyCgkJCQlpZiAoIGkgJiYgaSA8IDMgKSB7CgkJCQkJdiA9IE1hdGgucm91bmQoIHYgKiAxMDAgKSArICIlIjsKCQkJCX0KCQkJCXJldHVybiB2OwoJCQl9ICk7CgoJCWlmICggaHNsYVsgMyBdID09PSAxICkgewoJCQloc2xhLnBvcCgpOwoJCQlwcmVmaXggPSAiaHNsKCI7CgkJfQoJCXJldHVybiBwcmVmaXggKyBoc2xhLmpvaW4oKSArICIpIjsKCX0sCgl0b0hleFN0cmluZzogZnVuY3Rpb24oIGluY2x1ZGVBbHBoYSApIHsKCQl2YXIgcmdiYSA9IHRoaXMuX3JnYmEuc2xpY2UoKSwKCQkJYWxwaGEgPSByZ2JhLnBvcCgpOwoKCQlpZiAoIGluY2x1ZGVBbHBoYSApIHsKCQkJcmdiYS5wdXNoKCB+figgYWxwaGEgKiAyNTUgKSApOwoJCX0KCgkJcmV0dXJuICIjIiArIGpRdWVyeS5tYXAoIHJnYmEsIGZ1bmN0aW9uKCB2ICkgewoKCQkJLy8gRGVmYXVsdCB0byAwIHdoZW4gbnVsbHMgZXhpc3QKCQkJdiA9ICggdiB8fCAwICkudG9TdHJpbmcoIDE2ICk7CgkJCXJldHVybiB2Lmxlbmd0aCA9PT0gMSA/ICIwIiArIHYgOiB2OwoJCX0gKS5qb2luKCAiIiApOwoJfSwKCXRvU3RyaW5nOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fcmdiYVsgMyBdID09PSAwID8gInRyYW5zcGFyZW50IiA6IHRoaXMudG9SZ2JhU3RyaW5nKCk7Cgl9Cn0gKTsKY29sb3IuZm4ucGFyc2UucHJvdG90eXBlID0gY29sb3IuZm47CgovLyBIc2xhIGNvbnZlcnNpb25zIGFkYXB0ZWQgZnJvbToKLy8gaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9tYWFzaGFhY2svc291cmNlL2Jyb3dzZS9wYWNrYWdlcy9ncmFwaGljcy90cnVuay9zcmMvZ3JhcGhpY3MvY29sb3JzL0hVRTJSR0IuYXM/cj01MDIxCgpmdW5jdGlvbiBodWUycmdiKCBwLCBxLCBoICkgewoJaCA9ICggaCArIDEgKSAlIDE7CglpZiAoIGggKiA2IDwgMSApIHsKCQlyZXR1cm4gcCArICggcSAtIHAgKSAqIGggKiA2OwoJfQoJaWYgKCBoICogMiA8IDEgKSB7CgkJcmV0dXJuIHE7Cgl9CglpZiAoIGggKiAzIDwgMiApIHsKCQlyZXR1cm4gcCArICggcSAtIHAgKSAqICggKCAyIC8gMyApIC0gaCApICogNjsKCX0KCXJldHVybiBwOwp9CgpzcGFjZXMuaHNsYS50byA9IGZ1bmN0aW9uKCByZ2JhICkgewoJaWYgKCByZ2JhWyAwIF0gPT0gbnVsbCB8fCByZ2JhWyAxIF0gPT0gbnVsbCB8fCByZ2JhWyAyIF0gPT0gbnVsbCApIHsKCQlyZXR1cm4gWyBudWxsLCBudWxsLCBudWxsLCByZ2JhWyAzIF0gXTsKCX0KCXZhciByID0gcmdiYVsgMCBdIC8gMjU1LAoJCWcgPSByZ2JhWyAxIF0gLyAyNTUsCgkJYiA9IHJnYmFbIDIgXSAvIDI1NSwKCQlhID0gcmdiYVsgMyBdLAoJCW1heCA9IE1hdGgubWF4KCByLCBnLCBiICksCgkJbWluID0gTWF0aC5taW4oIHIsIGcsIGIgKSwKCQlkaWZmID0gbWF4IC0gbWluLAoJCWFkZCA9IG1heCArIG1pbiwKCQlsID0gYWRkICogMC41LAoJCWgsIHM7CgoJaWYgKCBtaW4gPT09IG1heCApIHsKCQloID0gMDsKCX0gZWxzZSBpZiAoIHIgPT09IG1heCApIHsKCQloID0gKCA2MCAqICggZyAtIGIgKSAvIGRpZmYgKSArIDM2MDsKCX0gZWxzZSBpZiAoIGcgPT09IG1heCApIHsKCQloID0gKCA2MCAqICggYiAtIHIgKSAvIGRpZmYgKSArIDEyMDsKCX0gZWxzZSB7CgkJaCA9ICggNjAgKiAoIHIgLSBnICkgLyBkaWZmICkgKyAyNDA7Cgl9CgoJLy8gQ2hyb21hIChkaWZmKSA9PSAwIG1lYW5zIGdyZXlzY2FsZSB3aGljaCwgYnkgZGVmaW5pdGlvbiwgc2F0dXJhdGlvbiA9IDAlCgkvLyBvdGhlcndpc2UsIHNhdHVyYXRpb24gaXMgYmFzZWQgb24gdGhlIHJhdGlvIG9mIGNocm9tYSAoZGlmZikgdG8gbGlnaHRuZXNzIChhZGQpCglpZiAoIGRpZmYgPT09IDAgKSB7CgkJcyA9IDA7Cgl9IGVsc2UgaWYgKCBsIDw9IDAuNSApIHsKCQlzID0gZGlmZiAvIGFkZDsKCX0gZWxzZSB7CgkJcyA9IGRpZmYgLyAoIDIgLSBhZGQgKTsKCX0KCXJldHVybiBbIE1hdGgucm91bmQoIGggKSAlIDM2MCwgcywgbCwgYSA9PSBudWxsID8gMSA6IGEgXTsKfTsKCnNwYWNlcy5oc2xhLmZyb20gPSBmdW5jdGlvbiggaHNsYSApIHsKCWlmICggaHNsYVsgMCBdID09IG51bGwgfHwgaHNsYVsgMSBdID09IG51bGwgfHwgaHNsYVsgMiBdID09IG51bGwgKSB7CgkJcmV0dXJuIFsgbnVsbCwgbnVsbCwgbnVsbCwgaHNsYVsgMyBdIF07Cgl9Cgl2YXIgaCA9IGhzbGFbIDAgXSAvIDM2MCwKCQlzID0gaHNsYVsgMSBdLAoJCWwgPSBoc2xhWyAyIF0sCgkJYSA9IGhzbGFbIDMgXSwKCQlxID0gbCA8PSAwLjUgPyBsICogKCAxICsgcyApIDogbCArIHMgLSBsICogcywKCQlwID0gMiAqIGwgLSBxOwoKCXJldHVybiBbCgkJTWF0aC5yb3VuZCggaHVlMnJnYiggcCwgcSwgaCArICggMSAvIDMgKSApICogMjU1ICksCgkJTWF0aC5yb3VuZCggaHVlMnJnYiggcCwgcSwgaCApICogMjU1ICksCgkJTWF0aC5yb3VuZCggaHVlMnJnYiggcCwgcSwgaCAtICggMSAvIDMgKSApICogMjU1ICksCgkJYQoJXTsKfTsKCmVhY2goIHNwYWNlcywgZnVuY3Rpb24oIHNwYWNlTmFtZSwgc3BhY2UgKSB7Cgl2YXIgcHJvcHMgPSBzcGFjZS5wcm9wcywKCQljYWNoZSA9IHNwYWNlLmNhY2hlLAoJCXRvID0gc3BhY2UudG8sCgkJZnJvbSA9IHNwYWNlLmZyb207CgoJLy8gTWFrZXMgcmdiYSgpIGFuZCBoc2xhKCkKCWNvbG9yLmZuWyBzcGFjZU5hbWUgXSA9IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCgkJLy8gR2VuZXJhdGUgYSBjYWNoZSBmb3IgdGhpcyBzcGFjZSBpZiBpdCBkb2Vzbid0IGV4aXN0CgkJaWYgKCB0byAmJiAhdGhpc1sgY2FjaGUgXSApIHsKCQkJdGhpc1sgY2FjaGUgXSA9IHRvKCB0aGlzLl9yZ2JhICk7CgkJfQoJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRoaXNbIGNhY2hlIF0uc2xpY2UoKTsKCQl9CgoJCXZhciByZXQsCgkJCXR5cGUgPSBqUXVlcnkudHlwZSggdmFsdWUgKSwKCQkJYXJyID0gKCB0eXBlID09PSAiYXJyYXkiIHx8IHR5cGUgPT09ICJvYmplY3QiICkgPyB2YWx1ZSA6IGFyZ3VtZW50cywKCQkJbG9jYWwgPSB0aGlzWyBjYWNoZSBdLnNsaWNlKCk7CgoJCWVhY2goIHByb3BzLCBmdW5jdGlvbigga2V5LCBwcm9wICkgewoJCQl2YXIgdmFsID0gYXJyWyB0eXBlID09PSAib2JqZWN0IiA/IGtleSA6IHByb3AuaWR4IF07CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBsb2NhbFsgcHJvcC5pZHggXTsKCQkJfQoJCQlsb2NhbFsgcHJvcC5pZHggXSA9IGNsYW1wKCB2YWwsIHByb3AgKTsKCQl9ICk7CgoJCWlmICggZnJvbSApIHsKCQkJcmV0ID0gY29sb3IoIGZyb20oIGxvY2FsICkgKTsKCQkJcmV0WyBjYWNoZSBdID0gbG9jYWw7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIGNvbG9yKCBsb2NhbCApOwoJCX0KCX07CgoJLy8gTWFrZXMgcmVkKCkgZ3JlZW4oKSBibHVlKCkgYWxwaGEoKSBodWUoKSBzYXR1cmF0aW9uKCkgbGlnaHRuZXNzKCkKCWVhY2goIHByb3BzLCBmdW5jdGlvbigga2V5LCBwcm9wICkgewoKCQkvLyBBbHBoYSBpcyBpbmNsdWRlZCBpbiBtb3JlIHRoYW4gb25lIHNwYWNlCgkJaWYgKCBjb2xvci5mblsga2V5IF0gKSB7CgkJCXJldHVybjsKCQl9CgkJY29sb3IuZm5bIGtleSBdID0gZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgdnR5cGUgPSBqUXVlcnkudHlwZSggdmFsdWUgKSwKCQkJCWZuID0gKCBrZXkgPT09ICJhbHBoYSIgPyAoIHRoaXMuX2hzbGEgPyAiaHNsYSIgOiAicmdiYSIgKSA6IHNwYWNlTmFtZSApLAoJCQkJbG9jYWwgPSB0aGlzWyBmbiBdKCksCgkJCQljdXIgPSBsb2NhbFsgcHJvcC5pZHggXSwKCQkJCW1hdGNoOwoKCQkJaWYgKCB2dHlwZSA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCQlyZXR1cm4gY3VyOwoJCQl9CgoJCQlpZiAoIHZ0eXBlID09PSAiZnVuY3Rpb24iICkgewoJCQkJdmFsdWUgPSB2YWx1ZS5jYWxsKCB0aGlzLCBjdXIgKTsKCQkJCXZ0eXBlID0galF1ZXJ5LnR5cGUoIHZhbHVlICk7CgkJCX0KCQkJaWYgKCB2YWx1ZSA9PSBudWxsICYmIHByb3AuZW1wdHkgKSB7CgkJCQlyZXR1cm4gdGhpczsKCQkJfQoJCQlpZiAoIHZ0eXBlID09PSAic3RyaW5nIiApIHsKCQkJCW1hdGNoID0gcnBsdXNlcXVhbHMuZXhlYyggdmFsdWUgKTsKCQkJCWlmICggbWF0Y2ggKSB7CgkJCQkJdmFsdWUgPSBjdXIgKyBwYXJzZUZsb2F0KCBtYXRjaFsgMiBdICkgKiAoIG1hdGNoWyAxIF0gPT09ICIrIiA/IDEgOiAtMSApOwoJCQkJfQoJCQl9CgkJCWxvY2FsWyBwcm9wLmlkeCBdID0gdmFsdWU7CgkJCXJldHVybiB0aGlzWyBmbiBdKCBsb2NhbCApOwoJCX07Cgl9ICk7Cn0gKTsKCi8vIEFkZCBjc3NIb29rIGFuZCAuZnguc3RlcCBmdW5jdGlvbiBmb3IgZWFjaCBuYW1lZCBob29rLgovLyBhY2NlcHQgYSBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIG9mIHByb3BlcnRpZXMKY29sb3IuaG9vayA9IGZ1bmN0aW9uKCBob29rICkgewoJdmFyIGhvb2tzID0gaG9vay5zcGxpdCggIiAiICk7CgllYWNoKCBob29rcywgZnVuY3Rpb24oIGksIGhvb2sgKSB7CgkJalF1ZXJ5LmNzc0hvb2tzWyBob29rIF0gPSB7CgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQkJdmFyIHBhcnNlZCwgY3VyRWxlbSwKCQkJCQliYWNrZ3JvdW5kQ29sb3IgPSAiIjsKCgkJCQlpZiAoIHZhbHVlICE9PSAidHJhbnNwYXJlbnQiICYmICggalF1ZXJ5LnR5cGUoIHZhbHVlICkgIT09ICJzdHJpbmciIHx8CgkJCQkJCSggcGFyc2VkID0gc3RyaW5nUGFyc2UoIHZhbHVlICkgKSApICkgewoJCQkJCXZhbHVlID0gY29sb3IoIHBhcnNlZCB8fCB2YWx1ZSApOwoJCQkJCWlmICggIXN1cHBvcnQucmdiYSAmJiB2YWx1ZS5fcmdiYVsgMyBdICE9PSAxICkgewoJCQkJCQljdXJFbGVtID0gaG9vayA9PT0gImJhY2tncm91bmRDb2xvciIgPyBlbGVtLnBhcmVudE5vZGUgOiBlbGVtOwoJCQkJCQl3aGlsZSAoCgkJCQkJCQkoIGJhY2tncm91bmRDb2xvciA9PT0gIiIgfHwgYmFja2dyb3VuZENvbG9yID09PSAidHJhbnNwYXJlbnQiICkgJiYKCQkJCQkJCWN1ckVsZW0gJiYgY3VyRWxlbS5zdHlsZQoJCQkJCQkpIHsKCQkJCQkJCXRyeSB7CgkJCQkJCQkJYmFja2dyb3VuZENvbG9yID0galF1ZXJ5LmNzcyggY3VyRWxlbSwgImJhY2tncm91bmRDb2xvciIgKTsKCQkJCQkJCQljdXJFbGVtID0gY3VyRWxlbS5wYXJlbnROb2RlOwoJCQkJCQkJfSBjYXRjaCAoIGUgKSB7CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJCXZhbHVlID0gdmFsdWUuYmxlbmQoIGJhY2tncm91bmRDb2xvciAmJiBiYWNrZ3JvdW5kQ29sb3IgIT09ICJ0cmFuc3BhcmVudCIgPwoJCQkJCQkJYmFja2dyb3VuZENvbG9yIDoKCQkJCQkJCSJfZGVmYXVsdCIgKTsKCQkJCQl9CgoJCQkJCXZhbHVlID0gdmFsdWUudG9SZ2JhU3RyaW5nKCk7CgkJCQl9CgkJCQl0cnkgewoJCQkJCWVsZW0uc3R5bGVbIGhvb2sgXSA9IHZhbHVlOwoJCQkJfSBjYXRjaCAoIGUgKSB7CgoJCQkJCS8vIFdyYXBwZWQgdG8gcHJldmVudCBJRSBmcm9tIHRocm93aW5nIGVycm9ycyBvbiAiaW52YWxpZCIgdmFsdWVzIGxpa2UKCQkJCQkvLyAnYXV0bycgb3IgJ2luaGVyaXQnCgkJCQl9CgkJCX0KCQl9OwoJCWpRdWVyeS5meC5zdGVwWyBob29rIF0gPSBmdW5jdGlvbiggZnggKSB7CgkJCWlmICggIWZ4LmNvbG9ySW5pdCApIHsKCQkJCWZ4LnN0YXJ0ID0gY29sb3IoIGZ4LmVsZW0sIGhvb2sgKTsKCQkJCWZ4LmVuZCA9IGNvbG9yKCBmeC5lbmQgKTsKCQkJCWZ4LmNvbG9ySW5pdCA9IHRydWU7CgkJCX0KCQkJalF1ZXJ5LmNzc0hvb2tzWyBob29rIF0uc2V0KCBmeC5lbGVtLCBmeC5zdGFydC50cmFuc2l0aW9uKCBmeC5lbmQsIGZ4LnBvcyApICk7CgkJfTsKCX0gKTsKCn07Cgpjb2xvci5ob29rKCBzdGVwSG9va3MgKTsKCmpRdWVyeS5jc3NIb29rcy5ib3JkZXJDb2xvciA9IHsKCWV4cGFuZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBleHBhbmRlZCA9IHt9OwoKCQllYWNoKCBbICJUb3AiLCAiUmlnaHQiLCAiQm90dG9tIiwgIkxlZnQiIF0sIGZ1bmN0aW9uKCBpLCBwYXJ0ICkgewoJCQlleHBhbmRlZFsgImJvcmRlciIgKyBwYXJ0ICsgIkNvbG9yIiBdID0gdmFsdWU7CgkJfSApOwoJCXJldHVybiBleHBhbmRlZDsKCX0KfTsKCi8vIEJhc2ljIGNvbG9yIG5hbWVzIG9ubHkuCi8vIFVzYWdlIG9mIGFueSBvZiB0aGUgb3RoZXIgY29sb3IgbmFtZXMgcmVxdWlyZXMgYWRkaW5nIHlvdXJzZWxmIG9yIGluY2x1ZGluZwovLyBqcXVlcnkuY29sb3Iuc3ZnLW5hbWVzLmpzLgpjb2xvcnMgPSBqUXVlcnkuQ29sb3IubmFtZXMgPSB7CgoJLy8gNC4xLiBCYXNpYyBjb2xvciBrZXl3b3JkcwoJYXF1YTogIiMwMGZmZmYiLAoJYmxhY2s6ICIjMDAwMDAwIiwKCWJsdWU6ICIjMDAwMGZmIiwKCWZ1Y2hzaWE6ICIjZmYwMGZmIiwKCWdyYXk6ICIjODA4MDgwIiwKCWdyZWVuOiAiIzAwODAwMCIsCglsaW1lOiAiIzAwZmYwMCIsCgltYXJvb246ICIjODAwMDAwIiwKCW5hdnk6ICIjMDAwMDgwIiwKCW9saXZlOiAiIzgwODAwMCIsCglwdXJwbGU6ICIjODAwMDgwIiwKCXJlZDogIiNmZjAwMDAiLAoJc2lsdmVyOiAiI2MwYzBjMCIsCgl0ZWFsOiAiIzAwODA4MCIsCgl3aGl0ZTogIiNmZmZmZmYiLAoJeWVsbG93OiAiI2ZmZmYwMCIsCgoJLy8gNC4yLjMuICJ0cmFuc3BhcmVudCIgY29sb3Iga2V5d29yZAoJdHJhbnNwYXJlbnQ6IFsgbnVsbCwgbnVsbCwgbnVsbCwgMCBdLAoKCV9kZWZhdWx0OiAiI2ZmZmZmZiIKfTsKCn0gKSggalF1ZXJ5ICk7CgovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqIENMQVNTIEFOSU1BVElPTlMgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwooIGZ1bmN0aW9uKCkgewoKdmFyIGNsYXNzQW5pbWF0aW9uQWN0aW9ucyA9IFsgImFkZCIsICJyZW1vdmUiLCAidG9nZ2xlIiBdLAoJc2hvcnRoYW5kU3R5bGVzID0gewoJCWJvcmRlcjogMSwKCQlib3JkZXJCb3R0b206IDEsCgkJYm9yZGVyQ29sb3I6IDEsCgkJYm9yZGVyTGVmdDogMSwKCQlib3JkZXJSaWdodDogMSwKCQlib3JkZXJUb3A6IDEsCgkJYm9yZGVyV2lkdGg6IDEsCgkJbWFyZ2luOiAxLAoJCXBhZGRpbmc6IDEKCX07CgokLmVhY2goCglbICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJUb3BTdHlsZSIgXSwKCWZ1bmN0aW9uKCBfLCBwcm9wICkgewoJCSQuZnguc3RlcFsgcHJvcCBdID0gZnVuY3Rpb24oIGZ4ICkgewoJCQlpZiAoIGZ4LmVuZCAhPT0gIm5vbmUiICYmICFmeC5zZXRBdHRyIHx8IGZ4LnBvcyA9PT0gMSAmJiAhZnguc2V0QXR0ciApIHsKCQkJCWpRdWVyeS5zdHlsZSggZnguZWxlbSwgcHJvcCwgZnguZW5kICk7CgkJCQlmeC5zZXRBdHRyID0gdHJ1ZTsKCQkJfQoJCX07Cgl9Cik7CgpmdW5jdGlvbiBnZXRFbGVtZW50U3R5bGVzKCBlbGVtICkgewoJdmFyIGtleSwgbGVuLAoJCXN0eWxlID0gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3ID8KCQkJZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoIGVsZW0sIG51bGwgKSA6CgkJCWVsZW0uY3VycmVudFN0eWxlLAoJCXN0eWxlcyA9IHt9OwoKCWlmICggc3R5bGUgJiYgc3R5bGUubGVuZ3RoICYmIHN0eWxlWyAwIF0gJiYgc3R5bGVbIHN0eWxlWyAwIF0gXSApIHsKCQlsZW4gPSBzdHlsZS5sZW5ndGg7CgkJd2hpbGUgKCBsZW4tLSApIHsKCQkJa2V5ID0gc3R5bGVbIGxlbiBdOwoJCQlpZiAoIHR5cGVvZiBzdHlsZVsga2V5IF0gPT09ICJzdHJpbmciICkgewoJCQkJc3R5bGVzWyAkLmNhbWVsQ2FzZSgga2V5ICkgXSA9IHN0eWxlWyBrZXkgXTsKCQkJfQoJCX0KCgkvLyBTdXBwb3J0OiBPcGVyYSwgSUUgPDkKCX0gZWxzZSB7CgkJZm9yICgga2V5IGluIHN0eWxlICkgewoJCQlpZiAoIHR5cGVvZiBzdHlsZVsga2V5IF0gPT09ICJzdHJpbmciICkgewoJCQkJc3R5bGVzWyBrZXkgXSA9IHN0eWxlWyBrZXkgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gc3R5bGVzOwp9CgpmdW5jdGlvbiBzdHlsZURpZmZlcmVuY2UoIG9sZFN0eWxlLCBuZXdTdHlsZSApIHsKCXZhciBkaWZmID0ge30sCgkJbmFtZSwgdmFsdWU7CgoJZm9yICggbmFtZSBpbiBuZXdTdHlsZSApIHsKCQl2YWx1ZSA9IG5ld1N0eWxlWyBuYW1lIF07CgkJaWYgKCBvbGRTdHlsZVsgbmFtZSBdICE9PSB2YWx1ZSApIHsKCQkJaWYgKCAhc2hvcnRoYW5kU3R5bGVzWyBuYW1lIF0gKSB7CgkJCQlpZiAoICQuZnguc3RlcFsgbmFtZSBdIHx8ICFpc05hTiggcGFyc2VGbG9hdCggdmFsdWUgKSApICkgewoJCQkJCWRpZmZbIG5hbWUgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoKCXJldHVybiBkaWZmOwp9CgovLyBTdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkLmZuLmFkZEJhY2sgKSB7CgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9CgokLmVmZmVjdHMuYW5pbWF0ZUNsYXNzID0gZnVuY3Rpb24oIHZhbHVlLCBkdXJhdGlvbiwgZWFzaW5nLCBjYWxsYmFjayApIHsKCXZhciBvID0gJC5zcGVlZCggZHVyYXRpb24sIGVhc2luZywgY2FsbGJhY2sgKTsKCglyZXR1cm4gdGhpcy5xdWV1ZSggZnVuY3Rpb24oKSB7CgkJdmFyIGFuaW1hdGVkID0gJCggdGhpcyApLAoJCQliYXNlQ2xhc3MgPSBhbmltYXRlZC5hdHRyKCAiY2xhc3MiICkgfHwgIiIsCgkJCWFwcGx5Q2xhc3NDaGFuZ2UsCgkJCWFsbEFuaW1hdGlvbnMgPSBvLmNoaWxkcmVuID8gYW5pbWF0ZWQuZmluZCggIioiICkuYWRkQmFjaygpIDogYW5pbWF0ZWQ7CgoJCS8vIE1hcCB0aGUgYW5pbWF0ZWQgb2JqZWN0cyB0byBzdG9yZSB0aGUgb3JpZ2luYWwgc3R5bGVzLgoJCWFsbEFuaW1hdGlvbnMgPSBhbGxBbmltYXRpb25zLm1hcCggZnVuY3Rpb24oKSB7CgkJCXZhciBlbCA9ICQoIHRoaXMgKTsKCQkJcmV0dXJuIHsKCQkJCWVsOiBlbCwKCQkJCXN0YXJ0OiBnZXRFbGVtZW50U3R5bGVzKCB0aGlzICkKCQkJfTsKCQl9ICk7CgoJCS8vIEFwcGx5IGNsYXNzIGNoYW5nZQoJCWFwcGx5Q2xhc3NDaGFuZ2UgPSBmdW5jdGlvbigpIHsKCQkJJC5lYWNoKCBjbGFzc0FuaW1hdGlvbkFjdGlvbnMsIGZ1bmN0aW9uKCBpLCBhY3Rpb24gKSB7CgkJCQlpZiAoIHZhbHVlWyBhY3Rpb24gXSApIHsKCQkJCQlhbmltYXRlZFsgYWN0aW9uICsgIkNsYXNzIiBdKCB2YWx1ZVsgYWN0aW9uIF0gKTsKCQkJCX0KCQkJfSApOwoJCX07CgkJYXBwbHlDbGFzc0NoYW5nZSgpOwoKCQkvLyBNYXAgYWxsIGFuaW1hdGVkIG9iamVjdHMgYWdhaW4gLSBjYWxjdWxhdGUgbmV3IHN0eWxlcyBhbmQgZGlmZgoJCWFsbEFuaW1hdGlvbnMgPSBhbGxBbmltYXRpb25zLm1hcCggZnVuY3Rpb24oKSB7CgkJCXRoaXMuZW5kID0gZ2V0RWxlbWVudFN0eWxlcyggdGhpcy5lbFsgMCBdICk7CgkJCXRoaXMuZGlmZiA9IHN0eWxlRGlmZmVyZW5jZSggdGhpcy5zdGFydCwgdGhpcy5lbmQgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSApOwoKCQkvLyBBcHBseSBvcmlnaW5hbCBjbGFzcwoJCWFuaW1hdGVkLmF0dHIoICJjbGFzcyIsIGJhc2VDbGFzcyApOwoKCQkvLyBNYXAgYWxsIGFuaW1hdGVkIG9iamVjdHMgYWdhaW4gLSB0aGlzIHRpbWUgY29sbGVjdGluZyBhIHByb21pc2UKCQlhbGxBbmltYXRpb25zID0gYWxsQW5pbWF0aW9ucy5tYXAoIGZ1bmN0aW9uKCkgewoJCQl2YXIgc3R5bGVJbmZvID0gdGhpcywKCQkJCWRmZCA9ICQuRGVmZXJyZWQoKSwKCQkJCW9wdHMgPSAkLmV4dGVuZCgge30sIG8sIHsKCQkJCQlxdWV1ZTogZmFsc2UsCgkJCQkJY29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCQkJCQlkZmQucmVzb2x2ZSggc3R5bGVJbmZvICk7CgkJCQkJfQoJCQkJfSApOwoKCQkJdGhpcy5lbC5hbmltYXRlKCB0aGlzLmRpZmYsIG9wdHMgKTsKCQkJcmV0dXJuIGRmZC5wcm9taXNlKCk7CgkJfSApOwoKCQkvLyBPbmNlIGFsbCBhbmltYXRpb25zIGhhdmUgY29tcGxldGVkOgoJCSQud2hlbi5hcHBseSggJCwgYWxsQW5pbWF0aW9ucy5nZXQoKSApLmRvbmUoIGZ1bmN0aW9uKCkgewoKCQkJLy8gU2V0IHRoZSBmaW5hbCBjbGFzcwoJCQlhcHBseUNsYXNzQ2hhbmdlKCk7CgoJCQkvLyBGb3IgZWFjaCBhbmltYXRlZCBlbGVtZW50LAoJCQkvLyBjbGVhciBhbGwgY3NzIHByb3BlcnRpZXMgdGhhdCB3ZXJlIGFuaW1hdGVkCgkJCSQuZWFjaCggYXJndW1lbnRzLCBmdW5jdGlvbigpIHsKCQkJCXZhciBlbCA9IHRoaXMuZWw7CgkJCQkkLmVhY2goIHRoaXMuZGlmZiwgZnVuY3Rpb24oIGtleSApIHsKCQkJCQllbC5jc3MoIGtleSwgIiIgKTsKCQkJCX0gKTsKCQkJfSApOwoKCQkJLy8gVGhpcyBpcyBndWFybnRlZWQgdG8gYmUgdGhlcmUgaWYgeW91IHVzZSBqUXVlcnkuc3BlZWQoKQoJCQkvLyBpdCBhbHNvIGhhbmRsZXMgZGVxdWV1aW5nIHRoZSBuZXh0IGFuaW0uLi4KCQkJby5jb21wbGV0ZS5jYWxsKCBhbmltYXRlZFsgMCBdICk7CgkJfSApOwoJfSApOwp9OwoKJC5mbi5leHRlbmQoIHsKCWFkZENsYXNzOiAoIGZ1bmN0aW9uKCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggY2xhc3NOYW1lcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJCXJldHVybiBzcGVlZCA/CgkJCQkkLmVmZmVjdHMuYW5pbWF0ZUNsYXNzLmNhbGwoIHRoaXMsCgkJCQkJeyBhZGQ6IGNsYXNzTmFtZXMgfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSA6CgkJCQlvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9OwoJfSApKCAkLmZuLmFkZENsYXNzICksCgoJcmVtb3ZlQ2xhc3M6ICggZnVuY3Rpb24oIG9yaWcgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBjbGFzc05hbWVzLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAxID8KCQkJCSQuZWZmZWN0cy5hbmltYXRlQ2xhc3MuY2FsbCggdGhpcywKCQkJCQl7IHJlbW92ZTogY2xhc3NOYW1lcyB9LCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIDoKCQkJCW9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCX07Cgl9ICkoICQuZm4ucmVtb3ZlQ2xhc3MgKSwKCgl0b2dnbGVDbGFzczogKCBmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGNsYXNzTmFtZXMsIGZvcmNlLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQkJaWYgKCB0eXBlb2YgZm9yY2UgPT09ICJib29sZWFuIiB8fCBmb3JjZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCAhc3BlZWQgKSB7CgoJCQkJCS8vIFdpdGhvdXQgc3BlZWQgcGFyYW1ldGVyCgkJCQkJcmV0dXJuIG9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gJC5lZmZlY3RzLmFuaW1hdGVDbGFzcy5jYWxsKCB0aGlzLAoJCQkJCQkoIGZvcmNlID8geyBhZGQ6IGNsYXNzTmFtZXMgfSA6IHsgcmVtb3ZlOiBjbGFzc05hbWVzIH0gKSwKCQkJCQkJc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCQkJCX0KCQkJfSBlbHNlIHsKCgkJCQkvLyBXaXRob3V0IGZvcmNlIHBhcmFtZXRlcgoJCQkJcmV0dXJuICQuZWZmZWN0cy5hbmltYXRlQ2xhc3MuY2FsbCggdGhpcywKCQkJCQl7IHRvZ2dsZTogY2xhc3NOYW1lcyB9LCBmb3JjZSwgc3BlZWQsIGVhc2luZyApOwoJCQl9CgkJfTsKCX0gKSggJC5mbi50b2dnbGVDbGFzcyApLAoKCXN3aXRjaENsYXNzOiBmdW5jdGlvbiggcmVtb3ZlLCBhZGQsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewoJCXJldHVybiAkLmVmZmVjdHMuYW5pbWF0ZUNsYXNzLmNhbGwoIHRoaXMsIHsKCQkJYWRkOiBhZGQsCgkJCXJlbW92ZTogcmVtb3ZlCgkJfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX0KfSApOwoKfSApKCk7CgovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiogRUZGRUNUUyAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKKCBmdW5jdGlvbigpIHsKCmlmICggJC5leHByICYmICQuZXhwci5maWx0ZXJzICYmICQuZXhwci5maWx0ZXJzLmFuaW1hdGVkICkgewoJJC5leHByLmZpbHRlcnMuYW5pbWF0ZWQgPSAoIGZ1bmN0aW9uKCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuICEhJCggZWxlbSApLmRhdGEoIGRhdGFTcGFjZUFuaW1hdGVkICkgfHwgb3JpZyggZWxlbSApOwoJCX07Cgl9ICkoICQuZXhwci5maWx0ZXJzLmFuaW1hdGVkICk7Cn0KCmlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICkgewoJJC5leHRlbmQoICQuZWZmZWN0cywgewoKCQkvLyBTYXZlcyBhIHNldCBvZiBwcm9wZXJ0aWVzIGluIGEgZGF0YSBzdG9yYWdlCgkJc2F2ZTogZnVuY3Rpb24oIGVsZW1lbnQsIHNldCApIHsKCQkJdmFyIGkgPSAwLCBsZW5ndGggPSBzZXQubGVuZ3RoOwoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCWlmICggc2V0WyBpIF0gIT09IG51bGwgKSB7CgkJCQkJZWxlbWVudC5kYXRhKCBkYXRhU3BhY2UgKyBzZXRbIGkgXSwgZWxlbWVudFsgMCBdLnN0eWxlWyBzZXRbIGkgXSBdICk7CgkJCQl9CgkJCX0KCQl9LAoKCQkvLyBSZXN0b3JlcyBhIHNldCBvZiBwcmV2aW91c2x5IHNhdmVkIHByb3BlcnRpZXMgZnJvbSBhIGRhdGEgc3RvcmFnZQoJCXJlc3RvcmU6IGZ1bmN0aW9uKCBlbGVtZW50LCBzZXQgKSB7CgkJCXZhciB2YWwsIGkgPSAwLCBsZW5ndGggPSBzZXQubGVuZ3RoOwoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCWlmICggc2V0WyBpIF0gIT09IG51bGwgKSB7CgkJCQkJdmFsID0gZWxlbWVudC5kYXRhKCBkYXRhU3BhY2UgKyBzZXRbIGkgXSApOwoJCQkJCWVsZW1lbnQuY3NzKCBzZXRbIGkgXSwgdmFsICk7CgkJCQl9CgkJCX0KCQl9LAoKCQlzZXRNb2RlOiBmdW5jdGlvbiggZWwsIG1vZGUgKSB7CgkJCWlmICggbW9kZSA9PT0gInRvZ2dsZSIgKSB7CgkJCQltb2RlID0gZWwuaXMoICI6aGlkZGVuIiApID8gInNob3ciIDogImhpZGUiOwoJCQl9CgkJCXJldHVybiBtb2RlOwoJCX0sCgoJCS8vIFdyYXBzIHRoZSBlbGVtZW50IGFyb3VuZCBhIHdyYXBwZXIgdGhhdCBjb3BpZXMgcG9zaXRpb24gcHJvcGVydGllcwoJCWNyZWF0ZVdyYXBwZXI6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoKCQkJLy8gSWYgdGhlIGVsZW1lbnQgaXMgYWxyZWFkeSB3cmFwcGVkLCByZXR1cm4gaXQKCQkJaWYgKCBlbGVtZW50LnBhcmVudCgpLmlzKCAiLnVpLWVmZmVjdHMtd3JhcHBlciIgKSApIHsKCQkJCXJldHVybiBlbGVtZW50LnBhcmVudCgpOwoJCQl9CgoJCQkvLyBXcmFwIHRoZSBlbGVtZW50CgkJCXZhciBwcm9wcyA9IHsKCQkJCQl3aWR0aDogZWxlbWVudC5vdXRlcldpZHRoKCB0cnVlICksCgkJCQkJaGVpZ2h0OiBlbGVtZW50Lm91dGVySGVpZ2h0KCB0cnVlICksCgkJCQkJImZsb2F0IjogZWxlbWVudC5jc3MoICJmbG9hdCIgKQoJCQkJfSwKCQkJCXdyYXBwZXIgPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1lZmZlY3RzLXdyYXBwZXIiICkKCQkJCQkuY3NzKCB7CgkJCQkJCWZvbnRTaXplOiAiMTAwJSIsCgkJCQkJCWJhY2tncm91bmQ6ICJ0cmFuc3BhcmVudCIsCgkJCQkJCWJvcmRlcjogIm5vbmUiLAoJCQkJCQltYXJnaW46IDAsCgkJCQkJCXBhZGRpbmc6IDAKCQkJCQl9ICksCgoJCQkJLy8gU3RvcmUgdGhlIHNpemUgaW4gY2FzZSB3aWR0aC9oZWlnaHQgYXJlIGRlZmluZWQgaW4gJSAtIEZpeGVzICM1MjQ1CgkJCQlzaXplID0gewoJCQkJCXdpZHRoOiBlbGVtZW50LndpZHRoKCksCgkJCQkJaGVpZ2h0OiBlbGVtZW50LmhlaWdodCgpCgkJCQl9LAoJCQkJYWN0aXZlID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKCgkJCS8vIFN1cHBvcnQ6IEZpcmVmb3gKCQkJLy8gRmlyZWZveCBpbmNvcnJlY3RseSBleHBvc2VzIGFub255bW91cyBjb250ZW50CgkJCS8vIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTU2MTY2NAoJCQl0cnkgewoJCQkJYWN0aXZlLmlkOwoJCQl9IGNhdGNoICggZSApIHsKCQkJCWFjdGl2ZSA9IGRvY3VtZW50LmJvZHk7CgkJCX0KCgkJCWVsZW1lbnQud3JhcCggd3JhcHBlciApOwoKCQkJLy8gRml4ZXMgIzc1OTUgLSBFbGVtZW50cyBsb3NlIGZvY3VzIHdoZW4gd3JhcHBlZC4KCQkJaWYgKCBlbGVtZW50WyAwIF0gPT09IGFjdGl2ZSB8fCAkLmNvbnRhaW5zKCBlbGVtZW50WyAwIF0sIGFjdGl2ZSApICkgewoJCQkJJCggYWN0aXZlICkudHJpZ2dlciggImZvY3VzIiApOwoJCQl9CgoJCQkvLyBIb3RmaXggZm9yIGpRdWVyeSAxLjQgc2luY2Ugc29tZSBjaGFuZ2UgaW4gd3JhcCgpIHNlZW1zIHRvIGFjdHVhbGx5CgkJCS8vIGxvc2UgdGhlIHJlZmVyZW5jZSB0byB0aGUgd3JhcHBlZCBlbGVtZW50CgkJCXdyYXBwZXIgPSBlbGVtZW50LnBhcmVudCgpOwoKCQkJLy8gVHJhbnNmZXIgcG9zaXRpb25pbmcgcHJvcGVydGllcyB0byB0aGUgd3JhcHBlcgoJCQlpZiAoIGVsZW1lbnQuY3NzKCAicG9zaXRpb24iICkgPT09ICJzdGF0aWMiICkgewoJCQkJd3JhcHBlci5jc3MoIHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSApOwoJCQkJZWxlbWVudC5jc3MoIHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSApOwoJCQl9IGVsc2UgewoJCQkJJC5leHRlbmQoIHByb3BzLCB7CgkJCQkJcG9zaXRpb246IGVsZW1lbnQuY3NzKCAicG9zaXRpb24iICksCgkJCQkJekluZGV4OiBlbGVtZW50LmNzcyggInotaW5kZXgiICkKCQkJCX0gKTsKCQkJCSQuZWFjaCggWyAidG9wIiwgImxlZnQiLCAiYm90dG9tIiwgInJpZ2h0IiBdLCBmdW5jdGlvbiggaSwgcG9zICkgewoJCQkJCXByb3BzWyBwb3MgXSA9IGVsZW1lbnQuY3NzKCBwb3MgKTsKCQkJCQlpZiAoIGlzTmFOKCBwYXJzZUludCggcHJvcHNbIHBvcyBdLCAxMCApICkgKSB7CgkJCQkJCXByb3BzWyBwb3MgXSA9ICJhdXRvIjsKCQkJCQl9CgkJCQl9ICk7CgkJCQllbGVtZW50LmNzcyggewoJCQkJCXBvc2l0aW9uOiAicmVsYXRpdmUiLAoJCQkJCXRvcDogMCwKCQkJCQlsZWZ0OiAwLAoJCQkJCXJpZ2h0OiAiYXV0byIsCgkJCQkJYm90dG9tOiAiYXV0byIKCQkJCX0gKTsKCQkJfQoJCQllbGVtZW50LmNzcyggc2l6ZSApOwoKCQkJcmV0dXJuIHdyYXBwZXIuY3NzKCBwcm9wcyApLnNob3coKTsKCQl9LAoKCQlyZW1vdmVXcmFwcGVyOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQkJdmFyIGFjdGl2ZSA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CgoJCQlpZiAoIGVsZW1lbnQucGFyZW50KCkuaXMoICIudWktZWZmZWN0cy13cmFwcGVyIiApICkgewoJCQkJZWxlbWVudC5wYXJlbnQoKS5yZXBsYWNlV2l0aCggZWxlbWVudCApOwoKCQkJCS8vIEZpeGVzICM3NTk1IC0gRWxlbWVudHMgbG9zZSBmb2N1cyB3aGVuIHdyYXBwZWQuCgkJCQlpZiAoIGVsZW1lbnRbIDAgXSA9PT0gYWN0aXZlIHx8ICQuY29udGFpbnMoIGVsZW1lbnRbIDAgXSwgYWN0aXZlICkgKSB7CgkJCQkJJCggYWN0aXZlICkudHJpZ2dlciggImZvY3VzIiApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gZWxlbWVudDsKCQl9Cgl9ICk7Cn0KCiQuZXh0ZW5kKCAkLmVmZmVjdHMsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoKCWRlZmluZTogZnVuY3Rpb24oIG5hbWUsIG1vZGUsIGVmZmVjdCApIHsKCQlpZiAoICFlZmZlY3QgKSB7CgkJCWVmZmVjdCA9IG1vZGU7CgkJCW1vZGUgPSAiZWZmZWN0IjsKCQl9CgoJCSQuZWZmZWN0cy5lZmZlY3RbIG5hbWUgXSA9IGVmZmVjdDsKCQkkLmVmZmVjdHMuZWZmZWN0WyBuYW1lIF0ubW9kZSA9IG1vZGU7CgoJCXJldHVybiBlZmZlY3Q7Cgl9LAoKCXNjYWxlZERpbWVuc2lvbnM6IGZ1bmN0aW9uKCBlbGVtZW50LCBwZXJjZW50LCBkaXJlY3Rpb24gKSB7CgkJaWYgKCBwZXJjZW50ID09PSAwICkgewoJCQlyZXR1cm4gewoJCQkJaGVpZ2h0OiAwLAoJCQkJd2lkdGg6IDAsCgkJCQlvdXRlckhlaWdodDogMCwKCQkJCW91dGVyV2lkdGg6IDAKCQkJfTsKCQl9CgoJCXZhciB4ID0gZGlyZWN0aW9uICE9PSAiaG9yaXpvbnRhbCIgPyAoICggcGVyY2VudCB8fCAxMDAgKSAvIDEwMCApIDogMSwKCQkJeSA9IGRpcmVjdGlvbiAhPT0gInZlcnRpY2FsIiA/ICggKCBwZXJjZW50IHx8IDEwMCApIC8gMTAwICkgOiAxOwoKCQlyZXR1cm4gewoJCQloZWlnaHQ6IGVsZW1lbnQuaGVpZ2h0KCkgKiB5LAoJCQl3aWR0aDogZWxlbWVudC53aWR0aCgpICogeCwKCQkJb3V0ZXJIZWlnaHQ6IGVsZW1lbnQub3V0ZXJIZWlnaHQoKSAqIHksCgkJCW91dGVyV2lkdGg6IGVsZW1lbnQub3V0ZXJXaWR0aCgpICogeAoJCX07CgoJfSwKCgljbGlwVG9Cb3g6IGZ1bmN0aW9uKCBhbmltYXRpb24gKSB7CgkJcmV0dXJuIHsKCQkJd2lkdGg6IGFuaW1hdGlvbi5jbGlwLnJpZ2h0IC0gYW5pbWF0aW9uLmNsaXAubGVmdCwKCQkJaGVpZ2h0OiBhbmltYXRpb24uY2xpcC5ib3R0b20gLSBhbmltYXRpb24uY2xpcC50b3AsCgkJCWxlZnQ6IGFuaW1hdGlvbi5jbGlwLmxlZnQsCgkJCXRvcDogYW5pbWF0aW9uLmNsaXAudG9wCgkJfTsKCX0sCgoJLy8gSW5qZWN0cyByZWNlbnRseSBxdWV1ZWQgZnVuY3Rpb25zIHRvIGJlIGZpcnN0IGluIGxpbmUgKGFmdGVyICJpbnByb2dyZXNzIikKCXVuc2hpZnQ6IGZ1bmN0aW9uKCBlbGVtZW50LCBxdWV1ZUxlbmd0aCwgY291bnQgKSB7CgkJdmFyIHF1ZXVlID0gZWxlbWVudC5xdWV1ZSgpOwoKCQlpZiAoIHF1ZXVlTGVuZ3RoID4gMSApIHsKCQkJcXVldWUuc3BsaWNlLmFwcGx5KCBxdWV1ZSwKCQkJCVsgMSwgMCBdLmNvbmNhdCggcXVldWUuc3BsaWNlKCBxdWV1ZUxlbmd0aCwgY291bnQgKSApICk7CgkJfQoJCWVsZW1lbnQuZGVxdWV1ZSgpOwoJfSwKCglzYXZlU3R5bGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCWVsZW1lbnQuZGF0YSggZGF0YVNwYWNlU3R5bGUsIGVsZW1lbnRbIDAgXS5zdHlsZS5jc3NUZXh0ICk7Cgl9LAoKCXJlc3RvcmVTdHlsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJZWxlbWVudFsgMCBdLnN0eWxlLmNzc1RleHQgPSBlbGVtZW50LmRhdGEoIGRhdGFTcGFjZVN0eWxlICkgfHwgIiI7CgkJZWxlbWVudC5yZW1vdmVEYXRhKCBkYXRhU3BhY2VTdHlsZSApOwoJfSwKCgltb2RlOiBmdW5jdGlvbiggZWxlbWVudCwgbW9kZSApIHsKCQl2YXIgaGlkZGVuID0gZWxlbWVudC5pcyggIjpoaWRkZW4iICk7CgoJCWlmICggbW9kZSA9PT0gInRvZ2dsZSIgKSB7CgkJCW1vZGUgPSBoaWRkZW4gPyAic2hvdyIgOiAiaGlkZSI7CgkJfQoJCWlmICggaGlkZGVuID8gbW9kZSA9PT0gImhpZGUiIDogbW9kZSA9PT0gInNob3ciICkgewoJCQltb2RlID0gIm5vbmUiOwoJCX0KCQlyZXR1cm4gbW9kZTsKCX0sCgoJLy8gVHJhbnNsYXRlcyBhIFt0b3AsbGVmdF0gYXJyYXkgaW50byBhIGJhc2VsaW5lIHZhbHVlCglnZXRCYXNlbGluZTogZnVuY3Rpb24oIG9yaWdpbiwgb3JpZ2luYWwgKSB7CgkJdmFyIHksIHg7CgoJCXN3aXRjaCAoIG9yaWdpblsgMCBdICkgewoJCWNhc2UgInRvcCI6CgkJCXkgPSAwOwoJCQlicmVhazsKCQljYXNlICJtaWRkbGUiOgoJCQl5ID0gMC41OwoJCQlicmVhazsKCQljYXNlICJib3R0b20iOgoJCQl5ID0gMTsKCQkJYnJlYWs7CgkJZGVmYXVsdDoKCQkJeSA9IG9yaWdpblsgMCBdIC8gb3JpZ2luYWwuaGVpZ2h0OwoJCX0KCgkJc3dpdGNoICggb3JpZ2luWyAxIF0gKSB7CgkJY2FzZSAibGVmdCI6CgkJCXggPSAwOwoJCQlicmVhazsKCQljYXNlICJjZW50ZXIiOgoJCQl4ID0gMC41OwoJCQlicmVhazsKCQljYXNlICJyaWdodCI6CgkJCXggPSAxOwoJCQlicmVhazsKCQlkZWZhdWx0OgoJCQl4ID0gb3JpZ2luWyAxIF0gLyBvcmlnaW5hbC53aWR0aDsKCQl9CgoJCXJldHVybiB7CgkJCXg6IHgsCgkJCXk6IHkKCQl9OwoJfSwKCgkvLyBDcmVhdGVzIGEgcGxhY2Vob2xkZXIgZWxlbWVudCBzbyB0aGF0IHRoZSBvcmlnaW5hbCBlbGVtZW50IGNhbiBiZSBtYWRlIGFic29sdXRlCgljcmVhdGVQbGFjZWhvbGRlcjogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdmFyIHBsYWNlaG9sZGVyLAoJCQljc3NQb3NpdGlvbiA9IGVsZW1lbnQuY3NzKCAicG9zaXRpb24iICksCgkJCXBvc2l0aW9uID0gZWxlbWVudC5wb3NpdGlvbigpOwoKCQkvLyBMb2NrIGluIG1hcmdpbnMgZmlyc3QgdG8gYWNjb3VudCBmb3IgZm9ybSBlbGVtZW50cywgd2hpY2gKCQkvLyB3aWxsIGNoYW5nZSBtYXJnaW4gaWYgeW91IGV4cGxpY2l0bHkgc2V0IGhlaWdodAoJCS8vIHNlZTogaHR0cDovL2pzZmlkZGxlLm5ldC9KWlNNdC8zLyBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MTA3MzgwCgkJLy8gU3VwcG9ydDogU2FmYXJpCgkJZWxlbWVudC5jc3MoIHsKCQkJbWFyZ2luVG9wOiBlbGVtZW50LmNzcyggIm1hcmdpblRvcCIgKSwKCQkJbWFyZ2luQm90dG9tOiBlbGVtZW50LmNzcyggIm1hcmdpbkJvdHRvbSIgKSwKCQkJbWFyZ2luTGVmdDogZWxlbWVudC5jc3MoICJtYXJnaW5MZWZ0IiApLAoJCQltYXJnaW5SaWdodDogZWxlbWVudC5jc3MoICJtYXJnaW5SaWdodCIgKQoJCX0gKQoJCS5vdXRlcldpZHRoKCBlbGVtZW50Lm91dGVyV2lkdGgoKSApCgkJLm91dGVySGVpZ2h0KCBlbGVtZW50Lm91dGVySGVpZ2h0KCkgKTsKCgkJaWYgKCAvXihzdGF0aWN8cmVsYXRpdmUpLy50ZXN0KCBjc3NQb3NpdGlvbiApICkgewoJCQljc3NQb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CgoJCQlwbGFjZWhvbGRlciA9ICQoICI8IiArIGVsZW1lbnRbIDAgXS5ub2RlTmFtZSArICI+IiApLmluc2VydEFmdGVyKCBlbGVtZW50ICkuY3NzKCB7CgoJCQkJLy8gQ29udmVydCBpbmxpbmUgdG8gaW5saW5lIGJsb2NrIHRvIGFjY291bnQgZm9yIGlubGluZSBlbGVtZW50cwoJCQkJLy8gdGhhdCB0dXJuIHRvIGlubGluZSBibG9jayBiYXNlZCBvbiBjb250ZW50IChsaWtlIGltZykKCQkJCWRpc3BsYXk6IC9eKGlubGluZXxydWJ5KS8udGVzdCggZWxlbWVudC5jc3MoICJkaXNwbGF5IiApICkgPwoJCQkJCSJpbmxpbmUtYmxvY2siIDoKCQkJCQkiYmxvY2siLAoJCQkJdmlzaWJpbGl0eTogImhpZGRlbiIsCgoJCQkJLy8gTWFyZ2lucyBuZWVkIHRvIGJlIHNldCB0byBhY2NvdW50IGZvciBtYXJnaW4gY29sbGFwc2UKCQkJCW1hcmdpblRvcDogZWxlbWVudC5jc3MoICJtYXJnaW5Ub3AiICksCgkJCQltYXJnaW5Cb3R0b206IGVsZW1lbnQuY3NzKCAibWFyZ2luQm90dG9tIiApLAoJCQkJbWFyZ2luTGVmdDogZWxlbWVudC5jc3MoICJtYXJnaW5MZWZ0IiApLAoJCQkJbWFyZ2luUmlnaHQ6IGVsZW1lbnQuY3NzKCAibWFyZ2luUmlnaHQiICksCgkJCQkiZmxvYXQiOiBlbGVtZW50LmNzcyggImZsb2F0IiApCgkJCX0gKQoJCQkub3V0ZXJXaWR0aCggZWxlbWVudC5vdXRlcldpZHRoKCkgKQoJCQkub3V0ZXJIZWlnaHQoIGVsZW1lbnQub3V0ZXJIZWlnaHQoKSApCgkJCS5hZGRDbGFzcyggInVpLWVmZmVjdHMtcGxhY2Vob2xkZXIiICk7CgoJCQllbGVtZW50LmRhdGEoIGRhdGFTcGFjZSArICJwbGFjZWhvbGRlciIsIHBsYWNlaG9sZGVyICk7CgkJfQoKCQllbGVtZW50LmNzcyggewoJCQlwb3NpdGlvbjogY3NzUG9zaXRpb24sCgkJCWxlZnQ6IHBvc2l0aW9uLmxlZnQsCgkJCXRvcDogcG9zaXRpb24udG9wCgkJfSApOwoKCQlyZXR1cm4gcGxhY2Vob2xkZXI7Cgl9LAoKCXJlbW92ZVBsYWNlaG9sZGVyOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgZGF0YUtleSA9IGRhdGFTcGFjZSArICJwbGFjZWhvbGRlciIsCgkJCQlwbGFjZWhvbGRlciA9IGVsZW1lbnQuZGF0YSggZGF0YUtleSApOwoKCQlpZiAoIHBsYWNlaG9sZGVyICkgewoJCQlwbGFjZWhvbGRlci5yZW1vdmUoKTsKCQkJZWxlbWVudC5yZW1vdmVEYXRhKCBkYXRhS2V5ICk7CgkJfQoJfSwKCgkvLyBSZW1vdmVzIGEgcGxhY2Vob2xkZXIgaWYgaXQgZXhpc3RzIGFuZCByZXN0b3JlcwoJLy8gcHJvcGVydGllcyB0aGF0IHdlcmUgbW9kaWZpZWQgZHVyaW5nIHBsYWNlaG9sZGVyIGNyZWF0aW9uCgljbGVhblVwOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQkkLmVmZmVjdHMucmVzdG9yZVN0eWxlKCBlbGVtZW50ICk7CgkJJC5lZmZlY3RzLnJlbW92ZVBsYWNlaG9sZGVyKCBlbGVtZW50ICk7Cgl9LAoKCXNldFRyYW5zaXRpb246IGZ1bmN0aW9uKCBlbGVtZW50LCBsaXN0LCBmYWN0b3IsIHZhbHVlICkgewoJCXZhbHVlID0gdmFsdWUgfHwge307CgkJJC5lYWNoKCBsaXN0LCBmdW5jdGlvbiggaSwgeCApIHsKCQkJdmFyIHVuaXQgPSBlbGVtZW50LmNzc1VuaXQoIHggKTsKCQkJaWYgKCB1bml0WyAwIF0gPiAwICkgewoJCQkJdmFsdWVbIHggXSA9IHVuaXRbIDAgXSAqIGZhY3RvciArIHVuaXRbIDEgXTsKCQkJfQoJCX0gKTsKCQlyZXR1cm4gdmFsdWU7Cgl9Cn0gKTsKCi8vIFJldHVybiBhbiBlZmZlY3Qgb3B0aW9ucyBvYmplY3QgZm9yIHRoZSBnaXZlbiBwYXJhbWV0ZXJzOgpmdW5jdGlvbiBfbm9ybWFsaXplQXJndW1lbnRzKCBlZmZlY3QsIG9wdGlvbnMsIHNwZWVkLCBjYWxsYmFjayApIHsKCgkvLyBBbGxvdyBwYXNzaW5nIGFsbCBvcHRpb25zIGFzIHRoZSBmaXJzdCBwYXJhbWV0ZXIKCWlmICggJC5pc1BsYWluT2JqZWN0KCBlZmZlY3QgKSApIHsKCQlvcHRpb25zID0gZWZmZWN0OwoJCWVmZmVjdCA9IGVmZmVjdC5lZmZlY3Q7Cgl9CgoJLy8gQ29udmVydCB0byBhbiBvYmplY3QKCWVmZmVjdCA9IHsgZWZmZWN0OiBlZmZlY3QgfTsKCgkvLyBDYXRjaCAoZWZmZWN0LCBudWxsLCAuLi4pCglpZiAoIG9wdGlvbnMgPT0gbnVsbCApIHsKCQlvcHRpb25zID0ge307Cgl9CgoJLy8gQ2F0Y2ggKGVmZmVjdCwgY2FsbGJhY2spCglpZiAoICQuaXNGdW5jdGlvbiggb3B0aW9ucyApICkgewoJCWNhbGxiYWNrID0gb3B0aW9uczsKCQlzcGVlZCA9IG51bGw7CgkJb3B0aW9ucyA9IHt9OwoJfQoKCS8vIENhdGNoIChlZmZlY3QsIHNwZWVkLCA/KQoJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgfHwgJC5meC5zcGVlZHNbIG9wdGlvbnMgXSApIHsKCQljYWxsYmFjayA9IHNwZWVkOwoJCXNwZWVkID0gb3B0aW9uczsKCQlvcHRpb25zID0ge307Cgl9CgoJLy8gQ2F0Y2ggKGVmZmVjdCwgb3B0aW9ucywgY2FsbGJhY2spCglpZiAoICQuaXNGdW5jdGlvbiggc3BlZWQgKSApIHsKCQljYWxsYmFjayA9IHNwZWVkOwoJCXNwZWVkID0gbnVsbDsKCX0KCgkvLyBBZGQgb3B0aW9ucyB0byBlZmZlY3QKCWlmICggb3B0aW9ucyApIHsKCQkkLmV4dGVuZCggZWZmZWN0LCBvcHRpb25zICk7Cgl9CgoJc3BlZWQgPSBzcGVlZCB8fCBvcHRpb25zLmR1cmF0aW9uOwoJZWZmZWN0LmR1cmF0aW9uID0gJC5meC5vZmYgPyAwIDoKCQl0eXBlb2Ygc3BlZWQgPT09ICJudW1iZXIiID8gc3BlZWQgOgoJCXNwZWVkIGluICQuZnguc3BlZWRzID8gJC5meC5zcGVlZHNbIHNwZWVkIF0gOgoJCSQuZnguc3BlZWRzLl9kZWZhdWx0OwoKCWVmZmVjdC5jb21wbGV0ZSA9IGNhbGxiYWNrIHx8IG9wdGlvbnMuY29tcGxldGU7CgoJcmV0dXJuIGVmZmVjdDsKfQoKZnVuY3Rpb24gc3RhbmRhcmRBbmltYXRpb25PcHRpb24oIG9wdGlvbiApIHsKCgkvLyBWYWxpZCBzdGFuZGFyZCBzcGVlZHMgKG5vdGhpbmcsIG51bWJlciwgbmFtZWQgc3BlZWQpCglpZiAoICFvcHRpb24gfHwgdHlwZW9mIG9wdGlvbiA9PT0gIm51bWJlciIgfHwgJC5meC5zcGVlZHNbIG9wdGlvbiBdICkgewoJCXJldHVybiB0cnVlOwoJfQoKCS8vIEludmFsaWQgc3RyaW5ncyAtIHRyZWF0IGFzICJub3JtYWwiIHNwZWVkCglpZiAoIHR5cGVvZiBvcHRpb24gPT09ICJzdHJpbmciICYmICEkLmVmZmVjdHMuZWZmZWN0WyBvcHRpb24gXSApIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCgkvLyBDb21wbGV0ZSBjYWxsYmFjawoJaWYgKCAkLmlzRnVuY3Rpb24oIG9wdGlvbiApICkgewoJCXJldHVybiB0cnVlOwoJfQoKCS8vIE9wdGlvbnMgaGFzaCAoYnV0IG5vdCBuYW1pbmcgYW4gZWZmZWN0KQoJaWYgKCB0eXBlb2Ygb3B0aW9uID09PSAib2JqZWN0IiAmJiAhb3B0aW9uLmVmZmVjdCApIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCgkvLyBEaWRuJ3QgbWF0Y2ggYW55IHN0YW5kYXJkIEFQSQoJcmV0dXJuIGZhbHNlOwp9CgokLmZuLmV4dGVuZCggewoJZWZmZWN0OiBmdW5jdGlvbiggLyogZWZmZWN0LCBvcHRpb25zLCBzcGVlZCwgY2FsbGJhY2sgKi8gKSB7CgkJdmFyIGFyZ3MgPSBfbm9ybWFsaXplQXJndW1lbnRzLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJZWZmZWN0TWV0aG9kID0gJC5lZmZlY3RzLmVmZmVjdFsgYXJncy5lZmZlY3QgXSwKCQkJZGVmYXVsdE1vZGUgPSBlZmZlY3RNZXRob2QubW9kZSwKCQkJcXVldWUgPSBhcmdzLnF1ZXVlLAoJCQlxdWV1ZU5hbWUgPSBxdWV1ZSB8fCAiZngiLAoJCQljb21wbGV0ZSA9IGFyZ3MuY29tcGxldGUsCgkJCW1vZGUgPSBhcmdzLm1vZGUsCgkJCW1vZGVzID0gW10sCgkJCXByZWZpbHRlciA9IGZ1bmN0aW9uKCBuZXh0ICkgewoJCQkJdmFyIGVsID0gJCggdGhpcyApLAoJCQkJCW5vcm1hbGl6ZWRNb2RlID0gJC5lZmZlY3RzLm1vZGUoIGVsLCBtb2RlICkgfHwgZGVmYXVsdE1vZGU7CgoJCQkJLy8gU2VudGluZWwgZm9yIGR1Y2stcHVuY2hpbmcgdGhlIDphbmltYXRlZCBwc3VlZG8tc2VsZWN0b3IKCQkJCWVsLmRhdGEoIGRhdGFTcGFjZUFuaW1hdGVkLCB0cnVlICk7CgoJCQkJLy8gU2F2ZSBlZmZlY3QgbW9kZSBmb3IgbGF0ZXIgdXNlLAoJCQkJLy8gd2UgY2FuJ3QganVzdCBjYWxsICQuZWZmZWN0cy5tb2RlIGFnYWluIGxhdGVyLAoJCQkJLy8gYXMgdGhlIC5zaG93KCkgYmVsb3cgZGVzdHJveXMgdGhlIGluaXRpYWwgc3RhdGUKCQkJCW1vZGVzLnB1c2goIG5vcm1hbGl6ZWRNb2RlICk7CgoJCQkJLy8gU2VlICQudWlCYWNrQ29tcGF0IGluc2lkZSBvZiBydW4oKSBmb3IgcmVtb3ZhbCBvZiBkZWZhdWx0TW9kZSBpbiAxLjEzCgkJCQlpZiAoIGRlZmF1bHRNb2RlICYmICggbm9ybWFsaXplZE1vZGUgPT09ICJzaG93IiB8fAoJCQkJCQkoIG5vcm1hbGl6ZWRNb2RlID09PSBkZWZhdWx0TW9kZSAmJiBub3JtYWxpemVkTW9kZSA9PT0gImhpZGUiICkgKSApIHsKCQkJCQllbC5zaG93KCk7CgkJCQl9CgoJCQkJaWYgKCAhZGVmYXVsdE1vZGUgfHwgbm9ybWFsaXplZE1vZGUgIT09ICJub25lIiApIHsKCQkJCQkkLmVmZmVjdHMuc2F2ZVN0eWxlKCBlbCApOwoJCQkJfQoKCQkJCWlmICggJC5pc0Z1bmN0aW9uKCBuZXh0ICkgKSB7CgkJCQkJbmV4dCgpOwoJCQkJfQoJCQl9OwoKCQlpZiAoICQuZngub2ZmIHx8ICFlZmZlY3RNZXRob2QgKSB7CgoJCQkvLyBEZWxlZ2F0ZSB0byB0aGUgb3JpZ2luYWwgbWV0aG9kIChlLmcuLCAuc2hvdygpKSBpZiBwb3NzaWJsZQoJCQlpZiAoIG1vZGUgKSB7CgkJCQlyZXR1cm4gdGhpc1sgbW9kZSBdKCBhcmdzLmR1cmF0aW9uLCBjb21wbGV0ZSApOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCBjb21wbGV0ZSApIHsKCQkJCQkJY29tcGxldGUuY2FsbCggdGhpcyApOwoJCQkJCX0KCQkJCX0gKTsKCQkJfQoJCX0KCgkJZnVuY3Rpb24gcnVuKCBuZXh0ICkgewoJCQl2YXIgZWxlbSA9ICQoIHRoaXMgKTsKCgkJCWZ1bmN0aW9uIGNsZWFudXAoKSB7CgkJCQllbGVtLnJlbW92ZURhdGEoIGRhdGFTcGFjZUFuaW1hdGVkICk7CgoJCQkJJC5lZmZlY3RzLmNsZWFuVXAoIGVsZW0gKTsKCgkJCQlpZiAoIGFyZ3MubW9kZSA9PT0gImhpZGUiICkgewoJCQkJCWVsZW0uaGlkZSgpOwoJCQkJfQoKCQkJCWRvbmUoKTsKCQkJfQoKCQkJZnVuY3Rpb24gZG9uZSgpIHsKCQkJCWlmICggJC5pc0Z1bmN0aW9uKCBjb21wbGV0ZSApICkgewoJCQkJCWNvbXBsZXRlLmNhbGwoIGVsZW1bIDAgXSApOwoJCQkJfQoKCQkJCWlmICggJC5pc0Z1bmN0aW9uKCBuZXh0ICkgKSB7CgkJCQkJbmV4dCgpOwoJCQkJfQoJCQl9CgoJCQkvLyBPdmVycmlkZSBtb2RlIG9wdGlvbiBvbiBhIHBlciBlbGVtZW50IGJhc2lzLAoJCQkvLyBhcyB0b2dnbGUgY2FuIGJlIGVpdGhlciBzaG93IG9yIGhpZGUgZGVwZW5kaW5nIG9uIGVsZW1lbnQgc3RhdGUKCQkJYXJncy5tb2RlID0gbW9kZXMuc2hpZnQoKTsKCgkJCWlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICYmICFkZWZhdWx0TW9kZSApIHsKCQkJCWlmICggZWxlbS5pcyggIjpoaWRkZW4iICkgPyBtb2RlID09PSAiaGlkZSIgOiBtb2RlID09PSAic2hvdyIgKSB7CgoJCQkJCS8vIENhbGwgdGhlIGNvcmUgbWV0aG9kIHRvIHRyYWNrICJvbGRkaXNwbGF5IiBwcm9wZXJseQoJCQkJCWVsZW1bIG1vZGUgXSgpOwoJCQkJCWRvbmUoKTsKCQkJCX0gZWxzZSB7CgkJCQkJZWZmZWN0TWV0aG9kLmNhbGwoIGVsZW1bIDAgXSwgYXJncywgZG9uZSApOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJaWYgKCBhcmdzLm1vZGUgPT09ICJub25lIiApIHsKCgkJCQkJLy8gQ2FsbCB0aGUgY29yZSBtZXRob2QgdG8gdHJhY2sgIm9sZGRpc3BsYXkiIHByb3Blcmx5CgkJCQkJZWxlbVsgbW9kZSBdKCk7CgkJCQkJZG9uZSgpOwoJCQkJfSBlbHNlIHsKCQkJCQllZmZlY3RNZXRob2QuY2FsbCggZWxlbVsgMCBdLCBhcmdzLCBjbGVhbnVwICk7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIFJ1biBwcmVmaWx0ZXIgb24gYWxsIGVsZW1lbnRzIGZpcnN0IHRvIGVuc3VyZSB0aGF0CgkJLy8gYW55IHNob3dpbmcgb3IgaGlkaW5nIGhhcHBlbnMgYmVmb3JlIHBsYWNlaG9sZGVyIGNyZWF0aW9uLAoJCS8vIHdoaWNoIGVuc3VyZXMgdGhhdCBhbnkgbGF5b3V0IGNoYW5nZXMgYXJlIGNvcnJlY3RseSBjYXB0dXJlZC4KCQlyZXR1cm4gcXVldWUgPT09IGZhbHNlID8KCQkJdGhpcy5lYWNoKCBwcmVmaWx0ZXIgKS5lYWNoKCBydW4gKSA6CgkJCXRoaXMucXVldWUoIHF1ZXVlTmFtZSwgcHJlZmlsdGVyICkucXVldWUoIHF1ZXVlTmFtZSwgcnVuICk7Cgl9LAoKCXNob3c6ICggZnVuY3Rpb24oIG9yaWcgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBvcHRpb24gKSB7CgkJCWlmICggc3RhbmRhcmRBbmltYXRpb25PcHRpb24oIG9wdGlvbiApICkgewoJCQkJcmV0dXJuIG9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9IGVsc2UgewoJCQkJdmFyIGFyZ3MgPSBfbm9ybWFsaXplQXJndW1lbnRzLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCWFyZ3MubW9kZSA9ICJzaG93IjsKCQkJCXJldHVybiB0aGlzLmVmZmVjdC5jYWxsKCB0aGlzLCBhcmdzICk7CgkJCX0KCQl9OwoJfSApKCAkLmZuLnNob3cgKSwKCgloaWRlOiAoIGZ1bmN0aW9uKCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggb3B0aW9uICkgewoJCQlpZiAoIHN0YW5kYXJkQW5pbWF0aW9uT3B0aW9uKCBvcHRpb24gKSApIHsKCQkJCXJldHVybiBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfSBlbHNlIHsKCQkJCXZhciBhcmdzID0gX25vcm1hbGl6ZUFyZ3VtZW50cy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQlhcmdzLm1vZGUgPSAiaGlkZSI7CgkJCQlyZXR1cm4gdGhpcy5lZmZlY3QuY2FsbCggdGhpcywgYXJncyApOwoJCQl9CgkJfTsKCX0gKSggJC5mbi5oaWRlICksCgoJdG9nZ2xlOiAoIGZ1bmN0aW9uKCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggb3B0aW9uICkgewoJCQlpZiAoIHN0YW5kYXJkQW5pbWF0aW9uT3B0aW9uKCBvcHRpb24gKSB8fCB0eXBlb2Ygb3B0aW9uID09PSAiYm9vbGVhbiIgKSB7CgkJCQlyZXR1cm4gb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX0gZWxzZSB7CgkJCQl2YXIgYXJncyA9IF9ub3JtYWxpemVBcmd1bWVudHMuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJYXJncy5tb2RlID0gInRvZ2dsZSI7CgkJCQlyZXR1cm4gdGhpcy5lZmZlY3QuY2FsbCggdGhpcywgYXJncyApOwoJCQl9CgkJfTsKCX0gKSggJC5mbi50b2dnbGUgKSwKCgljc3NVbml0OiBmdW5jdGlvbigga2V5ICkgewoJCXZhciBzdHlsZSA9IHRoaXMuY3NzKCBrZXkgKSwKCQkJdmFsID0gW107CgoJCSQuZWFjaCggWyAiZW0iLCAicHgiLCAiJSIsICJwdCIgXSwgZnVuY3Rpb24oIGksIHVuaXQgKSB7CgkJCWlmICggc3R5bGUuaW5kZXhPZiggdW5pdCApID4gMCApIHsKCQkJCXZhbCA9IFsgcGFyc2VGbG9hdCggc3R5bGUgKSwgdW5pdCBdOwoJCQl9CgkJfSApOwoJCXJldHVybiB2YWw7Cgl9LAoKCWNzc0NsaXA6IGZ1bmN0aW9uKCBjbGlwT2JqICkgewoJCWlmICggY2xpcE9iaiApIHsKCQkJcmV0dXJuIHRoaXMuY3NzKCAiY2xpcCIsICJyZWN0KCIgKyBjbGlwT2JqLnRvcCArICJweCAiICsgY2xpcE9iai5yaWdodCArICJweCAiICsKCQkJCWNsaXBPYmouYm90dG9tICsgInB4ICIgKyBjbGlwT2JqLmxlZnQgKyAicHgpIiApOwoJCX0KCQlyZXR1cm4gcGFyc2VDbGlwKCB0aGlzLmNzcyggImNsaXAiICksIHRoaXMgKTsKCX0sCgoJdHJhbnNmZXI6IGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgewoJCXZhciBlbGVtZW50ID0gJCggdGhpcyApLAoJCQl0YXJnZXQgPSAkKCBvcHRpb25zLnRvICksCgkJCXRhcmdldEZpeGVkID0gdGFyZ2V0LmNzcyggInBvc2l0aW9uIiApID09PSAiZml4ZWQiLAoJCQlib2R5ID0gJCggImJvZHkiICksCgkJCWZpeFRvcCA9IHRhcmdldEZpeGVkID8gYm9keS5zY3JvbGxUb3AoKSA6IDAsCgkJCWZpeExlZnQgPSB0YXJnZXRGaXhlZCA/IGJvZHkuc2Nyb2xsTGVmdCgpIDogMCwKCQkJZW5kUG9zaXRpb24gPSB0YXJnZXQub2Zmc2V0KCksCgkJCWFuaW1hdGlvbiA9IHsKCQkJCXRvcDogZW5kUG9zaXRpb24udG9wIC0gZml4VG9wLAoJCQkJbGVmdDogZW5kUG9zaXRpb24ubGVmdCAtIGZpeExlZnQsCgkJCQloZWlnaHQ6IHRhcmdldC5pbm5lckhlaWdodCgpLAoJCQkJd2lkdGg6IHRhcmdldC5pbm5lcldpZHRoKCkKCQkJfSwKCQkJc3RhcnRQb3NpdGlvbiA9IGVsZW1lbnQub2Zmc2V0KCksCgkJCXRyYW5zZmVyID0gJCggIjxkaXYgY2xhc3M9J3VpLWVmZmVjdHMtdHJhbnNmZXInPjwvZGl2PiIgKQoJCQkJLmFwcGVuZFRvKCAiYm9keSIgKQoJCQkJLmFkZENsYXNzKCBvcHRpb25zLmNsYXNzTmFtZSApCgkJCQkuY3NzKCB7CgkJCQkJdG9wOiBzdGFydFBvc2l0aW9uLnRvcCAtIGZpeFRvcCwKCQkJCQlsZWZ0OiBzdGFydFBvc2l0aW9uLmxlZnQgLSBmaXhMZWZ0LAoJCQkJCWhlaWdodDogZWxlbWVudC5pbm5lckhlaWdodCgpLAoJCQkJCXdpZHRoOiBlbGVtZW50LmlubmVyV2lkdGgoKSwKCQkJCQlwb3NpdGlvbjogdGFyZ2V0Rml4ZWQgPyAiZml4ZWQiIDogImFic29sdXRlIgoJCQkJfSApCgkJCQkuYW5pbWF0ZSggYW5pbWF0aW9uLCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgZnVuY3Rpb24oKSB7CgkJCQkJdHJhbnNmZXIucmVtb3ZlKCk7CgkJCQkJaWYgKCAkLmlzRnVuY3Rpb24oIGRvbmUgKSApIHsKCQkJCQkJZG9uZSgpOwoJCQkJCX0KCQkJCX0gKTsKCX0KfSApOwoKZnVuY3Rpb24gcGFyc2VDbGlwKCBzdHIsIGVsZW1lbnQgKSB7CgkJdmFyIG91dGVyV2lkdGggPSBlbGVtZW50Lm91dGVyV2lkdGgoKSwKCQkJb3V0ZXJIZWlnaHQgPSBlbGVtZW50Lm91dGVySGVpZ2h0KCksCgkJCWNsaXBSZWdleCA9IC9ecmVjdFwoKC0/XGQqXC4/XGQqcHh8LT9cZCslfGF1dG8pLD9ccyooLT9cZCpcLj9cZCpweHwtP1xkKyV8YXV0byksP1xzKigtP1xkKlwuP1xkKnB4fC0/XGQrJXxhdXRvKSw/XHMqKC0/XGQqXC4/XGQqcHh8LT9cZCslfGF1dG8pXCkkLywKCQkJdmFsdWVzID0gY2xpcFJlZ2V4LmV4ZWMoIHN0ciApIHx8IFsgIiIsIDAsIG91dGVyV2lkdGgsIG91dGVySGVpZ2h0LCAwIF07CgoJCXJldHVybiB7CgkJCXRvcDogcGFyc2VGbG9hdCggdmFsdWVzWyAxIF0gKSB8fCAwLAoJCQlyaWdodDogdmFsdWVzWyAyIF0gPT09ICJhdXRvIiA/IG91dGVyV2lkdGggOiBwYXJzZUZsb2F0KCB2YWx1ZXNbIDIgXSApLAoJCQlib3R0b206IHZhbHVlc1sgMyBdID09PSAiYXV0byIgPyBvdXRlckhlaWdodCA6IHBhcnNlRmxvYXQoIHZhbHVlc1sgMyBdICksCgkJCWxlZnQ6IHBhcnNlRmxvYXQoIHZhbHVlc1sgNCBdICkgfHwgMAoJCX07Cn0KCiQuZnguc3RlcC5jbGlwID0gZnVuY3Rpb24oIGZ4ICkgewoJaWYgKCAhZnguY2xpcEluaXQgKSB7CgkJZnguc3RhcnQgPSAkKCBmeC5lbGVtICkuY3NzQ2xpcCgpOwoJCWlmICggdHlwZW9mIGZ4LmVuZCA9PT0gInN0cmluZyIgKSB7CgkJCWZ4LmVuZCA9IHBhcnNlQ2xpcCggZnguZW5kLCBmeC5lbGVtICk7CgkJfQoJCWZ4LmNsaXBJbml0ID0gdHJ1ZTsKCX0KCgkkKCBmeC5lbGVtICkuY3NzQ2xpcCggewoJCXRvcDogZngucG9zICogKCBmeC5lbmQudG9wIC0gZnguc3RhcnQudG9wICkgKyBmeC5zdGFydC50b3AsCgkJcmlnaHQ6IGZ4LnBvcyAqICggZnguZW5kLnJpZ2h0IC0gZnguc3RhcnQucmlnaHQgKSArIGZ4LnN0YXJ0LnJpZ2h0LAoJCWJvdHRvbTogZngucG9zICogKCBmeC5lbmQuYm90dG9tIC0gZnguc3RhcnQuYm90dG9tICkgKyBmeC5zdGFydC5ib3R0b20sCgkJbGVmdDogZngucG9zICogKCBmeC5lbmQubGVmdCAtIGZ4LnN0YXJ0LmxlZnQgKSArIGZ4LnN0YXJ0LmxlZnQKCX0gKTsKfTsKCn0gKSgpOwoKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqIEVBU0lORyAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCiggZnVuY3Rpb24oKSB7CgovLyBCYXNlZCBvbiBlYXNpbmcgZXF1YXRpb25zIGZyb20gUm9iZXJ0IFBlbm5lciAoaHR0cDovL3d3dy5yb2JlcnRwZW5uZXIuY29tL2Vhc2luZykKCnZhciBiYXNlRWFzaW5ncyA9IHt9OwoKJC5lYWNoKCBbICJRdWFkIiwgIkN1YmljIiwgIlF1YXJ0IiwgIlF1aW50IiwgIkV4cG8iIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJYmFzZUVhc2luZ3NbIG5hbWUgXSA9IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiBNYXRoLnBvdyggcCwgaSArIDIgKTsKCX07Cn0gKTsKCiQuZXh0ZW5kKCBiYXNlRWFzaW5ncywgewoJU2luZTogZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIDEgLSBNYXRoLmNvcyggcCAqIE1hdGguUEkgLyAyICk7Cgl9LAoJQ2lyYzogZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIDEgLSBNYXRoLnNxcnQoIDEgLSBwICogcCApOwoJfSwKCUVsYXN0aWM6IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiBwID09PSAwIHx8IHAgPT09IDEgPyBwIDoKCQkJLU1hdGgucG93KCAyLCA4ICogKCBwIC0gMSApICkgKiBNYXRoLnNpbiggKCAoIHAgLSAxICkgKiA4MCAtIDcuNSApICogTWF0aC5QSSAvIDE1ICk7Cgl9LAoJQmFjazogZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIHAgKiBwICogKCAzICogcCAtIDIgKTsKCX0sCglCb3VuY2U6IGZ1bmN0aW9uKCBwICkgewoJCXZhciBwb3cyLAoJCQlib3VuY2UgPSA0OwoKCQl3aGlsZSAoIHAgPCAoICggcG93MiA9IE1hdGgucG93KCAyLCAtLWJvdW5jZSApICkgLSAxICkgLyAxMSApIHt9CgkJcmV0dXJuIDEgLyBNYXRoLnBvdyggNCwgMyAtIGJvdW5jZSApIC0gNy41NjI1ICogTWF0aC5wb3coICggcG93MiAqIDMgLSAyICkgLyAyMiAtIHAsIDIgKTsKCX0KfSApOwoKJC5lYWNoKCBiYXNlRWFzaW5ncywgZnVuY3Rpb24oIG5hbWUsIGVhc2VJbiApIHsKCSQuZWFzaW5nWyAiZWFzZUluIiArIG5hbWUgXSA9IGVhc2VJbjsKCSQuZWFzaW5nWyAiZWFzZU91dCIgKyBuYW1lIF0gPSBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gMSAtIGVhc2VJbiggMSAtIHAgKTsKCX07CgkkLmVhc2luZ1sgImVhc2VJbk91dCIgKyBuYW1lIF0gPSBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gcCA8IDAuNSA/CgkJCWVhc2VJbiggcCAqIDIgKSAvIDIgOgoJCQkxIC0gZWFzZUluKCBwICogLTIgKyAyICkgLyAyOwoJfTsKfSApOwoKfSApKCk7Cgp2YXIgZWZmZWN0ID0gJC5lZmZlY3RzOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyBCbGluZCAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IEJsaW5kIEVmZmVjdAovLz4+Z3JvdXA6IEVmZmVjdHMKLy8+PmRlc2NyaXB0aW9uOiBCbGluZHMgdGhlIGVsZW1lbnQuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9ibGluZC1lZmZlY3QvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvCgoKCnZhciBlZmZlY3RzRWZmZWN0QmxpbmQgPSAkLmVmZmVjdHMuZGVmaW5lKCAiYmxpbmQiLCAiaGlkZSIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgewoJdmFyIG1hcCA9IHsKCQkJdXA6IFsgImJvdHRvbSIsICJ0b3AiIF0sCgkJCXZlcnRpY2FsOiBbICJib3R0b20iLCAidG9wIiBdLAoJCQlkb3duOiBbICJ0b3AiLCAiYm90dG9tIiBdLAoJCQlsZWZ0OiBbICJyaWdodCIsICJsZWZ0IiBdLAoJCQlob3Jpem9udGFsOiBbICJyaWdodCIsICJsZWZ0IiBdLAoJCQlyaWdodDogWyAibGVmdCIsICJyaWdodCIgXQoJCX0sCgkJZWxlbWVudCA9ICQoIHRoaXMgKSwKCQlkaXJlY3Rpb24gPSBvcHRpb25zLmRpcmVjdGlvbiB8fCAidXAiLAoJCXN0YXJ0ID0gZWxlbWVudC5jc3NDbGlwKCksCgkJYW5pbWF0ZSA9IHsgY2xpcDogJC5leHRlbmQoIHt9LCBzdGFydCApIH0sCgkJcGxhY2Vob2xkZXIgPSAkLmVmZmVjdHMuY3JlYXRlUGxhY2Vob2xkZXIoIGVsZW1lbnQgKTsKCglhbmltYXRlLmNsaXBbIG1hcFsgZGlyZWN0aW9uIF1bIDAgXSBdID0gYW5pbWF0ZS5jbGlwWyBtYXBbIGRpcmVjdGlvbiBdWyAxIF0gXTsKCglpZiAoIG9wdGlvbnMubW9kZSA9PT0gInNob3ciICkgewoJCWVsZW1lbnQuY3NzQ2xpcCggYW5pbWF0ZS5jbGlwICk7CgkJaWYgKCBwbGFjZWhvbGRlciApIHsKCQkJcGxhY2Vob2xkZXIuY3NzKCAkLmVmZmVjdHMuY2xpcFRvQm94KCBhbmltYXRlICkgKTsKCQl9CgoJCWFuaW1hdGUuY2xpcCA9IHN0YXJ0OwoJfQoKCWlmICggcGxhY2Vob2xkZXIgKSB7CgkJcGxhY2Vob2xkZXIuYW5pbWF0ZSggJC5lZmZlY3RzLmNsaXBUb0JveCggYW5pbWF0ZSApLCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZyApOwoJfQoKCWVsZW1lbnQuYW5pbWF0ZSggYW5pbWF0ZSwgewoJCXF1ZXVlOiBmYWxzZSwKCQlkdXJhdGlvbjogb3B0aW9ucy5kdXJhdGlvbiwKCQllYXNpbmc6IG9wdGlvbnMuZWFzaW5nLAoJCWNvbXBsZXRlOiBkb25lCgl9ICk7Cn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIEVmZmVjdHMgQm91bmNlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogQm91bmNlIEVmZmVjdAovLz4+Z3JvdXA6IEVmZmVjdHMKLy8+PmRlc2NyaXB0aW9uOiBCb3VuY2VzIGFuIGVsZW1lbnQgaG9yaXpvbnRhbGx5IG9yIHZlcnRpY2FsbHkgbiB0aW1lcy4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2JvdW5jZS1lZmZlY3QvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvCgoKCnZhciBlZmZlY3RzRWZmZWN0Qm91bmNlID0gJC5lZmZlY3RzLmRlZmluZSggImJvdW5jZSIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgewoJdmFyIHVwQW5pbSwgZG93bkFuaW0sIHJlZlZhbHVlLAoJCWVsZW1lbnQgPSAkKCB0aGlzICksCgoJCS8vIERlZmF1bHRzOgoJCW1vZGUgPSBvcHRpb25zLm1vZGUsCgkJaGlkZSA9IG1vZGUgPT09ICJoaWRlIiwKCQlzaG93ID0gbW9kZSA9PT0gInNob3ciLAoJCWRpcmVjdGlvbiA9IG9wdGlvbnMuZGlyZWN0aW9uIHx8ICJ1cCIsCgkJZGlzdGFuY2UgPSBvcHRpb25zLmRpc3RhbmNlLAoJCXRpbWVzID0gb3B0aW9ucy50aW1lcyB8fCA1LAoKCQkvLyBOdW1iZXIgb2YgaW50ZXJuYWwgYW5pbWF0aW9ucwoJCWFuaW1zID0gdGltZXMgKiAyICsgKCBzaG93IHx8IGhpZGUgPyAxIDogMCApLAoJCXNwZWVkID0gb3B0aW9ucy5kdXJhdGlvbiAvIGFuaW1zLAoJCWVhc2luZyA9IG9wdGlvbnMuZWFzaW5nLAoKCQkvLyBVdGlsaXR5OgoJCXJlZiA9ICggZGlyZWN0aW9uID09PSAidXAiIHx8IGRpcmVjdGlvbiA9PT0gImRvd24iICkgPyAidG9wIiA6ICJsZWZ0IiwKCQltb3Rpb24gPSAoIGRpcmVjdGlvbiA9PT0gInVwIiB8fCBkaXJlY3Rpb24gPT09ICJsZWZ0IiApLAoJCWkgPSAwLAoKCQlxdWV1ZWxlbiA9IGVsZW1lbnQucXVldWUoKS5sZW5ndGg7CgoJJC5lZmZlY3RzLmNyZWF0ZVBsYWNlaG9sZGVyKCBlbGVtZW50ICk7CgoJcmVmVmFsdWUgPSBlbGVtZW50LmNzcyggcmVmICk7CgoJLy8gRGVmYXVsdCBkaXN0YW5jZSBmb3IgdGhlIEJJR0dFU1QgYm91bmNlIGlzIHRoZSBvdXRlciBEaXN0YW5jZSAvIDMKCWlmICggIWRpc3RhbmNlICkgewoJCWRpc3RhbmNlID0gZWxlbWVudFsgcmVmID09PSAidG9wIiA/ICJvdXRlckhlaWdodCIgOiAib3V0ZXJXaWR0aCIgXSgpIC8gMzsKCX0KCglpZiAoIHNob3cgKSB7CgkJZG93bkFuaW0gPSB7IG9wYWNpdHk6IDEgfTsKCQlkb3duQW5pbVsgcmVmIF0gPSByZWZWYWx1ZTsKCgkJLy8gSWYgd2UgYXJlIHNob3dpbmcsIGZvcmNlIG9wYWNpdHkgMCBhbmQgc2V0IHRoZSBpbml0aWFsIHBvc2l0aW9uCgkJLy8gdGhlbiBkbyB0aGUgImZpcnN0IiBhbmltYXRpb24KCQllbGVtZW50CgkJCS5jc3MoICJvcGFjaXR5IiwgMCApCgkJCS5jc3MoIHJlZiwgbW90aW9uID8gLWRpc3RhbmNlICogMiA6IGRpc3RhbmNlICogMiApCgkJCS5hbmltYXRlKCBkb3duQW5pbSwgc3BlZWQsIGVhc2luZyApOwoJfQoKCS8vIFN0YXJ0IGF0IHRoZSBzbWFsbGVzdCBkaXN0YW5jZSBpZiB3ZSBhcmUgaGlkaW5nCglpZiAoIGhpZGUgKSB7CgkJZGlzdGFuY2UgPSBkaXN0YW5jZSAvIE1hdGgucG93KCAyLCB0aW1lcyAtIDEgKTsKCX0KCglkb3duQW5pbSA9IHt9OwoJZG93bkFuaW1bIHJlZiBdID0gcmVmVmFsdWU7CgoJLy8gQm91bmNlcyB1cC9kb3duL2xlZnQvcmlnaHQgdGhlbiBiYWNrIHRvIDAgLS0gdGltZXMgKiAyIGFuaW1hdGlvbnMgaGFwcGVuIGhlcmUKCWZvciAoIDsgaSA8IHRpbWVzOyBpKysgKSB7CgkJdXBBbmltID0ge307CgkJdXBBbmltWyByZWYgXSA9ICggbW90aW9uID8gIi09IiA6ICIrPSIgKSArIGRpc3RhbmNlOwoKCQllbGVtZW50CgkJCS5hbmltYXRlKCB1cEFuaW0sIHNwZWVkLCBlYXNpbmcgKQoJCQkuYW5pbWF0ZSggZG93bkFuaW0sIHNwZWVkLCBlYXNpbmcgKTsKCgkJZGlzdGFuY2UgPSBoaWRlID8gZGlzdGFuY2UgKiAyIDogZGlzdGFuY2UgLyAyOwoJfQoKCS8vIExhc3QgQm91bmNlIHdoZW4gSGlkaW5nCglpZiAoIGhpZGUgKSB7CgkJdXBBbmltID0geyBvcGFjaXR5OiAwIH07CgkJdXBBbmltWyByZWYgXSA9ICggbW90aW9uID8gIi09IiA6ICIrPSIgKSArIGRpc3RhbmNlOwoKCQllbGVtZW50LmFuaW1hdGUoIHVwQW5pbSwgc3BlZWQsIGVhc2luZyApOwoJfQoKCWVsZW1lbnQucXVldWUoIGRvbmUgKTsKCgkkLmVmZmVjdHMudW5zaGlmdCggZWxlbWVudCwgcXVldWVsZW4sIGFuaW1zICsgMSApOwp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBFZmZlY3RzIENsaXAgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBDbGlwIEVmZmVjdAovLz4+Z3JvdXA6IEVmZmVjdHMKLy8+PmRlc2NyaXB0aW9uOiBDbGlwcyB0aGUgZWxlbWVudCBvbiBhbmQgb2ZmIGxpa2UgYW4gb2xkIFRWLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vY2xpcC1lZmZlY3QvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvCgoKCnZhciBlZmZlY3RzRWZmZWN0Q2xpcCA9ICQuZWZmZWN0cy5kZWZpbmUoICJjbGlwIiwgImhpZGUiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCXZhciBzdGFydCwKCQlhbmltYXRlID0ge30sCgkJZWxlbWVudCA9ICQoIHRoaXMgKSwKCQlkaXJlY3Rpb24gPSBvcHRpb25zLmRpcmVjdGlvbiB8fCAidmVydGljYWwiLAoJCWJvdGggPSBkaXJlY3Rpb24gPT09ICJib3RoIiwKCQlob3Jpem9udGFsID0gYm90aCB8fCBkaXJlY3Rpb24gPT09ICJob3Jpem9udGFsIiwKCQl2ZXJ0aWNhbCA9IGJvdGggfHwgZGlyZWN0aW9uID09PSAidmVydGljYWwiOwoKCXN0YXJ0ID0gZWxlbWVudC5jc3NDbGlwKCk7CglhbmltYXRlLmNsaXAgPSB7CgkJdG9wOiB2ZXJ0aWNhbCA/ICggc3RhcnQuYm90dG9tIC0gc3RhcnQudG9wICkgLyAyIDogc3RhcnQudG9wLAoJCXJpZ2h0OiBob3Jpem9udGFsID8gKCBzdGFydC5yaWdodCAtIHN0YXJ0LmxlZnQgKSAvIDIgOiBzdGFydC5yaWdodCwKCQlib3R0b206IHZlcnRpY2FsID8gKCBzdGFydC5ib3R0b20gLSBzdGFydC50b3AgKSAvIDIgOiBzdGFydC5ib3R0b20sCgkJbGVmdDogaG9yaXpvbnRhbCA/ICggc3RhcnQucmlnaHQgLSBzdGFydC5sZWZ0ICkgLyAyIDogc3RhcnQubGVmdAoJfTsKCgkkLmVmZmVjdHMuY3JlYXRlUGxhY2Vob2xkZXIoIGVsZW1lbnQgKTsKCglpZiAoIG9wdGlvbnMubW9kZSA9PT0gInNob3ciICkgewoJCWVsZW1lbnQuY3NzQ2xpcCggYW5pbWF0ZS5jbGlwICk7CgkJYW5pbWF0ZS5jbGlwID0gc3RhcnQ7Cgl9CgoJZWxlbWVudC5hbmltYXRlKCBhbmltYXRlLCB7CgkJcXVldWU6IGZhbHNlLAoJCWR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAoJCWVhc2luZzogb3B0aW9ucy5lYXNpbmcsCgkJY29tcGxldGU6IGRvbmUKCX0gKTsKCn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIEVmZmVjdHMgRHJvcCAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IERyb3AgRWZmZWN0Ci8vPj5ncm91cDogRWZmZWN0cwovLz4+ZGVzY3JpcHRpb246IE1vdmVzIGFuIGVsZW1lbnQgaW4gb25lIGRpcmVjdGlvbiBhbmQgaGlkZXMgaXQgYXQgdGhlIHNhbWUgdGltZS4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2Ryb3AtZWZmZWN0LwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0LwoKCgp2YXIgZWZmZWN0c0VmZmVjdERyb3AgPSAkLmVmZmVjdHMuZGVmaW5lKCAiZHJvcCIsICJoaWRlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7CgoJdmFyIGRpc3RhbmNlLAoJCWVsZW1lbnQgPSAkKCB0aGlzICksCgkJbW9kZSA9IG9wdGlvbnMubW9kZSwKCQlzaG93ID0gbW9kZSA9PT0gInNob3ciLAoJCWRpcmVjdGlvbiA9IG9wdGlvbnMuZGlyZWN0aW9uIHx8ICJsZWZ0IiwKCQlyZWYgPSAoIGRpcmVjdGlvbiA9PT0gInVwIiB8fCBkaXJlY3Rpb24gPT09ICJkb3duIiApID8gInRvcCIgOiAibGVmdCIsCgkJbW90aW9uID0gKCBkaXJlY3Rpb24gPT09ICJ1cCIgfHwgZGlyZWN0aW9uID09PSAibGVmdCIgKSA/ICItPSIgOiAiKz0iLAoJCW9wcG9zaXRlTW90aW9uID0gKCBtb3Rpb24gPT09ICIrPSIgKSA/ICItPSIgOiAiKz0iLAoJCWFuaW1hdGlvbiA9IHsKCQkJb3BhY2l0eTogMAoJCX07CgoJJC5lZmZlY3RzLmNyZWF0ZVBsYWNlaG9sZGVyKCBlbGVtZW50ICk7CgoJZGlzdGFuY2UgPSBvcHRpb25zLmRpc3RhbmNlIHx8CgkJZWxlbWVudFsgcmVmID09PSAidG9wIiA/ICJvdXRlckhlaWdodCIgOiAib3V0ZXJXaWR0aCIgXSggdHJ1ZSApIC8gMjsKCglhbmltYXRpb25bIHJlZiBdID0gbW90aW9uICsgZGlzdGFuY2U7CgoJaWYgKCBzaG93ICkgewoJCWVsZW1lbnQuY3NzKCBhbmltYXRpb24gKTsKCgkJYW5pbWF0aW9uWyByZWYgXSA9IG9wcG9zaXRlTW90aW9uICsgZGlzdGFuY2U7CgkJYW5pbWF0aW9uLm9wYWNpdHkgPSAxOwoJfQoKCS8vIEFuaW1hdGUKCWVsZW1lbnQuYW5pbWF0ZSggYW5pbWF0aW9uLCB7CgkJcXVldWU6IGZhbHNlLAoJCWR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAoJCWVhc2luZzogb3B0aW9ucy5lYXNpbmcsCgkJY29tcGxldGU6IGRvbmUKCX0gKTsKfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyBFeHBsb2RlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogRXhwbG9kZSBFZmZlY3QKLy8+Pmdyb3VwOiBFZmZlY3RzCi8vIGpzY3M6ZGlzYWJsZSBtYXhpbXVtTGluZUxlbmd0aAovLz4+ZGVzY3JpcHRpb246IEV4cGxvZGVzIGFuIGVsZW1lbnQgaW4gYWxsIGRpcmVjdGlvbnMgaW50byBuIHBpZWNlcy4gSW1wbG9kZXMgYW4gZWxlbWVudCB0byBpdHMgb3JpZ2luYWwgd2hvbGVuZXNzLgovLyBqc2NzOmVuYWJsZSBtYXhpbXVtTGluZUxlbmd0aAovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZXhwbG9kZS1lZmZlY3QvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvCgoKCnZhciBlZmZlY3RzRWZmZWN0RXhwbG9kZSA9ICQuZWZmZWN0cy5kZWZpbmUoICJleHBsb2RlIiwgImhpZGUiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCgl2YXIgaSwgaiwgbGVmdCwgdG9wLCBteCwgbXksCgkJcm93cyA9IG9wdGlvbnMucGllY2VzID8gTWF0aC5yb3VuZCggTWF0aC5zcXJ0KCBvcHRpb25zLnBpZWNlcyApICkgOiAzLAoJCWNlbGxzID0gcm93cywKCQllbGVtZW50ID0gJCggdGhpcyApLAoJCW1vZGUgPSBvcHRpb25zLm1vZGUsCgkJc2hvdyA9IG1vZGUgPT09ICJzaG93IiwKCgkJLy8gU2hvdyBhbmQgdGhlbiB2aXNpYmlsaXR5OmhpZGRlbiB0aGUgZWxlbWVudCBiZWZvcmUgY2FsY3VsYXRpbmcgb2Zmc2V0CgkJb2Zmc2V0ID0gZWxlbWVudC5zaG93KCkuY3NzKCAidmlzaWJpbGl0eSIsICJoaWRkZW4iICkub2Zmc2V0KCksCgoJCS8vIFdpZHRoIGFuZCBoZWlnaHQgb2YgYSBwaWVjZQoJCXdpZHRoID0gTWF0aC5jZWlsKCBlbGVtZW50Lm91dGVyV2lkdGgoKSAvIGNlbGxzICksCgkJaGVpZ2h0ID0gTWF0aC5jZWlsKCBlbGVtZW50Lm91dGVySGVpZ2h0KCkgLyByb3dzICksCgkJcGllY2VzID0gW107CgoJLy8gQ2hpbGRyZW4gYW5pbWF0ZSBjb21wbGV0ZToKCWZ1bmN0aW9uIGNoaWxkQ29tcGxldGUoKSB7CgkJcGllY2VzLnB1c2goIHRoaXMgKTsKCQlpZiAoIHBpZWNlcy5sZW5ndGggPT09IHJvd3MgKiBjZWxscyApIHsKCQkJYW5pbUNvbXBsZXRlKCk7CgkJfQoJfQoKCS8vIENsb25lIHRoZSBlbGVtZW50IGZvciBlYWNoIHJvdyBhbmQgY2VsbC4KCWZvciAoIGkgPSAwOyBpIDwgcm93czsgaSsrICkgeyAvLyA9PT0+CgkJdG9wID0gb2Zmc2V0LnRvcCArIGkgKiBoZWlnaHQ7CgkJbXkgPSBpIC0gKCByb3dzIC0gMSApIC8gMjsKCgkJZm9yICggaiA9IDA7IGogPCBjZWxsczsgaisrICkgeyAvLyB8fHwKCQkJbGVmdCA9IG9mZnNldC5sZWZ0ICsgaiAqIHdpZHRoOwoJCQlteCA9IGogLSAoIGNlbGxzIC0gMSApIC8gMjsKCgkJCS8vIENyZWF0ZSBhIGNsb25lIG9mIHRoZSBub3cgaGlkZGVuIG1haW4gZWxlbWVudCB0aGF0IHdpbGwgYmUgYWJzb2x1dGUgcG9zaXRpb25lZAoJCQkvLyB3aXRoaW4gYSB3cmFwcGVyIGRpdiBvZmYgdGhlIC1sZWZ0IGFuZCAtdG9wIGVxdWFsIHRvIHNpemUgb2Ygb3VyIHBpZWNlcwoJCQllbGVtZW50CgkJCQkuY2xvbmUoKQoJCQkJLmFwcGVuZFRvKCAiYm9keSIgKQoJCQkJLndyYXAoICI8ZGl2PjwvZGl2PiIgKQoJCQkJLmNzcyggewoJCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLAoJCQkJCXZpc2liaWxpdHk6ICJ2aXNpYmxlIiwKCQkJCQlsZWZ0OiAtaiAqIHdpZHRoLAoJCQkJCXRvcDogLWkgKiBoZWlnaHQKCQkJCX0gKQoKCQkJCS8vIFNlbGVjdCB0aGUgd3JhcHBlciAtIG1ha2UgaXQgb3ZlcmZsb3c6IGhpZGRlbiBhbmQgYWJzb2x1dGUgcG9zaXRpb25lZCBiYXNlZCBvbgoJCQkJLy8gd2hlcmUgdGhlIG9yaWdpbmFsIHdhcyBsb2NhdGVkICtsZWZ0IGFuZCArdG9wIGVxdWFsIHRvIHRoZSBzaXplIG9mIHBpZWNlcwoJCQkJLnBhcmVudCgpCgkJCQkJLmFkZENsYXNzKCAidWktZWZmZWN0cy1leHBsb2RlIiApCgkJCQkJLmNzcyggewoJCQkJCQlwb3NpdGlvbjogImFic29sdXRlIiwKCQkJCQkJb3ZlcmZsb3c6ICJoaWRkZW4iLAoJCQkJCQl3aWR0aDogd2lkdGgsCgkJCQkJCWhlaWdodDogaGVpZ2h0LAoJCQkJCQlsZWZ0OiBsZWZ0ICsgKCBzaG93ID8gbXggKiB3aWR0aCA6IDAgKSwKCQkJCQkJdG9wOiB0b3AgKyAoIHNob3cgPyBteSAqIGhlaWdodCA6IDAgKSwKCQkJCQkJb3BhY2l0eTogc2hvdyA/IDAgOiAxCgkJCQkJfSApCgkJCQkJLmFuaW1hdGUoIHsKCQkJCQkJbGVmdDogbGVmdCArICggc2hvdyA/IDAgOiBteCAqIHdpZHRoICksCgkJCQkJCXRvcDogdG9wICsgKCBzaG93ID8gMCA6IG15ICogaGVpZ2h0ICksCgkJCQkJCW9wYWNpdHk6IHNob3cgPyAxIDogMAoJCQkJCX0sIG9wdGlvbnMuZHVyYXRpb24gfHwgNTAwLCBvcHRpb25zLmVhc2luZywgY2hpbGRDb21wbGV0ZSApOwoJCX0KCX0KCglmdW5jdGlvbiBhbmltQ29tcGxldGUoKSB7CgkJZWxlbWVudC5jc3MoIHsKCQkJdmlzaWJpbGl0eTogInZpc2libGUiCgkJfSApOwoJCSQoIHBpZWNlcyApLnJlbW92ZSgpOwoJCWRvbmUoKTsKCX0KfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyBGYWRlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogRmFkZSBFZmZlY3QKLy8+Pmdyb3VwOiBFZmZlY3RzCi8vPj5kZXNjcmlwdGlvbjogRmFkZXMgdGhlIGVsZW1lbnQuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9mYWRlLWVmZmVjdC8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8KCgoKdmFyIGVmZmVjdHNFZmZlY3RGYWRlID0gJC5lZmZlY3RzLmRlZmluZSggImZhZGUiLCAidG9nZ2xlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7Cgl2YXIgc2hvdyA9IG9wdGlvbnMubW9kZSA9PT0gInNob3ciOwoKCSQoIHRoaXMgKQoJCS5jc3MoICJvcGFjaXR5Iiwgc2hvdyA/IDAgOiAxICkKCQkuYW5pbWF0ZSggewoJCQlvcGFjaXR5OiBzaG93ID8gMSA6IDAKCQl9LCB7CgkJCXF1ZXVlOiBmYWxzZSwKCQkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sCgkJCWVhc2luZzogb3B0aW9ucy5lYXNpbmcsCgkJCWNvbXBsZXRlOiBkb25lCgkJfSApOwp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBFZmZlY3RzIEZvbGQgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBGb2xkIEVmZmVjdAovLz4+Z3JvdXA6IEVmZmVjdHMKLy8+PmRlc2NyaXB0aW9uOiBGb2xkcyBhbiBlbGVtZW50IGZpcnN0IGhvcml6b250YWxseSBhbmQgdGhlbiB2ZXJ0aWNhbGx5LgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZm9sZC1lZmZlY3QvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvCgoKCnZhciBlZmZlY3RzRWZmZWN0Rm9sZCA9ICQuZWZmZWN0cy5kZWZpbmUoICJmb2xkIiwgImhpZGUiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCgkvLyBDcmVhdGUgZWxlbWVudAoJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICksCgkJbW9kZSA9IG9wdGlvbnMubW9kZSwKCQlzaG93ID0gbW9kZSA9PT0gInNob3ciLAoJCWhpZGUgPSBtb2RlID09PSAiaGlkZSIsCgkJc2l6ZSA9IG9wdGlvbnMuc2l6ZSB8fCAxNSwKCQlwZXJjZW50ID0gLyhbMC05XSspJS8uZXhlYyggc2l6ZSApLAoJCWhvcml6Rmlyc3QgPSAhIW9wdGlvbnMuaG9yaXpGaXJzdCwKCQlyZWYgPSBob3JpekZpcnN0ID8gWyAicmlnaHQiLCAiYm90dG9tIiBdIDogWyAiYm90dG9tIiwgInJpZ2h0IiBdLAoJCWR1cmF0aW9uID0gb3B0aW9ucy5kdXJhdGlvbiAvIDIsCgoJCXBsYWNlaG9sZGVyID0gJC5lZmZlY3RzLmNyZWF0ZVBsYWNlaG9sZGVyKCBlbGVtZW50ICksCgoJCXN0YXJ0ID0gZWxlbWVudC5jc3NDbGlwKCksCgkJYW5pbWF0aW9uMSA9IHsgY2xpcDogJC5leHRlbmQoIHt9LCBzdGFydCApIH0sCgkJYW5pbWF0aW9uMiA9IHsgY2xpcDogJC5leHRlbmQoIHt9LCBzdGFydCApIH0sCgoJCWRpc3RhbmNlID0gWyBzdGFydFsgcmVmWyAwIF0gXSwgc3RhcnRbIHJlZlsgMSBdIF0gXSwKCgkJcXVldWVsZW4gPSBlbGVtZW50LnF1ZXVlKCkubGVuZ3RoOwoKCWlmICggcGVyY2VudCApIHsKCQlzaXplID0gcGFyc2VJbnQoIHBlcmNlbnRbIDEgXSwgMTAgKSAvIDEwMCAqIGRpc3RhbmNlWyBoaWRlID8gMCA6IDEgXTsKCX0KCWFuaW1hdGlvbjEuY2xpcFsgcmVmWyAwIF0gXSA9IHNpemU7CglhbmltYXRpb24yLmNsaXBbIHJlZlsgMCBdIF0gPSBzaXplOwoJYW5pbWF0aW9uMi5jbGlwWyByZWZbIDEgXSBdID0gMDsKCglpZiAoIHNob3cgKSB7CgkJZWxlbWVudC5jc3NDbGlwKCBhbmltYXRpb24yLmNsaXAgKTsKCQlpZiAoIHBsYWNlaG9sZGVyICkgewoJCQlwbGFjZWhvbGRlci5jc3MoICQuZWZmZWN0cy5jbGlwVG9Cb3goIGFuaW1hdGlvbjIgKSApOwoJCX0KCgkJYW5pbWF0aW9uMi5jbGlwID0gc3RhcnQ7Cgl9CgoJLy8gQW5pbWF0ZQoJZWxlbWVudAoJCS5xdWV1ZSggZnVuY3Rpb24oIG5leHQgKSB7CgkJCWlmICggcGxhY2Vob2xkZXIgKSB7CgkJCQlwbGFjZWhvbGRlcgoJCQkJCS5hbmltYXRlKCAkLmVmZmVjdHMuY2xpcFRvQm94KCBhbmltYXRpb24xICksIGR1cmF0aW9uLCBvcHRpb25zLmVhc2luZyApCgkJCQkJLmFuaW1hdGUoICQuZWZmZWN0cy5jbGlwVG9Cb3goIGFuaW1hdGlvbjIgKSwgZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nICk7CgkJCX0KCgkJCW5leHQoKTsKCQl9ICkKCQkuYW5pbWF0ZSggYW5pbWF0aW9uMSwgZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nICkKCQkuYW5pbWF0ZSggYW5pbWF0aW9uMiwgZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nICkKCQkucXVldWUoIGRvbmUgKTsKCgkkLmVmZmVjdHMudW5zaGlmdCggZWxlbWVudCwgcXVldWVsZW4sIDQgKTsKfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyBIaWdobGlnaHQgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBIaWdobGlnaHQgRWZmZWN0Ci8vPj5ncm91cDogRWZmZWN0cwovLz4+ZGVzY3JpcHRpb246IEhpZ2hsaWdodHMgdGhlIGJhY2tncm91bmQgb2YgYW4gZWxlbWVudCBpbiBhIGRlZmluZWQgY29sb3IgZm9yIGEgY3VzdG9tIGR1cmF0aW9uLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vaGlnaGxpZ2h0LWVmZmVjdC8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8KCgoKdmFyIGVmZmVjdHNFZmZlY3RIaWdobGlnaHQgPSAkLmVmZmVjdHMuZGVmaW5lKCAiaGlnaGxpZ2h0IiwgInNob3ciLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCXZhciBlbGVtZW50ID0gJCggdGhpcyApLAoJCWFuaW1hdGlvbiA9IHsKCQkJYmFja2dyb3VuZENvbG9yOiBlbGVtZW50LmNzcyggImJhY2tncm91bmRDb2xvciIgKQoJCX07CgoJaWYgKCBvcHRpb25zLm1vZGUgPT09ICJoaWRlIiApIHsKCQlhbmltYXRpb24ub3BhY2l0eSA9IDA7Cgl9CgoJJC5lZmZlY3RzLnNhdmVTdHlsZSggZWxlbWVudCApOwoKCWVsZW1lbnQKCQkuY3NzKCB7CgkJCWJhY2tncm91bmRJbWFnZTogIm5vbmUiLAoJCQliYWNrZ3JvdW5kQ29sb3I6IG9wdGlvbnMuY29sb3IgfHwgIiNmZmZmOTkiCgkJfSApCgkJLmFuaW1hdGUoIGFuaW1hdGlvbiwgewoJCQlxdWV1ZTogZmFsc2UsCgkJCWR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAoJCQllYXNpbmc6IG9wdGlvbnMuZWFzaW5nLAoJCQljb21wbGV0ZTogZG9uZQoJCX0gKTsKfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyBTaXplIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogU2l6ZSBFZmZlY3QKLy8+Pmdyb3VwOiBFZmZlY3RzCi8vPj5kZXNjcmlwdGlvbjogUmVzaXplIGFuIGVsZW1lbnQgdG8gYSBzcGVjaWZpZWQgd2lkdGggYW5kIGhlaWdodC4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3NpemUtZWZmZWN0LwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0LwoKCgp2YXIgZWZmZWN0c0VmZmVjdFNpemUgPSAkLmVmZmVjdHMuZGVmaW5lKCAic2l6ZSIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgewoKCS8vIENyZWF0ZSBlbGVtZW50Cgl2YXIgYmFzZWxpbmUsIGZhY3RvciwgdGVtcCwKCQllbGVtZW50ID0gJCggdGhpcyApLAoKCQkvLyBDb3B5IGZvciBjaGlsZHJlbgoJCWNQcm9wcyA9IFsgImZvbnRTaXplIiBdLAoJCXZQcm9wcyA9IFsgImJvcmRlclRvcFdpZHRoIiwgImJvcmRlckJvdHRvbVdpZHRoIiwgInBhZGRpbmdUb3AiLCAicGFkZGluZ0JvdHRvbSIgXSwKCQloUHJvcHMgPSBbICJib3JkZXJMZWZ0V2lkdGgiLCAiYm9yZGVyUmlnaHRXaWR0aCIsICJwYWRkaW5nTGVmdCIsICJwYWRkaW5nUmlnaHQiIF0sCgoJCS8vIFNldCBvcHRpb25zCgkJbW9kZSA9IG9wdGlvbnMubW9kZSwKCQlyZXN0b3JlID0gbW9kZSAhPT0gImVmZmVjdCIsCgkJc2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8ICJib3RoIiwKCQlvcmlnaW4gPSBvcHRpb25zLm9yaWdpbiB8fCBbICJtaWRkbGUiLCAiY2VudGVyIiBdLAoJCXBvc2l0aW9uID0gZWxlbWVudC5jc3MoICJwb3NpdGlvbiIgKSwKCQlwb3MgPSBlbGVtZW50LnBvc2l0aW9uKCksCgkJb3JpZ2luYWwgPSAkLmVmZmVjdHMuc2NhbGVkRGltZW5zaW9ucyggZWxlbWVudCApLAoJCWZyb20gPSBvcHRpb25zLmZyb20gfHwgb3JpZ2luYWwsCgkJdG8gPSBvcHRpb25zLnRvIHx8ICQuZWZmZWN0cy5zY2FsZWREaW1lbnNpb25zKCBlbGVtZW50LCAwICk7CgoJJC5lZmZlY3RzLmNyZWF0ZVBsYWNlaG9sZGVyKCBlbGVtZW50ICk7CgoJaWYgKCBtb2RlID09PSAic2hvdyIgKSB7CgkJdGVtcCA9IGZyb207CgkJZnJvbSA9IHRvOwoJCXRvID0gdGVtcDsKCX0KCgkvLyBTZXQgc2NhbGluZyBmYWN0b3IKCWZhY3RvciA9IHsKCQlmcm9tOiB7CgkJCXk6IGZyb20uaGVpZ2h0IC8gb3JpZ2luYWwuaGVpZ2h0LAoJCQl4OiBmcm9tLndpZHRoIC8gb3JpZ2luYWwud2lkdGgKCQl9LAoJCXRvOiB7CgkJCXk6IHRvLmhlaWdodCAvIG9yaWdpbmFsLmhlaWdodCwKCQkJeDogdG8ud2lkdGggLyBvcmlnaW5hbC53aWR0aAoJCX0KCX07CgoJLy8gU2NhbGUgdGhlIGNzcyBib3gKCWlmICggc2NhbGUgPT09ICJib3giIHx8IHNjYWxlID09PSAiYm90aCIgKSB7CgoJCS8vIFZlcnRpY2FsIHByb3BzIHNjYWxpbmcKCQlpZiAoIGZhY3Rvci5mcm9tLnkgIT09IGZhY3Rvci50by55ICkgewoJCQlmcm9tID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGVsZW1lbnQsIHZQcm9wcywgZmFjdG9yLmZyb20ueSwgZnJvbSApOwoJCQl0byA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBlbGVtZW50LCB2UHJvcHMsIGZhY3Rvci50by55LCB0byApOwoJCX0KCgkJLy8gSG9yaXpvbnRhbCBwcm9wcyBzY2FsaW5nCgkJaWYgKCBmYWN0b3IuZnJvbS54ICE9PSBmYWN0b3IudG8ueCApIHsKCQkJZnJvbSA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBlbGVtZW50LCBoUHJvcHMsIGZhY3Rvci5mcm9tLngsIGZyb20gKTsKCQkJdG8gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggZWxlbWVudCwgaFByb3BzLCBmYWN0b3IudG8ueCwgdG8gKTsKCQl9Cgl9CgoJLy8gU2NhbGUgdGhlIGNvbnRlbnQKCWlmICggc2NhbGUgPT09ICJjb250ZW50IiB8fCBzY2FsZSA9PT0gImJvdGgiICkgewoKCQkvLyBWZXJ0aWNhbCBwcm9wcyBzY2FsaW5nCgkJaWYgKCBmYWN0b3IuZnJvbS55ICE9PSBmYWN0b3IudG8ueSApIHsKCQkJZnJvbSA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBlbGVtZW50LCBjUHJvcHMsIGZhY3Rvci5mcm9tLnksIGZyb20gKTsKCQkJdG8gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggZWxlbWVudCwgY1Byb3BzLCBmYWN0b3IudG8ueSwgdG8gKTsKCQl9Cgl9CgoJLy8gQWRqdXN0IHRoZSBwb3NpdGlvbiBwcm9wZXJ0aWVzIGJhc2VkIG9uIHRoZSBwcm92aWRlZCBvcmlnaW4gcG9pbnRzCglpZiAoIG9yaWdpbiApIHsKCQliYXNlbGluZSA9ICQuZWZmZWN0cy5nZXRCYXNlbGluZSggb3JpZ2luLCBvcmlnaW5hbCApOwoJCWZyb20udG9wID0gKCBvcmlnaW5hbC5vdXRlckhlaWdodCAtIGZyb20ub3V0ZXJIZWlnaHQgKSAqIGJhc2VsaW5lLnkgKyBwb3MudG9wOwoJCWZyb20ubGVmdCA9ICggb3JpZ2luYWwub3V0ZXJXaWR0aCAtIGZyb20ub3V0ZXJXaWR0aCApICogYmFzZWxpbmUueCArIHBvcy5sZWZ0OwoJCXRvLnRvcCA9ICggb3JpZ2luYWwub3V0ZXJIZWlnaHQgLSB0by5vdXRlckhlaWdodCApICogYmFzZWxpbmUueSArIHBvcy50b3A7CgkJdG8ubGVmdCA9ICggb3JpZ2luYWwub3V0ZXJXaWR0aCAtIHRvLm91dGVyV2lkdGggKSAqIGJhc2VsaW5lLnggKyBwb3MubGVmdDsKCX0KCWVsZW1lbnQuY3NzKCBmcm9tICk7CgoJLy8gQW5pbWF0ZSB0aGUgY2hpbGRyZW4gaWYgZGVzaXJlZAoJaWYgKCBzY2FsZSA9PT0gImNvbnRlbnQiIHx8IHNjYWxlID09PSAiYm90aCIgKSB7CgoJCXZQcm9wcyA9IHZQcm9wcy5jb25jYXQoIFsgIm1hcmdpblRvcCIsICJtYXJnaW5Cb3R0b20iIF0gKS5jb25jYXQoIGNQcm9wcyApOwoJCWhQcm9wcyA9IGhQcm9wcy5jb25jYXQoIFsgIm1hcmdpbkxlZnQiLCAibWFyZ2luUmlnaHQiIF0gKTsKCgkJLy8gT25seSBhbmltYXRlIGNoaWxkcmVuIHdpdGggd2lkdGggYXR0cmlidXRlcyBzcGVjaWZpZWQKCQkvLyBUT0RPOiBpcyB0aGlzIHJpZ2h0PyBzaG91bGQgd2UgaW5jbHVkZSBhbnl0aGluZyB3aXRoIGNzcyB3aWR0aCBzcGVjaWZpZWQgYXMgd2VsbAoJCWVsZW1lbnQuZmluZCggIipbd2lkdGhdIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgY2hpbGQgPSAkKCB0aGlzICksCgkJCQljaGlsZE9yaWdpbmFsID0gJC5lZmZlY3RzLnNjYWxlZERpbWVuc2lvbnMoIGNoaWxkICksCgkJCQljaGlsZEZyb20gPSB7CgkJCQkJaGVpZ2h0OiBjaGlsZE9yaWdpbmFsLmhlaWdodCAqIGZhY3Rvci5mcm9tLnksCgkJCQkJd2lkdGg6IGNoaWxkT3JpZ2luYWwud2lkdGggKiBmYWN0b3IuZnJvbS54LAoJCQkJCW91dGVySGVpZ2h0OiBjaGlsZE9yaWdpbmFsLm91dGVySGVpZ2h0ICogZmFjdG9yLmZyb20ueSwKCQkJCQlvdXRlcldpZHRoOiBjaGlsZE9yaWdpbmFsLm91dGVyV2lkdGggKiBmYWN0b3IuZnJvbS54CgkJCQl9LAoJCQkJY2hpbGRUbyA9IHsKCQkJCQloZWlnaHQ6IGNoaWxkT3JpZ2luYWwuaGVpZ2h0ICogZmFjdG9yLnRvLnksCgkJCQkJd2lkdGg6IGNoaWxkT3JpZ2luYWwud2lkdGggKiBmYWN0b3IudG8ueCwKCQkJCQlvdXRlckhlaWdodDogY2hpbGRPcmlnaW5hbC5oZWlnaHQgKiBmYWN0b3IudG8ueSwKCQkJCQlvdXRlcldpZHRoOiBjaGlsZE9yaWdpbmFsLndpZHRoICogZmFjdG9yLnRvLngKCQkJCX07CgoJCQkvLyBWZXJ0aWNhbCBwcm9wcyBzY2FsaW5nCgkJCWlmICggZmFjdG9yLmZyb20ueSAhPT0gZmFjdG9yLnRvLnkgKSB7CgkJCQljaGlsZEZyb20gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggY2hpbGQsIHZQcm9wcywgZmFjdG9yLmZyb20ueSwgY2hpbGRGcm9tICk7CgkJCQljaGlsZFRvID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGNoaWxkLCB2UHJvcHMsIGZhY3Rvci50by55LCBjaGlsZFRvICk7CgkJCX0KCgkJCS8vIEhvcml6b250YWwgcHJvcHMgc2NhbGluZwoJCQlpZiAoIGZhY3Rvci5mcm9tLnggIT09IGZhY3Rvci50by54ICkgewoJCQkJY2hpbGRGcm9tID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGNoaWxkLCBoUHJvcHMsIGZhY3Rvci5mcm9tLngsIGNoaWxkRnJvbSApOwoJCQkJY2hpbGRUbyA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBjaGlsZCwgaFByb3BzLCBmYWN0b3IudG8ueCwgY2hpbGRUbyApOwoJCQl9CgoJCQlpZiAoIHJlc3RvcmUgKSB7CgkJCQkkLmVmZmVjdHMuc2F2ZVN0eWxlKCBjaGlsZCApOwoJCQl9CgoJCQkvLyBBbmltYXRlIGNoaWxkcmVuCgkJCWNoaWxkLmNzcyggY2hpbGRGcm9tICk7CgkJCWNoaWxkLmFuaW1hdGUoIGNoaWxkVG8sIG9wdGlvbnMuZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nLCBmdW5jdGlvbigpIHsKCgkJCQkvLyBSZXN0b3JlIGNoaWxkcmVuCgkJCQlpZiAoIHJlc3RvcmUgKSB7CgkJCQkJJC5lZmZlY3RzLnJlc3RvcmVTdHlsZSggY2hpbGQgKTsKCQkJCX0KCQkJfSApOwoJCX0gKTsKCX0KCgkvLyBBbmltYXRlCgllbGVtZW50LmFuaW1hdGUoIHRvLCB7CgkJcXVldWU6IGZhbHNlLAoJCWR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAoJCWVhc2luZzogb3B0aW9ucy5lYXNpbmcsCgkJY29tcGxldGU6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIG9mZnNldCA9IGVsZW1lbnQub2Zmc2V0KCk7CgoJCQlpZiAoIHRvLm9wYWNpdHkgPT09IDAgKSB7CgkJCQllbGVtZW50LmNzcyggIm9wYWNpdHkiLCBmcm9tLm9wYWNpdHkgKTsKCQkJfQoKCQkJaWYgKCAhcmVzdG9yZSApIHsKCQkJCWVsZW1lbnQKCQkJCQkuY3NzKCAicG9zaXRpb24iLCBwb3NpdGlvbiA9PT0gInN0YXRpYyIgPyAicmVsYXRpdmUiIDogcG9zaXRpb24gKQoJCQkJCS5vZmZzZXQoIG9mZnNldCApOwoKCQkJCS8vIE5lZWQgdG8gc2F2ZSBzdHlsZSBoZXJlIHNvIHRoYXQgYXV0b21hdGljIHN0eWxlIHJlc3RvcmF0aW9uCgkJCQkvLyBkb2Vzbid0IHJlc3RvcmUgdG8gdGhlIG9yaWdpbmFsIHN0eWxlcyBmcm9tIGJlZm9yZSB0aGUgYW5pbWF0aW9uLgoJCQkJJC5lZmZlY3RzLnNhdmVTdHlsZSggZWxlbWVudCApOwoJCQl9CgoJCQlkb25lKCk7CgkJfQoJfSApOwoKfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyBTY2FsZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFNjYWxlIEVmZmVjdAovLz4+Z3JvdXA6IEVmZmVjdHMKLy8+PmRlc2NyaXB0aW9uOiBHcm93cyBvciBzaHJpbmtzIGFuIGVsZW1lbnQgYW5kIGl0cyBjb250ZW50LgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2NhbGUtZWZmZWN0LwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0LwoKCgp2YXIgZWZmZWN0c0VmZmVjdFNjYWxlID0gJC5lZmZlY3RzLmRlZmluZSggInNjYWxlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7CgoJLy8gQ3JlYXRlIGVsZW1lbnQKCXZhciBlbCA9ICQoIHRoaXMgKSwKCQltb2RlID0gb3B0aW9ucy5tb2RlLAoJCXBlcmNlbnQgPSBwYXJzZUludCggb3B0aW9ucy5wZXJjZW50LCAxMCApIHx8CgkJCSggcGFyc2VJbnQoIG9wdGlvbnMucGVyY2VudCwgMTAgKSA9PT0gMCA/IDAgOiAoIG1vZGUgIT09ICJlZmZlY3QiID8gMCA6IDEwMCApICksCgoJCW5ld09wdGlvbnMgPSAkLmV4dGVuZCggdHJ1ZSwgewoJCQlmcm9tOiAkLmVmZmVjdHMuc2NhbGVkRGltZW5zaW9ucyggZWwgKSwKCQkJdG86ICQuZWZmZWN0cy5zY2FsZWREaW1lbnNpb25zKCBlbCwgcGVyY2VudCwgb3B0aW9ucy5kaXJlY3Rpb24gfHwgImJvdGgiICksCgkJCW9yaWdpbjogb3B0aW9ucy5vcmlnaW4gfHwgWyAibWlkZGxlIiwgImNlbnRlciIgXQoJCX0sIG9wdGlvbnMgKTsKCgkvLyBGYWRlIG9wdGlvbiB0byBzdXBwb3J0IHB1ZmYKCWlmICggb3B0aW9ucy5mYWRlICkgewoJCW5ld09wdGlvbnMuZnJvbS5vcGFjaXR5ID0gMTsKCQluZXdPcHRpb25zLnRvLm9wYWNpdHkgPSAwOwoJfQoKCSQuZWZmZWN0cy5lZmZlY3Quc2l6ZS5jYWxsKCB0aGlzLCBuZXdPcHRpb25zLCBkb25lICk7Cn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIEVmZmVjdHMgUHVmZiAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFB1ZmYgRWZmZWN0Ci8vPj5ncm91cDogRWZmZWN0cwovLz4+ZGVzY3JpcHRpb246IENyZWF0ZXMgYSBwdWZmIGVmZmVjdCBieSBzY2FsaW5nIHRoZSBlbGVtZW50IHVwIGFuZCBoaWRpbmcgaXQgYXQgdGhlIHNhbWUgdGltZS4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3B1ZmYtZWZmZWN0LwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0LwoKCgp2YXIgZWZmZWN0c0VmZmVjdFB1ZmYgPSAkLmVmZmVjdHMuZGVmaW5lKCAicHVmZiIsICJoaWRlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7Cgl2YXIgbmV3T3B0aW9ucyA9ICQuZXh0ZW5kKCB0cnVlLCB7fSwgb3B0aW9ucywgewoJCWZhZGU6IHRydWUsCgkJcGVyY2VudDogcGFyc2VJbnQoIG9wdGlvbnMucGVyY2VudCwgMTAgKSB8fCAxNTAKCX0gKTsKCgkkLmVmZmVjdHMuZWZmZWN0LnNjYWxlLmNhbGwoIHRoaXMsIG5ld09wdGlvbnMsIGRvbmUgKTsKfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyBQdWxzYXRlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogUHVsc2F0ZSBFZmZlY3QKLy8+Pmdyb3VwOiBFZmZlY3RzCi8vPj5kZXNjcmlwdGlvbjogUHVsc2F0ZXMgYW4gZWxlbWVudCBuIHRpbWVzIGJ5IGNoYW5naW5nIHRoZSBvcGFjaXR5IHRvIHplcm8gYW5kIGJhY2suCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9wdWxzYXRlLWVmZmVjdC8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8KCgoKdmFyIGVmZmVjdHNFZmZlY3RQdWxzYXRlID0gJC5lZmZlY3RzLmRlZmluZSggInB1bHNhdGUiLCAic2hvdyIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgewoJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICksCgkJbW9kZSA9IG9wdGlvbnMubW9kZSwKCQlzaG93ID0gbW9kZSA9PT0gInNob3ciLAoJCWhpZGUgPSBtb2RlID09PSAiaGlkZSIsCgkJc2hvd2hpZGUgPSBzaG93IHx8IGhpZGUsCgoJCS8vIFNob3dpbmcgb3IgaGlkaW5nIGxlYXZlcyBvZmYgdGhlICJsYXN0IiBhbmltYXRpb24KCQlhbmltcyA9ICggKCBvcHRpb25zLnRpbWVzIHx8IDUgKSAqIDIgKSArICggc2hvd2hpZGUgPyAxIDogMCApLAoJCWR1cmF0aW9uID0gb3B0aW9ucy5kdXJhdGlvbiAvIGFuaW1zLAoJCWFuaW1hdGVUbyA9IDAsCgkJaSA9IDEsCgkJcXVldWVsZW4gPSBlbGVtZW50LnF1ZXVlKCkubGVuZ3RoOwoKCWlmICggc2hvdyB8fCAhZWxlbWVudC5pcyggIjp2aXNpYmxlIiApICkgewoJCWVsZW1lbnQuY3NzKCAib3BhY2l0eSIsIDAgKS5zaG93KCk7CgkJYW5pbWF0ZVRvID0gMTsKCX0KCgkvLyBBbmltcyAtIDEgb3BhY2l0eSAidG9nZ2xlcyIKCWZvciAoIDsgaSA8IGFuaW1zOyBpKysgKSB7CgkJZWxlbWVudC5hbmltYXRlKCB7IG9wYWNpdHk6IGFuaW1hdGVUbyB9LCBkdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcgKTsKCQlhbmltYXRlVG8gPSAxIC0gYW5pbWF0ZVRvOwoJfQoKCWVsZW1lbnQuYW5pbWF0ZSggeyBvcGFjaXR5OiBhbmltYXRlVG8gfSwgZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nICk7CgoJZWxlbWVudC5xdWV1ZSggZG9uZSApOwoKCSQuZWZmZWN0cy51bnNoaWZ0KCBlbGVtZW50LCBxdWV1ZWxlbiwgYW5pbXMgKyAxICk7Cn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIEVmZmVjdHMgU2hha2UgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBTaGFrZSBFZmZlY3QKLy8+Pmdyb3VwOiBFZmZlY3RzCi8vPj5kZXNjcmlwdGlvbjogU2hha2VzIGFuIGVsZW1lbnQgaG9yaXpvbnRhbGx5IG9yIHZlcnRpY2FsbHkgbiB0aW1lcy4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3NoYWtlLWVmZmVjdC8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8KCgoKdmFyIGVmZmVjdHNFZmZlY3RTaGFrZSA9ICQuZWZmZWN0cy5kZWZpbmUoICJzaGFrZSIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgewoKCXZhciBpID0gMSwKCQllbGVtZW50ID0gJCggdGhpcyApLAoJCWRpcmVjdGlvbiA9IG9wdGlvbnMuZGlyZWN0aW9uIHx8ICJsZWZ0IiwKCQlkaXN0YW5jZSA9IG9wdGlvbnMuZGlzdGFuY2UgfHwgMjAsCgkJdGltZXMgPSBvcHRpb25zLnRpbWVzIHx8IDMsCgkJYW5pbXMgPSB0aW1lcyAqIDIgKyAxLAoJCXNwZWVkID0gTWF0aC5yb3VuZCggb3B0aW9ucy5kdXJhdGlvbiAvIGFuaW1zICksCgkJcmVmID0gKCBkaXJlY3Rpb24gPT09ICJ1cCIgfHwgZGlyZWN0aW9uID09PSAiZG93biIgKSA/ICJ0b3AiIDogImxlZnQiLAoJCXBvc2l0aXZlTW90aW9uID0gKCBkaXJlY3Rpb24gPT09ICJ1cCIgfHwgZGlyZWN0aW9uID09PSAibGVmdCIgKSwKCQlhbmltYXRpb24gPSB7fSwKCQlhbmltYXRpb24xID0ge30sCgkJYW5pbWF0aW9uMiA9IHt9LAoKCQlxdWV1ZWxlbiA9IGVsZW1lbnQucXVldWUoKS5sZW5ndGg7CgoJJC5lZmZlY3RzLmNyZWF0ZVBsYWNlaG9sZGVyKCBlbGVtZW50ICk7CgoJLy8gQW5pbWF0aW9uCglhbmltYXRpb25bIHJlZiBdID0gKCBwb3NpdGl2ZU1vdGlvbiA/ICItPSIgOiAiKz0iICkgKyBkaXN0YW5jZTsKCWFuaW1hdGlvbjFbIHJlZiBdID0gKCBwb3NpdGl2ZU1vdGlvbiA/ICIrPSIgOiAiLT0iICkgKyBkaXN0YW5jZSAqIDI7CglhbmltYXRpb24yWyByZWYgXSA9ICggcG9zaXRpdmVNb3Rpb24gPyAiLT0iIDogIis9IiApICsgZGlzdGFuY2UgKiAyOwoKCS8vIEFuaW1hdGUKCWVsZW1lbnQuYW5pbWF0ZSggYW5pbWF0aW9uLCBzcGVlZCwgb3B0aW9ucy5lYXNpbmcgKTsKCgkvLyBTaGFrZXMKCWZvciAoIDsgaSA8IHRpbWVzOyBpKysgKSB7CgkJZWxlbWVudAoJCQkuYW5pbWF0ZSggYW5pbWF0aW9uMSwgc3BlZWQsIG9wdGlvbnMuZWFzaW5nICkKCQkJLmFuaW1hdGUoIGFuaW1hdGlvbjIsIHNwZWVkLCBvcHRpb25zLmVhc2luZyApOwoJfQoKCWVsZW1lbnQKCQkuYW5pbWF0ZSggYW5pbWF0aW9uMSwgc3BlZWQsIG9wdGlvbnMuZWFzaW5nICkKCQkuYW5pbWF0ZSggYW5pbWF0aW9uLCBzcGVlZCAvIDIsIG9wdGlvbnMuZWFzaW5nICkKCQkucXVldWUoIGRvbmUgKTsKCgkkLmVmZmVjdHMudW5zaGlmdCggZWxlbWVudCwgcXVldWVsZW4sIGFuaW1zICsgMSApOwp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBFZmZlY3RzIFNsaWRlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogU2xpZGUgRWZmZWN0Ci8vPj5ncm91cDogRWZmZWN0cwovLz4+ZGVzY3JpcHRpb246IFNsaWRlcyBhbiBlbGVtZW50IGluIGFuZCBvdXQgb2YgdGhlIHZpZXdwb3J0LgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2xpZGUtZWZmZWN0LwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0LwoKCgp2YXIgZWZmZWN0c0VmZmVjdFNsaWRlID0gJC5lZmZlY3RzLmRlZmluZSggInNsaWRlIiwgInNob3ciLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCXZhciBzdGFydENsaXAsIHN0YXJ0UmVmLAoJCWVsZW1lbnQgPSAkKCB0aGlzICksCgkJbWFwID0gewoJCQl1cDogWyAiYm90dG9tIiwgInRvcCIgXSwKCQkJZG93bjogWyAidG9wIiwgImJvdHRvbSIgXSwKCQkJbGVmdDogWyAicmlnaHQiLCAibGVmdCIgXSwKCQkJcmlnaHQ6IFsgImxlZnQiLCAicmlnaHQiIF0KCQl9LAoJCW1vZGUgPSBvcHRpb25zLm1vZGUsCgkJZGlyZWN0aW9uID0gb3B0aW9ucy5kaXJlY3Rpb24gfHwgImxlZnQiLAoJCXJlZiA9ICggZGlyZWN0aW9uID09PSAidXAiIHx8IGRpcmVjdGlvbiA9PT0gImRvd24iICkgPyAidG9wIiA6ICJsZWZ0IiwKCQlwb3NpdGl2ZU1vdGlvbiA9ICggZGlyZWN0aW9uID09PSAidXAiIHx8IGRpcmVjdGlvbiA9PT0gImxlZnQiICksCgkJZGlzdGFuY2UgPSBvcHRpb25zLmRpc3RhbmNlIHx8CgkJCWVsZW1lbnRbIHJlZiA9PT0gInRvcCIgPyAib3V0ZXJIZWlnaHQiIDogIm91dGVyV2lkdGgiIF0oIHRydWUgKSwKCQlhbmltYXRpb24gPSB7fTsKCgkkLmVmZmVjdHMuY3JlYXRlUGxhY2Vob2xkZXIoIGVsZW1lbnQgKTsKCglzdGFydENsaXAgPSBlbGVtZW50LmNzc0NsaXAoKTsKCXN0YXJ0UmVmID0gZWxlbWVudC5wb3NpdGlvbigpWyByZWYgXTsKCgkvLyBEZWZpbmUgaGlkZSBhbmltYXRpb24KCWFuaW1hdGlvblsgcmVmIF0gPSAoIHBvc2l0aXZlTW90aW9uID8gLTEgOiAxICkgKiBkaXN0YW5jZSArIHN0YXJ0UmVmOwoJYW5pbWF0aW9uLmNsaXAgPSBlbGVtZW50LmNzc0NsaXAoKTsKCWFuaW1hdGlvbi5jbGlwWyBtYXBbIGRpcmVjdGlvbiBdWyAxIF0gXSA9IGFuaW1hdGlvbi5jbGlwWyBtYXBbIGRpcmVjdGlvbiBdWyAwIF0gXTsKCgkvLyBSZXZlcnNlIHRoZSBhbmltYXRpb24gaWYgd2UncmUgc2hvd2luZwoJaWYgKCBtb2RlID09PSAic2hvdyIgKSB7CgkJZWxlbWVudC5jc3NDbGlwKCBhbmltYXRpb24uY2xpcCApOwoJCWVsZW1lbnQuY3NzKCByZWYsIGFuaW1hdGlvblsgcmVmIF0gKTsKCQlhbmltYXRpb24uY2xpcCA9IHN0YXJ0Q2xpcDsKCQlhbmltYXRpb25bIHJlZiBdID0gc3RhcnRSZWY7Cgl9CgoJLy8gQWN0dWFsbHkgYW5pbWF0ZQoJZWxlbWVudC5hbmltYXRlKCBhbmltYXRpb24sIHsKCQlxdWV1ZTogZmFsc2UsCgkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sCgkJZWFzaW5nOiBvcHRpb25zLmVhc2luZywKCQljb21wbGV0ZTogZG9uZQoJfSApOwp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBFZmZlY3RzIFRyYW5zZmVyIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogVHJhbnNmZXIgRWZmZWN0Ci8vPj5ncm91cDogRWZmZWN0cwovLz4+ZGVzY3JpcHRpb246IERpc3BsYXlzIGEgdHJhbnNmZXIgZWZmZWN0IGZyb20gb25lIGVsZW1lbnQgdG8gYW5vdGhlci4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3RyYW5zZmVyLWVmZmVjdC8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8KCgoKdmFyIGVmZmVjdDsKaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgKSB7CgllZmZlY3QgPSAkLmVmZmVjdHMuZGVmaW5lKCAidHJhbnNmZXIiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCQkkKCB0aGlzICkudHJhbnNmZXIoIG9wdGlvbnMsIGRvbmUgKTsKCX0gKTsKfQp2YXIgZWZmZWN0c0VmZmVjdFRyYW5zZmVyID0gZWZmZWN0OwoKCgoKfSkpOw=="></script>
	<link rel="stylesheet" href="css/jquery-ui.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">